<application>
  <component name="VimHistorySettings">
    <history>
      <history-search>
        <entry encoding="base64">ZmlsbEluID0gbmV3IEludGVudA==</entry>
        <entry encoding="base64">bVNlbnRJbnRlbnQ=</entry>
        <entry encoding="base64">bWVzc2FnZVR5cGUgPSBTbXMuTUVTU0FHRQ==</entry>
        <entry encoding="base64">U21zLk1FU1NBR0VfVFlQRV9GQUlMRUQ=</entry>
        <entry encoding="base64">cGVyc2lzdE9yVXBkYXRlTWVzc2FnZSg=</entry>
        <entry encoding="base64">cGVyc2lzdFNlbnRNZXNzYWdlSWZSZXF1aXJlZCg=</entry>
        <entry encoding="base64">c2VuZFRleHRGb3I=</entry>
        <entry encoding="base64">Z2V0UGhvbmU=</entry>
        <entry encoding="base64">c21z</entry>
        <entry encoding="base64">U21z</entry>
        <entry encoding="base64">Y2VsbA==</entry>
        <entry encoding="base64">Z2V0QWxsQ2VsbEluZm8=</entry>
        <entry encoding="base64">cmVxdWVzdENlbGxJbmZvVXBkYXRl</entry>
        <entry encoding="base64">aW50ZW50</entry>
        <entry encoding="base64">c21zUGR1</entry>
        <entry encoding="base64">U21zUGR1</entry>
        <entry encoding="base64">cGVuZGluZ0ludGVudA==</entry>
        <entry encoding="base64">SW5qZWN0U21zUGR1</entry>
        <entry encoding="base64">aW5qZWN0U21zUGR1</entry>
        <entry encoding="base64">UGVuZGluZ0ludGVudA==</entry>
        <entry encoding="base64">c2VudEludGVudA==</entry>
        <entry encoding="base64">c2VuZFRleHRNZXNzYWdlSW50ZXJuYWw=</entry>
        <entry encoding="base64">RVZFTlRfU0VORF9DT05GSVJNRURfU01T</entry>
        <entry encoding="base64">ZGVmYXVsdA==</entry>
        <entry encoding="base64">ZGVsaGl2ZXJ5</entry>
        <entry encoding="base64">UHJlU2VuZA==</entry>
        <entry encoding="base64">c3RhcnRTZXJ2aWNl</entry>
        <entry encoding="base64">c2VuZFRleHRNZXNzYWdlSW50ZXJuYWwo</entry>
        <entry encoding="base64">dm9pZCBzZW5kVGV4dE1lc3NhZ2VJbnRlcm5hbCg=</entry>
        <entry encoding="base64">dm9pZCBzZW5kRGF0YU1lc3NhZ2U=</entry>
        <entry encoding="base64">U2ltSW5mbw==</entry>
        <entry encoding="base64">c2V0UGhvbmU=</entry>
        <entry encoding="base64">bm90aWZ5RXJyb3I=</entry>
        <entry encoding="base64">bm90aWZ5</entry>
        <entry encoding="base64">bm90aWZ5U21zU3VjY2Vzcw==</entry>
        <entry encoding="base64">QWN0aXZpdHk=</entry>
        <entry encoding="base64">dm9pZCBzZW5kVGV4dE1lc3NhZ2VJbnRlcm5hbA==</entry>
        <entry encoding="base64">cmVwb3NpdG9yaWVz</entry>
        <entry encoding="base64">dGhpcw==</entry>
        <entry encoding="base64">UGlja0RvY3VtZW50Q29udHJhY3Q=</entry>
        <entry encoding="base64">TG9n</entry>
        <entry encoding="base64">Y29pbA==</entry>
        <entry encoding="base64">dmVyc2lvbg==</entry>
        <entry encoding="base64">Kg==</entry>
        <entry encoding="base64">a2xpbmtlcg==</entry>
        <entry encoding="base64">a290bGlueC1zZXJpYWw=</entry>
        <entry encoding="base64">c2hvd0FsbG93UGVybWlzc2lvbkJ0bi52YWx1ZQ==</entry>
        <entry encoding="base64">ZmlyZWJhc2U=</entry>
        <entry encoding="base64">aW5zZXJ0</entry>
        <entry encoding="base64">QWN0aXZpdHkuUkVTVUxUX09LQVk=</entry>
      </history-search>
      <history-cmd>
        <entry encoding="base64">c3BsaXQ=</entry>
        <entry encoding="base64">dnNwbGl0</entry>
        <entry encoding="base64">TkVSRFRyZWVUb2dnbGU=</entry>
        <entry encoding="base64">JzwsJz5ub3JtISBJQENvbHVtbkluZm8obmFtZSA9ICIiKSA=</entry>
        <entry encoding="base64">JzwsJz4gbm9ybSEgSXZhbCA=</entry>
        <entry encoding="base64">JzwsJz4gbm9ybSEgeCwgQSIi</entry>
        <entry encoding="base64">JzwsJz4gbm9ybSEgeCw=</entry>
        <entry encoding="base64">JzwsJz4gbm9ybSEgQSI6dyI=</entry>
        <entry encoding="base64">JzwsJz4gbm9ybSEgeGludGVudA==</entry>
        <entry encoding="base64">JzwsJz5ub3JtISB4ImludGVudCI=</entry>
        <entry encoding="base64">JzwsJz5ub3JtISB4XGludGVudA==</entry>
        <entry encoding="base64">JzwsJz5ub3JtISBpc2VuZFNlc3Npb25JbnRlbnQ=</entry>
        <entry encoding="base64">d2E=</entry>
        <entry encoding="base64">cQ==</entry>
        <entry encoding="base64">dw==</entry>
      </history-cmd>
      <history-expr />
      <history-input />
    </history>
  </component>
  <component name="VimMarksSettings">
    <globalmarks />
    <filemarks>
      <file name="$USER_HOME$/aosp-telephony/SmsController.opt.java" timestamp="1701599801798">
        <mark key="'" line="162" column="28" />
      </file>
      <file name="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/ToDoListViewModel.kt" timestamp="1701105946708">
        <mark key="[" line="63" column="59" />
        <mark key="]" line="63" column="72" />
        <mark key="." line="63" column="71" />
        <mark key="^" line="63" column="72" />
      </file>
      <file name="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/TelephonyManager.java" timestamp="1701601006719">
        <mark key="'" line="154" column="2" />
      </file>
      <file name="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" timestamp="1701106240364">
        <mark key="'" line="0" column="0" />
        <mark key="[" line="60" column="0" />
        <mark key="]" line="60" column="0" />
        <mark key="^" line="72" column="46" />
        <mark key="." line="60" column="0" />
      </file>
      <file name="$USER_HOME$/interview/build.gradle" timestamp="1701108864917">
        <mark key="[" line="10" column="55" />
        <mark key="]" line="10" column="55" />
        <mark key="^" line="10" column="55" />
        <mark key="." line="10" column="54" />
      </file>
      <file name="$USER_HOME$/interview/usertracker/src/main/AndroidManifest.xml" timestamp="1701108241310">
        <mark key="[" line="1" column="68" />
        <mark key="]" line="2" column="40" />
        <mark key="^" line="2" column="40" />
        <mark key="." line="2" column="39" />
      </file>
      <file name="$USER_HOME$/aosp-telephony/SubscriptionManager.java" timestamp="1701601146015">
        <mark key="'" line="0" column="0" />
        <mark key="[" line="0" column="0" />
        <mark key="]" line="4661" column="1" />
      </file>
      <file name="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SmsManager.java" timestamp="1701596458696">
        <mark key="'" line="584" column="21" />
      </file>
      <file name="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/dto/NotificationDto.kt" timestamp="1701104992650">
        <mark key="[" line="5" column="20" />
        <mark key="]" line="5" column="31" />
        <mark key="^" line="5" column="31" />
        <mark key="." line="5" column="30" />
      </file>
      <file name="$USER_HOME$/interview/usertracker/build.gradle" timestamp="1701107702707">
        <mark key="[" line="6" column="9" />
        <mark key="]" line="10" column="24" />
        <mark key="^" line="10" column="24" />
        <mark key="." line="10" column="23" />
      </file>
      <file name="$USER_HOME$/interview/README.md" timestamp="1701105417268">
        <mark key="[" line="43" column="59" />
        <mark key="]" line="43" column="58" />
        <mark key="." line="43" column="57" />
        <mark key="^" line="43" column="58" />
      </file>
      <file name="/Dummy.txt" timestamp="1701601167135">
        <mark key="[" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SubscriptionManager.java" timestamp="1701601362184">
        <mark key="'" line="0" column="0" />
        <mark key="[" line="0" column="0" />
        <mark key="]" line="3377" column="0" />
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/ListAdapter.kt" timestamp="1701105780918">
        <mark key="'" line="31" column="27" />
      </file>
      <file name="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SendSessionDataService.kt" timestamp="1701107393157">
        <mark key="'" line="81" column="39" />
        <mark key="[" line="34" column="17" />
        <mark key="]" line="30" column="36" />
        <mark key="." line="30" column="37" />
        <mark key="^" line="30" column="61" />
      </file>
      <file name="$USER_HOME$/interview/app/build.gradle" timestamp="1701107630349">
        <mark key="[" line="12" column="24" />
        <mark key="]" line="12" column="24" />
        <mark key="^" line="12" column="24" />
        <mark key="." line="12" column="23" />
      </file>
      <file name="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" timestamp="1701106033643">
        <mark key="'" line="83" column="54" />
        <mark key="[" line="80" column="33" />
        <mark key="]" line="80" column="50" />
        <mark key="." line="80" column="49" />
        <mark key="^" line="80" column="50" />
      </file>
      <file name="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/OnItemClick.kt" timestamp="1701105764071">
        <mark key="'" line="9" column="13" />
      </file>
    </filemarks>
    <jumps>
      <jump line="0" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/SmsBroadcastReceiver.kt" />
      <jump line="16" column="38" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/observers/SmsOberver.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/observers/SmsOberver.kt" />
      <jump line="2" column="28" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/TxnSmsReceiveBroadcast.kt" />
      <jump line="40" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/TxnSmsReceiveBroadcast.kt" />
      <jump line="13" column="40" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/TxnSmsReceiveBroadcast.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/TxnSmsReceiveBroadcast.kt" />
      <jump line="18" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/SmsReceiveBroadcast.kt" />
      <jump line="16" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/broadcasts/SmsSendBroadcast.kt" />
      <jump line="23" column="63" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/tasks/broadcasts/SmsReceiveBroadcast.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/tasks/broadcasts/SmsReceiveBroadcast.kt" />
      <jump line="41" column="2" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/ui/checkAdmin/CheckAdmin.comp.kt" />
      <jump line="27" column="36" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/ui/checkAdmin/CheckAdmin.comp.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/ui/checkAdmin/CheckAdmin.comp.kt" />
      <jump line="41" column="16" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/tasks/workers/ObserveMessages.kt" />
      <jump line="77" column="44" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/tasks/workers/ObserveMessages.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/tasks/workers/ObserveMessages.kt" />
      <jump line="29" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCM.kt" />
      <jump line="28" column="83" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCM.kt" />
      <jump line="2" column="10" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="80" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="49" column="25" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCM.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCM.kt" />
      <jump line="37" column="8" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="49" column="47" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="86" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="53" column="16" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="120" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="77" column="59" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="119" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/tasks/services/FCMC.kt" />
      <jump line="92" column="27" filename="$USER_HOME$/Delhivery/app/build.gradle.kts" />
      <jump line="96" column="0" filename="$USER_HOME$/Delhivery/app/src/main/java/com/delhivery/ui/screens/LoginScreen.kt" />
      <jump line="6" column="9" filename="$USER_HOME$/interview/README.md" />
      <jump line="19" column="24" filename="$USER_HOME$/interview/README.md" />
      <jump line="31" column="53" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="9" column="44" filename="$USER_HOME$/interview/README.md" />
      <jump line="22" column="0" filename="$USER_HOME$/interview/README.md" />
      <jump line="21" column="0" filename="$USER_HOME$/interview/README.md" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/README.md" />
      <jump line="40" column="0" filename="$USER_HOME$/interview/usertracker/build.gradle" />
      <jump line="11" column="97" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="19" column="55" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="10" column="17" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="31" column="29" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="16" column="0" filename="$USER_HOME$/DelhiveryAdmin/app/src/main/java/com/delhivery/admin/di/TasksRetrofitInstance.kt" />
      <jump line="2" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/RetrofitInstance.kt" />
      <jump line="17" column="27" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/RetrofitInstance.kt" />
      <jump line="18" column="13" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/RetrofitInstance.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/RetrofitInstance.kt" />
      <jump line="10" column="30" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/database/ToDoListDataEntity.kt" />
      <jump line="30" column="38" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="76" column="54" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="22" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="24" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionDb.kt" />
      <jump line="10" column="21" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionDb.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionDb.kt" />
      <jump line="23" column="42" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="59" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="37" column="5" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="45" column="16" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SendData.service.kt" />
      <jump line="11" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveData.service.kt" />
      <jump line="16" column="16" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveData.service.kt" />
      <jump line="16" column="29" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionEntity.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionEntity.kt" />
      <jump line="40" column="4" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionDao.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/usersession/UserSessionDao.kt" />
      <jump line="18" column="16" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/server/ServerDao.kt" />
      <jump line="47" column="19" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveData.service.kt" />
      <jump line="6" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveData.service.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveData.service.kt" />
      <jump line="15" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/server/ServerDao.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/db/server/ServerDao.kt" />
      <jump line="72" column="27" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SendSessionDataService.kt" />
      <jump line="67" column="39" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SendSessionDataService.kt" />
      <jump line="50" column="48" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/tasks/services/SaveSessionDataService.kt" />
      <jump line="26" column="25" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="105" column="4" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="32" column="33" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="134" column="31" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="75" column="50" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="84" column="54" filename="$USER_HOME$/interview/usertracker/src/main/java/com/example/usertracker/UserTracker.kt" />
      <jump line="24" column="49" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="97" column="0" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="22" column="0" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="53" column="32" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="9" column="13" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/OnItemClick.kt" />
      <jump line="31" column="27" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/ListAdapter.kt" />
      <jump line="75" column="2" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="0" column="0" filename="$USER_HOME$/interview/app/src/main/java/com/example/todolistinkotlin/notification/AlarmReceiver.kt" />
      <jump line="584" column="21" filename="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SmsManager.java" />
      <jump line="0" column="0" filename="$USER_HOME$/android_frameworks_base/test.java" />
      <jump line="162" column="28" filename="$USER_HOME$/aosp-telephony/SmsController.opt.java" />
      <jump line="154" column="2" filename="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/TelephonyManager.java" />
      <jump line="247" column="0" filename="$USER_HOME$/aosp-telephony/SubscriptionManager.java" />
      <jump line="0" column="0" filename="$USER_HOME$/aosp-telephony/SubscriptionManager.java" />
      <jump line="86" column="2" filename="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SubscriptionManager.java" />
      <jump line="8" column="1" filename="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SubscriptionManager.java" />
      <jump line="0" column="0" filename="$USER_HOME$/android_frameworks_base/telephony/java/android/telephony/SubscriptionManager.java" />
    </jumps>
  </component>
  <component name="VimRegisterSettings">
    <registers>
      <register name="&quot;" type="2">
        <text encoding="base64">LyoKICogQ29weXJpZ2h0IChDKSAyMDE0IFRoZSBBbmRyb2lkIE9wZW4gU291cmNlIFByb2plY3QKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBhbmRyb2lkLnRlbGVwaG9ueTsKCmltcG9ydCBzdGF0aWMgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXIuU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRDsKaW1wb3J0IHN0YXRpYyBhbmRyb2lkLm5ldC5OZXR3b3JrUG9saWN5TWFuYWdlci5TVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEOwoKaW1wb3J0IGFuZHJvaWQuTWFuaWZlc3Q7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uQ2FsbGJhY2tFeGVjdXRvcjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5Db2xvckludDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5EdXJhdGlvbk1pbGxpc0xvbmc7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uSW50RGVmOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLk5vbk51bGw7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uTnVsbGFibGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uUmVxdWlyZXNGZWF0dXJlOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlJlcXVpcmVzUGVybWlzc2lvbjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudC5TZGtDb25zdGFudFR5cGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uU3VwcHJlc3NBdXRvRG9jOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlN5c3RlbUFwaTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TeXN0ZW1TZXJ2aWNlOwppbXBvcnQgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudDsKaW1wb3J0IGFuZHJvaWQuYXBwLlByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTsKaW1wb3J0IGFuZHJvaWQuY29tcGF0LmFubm90YXRpb24uVW5zdXBwb3J0ZWRBcHBVc2FnZTsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5Db250ZXh0OwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkludGVudDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlSW5mbzsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuQ29uZmlndXJhdGlvbjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuUmVzb3VyY2VzOwppbXBvcnQgYW5kcm9pZC5kYXRhYmFzZS5Db250ZW50T2JzZXJ2ZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5OZXR3b3JrQ2FwYWJpbGl0aWVzOwppbXBvcnQgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5Vcmk7CmltcG9ydCBhbmRyb2lkLm9zLkJpbmRlcjsKaW1wb3J0IGFuZHJvaWQub3MuQnVpbGQ7CmltcG9ydCBhbmRyb2lkLm9zLkJ1bmRsZTsKaW1wb3J0IGFuZHJvaWQub3MuSGFuZGxlcjsKaW1wb3J0IGFuZHJvaWQub3MuTG9vcGVyOwppbXBvcnQgYW5kcm9pZC5vcy5QYXJjZWxVdWlkOwppbXBvcnQgYW5kcm9pZC5vcy5Qcm9jZXNzOwppbXBvcnQgYW5kcm9pZC5vcy5SZW1vdGVFeGNlcHRpb247CmltcG9ydCBhbmRyb2lkLnByb3ZpZGVyLlRlbGVwaG9ueS5TaW1JbmZvOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuZXVpY2MuRXVpY2NNYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLkltc01tVGVsTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQudXRpbC5CYXNlNjQ7CmltcG9ydCBhbmRyb2lkLnV0aWwuTG9nOwppbXBvcnQgYW5kcm9pZC51dGlsLlBhaXI7CgppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTdWI7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuUGhvbmVDb25zdGFudHM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkudXRpbC5IYW5kbGVyRXhlY3V0b3I7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC51dGlsLkZ1bmN0aW9uYWxVdGlsczsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnV0aWwuUHJlY29uZGl0aW9uczsKaW1wb3J0IGNvbS5hbmRyb2lkLnRlbGVwaG9ueS5SbG9nOwoKaW1wb3J0IGphdmEuaW8uQnl0ZUFycmF5SW5wdXRTdHJlYW07CmltcG9ydCBqYXZhLmlvLkJ5dGVBcnJheU91dHB1dFN0cmVhbTsKaW1wb3J0IGphdmEuaW8uSU9FeGNlcHRpb247CmltcG9ydCBqYXZhLmlvLk9iamVjdElucHV0U3RyZWFtOwppbXBvcnQgamF2YS5pby5PYmplY3RPdXRwdXRTdHJlYW07CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb25Qb2xpY3k7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkFycmF5czsKaW1wb3J0IGphdmEudXRpbC5Db2xsZWN0aW9uczsKaW1wb3J0IGphdmEudXRpbC5IYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLkxpc3Q7CmltcG9ydCBqYXZhLnV0aWwuTG9jYWxlOwppbXBvcnQgamF2YS51dGlsLk1hcDsKaW1wb3J0IGphdmEudXRpbC5jb25jdXJyZW50LkNvbmN1cnJlbnRIYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLmNvbmN1cnJlbnQuRXhlY3V0b3I7CmltcG9ydCBqYXZhLnV0aWwuZnVuY3Rpb24uQ29uc3VtZXI7CmltcG9ydCBqYXZhLnV0aWwuc3RyZWFtLkNvbGxlY3RvcnM7CgovKioKICogU3Vic2NyaXB0aW9uTWFuYWdlciBpcyB0aGUgYXBwbGljYXRpb24gaW50ZXJmYWNlIHRvIFN1YnNjcmlwdGlvbkNvbnRyb2xsZXIKICogYW5kIHByb3ZpZGVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IFRlbGVwaG9ueSBTdWJzY3JpcHRpb25zLgogKi8KQFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU1VCU0NSSVBUSU9OX1NFUlZJQ0UpCkBSZXF1aXJlc0ZlYXR1cmUoUGFja2FnZU1hbmFnZXIuRkVBVFVSRV9URUxFUEhPTllfU1VCU0NSSVBUSU9OKQpwdWJsaWMgY2xhc3MgU3Vic2NyaXB0aW9uTWFuYWdlciB7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBTdHJpbmcgTE9HX1RBRyA9ICJTdWJzY3JpcHRpb25NYW5hZ2VyIjsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGJvb2xlYW4gREJHID0gZmFsc2U7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBib29sZWFuIFZEQkcgPSBmYWxzZTsKCiAgICAvKiogQW4gaW52YWxpZCBzdWJzY3JpcHRpb24gaWRlbnRpZmllciAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgPSAtMTsKCiAgICAvKiogQmFzZSB2YWx1ZSBmb3IgcGxhY2Vob2xkZXIgU1VCU0NSSVBUSU9OX0lEJ3MuICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBMQUNFSE9MREVSX1NVQlNDUklQVElPTl9JRF9CQVNFID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBBbiBpbnZhbGlkIHBob25lIGlkZW50aWZpZXIgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9QSE9ORV9JTkRFWCA9IC0xOwoKICAgIC8qKiBJbmRpY2F0ZXMgaW52YWxpZCBzaW0gc2xvdC4gVGhpcyBjYW4gYmUgcmV0dXJuZWQgYnkge0BsaW5rICNnZXRTbG90SW5kZXgoaW50KX0uICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTlZBTElEX1NJTV9TTE9UX0lOREVYID0gLTE7CgogICAgLyoqIEluZGljYXRlcyB0aGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gSUQgaW4gVGVsZXBob255LiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQgPSBJbnRlZ2VyLk1BWF9WQUxVRTsKCiAgICAvKioKICAgICAqIEluZGljYXRlcyB0aGUgY2FsbGVyIHdhbnRzIHRoZSBkZWZhdWx0IHBob25lIGlkLgogICAgICogVXNlZCBpbiBTdWJzY3JpcHRpb25Db250cm9sbGVyIGFuZCBQaG9uZSBidXQgZG8gd2UgcmVhbGx5IG5lZWQgaXQ/Pz8KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfUEhPTkVfSU5ERVggPSBJbnRlZ2VyLk1BWF9WQUxVRTsKCiAgICAvKiogSW5kaWNhdGVzIHRoZSBjYWxsZXIgd2FudHMgdGhlIGRlZmF1bHQgc2xvdCBpZC4gTk9UIHVzZWQgcmVtb3ZlPyAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUZBVUxUX1NJTV9TTE9UX0lOREVYID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqIE1pbmltdW0gcG9zc2libGUgc3ViaWQgdGhhdCByZXByZXNlbnRzIGEgc3Vic2NyaXB0aW9uICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1JTl9TVUJTQ1JJUFRJT05fSURfVkFMVUUgPSAwOwoKICAgIC8qKiBNYXhpbXVtIHBvc3NpYmxlIHN1YmlkIHRoYXQgcmVwcmVzZW50cyBhIHN1YnNjcmlwdGlvbiAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNQVhfU1VCU0NSSVBUSU9OX0lEX1ZBTFVFID0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIENPTlRFTlRfVVJJID0gU2ltSW5mby5DT05URU5UX1VSSTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSA9CiAgICAgICAgICAgICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfREVGQVVMVF9EQVRBX1NVQl9JRF9QUk9QRVJUWSA9CiAgICAgICAgICAgICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfZGVmYXVsdF9zbXNfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9BQ1RJVkVfREFUQV9TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfYWN0aXZlX2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9TTE9UX0lOREVYX1BST1BFUlRZID0KICAgICAgICAgICAgImNhY2hlX2tleS50ZWxlcGhvbnkuZ2V0X3Nsb3RfaW5kZXgiOwoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgR0VUX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19NRVRIT0RfTkFNRSA9ICJnZXRTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFJFU1RPUkVfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FID0KICAgICAgICAgICAgInJlc3RvcmVTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKioKICAgICAqIEtleSB0byB0aGUgYmFja3VwICYgcmVzdG9yZSBkYXRhIGJ5dGUgYXJyYXkgaW4gdGhlIEJ1bmRsZSB0aGF0IGlzIHJldHVybmVkIGJ5IHtAbGluawogICAgICogI2dldEFsbFNpbVNwZWNpZmljU2V0dGluZ3NGb3JCYWNrdXAoKX0gb3IgdG8gYmUgcGFzcyBpbiB0byB7QGxpbmsKICAgICAqICNyZXN0b3JlQWxsU2ltU3BlY2lmaWNTZXR0aW5ncygpfS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBLRVlfU0lNX1NQRUNJRklDX1NFVFRJTkdTX0RBVEEgPSAiS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBIjsKCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpbnQgTUFYX0NBQ0hFX1NJWkUgPSA0OwoKICAgIHByaXZhdGUgc3RhdGljIGNsYXNzIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8VD4KICAgICAgICAgICAgZXh0ZW5kcyBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8Vm9pZCwgVD4gewogICAgICAgIHByaXZhdGUgZmluYWwgRnVuY3Rpb25hbFV0aWxzLlRocm93aW5nRnVuY3Rpb248SVN1YiwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0Z1bmN0aW9uPElTdWIsIFQ+IHN1YnNjcmlwdGlvbkludGVyZmFjZU1ldGhvZCwKICAgICAgICAgICAgICAgIFN0cmluZyBjYWNoZUtleVByb3BlcnR5LAogICAgICAgICAgICAgICAgVCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgc3VwZXIoTUFYX0NBQ0hFX1NJWkUsIGNhY2hlS2V5UHJvcGVydHkpOwogICAgICAgICAgICBtSW50ZXJmYWNlTWV0aG9kID0gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kOwogICAgICAgICAgICBtQ2FjaGVLZXlQcm9wZXJ0eSA9IGNhY2hlS2V5UHJvcGVydHk7CiAgICAgICAgICAgIG1EZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQoKICAgICAgICBAT3ZlcnJpZGUKICAgICAgICBwdWJsaWMgVCByZWNvbXB1dGUoVm9pZCBhVm9pZCkgewogICAgICAgICAgICBUIHJlc3VsdCA9IG1EZWZhdWx0VmFsdWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbUludGVyZmFjZU1ldGhvZC5hcHBseU9yVGhyb3coaVN1Yik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBjbGFzcyBJbnRlZ2VyUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPFQ+CiAgICAgICAgICAgIGV4dGVuZHMgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXIsIFQ+IHsKICAgICAgICBwcml2YXRlIGZpbmFsIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kLAogICAgICAgICAgICAgICAgU3RyaW5nIGNhY2hlS2V5UHJvcGVydHksCiAgICAgICAgICAgICAgICBUIGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICBzdXBlcihNQVhfQ0FDSEVfU0laRSwgY2FjaGVLZXlQcm9wZXJ0eSk7CiAgICAgICAgICAgIG1JbnRlcmZhY2VNZXRob2QgPSBzdWJzY3JpcHRpb25JbnRlcmZhY2VNZXRob2Q7CiAgICAgICAgICAgIG1DYWNoZUtleVByb3BlcnR5ID0gY2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICAgICAgbURlZmF1bHRWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CgogICAgICAgIEBPdmVycmlkZQogICAgICAgIHB1YmxpYyBUIHJlY29tcHV0ZShJbnRlZ2VyIHF1ZXJ5KSB7CiAgICAgICAgICAgIFQgcmVzdWx0ID0gbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBtSW50ZXJmYWNlTWV0aG9kLmFwcGx5T3JUaHJvdyhpU3ViLCBxdWVyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzRGVmYXVsdERhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXREZWZhdWx0RGF0YVN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX0RBVEFfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICAgICAgICAgIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEKTsKCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U21zU3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFNtc1N1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFksCiAgICAgICAgICAgICAgICAgICAgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQpOwoKICAgIHByaXZhdGUgc3RhdGljIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8SW50ZWdlcj4gc0FjdGl2ZURhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRBY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgICAgICAgICAgQ0FDSEVfS0VZX0FDVElWRV9EQVRBX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzU2xvdEluZGV4Q2FjaGUgPQogICAgICAgICAgICBuZXcgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTw+KElTdWI6OmdldFNsb3RJbmRleCwKICAgICAgICAgICAgICAgICAgICBDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NJTV9TTE9UX0lOREVYKTsKCiAgICAvKiogQ2FjaGUgZGVwZW5kcyBvbiBnZXREZWZhdWx0U3ViSWQsIHNvIHdlIHVzZSB0aGUgZGVmYXVsdFN1YklkIGNhY2hlIGtleSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzUGhvbmVJZENhY2hlID0KICAgICAgICAgICAgbmV3IEludGVnZXJQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRQaG9uZUlkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1BIT05FX0lOREVYKTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gc2ltSW5mbyBjaGFuZ2UKICAgICAqIG9uIHRoZSBnaXZlbiBzdWJzY3JpcHRpb25JZAogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb25JZCB0byByZWNlaXZlIHVwZGF0ZXMgb24KICAgICAqIEByZXR1cm4gdGhlIFVyaSB1c2VkIHRvIG9ic2VydmUgY2FycmllciBpZGVudGl0eSBjaGFuZ2VzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIFVyaSBnZXRVcmlGb3JTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gVXJpLndpdGhBcHBlbmRlZFBhdGgoQ09OVEVOVF9VUkksIFN0cmluZy52YWx1ZU9mKHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIGVuYWJsZWQgdXNlciBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVm9XaUZpU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgV0ZDX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwgIndmYyIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIGFkdmFuY2VkIGNhbGxpbmcgdXNlciBzZXR0aW5nCiAgICAgKiBAc2VlIEltc01tVGVsTWFuYWdlciNpc0FkdmFuY2VkQ2FsbGluZ1NldHRpbmdFbmFibGVkKCkuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIGFkdmFuY2VkIGNhbGxpbmcgZW5hYmxlZAogICAgICoge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0FkdmFuY2VkQ2FsbGluZ1NldHRpbmdFbmFibGVkKCl9IHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuCiAgICAgKiBZb3UgY2FuIGFsc28gdXNlIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YKICAgICAqIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQURWQU5DRURfQ0FMTElOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAiYWR2YW5jZWRfY2FsbGluZyIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIHdmYyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyBtb2RlIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjZ2V0Vm9XaUZpTW9kZVNldHRpbmcoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKENPTlRFTlRfVVJJLCAid2ZjX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyByb2FtaW5nIG1vZGUge0BsaW5rIEltc01tVGVsTWFuYWdlciNnZXRWb1dpRmlSb2FtaW5nTW9kZVNldHRpbmcoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19NT0RFX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfbW9kZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIHZ0KHZpZGVvIHRlbGVwaG9ueSBvdmVyIElNUykgZW5hYmxlZAogICAgICogc2V0dGluZy4KICAgICAqIDxwPgogICAgICogVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gdnQgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVnRTZXR0aW5nRW5hYmxlZCgpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdCBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFZUX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aCgKICAgICAgICAgICAgQ09OVEVOVF9VUkksICJ2dF9lbmFibGVkIik7CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIHJvYW1pbmcgZW5hYmxlZCBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgcm9hbWluZyBlbmFibGVkIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjaXNWb1dpRmlSb2FtaW5nU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfZW5hYmxlZCIpOwoKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgdXJpfSB1c2VkIHRvIGNhbGwgdGhlIGFwcHJvcHJpYXRlIGJhY2t1cCBvciByZXN0b3JlIG1ldGhvZCBmb3Igc2ltLXNwZWNpZmljCiAgICAgKiBzZXR0aW5ncwogICAgICogPHA+CiAgICAgKiBTZWUge0BsaW5rICNHRVRfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FfSBhbmQge0BsaW5rCiAgICAgKiAjUkVTVE9SRV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUV9IGZvciBpbmZvcm1hdGlvbiBvbiB3aGF0IG1ldGhvZCB0byBjYWxsLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgImJhY2t1cF9hbmRfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayB1cml9IHVzZWQgdG8gbm90aWZ5IGNvbnRlbnRvYnNlcnZlcnMgbGlzdGVuaW5nIHRvIHNpbWluZm8gcmVzdG9yZSBkdXJpbmcKICAgICAqIFN1Vy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBTSU1fSU5GT19TVVdfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBTSU1fSU5GT19CQUNLVVBfQU5EX1JFU1RPUkVfQ09OVEVOVF9VUkksICJzdXdfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIGNyb3NzIHNpbSBlbmFibGVkIHVzZXIgc2V0dGluZy4KICAgICAqIDxwPgogICAgICogVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gY3Jvc3Mgc2ltIGNhbGxpbmcgZW5hYmxlZAogICAgICoge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0Nyb3NzU2ltQ2FsbGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQ1JPU1NfU0lNX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwKICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRCk7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciB1bmlxdWUga2V5IGNvbHVtbiBuYW1lIGlzIHRoZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFVOSVFVRV9LRVlfU1VCU0NSSVBUSU9OX0lEID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fVU5JUVVFX0tFWV9TVUJTQ1JJUFRJT05fSUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlCiAgICAgKiBzcGVjaWZpYyBzdWJzY3JpcHRpb24gdHlwZS4gRm9yIGV4YW1wbGUsIGl0IGNvbnRhaW5zIFNJTSBJQ0MgSWRlbnRpZmllciBzdWJzY3JpcHRpb25zCiAgICAgKiBvbiBMb2NhbCBTSU1zLiBhbmQgTWFjLWFkZHJlc3MgZm9yIFJlbW90ZS1TSU0gU3Vic2NyaXB0aW9ucyBmb3IgQmx1ZXRvb3RoIGRldmljZXMuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElDQ19JRCA9IFNpbUluZm8uQ09MVU1OX0lDQ19JRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB1c2VyIFNJTV9TbE9UX0lOREVYCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFNJTV9TTE9UX0lOREVYID0gU2ltSW5mby5DT0xVTU5fU0lNX1NMT1RfSU5ERVg7CgogICAgLyoqIFNJTSBpcyBub3QgaW5zZXJ0ZWQgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX05PVF9JTlNFUlRFRCA9IFNpbUluZm8uU0lNX05PVF9JTlNFUlRFRDsKCiAgICAvKioKICAgICAqIFRoZSBzbG90LWluZGV4IGZvciBCbHVldG9vdGggUmVtb3RlLVNJTSBzdWJzY3JpcHRpb25zCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTTE9UX0lOREVYX0ZPUl9SRU1PVEVfU0lNX1NVQiA9IElOVkFMSURfU0lNX1NMT1RfSU5ERVg7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBTdWJzY3JpcHRpb24tdHlwZS4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+IHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNfSBmb3IgTG9jYWwtU0lNIFN1YnNjcmlwdGlvbnMsCiAgICAgKiB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU19IGZvciBSZW1vdGUtU0lNIFN1YnNjcmlwdGlvbnMuCiAgICAgKiBEZWZhdWx0IHZhbHVlIGlzIDAuCiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgU1VCU0NSSVBUSU9OX1RZUEUgPSBTaW1JbmZvLkNPTFVNTl9TVUJTQ1JJUFRJT05fVFlQRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGRhdGFfZW5hYmxlZF9vdmVycmlkZV9ydWxlcy4KICAgICAqIEl0J3MgYSBsaXN0IG9mIHJ1bGVzIGZvciBvdmVycmlkaW5nIGRhdGEgZW5hYmxlZCBzZXR0aW5ncy4gVGhlIHN5bnRheCBpcwogICAgICogRm9yIGV4YW1wbGUsICJtbXM9bm9uRGVmYXVsdCIgaW5kaWNhdGVzIGVuYWJsaW5nIGRhdGEgZm9yIG1tcyBpbiBub24tZGVmYXVsdCBzdWJzY3JpcHRpb24uCiAgICAgKiAiZGVmYXVsdD1ub25EZWZhdWx0JmluVm9pY2VDYWxsIiBpbmRpY2F0ZXMgZW5hYmxpbmcgZGF0YSBmb3IgaW50ZXJuZXQgaW4gbm9uLWRlZmF1bHQKICAgICAqIHN1YnNjcmlwdGlvbiBhbmQgd2hpbGUgaXMgaW4gdm9pY2UgY2FsbC4KICAgICAqCiAgICAgKiBEZWZhdWx0IHZhbHVlIGlzIGVtcHR5IHN0cmluZy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVMgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9EQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVM7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiU1VCU0NSSVBUSU9OX1RZUEVfIn0sCiAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgIFNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTSwKICAgICAgICAgICAgU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTX0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBTdWJzY3JpcHRpb25UeXBlIHt9CgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnN0YW50IGlzIHRvIGRlc2lnbmF0ZSBhIHN1YnNjcmlwdGlvbiBhcyBhIExvY2FsLVNJTSBTdWJzY3JpcHRpb24uCiAgICAgKiA8cD4gQSBMb2NhbC1TSU0gY2FuIGJlIGEgcGh5c2ljYWwgU0lNIGluc2VydGVkIGludG8gYSBzaW0tc2xvdCBpbiB0aGUgZGV2aWNlLCBvciBlU0lNIG9uIHRoZQogICAgICogZGV2aWNlLgogICAgICogPC9wPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVUJTQ1JJUFRJT05fVFlQRV9MT0NBTF9TSU0gPSBTaW1JbmZvLlNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTTsKCiAgICAvKioKICAgICAqIFRoaXMgY29uc3RhbnQgaXMgdG8gZGVzaWduYXRlIGEgc3Vic2NyaXB0aW9uIGFzIGEgUmVtb3RlLVNJTSBTdWJzY3JpcHRpb24uCiAgICAgKiA8cD4KICAgICAqIEEgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMgZm9yIGEgU0lNIG9uIGEgcGhvbmUgY29ubmVjdGVkIHRvIHRoaXMgZGV2aWNlIHZpYSBzb21lCiAgICAgKiBjb25uZWN0aXZpdHkgbWVjaGFuaXNtLCBmb3IgZXhhbXBsZSBibHVldG9vdGguIFNpbWlsYXIgdG8gTG9jYWwgU0lNLCB0aGlzIHN1YnNjcmlwdGlvbiBjYW4KICAgICAqIGJlIHVzZWQgZm9yIFNNUywgVm9pY2UgYW5kIGRhdGEgYnkgcHJveHlpbmcgZGF0YSB0aHJvdWdoIHRoZSBjb25uZWN0ZWQgZGV2aWNlLgogICAgICogQ2VydGFpbiBkYXRhIG9mIHRoZSBTSU0sIHN1Y2ggYXMgSU1FSSwgYXJlIG5vdCBhY2Nlc3NpYmxlIGZvciBSZW1vdGUgU0lNcy4KICAgICAqIDwvcD4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIEEgUmVtb3RlLVNJTSBpcyBhdmFpbGFibGUgb25seSBhcyBsb25nIHRoZSBwaG9uZSBzdGF5cyBjb25uZWN0ZWQgdG8gdGhpcyBkZXZpY2UuCiAgICAgKiBXaGVuIHRoZSBwaG9uZSBkaXNjb25uZWN0cywgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMgcmVtb3ZlZCBmcm9tIHRoaXMgZGV2aWNlIGFuZCBpcwogICAgICogbm8gbG9uZ2VyIGtub3duLiBBbGwgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbiwgc3VjaCBhcyBzdG9yZWQgU01TLCBjYWxsIGxvZ3MsCiAgICAgKiBjb250YWN0cyBldGMsIGFyZSByZW1vdmVkIGZyb20gdGhpcyBkZXZpY2UuCiAgICAgKiA8L3A+CiAgICAgKgogICAgICogPHA+CiAgICAgKiBJZiB0aGUgcGhvbmUgcmUtY29ubmVjdHMgdG8gdGhpcyBkZXZpY2UsIGEgbmV3IFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9uIGlzIGNyZWF0ZWQgZm9yCiAgICAgKiB0aGUgcGhvbmUuIFRoZSBTdWJzY3JpcHRpb24gSWQgYXNzb2NpYXRlZCB3aXRoIHRoZSBuZXcgc3Vic2NyaXB0aW9uIGlzIGRpZmZlcmVudCBmcm9tCiAgICAgKiB0aGUgU3Vic2NyaXB0aW9uIElkIG9mIHRoZSBwcmV2aW91cyBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiBjcmVhdGVkIChhbmQgcmVtb3ZlZCkgZm9yIHRoZQogICAgICogcGhvbmU7IGkuZS4sIG5ldyBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiB0cmVhdHMgdGhlIHJlY29ubmVjdGVkIHBob25lIGFzIGEgUmVtb3RlLVNJTSB0aGF0CiAgICAgKiB3YXMgbmV2ZXIgc2VlbiBiZWZvcmUuCiAgICAgKiA8L3A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU0gPSBTaW1JbmZvLlNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU07CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdXNlciBkaXNwbGF5ZWQgbmFtZS4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRElTUExBWV9OQU1FID0gU2ltSW5mby5DT0xVTU5fRElTUExBWV9OQU1FOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBzZXJ2aWNlIHByb3ZpZGVyIG5hbWUgZm9yIHRoZSBTSU0uCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBUlJJRVJfTkFNRSA9IFNpbUluZm8uQ09MVU1OX0NBUlJJRVJfTkFNRTsKCiAgICAvKioKICAgICAqIERlZmF1bHQgbmFtZSByZXNvdXJjZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREVGQVVMVF9OQU1FX1JFUyA9IGNvbS5hbmRyb2lkLmludGVybmFsLlIuc3RyaW5nLnVua25vd25OYW1lOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHNvdXJjZSBvZiB0aGUgdXNlciBkaXNwbGF5ZWQgbmFtZS4KICAgICAqIDxQPlR5cGU6IElOVCAoaW50KTwvUD4gd2l0aCBvbmUgb2YgdGhlIE5BTUVfU09VUkNFX1hYWFggdmFsdWVzIGJlbG93CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTkFNRV9TT1VSQ0UgPSBTaW1JbmZvLkNPTFVNTl9OQU1FX1NPVVJDRTsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIHRoZSBjYXJyaWVyIGlkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRCA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRDsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIFNJTSBFRl9TUE4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9TSU1fU1BOID0gU2ltSW5mby5OQU1FX1NPVVJDRV9TSU1fU1BOOwoKICAgIC8qKgogICAgICogVGhlIG5hbWVfc291cmNlIGlzIGZyb20gdXNlciBpbnB1dAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5BTUVfU09VUkNFX1VTRVJfSU5QVVQgPSBTaW1JbmZvLk5BTUVfU09VUkNFX1VTRVJfSU5QVVQ7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgY2FycmllciAoY2FycmllciBhcHAsIGNhcnJpZXIgY29uZmlnLCBldGMuKQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfQ0FSUklFUiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfQ0FSUklFUjsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIFNJTSBFRl9QTk4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9TSU1fUE5OID0gU2ltSW5mby5OQU1FX1NPVVJDRV9TSU1fUE5OOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7Ik5BTUVfU09VUkNFXyJ9LAogICAgICAgICAgICB2YWx1ZSA9IHsKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9DQVJSSUVSX0lELAogICAgICAgICAgICAgICAgICAgIE5BTUVfU09VUkNFX1NJTV9TUE4sCiAgICAgICAgICAgICAgICAgICAgTkFNRV9TT1VSQ0VfVVNFUl9JTlBVVCwKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9DQVJSSUVSLAogICAgICAgICAgICAgICAgICAgIE5BTUVfU09VUkNFX1NJTV9QTk4KICAgICAgICAgICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFNpbURpc3BsYXlOYW1lU291cmNlIHt9CgogICAgLyoqCiAgICAgKiBEZXZpY2Ugc3RhdHVzIGlzIG5vdCBzaGFyZWQgdG8gYSByZW1vdGUgcGFydHkuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEQyRF9TSEFSSU5HX0RJU0FCTEVEID0gMDsKCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgc2hhcmVkIHdpdGggYWxsIG51bWJlcnMgaW4gdGhlIHVzZXIncyBjb250YWN0cy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRDJEX1NIQVJJTkdfQUxMX0NPTlRBQ1RTID0gMTsKCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgc2hhcmVkIHdpdGggYWxsIHNlbGVjdGVkIGNvbnRhY3RzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEMkRfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUyA9IDI7CgogICAgLyoqCiAgICAgKiBEZXZpY2Ugc3RhdHVzIGlzIHNoYXJlZCB3aGVuZXZlciBwb3NzaWJsZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRDJEX1NIQVJJTkdfQUxMID0gMzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJEMkRfU0hBUklOR18ifSwKICAgICAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgICAgICAgICAgRDJEX1NIQVJJTkdfRElTQUJMRUQsCiAgICAgICAgICAgICAgICAgICAgRDJEX1NIQVJJTkdfQUxMX0NPTlRBQ1RTLAogICAgICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX1NFTEVDVEVEX0NPTlRBQ1RTLAogICAgICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX0FMTAogICAgICAgICAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgRGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSB7fQoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGRldmljZSB0byBkZXZpY2Ugc2hhcmluZyBzdGF0dXMuCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEMkRfU1RBVFVTX1NIQVJJTkcgPSBTaW1JbmZvLkNPTFVNTl9EMkRfU1RBVFVTX1NIQVJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgY29udGFjdHMgaW5mb3JtYXRpb24gdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHNoYXJpbmcuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEMkRfU1RBVFVTX1NIQVJJTkdfU0VMRUNURURfQ09OVEFDVFMgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9EMkRfU1RBVFVTX1NIQVJJTkdfU0VMRUNURURfQ09OVEFDVFM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIGNvbG9yIG9mIGEgU0lNLgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBIVUUgPSBTaW1JbmZvLkNPTFVNTl9DT0xPUjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgcGhvbmUgbnVtYmVyIG9mIGEgU0lNLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBOVU1CRVIgPSBTaW1JbmZvLkNPTFVNTl9OVU1CRVI7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igd2hldGhlciBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZC4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgREFUQV9ST0FNSU5HID0gU2ltSW5mby5DT0xVTU5fREFUQV9ST0FNSU5HOwoKICAgIC8qKiBJbmRpY2F0ZXMgdGhhdCBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZCBmb3IgYSBzdWJzY3JpcHRpb24gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfUk9BTUlOR19FTkFCTEUgPSBTaW1JbmZvLkRBVEFfUk9BTUlOR19FTkFCTEU7CgogICAgLyoqIEluZGljYXRlcyB0aGF0IGRhdGEgcm9hbWluZyBpcyBkaXNhYmxlZCBmb3IgYSBzdWJzY3JpcHRpb24gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfUk9BTUlOR19ESVNBQkxFID0gU2ltSW5mby5EQVRBX1JPQU1JTkdfRElTQUJMRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBzdWJzY3JpcHRpb24gY2FycmllciBpZC4KICAgICAqIEBzZWUgVGVsZXBob255TWFuYWdlciNnZXRTaW1DYXJyaWVySWQoKQogICAgICogPHA+VHlwZTogSU5URUdFUiAoaW50KSA8L3A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJSSUVSX0lEID0gU2ltSW5mby5DT0xVTU5fQ0FSUklFUl9JRDsKCiAgICAvKioKICAgICAqIEBoaWRlIEEgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgRUhQTE1OcyBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRUhQTE1OUyA9IFNpbUluZm8uQ09MVU1OX0VIUExNTlM7CgogICAgLyoqCiAgICAgKiBAaGlkZSBBIGNvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIEhQTE1OcyBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSFBMTU5TID0gU2ltSW5mby5DT0xVTU5fSFBMTU5TOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNQ0MgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLCBzdG9yZWQgYXMgYSBzdHJpbmcuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTUNDX1NUUklORyA9IFNpbUluZm8uQ09MVU1OX01DQ19TVFJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIE1OQyBhc3NvY2lhdGVkIHdpdGggYSBTSU0sIHN0b3JlZCBhcyBhIHN0cmluZy4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNTkNfU1RSSU5HID0gU2ltSW5mby5DT0xVTU5fTU5DX1NUUklORzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgTUNDIGFzc29jaWF0ZWQgd2l0aCBhIFNJTS4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNQ0MgPSBTaW1JbmZvLkNPTFVNTl9NQ0M7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIE1OQyBhc3NvY2lhdGVkIHdpdGggYSBTSU0uCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTU5DID0gU2ltSW5mby5DT0xVTU5fTU5DOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBpc28gY291bnRyeSBjb2RlIGFzc29jaWF0ZWQgd2l0aCBhIFNJTS4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJU09fQ09VTlRSWV9DT0RFID0gU2ltSW5mby5DT0xVTU5fSVNPX0NPVU5UUllfQ09ERTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIGVtYmVkZGVkICh0aGF0IGlzLCBwcmVzZW50IG9uIGFuCiAgICAgKiBlU0lNKS4KICAgICAqIDxwPlR5cGU6IElOVEVHRVIgKGludCksIDEgZm9yIGVtYmVkZGVkIG9yIDAgZm9yIG5vbi1lbWJlZGRlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX0VNQkVEREVEID0gU2ltSW5mby5DT0xVTU5fSVNfRU1CRURERUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgU0lNIGNhcmQgaWRlbnRpZmllci4gRm9yIFVJQ0MgY2FyZCBpdCBpcyB0aGUgSUNDSUQgb2YgdGhlCiAgICAgKiBjdXJyZW50IGVuYWJsZWQgcHJvZmlsZSBvbiB0aGUgY2FyZCwgd2hpbGUgZm9yIGVVSUNDIGNhcmQgaXQgaXMgdGhlIEVJRCBvZiB0aGUgY2FyZC4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJEX0lEID0gU2ltSW5mby5DT0xVTU5fQ0FSRF9JRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgZW5jb2RlZCB7QGxpbmsgVWljY0FjY2Vzc1J1bGV9cyBmcm9tCiAgICAgKiB7QGxpbmsgVWljY0FjY2Vzc1J1bGUjZW5jb2RlUnVsZXN9LiBPbmx5IHByZXNlbnQgaWYge0BsaW5rICNJU19FTUJFRERFRH0gaXMgMS4KICAgICAqIDxwPlRZUEU6IEJMT0IKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDQ0VTU19SVUxFUyA9IFNpbUluZm8uQ09MVU1OX0FDQ0VTU19SVUxFUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgZW5jb2RlZCB7QGxpbmsgVWljY0FjY2Vzc1J1bGV9cyBmcm9tCiAgICAgKiB7QGxpbmsgVWljY0FjY2Vzc1J1bGUjZW5jb2RlUnVsZXN9IGJ1dCBmb3IgdGhlIHJ1bGVzIHRoYXQgY29tZSBmcm9tIENhcnJpZXJDb25maWdzLgogICAgICogT25seSBwcmVzZW50IGlmIHRoZXJlIGFyZSBhY2Nlc3MgcnVsZXMgaW4gQ2FycmllckNvbmZpZ3MKICAgICAqIDxwPlRZUEU6IEJMT0IKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDQ0VTU19SVUxFU19GUk9NX0NBUlJJRVJfQ09ORklHUyA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0FDQ0VTU19SVUxFU19GUk9NX0NBUlJJRVJfQ09ORklHUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGlkZW50aWZ5aW5nIHdoZXRoZXIgYW4gZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGlzIG9uIGEgcmVtb3ZhYmxlCiAgICAgKiBjYXJkLiBTdWNoIHN1YnNjcmlwdGlvbnMgYXJlIG1hcmtlZCBpbmFjY2Vzc2libGUgYXMgc29vbiBhcyB0aGUgY3VycmVudCBjYXJkIGlzIHJlbW92ZWQuCiAgICAgKiBPdGhlcndpc2UsIHRoZXkgd2lsbCByZW1haW4gYWNjZXNzaWJsZSB1bmxlc3MgZXhwbGljaXRseSBkZWxldGVkLiBPbmx5IHByZXNlbnQgaWYKICAgICAqIHtAbGluayAjSVNfRU1CRURERUR9IGlzIDEuCiAgICAgKiA8cD5UWVBFOiBJTlRFR0VSIChpbnQpLCAxIGZvciByZW1vdmFibGUgb3IgMCBmb3Igbm9uLXJlbW92YWJsZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX1JFTU9WQUJMRSA9IFNpbUluZm8uQ09MVU1OX0lTX1JFTU9WQUJMRTsKCiAgICAvKioKICAgICAqICBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZXh0cmVtZSB0aHJlYXQgaW4gQ0Igc2V0dGluZ3MKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0VYVFJFTUVfVEhSRUFUX0FMRVJUID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ0JfRVhUUkVNRV9USFJFQVRfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igc2V2ZXJlIHRocmVhdCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9TRVZFUkVfVEhSRUFUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfU0VWRVJFX1RIUkVBVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbWJlciBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTUJFUl9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0FNQkVSX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVtZXJnZW5jeSBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9FTUVSR0VOQ1lfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9FTUVSR0VOQ1lfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYWxlcnQgc291bmQgZHVyYXRpb24gaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfU09VTkRfRFVSQVRJT04gPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9TT1VORF9EVVJBVElPTjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbGVydCByZW1pbmRlciBpbnRlcnZhbCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTEVSVF9SRU1JTkRFUl9JTlRFUlZBTCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1JFTUlOREVSX0lOVEVSVkFMOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsaW5nIHZpYnJhdGUgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfVklCUkFURSA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1ZJQlJBVEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZW5hYmxpbmcgYWxlcnQgc3BlZWNoIGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0FMRVJUX1NQRUVDSCA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1NQRUVDSDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBFVFdTIHRlc3QgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfRVRXU19URVNUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfRVRXU19URVNUX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBjaGFubmVsNTAgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQ0hBTk5FTF81MF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NIQU5ORUxfNTBfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgQ01BUyB0ZXN0IGFsZXJ0IGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0NNQVNfVEVTVF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NNQVNfVEVTVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBPcHQgb3V0IGRpYWxvZyBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9PUFRfT1VUX0RJQUxPRyA9IFNpbUluZm8uQ09MVU1OX0NCX09QVF9PVVRfRElBTE9HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBWb2x0ZS4KICAgICAqCiAgICAgKiBJZiB0aGlzIHNldHRpbmcgaXMgbm90IGluaXRpYWxpemVkIChzZXQgdG8gLTEpICB0aGVuIHdlIHVzZSB0aGUgQ2FycmllciBDb25maWcgdmFsdWUKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfRU5IQU5DRURfNEdfTFRFX09OX0JZX0RFRkFVTFRfQk9PTH0uCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVOSEFOQ0VEXzRHX01PREVfRU5BQkxFRCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0VOSEFOQ0VEXzRHX01PREVfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgVlQgKFZpZGVvIFRlbGVwaG9ueSBvdmVyIElNUykKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVlRfSU1TX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9WVF9JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgV2lmaSBjYWxsaW5nCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFdGQ19JTVNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBXaWZpIGNhbGxpbmcgbW9kZQogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX01PREUgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX01PREU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgV2lmaSBjYWxsaW5nIG1vZGUgaW4gcm9hbWluZwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfTU9ERSA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19NT0RFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBXaWZpIGNhbGxpbmcgaW4gcm9hbWluZwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19FTkFCTEVEOwoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgdXNlciBoYXMgZW5hYmxlZCBJTVMgUkNTIFVzZXIgQ2FwYWJpbGl0eSBFeGNoYW5nZSAoVUNFKSBmb3IgdGhpcwogICAgICogc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSU1TX1JDU19VQ0VfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX0lNU19SQ1NfVUNFX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB1c2VyIGhhcyBlbmFibGVkIGNyb3NzIFNJTSBjYWxsaW5nIGZvciB0aGlzIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDUk9TU19TSU1fQ0FMTElOR19FTkFCTEVEID0gU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIG9wcG9ydHVuaXN0aWMsIHRoYXQgaXMsCiAgICAgKiB3aGV0aGVyIHRoZSBuZXR3b3JrIGl0IGNvbm5lY3RzIHRvIGlzIGxpbWl0ZWQgaW4gZnVuY3Rpb25hbGl0eSBvciBjb3ZlcmFnZS4KICAgICAqIEZvciBleGFtcGxlLCBDQlJTLgogICAgICogPHA+VHlwZTogSU5URUdFUiAoaW50KSwgMSBmb3Igb3Bwb3J0dW5pc3RpYyBvciAwIGZvciBub24tb3Bwb3J0dW5pc3RpYy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX09QUE9SVFVOSVNUSUMgPSBTaW1JbmZvLkNPTFVNTl9JU19PUFBPUlRVTklTVElDOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGdyb3VwIElELiBTdWJzY3JpcHRpb25zIHdpdGggc2FtZSBncm91cCBJRAogICAgICogYXJlIGNvbnNpZGVyZWQgYnVuZGxlZCB0b2dldGhlciwgYW5kIHNob3VsZCBiZWhhdmUgYXMgYSBzaW5nbGUgc3Vic2NyaXB0aW9uIGF0CiAgICAgKiBjZXJ0YWluIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBHUk9VUF9VVUlEID0gU2ltSW5mby5DT0xVTU5fR1JPVVBfVVVJRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBncm91cCBvd25lci4gSXQncyB0aGUgcGFja2FnZSBuYW1lIHdobyBjcmVhdGVkCiAgICAgKiB0aGUgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEdST1VQX09XTkVSID0gU2ltSW5mby5DT0xVTU5fR1JPVVBfT1dORVI7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIHByb2ZpbGUgY2xhc3Mgb2YgYSBzdWJzY3JpcHRpb24KICAgICAqIE9ubHkgcHJlc2VudCBpZiB7QGxpbmsgI0lTX0VNQkVEREVEfSBpcyAxLgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFBST0ZJTEVfQ0xBU1MgPSBTaW1JbmZvLkNPTFVNTl9QUk9GSUxFX0NMQVNTOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBwb3J0IGluZGV4IG9mIHRoZSBhY3RpdmUgVUlDQyBwb3J0LgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFBPUlRfSU5ERVggPSBTaW1JbmZvLkNPTFVNTl9QT1JUX0lOREVYOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIFZvSU1TIG9wdC1pbiBzdGF0dXMuCiAgICAgKgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFZPSU1TX09QVF9JTl9TVEFUVVMgPSBTaW1JbmZvLkNPTFVNTl9WT0lNU19PUFRfSU5fU1RBVFVTOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIE5SIEFkdmFuY2VkIGNhbGxpbmcKICAgICAqIERldGVybWluZXMgaWYgdGhlIHVzZXIgaGFzIGVuYWJsZWQgVm9OUiBzZXR0aW5ncyBmb3IgdGhpcyBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTlJfQURWQU5DRURfQ0FMTElOR19FTkFCTEVEID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fTlJfQURWQU5DRURfQ0FMTElOR19FTkFCTEVEOwoKICAgIC8qKgogICAgICogUHJvZmlsZSBjbGFzcyBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsgIlBST0ZJTEVfQ0xBU1NfIiB9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1RFU1RJTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTCwKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1VOU0VULAogICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFByb2ZpbGVDbGFzcyB7fQoKICAgIC8qKgogICAgICogQSB0ZXN0aW5nIHByb2ZpbGUgY2FuIGJlIHByZS1sb2FkZWQgb3IgZG93bmxvYWRlZCBvbnRvCiAgICAgKiB0aGUgZVVJQ0MgYW5kIHByb3ZpZGVzIGNvbm5lY3Rpdml0eSB0byB0ZXN0IGVxdWlwbWVudAogICAgICogZm9yIHRoZSBwdXJwb3NlIG9mIHRlc3RpbmcgdGhlIGRldmljZSBhbmQgdGhlIGVVSUNDLiBJdAogICAgICogaXMgbm90IGludGVuZGVkIHRvIHN0b3JlIGFueSBvcGVyYXRvciBjcmVkZW50aWFscy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfVEVTVElORyA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19URVNUSU5HOwoKICAgIC8qKgogICAgICogQSBwcm92aXNpb25pbmcgcHJvZmlsZSBpcyBwcmUtbG9hZGVkIG9udG8gdGhlIGVVSUNDIGFuZAogICAgICogcHJvdmlkZXMgY29ubmVjdGl2aXR5IHRvIGEgbW9iaWxlIG5ldHdvcmsgc29sZWx5IGZvciB0aGUKICAgICAqIHB1cnBvc2Ugb2YgcHJvdmlzaW9uaW5nIHByb2ZpbGVzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfUFJPVklTSU9OSU5HOwoKICAgIC8qKgogICAgICogQW4gb3BlcmF0aW9uYWwgcHJvZmlsZSBjYW4gYmUgcHJlLWxvYWRlZCBvciBkb3dubG9hZGVkCiAgICAgKiBvbnRvIHRoZSBlVUlDQyBhbmQgcHJvdmlkZXMgc2VydmljZXMgcHJvdmlkZWQgYnkgdGhlCiAgICAgKiBvcGVyYXRvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfT1BFUkFUSU9OQUwgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfT1BFUkFUSU9OQUw7CgogICAgLyoqCiAgICAgKiBUaGUgcHJvZmlsZSBjbGFzcyBpcyB1bnNldC4gVGhpcyBvY2N1cnMgd2hlbiBwcm9maWxlIGNsYXNzCiAgICAgKiBpbmZvIGlzIG5vdCBhdmFpbGFibGUuIFRoZSBzdWJzY3JpcHRpb24gZWl0aGVyIGhhcyBubyBwcm9maWxlCiAgICAgKiBtZXRhZGF0YSBvciB0aGUgcHJvZmlsZSBtZXRhZGF0YSBkaWQgbm90IGVuY29kZSBwcm9maWxlIGNsYXNzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19VTlNFVCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19VTlNFVDsKCiAgICAvKioKICAgICAqIERlZmF1bHQgcHJvZmlsZSBjbGFzcwogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfREVGQVVMVCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19VTlNFVDsKCiAgICAvKioKICAgICAqIElNU0kgKEludGVybmF0aW9uYWwgTW9iaWxlIFN1YnNjcmliZXIgSWRlbnRpdHkpLgogICAgICogPFA+VHlwZTogVEVYVCA8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICAvL1RPRE86IGFkZCBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJTVNJID0gU2ltSW5mby5DT0xVTU5fSU1TSTsKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdWljYyBhcHBsaWNhdGlvbnMgaXMgc2V0IHRvIGJlIGVuYWJsZWQgb3IgZGlzYWJsZWQuIEJ5IGRlZmF1bHQgaXQncyBlbmFibGVkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVUlDQ19BUFBMSUNBVElPTlNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1VJQ0NfQVBQTElDQVRJT05TX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSB3aGljaCBuZXR3b3JrIHR5cGUgaXMgYWxsb3dlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFMTE9XRURfTkVUV09SS19UWVBFUyA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0FMTE9XRURfTkVUV09SS19UWVBFU19GT1JfUkVBU09OUzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJVU0FHRV9TRVRUSU5HXyJ9LAogICAgICAgIHZhbHVlID0gewogICAgICAgICAgICBVU0FHRV9TRVRUSU5HX1VOS05PV04sCiAgICAgICAgICAgIFVTQUdFX1NFVFRJTkdfREVGQVVMVCwKICAgICAgICAgICAgVVNBR0VfU0VUVElOR19WT0lDRV9DRU5UUklDLAogICAgICAgICAgICBVU0FHRV9TRVRUSU5HX0RBVEFfQ0VOVFJJQ30pCiAgICBwdWJsaWMgQGludGVyZmFjZSBVc2FnZVNldHRpbmcge30KCiAgICAvKioKICAgICAqIFRoZSB1c2FnZSBzZXR0aW5nIGlzIHVua25vd24uCiAgICAgKgogICAgICogVGhpcyB3aWxsIGJlIHRoZSB1c2FnZSBzZXR0aW5nIHJldHVybmVkIG9uIGRldmljZXMgdGhhdCBkbyBub3Qgc3VwcG9ydCBxdWVyeWluZyB0aGUKICAgICAqIG9yIHNldHRpbmcgdGhlIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogSXQgbWF5IGFsc28gYmUgcHJvdmlkZWQgYnkgYSBjYXJyaWVyIHRoYXQgd2lzaGVzIHRvIHByb3ZpZGUgYSB2YWx1ZSB0byBhdm9pZCBtYWtpbmcgYW55CiAgICAgKiBzZXR0aW5ncyBjaGFuZ2VzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX1VOS05PV04gPSAtMTsKCiAgICAvKioKICAgICAqIFN1YnNjcmlwdGlvbiB1c2VzIHRoZSBkZWZhdWx0IHNldHRpbmcuCiAgICAgKgogICAgICogVGhlIHZhbHVlIGlzIGJhc2VkIHVwb24gZGV2aWNlIGNhcGFiaWxpdHkgYW5kIHRoZSBvdGhlciBwcm9wZXJ0aWVzIG9mIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogTW9zdCBzdWJzY3JpcHRpb25zIHdpbGwgZGVmYXVsdCB0byB2b2ljZS1jZW50cmljIHdoZW4gaW4gYSBwaG9uZS4KICAgICAqCiAgICAgKiBBbiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiB3aWxsIGRlZmF1bHQgdG8gZGF0YS1jZW50cmljLgogICAgICoKICAgICAqIHtAc2VlIFN1YnNjcmlwdGlvbkluZm8jaXNPcHBvcnR1bmlzdGljfQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX0RFRkFVTFQgPSAwOwoKICAgIC8qKgogICAgICogVGhpcyBzdWJzY3JpcHRpb24gaXMgZm9yY2VkIHRvIHZvaWNlLWNlbnRyaWMgbW9kZQogICAgICoKICAgICAqIDxwPlJlZmVyIHRvIHZvaWNlLWNlbnRyaWMgbW9kZSBpbiAzZ3BwIDI0LjMwMSBzZWMgNC4zIGFuZCAzZ3BwIDI0LjUwMSBzZWMgNC4zLgogICAgICogQWxzbyByZWZlciB0byAiVUUncyB1c2FnZSBzZXR0aW5nIiBhcyBkZWZpbmVkIGluIDNncHAgMjQuMzAxIHNlY3Rpb24gMy4xIGFuZCAzZ3BwIDIzLjIyMQogICAgICogQW5uZXggQS4KICAgICAqCiAgICAgKiA8cD5EZXZpY2VzIHRoYXQgc3VwcG9ydCB7QGxpbmsgUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTllfQ0FMTElOR30gYW5kIHN1cHBvcnQgdXNhZ2UKICAgICAqIHNldHRpbmcgY29uZmlndXJhdGlvbiBtdXN0IHN1cHBvcnQgc2V0dGluZyB0aGlzIHZhbHVlIHZpYQogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DRUxMVUxBUl9VU0FHRV9TRVRUSU5HX0lOVH0uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTQUdFX1NFVFRJTkdfVk9JQ0VfQ0VOVFJJQyA9IDE7CgogICAgLyoqCiAgICAgKiBUaGlzIHN1YnNjcmlwdGlvbiBpcyBmb3JjZWQgdG8gZGF0YS1jZW50cmljIG1vZGUKICAgICAqCiAgICAgKiA8cD5SZWZlciB0byBkYXRhLWNlbnRyaWMgbW9kZSBpbiAzZ3BwIDI0LjMwMSBzZWMgNC4zIGFuZCAzZ3BwIDI0LjUwMSBzZWMgNC4zLgogICAgICogQWxzbyByZWZlciB0byAiVUUncyB1c2FnZSBzZXR0aW5nIiBhcyBkZWZpbmVkIGluIDNncHAgMjQuMzAxIHNlY3Rpb24gMy4xIGFuZCAzZ3BwIDIzLjIyMQogICAgICogQW5uZXggQS4KICAgICAqCiAgICAgKiA8cD5EZXZpY2VzIHRoYXQgc3VwcG9ydCB7QGxpbmsgUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTllfREFUQX0gYW5kIHN1cHBvcnQgdXNhZ2UKICAgICAqIHNldHRpbmcgY29uZmlndXJhdGlvbiBtdXN0IHN1cHBvcnQgc2V0dGluZyB0aGlzIHZhbHVlIHZpYS4KICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ0VMTFVMQVJfVVNBR0VfU0VUVElOR19JTlR9LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX0RBVEFfQ0VOVFJJQyA9IDI7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSB0aGUgcHJlZmVycmVkIHVzYWdlIHNldHRpbmcgZm9yIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogMCAtIERlZmF1bHQgLSBJZiB0aGUgdmFsdWUgaGFzIG5vdCBiZWVuIGV4cGxpY2l0bHkgc2V0LCBpdCB3aWxsIGJlICJkZWZhdWx0IgogICAgICogMSAtIFZvaWNlLWNlbnRyaWMKICAgICAqIDIgLSBEYXRhLWNlbnRyaWMKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBVU0FHRV9TRVRUSU5HID0gU2ltSW5mby5DT0xVTU5fVVNBR0VfU0VUVElORzsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSB1c2VyIGhhcyBjaGFuZ2VkIG9uZSBvZiB0aGUgZGVmYXVsdCBzdWJzIHJlbGF0ZWQgdG8KICAgICAqIGRhdGEsIHBob25lIGNhbGxzLCBvciBzbXM8L3A+CiAgICAgKgogICAgICogVE9ETzogQ2hhbmdlIHRvIGEgbGlzdGVuZXIKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBTVUJfREVGQVVMVF9DSEFOR0VEX0FDVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLmludGVudC5hY3Rpb24uU1VCX0RFRkFVTFRfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICogVGhlIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSBleHRyYSBpbmRpY2F0ZXMgdGhlIGN1cnJlbnQgZGVmYXVsdCBzdWJzY3JpcHRpb24gaW5kZXgKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VECiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBkZWZhdWx0IHNtcyBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICoge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IGV4dHJhIGluZGljYXRlcyB0aGUgY3VycmVudCBkZWZhdWx0IHNtcwogICAgICogc3Vic2NyaXB0aW9uIGluZGV4CiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fREVGQVVMVF9TTVNfU1VCU0NSSVBUSU9OX0NIQU5HRUQKICAgICAgICAgICAgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLkRFRkFVTFRfU01TX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEFjdGl2aXR5IEFjdGlvbjogRGlzcGxheSBVSSBmb3IgbWFuYWdpbmcgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW5zCiAgICAgKiBiZXR3ZWVuIGEgY2FycmllciBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBDYXJyaWVyIGFwcHMgYXJlIGVuY291cmFnZWQgdG8gaW1wbGVtZW50IHRoaXMgYWN0aXZpdHksIGFuZCB0aGUgT1Mgd2lsbAogICAgICogcHJvdmlkZSBhbiBhZmZvcmRhbmNlIHRvIHF1aWNrbHkgZW50ZXIgdGhpcyBhY3Rpdml0eSwgdHlwaWNhbGx5IHZpYQogICAgICogU2V0dGluZ3MuIFRoaXMgYWZmb3JkYW5jZSB3aWxsIG9ubHkgYmUgc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMKICAgICAqIGFjdGl2ZWx5IHByb3ZpZGluZyBzdWJzY3JpcHRpb24gcGxhbiBpbmZvcm1hdGlvbiB2aWEKICAgICAqIHtAbGluayAjc2V0U3Vic2NyaXB0aW9uUGxhbnMoaW50LCBMaXN0KX0uCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIHRoZSB1c2VyIGlzIGludGVyZXN0ZWQgaW4uCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQUNUSVZJVFlfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFucwogICAgICogYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogQ2FycmllciBhcHBzIGFyZSBlbmNvdXJhZ2VkIHRvIGltcGxlbWVudCB0aGlzIHJlY2VpdmVyLCBhbmQgdGhlIE9TIHdpbGwKICAgICAqIHByb3ZpZGUgYW4gYWZmb3JkYW5jZSB0byByZXF1ZXN0IGEgcmVmcmVzaC4gVGhpcyBhZmZvcmRhbmNlIHdpbGwgb25seSBiZQogICAgICogc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMgYWN0aXZlbHkgcHJvdmlkaW5nIHN1YnNjcmlwdGlvbiBwbGFuCiAgICAgKiBpbmZvcm1hdGlvbiB2aWEge0BsaW5rICNzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQsIExpc3QpfS4KICAgICAqIDxwPgogICAgICogQ29udGFpbnMge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IHRvIGluZGljYXRlIHdoaWNoIHN1YnNjcmlwdGlvbgogICAgICogdGhlIHVzZXIgaXMgaW50ZXJlc3RlZCBpbi4KICAgICAqIDxwPgogICAgICogUmVjZWl2ZXJzIHNob3VsZCBwcm90ZWN0IHRoZW1zZWx2ZXMgYnkgY2hlY2tpbmcgdGhhdCB0aGUgc2VuZGVyIGhvbGRzIHRoZQogICAgICoge0Bjb2RlIGFuZHJvaWQucGVybWlzc2lvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TfSBwZXJtaXNzaW9uLgogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1JFRlJFU0hfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5SRUZSRVNIX1NVQlNDUklQVElPTl9QTEFOUyI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbnMgYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEKICAgICAqIHNwZWNpZmljIHN1YnNjcmliZXIgaGFzIGNoYW5nZWQuCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIGNoYW5nZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTUFOQUdFX1NVQlNDUklQVElPTl9QTEFOUykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TVUJTQ1JJUFRJT05fUExBTlNfQ0hBTkdFRAogICAgICAgICAgICA9ICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uU1VCU0NSSVBUSU9OX1BMQU5TX0NIQU5HRUQiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fREVGQVVMVF9TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gYW5kCiAgICAgKiB7QGxpbmsgI0FDVElPTl9ERUZBVUxUX1NNU19TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gdG8gaW5kaWNhdGUgdGhlIHN1YnNjcmlwdGlvbgogICAgICogd2hpY2ggaGFzIGNoYW5nZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NVQlNDUklQVElPTl9JTkRFWCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TVUJTQ1JJUFRJT05fSU5ERVgiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB0byBzcGVjaWZ5IFNJTSBzbG90IGluZGV4LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TTE9UX0lOREVYID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNMT1RfSU5ERVgiOwoKICAgIC8qKgogICAgICogQSBzb3VyY2Ugb2YgcGhvbmUgbnVtYmVyOiB0aGUgRUYtTVNJU0ROIChzZWUgM0dQUCBUUyAzMS4xMDIpLAogICAgICogb3IgRUYtTUROIGZvciBDRE1BIChzZWUgM0dQUDIgQy5QMDA2NS1CKSwgZnJvbSBVSUNDIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIDxwPlRoZSBhdmFpbGFiaWxpdHkgYW5kIGEgb2YgdGhlIG51bWJlciBkZXBlbmRzIG9uIHRoZSBjYXJyaWVyLgogICAgICogVGhlIG51bWJlciBtYXkgYmUgdXBkYXRlZCBieSBvdmVyLXRoZS1haXIgdXBkYXRlIHRvIFVJQ0MgYXBwbGljYXRpb25zCiAgICAgKiBmcm9tIHRoZSBjYXJyaWVyLCBvciBieSBvdGhlciBtZWFucyB3aXRoIHBoeXNpY2FsIGFjY2VzcyB0byB0aGUgU0lNLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgPSAxOwoKICAgIC8qKgogICAgICogQSBzb3VyY2Ugb2YgcGhvbmUgbnVtYmVyOiBwcm92aWRlZCBieSBhbiBhcHAgdGhhdCBoYXMgY2FycmllciBwcml2aWxlZ2UuCiAgICAgKgogICAgICogPHA+VGhlIG51bWJlciBpcyBpbnRlbmRlZCB0byBiZSBzZXQgYnkgYSBjYXJyaWVyIGFwcCBrbm93aW5nIHRoZSBjb3JyZWN0IG51bWJlcgogICAgICogd2hpY2ggaXMsIGZvciBleGFtcGxlLCBkaWZmZXJlbnQgZnJvbSB0aGUgbnVtYmVyIGluIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9CiAgICAgKiBmb3Igc29tZSByZWFzb24uCiAgICAgKiBUaGUgbnVtYmVyIGlzIG5vdCBhdmFpbGFibGUgdW50aWwgYSBjYXJyaWVyIGFwcCBzZXRzIG9uZSB2aWEKICAgICAqIHtAbGluayAjc2V0Q2FycmllclBob25lTnVtYmVyKGludCwgU3RyaW5nKX0uCiAgICAgKiBUaGUgYXBwIGNhbiB1cGRhdGUgdGhlIG51bWJlciB3aXRoIHRoZSBzYW1lIEFQSSBzaG91bGQgdGhlIG51bWJlciBjaGFuZ2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiA9IDI7CgogICAgLyoqCiAgICAgKiBBIHNvdXJjZSBvZiBwaG9uZSBudW1iZXI6IHByb3ZpZGVkIGJ5IElNUyAoSVAgTXVsdGltZWRpYSBTdWJzeXN0ZW0pIGltcGxlbWVudGF0aW9uLgogICAgICogV2hlbiBJTVMgc2VydmljZSBpcyByZWdpc3RlcmVkIChhcyBpbmRpY2F0ZWQgYnkKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuUmVnaXN0cmF0aW9uTWFuYWdlci5SZWdpc3RyYXRpb25DYWxsYmFjayNvblJlZ2lzdGVyZWQoaW50KX0pCiAgICAgKiB0aGUgSU1TIGltcGxlbWVudGF0aW9uIG1heSByZXR1cm4gUC1Bc3NvY2lhdGVkLVVyaSBTSVAgaGVhZGVycyAoUkZDIDM0NTUpLiBUaGUgVVJJcwogICAgICogYXJlIHRoZSB1c2Vy4oCZcyBwdWJsaWMgdXNlciBpZGVudGl0aWVzIGtub3duIHRvIHRoZSBuZXR3b3JrIChzZWUgM0dQUCBUUyAyNC4yMjkgNS40LjEuMiksCiAgICAgKiBhbmQgdGhlIHBob25lIG51bWJlciBpcyB0eXBpY2FsbHkgb25lIG9mIHRoZW0gKHNlZSDigJxnbG9iYWwgbnVtYmVy4oCdIGluIDNHUFAgVFMgMjMuMDAzIDEzLjQpLgogICAgICoKICAgICAqIDxwPlRoaXMgc291cmNlIHByb3ZpZGVzIHRoZSBwaG9uZSBudW1iZXIgZnJvbSB0aGUgbGFzdCBJTVMgcmVnaXN0cmF0aW9uLgogICAgICogSU1TIHJlZ2lzdHJhdGlvbiBtYXkgaGFwcGVuIG9uIGV2ZXJ5IGRldmljZSByZWJvb3Qgb3Igb3RoZXIgbmV0d29yayBjb25kaXRpb24gY2hhbmdlcy4KICAgICAqIFRoZSBudW1iZXIgd2lsbCBiZSB1cGRhdGVkIHNob3VsZCB0aGUgYXNzb2NpYXRlZCBVUkkgY2hhbmdlIGFmdGVyIGFuIElNUyByZWdpc3RyYXRpb24uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX05VTUJFUl9TT1VSQ0VfSU1TID0gMzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJQSE9ORV9OVU1CRVJfU09VUkNFIn0sCiAgICAgICAgICAgIHZhbHVlID0gewogICAgICAgICAgICAgICAgICAgIFBIT05FX05VTUJFUl9TT1VSQ0VfVUlDQywKICAgICAgICAgICAgICAgICAgICBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIsCiAgICAgICAgICAgICAgICAgICAgUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVMsCiAgICAgICAgICAgIH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBQaG9uZU51bWJlclNvdXJjZSB7fQoKICAgIHByaXZhdGUgZmluYWwgQ29udGV4dCBtQ29udGV4dDsKCiAgICAvLyBDYWNoZSBvZiBSZXNvdXJjZSB0aGF0IGhhcyBiZWVuIGNyZWF0ZWQgaW4gZ2V0UmVzb3VyY2VzRm9yU3ViSWQuIEtleSBpcyBhIFBhaXIgY29udGFpbmluZwogICAgLy8gdGhlIENvbnRleHQgYW5kIHN1YklkLgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTWFwPFBhaXI8Q29udGV4dCwgSW50ZWdlcj4sIFJlc291cmNlcz4gc1Jlc291cmNlc0NhY2hlID0KICAgICAgICAgICAgbmV3IENvbmN1cnJlbnRIYXNoTWFwPD4oKTsKCiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgY2xhc3MgZm9yIG1vbml0b3JpbmcgY2hhbmdlcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3Jkcy4KICAgICAqIDxwPgogICAgICogT3ZlcnJpZGUgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIGluIHRoZSBvYmplY3QgdGhhdCBleHRlbmRzIHRoaXMKICAgICAqIGNsYXNzIGFuZCBwYXNzIGl0IHRvIHtAbGluayAjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9CiAgICAgKiB0byByZWdpc3RlciB5b3VyIGxpc3RlbmVyIGFuZCB0byB1bnJlZ2lzdGVyIGludm9rZQogICAgICoge0BsaW5rICNyZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciAjb25TdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciB7CiAgICAgICAgcHJpdmF0ZSBjbGFzcyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyIGV4dGVuZHMgSGFuZGxlciB7CiAgICAgICAgICAgIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lckhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKExvb3BlciBsb29wZXIpIHsKICAgICAgICAgICAgICAgIHN1cGVyKGxvb3Blcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFBvc3RlZCBleGVjdXRvciBjYWxsYmFjayBvbiB0aGUgaGFuZGxlciBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBsb29wZXIuCiAgICAgICAgICogVGhlIGxvb3BlciBjYW4gYmUgdGhlIGNhbGxpbmcgdGhyZWFkJ3MgbG9vcGVyIG9yIHRoZSBsb29wZXIgcGFzc2VkIGZyb20gdGhlCiAgICAgICAgICogY29uc3RydWN0b3Ige0BsaW5rICNPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyKX0uCiAgICAgICAgICovCiAgICAgICAgcHJpdmF0ZSBmaW5hbCBIYW5kbGVyRXhlY3V0b3IgbUV4ZWN1dG9yOwoKICAgICAgICAvKioKICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBIYW5kbGVyRXhlY3V0b3IgZ2V0SGFuZGxlckV4ZWN1dG9yKCkgewogICAgICAgICAgICByZXR1cm4gbUV4ZWN1dG9yOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigpIHsKICAgICAgICAgICAgbUV4ZWN1dG9yID0gbmV3IEhhbmRsZXJFeGVjdXRvcihuZXcgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVySGFuZGxlcigpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEFsbG93IGEgbGlzdGVuZXIgdG8gYmUgY3JlYXRlZCB3aXRoIGEgY3VzdG9tIGxvb3BlcgogICAgICAgICAqIEBwYXJhbSBsb29wZXIgdGhlIGxvb3BlciB0aGF0IHRoZSB1bmRlcmxpbmluZyBoYW5kbGVyIHNob3VsZCBydW4gb24KICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyIGxvb3BlcikgewogICAgICAgICAgICBtRXhlY3V0b3IgPSBuZXcgSGFuZGxlckV4ZWN1dG9yKG5ldyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKGxvb3BlcikpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIHRoZXJlIGlzIGFueSBjaGFuZ2UgdG8gYW55IFN1YnNjcmlwdGlvbkluZm8sIGFzIHdlbGwgYXMgb25jZSBvbgogICAgICAgICAqIHJlZ2lzdGVyaW5nIGZvciBjaGFuZ2VzIHdpdGgge0BsaW5rICNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9LiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAoREJHKSBsb2coIm9uU3Vic2NyaXB0aW9uc0NoYW5nZWQ6IE5PVCBPVkVSUklEREVOIik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBpbnZva2VkIHdoZW4ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAqIEV4ZWN1dG9yLCBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBvcgogICAgICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgKiBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBmYWlscyB0byBjb21wbGV0ZSBkdWUgdG8gdGhlCiAgICAgICAgICoge0BsaW5rIENvbnRleHQjVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0V9IGJlaW5nIHVuYXZhaWxhYmxlLgogICAgICAgICAqIEBoaWRlCiAgICAgICAgICovCiAgICAgICAgcHVibGljIHZvaWQgb25BZGRMaXN0ZW5lckZhaWxlZCgpIHsKICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJvbkFkZExpc3RlbmVyRmFpbGVkIG5vdCBvdmVycmlkZGVuIik7CiAgICAgICAgfQoKICAgICAgICBwcml2YXRlIHZvaWQgbG9nKFN0cmluZyBzKSB7CiAgICAgICAgICAgIFJsb2cuZChMT0dfVEFHLCBzKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN1YnNjcmlwdGlvbk1hbmFnZXIoQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgaWYgKERCRykgbG9nZCgiU3Vic2NyaXB0aW9uTWFuYWdlciBjcmVhdGVkIik7CiAgICAgICAgbUNvbnRleHQgPSBjb250ZXh0OwogICAgfQoKICAgIHByaXZhdGUgTmV0d29ya1BvbGljeU1hbmFnZXIgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKSB7CiAgICAgICAgcmV0dXJuIChOZXR3b3JrUG9saWN5TWFuYWdlcikgbUNvbnRleHQKICAgICAgICAgICAgICAgIC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuTkVUV09SS19QT0xJQ1lfU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBkZXZlbG9wZXJzIHNob3VsZCBhbHdheXMgb2J0YWluIHJlZmVyZW5jZXMgZGlyZWN0bHkgZnJvbQogICAgICogICAgICAgICAgICAge0BsaW5rIENvbnRleHQjZ2V0U3lzdGVtU2VydmljZShDbGFzcyl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHN0YXRpYyBTdWJzY3JpcHRpb25NYW5hZ2VyIGZyb20oQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIChTdWJzY3JpcHRpb25NYW5hZ2VyKSBjb250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9TVUJTQ1JJUFRJT05fU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBhY3RpdmUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgb3IgdG8gdGhlCiAgICAgKiBpbmRpdmlkdWFsIHJlY29yZHMgdGhlbXNlbHZlcy4gV2hlbiBhIGNoYW5nZSBvY2N1cnMgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIG9mCiAgICAgKiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBpbnZva2VkIGltbWVkaWF0ZWx5IGlmIHRoZXJlIGhhcyBiZWVuIGEgbm90aWZpY2F0aW9uLiBUaGUKICAgICAqIG9uU3Vic2NyaXB0aW9uQ2hhbmdlZCBtZXRob2Qgd2lsbCBhbHNvIGJlIHRyaWdnZXJlZCBvbmNlIGluaXRpYWxseSB3aGVuIGNhbGxpbmcgdGhpcwogICAgICogZnVuY3Rpb24uIFRoZSBjYWxsYmFjayB3aWxsIGJlIGludm9rZWQgb24gdGhlIGxvb3BlciBzcGVjaWZpZWQgaW4gdGhlIGxpc3RlbmVyJ3MgY29uc3RydWN0b3IuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG92ZXJyaWRkZW4uCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgV2lsbCBnZXQgZXhjZXB0aW9uIGlmIHRoZSBwYXJhbWV0ZXIgbGlzdGVuZXIgaXMgbm90IGluaXRpYWxpemVkIHdpdGggYSBMb29wZXIuCiAgICAgKiBVc2Uge0BsaW5rICNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoRXhlY3V0b3IsIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHZvaWQgYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIGlmIChsaXN0ZW5lciA9PSBudWxsKSByZXR1cm47CiAgICAgICAgYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyLm1FeGVjdXRvciwgbGlzdGVuZXIpOwogICAgfQoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgZm9yIGNoYW5nZXMgdG8gdGhlIGxpc3Qgb2YgYWN0aXZlIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIG9yIHRvIHRoZQogICAgICogaW5kaXZpZHVhbCByZWNvcmRzIHRoZW1zZWx2ZXMuIFdoZW4gYSBjaGFuZ2Ugb2NjdXJzIHRoZSBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG1ldGhvZCBvZgogICAgICogdGhlIGxpc3RlbmVyIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBpZiB0aGVyZSBoYXMgYmVlbiBhIG5vdGlmaWNhdGlvbi4gVGhlCiAgICAgKiBvblN1YnNjcmlwdGlvbkNoYW5nZWQgbWV0aG9kIHdpbGwgYWxzbyBiZSB0cmlnZ2VyZWQgb25jZSBpbml0aWFsbHkgd2hlbiBjYWxsaW5nIHRoaXMKICAgICAqIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lciBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB3aXRoCiAgICAgKiAgICAgICAgICAgICAgICAgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICogQHBhcmFtIGV4ZWN1dG9yIHRoZSBleGVjdXRvciB0aGF0IHdpbGwgZXhlY3V0ZSBjYWxsYmFja3MuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIGFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgQE5vbk51bGwgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsCiAgICAgICAgICAgIEBOb25OdWxsIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIFN0cmluZyBwa2dOYW1lID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgicmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2UgdXNlIHRoZSBUZWxlcGhvbnlSZWdpc3RyeSBhcyBpdCBydW5zIGluIHRoZSBzeXN0ZW0gYW5kIHRodXMgaXMgYWx3YXlzCiAgICAgICAgLy8gYXZhaWxhYmxlLiBXaGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIuYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0aGUgdGVsZXBob255IHJlZ2lzdHJ5IGlzbid0IGF2YWlsYWJsZSwgd2Ugd2lsbCBpbmZvcm0gdGhlIGNhbGxlciBvbiB0aGVpcgogICAgICAgICAgICAvLyBsaXN0ZW5lciB0aGF0IGl0IGZhaWxlZCBzbyB0aGV5IGNhbiB0cnkgdG8gcmUtcmVnaXN0ZXIuCiAgICAgICAgICAgIGxvZ2UoImFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcjogcGtnbmFtZT0iICsgcGtnTmFtZSArICIgZmFpbGVkIHRvIGJlIGFkZGVkICIKICAgICAgICAgICAgICAgICAgICArICIgZHVlIHRvIFRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFIGJlaW5nIHVuYXZhaWxhYmxlLiIpOwogICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IGxpc3RlbmVyLm9uQWRkTGlzdGVuZXJGYWlsZWQoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVW5yZWdpc3RlciB0aGUge0BsaW5rIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0uIFRoaXMgaXMgbm90IHN0cmljdGx5IG5lY2Vzc2FyeQogICAgICogYXMgdGhlIGxpc3RlbmVyIHdpbGwgYXV0b21hdGljYWxseSBiZSB1bnJlZ2lzdGVyZWQgaWYgYW4gYXR0ZW1wdCB0byBpbnZva2UgdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkgcmV0dXJuOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInVucmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIgKyBwa2dGb3JEZWJ1ZwogICAgICAgICAgICAgICAgICAgICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICAvLyBXZSB1c2UgdGhlIFRlbGVwaG9ueVJlZ2lzdHJ5IGFzIGl0IHJ1bnMgaW4gdGhlIHN5c3RlbSBhbmQgdGh1cyBpcyBhbHdheXMKICAgICAgICAvLyBhdmFpbGFibGUgd2hlcmUgYXMgU3Vic2NyaXB0aW9uQ29udHJvbGxlciBjb3VsZCBjcmFzaCBhbmQgbm90IGJlIGF2YWlsYWJsZQogICAgICAgIFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgPSAoVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyKQogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLnJlbW92ZU9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQSBsaXN0ZW5lciBjbGFzcyBmb3IgbW9uaXRvcmluZyBjaGFuZ2VzIHRvIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIG9mIG9wcG9ydHVuaXN0aWMKICAgICAqIHN1YnNjcmlwdGlvbnMuCiAgICAgKiA8cD4KICAgICAqIE92ZXJyaWRlIHRoZSBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCBtZXRob2QgaW4gdGhlIG9iamVjdCB0aGF0IGV4dGVuZHMgdGhpcwogICAgICogb3Ige0BsaW5rICNhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICogRXhlY3V0b3IsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogdG8gcmVnaXN0ZXIgeW91ciBsaXN0ZW5lciBhbmQgdG8gdW5yZWdpc3RlciBpbnZva2UKICAgICAqIHtAbGluayAjcmVtb3ZlT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAqIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogPHA+CiAgICAgKiBQZXJtaXNzaW9ucyBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgewogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhbnkgY2hhbmdlIHRvIGFueSBTdWJzY3JpcHRpb25JbmZvLiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCgpIHsKICAgICAgICAgICAgaWYgKERCRykgbG9nKCJvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZDogTk9UIE9WRVJSSURERU4iKTsKICAgICAgICB9CgogICAgICAgIHByaXZhdGUgdm9pZCBsb2coU3RyaW5nIHMpIHsKICAgICAgICAgICAgUmxvZy5kKExPR19UQUcsIHMpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIGZvciBjaGFuZ2VzIHRvIHRoZSBsaXN0IG9mIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHJlY29yZHMgb3IgdG8gdGhlCiAgICAgKiBpbmRpdmlkdWFsIHJlY29yZHMgdGhlbXNlbHZlcy4gV2hlbiBhIGNoYW5nZSBvY2N1cnMgdGhlIG9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkCiAgICAgKiBtZXRob2Qgb2YgdGhlIGxpc3RlbmVyIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBpZiB0aGVyZSBoYXMgYmVlbiBhIG5vdGlmaWNhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAgICBATm9uTnVsbCBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE5vbk51bGwgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGxpc3RlbmVyID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgU3RyaW5nIHBrZ05hbWUgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICBsb2dkKCJyZWdpc3RlciBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CgogICAgICAgIC8vIFdlIHVzZSB0aGUgVGVsZXBob255UmVnaXN0cnkgYXMgaXQgcnVucyBpbiB0aGUgc3lzdGVtIGFuZCB0aHVzIGlzIGFsd2F5cwogICAgICAgIC8vIGF2YWlsYWJsZSB3aGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIuYWRkT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciwgZXhlY3V0b3IpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVucmVnaXN0ZXIgdGhlIHtAbGluayBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB0aGF0IGlzIGN1cnJlbnRseQogICAgICogbGlzdGVuaW5nIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBjaGFuZ2UuIFRoaXMgaXMgbm90IHN0cmljdGx5IG5lY2Vzc2FyeQogICAgICogYXMgdGhlIGxpc3RlbmVyIHdpbGwgYXV0b21hdGljYWxseSBiZSB1bnJlZ2lzdGVyZWQgaWYgYW4gYXR0ZW1wdCB0byBpbnZva2UgdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgIEBOb25OdWxsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChsaXN0ZW5lciwgImxpc3RlbmVyIGNhbm5vdCBiZSBudWxsIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgidW5yZWdpc3RlciBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIKICAgICAgICAgICAgICAgICAgICArIHBrZ0ZvckRlYnVnICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICBUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyID0gKFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlcikKICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSk7CiAgICAgICAgaWYgKHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciAhPSBudWxsKSB7CiAgICAgICAgICAgIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlci5yZW1vdmVPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFjdGl2ZSBTdWJzY3JpcHRpb25JbmZvIHdpdGggdGhlIGlucHV0IHN1YklkLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8ga2V5IGluIGRhdGFiYXNlLgogICAgICogQHJldHVybiBTdWJzY3JpcHRpb25JbmZvLCBtYXliZSBudWxsIGlmIGl0cyBub3QgYWN0aXZlLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oaW50IHN1YklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvXSsgc3ViSWQ9IiArIHN1YklkKTsKICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkpIHsKICAgICAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICAgICAgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9dLSBpbnZhbGlkIHN1YklkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBTdWJzY3JpcHRpb25JbmZvIHN1YkluZm8gPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSW5mbyA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJbmZvOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhbiBhY3RpdmUgU3Vic2NyaXB0aW9uSW5mbyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gYXNzb2NpYXRlZCB3aXRoIHRoZSBTaW0gSWNjSWQuCiAgICAgKgogICAgICogQHBhcmFtIGljY0lkIHRoZSBJY2NJZCBvZiBTSU0gY2FyZAogICAgICogQHJldHVybiBTdWJzY3JpcHRpb25JbmZvLCBtYXliZSBudWxsIGlmIGl0cyBub3QgYWN0aXZlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE51bGxhYmxlCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9ySWNjKEBOb25OdWxsIFN0cmluZyBpY2NJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0luZGV4XSsgaWNjSWQ9IiArIGljY0lkKTsKICAgICAgICBpZiAoaWNjSWQgPT0gbnVsbCkgewogICAgICAgICAgICBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0luZGV4XS0gbnVsbCBpY2NpZCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIFN1YnNjcmlwdGlvbkluZm8gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0lkKGljY0lkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgYWN0aXZlIFN1YnNjcmlwdGlvbkluZm8gYXNzb2NpYXRlZCB3aXRoIHRoZSBzbG90SW5kZXgKICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBzdWJzY3JpcHRpb24gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gU3Vic2NyaXB0aW9uSW5mbywgbWF5YmUgbnVsbCBpZiBpdHMgbm90IGFjdGl2ZQogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JTaW1TbG90SW5kZXgoaW50IHNsb3RJbmRleCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleF0rIHNsb3RJbmRleD0iICsgc2xvdEluZGV4KTsKICAgICAgICBpZiAoIWlzVmFsaWRTbG90SW5kZXgoc2xvdEluZGV4KSkgewogICAgICAgICAgICBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleF0tIGludmFsaWQgc2xvdEluZGV4Iik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3Vic2NyaXB0aW9uSW5mbyByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9yU2ltU2xvdEluZGV4KHNsb3RJbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIExpc3Qgb2YgYWxsIFN1YnNjcmlwdGlvbkluZm8gcmVjb3JkcyBpbiBkYXRhYmFzZSwKICAgICAqIGluY2x1ZGUgdGhvc2UgdGhhdCB3ZXJlIGluc2VydGVkIGJlZm9yZSwgbWF5YmUgZW1wdHkgYnV0IG5vdCBudWxsLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBbGxTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW2dldEFsbFN1YnNjcmlwdGlvbkluZm9MaXN0XSsiKTsKCiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBbGxTdWJJbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4gVGhlIHJlY29yZHMgd2lsbCBiZSBzb3J0ZWQKICAgICAqIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuIEluIHRoZSBsYXR0ZXIgY2FzZSwgb25seSByZWNvcmRzIGFjY2Vzc2libGUKICAgICAqIHRvIHRoZSBjYWxsaW5nIGFwcCBhcmUgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHJldHVybiBTb3J0ZWQgbGlzdCBvZiB0aGUgY3VycmVudGx5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGF2YWlsYWJsZSBvbiB0aGUgZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9CiAgICAgKiBoYXMgYmVlbiByZWdpc3RlcmVkIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZQogICAgICogaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPC9saT4KICAgICAqIDxsaT4KICAgICAqIElmIHRoZSBsaXN0IGlzIGVtcHR5IHRoZW4gdGhlcmUgYXJlIG5vIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiA8L2xpPgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvbGk+CiAgICAgKiA8L3VsPgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgvKiB1c2VyVmlzaWJsZW9ubHkgKi90cnVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBib3RoIGhpZGRlbiBhbmQgdmlzaWJsZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqIFRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0KICAgICAqIHRoZW4gYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEhpZGRlbiBzdWJzY3JpcHRpb25zIHJlZmVyIHRvIHRob3NlIGFyZSBub3QgbWVhbnQgdmlzaWJsZSB0byB0aGUgdXNlcnMuCiAgICAgKiBGb3IgZXhhbXBsZSwgYW4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gdGhhdCBpcyBncm91cGVkIHdpdGggb3RoZXIKICAgICAqIHN1YnNjcmlwdGlvbnMgc2hvdWxkIHJlbWFpbiBpbnZpc2libGUgdG8gdXNlcnMgYXMgdGhleSBhcmUgb25seSBmdW5jdGlvbmFsbHkKICAgICAqIHN1cHBsZW1lbnRhcnkgdG8gcHJpbWFyeSBvbmVzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIG9ubHkgcmVjb3JkcyBhY2Nlc3NpYmxlCiAgICAgKiB0byB0aGUgY2FsbGluZyBhcHAgYXJlIHJldHVybmVkLgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnRseSBhdmFpbGFibGUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99CiAgICAgKiByZWNvcmRzIG9uIHRoZSBkZXZpY2UuCiAgICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gZXhjZXB0IHRoYXQgaXQgd2lsbCByZXR1cm4KICAgICAqIGJvdGggYWN0aXZlIGFuZCBoaWRkZW4gU3Vic2NyaXB0aW9uSW5mb3MuCiAgICAgKgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gY29tcGxldGVMaXN0ID0gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoCiAgICAgICAgICAgICAgICAvKiB1c2VyVmlzaWJsZW9ubHkgKi9mYWxzZSk7CiAgICAgICAgaWYgKGNvbXBsZXRlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBsZXRlTGlzdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcGxldGVMaXN0OwogICAgfQoKICAgIC8qKgogICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgpfSwgYnV0IGlmIHVzZXJWaXNpYmxlT25seQogICAgKiBpcyB0cnVlLCBpdCB3aWxsIGZpbHRlciBvdXQgdGhlIGhpZGRlbiBzdWJzY3JpcHRpb25zLgogICAgKgogICAgKiBAaGlkZQogICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChib29sZWFuIHVzZXJWaXNpYmxlT25seSkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gYWN0aXZlTGlzdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVMaXN0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKCF1c2VyVmlzaWJsZU9ubHkgfHwgYWN0aXZlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0LnN0cmVhbSgpLmZpbHRlcihzdWJJbmZvIC0+IGlzU3Vic2NyaXB0aW9uVmlzaWJsZShzdWJJbmZvKSkKICAgICAgICAgICAgICAgICAgICAuY29sbGVjdChDb2xsZWN0b3JzLnRvTGlzdCgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIGFsbCBhdmFpbGFibGUgc3Vic2NyaXB0aW9ucywgaWYgYW55LgogICAgICoKICAgICAqIDxwPkF2YWlsYWJsZSBzdWJzY3JpcHRpb25zIGluY2x1ZGUgYWN0aXZlIG9uZXMgKHRob3NlIHdpdGggYSBub24tbmVnYXRpdmUKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleCgpfSkgYXMgd2VsbCBhcyBpbmFjdGl2ZSBidXQgaW5zdGFsbGVkIGVtYmVkZGVkCiAgICAgKiBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSBoYXMgYmVlbiByZWdpc3RlcmVkCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyI29uU3Vic2NyaXB0aW9uc0NoYW5nZWR9IHdpbGwgYmUgaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPGxpPgogICAgICogSWYgdGhlIGxpc3QgaXMgZW1wdHkgdGhlbiB0aGVyZSBhcmUgbm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIDxsaT4KICAgICAqIGlmIHRoZSBsaXN0IGlzIG5vbi1lbXB0eSB0aGUgbGlzdCBpcyBzb3J0ZWQgYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fQogICAgICogdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNnZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdCB0byBiZSBpbnZva2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgU3Vic2NyaXB0aW9uSW5mbyhzKSBvZiBhbGwgZW1iZWRkZWQgc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsaW5nIGFwcCwgaWYKICAgICAqIGFueS4KICAgICAqCiAgICAgKiA8cD5Pbmx5IHRob3NlIHN1YnNjcmlwdGlvbnMgZm9yIHdoaWNoIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIHBlciB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBtZXRhZGF0YSwgaWYgYW55LCB3aWxsIGJlIGluY2x1ZGVkIGluIHRoZSByZXR1cm5lZCBsaXN0LgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQgZW1iZWRkZWQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlIHdoaWNoIGFyZSBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKiA8dWw+CiAgICAgKiA8bGk+CiAgICAgKiBJZiBudWxsIGlzIHJldHVybmVkIHRoZSBjdXJyZW50IHN0YXRlIGlzIHVua25vd24gYnV0IGlmIGEKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IGhhcyBiZWVuIHJlZ2lzdGVyZWQKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZSBpbnZva2VkIGluIHRoZSBmdXR1cmUuCiAgICAgKiA8bGk+CiAgICAgKiBJZiB0aGUgbGlzdCBpcyBlbXB0eSB0aGVuIHRoZXJlIGFyZSBubyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcyBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvdWw+CiAgICAgKi8KICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHJlc3VsdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIHJlZnJlc2ggb2YgdGhlIHBsYXRmb3JtIGNhY2hlIG9mIHByb2ZpbGUgaW5mb3JtYXRpb24gZm9yIHRoZSBlVUlDQyB3aGljaAogICAgICogY29ycmVzcG9uZHMgdG8gdGhlIGNhcmQgSUQgcmV0dXJuZWQgYnkge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaCgpIHsKICAgICAgICBpbnQgY2FyZElkID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KS5nZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5yZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdFJlZnJlc2goY2FyZElkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dkKCJyZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdEZyZXNoIGZvciBjYXJkID0gIiArIGNhcmRJZCArICIgZmFpbGVkLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBwbGF0Zm9ybSBjYWNoZSBvZiBwcm9maWxlIGluZm9ybWF0aW9uIGZvciB0aGUgZVVJQ0Mgd2l0aCB0aGUgZ2l2ZW4KICAgICAqIHtAY29kZSBjYXJkSWR9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBwYXJhbSBjYXJkSWQgdGhlIGNhcmQgSUQgb2YgdGhlIGVVSUNDLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaChpbnQgY2FyZElkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIucmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RSZWZyZXNoKGNhcmRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZCgicmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RGcmVzaCBmb3IgY2FyZCA9ICIgKyBjYXJkSWQgKyAiIGZhaWxlZC4iKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRoZSBjb3VudCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZGF0YWJhc2UsIHRoaXMgaW5jbHVkZXMKICAgICAqIGFsbCBzdWJzY3JpcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNlZW4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnRdKyIpOwoKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWxsU3ViSW5mb0NvdW50KG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIHRoZSBjb3VudCB3aWxsIGluY2x1ZGUKICAgICAqIG9ubHkgdGhvc2Ugc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgY3VycmVudCBudW1iZXIgb2YgYWN0aXZlIHN1YnNjcmlwdGlvbnMuIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGUgdmFsdWUKICAgICAqIHJldHVybmVkIGJ5IHRoaXMgbWV0aG9kIHdpbGwgYmUgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aCBvZiB0aGUgbGlzdCByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0uCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaW50IHJlc3VsdCA9IDA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjdGl2ZVN1YkluZm9Db3VudChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdGhlIG1heGltdW0gbnVtYmVyIG9mIGFjdGl2ZSBzdWJzY3JpcHRpb25zIHRoYXQgd2lsbCBiZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gYW5kIHRoZSB2YWx1ZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnR9LgogICAgICovCiAgICBwdWJsaWMgaW50IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Db3VudE1heCgpIHsKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3ViSW5mb0NvdW50TWF4KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSBpY2NJZCB0aGUgSWNjSWQgb2YgdGhlIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBTSU0gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gdGhlIFVSTCBvZiB0aGUgbmV3bHkgY3JlYXRlZCByb3cgb3IgdGhlIHVwZGF0ZWQgcm93CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgVXJpIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIGljY0lkLCBpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgaWNjSWQ6IiArIGljY0lkICsgIiBzbG90SW5kZXg6IiArIHNsb3RJbmRleCk7CiAgICAgICAgaWYgKGljY0lkID09IG51bGwpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBudWxsIGljY0lkIik7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gaW52YWxpZCBzbG90SW5kZXgiKTsKICAgICAgICB9CgogICAgICAgIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoaWNjSWQsIG51bGwsIHNsb3RJbmRleCwgU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNKTsKCiAgICAgICAgLy8gRklYTUU6IEFsd2F5cyByZXR1cm5zIG51bGw/CiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgc3BlY2lmaWMgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gZGlzcGxheU5hbWUgaHVtYW4tcmVhZGFibGUgbmFtZSBvZiB0aGUgZGV2aWNlIHRoZSBzdWJzY3JpcHRpb24gY29ycmVzcG9uZHMgdG8uCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IGFzc2lnbmVkIHRvIHRoaXMgc3Vic2NyaXB0aW9uLiBJdCBpcyBpZ25vcmVkIGZvciBzdWJzY3JpcHRpb25UeXBlCiAgICAgKiAgICAgICAgICAgICAgICAgIG9mIHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTX0uCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkoY2xpZW50ID0gU3lzdGVtQXBpLkNsaWVudC5NT0RVTEVfTElCUkFSSUVTKQogICAgcHVibGljIHZvaWQgYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZChATm9uTnVsbCBTdHJpbmcgdW5pcXVlSWQsIEBOdWxsYWJsZSBTdHJpbmcgZGlzcGxheU5hbWUsCiAgICAgICAgICAgIGludCBzbG90SW5kZXgsIEBTdWJzY3JpcHRpb25UeXBlIGludCBzdWJzY3JpcHRpb25UeXBlKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdKyB1bmlxdWVJZDoiICsgdW5pcXVlSWQKICAgICAgICAgICAgICAgICAgICArICIsIGRpc3BsYXlOYW1lOiIgKyBkaXNwbGF5TmFtZSArICIsIHNsb3RJbmRleDoiICsgc2xvdEluZGV4CiAgICAgICAgICAgICAgICAgICAgKyAiLCBzdWJzY3JpcHRpb25UeXBlOiAiICsgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmICh1bmlxdWVJZCA9PSBudWxsKSB7CiAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIHVuaXF1ZUlkIGlzIG51bGwiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViID09IG51bGwpIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIElTdWIgc2VydmljZSBpcyBudWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IHJlc3VsdCA9IGlTdWIuYWRkU3ViSW5mbyh1bmlxdWVJZCwgZGlzcGxheU5hbWUsIHNsb3RJbmRleCwgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPCAwKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiQWRkaW5nIG9mIHN1YnNjcmlwdGlvbiBkaWRuJ3Qgc3VjY2VlZDogZXJyb3IgPSAiICsgcmVzdWx0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZ2QoInN1Y2Nlc3NmdWxseSBhZGRlZCBuZXcgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIFN1YnNjcmlwdGlvbkluZm8gcmVjb3JkIGZyb20gdGhlIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlIHNwZWNpZmljCiAgICAgKiAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkoY2xpZW50ID0gU3lzdGVtQXBpLkNsaWVudC5NT0RVTEVfTElCUkFSSUVTKQogICAgcHVibGljIHZvaWQgcmVtb3ZlU3Vic2NyaXB0aW9uSW5mb1JlY29yZChATm9uTnVsbCBTdHJpbmcgdW5pcXVlSWQsCiAgICAgICAgICAgIEBTdWJzY3JpcHRpb25UeXBlIGludCBzdWJzY3JpcHRpb25UeXBlKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW3JlbW92ZVN1YnNjcmlwdGlvbkluZm9SZWNvcmRdKyB1bmlxdWVJZDoiICsgdW5pcXVlSWQKICAgICAgICAgICAgICAgICAgICArICIsIHN1YnNjcmlwdGlvblR5cGU6ICIgKyBzdWJzY3JpcHRpb25UeXBlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHVuaXF1ZUlkID09IG51bGwpIHsKICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gdW5pcXVlSWQgaXMgbnVsbCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIltyZW1vdmVTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gSVN1YiBzZXJ2aWNlIGlzIG51bGwiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgcmVzdWx0ID0gaVN1Yi5yZW1vdmVTdWJJbmZvKHVuaXF1ZUlkLCBzdWJzY3JpcHRpb25UeXBlKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA8IDApIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJSZW1vdmFsIG9mIHN1YnNjcmlwdGlvbiBkaWRuJ3Qgc3VjY2VlZDogZXJyb3IgPSAiICsgcmVzdWx0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZ2QoInN1Y2Nlc3NmdWxseSByZW1vdmVkIHN1YnNjcmlwdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldCBTSU0gaWNvbiB0aW50IGNvbG9yIGZvciBzdWJzY3JpcHRpb24gSUQKICAgICAqIEBwYXJhbSB0aW50IHRoZSBSR0IgdmFsdWUgb2YgaWNvbiB0aW50IGNvbG9yIG9mIHRoZSBTSU0KICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgdW5pcXVlIFN1YnNjcml0cGlvbiBJRCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgc2V0SWNvblRpbnQoQENvbG9ySW50IGludCB0aW50LCBpbnQgc3ViSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW3NldEljb25UaW50XSsgdGludDoiICsgdGludCArICIgc3ViSWQ6IiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3ViSWQsICJzZXRJY29uVGludCIsCiAgICAgICAgICAgICAgICAoaVN1YiktPiBpU3ViLnNldEljb25UaW50KHRpbnQsIHN1YklkKQogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGRpc3BsYXkgbmFtZSBmb3IgYSBzdWJzY3JpcHRpb24gSUQKICAgICAqIEBwYXJhbSBkaXNwbGF5TmFtZSB0aGUgZGlzcGxheSBuYW1lIG9mIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpdHBpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBuYW1lU291cmNlIFNJTSBkaXNwbGF5IG5hbWUgc291cmNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkIG9yIDwgMCBpZiBpbnZhbGlkIHN1YklkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBzZXREaXNwbGF5TmFtZShATnVsbGFibGUgU3RyaW5nIGRpc3BsYXlOYW1lLCBpbnQgc3ViSWQsCiAgICAgICAgICAgIEBTaW1EaXNwbGF5TmFtZVNvdXJjZSBpbnQgbmFtZVNvdXJjZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREaXNwbGF5TmFtZV0rICBkaXNwbGF5TmFtZToiICsgZGlzcGxheU5hbWUgKyAiIHN1YklkOiIgKyBzdWJJZAogICAgICAgICAgICAgICAgICAgICsgIiBuYW1lU291cmNlOiIgKyBuYW1lU291cmNlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0RGlzcGxheU5hbWUiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXREaXNwbGF5TmFtZVVzaW5nU3JjKGRpc3BsYXlOYW1lLCBzdWJJZCwgbmFtZVNvdXJjZSkKICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHBob25lIG51bWJlciBieSBzdWJJZAogICAgICogQHBhcmFtIG51bWJlciB0aGUgcGhvbmUgbnVtYmVyIG9mIHRoZSBTSU0KICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8gaW5kZXggaW4gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gdGhlIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgaW50IHNldERpc3BsYXlOdW1iZXIoU3RyaW5nIG51bWJlciwgaW50IHN1YklkKSB7CiAgICAgICAgaWYgKG51bWJlciA9PSBudWxsKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREaXNwbGF5TnVtYmVyXS0gZmFpbCIpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERpc3BsYXlOdW1iZXIiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXREaXNwbGF5TnVtYmVyKG51bWJlciwgc3ViSWQpCiAgICAgICAgKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBkYXRhIHJvYW1pbmcgYnkgc2ltSW5mbyBpbmRleAogICAgICogQHBhcmFtIHJvYW1pbmcgMDpEb24ndCBhbGxvdyBkYXRhIHdoZW4gcm9hbWluZywgMTpBbGxvdyBkYXRhIHdoZW4gcm9hbWluZwogICAgICogQHBhcmFtIHN1YklkIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBpbnQgc2V0RGF0YVJvYW1pbmcoaW50IHJvYW1pbmcsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbc2V0RGF0YVJvYW1pbmddKyByb2FtaW5nOiIgKyByb2FtaW5nICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERhdGFSb2FtaW5nIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREYXRhUm9hbWluZyhyb2FtaW5nLCBzdWJJZCkKICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHNsb3RJbmRleCBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHNsb3RJbmRleCBhcyBhIHBvc2l0aXZlIGludGVnZXIgb3Ige0BsaW5rICNJTlZBTElEX1NJTV9TTE9UX0lOREVYfSBpZiB0aGUgc3VwcGxpZWQKICAgICAqIHN1YnNjcmlwdGlvbklkIGRvZXNuJ3QgaGF2ZSBhbiBhc3NvY2lhdGVkIHNsb3QgaW5kZXguCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldFNsb3RJbmRleChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gc1Nsb3RJbmRleENhY2hlLnF1ZXJ5KHN1YnNjcmlwdGlvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBhbiBhcnJheSBvZiBTdWJzY3JpcHRpb24gSWRzIGZvciBzcGVjaWZpZWQgc2xvdCBJbmRleC4KICAgICAqIEBwYXJhbSBzbG90SW5kZXggdGhlIHNsb3QgaW5kZXguCiAgICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBJZHMgb3IgbnVsbCBpZiB0aGUgZ2l2ZW4gc2xvdCBJbmRleCBpcyBub3QgdmFsaWQgb3IgdGhlcmUgYXJlIG5vIGFjdGl2ZQogICAgICogc3Vic2NyaXB0aW9ucyBpbiB0aGUgc2xvdC4KICAgICAqLwogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgaW50W10gZ2V0U3Vic2NyaXB0aW9uSWRzKGludCBzbG90SW5kZXgpIHsKICAgICAgICByZXR1cm4gZ2V0U3ViSWQoc2xvdEluZGV4KTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGludFtdIGdldFN1YklkKGludCBzbG90SW5kZXgpIHsKICAgICAgICBpZiAoIWlzVmFsaWRTbG90SW5kZXgoc2xvdEluZGV4KSkgewogICAgICAgICAgICBsb2dkKCJbZ2V0U3ViSWRdLSBmYWlsIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaW50W10gc3ViSWQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSWQgPSBpU3ViLmdldFN1YklkKHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3ViSWQ7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRQaG9uZUlkKGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBzUGhvbmVJZENhY2hlLnF1ZXJ5KHN1YklkKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIGxvZ2QoU3RyaW5nIG1zZykgewogICAgICAgIFJsb2cuZChMT0dfVEFHLCBtc2cpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgbG9nZShTdHJpbmcgbXNnKSB7CiAgICAgICAgUmxvZy5lKExPR19UQUcsIG1zZyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBGb3IgYSB2b2ljZSBjYXBhYmxlIGRldmljZSwgaXQgd2lsbCByZXR1cm4gZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQuCiAgICAgKiBGb3IgYSBkYXRhIG9ubHkgZGV2aWNlLCBpdCB3aWxsIHJldHVybiB0aGUgZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZC4KICAgICAqIE1heSByZXR1cm4gYW4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgb24gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgInN5c3RlbSIgZGVmYXVsdCBzdWJzY3JpcHRpb24gaWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHRTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSBkYXRhIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbiBJZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoKSB7CiAgICAgICAgaW50IHN1YklkID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdWJJZCA9IGlTdWIuZ2V0RGVmYXVsdFZvaWNlU3ViSWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmIChWREJHKSBsb2dkKCJnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCwgc3ViIGlkID0gIiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc3ViSWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBPbiBhIGRhdGEtb25seSBkZXZpY2UsIHRoaXMgaXMgYSBuby1vcC4KICAgICAqCiAgICAgKiBNYXkgdGhyb3cgYSB7QGxpbmsgUnVudGltZUV4Y2VwdGlvbn0gaWYgdGhlIHByb3ZpZGVkIHN1YnNjcmlwdGlvbiBpZCBpcyBlcXVhbCB0bwogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9CiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIEEgdmFsaWQgc3Vic2NyaXB0aW9uIElEIHRvIHNldCBhcyB0aGUgc3lzdGVtIGRlZmF1bHQsIG9yCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUR9CiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInNldERlZmF1bHRWb2ljZVN1YklkIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdFZvaWNlU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNhbWUgYXMge0BsaW5rICNzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChpbnQpfSwgYnV0IHByZXNlcnZlZCBmb3IgYmFja3dhcmRzCiAgICAgKiBjb21wYXRpYmlsaXR5LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFZvaWNlU3ViSWQoaW50IHN1YklkKSB7CiAgICAgICAgc2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBXaWxsIHJldHVybiBudWxsIG9uIGRhdGEgb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlIsIHRyYWNraW5nQnVnID0gMTcwNzI5NTUzKQogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSW5mbygpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0Vm9pY2VQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uIGlkLgogICAgICoKICAgICAqIE9uIGEgZGF0YSBvbmx5IGRldmljZSBvciBvbiBlcnJvciwgd2lsbCByZXR1cm4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uIElkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKSB7CiAgICAgICAgcmV0dXJuIHNEZWZhdWx0U21zU3ViSWRDYWNoZS5xdWVyeShudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgc3Vic2NyaXB0aW9uIHdoaWNoIHdpbGwgYmUgdXNlZCBieSBkZWZhdWx0IGZvciBTTVMsIHdpdGggdGhlIHN1YnNjcmlwdGlvbiB3aGljaAogICAgICogdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0bzsgb3IgdGhyb3cgYSBSdW50aW1lRXhjZXB0aW9uIGlmIHRoZSBzdXBwbGllZAogICAgICogc3Vic2NyaXB0aW9uIElEIGlzIG5vdCB1c2FibGUgKGNoZWNrIHdpdGgge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERlZmF1bHRTbXNTdWJJZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgic2V0RGVmYXVsdFNtc1N1YklkIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdFNtc1N1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBleC5yZXRocm93RnJvbVN5c3RlbVNlcnZlcigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgU3Vic2NyaXB0aW9uSW5mbyBmb3IgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogV2lsbCByZXR1cm4gbnVsbCBvbiBkYXRhIG9ubHkgZGV2aWNlcywgb3Igb24gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgU3Vic2NyaXB0aW9uSW5mbyBmb3IgdGhlIGRlZmF1bHQgU01TIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgaW50IGdldERlZmF1bHRTbXNQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHN5c3RlbSdzIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSB2b2ljZSBvbmx5IGRldmljZSBvciBvbiBlcnJvciwgd2lsbCByZXR1cm4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiBJZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHREYXRhU3ViSWRDYWNoZS5xdWVyeShudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgc3Vic2NyaXB0aW9uIHdoaWNoIHdpbGwgYmUgdXNlZCBieSBkZWZhdWx0IGZvciBkYXRhLCB3aXRoIHRoZSBzdWJzY3JpcHRpb24gd2hpY2gKICAgICAqIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgY29ycmVzcG9uZHMgdG87IG9yIHRocm93IGEgUnVudGltZUV4Y2VwdGlvbiBpZiB0aGUgc3VwcGxpZWQKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBpcyBub3QgdXNhYmxlIChjaGVjayB3aXRoIHtAbGluayAjaXNVc2FibGVTdWJzY3JpcHRpb25JZChpbnQpfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0RGF0YVN1YklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJzZXREYXRhU3Vic2NyaXB0aW9uIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdERhdGFTdWJJZChzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIFdpbGwgcmV0dXJuIG51bGwgb24gdm9pY2Ugb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IGdldERlZmF1bHREYXRhUGhvbmVJZCgpIHsKICAgICAgICByZXR1cm4gZ2V0UGhvbmVJZChnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHZvaWQgY2xlYXJTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLmNsZWFyU3ViSW5mbygpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vRklYTUUgdGhpcyBpcyB2dWxuZXJhYmxlIHRvIHJhY2UgY29uZGl0aW9ucwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgYm9vbGVhbiBhbGxEZWZhdWx0c1NlbGVjdGVkKCkgewogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBpcyB2YWxpZC4KICAgICAqCiAgICAgKiA8cD5BIHZhbGlkIHN1YnNjcmlwdGlvbiBJRCBpcyBub3QgbmVjZXNzYXJpbHkgYW4gYWN0aXZlIHN1YnNjcmlwdGlvbiBJRAogICAgICogKHNlZSB7QGxpbmsgI2lzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50KX0pIG9yIGFuIHVzYWJsZSBzdWJzY3JpcHRpb24gSUQKICAgICAqIChzZWUge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4gVW5sZXNzIHNwZWNpZmljYWxseSBub3RlZCwgc3Vic2NyaXB0aW9uCiAgICAgKiBBUElzIHdvcmsgd2l0aCBhIHZhbGlkIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgVGhlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb25JZCBpcyB2YWxpZDsge0Bjb2RlIGZhbHNlfSBvdGhlcndpc2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbklkID4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGlzIHVzYWJsZS4KICAgICAqCiAgICAgKiA8cD5BIHVzYWJsZSBzdWJzY3JpcHRpb24gSUQgaXMgYSB2YWxpZCBzdWJzY3JpcHRpb24gSUQsIGJ1dCBub3QgbmVjZXNzYXJpbHkgYW4gYWN0aXZlCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgKHNlZSB7QGxpbmsgI2lzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50KX0pLiBTb21lIHN1YnNjcmlwdGlvbiBBUElzCiAgICAgKiByZXF1aXJlIGEgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRCwgYW5kIHRoaXMgaXMgbm90ZWQgaW4gdGhlaXIgZG9jdW1lbnRhdGlvbjsgb3RoZXJ3aXNlLCBhCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgZG9lcyBub3QgbmVlZCB0byBiZSB1c2FibGUgZm9yIHN1YnNjcmlwdGlvbiBmdW5jdGlvbnMsIG9ubHkgdmFsaWQuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb24gSUQKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgdXNhYmxlOyB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIGlzVXNhYmxlU3ViSWRWYWx1ZShzdWJzY3JpcHRpb25JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgc3ViSWQgaXMgYW4gdXNhYmxlIHN1YklkIHZhbHVlIGVsc2UgZmFsc2UuIEEKICAgICAqIHVzYWJsZSBzdWJJZCBtZWFucyBpdHMgbmVpdGhlciBhIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEIG5vciBhIERFRkFVTFRfU1VCX0lELgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVXNhYmxlU3ViSWRWYWx1ZShpbnQgc3ViSWQpIHsKICAgICAgICByZXR1cm4gc3ViSWQgPj0gTUlOX1NVQlNDUklQVElPTl9JRF9WQUxVRSAmJiBzdWJJZCA8PSBNQVhfU1VCU0NSSVBUSU9OX0lEX1ZBTFVFOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkU2xvdEluZGV4KGludCBzbG90SW5kZXgpIHsKICAgICAgICByZXR1cm4gc2xvdEluZGV4ID49IDAgJiYgc2xvdEluZGV4IDwgVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuZ2V0QWN0aXZlTW9kZW1Db3VudCgpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkUGhvbmVJZChpbnQgcGhvbmVJZCkgewogICAgICAgIHJldHVybiBwaG9uZUlkID49IDAgJiYgcGhvbmVJZCA8IFRlbGVwaG9ueU1hbmFnZXIuZ2V0RGVmYXVsdCgpLmdldEFjdGl2ZU1vZGVtQ291bnQoKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYShJbnRlbnQgaW50ZW50LCBpbnQgcGhvbmVJZCkgewogICAgICAgIGludFtdIHN1YklkcyA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0U3ViSWQocGhvbmVJZCk7CiAgICAgICAgaWYgKHN1YklkcyAhPSBudWxsICYmIHN1Yklkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHB1dFBob25lSWRBbmRTdWJJZEV4dHJhKGludGVudCwgcGhvbmVJZCwgc3ViSWRzWzBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb2dkKCJwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYTogbm8gdmFsaWQgc3VicyIpOwogICAgICAgICAgICBpbnRlbnQucHV0RXh0cmEoUGhvbmVDb25zdGFudHMuUEhPTkVfS0VZLCBwaG9uZUlkKTsKICAgICAgICAgICAgaW50ZW50LnB1dEV4dHJhKEVYVFJBX1NMT1RfSU5ERVgsIHBob25lSWQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgcHV0UGhvbmVJZEFuZFN1YklkRXh0cmEoSW50ZW50IGludGVudCwgaW50IHBob25lSWQsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYTogcGhvbmVJZD0iICsgcGhvbmVJZCArICIgc3ViSWQ9IiArIHN1YklkKTsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoRVhUUkFfU0xPVF9JTkRFWCwgcGhvbmVJZCk7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFBob25lQ29uc3RhbnRzLlBIT05FX0tFWSwgcGhvbmVJZCk7CiAgICAgICAgcHV0U3Vic2NyaXB0aW9uSWRFeHRyYShpbnRlbnQsIHN1YklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB2aXNpYmxlIHN1YnNjcmlwdGlvbiBJZChzKSBvZiB0aGUgY3VycmVudGx5IGFjdGl2ZSBTSU0ocykuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgbGlzdCBvZiBzdWJJZCdzIHRoYXQgYXJlIGFjdGl2ZSwKICAgICAqICAgICAgICAgaXMgbmV2ZXIgbnVsbCBidXQgdGhlIGxlbmd0aCBtYXkgYmUgMC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5vbk51bGwgaW50W10gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JZExpc3QoLyogdmlzaWJsZU9ubHkgKi8gdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYm90aCBoaWRkZW4gYW5kIHZpc2libGUgc3Vic2NyaXB0aW9uIElkKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqCiAgICAgKiBIaWRkZW4gc3Vic2NyaXB0aW9ucyByZWZlciB0byB0aG9zZSBhcmUgbm90IG1lYW50IHZpc2libGUgdG8gdGhlIHVzZXJzLgogICAgICogRm9yIGV4YW1wbGUsIGFuIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHRoYXQgaXMgZ3JvdXBlZCB3aXRoIG90aGVyCiAgICAgKiBzdWJzY3JpcHRpb25zIHNob3VsZCByZW1haW4gaW52aXNpYmxlIHRvIHVzZXJzIGFzIHRoZXkgYXJlIG9ubHkgZnVuY3Rpb25hbGx5CiAgICAgKiBzdXBwbGVtZW50YXJ5IHRvIHByaW1hcnkgb25lcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIHN1YklkJ3MgdGhhdCBhcmUgYWN0aXZlLAogICAgICogICAgICAgICBpcyBuZXZlciBudWxsIGJ1dCB0aGUgbGVuZ3RoIG1heSBiZSAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBpbnRbXSBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdCgpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KC8qIHZpc2libGVPbmx5ICovZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiBhIG5vbi1udWxsIGxpc3Qgb2Ygc3ViSWQncyB0aGF0IGFyZSBhY3RpdmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOb25OdWxsIGludFtdIGdldEFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdChib29sZWFuIHZpc2libGVPbmx5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGludFtdIHN1YklkID0gaVN1Yi5nZXRBY3RpdmVTdWJJZExpc3QodmlzaWJsZU9ubHkpOwogICAgICAgICAgICAgICAgaWYgKHN1YklkICE9IG51bGwpIHJldHVybiBzdWJJZDsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgaW50WzBdOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBkZXZpY2UgaXMgY29uc2lkZXJlZCByb2FtaW5nIG9uIHRoZSBjdXJyZW50CiAgICAgKiBuZXR3b3JrIGZvciBhIHN1YnNjcmlwdGlvbi4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBPbmx5IHdoZW4gdXNlciByZWdpc3RlcmVkIHRvIGEgbmV0d29yay4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHN1YnNjcmlwdGlvbiBJRAogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBuZXR3b3JrIGZvciB0aGUgc3Vic2NyaXB0aW9uIGlzIHJvYW1pbmcsIGZhbHNlIG90aGVyd2lzZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc05ldHdvcmtSb2FtaW5nKGludCBzdWJJZCkgewogICAgICAgIGZpbmFsIGludCBwaG9uZUlkID0gZ2V0UGhvbmVJZChzdWJJZCk7CiAgICAgICAgaWYgKHBob25lSWQgPCAwKSB7CiAgICAgICAgICAgIC8vIFdoYXQgZWxzZSBjYW4gd2UgZG8/CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFRlbGVwaG9ueU1hbmFnZXIuZ2V0RGVmYXVsdCgpLmlzTmV0d29ya1JvYW1pbmcoc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXRlIG9mIHNpbSBmb3IgdGhlIHNsb3QgaW5kZXguCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleAogICAgICoKICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1VOS05PV059CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9BQlNFTlR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9QSU5fUkVRVUlSRUR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9QVUtfUkVRVUlSRUR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1JFQURZfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfTk9UX1JFQURZfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUEVSTV9ESVNBQkxFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX0NBUkRfSU9fRVJST1J9CiAgICAgKgogICAgICoge0BoaWRlfQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRTaW1TdGF0ZUZvclNsb3RJbmRleChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0gVGVsZXBob255TWFuYWdlci5TSU1fU1RBVEVfVU5LTk9XTjsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNpbVN0YXRlID0gaVN1Yi5nZXRTaW1TdGF0ZUZvclNsb3RJbmRleChzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2ltU3RhdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBwcm9wZXJ0aWVzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb25JbmZvIGluIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gZGF0YWJhc2UgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbkluZm8KICAgICAqIEBwYXJhbSBwcm9wVmFsdWUgVmFsdWUgdG8gc3RvcmUgaW4gREIgZm9yIHBhcnRpY3VsYXIgc3ViSWQgJiBjb2x1bW4gbmFtZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIHNldFN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIFN0cmluZyBwcm9wVmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXJpYWxpemUgbGlzdCBvZiBjb250YWN0cyB1cmkgdG8gc3RyaW5nCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIFN0cmluZyBzZXJpYWxpemVVcmlMaXN0cyhMaXN0PFVyaT4gdXJpcykgewogICAgICAgIExpc3Q8U3RyaW5nPiBjb250YWN0cyA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIGZvciAoVXJpIHVyaSA6IHVyaXMpIHsKICAgICAgICAgICAgY29udGFjdHMuYWRkKHVyaS50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgQnl0ZUFycmF5T3V0cHV0U3RyZWFtIGJvcyA9IG5ldyBCeXRlQXJyYXlPdXRwdXRTdHJlYW0oKTsKICAgICAgICAgICAgT2JqZWN0T3V0cHV0U3RyZWFtIG9vcyA9IG5ldyBPYmplY3RPdXRwdXRTdHJlYW0oYm9zKTsKICAgICAgICAgICAgb29zLndyaXRlT2JqZWN0KGNvbnRhY3RzKTsKICAgICAgICAgICAgb29zLmZsdXNoKCk7CiAgICAgICAgICAgIHJldHVybiBCYXNlNjQuZW5jb2RlVG9TdHJpbmcoYm9zLnRvQnl0ZUFycmF5KCksIEJhc2U2NC5ERUZBVUxUKTsKICAgICAgICB9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIGxvZ2QoInNlcmlhbGl6ZVVyaUxpc3RzIElPIGV4Y2VwdGlvbiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gIiI7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gbGlzdCBvZiBjb250YWN0cyB1cmkgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHJldHVybiBsaXN0IG9mIGNvbnRhY3RzIHVyaSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgTGlzdDxVcmk+IGdldENvbnRhY3RzRnJvbVN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBieXRlW10gYiA9IEJhc2U2NC5kZWNvZGUocmVzdWx0LCBCYXNlNjQuREVGQVVMVCk7CiAgICAgICAgICAgICAgICBCeXRlQXJyYXlJbnB1dFN0cmVhbSBiaXMgPSBuZXcgQnl0ZUFycmF5SW5wdXRTdHJlYW0oYik7CiAgICAgICAgICAgICAgICBPYmplY3RJbnB1dFN0cmVhbSBvaXMgPSBuZXcgT2JqZWN0SW5wdXRTdHJlYW0oYmlzKTsKICAgICAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBjb250YWN0cyA9IEFycmF5TGlzdC5jbGFzcy5jYXN0KG9pcy5yZWFkT2JqZWN0KCkpOwogICAgICAgICAgICAgICAgTGlzdDxVcmk+IHVyaXMgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICAgICAgICAgIGZvciAoU3RyaW5nIGNvbnRhY3QgOiBjb250YWN0cykgewogICAgICAgICAgICAgICAgICAgIHVyaXMuYWRkKFVyaS5wYXJzZShjb250YWN0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdXJpczsKICAgICAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgSU8gZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0gY2F0Y2ggKENsYXNzTm90Rm91bmRFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgQ2xhc3NOb3RGb3VuZCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEFycmF5TGlzdDw+KCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBwcm9wZXJ0aWVzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb25JbmZvIGluIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHJldHVybiBWYWx1ZSBhc3NvY2lhdGVkIHdpdGggc3ViSWQgYW5kIHByb3BLZXkgY29sdW1uIGluIGRhdGFiYXNlCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwcml2YXRlIHN0YXRpYyBTdHJpbmcgZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwKICAgICAgICAgICAgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdFZhbHVlID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0VmFsdWUgPSBpU3ViLmdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgY29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdFZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBib29sZWFuIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gcXVlcnkgcmVzdWx0LgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5IENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBkZWZWYWx1ZSBEZWZhdWx0IGJvb2xlYW4gdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gYm9vbGVhbiByZXN1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBnZXRCb29sZWFuU3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwKICAgICAgICAgICAgYm9vbGVhbiBkZWZWYWx1ZSwgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdCA9IGdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LCBjb250ZXh0KTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBJbnRlZ2VyLnBhcnNlSW50KHJlc3VsdCkgPT0gMTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGVycikgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Qm9vbGVhblN1YnNjcmlwdGlvblByb3BlcnR5IE51bWJlckZvcm1hdCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGludGVnZXIgdmFsdWUgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHBhcmFtIGRlZlZhbHVlIERlZmF1bHQgaW50ZWdlciB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQHJldHVybiBpbnRlZ2VyIHJlc3VsdCB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0SW50ZWdlclN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIGludCBkZWZWYWx1ZSwKICAgICAgICAgICAgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdCA9IGdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LCBjb250ZXh0KTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBJbnRlZ2VyLnBhcnNlSW50KHJlc3VsdCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlcnIpIHsKICAgICAgICAgICAgICAgIGxvZ2QoImdldEludGVnZXJTdWJzY3JpcHRpb25Qcm9wZXJ0eSBOdW1iZXJGb3JtYXQgZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZlZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBsb25nIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gcXVlcnkgcmVzdWx0LgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5IENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBkZWZWYWx1ZSBEZWZhdWx0IGxvbmcgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gbG9uZyByZXN1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgbG9uZyBnZXRMb25nU3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwgbG9uZyBkZWZWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb250ZXh0IGNvbnRleHQpIHsKICAgICAgICBTdHJpbmcgcmVzdWx0ID0gZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoc3ViSWQsIHByb3BLZXksIGNvbnRleHQpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIExvbmcucGFyc2VMb25nKHJlc3VsdCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlcnIpIHsKICAgICAgICAgICAgICAgIGxvZ2QoImdldExvbmdTdWJzY3JpcHRpb25Qcm9wZXJ0eSBOdW1iZXJGb3JtYXQgZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZlZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUge0BsaW5rIFJlc291cmNlc30gZnJvbSB0aGUgZ2l2ZW4ge0BsaW5rIENvbnRleHR9IGZvciB0aGUgTUNDL01OQyBhc3NvY2lhdGVkIHdpdGgKICAgICAqIHRoZSBzdWJzY3JpcHRpb24uIElmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgaW52YWxpZCwgdGhlIGJhc2UgcmVzb3VyY2VzIGFyZSByZXR1cm5lZCBpbnN0ZWFkLgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICoKICAgICAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2JqZWN0CiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbiB3aG9zZSByZXNvdXJjZXMgYXJlIHJlcXVpcmVkCiAgICAgKiBAcmV0dXJuIFJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgUmVzb3VyY2VzIGdldFJlc291cmNlc0ZvclN1YklkKEBOb25OdWxsIENvbnRleHQgY29udGV4dCwgaW50IHN1YklkKSB7CiAgICAgICAgcmV0dXJuIGdldFJlc291cmNlc0ZvclN1YklkKGNvbnRleHQsIHN1YklkLCBmYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbi4KICAgICAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2JqZWN0CiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbiB3aG8ncyByZXNvdXJjZXMgYXJlIHJlcXVpcmVkCiAgICAgKiBAcGFyYW0gdXNlUm9vdExvY2FsZSBpZiByb290IGxvY2FsZSBzaG91bGQgYmUgdXNlZC4gTG9jYWxpemVkIGxvY2FsZSBpcyB1c2VkIGlmIGZhbHNlLgogICAgICogQHJldHVybiBSZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBwdWJsaWMgc3RhdGljIFJlc291cmNlcyBnZXRSZXNvdXJjZXNGb3JTdWJJZChDb250ZXh0IGNvbnRleHQsIGludCBzdWJJZCwKICAgICAgICAgICAgYm9vbGVhbiB1c2VSb290TG9jYWxlKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgcmVzb3VyY2VzIGZvciB0aGlzIGNvbnRleHQgYW5kIHN1YklkIGFscmVhZHkgZXhpc3QgaW4gdGhlIHJlc291cmNlIGNhY2hlLgogICAgICAgIC8vIFJlc291cmNlcyB0aGF0IHVzZSB0aGUgcm9vdCBsb2NhbGUgYXJlIG5vdCBjYWNoZWQuCiAgICAgICAgUGFpcjxDb250ZXh0LCBJbnRlZ2VyPiBjYWNoZUtleSA9IG51bGw7CiAgICAgICAgaWYgKGlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkgJiYgIXVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAgICAgY2FjaGVLZXkgPSBQYWlyLmNyZWF0ZShjb250ZXh0LCBzdWJJZCk7CiAgICAgICAgICAgIGlmIChzUmVzb3VyY2VzQ2FjaGUuY29udGFpbnNLZXkoY2FjaGVLZXkpKSB7CiAgICAgICAgICAgICAgICAvLyBDYWNoZSBoaXQuIFVzZSBjYWNoZWQgUmVzb3VyY2VzLgogICAgICAgICAgICAgICAgcmV0dXJuIHNSZXNvdXJjZXNDYWNoZS5nZXQoY2FjaGVLZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmaW5hbCBTdWJzY3JpcHRpb25JbmZvIHN1YkluZm8gPQogICAgICAgICAgICAgICAgU3Vic2NyaXB0aW9uTWFuYWdlci5mcm9tKGNvbnRleHQpLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oc3ViSWQpOwoKICAgICAgICBDb25maWd1cmF0aW9uIG92ZXJyaWRlQ29uZmlnID0gbmV3IENvbmZpZ3VyYXRpb24oKTsKICAgICAgICBpZiAoc3ViSW5mbyAhPSBudWxsKSB7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLm1jYyA9IHN1YkluZm8uZ2V0TWNjKCk7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLm1uYyA9IHN1YkluZm8uZ2V0TW5jKCk7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUNvbmZpZy5tbmMgPT0gMCkgewogICAgICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubW5jID0gQ29uZmlndXJhdGlvbi5NTkNfWkVSTzsKICAgICAgICAgICAgICAgIGNhY2hlS2V5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhY2hlS2V5ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh1c2VSb290TG9jYWxlKSB7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLnNldExvY2FsZShMb2NhbGUuUk9PVCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDcmVhdGUgbmV3IGNvbnRleHQgd2l0aCBuZXcgY29uZmlndXJhdGlvbiBzbyB0aGF0IHdlIGNhbiBhdm9pZCBtb2RpZnlpbmcgdGhlIHBhc3NlZCBpbgogICAgICAgIC8vIGNvbnRleHQuCiAgICAgICAgLy8gTm90ZSB0aGF0IGlmIHRoZSBvcmlnaW5hbCBjb250ZXh0IGNvbmZpZ3VyYXRpb24gY2hhbmdlcywgdGhlIHJlc291cmNlcyBoZXJlIHdpbGwgYWxzbwogICAgICAgIC8vIGNoYW5nZSBmb3IgYWxsIHZhbHVlcyBleGNlcHQgdGhvc2Ugb3ZlcnJpZGRlbiBieSBuZXdDb25maWcgKGUuZy4gaWYgdGhlIGRldmljZSBoYXMgYW4KICAgICAgICAvLyBvcmllbnRhdGlvbiBjaGFuZ2UpLgogICAgICAgIENvbnRleHQgbmV3Q29udGV4dCA9IGNvbnRleHQuY3JlYXRlQ29uZmlndXJhdGlvbkNvbnRleHQob3ZlcnJpZGVDb25maWcpOwogICAgICAgIFJlc291cmNlcyByZXMgPSBuZXdDb250ZXh0LmdldFJlc291cmNlcygpOwoKICAgICAgICBpZiAoY2FjaGVLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAvLyBTYXZlIHRoZSBuZXdseSBjcmVhdGVkIFJlc291cmNlcyBpbiB0aGUgcmVzb3VyY2UgY2FjaGUuCiAgICAgICAgICAgIHNSZXNvdXJjZXNDYWNoZS5wdXQoY2FjaGVLZXksIHJlcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0byBhIHN1YnNjcmlwdGlvbiB3aGljaCBpcyBhY3RpdmVseSBpbgogICAgICogdXNlIG9uIHRoZSBkZXZpY2UuIEFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gSUQgaXMgYSB2YWxpZCBhbmQgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgY29ycmVzcG9uZHMgdG8gYW4gYWN0aXZlIHN1YnNjcmlwdGlvbjsKICAgICAqIHtAY29kZSBmYWxzZX0gaWYgaXQgZG9lcyBub3QgY29ycmVzcG9uZCB0byBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uOyBvciB0aHJvdyBhCiAgICAgKiBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGhhc24ndCBnb3QgdGhlIHJpZ2h0IHBlcm1pc3Npb24uCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0FjdGl2ZVN1YnNjcmlwdGlvbklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIHJldHVybiBpc0FjdGl2ZVN1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgc3ViIElEIGlzIGFjdGl2ZS4gaS5lLiBUaGUgc3ViIElEIGNvcnJlc3BvbmRzIHRvIGEga25vd24gc3Vic2NyaXB0aW9uCiAgICAgKiBhbmQgdGhlIFNJTSBwcm92aWRpbmcgdGhlIHN1YnNjcmlwdGlvbiBpcyBwcmVzZW50IGluIGEgc2xvdCBhbmQgaW4gIkxPQURFRCIgc3RhdGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGJvb2xlYW4gaXNBY3RpdmVTdWJJZChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuaXNBY3RpdmVTdWJJZChzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyCiAgICAgKiBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIHJlbGF0aW9uc2hpcCBhcHBsaWVzIHRvCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25QbGFuPiBnZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQpIHsKICAgICAgICBTdWJzY3JpcHRpb25QbGFuW10gc3Vic2NyaXB0aW9uUGxhbnMgPQogICAgICAgICAgICAgICAgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKS5nZXRTdWJzY3JpcHRpb25QbGFucyhzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uUGxhbnMgPT0gbnVsbAogICAgICAgICAgICAgICAgPyBDb2xsZWN0aW9ucy5lbXB0eUxpc3QoKSA6IEFycmF5cy5hc0xpc3Qoc3Vic2NyaXB0aW9uUGxhbnMpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllcgogICAgICogYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0by4gQW4gZW1wdHkgbGlzdAogICAgICogICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgdGhlIGxpc3Qgb2YgcGxhbnMuIFRoZSBmaXJzdCBwbGFuIGlzIGFsd2F5cyB0aGUgcHJpbWFyeSBhbmQKICAgICAqICAgICAgICAgICAgbW9zdCBpbXBvcnRhbnQgcGxhbi4gQW55IGFkZGl0aW9uYWwgcGxhbnMgYXJlIHNlY29uZGFyeSBhbmQKICAgICAqICAgICAgICAgICAgbWF5IG5vdCBiZSBkaXNwbGF5ZWQgb3IgdXNlZCBieSBkZWNpc2lvbiBtYWtpbmcgbG9naWMuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgcGxhbnMgZG9uJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBkZWZpbmVkIGluIHtAbGluayBTdWJzY3JpcHRpb25QbGFufS4KICAgICAqIEBkZXByZWNhdGVkIHVzZSB7QGxpbmsgI3NldFN1YnNjcmlwdGlvblBsYW5zKGludCwgTGlzdCwgbG9uZyl9IGluc3RlYWQuCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQsIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uUGxhbj4gcGxhbnMpIHsKICAgICAgICBzZXRTdWJzY3JpcHRpb25QbGFucyhzdWJJZCwgcGxhbnMsIDApOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllcgogICAgICogYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0by4gQW4gZW1wdHkgbGlzdAogICAgICogICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgdGhlIGxpc3Qgb2YgcGxhbnMuIFRoZSBmaXJzdCBwbGFuIGlzIGFsd2F5cyB0aGUgcHJpbWFyeSBhbmQKICAgICAqICAgICAgICAgICAgbW9zdCBpbXBvcnRhbnQgcGxhbi4gQW55IGFkZGl0aW9uYWwgcGxhbnMgYXJlIHNlY29uZGFyeSBhbmQKICAgICAqICAgICAgICAgICAgbWF5IG5vdCBiZSBkaXNwbGF5ZWQgb3IgdXNlZCBieSBkZWNpc2lvbiBtYWtpbmcgbG9naWMuCiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgc3Vic2NyaXB0aW9uIHBsYW5zCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgdGhlIHBsYW5zIHVudGlsCiAgICAgKiAgICAgICAgICAgIGV4cGxpY2l0bHkgY2xlYXJlZCwgb3IgdGhlIG5leHQgcmVib290LCB3aGljaGV2ZXIgaGFwcGVucyBmaXJzdC4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBwbGFucyBkb24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIGRlZmluZWQgaW4ge0BsaW5rIFN1YnNjcmlwdGlvblBsYW59LgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQsIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uUGxhbj4gcGxhbnMsCiAgICAgICAgICAgIEBEdXJhdGlvbk1pbGxpc0xvbmcgbG9uZyBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpIHsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLAogICAgICAgICAgICAgICAgcGxhbnMudG9BcnJheShuZXcgU3Vic2NyaXB0aW9uUGxhblswXSksIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcywKICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIHVubWV0ZXJlZC4gVGhpcyB3aWxsIGJlIHJlZmxlY3RlZAogICAgICogdG8gYXBwcyB2aWEge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfTk9UX01FVEVSRUR9LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVVbm1ldGVyZWQgc2V0IGlmIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBzaG91bGQgYmUKICAgICAqICAgICAgICAgICAgY29uc2lkZXJlZCB1bm1ldGVyZWQuCiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgcmVxdWVzdGVkIG92ZXJyaWRlCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgaW4gdGhlCiAgICAgKiAgICAgICAgICAgIHJlcXVlc3RlZCBzdGF0ZSB1bnRpbCBleHBsaWNpdGx5IGNsZWFyZWQsIG9yIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlVW5tZXRlcmVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZVVubWV0ZXJlZCwKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlVW5tZXRlcmVkKHN1YklkLCBvdmVycmlkZVVubWV0ZXJlZCwKICAgICAgICAgICAgICAgIFRlbGVwaG9ueU1hbmFnZXIuZ2V0QWxsTmV0d29ya1R5cGVzKCksIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIHVubWV0ZXJlZC4gVGhpcyB3aWxsIGJlIHJlZmxlY3RlZAogICAgICogdG8gYXBwcyB2aWEge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfTk9UX01FVEVSRUR9LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVVbm1ldGVyZWQgc2V0IGlmIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBzaG91bGQgYmUKICAgICAqICAgICAgICAgICAgY29uc2lkZXJlZCB1bm1ldGVyZWQuCiAgICAgKiBAcGFyYW0gbmV0d29ya1R5cGVzIHRoZSBuZXR3b3JrIHR5cGVzIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4gSWYgbm8KICAgICAqICAgICAgICAgICAgbmV0d29yayB0eXBlcyBhcmUgc3BlY2lmaWVkLCBvdmVycmlkZSB2YWx1ZXMgd2lsbCBiZSBpZ25vcmVkLgogICAgICogICAgICAgICAgICB7QHNlZSBUZWxlcGhvbnlNYW5hZ2VyI2dldEFsbE5ldHdvcmtUeXBlcygpfQogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZCBvdmVycmlkZQogICAgICogICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9IHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvciB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZVVubWV0ZXJlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVVbm1ldGVyZWQsCiAgICAgICAgICAgIEBOb25OdWxsIEBBbm5vdGF0aW9uLk5ldHdvcmtUeXBlIGludFtdIG5ldHdvcmtUeXBlcywKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIGZpbmFsIGludCBvdmVycmlkZVZhbHVlID0gb3ZlcnJpZGVVbm1ldGVyZWQgPyBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEIDogMDsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvbk92ZXJyaWRlKHN1YklkLCBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVELAogICAgICAgICAgICAgICAgb3ZlcnJpZGVWYWx1ZSwgbmV0d29ya1R5cGVzLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIGNvbmdlc3RlZC4gVGhpcyB3aWxsIGNhdXNlIHRoZQogICAgICogZGV2aWNlIHRvIGRlbGF5IGNlcnRhaW4gbmV0d29yayByZXF1ZXN0cyB3aGVuIHBvc3NpYmxlLCBzdWNoIGFzIGRldmVsb3BlcgogICAgICogam9icyB0aGF0IGFyZSB3aWxsaW5nIHRvIHJ1biBpbiBhIGZsZXhpYmxlIHRpbWUgd2luZG93LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVDb25nZXN0ZWQgc2V0IGlmIHRoZSBzdWJzY3JpcHRpb24gc2hvdWxkIGJlIGNvbnNpZGVyZWQKICAgICAqICAgICAgICAgICAgY29uZ2VzdGVkLgogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZCBvdmVycmlkZQogICAgICogICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9IHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvciB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZUNvbmdlc3RlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVDb25nZXN0ZWQsCiAgICAgICAgICAgIEBEdXJhdGlvbk1pbGxpc0xvbmcgbG9uZyBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpIHsKICAgICAgICBzZXRTdWJzY3JpcHRpb25PdmVycmlkZUNvbmdlc3RlZChzdWJJZCwgb3ZlcnJpZGVDb25nZXN0ZWQsCiAgICAgICAgICAgICAgICBUZWxlcGhvbnlNYW5hZ2VyLmdldEFsbE5ldHdvcmtUeXBlcygpLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpOwogICAgfQoKICAgIC8qKgogICAgICogVGVtcG9yYXJpbHkgb3ZlcnJpZGUgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIgYW5kCiAgICAgKiBhIHNwZWNpZmljIHN1YnNjcmliZXIgdG8gYmUgY29uc2lkZXJlZCBjb25nZXN0ZWQuIFRoaXMgd2lsbCBjYXVzZSB0aGUKICAgICAqIGRldmljZSB0byBkZWxheSBjZXJ0YWluIG5ldHdvcmsgcmVxdWVzdHMgd2hlbiBwb3NzaWJsZSwgc3VjaCBhcyBkZXZlbG9wZXIKICAgICAqIGpvYnMgdGhhdCBhcmUgd2lsbGluZyB0byBydW4gaW4gYSBmbGV4aWJsZSB0aW1lIHdpbmRvdy4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLgogICAgICogQHBhcmFtIG92ZXJyaWRlQ29uZ2VzdGVkIHNldCBpZiB0aGUgc3Vic2NyaXB0aW9uIHNob3VsZCBiZSBjb25zaWRlcmVkCiAgICAgKiAgICAgICAgICAgIGNvbmdlc3RlZC4KICAgICAqIEBwYXJhbSBuZXR3b3JrVHlwZXMgdGhlIG5ldHdvcmsgdHlwZXMgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLiBJZiBubwogICAgICogICAgICAgICAgICBuZXR3b3JrIHR5cGVzIGFyZSBzcGVjaWZpZWQsIG92ZXJyaWRlIHZhbHVlcyB3aWxsIGJlIGlnbm9yZWQuCiAgICAgKiAgICAgICAgICAgIHtAc2VlIFRlbGVwaG9ueU1hbmFnZXIjZ2V0QWxsTmV0d29ya1R5cGVzKCl9CiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgcmVxdWVzdGVkIG92ZXJyaWRlCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgaW4gdGhlCiAgICAgKiAgICAgICAgICAgIHJlcXVlc3RlZCBzdGF0ZSB1bnRpbCBleHBsaWNpdGx5IGNsZWFyZWQsIG9yIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlQ29uZ2VzdGVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZUNvbmdlc3RlZCwKICAgICAgICAgICAgQE5vbk51bGwgQEFubm90YXRpb24uTmV0d29ya1R5cGUgaW50W10gbmV0d29ya1R5cGVzLAogICAgICAgICAgICBARHVyYXRpb25NaWxsaXNMb25nIGxvbmcgZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzKSB7CiAgICAgICAgZmluYWwgaW50IG92ZXJyaWRlVmFsdWUgPSBvdmVycmlkZUNvbmdlc3RlZCA/IFNVQlNDUklQVElPTl9PVkVSUklERV9DT05HRVNURUQgOiAwOwogICAgICAgIGdldE5ldHdvcmtQb2xpY3lNYW5hZ2VyKCkuc2V0U3Vic2NyaXB0aW9uT3ZlcnJpZGUoc3ViSWQsIFNVQlNDUklQVElPTl9PVkVSUklERV9DT05HRVNURUQsCiAgICAgICAgICAgICAgICBvdmVycmlkZVZhbHVlLCBuZXR3b3JrVHlwZXMsIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcywgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIHRoZSBhcHAgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBpcyBhdXRob3JpemVkIHRvIG1hbmFnZSB0aGUgZ2l2ZW4gc3Vic2NyaXB0aW9uCiAgICAgKiBhY2NvcmRpbmcgdG8gaXRzIG1ldGFkYXRhLgogICAgICoKICAgICAqIE9ubHkgc3VwcG9ydGVkIGZvciBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIChpZiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyBUaGUgc3Vic2NyaXB0aW9uIHRvIGNoZWNrLgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBhcHAgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhpcyBzdWJzY3JpcHRpb24gcGVyIGl0cyBtZXRhZGF0YS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8gaW5mbykgewogICAgICAgIHJldHVybiBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oaW5mbywgbUNvbnRleHQuZ2V0UGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24uIEFuIGFwcCBjYW4gb25seQogICAgICogYmUgYXV0aG9yaXplZCBpZiBpdCBpcyBpbmNsdWRlZCBpbiB0aGUge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlVpY2NBY2Nlc3NSdWxlfSBvZiB0aGUKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5TdWJzY3JpcHRpb25JbmZvfSB3aXRoIHRoZSBhY2Nlc3Mgc3RhdHVzLgogICAgICoKICAgICAqIE9ubHkgc3VwcG9ydGVkIGZvciBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIChpZiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyBUaGUgc3Vic2NyaXB0aW9uIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHBhY2thZ2VOYW1lIFBhY2thZ2UgbmFtZSBvZiB0aGUgYXBwIHRvIGNoZWNrLgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBhcHAgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhpcyBzdWJzY3JpcHRpb24gcGVyIGl0cyBhY2Nlc3MgcnVsZXMuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oQE5vbk51bGwgU3Vic2NyaXB0aW9uSW5mbyBpbmZvLAogICAgICAgICAgICBATm9uTnVsbCBTdHJpbmcgcGFja2FnZU5hbWUpIHsKICAgICAgICBpZiAoaW5mbyA9PSBudWxsIHx8IGluZm8uZ2V0QWxsQWNjZXNzUnVsZXMoKSA9PSBudWxsIHx8IHBhY2thZ2VOYW1lID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBQYWNrYWdlTWFuYWdlciBwYWNrYWdlTWFuYWdlciA9IG1Db250ZXh0LmdldFBhY2thZ2VNYW5hZ2VyKCk7CiAgICAgICAgUGFja2FnZUluZm8gcGFja2FnZUluZm87CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcGFja2FnZUluZm8gPSBwYWNrYWdlTWFuYWdlci5nZXRQYWNrYWdlSW5mbyhwYWNrYWdlTmFtZSwKICAgICAgICAgICAgICAgIFBhY2thZ2VNYW5hZ2VyLkdFVF9TSUdOSU5HX0NFUlRJRklDQVRFUyk7CiAgICAgICAgfSBjYXRjaCAoUGFja2FnZU1hbmFnZXIuTmFtZU5vdEZvdW5kRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgbG9nZCgiVW5rbm93biBwYWNrYWdlOiAiICsgcGFja2FnZU5hbWUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoVWljY0FjY2Vzc1J1bGUgcnVsZSA6IGluZm8uZ2V0QWxsQWNjZXNzUnVsZXMoKSkgewogICAgICAgICAgICBpZiAocnVsZS5nZXRDYXJyaWVyUHJpdmlsZWdlU3RhdHVzKHBhY2thZ2VJbmZvKQogICAgICAgICAgICAgICAgICAgID09IFRlbGVwaG9ueU1hbmFnZXIuQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX0hBU19BQ0NFU1MpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzIHVzZWQKICAgICAqIGJ5IEFsdGVybmF0aXZlTmV0d29ya1NlcnZpY2Ugb3IgY2FycmllciBhcHBzIHRvIHN3aXRjaCBwcmltYXJ5IGFuZCBDQlJTCiAgICAgKiBzdWJzY3JpcHRpb24gZHluYW1pY2FsbHkgaW4gbXVsdGktU0lNIGRldmljZXMuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHdoaWNoIHN1YnNjcmlwdGlvbiBpcyBwcmVmZXJyZWQgdG8gZm9yIGNlbGx1bGFyIGRhdGEuIElmIGl0J3MKICAgICAqICAgICAgICAgICAgICB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0sIGl0IG1lYW5zCiAgICAgKiAgICAgICAgICAgICAgaXQncyB1bnNldCBhbmQge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICogICAgICAgICAgICAgIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIG1vZGVtIGlzIHByZWZlcnJlZC4KICAgICAqIEBwYXJhbSBuZWVkVmFsaWRhdGlvbiB3aGV0aGVyIFRlbGVwaG9ueSB3aWxsIHdhaXQgdW50aWwgdGhlIG5ldHdvcmsgaXMgdmFsaWRhdGVkIGJ5CiAgICAgKiAgICAgICAgICAgICAgY29ubmVjdGl2aXR5IHNlcnZpY2UgYmVmb3JlIHN3aXRjaGluZyBkYXRhIHRvIGl0LiBNb3JlIGRldGFpbHMgc2VlCiAgICAgKiAgICAgICAgICAgICAge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfVkFMSURBVEVEfS4KICAgICAqIEBwYXJhbSBleGVjdXRvciBUaGUgZXhlY3V0b3Igb2Ygd2hlcmUgdGhlIGNhbGxiYWNrIHdpbGwgZXhlY3V0ZS4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBDYWxsYmFjayB3aWxsIGJlIHRyaWdnZXJlZCBvbmNlIGl0IHN1Y2NlZWRzIG9yIGZhaWxlZC4KICAgICAqICAgICAgICAgICAgICAgICBQYXNzIG51bGwgaWYgZG9uJ3QgY2FyZSBhYm91dCB0aGUgcmVzdWx0LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKgogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoaW50IHN1YklkLCBib29sZWFuIG5lZWRWYWxpZGF0aW9uLAogICAgICAgICAgICBATnVsbGFibGUgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsIEBOdWxsYWJsZQogICAgICAgICAgICBAVGVsZXBob255TWFuYWdlci5TZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uUmVzdWx0IENvbnN1bWVyPEludGVnZXI+IGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltzZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWRdKyBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiA9PSBudWxsKSByZXR1cm47CgogICAgICAgICAgICBJU2V0T3Bwb3J0dW5pc3RpY0RhdGFDYWxsYmFjayBjYWxsYmFja1N0dWIgPSBuZXcgSVNldE9wcG9ydHVuaXN0aWNEYXRhQ2FsbGJhY2suU3R1YigpIHsKICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgb25Db21wbGV0ZShpbnQgcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4ZWN1dG9yID09IG51bGwgfHwgY2FsbGJhY2sgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpbmFsIGxvbmcgaWRlbnRpdHkgPSBCaW5kZXIuY2xlYXJDYWxsaW5nSWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFjY2VwdChyZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBpU3ViLnNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZChzdWJJZCwgbmVlZFZhbGlkYXRpb24sIGNhbGxiYWNrU3R1Yik7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzIHVzZWQKICAgICAqIGJ5IEFsdGVybmF0aXZlTmV0d29ya1NlcnZpY2Ugb3IgY2FycmllciBhcHBzIHRvIHN3aXRjaCBwcmltYXJ5IGFuZCBDQlJTCiAgICAgKiBzdWJzY3JpcHRpb24gZHluYW1pY2FsbHkgaW4gbXVsdGktU0lNIGRldmljZXMuCiAgICAgKgogICAgICogQHJldHVybiBwcmVmZXJyZWQgc3Vic2NyaXB0aW9uIGlkIGZvciBjZWxsdWxhciBkYXRhLiB7QGxpbmsgREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9IGlmCiAgICAgKiB0aGVyZSdzIG5vIHByZWZlcmVkIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICoKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgZ2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIGludCBwcmVmZXJyZWRTdWJJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZWZlcnJlZFN1YklkID0gaVN1Yi5nZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBwcmVmZXJyZWRTdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgdGhhdCBjYW4gYmUgdmlzaWJsZSB0byB0aGUgY2FsbGVyLgogICAgICogT3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGFyZSBmb3Igb3Bwb3J0dW5pc3RpYyBuZXR3b3Jrcywgd2hpY2ggYXJlIGNlbGx1bGFyCiAgICAgKiBuZXR3b3JrcyB3aXRoIGxpbWl0ZWQgY2FwYWJpbGl0aWVzIGFuZCBjb3ZlcmFnZSwgZm9yIGV4YW1wbGUsIENCUlMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGxpc3Qgb2Ygb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gaW5mby4gSWYgbm9uZSBleGlzdHMsIGFuIGVtcHR5IGxpc3QuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0T3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnMoKSB7CiAgICAgICAgU3RyaW5nIGNvbnRleHRQa2cgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgU3RyaW5nIGNvbnRleHRBdHRyaWJ1dGlvblRhZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpIDogbnVsbDsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHN1YkluZm9MaXN0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YkluZm9MaXN0ID0gaVN1Yi5nZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9ucyhjb250ZXh0UGtnLAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0QXR0cmlidXRpb25UYWcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHN1YkluZm9MaXN0ID09IG51bGwpIHsKICAgICAgICAgICAgc3ViSW5mb0xpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJbmZvTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIFN3aXRjaCB0byBhIGNlcnRhaW4gc3Vic2NyaXB0aW9uCiAgICAgKgogICAgICogIEBwYXJhbSBzdWJJZCBzdWIgaWQKICAgICAqICBAcGFyYW0gY2FsbGJhY2tJbnRlbnQgcGVuZGluZyBpbnRlbnQgdGhhdCB3aWxsIGJlIHNlbnQgYWZ0ZXIgb3BlcmF0aW9uIGlzIGRvbmUuCiAgICAgKgogICAgICogIHRvLWJlLWRlcHJlY2F0ZWQgdGhpcyBBUEkgaXMgYSBkdXBsaWNhdGUgb2Yge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsCiAgICAgKiAgUGVuZGluZ0ludGVudCl9IGFuZCBkb2VzIG5vdCBzdXBwb3J0IE11bHRpcGxlIEVuYWJsZWQgUHJvZmlsZShNRVApLiBBcHBzIHNob3VsZCB1c2UKICAgICAqICB7QGxpbmsgRXVpY2NNYW5hZ2VyI3N3aXRjaFRvU3Vic2NyaXB0aW9uKGludCwgUGVuZGluZ0ludGVudCl9IG9yCiAgICAgKiAge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsIGludCwgUGVuZGluZ0ludGVudCl9IGluc3RlYWQuCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLldSSVRFX0VNQkVEREVEX1NVQlNDUklQVElPTlMpCiAgICBwdWJsaWMgdm9pZCBzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQgc3ViSWQsIEBOb25OdWxsIFBlbmRpbmdJbnRlbnQgY2FsbGJhY2tJbnRlbnQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChjYWxsYmFja0ludGVudCwgImNhbGxiYWNrSW50ZW50IGNhbm5vdCBiZSBudWxsIik7CiAgICAgICAgRXVpY2NNYW5hZ2VyIGV1aWNjTWFuYWdlciA9IG5ldyBFdWljY01hbmFnZXIobUNvbnRleHQpOwogICAgICAgIGV1aWNjTWFuYWdlci5zd2l0Y2hUb1N1YnNjcmlwdGlvbihzdWJJZCwgY2FsbGJhY2tJbnRlbnQpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgb3Bwb3J0dW5pc3RpYywgdGhhdCBpcywgd2hldGhlciB0aGUgbmV0d29yayBpdCBjb25uZWN0cwogICAgICogdG8gaGFzIGxpbWl0ZWQgY292ZXJhZ2UuIEZvciBleGFtcGxlLCBDQlJTLiBTZXR0aW5nIGEgc3Vic2NyaXB0aW9uIG9wcG9ydHVuaXN0aWMgaGFzCiAgICAgKiBmb2xsb3dpbmcgaW1wYWN0czoKICAgICAqICAxKSBFdmVuIGlmIGl0J3MgYWN0aXZlLCBpdCB3aWxsIGJlIGRvcm1hbnQgbW9zdCBvZiB0aGUgdGltZS4gVGhlIG1vZGVtIHdpbGwgbm90IHRyeQogICAgICogICAgIHRvIHNjYW4gb3IgY2FtcCB1bnRpbCBpdCBrbm93cyBhbiBhdmFpbGFibGUgbmV0d29yayBpcyBuZWFyYnkgdG8gc2F2ZSBwb3dlci4KICAgICAqICAyKSBUZWxlcGhvbnkgcmVsaWVzIG9uIHN5c3RlbSBhcHAgb3IgY2FycmllciBpbnB1dCB0byBub3RpZnkgbmVhcmJ5IGF2YWlsYWJsZSBuZXR3b3Jrcy4KICAgICAqICAgICBTZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjdXBkYXRlQXZhaWxhYmxlTmV0d29ya3MoTGlzdCwgRXhlY3V0b3IsIENvbnN1bWVyKX0KICAgICAqICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqICAzKSBJbiBtdWx0aS1TSU0gZGV2aWNlcywgd2hlbiB0aGUgbmV0d29yayBpcyBuZWFyYnkgYW5kIGNhbXBlZCwgc3lzdGVtIG1heSBhdXRvbWF0aWNhbGx5CiAgICAgKiAgICAgc3dpdGNoIGludGVybmV0IGRhdGEgYmV0d2VlbiBpdCBhbmQgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiwgYmFzZWQgb24gY2FycmllcgogICAgICogICAgIHJlY29tbWVuZGF0aW9uIGFuZCBpdHMgc2lnbmFsIHN0cmVuZ3RoIGFuZCBtZXRlcmVkLW5lc3MsIGV0Yy4KICAgICAqCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEV9IG9yIGNhcnJpZXIKICAgICAqIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9mIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHBhcmFtIG9wcG9ydHVuaXN0aWMgd2hldGhlciBpdOKAmXMgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgb3BlcmF0aW9uIGlzIHN1Y2NlZWQsIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0T3Bwb3J0dW5pc3RpYyhib29sZWFuIG9wcG9ydHVuaXN0aWMsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbc2V0T3Bwb3J0dW5pc3RpY10rIG9wcG9ydHVuaXN0aWM6IiArIG9wcG9ydHVuaXN0aWMgKyAiIHN1YklkOiIgKyBzdWJJZCk7CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0T3Bwb3J0dW5pc3RpYyIsCiAgICAgICAgICAgICAgICAoaVN1YiktPiBpU3ViLnNldE9wcG9ydHVuaXN0aWMoCiAgICAgICAgICAgICAgICAgICAgICAgIG9wcG9ydHVuaXN0aWMsIHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpKSA9PSAxOwogICAgfQoKICAgIC8qKgogICAgICogSW5mb3JtIFN1YnNjcmlwdGlvbk1hbmFnZXIgdGhhdCBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGFyZSBidW5kbGVkCiAgICAgKiBhcyBhIGdyb3VwLiBJdCBjYW4gYmUgbXVsdGlwbGUgcHJpbWFyeSAobm9uLW9wcG9ydHVuaXN0aWMpIHN1YnNjcmlwdGlvbnMsCiAgICAgKiBvciBvbmUgb3IgbW9yZSBwcmltYXJ5IHBsdXMgb25lIG9yIG1vcmUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIFRoaXMgQVBJIHdpbGwgYWx3YXlzIGNyZWF0ZSBhIG5ldyBpbW11dGFibGUgZ3JvdXAgYW5kIGFzc2lnbiBncm91cCBVVUlEIHRvIGFsbCB0aGUKICAgICAqIHN1YnNjcmlwdGlvbnMsIHJlZ2FyZGxlc3Mgd2hldGhlciB0aGV5IGFyZSBpbiBhIGdyb3VwIGFscmVhZHkgb3Igbm90LgogICAgICoKICAgICAqIEdyb3VwZWQgc3Vic2NyaXB0aW9ucyB3aWxsIGhhdmUgYmVsb3cgYmVoYXZpb3JzOgogICAgICogMSkgVGhleSB3aWxsIHNoYXJlIHRoZSBzYW1lIHVzZXIgc2V0dGluZ3MuCiAgICAgKiAyKSBUaGUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGluIHRoZSBncm91cCBpcyBjb25zaWRlcmVkIGludmlzaWJsZSBhbmQgd2lsbCBub3QKICAgICAqICAgIHJldHVybiBmcm9tIHtAbGluayAjZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKX0sIHVubGVzcyBjYWxsZXIgaGFzIGNhcnJpZXIKICAgICAqICAgIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9mIHRoZSBzdWJzY3JpcHRpb25zLgogICAgICogMykgVGhlIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZ3JvdXAgY2FuJ3QgYmUgYWN0aXZlIGJ5IGl0c2VsZi4gSWYgYWxsIG90aGVyCiAgICAgKiAgICBub24tb3Bwb3J0dW5pc3RpYyBvbmVzIGFyZSBkZWFjdGl2YXRlZCAodW5wbHVnZ2VkIG9yIGRpc2FibGVkIGluIFNldHRpbmdzKSwKICAgICAqICAgIHRoZSBvcHBvcnR1bmlzdGljIG9uZXMgd2lsbCBiZSBkZWFjdGl2YXRlZCBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICogcGVybWlzc2lvbiBvciBoYWQgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbiBvbiB0aGUgc3Vic2NyaXB0aW9uczoKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9IG9yCiAgICAgKiB7QGxpbmsgI2Nhbk1hbmFnZVN1YnNjcmlwdGlvbihTdWJzY3JpcHRpb25JbmZvKX0KICAgICAqCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgYW55IG9mIHRoZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGRvZXNuJ3QgZXhpc3QuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiBUZWxlcGhvbnkgc2VydmljZSBpcyBpbiBiYWQgc3RhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkTGlzdCBsaXN0IG9mIHN1YklkIHRoYXQgd2lsbCBiZSBpbiB0aGUgc2FtZSBncm91cAogICAgICogQHJldHVybiBncm91cFVVSUQgYSBVVUlEIGFzc2lnbmVkIHRvIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIFBhcmNlbFV1aWQgY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChzdWJJZExpc3QsICJjYW4ndCBjcmVhdGUgZ3JvdXAgZm9yIG51bGwgc3ViSWQgbGlzdCIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXBdIik7CiAgICAgICAgfQoKICAgICAgICBQYXJjZWxVdWlkIGdyb3VwVXVpZCA9IG51bGw7CiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpLT5pKS50b0FycmF5KCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGdyb3VwVXVpZCA9IGlTdWIuY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoc3ViSWRBcnJheSwgcGtnRm9yRGVidWcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInRlbGVwaG9ueSBzZXJ2aWNlIGlzIG51bGwuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZSgiY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdyb3VwVXVpZDsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBpbnRvIGEgZ3JvdXAuCiAgICAgKiBTZWUge0BsaW5rICNjcmVhdGVTdWJzY3JpcHRpb25Hcm91cChMaXN0KX0gZm9yIG1vcmUgZGV0YWlscy4KICAgICAqCiAgICAgKiBDYWxsZXIgd2lsbCBlaXRoZXIgaGF2ZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIHRoZSBzb21lIHN1YnNjcmlwdGlvbnMgaW4gdGhlIGxpc3QgZG9lc24ndCBleGlzdC4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIFRlbGVwaG9ueSBzZXJ2aWNlIGlzIGluIGJhZCBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWRMaXN0IGxpc3Qgb2Ygc3ViSWQgdGhhdCBuZWVkIGFkZGluZyBpbnRvIHRoZSBncm91cAogICAgICogQHBhcmFtIGdyb3VwVXVpZCB0aGUgZ3JvdXBVdWlkIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBiZWluZyBhZGRlZCB0by4KICAgICAqCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgYWRkU3Vic2NyaXB0aW9uc0ludG9Hcm91cChATm9uTnVsbCBMaXN0PEludGVnZXI+IHN1YklkTGlzdCwKICAgICAgICAgICAgQE5vbk51bGwgUGFyY2VsVXVpZCBncm91cFV1aWQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChzdWJJZExpc3QsICJzdWJJZExpc3QgY2FuJ3QgYmUgbnVsbC4iKTsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChncm91cFV1aWQsICJncm91cFV1aWQgY2FuJ3QgYmUgbnVsbC4iKTsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXBdIik7CiAgICAgICAgfQoKICAgICAgICBpbnRbXSBzdWJJZEFycmF5ID0gc3ViSWRMaXN0LnN0cmVhbSgpLm1hcFRvSW50KGktPmkpLnRvQXJyYXkoKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuYWRkU3Vic2NyaXB0aW9uc0ludG9Hcm91cChzdWJJZEFycmF5LCBncm91cFV1aWQsIHBrZ0ZvckRlYnVnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGxvZ2UoImFkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIGJvb2xlYW4gaXNTeXN0ZW1Qcm9jZXNzKCkgewogICAgICAgIHJldHVybiBQcm9jZXNzLm15VWlkKCkgPT0gUHJvY2Vzcy5TWVNURU1fVUlEOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZyb20gdGhlaXIgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICogU2VlIHtAbGluayAjY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoTGlzdCl9IGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKiBwZXJtaXNzaW9uIG9yIGhhZCBjYXJyaWVyIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9uIHRoZSBzdWJzY3JpcHRpb25zOgogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0gb3IKICAgICAqIHtAbGluayAjY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8pfQogICAgICoKICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiB0aGUgc29tZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGRvZXNuJ3QgYmVsb25nCiAgICAgKiAgICAgICAgICAgICB0aGUgc3BlY2lmaWVkIGdyb3VwLgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZExpc3QgbGlzdCBvZiBzdWJJZCB0aGF0IG5lZWQgcmVtb3ZpbmcgZnJvbSB0aGVpciBncm91cHMuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QsCiAgICAgICAgICAgIEBOb25OdWxsIFBhcmNlbFV1aWQgZ3JvdXBVdWlkKSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoc3ViSWRMaXN0LCAic3ViSWRMaXN0IGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoZ3JvdXBVdWlkLCAiZ3JvdXBVdWlkIGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwXSIpOwogICAgICAgIH0KCiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpLT5pKS50b0FycmF5KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAoc3ViSWRBcnJheSwgZ3JvdXBVdWlkLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgc3Vic2NyaXB0aW9uSW5mbyBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgdGhhdCBhcmUgaW4gdGhlIHNhbWUgZ3JvdXAgb2YgZ2l2ZW4gc3ViSWQuCiAgICAgKiBTZWUge0BsaW5rICNjcmVhdGVTdWJzY3JpcHRpb25Hcm91cChMaXN0KX0gZm9yIG1vcmUgZGV0YWlscy4KICAgICAqCiAgICAgKiBDYWxsZXIgbXVzdCBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9CiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMzMsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGFuIGVtcHR5IExpc3QgaWYgdGhlIGNhbGxlciBkb2VzCiAgICAgKiBub3QgaGF2ZSBhY2Nlc3MgdG8gZGV2aWNlIGlkZW50aWZpZXJzLgogICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbi4KICAgICAqICAgICB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfQogICAgICogICAgIDxsaT5JZiB0aGUgYXBwIGhhcyB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24gYW5kCiAgICAgKiAgICAgYWNjZXNzIHRvIGRldmljZSBpZGVudGlmaWVycy4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gZ3JvdXBVdWlkIG9mIHdoaWNoIGxpc3Qgb2Ygc3ViSW5mbyB3aWxsIGJlIHJldHVybmVkLgogICAgICogQHJldHVybiBsaXN0IG9mIHN1YnNjcmlwdGlvbkluZm8gdGhhdCBiZWxvbmcgdG8gdGhlIHNhbWUgZ3JvdXAsIGluY2x1ZGluZyB0aGUgZ2l2ZW4KICAgICAqIHN1YnNjcmlwdGlvbiBpdHNlbGYuIEl0IHdpbGwgcmV0dXJuIGFuIGVtcHR5IGxpc3QgaWYgbm8gc3Vic2NyaXB0aW9uIGJlbG9uZ3MgdG8gdGhlIGdyb3VwLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0U3Vic2NyaXB0aW9uc0luR3JvdXAoQE5vbk51bGwgUGFyY2VsVXVpZCBncm91cFV1aWQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChncm91cFV1aWQsICJncm91cFV1aWQgY2FuJ3QgYmUgbnVsbCIpOwogICAgICAgIFN0cmluZyBjb250ZXh0UGtnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIFN0cmluZyBjb250ZXh0QXR0cmlidXRpb25UYWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSA6IG51bGw7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2dldFN1YnNjcmlwdGlvbnNJbkdyb3VwXSsgZ3JvdXBVdWlkOiIgKyBncm91cFV1aWQpOwogICAgICAgIH0KCiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldFN1YnNjcmlwdGlvbnNJbkdyb3VwKGdyb3VwVXVpZCwgY29udGV4dFBrZywKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dEF0dHJpYnV0aW9uVGFnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGxvZ2UoInJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgdmlzaWJsZSB0byBBUEkgY2FsbGVyLiBJZiBpdCdzIGEgYnVuZGxlZCBvcHBvcnR1bmlzdGljCiAgICAgKiBzdWJzY3JpcHRpb24sIGl0IHNob3VsZCBiZSBoaWRkZW4gYW55d2hlcmUgaW4gU2V0dGluZ3MsIGRpYWxlciwgc3RhdHVzIGJhciBldGMuCiAgICAgKiBFeGNlcHRpb24gaXMgaWYgY2FsbGVyIG93bnMgY2FycmllciBwcml2aWxlZ2UsIGluIHdoaWNoIGNhc2UgdGhleSB3aWxsCiAgICAgKiB3YW50IHRvIHNlZSB0aGVpciBvd24gaGlkZGVuIHN1YnNjcmlwdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIGluZm8gdGhlIHN1YnNjcmlwdGlvbkluZm8gdG8gY2hlY2sgYWdhaW5zdC4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGlzIHN1YnNjcmlwdGlvbiBzaG91bGQgYmUgdmlzaWJsZSB0byB0aGUgQVBJIGNhbGxlci4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc1N1YnNjcmlwdGlvblZpc2libGUoU3Vic2NyaXB0aW9uSW5mbyBpbmZvKSB7CiAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIElmIHN1YnNjcmlwdGlvbiBpcyBOT1QgZ3JvdXBlZCBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiwgaXQncyB2aXNpYmxlLgogICAgICAgIGlmIChpbmZvLmdldEdyb3VwVXVpZCgpID09IG51bGwgfHwgIWluZm8uaXNPcHBvcnR1bmlzdGljKCkpIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBJZiB0aGUgY2FsbGVyIGlzIHRoZSBjYXJyaWVyIGFwcCBhbmQgb3ducyB0aGUgc3Vic2NyaXB0aW9uLCBpdCBzaG91bGQgYmUgdmlzaWJsZQogICAgICAgIC8vIHRvIHRoZSBjYWxsZXIuCiAgICAgICAgYm9vbGVhbiBoYXNDYXJyaWVyUHJpdmlsZWdlUGVybWlzc2lvbiA9IFRlbGVwaG9ueU1hbmFnZXIuZnJvbShtQ29udGV4dCkKICAgICAgICAgICAgICAgIC5oYXNDYXJyaWVyUHJpdmlsZWdlcyhpbmZvLmdldFN1YnNjcmlwdGlvbklkKCkpCiAgICAgICAgICAgICAgICB8fCBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oaW5mbyk7CiAgICAgICAgcmV0dXJuIGhhc0NhcnJpZXJQcml2aWxlZ2VQZXJtaXNzaW9uOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIHRoYXQgYXJlIGF2YWlsYWJsZSBhbmQgdmlzaWJsZSB0byB0aGUgdXNlci4KICAgICAqIFVzZWQgYnkgU2V0dGluZ3MgYXBwIHRvIHNob3cgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHVzZXIgdG8gcGljay4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciBnZXRTZWxlY3RhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QgdG8gYmUgaW52b2tlZC4KICAgICAqIEByZXR1cm4gbGlzdCBvZiB1c2VyIHNlbGVjdGFibGUgc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgQE51bGxhYmxlIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0U2VsZWN0YWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gYXZhaWxhYmxlTGlzdCA9IGdldEF2YWlsYWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCk7CiAgICAgICAgaWYgKGF2YWlsYWJsZUxpc3QgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBNdWx0aXBsZSBzdWJzY3JpcHRpb25zIGluIGEgZ3JvdXAgc2hvdWxkIG9ubHkgaGF2ZSBvbmUgcmVwcmVzZW50YXRpdmUuCiAgICAgICAgICAgIC8vIEl0IHNob3VsZCBiZSB0aGUgY3VycmVudCBhY3RpdmUgcHJpbWFyeSBzdWJzY3JpcHRpb24gaWYgYW55LCBvciBhbnkKICAgICAgICAgICAgLy8gcHJpbWFyeSBzdWJzY3JpcHRpb24uCiAgICAgICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gc2VsZWN0YWJsZUxpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICAgICAgTWFwPFBhcmNlbFV1aWQsIFN1YnNjcmlwdGlvbkluZm8+IGdyb3VwTWFwID0gbmV3IEhhc2hNYXA8PigpOwoKICAgICAgICAgICAgZm9yIChTdWJzY3JpcHRpb25JbmZvIGluZm8gOiBhdmFpbGFibGVMaXN0KSB7CiAgICAgICAgICAgICAgICAvLyBPcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgYXJlIGNvbnNpZGVyZWQgaW52aXNpYmxlCiAgICAgICAgICAgICAgICAvLyB0byB1c2VycyBzbyB0aGV5IHNob3VsZCBuZXZlciBiZSByZXR1cm5lZC4KICAgICAgICAgICAgICAgIGlmICghaXNTdWJzY3JpcHRpb25WaXNpYmxlKGluZm8pKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBQYXJjZWxVdWlkIGdyb3VwVXVpZCA9IGluZm8uZ2V0R3JvdXBVdWlkKCk7CiAgICAgICAgICAgICAgICBpZiAoZ3JvdXBVdWlkID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAvLyBEb2Vzbid0IGJlbG9uZyB0byBhbnkgZ3JvdXAuIEFkZCBpbiB0aGUgbGlzdC4KICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlTGlzdC5hZGQoaW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFncm91cE1hcC5jb250YWluc0tleShncm91cFV1aWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHx8IChncm91cE1hcC5nZXQoZ3JvdXBVdWlkKS5nZXRTaW1TbG90SW5kZXgoKSA9PSBJTlZBTElEX1NJTV9TTE9UX0lOREVYCiAgICAgICAgICAgICAgICAgICAgICAgICYmIGluZm8uZ2V0U2ltU2xvdEluZGV4KCkgIT0gSU5WQUxJRF9TSU1fU0xPVF9JTkRFWCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBiZWxvbmdzIHRvIGEgZ3JvdXAgdGhhdCBoYXMgbmV2ZXIgYmVlbiByZWNvcmRlZCBvciBpdCdzIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgLy8gYWN0aXZlIHN1YnNjcmlwdGlvbiwgYWRkIGl0IGluIHRoZSBsaXN0LgogICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGVMaXN0LnJlbW92ZShncm91cE1hcC5nZXQoZ3JvdXBVdWlkKSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZUxpc3QuYWRkKGluZm8pOwogICAgICAgICAgICAgICAgICAgIGdyb3VwTWFwLnB1dChncm91cFV1aWQsIGluZm8pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VsZWN0YWJsZUxpc3Q7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlcyBvciBkaXNhYmxlcyBhIHN1YnNjcmlwdGlvbi4gVGhpcyBpcyBjdXJyZW50bHkgdXNlZCBpbiB0aGUgc2V0dGluZ3MgcGFnZS4gSXQgd2lsbAogICAgICogZmFpbCBhbmQgcmV0dXJuIGZhbHNlIGlmIG9wZXJhdGlvbiBpcyBub3Qgc3VwcG9ydGVkIG9yIGZhaWxlZC4KICAgICAqCiAgICAgKiBUbyBkaXNhYmxlIGFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gb24gYSBwaHlzaWNhbCAobm9uLUV1aWNjKSBTSU0sCiAgICAgKiB7QGxpbmsgI2NhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbn0gbmVlZHMgdG8gYmUgdHJ1ZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqCiAgICAgKiBAcGFyYW0gZW5hYmxlIHdoZXRoZXIgdXNlciBpcyB0dXJuaW5nIGl0IG9uIG9yIG9mZi4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gdG8gYmUgZW5hYmxlZCBvciBkaXNhYmxlZC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBJdCBjb3VsZCBiZSBhIGVTSU0gb3IgcFNJTSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBvcGVyYXRpb24gaXMgc3VjY2Vzc2Z1bC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRTdWJzY3JpcHRpb25FbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCwgYm9vbGVhbiBlbmFibGUpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJzZXRTdWJzY3JpcHRpb25BY3RpdmF0ZWQgc3ViSWQ9ICIgKyBzdWJzY3JpcHRpb25JZCArICIgZW5hYmxlICIgKyBlbmFibGUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuc2V0U3Vic2NyaXB0aW9uRW5hYmxlZChlbmFibGUsIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB1aWNjIGFwcGxpY2F0aW9ucyBiZWluZyBlbmFibGVkIG9yIGRpc2FibGVkLgogICAgICogVGhlIHZhbHVlIHdpbGwgYmUgcmVtZW1iZXJlZCBvbiB0aGUgc3Vic2NyaXB0aW9uIGFuZCB3aWxsIGJlIGFwcGxpZWQgd2hlbmV2ZXIgaXQncyBwcmVzZW50LgogICAgICogSWYgdGhlIHN1YnNjcmlwdGlvbiBpbiBjdXJyZW50bHkgcHJlc2VudCwgaXQgd2lsbCBhbHNvIGFwcGx5IHRoZSBzZXR0aW5nIHRvIG1vZGVtCiAgICAgKiBpbW1lZGlhdGVseSAodGhlIHNldHRpbmcgaW4gdGhlIG1vZGVtIHdpbGwgbm90IGNoYW5nZSB1bnRpbCB0aGUgbW9kZW0gcmVjZWl2ZXMgYW5kIHJlc3BvbmRzCiAgICAgKiB0byB0aGUgcmVxdWVzdCwgYnV0IHR5cGljYWxseSB0aGlzIHNob3VsZCBvbmx5IHRha2UgYSBmZXcgc2Vjb25kcy4gVGhlIHVzZXIgdmlzaWJsZSBzZXR0aW5nCiAgICAgKiBhdmFpbGFibGUgZnJvbSBTdWJzY3JpcHRpb25JbmZvLmFyZVVpY2NBcHBsaWNhdGlvbnNFbmFibGVkKCkgd2lsbCBiZSB1cGRhdGVkCiAgICAgKiBpbW1lZGlhdGVseS4pCiAgICAgKgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB3aGljaCBzdWJzY3JpcHRpb24gdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBlbmFibGVkIHdoZXRoZXIgdWljYyBhcHBsaWNhdGlvbnMgYXJlIGVuYWJsZWQgb3IgZGlzYWJsZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0VWljY0FwcGxpY2F0aW9uc0VuYWJsZWQoaW50IHN1YnNjcmlwdGlvbklkLCBib29sZWFuIGVuYWJsZWQpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJzZXRVaWNjQXBwbGljYXRpb25zRW5hYmxlZCBzdWJJZD0gIiArIHN1YnNjcmlwdGlvbklkICsgIiBlbmFibGUgIiArIGVuYWJsZWQpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBJU3ViLlN0dWIuYXNJbnRlcmZhY2UoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U3Vic2NyaXB0aW9uU2VydmljZVJlZ2lzdGVyZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldCgpKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXRVaWNjQXBwbGljYXRpb25zRW5hYmxlZChlbmFibGVkLCBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogV2hldGhlciBpdCdzIHN1cHBvcnRlZCB0byBkaXNhYmxlIC8gcmUtZW5hYmxlIGEgc3Vic2NyaXB0aW9uIG9uIGEgcGh5c2ljYWwgKG5vbi1ldWljYykgU0lNLgogICAgICoKICAgICAqIFBoeXNpY2FsIFNJTSByZWZlcnMgbm9uLWV1aWNjLCBvciBha2Egbm9uLXByb2dyYW1tYWJsZSBTSU0uCiAgICAgKgogICAgICogSXQgcHJvdmlkZXMgd2hldGhlciBhIHBoeXNpY2FsIFNJTSBjYXJkIGNhbiBiZSBkaXNhYmxlZCB3aXRob3V0IHRha2luZyBpdCBvdXQsIHdoaWNoIGlzIGRvbmUKICAgICAqIHZpYSB7QGxpbmsgI3NldFN1YnNjcmlwdGlvbkVuYWJsZWQoaW50LCBib29sZWFuKX0gQVBJLgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHdoZXRoZXIgY2FuIGRpc2FibGUgc3Vic2NyaXB0aW9ucyBvbiBwaHlzaWNhbCBTSU1zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGNhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbigpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJjYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24iKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gSVN1Yi5TdHViLmFzSW50ZXJmYWNlKAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueUZyYW1ld29ya0luaXRpYWxpemVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0VGVsZXBob255U2VydmljZU1hbmFnZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFN1YnNjcmlwdGlvblNlcnZpY2VSZWdpc3RlcmVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXQoKSk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpU3ViLmNhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogRE8gTk9UIFVTRS4KICAgICAqIFRoaXMgQVBJIGlzIGRlc2lnbmVkIGZvciBmZWF0dXJlcyB0aGF0IGFyZSBub3QgZmluaXNoZWQgYXQgdGhpcyBwb2ludC4gRG8gbm90IGNhbGwgdGhpcyBBUEkuCiAgICAgKiBAaGlkZQogICAgICogVE9ETyBiLzEzNTU0NzUxMjogZnVydGhlciBjbGVhbiB1cAogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaXNTdWJzY3JpcHRpb25FbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5pc1N1YnNjcmlwdGlvbkVuYWJsZWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nIHVzZXIgcHJlZmVyZW5jZSBmb3IgYSBzdWJzY3JpcHRpb24gSUQuIFRoZSBzZXR0aW5nCiAgICAgKiBhcHAgdXNlcyB0aGlzIG1ldGhvZCB0byBpbmRpY2F0ZSB3aXRoIHdob20gdGhleSB3aXNoIHRvIHNoYXJlIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzCiAgICAgKiBpbmZvcm1hdGlvbi4KICAgICAqIEBwYXJhbSBzaGFyaW5nIHRoZSBzdGF0dXMgc2hhcmluZyBwcmVmZXJlbmNlCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UoaW50IHN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICBARGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSBpbnQgc2hhcmluZykgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmddICsgc2hhcmluZzogIiArIHNoYXJpbmcgKyAiIHN1YklkOiAiCiAgICAgICAgICAgICAgICAgICAgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YnNjcmlwdGlvbklkLCAic2V0RGV2aWNlVG9EZXZpY2VTaGFyaW5nU3RhdHVzIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmcoc2hhcmluZywgc3Vic2NyaXB0aW9uSWQpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHVzZXItY2hvc2VuIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzIHNoYXJpbmcgcHJlZmVyZW5jZQogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFN1YnNjcmlwdGlvbiBpZCBvZiBzdWJzY3JpcHRpb24KICAgICAqIEByZXR1cm4gVGhlIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzIHNoYXJpbmcgcHJlZmVyZW5jZQogICAgICovCiAgICBwdWJsaWMgQERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UgaW50IGdldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UoCiAgICAgICAgICAgIGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmddICsgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRJbnRlZ2VyU3Vic2NyaXB0aW9uUHJvcGVydHkoc3Vic2NyaXB0aW9uSWQsIEQyRF9TVEFUVVNfU0hBUklORywKICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX0RJU0FCTEVELCBtQ29udGV4dCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGxpc3Qgb2YgY29udGFjdHMgdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nIGZvciBhIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIFRoZSBzZXR0aW5nIGFwcCB1c2VzIHRoaXMgbWV0aG9kIHRvIGluZGljYXRlIHdpdGggd2hvbSB0aGV5IHdpc2ggdG8gc2hhcmUgZGV2aWNlIHRvIGRldmljZQogICAgICogc3RhdHVzIGluZm9ybWF0aW9uLgogICAgICogQHBhcmFtIGNvbnRhY3RzIFRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZwogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uIElEIGluIGRhdGFiYXNlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0cyhpbnQgc3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgIEBOb25OdWxsIExpc3Q8VXJpPiBjb250YWN0cykgewogICAgICAgIFN0cmluZyBjb250YWN0U3RyaW5nID0gc2VyaWFsaXplVXJpTGlzdHMoY29udGFjdHMpOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0c10gKyBjb250YWN0czogIiArIGNvbnRhY3RTdHJpbmcKICAgICAgICAgICAgICAgICAgICArICIgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YnNjcmlwdGlvbklkLCAic2V0RGV2aWNlVG9EZXZpY2VTaGFyaW5nU3RhdHVzIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0cyhzZXJpYWxpemVVcmlMaXN0cyhjb250YWN0cyksCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZy4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gaWQgb2Ygc3Vic2NyaXB0aW9uCiAgICAgKiBAcmV0dXJuIFRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZwogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxVcmk+IGdldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ0NvbnRhY3RzKAogICAgICAgICAgICBpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbZ2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nQ29udGFjdHNdICsgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRDb250YWN0c0Zyb21TdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJzY3JpcHRpb25JZCwKICAgICAgICAgICAgICAgIEQyRF9TVEFUVVNfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUywgbUNvbnRleHQpOwogICAgfQoKICAgIC8qKgogICAgICogRE8gTk9UIFVTRS4KICAgICAqIFRoaXMgQVBJIGlzIGRlc2lnbmVkIGZvciBmZWF0dXJlcyB0aGF0IGFyZSBub3QgZmluaXNoZWQgYXQgdGhpcyBwb2ludC4gRG8gbm90IGNhbGwgdGhpcyBBUEkuCiAgICAgKiBAaGlkZQogICAgICogVE9ETyBiLzEzNTU0NzUxMjogZnVydGhlciBjbGVhbiB1cAogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRFbmFibGVkU3Vic2NyaXB0aW9uSWQoaW50IHNsb3RJbmRleCkgewogICAgICAgIGludCBzdWJJZCA9IElOVkFMSURfU1VCU0NSSVBUSU9OX0lEOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSWQgPSBpU3ViLmdldEVuYWJsZWRTdWJzY3JpcHRpb25JZChzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoImdldEVuYWJsZWRTdWJzY3JpcHRpb25JZCwgc3ViSWQgPSAiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzdWJJZDsKICAgIH0KCiAgICBwcml2YXRlIGludGVyZmFjZSBDYWxsSVN1Yk1ldGhvZEhlbHBlciB7CiAgICAgICAgaW50IGNhbGxNZXRob2QoSVN1YiBpU3ViKSB0aHJvd3MgUmVtb3RlRXhjZXB0aW9uOwogICAgfQoKICAgIHByaXZhdGUgaW50IHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKGludCBzdWJJZCwgU3RyaW5nIG1ldGhvZE5hbWUsCiAgICAgICAgICAgIENhbGxJU3ViTWV0aG9kSGVscGVyIGhlbHBlcikgewogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKHN1YklkKSkgewogICAgICAgICAgICBsb2dkKCJbIiArIG1ldGhvZE5hbWUgKyAiXSIgKyAiLSBmYWlsIik7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIGludCByZXN1bHQgPSAwOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaGVscGVyLmNhbGxNZXRob2QoaVN1Yik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IGFjdGl2ZSBkYXRhIHN1YnNjcmlwdGlvbiBpZC4gQWN0aXZlIGRhdGEgc3Vic2NyaXB0aW9uIHJlZmVycyB0byB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiBjdXJyZW50bHkgY2hvc2VuIHRvIHByb3ZpZGUgY2VsbHVsYXIgaW50ZXJuZXQgY29ubmVjdGlvbiB0byB0aGUgdXNlci4gVGhpcyBtYXkgYmUKICAgICAqIGRpZmZlcmVudCBmcm9tIGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKS4gRWcuIE9wcG9ydHVuaXN0aWNzIGRhdGEKICAgICAqCiAgICAgKiBTZWUge0BsaW5rIFBob25lU3RhdGVMaXN0ZW5lciNvbkFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZENoYW5nZWQoaW50KX0gZm9yIHRoZSBkZXRhaWxzLgogICAgICoKICAgICAqIEByZXR1cm4gQWN0aXZlIGRhdGEgc3Vic2NyaXB0aW9uIGlkIGlmIGFueSBpcyBjaG9zZW4sIG9yCiAgICAgKiBTdWJzY3JpcHRpb25NYW5hZ2VyLklOVkFMSURfU1VCU0NSSVBUSU9OX0lEIGlmIG5vdC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0QWN0aXZlRGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIHJldHVybiBzQWN0aXZlRGF0YVN1YklkQ2FjaGUucXVlcnkobnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBIZWxwZXIgbWV0aG9kIHRoYXQgcHV0cyBhIHN1YnNjcmlwdGlvbiBpZCBvbiBhbiBpbnRlbnQgd2l0aCB0aGUgY29uc3RhbnRzOgogICAgICogUGhvbmVDb25zdGFudC5TVUJTQ1JJUFRJT05fS0VZIGFuZCBTdWJzY3JpcHRpb25NYW5hZ2VyLkVYVFJBX1NVQlNDUklQVElPTl9JTkRFWC4KICAgICAqIEJvdGggY29uc3RhbnRzIGFyZSB1c2VkIHRvIHN1cHBvcnQgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuICBPbmNlIHdlIGtub3cgd2UgZ290IGFsbCBwbGFjZXMsCiAgICAgKiB3ZSBjYW4gcmVtb3ZlIFBob25lQ29uc3RhbnRzLlNVQlNDUklQVElPTl9LRVkuCiAgICAgKiBAcGFyYW0gaW50ZW50IEludGVudCB0byBwdXQgc3ViIGlkIG9uLgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbklkIHRvIHB1dCBvbiBpbnRlbnQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIHB1dFN1YnNjcmlwdGlvbklkRXh0cmEoSW50ZW50IGludGVudCwgaW50IHN1YklkKSB7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFN1YnNjcmlwdGlvbk1hbmFnZXIuRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYLCBzdWJJZCk7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFBob25lQ29uc3RhbnRzLlNVQlNDUklQVElPTl9LRVksIHN1YklkKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdFN1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0RFRkFVTFRfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdERhdGFTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9ERUZBVUxUX0RBVEFfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdFNtc1N1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0RFRkFVTFRfU01TX1NVQl9JRF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZUFjdGl2ZURhdGFTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9BQ1RJVkVfREFUQV9TVUJfSURfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVTbG90SW5kZXhDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGxvd3MgYSB0ZXN0IHByb2Nlc3MgdG8gZGlzYWJsZSBjbGllbnQtc2lkZSBjYWNoaW5nIG9wZXJhdGlvbnMuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGRpc2FibGVDYWNoaW5nKCkgewogICAgICAgIHNEZWZhdWx0U3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzRGVmYXVsdERhdGFTdWJJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNBY3RpdmVEYXRhU3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzRGVmYXVsdFNtc1N1YklkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc1Nsb3RJbmRleENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNQaG9uZUlkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDbGVhcnMgYWxsIHByb2Nlc3MtbG9jYWwgYmluZGVyIGNhY2hlcy4KICAgICAqCiAgICAgKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGNsZWFyQ2FjaGVzKCkgewogICAgICAgIHNEZWZhdWx0U3ViSWRDYWNoZS5jbGVhcigpOwogICAgICAgIHNEZWZhdWx0RGF0YVN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzQWN0aXZlRGF0YVN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzRGVmYXVsdFNtc1N1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzU2xvdEluZGV4Q2FjaGUuY2xlYXIoKTsKICAgICAgICBzUGhvbmVJZENhY2hlLmNsZWFyKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsZWQgdG8gcmV0cmlldmUgU0lNLXNwZWNpZmljIHNldHRpbmdzIGRhdGEgdG8gYmUgYmFja2VkIHVwLgogICAgICoKICAgICAqIEByZXR1cm4gZGF0YSBpbiBieXRlW10gdG8gYmUgYmFja2VkIHVwLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJ5dGVbXSBnZXRBbGxTaW1TcGVjaWZpY1NldHRpbmdzRm9yQmFja3VwKCkgewogICAgICAgIEJ1bmRsZSBidW5kbGUgPSAgbUNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCkuY2FsbCgKICAgICAgICAgICAgICAgIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSwKICAgICAgICAgICAgICAgIEdFVF9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUUsIG51bGwsIG51bGwpOwogICAgICAgIHJldHVybiBidW5kbGUuZ2V0Qnl0ZUFycmF5KFN1YnNjcmlwdGlvbk1hbmFnZXIuS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBKTsKICAgIH0KCiAgICAvKioKICAgICAqIENhbGxlZCB0byBhdHRlbXB0IHRvIHJlc3RvcmUgdGhlIGJhY2tlZCB1cCBzaW0tc3BlY2lmaWMgY29uZmlncyB0byBkZXZpY2UgZm9yIHNwZWNpZmljIHNpbS4KICAgICAqIFRoaXMgd2lsbCB0cnkgdG8gcmVzdG9yZSB0aGUgZGF0YSB0aGF0IHdhcyBzdG9yZWQgaW50ZXJuYWxseSB3aGVuIHtAbGluawogICAgICogI3Jlc3RvcmVBbGxTaW1TcGVjaWZpY1NldHRpbmdzRnJvbUJhY2t1cChieXRlW10gZGF0YSl9IHdhcyBjYWxsZWQgZHVyaW5nIHNldHVwIHdpemFyZC4KICAgICAqIEVuZCByZXN1bHQgaXMgU2ltSW5mb0RCIGlzIG1vZGlmaWVkIHRvIG1hdGNoIGFueSBiYWNrZWQgdXAgY29uZmlncyBmb3IgdGhlIHJlcXVlc3RlZAogICAgICogaW5zZXJ0ZWQgc2ltLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayBVcml9IHtAbGluayAjU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJfSBpcyBub3RpZmllZCBpZiBhbnkgU2ltSW5mb0RCCiAgICAgKiBlbnRyeSBpcyB1cGRhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2QgY2FsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gaWNjSWQgb2YgdGhlIHNpbSB0aGF0IGEgcmVzdG9yZSBpcyByZXF1ZXN0ZWQgZm9yLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCByZXN0b3JlU2ltU3BlY2lmaWNTZXR0aW5nc0ZvckljY0lkRnJvbUJhY2t1cChATm9uTnVsbCBTdHJpbmcgaWNjSWQpIHsKICAgICAgICBtQ29udGV4dC5nZXRDb250ZW50UmVzb2x2ZXIoKS5jYWxsKAogICAgICAgICAgICAgICAgU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJLAogICAgICAgICAgICAgICAgUkVTVE9SRV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUUsCiAgICAgICAgICAgICAgICBpY2NJZCwgbnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsZWQgZHVyaW5nIHNldHVwIHdpemFyZCByZXN0b3JlIGZsb3cgdG8gYXR0ZW1wdCB0byByZXN0b3JlIHRoZSBiYWNrZWQgdXAgc2ltLXNwZWNpZmljCiAgICAgKiBjb25maWdzIHRvIGRldmljZSBmb3IgYWxsIGV4aXN0aW5nIFNJTXMgaW4gU2ltSW5mb0RCLiBJbnRlcm5hbGx5LCBpdCB3aWxsIHN0b3JlIHRoZSBiYWNrdXAKICAgICAqIGRhdGEgaW4gYW4gaW50ZXJuYWwgZmlsZS4gVGhpcyBmaWxlIHdpbGwgcGVyc2lzdCBvbiBkZXZpY2UgZm9yIGRldmljZSdzIGxpZmV0aW1lIGFuZCB3aWxsIGJlCiAgICAgKiB1c2VkIGxhdGVyIG9uIHdoZW4gYSBTSU0gaXMgaW5zZXJ0ZWQgdG8gcmVzdG9yZSB0aGF0IHNwZWNpZmljIFNJTSdzIHNldHRpbmdzIGJ5IGNhbGxpbmcKICAgICAqIHtAbGluayAjcmVzdG9yZVNpbVNwZWNpZmljU2V0dGluZ3NGb3JJY2NJZEZyb21CYWNrdXAoU3RyaW5nIGljY0lkKX0uIEVuZCByZXN1bHQgaXMKICAgICAqIFNpbUluZm9EQiBpcyBtb2RpZmllZCB0byBtYXRjaCBhbnkgYmFja2VkIHVwIGNvbmZpZ3MgZm9yIHRoZSBhcHByb3ByaWF0ZSBpbnNlcnRlZCBTSU1zLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayBVcml9IHtAbGluayAjU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJfSBpcyBub3RpZmllZCBpZiBhbnkgU2ltSW5mb0RCCiAgICAgKiBlbnRyeSBpcyB1cGRhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2QgY2FsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gZGF0YSB3aXRoIHRoZSBzaW0gc3BlY2lmaWMgY29uZmlncyB0byBiZSBiYWNrZWQgdXAuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHJlc3RvcmVBbGxTaW1TcGVjaWZpY1NldHRpbmdzRnJvbUJhY2t1cChATm9uTnVsbCBieXRlW10gZGF0YSkgewogICAgICAgIEJ1bmRsZSBidW5kbGUgPSBuZXcgQnVuZGxlKCk7CiAgICAgICAgYnVuZGxlLnB1dEJ5dGVBcnJheShLRVlfU0lNX1NQRUNJRklDX1NFVFRJTkdTX0RBVEEsIGRhdGEpOwogICAgICAgIG1Db250ZXh0LmdldENvbnRlbnRSZXNvbHZlcigpLmNhbGwoCiAgICAgICAgICAgICAgICBTSU1fSU5GT19CQUNLVVBfQU5EX1JFU1RPUkVfQ09OVEVOVF9VUkksCiAgICAgICAgICAgICAgICBSRVNUT1JFX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19NRVRIT0RfTkFNRSwKICAgICAgICAgICAgICAgIG51bGwsIGJ1bmRsZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBwaG9uZSBudW1iZXIgZm9yIHRoZSBnaXZlbiB7QGNvZGUgc3Vic2NyaXB0aW9uSWR9IGFuZCB7QGNvZGUgc291cmNlfSwKICAgICAqIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPkdlbmVyYWwgYXBwcyB0aGF0IG5lZWQgdG8ga25vdyB0aGUgcGhvbmUgbnVtYmVyIHNob3VsZCB1c2Uge0BsaW5rICNnZXRQaG9uZU51bWJlcihpbnQpfQogICAgICogaW5zdGVhZC4gVGhpcyBBUEkgbWF5IGJlIHN1aXRhYmxlIHNwZWNpZmljIGFwcHMgdGhhdCBuZWVkcyB0byBrbm93IHRoZSBwaG9uZSBudW1iZXIgZnJvbQogICAgICogYSBzcGVjaWZpYyBzb3VyY2UuIEZvciBleGFtcGxlLCBhIGNhcnJpZXIgYXBwIG5lZWRzIHRvIGtub3cgZXhhY3RseSB3aGF0J3Mgb24KICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9IGFuZCBkZWNpZGUgaWYgdGhlIHByZXZpb3VzbHkgc2V0IHBob25lIG51bWJlcgogICAgICogb2Ygc291cmNlIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSIGNhcnJpZXJ9IHNob3VsZCBiZSB1cGRhdGVkLgogICAgICoKICAgICAqIDxwPlRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0IGNhbiB2YXJ5CiAgICAgKiBkZXBlbmRpbmcgb24gdGhlIHtAY29kZSBzb3VyY2V9IGFuZCB0aGUgbmV0d29yayBldGMuIFByb2dyYW1tYXRpYyBwYXJzaW5nIHNob3VsZCBiZSBkb25lCiAgICAgKiBjYXV0aW91c2x5LCBmb3IgZXhhbXBsZSwgYWZ0ZXIgZm9ybWF0dGluZyB0aGUgbnVtYmVyIHRvIGEgY29uc2lzdGVudCBmb3JtYXQgd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+Tm90ZSB0aGUgYXNzdW1wdGlvbiBpcyB0aGF0IG9uZSBzdWJzY3JpcHRpb24gKHdoaWNoIHVzdWFsbHkgbWVhbnMgb25lIFNJTSkgaGFzCiAgICAgKiBvbmx5IG9uZSBwaG9uZSBudW1iZXIuIFRoZSBtdWx0aXBsZSBzb3VyY2VzIGJhY2t1cCBlYWNoIG90aGVyIHNvIGhvcGVmdWxseSBhdCBsZWFzdCBvbmUKICAgICAqIGlzIGF2YWlsYXZsZS4gRm9yIGV4YW1wbGUsIGZvciBhIGNhcnJpZXIgdGhhdCBkb2Vzbid0IHR5cGljYWxseSBzZXQgcGhvbmUgbnVtYmVycwogICAgICogb24ge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgVUlDQ30sIHRoZSBzb3VyY2Uge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0lNUyBJTVN9CiAgICAgKiBtYXkgcHJvdmlkZSBvbmUuIE9yLCBhIGNhcnJpZXIgbWF5IGRlY2lkZSB0byBwcm92aWRlIHRoZSBwaG9uZSBudW1iZXIgdmlhIHNvdXJjZQogICAgICoge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIgY2Fycmllcn0gaWYgbmVpdGhlciBzb3VyY2UgVUlDQyBub3IgSU1TIGlzIGF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5UaGUgYXZhaWxhYmlsaXR5IGFuZCBjb3JyZWN0bmVzcyBvZiB0aGUgcGhvbmUgbnVtYmVyIGRlcGVuZHMgb24gdGhlIHVuZGVybHlpbmcgc291cmNlCiAgICAgKiBhbmQgdGhlIG5ldHdvcmsgZXRjLiBBZGRpdGlvbmFsIHZlcmlmaWNhdGlvbiBpcyBuZWVkZWQgdG8gdXNlIHRoaXMgbnVtYmVyIGZvcgogICAgICogc2VjdXJpdHktcmVsYXRlZCBvciBvdGhlciBzZW5zaXRpdmUgc2NlbmFyaW9zLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgc3Vic2NyaXB0aW9uIElELCBvciB7QGxpbmsgI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfQogICAgICogICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZGVmYXVsdCBvbmUuCiAgICAgKiBAcGFyYW0gc291cmNlIHRoZSBzb3VyY2Ugb2YgdGhlIHBob25lIG51bWJlciwgb25lIG9mIHRoZSBQSE9ORV9OVU1CRVJfU09VUkNFXyogY29uc3RhbnRzLgogICAgICogQHJldHVybiB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIHtAY29kZSBzb3VyY2V9IGlzIGludmFsaWQuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgdGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBoYXZlIHBlcm1pc3Npb25zIHJlcXVpcmVkLgogICAgICogQHNlZSAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDCiAgICAgKiBAc2VlICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIKICAgICAqIEBzZWUgI1BIT05FX05VTUJFUl9TT1VSQ0VfSU1TCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW55T2YgPSB7CiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX05VTUJFUlMsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgICJjYXJyaWVyIHByaXZpbGVnZXMiLAogICAgfSkKICAgIEBOb25OdWxsCiAgICBwdWJsaWMgU3RyaW5nIGdldFBob25lTnVtYmVyKGludCBzdWJzY3JpcHRpb25JZCwgQFBob25lTnVtYmVyU291cmNlIGludCBzb3VyY2UpIHsKICAgICAgICBpZiAoc3Vic2NyaXB0aW9uSWQgPT0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQpIHsKICAgICAgICAgICAgc3Vic2NyaXB0aW9uSWQgPSBnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MKICAgICAgICAgICAgICAgICYmIHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX0lNUykgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJpbnZhbGlkIHNvdXJjZSAiICsgc291cmNlKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpU3ViLmdldFBob25lTnVtYmVyKHN1YnNjcmlwdGlvbklkLCBzb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJzdWJzY3JpcHRpb24gc2VydmljZSB1bmF2YWlsYWJsZS4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICB0aHJvdyBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcGhvbmUgbnVtYmVyIGZvciB0aGUgZ2l2ZW4ge0Bjb2RlIHN1YklkfSwgb3IgYW4gZW1wdHkgc3RyaW5nIGlmCiAgICAgKiBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlRoaXMgQVBJIGlzIHN1aXRhYmxlIGZvciBnZW5lcmFsIGFwcHMgdGhhdCBuZWVkcyB0byBrbm93IHRoZSBwaG9uZSBudW1iZXIuCiAgICAgKiBGb3Igc3BlY2lmaWMgYXBwcyB0aGF0IG5lZWRzIHRvIGtub3cgdGhlIHBob25lIG51bWJlciBwcm92aWRlZCBieSBhIHNwZWNpZmljIHNvdXJjZSwKICAgICAqIHtAbGluayAjZ2V0UGhvbmVOdW1iZXIoaW50LCBpbnQpfSBtYXkgYmUgc3VpdGFibGUuCiAgICAgKgogICAgICogPHA+VGhpcyBBUEkgaXMgYnVpbHQgdXAgb24ge0BsaW5rICNnZXRQaG9uZU51bWJlcihpbnQsIGludCl9LCBidXQgcGlja3MKICAgICAqIGZyb20gYXZhaWxhYmxlIHNvdXJjZXMgaW4gdGhlIGZvbGxvd2luZyBvcmRlcjoge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVJ9CiAgICAgKiA+IHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDfSA+IHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVN9LgogICAgICoKICAgICAqIDxwPlRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0IGNhbiB2YXJ5CiAgICAgKiBkZXBlbmRpbmcgb24gdGhlIHVuZGVybHlpbmcgc291cmNlIGFuZCB0aGUgbmV0d29yayBldGMuIFByb2dyYW1tYXRpYyBwYXJzaW5nIHNob3VsZCBiZSBkb25lCiAgICAgKiBjYXV0aW91c2x5LCBmb3IgZXhhbXBsZSwgYWZ0ZXIgZm9ybWF0dGluZyB0aGUgbnVtYmVyIHRvIGEgY29uc2lzdGVudCBmb3JtYXQgd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+VGhlIGF2YWlsYWJpbGl0eSBhbmQgY29ycmVjdG5lc3Mgb2YgdGhlIHBob25lIG51bWJlciBkZXBlbmRzIG9uIHRoZSB1bmRlcmx5aW5nIHNvdXJjZQogICAgICogYW5kIHRoZSBuZXR3b3JrIGV0Yy4gQWRkaXRpb25hbCB2ZXJpZmljYXRpb24gaXMgbmVlZGVkIHRvIHVzZSB0aGlzIG51bWJlciBmb3IKICAgICAqIHNlY3VyaXR5LXJlbGF0ZWQgb3Igb3RoZXIgc2Vuc2l0aXZlIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3Ige0BsaW5rICNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGRlZmF1bHQgb25lLgogICAgICogQHJldHVybiB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIHRoZSB0ZWxlcGhvbnkgcHJvY2VzcyBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbnMgcmVxdWlyZWQuCiAgICAgKiBAc2VlICNnZXRQaG9uZU51bWJlcihpbnQsIGludCkKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgImNhcnJpZXIgcHJpdmlsZWdlcyIsCiAgICB9KQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBTdHJpbmcgZ2V0UGhvbmVOdW1iZXIoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbklkID09IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkID0gZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5nZXRQaG9uZU51bWJlckZyb21GaXJzdEF2YWlsYWJsZVNvdXJjZShzdWJzY3JpcHRpb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInN1YnNjcmlwdGlvbiBzZXJ2aWNlIHVuYXZhaWxhYmxlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHRocm93IGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBwaG9uZSBudW1iZXIgZm9yIHRoZSBnaXZlbiB7QGNvZGUgc3ViSWR9IGZvciBzb3VyY2UKICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSIGNhcnJpZXJ9LgogICAgICogU2V0cyBhbiBlbXB0eSBzdHJpbmcgdG8gcmVtb3ZlIHRoZSBwcmV2aW91c2x5IHNldCBwaG9uZSBudW1iZXIuCiAgICAgKgogICAgICogPHA+VGhlIEFQSSBpcyBzdWl0YWJsZSBmb3IgY2FycmllciBhcHBzIHRvIHByb3ZpZGUgYSBwaG9uZSBudW1iZXIsIGZvciBleGFtcGxlIHdoZW4KICAgICAqIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVwZGF0ZSB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfVUlDQyBVSUNDfSBkaXJlY3RseS4KICAgICAqCiAgICAgKiA8cD5JdCdzIHJlY29tbWVuZGVkIHRoYXQgdGhlIHBob25lIG51bWJlciBpcyBmb3JtYXR0ZWQgdG8gd2VsbC1rbm93biBmb3JtYXRzLAogICAgICogZm9yIGV4YW1wbGUsIGJ5IHtAbGluayBQaG9uZU51bWJlclV0aWxzfSB7QGNvZGUgZm9ybWF0TnVtYmVyKn0gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3Ige0BsaW5rICNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGRlZmF1bHQgb25lLgogICAgICogQHBhcmFtIG51bWJlciB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgdG8gcmVtb3ZlIHRoZSBwcmV2aW91c2x5IHNldCBudW1iZXIuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgdGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIE51bGxQb2ludGVyRXhjZXB0aW9uIGlmIHtAY29kZSBudW1iZXJ9IGlzIHtAY29kZSBudWxsfS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbnMgcmVxdWlyZWQuCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oImNhcnJpZXIgcHJpdmlsZWdlcyIpCiAgICBwdWJsaWMgdm9pZCBzZXRDYXJyaWVyUGhvbmVOdW1iZXIoaW50IHN1YnNjcmlwdGlvbklkLCBATm9uTnVsbCBTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbklkID09IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkID0gZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXIgPT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oImludmFsaWQgbnVtYmVyIG51bGwiKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0UGhvbmVOdW1iZXIoc3Vic2NyaXB0aW9uSWQsIFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiwgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigic3Vic2NyaXB0aW9uIHNlcnZpY2UgdW5hdmFpbGFibGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgdGhyb3cgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgcHJlZmVycmVkIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogVGhlIGNlbGx1bGFyIHVzYWdlIHNldHRpbmcgaXMgYSBzd2l0Y2ggd2hpY2ggY29udHJvbHMgdGhlIG1vZGUgb2Ygb3BlcmF0aW9uIGZvciB0aGUgY2VsbHVsYXIKICAgICAqIHJhZGlvIHRvIGVpdGhlciByZXF1aXJlIG9yIG5vdCByZXF1aXJlIHZvaWNlIHNlcnZpY2UuIEl0IGlzIG5vdCBtYW5hZ2VkIHZpYSBBbmRyb2lk4oCZcwogICAgICogU2V0dGluZ3MuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJJZCBvZiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIHVzYWdlU2V0dGluZyB0aGUgcmVxdWVzdGVkIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgYSBzcGVjaWZpYyBtb2RlIG9yIHNldHRpbmcgdGhlIG1vZGUgaXMgbm90IHN1cHBvcnRlZCBvbiBhCiAgICAgKiBwYXJ0aWN1bGFyIGRldmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBDYXJyaWVyUHJpdmlsZWdlcyBmb3IgdGhlIGdpdmVuIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCB3aWxsIG5vdCBhbGxvdyB0aGUgc2V0dGluZyBvZiBVU0FHRV9TRVRUSU5HX1VOS05PV04uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHZvaWQgc2V0VXNhZ2VTZXR0aW5nKGludCBzdWJzY3JpcHRpb25JZCwgQFVzYWdlU2V0dGluZyBpbnQgdXNhZ2VTZXR0aW5nKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltzZXRVc2FnZVNldHRpbmddKyBzZXR0aW5nOiIgKyB1c2FnZVNldHRpbmcgKyAiIHN1YklkOiIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3Vic2NyaXB0aW9uSWQsICJzZXRVc2FnZVNldHRpbmciLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXRVc2FnZVNldHRpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIHVzYWdlU2V0dGluZywgc3Vic2NyaXB0aW9uSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSkpOwogICAgfQp9Cgo=</text>
      </register>
      <register name="+" type="2">
        <text encoding="base64">ICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLmdldE1TSVNETigpOwo=</text>
      </register>
      <register name="-" type="4">
        <text encoding="base64">d2l0aCBzdGF0dXMgW2BUT1NFTkRgXQ==</text>
      </register>
      <register name="." type="4">
        <text encoding="base64">LyoKICogQ29weXJpZ2h0IChDKSAyMDA4IFRoZSBBbmRyb2lkIE9wZW4gU291cmNlIFByb2plY3QKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBhbmRyb2lkLnRlbGVwaG9ueTsKCmltcG9ydCBzdGF0aWMgYW5kcm9pZC5jb250ZW50LkNvbnRleHQuVEVMRUNPTV9TRVJWSUNFOwppbXBvcnQgc3RhdGljIGFuZHJvaWQucHJvdmlkZXIuVGVsZXBob255LkNhcnJpZXJzLkRQQ19VUkk7CmltcG9ydCBzdGF0aWMgYW5kcm9pZC5wcm92aWRlci5UZWxlcGhvbnkuQ2FycmllcnMuSU5WQUxJRF9BUE5fSUQ7CgppbXBvcnQgc3RhdGljIGNvbS5hbmRyb2lkLmludGVybmFsLnV0aWwuUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGw7CgppbXBvcnQgYW5kcm9pZC5NYW5pZmVzdDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5DYWxsYmFja0V4ZWN1dG9yOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLkludERlZjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5Mb25nRGVmOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLk5vbk51bGw7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uTnVsbGFibGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uUmVxdWlyZXNQZXJtaXNzaW9uOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlNka0NvbnN0YW50OwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlNka0NvbnN0YW50LlNka0NvbnN0YW50VHlwZTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TdXBwcmVzc0F1dG9Eb2M7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uU3VwcHJlc3NMaW50OwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlN5c3RlbUFwaTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TeXN0ZW1TZXJ2aWNlOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlRlc3RBcGk7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uV29ya2VyVGhyZWFkOwppbXBvcnQgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudDsKaW1wb3J0IGFuZHJvaWQuYXBwLnJvbGUuUm9sZU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLmNvbXBhdC5Db21wYXRpYmlsaXR5OwppbXBvcnQgYW5kcm9pZC5jb21wYXQuYW5ub3RhdGlvbi5DaGFuZ2VJZDsKaW1wb3J0IGFuZHJvaWQuY29tcGF0LmFubm90YXRpb24uRW5hYmxlZEFmdGVyOwppbXBvcnQgYW5kcm9pZC5jb21wYXQuYW5ub3RhdGlvbi5VbnN1cHBvcnRlZEFwcFVzYWdlOwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkNvbXBvbmVudE5hbWU7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQuQ29udGV4dDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5JbnRlbnQ7CmltcG9ydCBhbmRyb2lkLmRhdGFiYXNlLkN1cnNvcjsKaW1wb3J0IGFuZHJvaWQubmV0LkNvbm5lY3Rpdml0eU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5Vcmk7CmltcG9ydCBhbmRyb2lkLm9zLkFzeW5jVGFzazsKaW1wb3J0IGFuZHJvaWQub3MuQmluZGVyOwppbXBvcnQgYW5kcm9pZC5vcy5CdWlsZDsKaW1wb3J0IGFuZHJvaWQub3MuQnVuZGxlOwppbXBvcnQgYW5kcm9pZC5vcy5IYW5kbGVyOwppbXBvcnQgYW5kcm9pZC5vcy5JQmluZGVyOwppbXBvcnQgYW5kcm9pZC5vcy5QYXJjZWxGaWxlRGVzY3JpcHRvcjsKaW1wb3J0IGFuZHJvaWQub3MuUGVyc2lzdGFibGVCdW5kbGU7CmltcG9ydCBhbmRyb2lkLm9zLlByb2Nlc3M7CmltcG9ydCBhbmRyb2lkLm9zLlJlbW90ZUV4Y2VwdGlvbjsKaW1wb3J0IGFuZHJvaWQub3MuUmVzdWx0UmVjZWl2ZXI7CmltcG9ydCBhbmRyb2lkLm9zLlN5c3RlbVByb3BlcnRpZXM7CmltcG9ydCBhbmRyb2lkLm9zLldvcmtTb3VyY2U7CmltcG9ydCBhbmRyb2lkLnByb3ZpZGVyLlNldHRpbmdzLlNldHRpbmdOb3RGb3VuZEV4Y2VwdGlvbjsKaW1wb3J0IGFuZHJvaWQuc2VydmljZS5jYXJyaWVyLkNhcnJpZXJJZGVudGlmaWVyOwppbXBvcnQgYW5kcm9pZC5zeXNwcm9wLlRlbGVwaG9ueVByb3BlcnRpZXM7CmltcG9ydCBhbmRyb2lkLnRlbGVjb20uQ2FsbFNjcmVlbmluZ1NlcnZpY2U7CmltcG9ydCBhbmRyb2lkLnRlbGVjb20uSW5DYWxsU2VydmljZTsKaW1wb3J0IGFuZHJvaWQudGVsZWNvbS5QaG9uZUFjY291bnQ7CmltcG9ydCBhbmRyb2lkLnRlbGVjb20uUGhvbmVBY2NvdW50SGFuZGxlOwppbXBvcnQgYW5kcm9pZC50ZWxlY29tLlRlbGVjb21NYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuQW5ub3RhdGlvbi5BcG5UeXBlOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuQW5ub3RhdGlvbi5DYWxsU3RhdGU7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5Bbm5vdGF0aW9uLkNhcnJpZXJQcml2aWxlZ2VTdGF0dXM7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5Bbm5vdGF0aW9uLk5ldHdvcmtUeXBlOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuQW5ub3RhdGlvbi5SYWRpb1Bvd2VyU3RhdGU7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5Bbm5vdGF0aW9uLlNpbUFjdGl2YXRpb25TdGF0ZTsKaW1wb3J0IGFuZHJvaWQudGVsZXBob255LkFubm90YXRpb24uVWljY0FwcFR5cGU7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5DYWxsRm9yd2FyZGluZ0luZm8uQ2FsbEZvcndhcmRpbmdSZWFzb247CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5WaXN1YWxWb2ljZW1haWxTZXJ2aWNlLlZpc3VhbFZvaWNlbWFpbFRhc2s7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5kYXRhLkFwblNldHRpbmc7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5kYXRhLkFwblNldHRpbmcuTXZub1R5cGU7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5lbWVyZ2VuY3kuRW1lcmdlbmN5TnVtYmVyOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuZW1lcmdlbmN5LkVtZXJnZW5jeU51bWJlci5FbWVyZ2VuY3lTZXJ2aWNlQ2F0ZWdvcmllczsKaW1wb3J0IGFuZHJvaWQudGVsZXBob255Lmltcy5JbXNNbVRlbE1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuYWlkbC5JSW1zQ29uZmlnOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLmFpZGwuSUltc01tVGVsRmVhdHVyZTsKaW1wb3J0IGFuZHJvaWQudGVsZXBob255Lmltcy5haWRsLklJbXNSY3NGZWF0dXJlOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLmFpZGwuSUltc1JlZ2lzdHJhdGlvbjsKaW1wb3J0IGFuZHJvaWQudGVsZXBob255Lmltcy5mZWF0dXJlLk1tVGVsRmVhdHVyZTsKaW1wb3J0IGFuZHJvaWQudGVsZXBob255Lmltcy5zdHViLkltc1JlZ2lzdHJhdGlvbkltcGxCYXNlOwppbXBvcnQgYW5kcm9pZC50ZXh0LlRleHRVdGlsczsKaW1wb3J0IGFuZHJvaWQudXRpbC5Mb2c7CmltcG9ydCBhbmRyb2lkLnV0aWwuUGFpcjsKCmltcG9ydCBjb20uYW5kcm9pZC5pbXMuaW50ZXJuYWwuSUltc1NlcnZpY2VGZWF0dXJlQ2FsbGJhY2s7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC5hbm5vdGF0aW9ucy5HdWFyZGVkQnk7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC5hbm5vdGF0aW9ucy5WaXNpYmxlRm9yVGVzdGluZzsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5DZWxsTmV0d29ya1NjYW5SZXN1bHQ7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuSUJvb2xlYW5Db25zdW1lcjsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5JTnVtYmVyVmVyaWZpY2F0aW9uQ2FsbGJhY2s7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuSU9uczsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5JUGhvbmVTdWJJbmZvOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTbXM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuSVN1YjsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5JVGVsZXBob255OwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklVcGRhdGVBdmFpbGFibGVOZXR3b3Jrc0NhbGxiYWNrOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255Lk9wZXJhdG9ySW5mbzsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5QaG9uZUNvbnN0YW50czsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5SSUxDb25zdGFudHM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuU21zQXBwbGljYXRpb247CmltcG9ydCBjb20uYW5kcm9pZC50ZWxlcGhvbnkuUmxvZzsKCmltcG9ydCBqYXZhLmlvLkZpbGVJbnB1dFN0cmVhbTsKaW1wb3J0IGphdmEuaW8uSU9FeGNlcHRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb25Qb2xpY3k7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkNvbGxlY3Rpb25zOwppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9ydCBqYXZhLnV0aWwuTGlzdDsKaW1wb3J0IGphdmEudXRpbC5Mb2NhbGU7CmltcG9ydCBqYXZhLnV0aWwuTWFwOwppbXBvcnQgamF2YS51dGlsLk9iamVjdHM7CmltcG9ydCBqYXZhLnV0aWwuVVVJRDsKaW1wb3J0IGphdmEudXRpbC5jb25jdXJyZW50LkV4ZWN1dG9yOwppbXBvcnQgamF2YS51dGlsLmZ1bmN0aW9uLkNvbnN1bWVyOwppbXBvcnQgamF2YS51dGlsLnJlZ2V4Lk1hdGNoZXI7CmltcG9ydCBqYXZhLnV0aWwucmVnZXguUGF0dGVybjsKCi8qKgogKiBQcm92aWRlcyBhY2Nlc3MgdG8gaW5mb3JtYXRpb24gYWJvdXQgdGhlIHRlbGVwaG9ueSBzZXJ2aWNlcyBvbgogKiB0aGUgZGV2aWNlLiBBcHBsaWNhdGlvbnMgY2FuIHVzZSB0aGUgbWV0aG9kcyBpbiB0aGlzIGNsYXNzIHRvCiAqIGRldGVybWluZSB0ZWxlcGhvbnkgc2VydmljZXMgYW5kIHN0YXRlcywgYXMgd2VsbCBhcyB0byBhY2Nlc3Mgc29tZQogKiB0eXBlcyBvZiBzdWJzY3JpYmVyIGluZm9ybWF0aW9uLiBBcHBsaWNhdGlvbnMgY2FuIGFsc28gcmVnaXN0ZXIKICogYSBsaXN0ZW5lciB0byByZWNlaXZlIG5vdGlmaWNhdGlvbiBvZiB0ZWxlcGhvbnkgc3RhdGUgY2hhbmdlcy4KICogPHA+CiAqIFRoZSByZXR1cm5lZCBUZWxlcGhvbnlNYW5hZ2VyIHdpbGwgdXNlIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbiBmb3IgYWxsIGNhbGxzLgogKiBUbyBjYWxsIGFuIEFQSSBmb3IgYSBzcGVjaWZpYyBzdWJzY3JpcHRpb24sIHVzZSB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkKGludCl9LiBlLmcuCiAqIDxjb2RlPgogKiAgIHRlbGVwaG9ueU1hbmFnZXIgPSBkZWZhdWx0U3ViVGVsZXBob255TWFuYWdlci5jcmVhdGVGb3JTdWJzY3JpcHRpb25JZChzdWJJZCk7CiAqIDwvY29kZT4KICogPHA+CiAqIE5vdGUgdGhhdCBhY2Nlc3MgdG8gc29tZSB0ZWxlcGhvbnkgaW5mb3JtYXRpb24gaXMKICogcGVybWlzc2lvbi1wcm90ZWN0ZWQuIFlvdXIgYXBwbGljYXRpb24gY2Fubm90IGFjY2VzcyB0aGUgcHJvdGVjdGVkCiAqIGluZm9ybWF0aW9uIHVubGVzcyBpdCBoYXMgdGhlIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zIGRlY2xhcmVkIGluCiAqIGl0cyBtYW5pZmVzdCBmaWxlLiBXaGVyZSBwZXJtaXNzaW9ucyBhcHBseSwgdGhleSBhcmUgbm90ZWQgaW4gdGhlCiAqIHRoZSBtZXRob2RzIHRocm91Z2ggd2hpY2ggeW91IGFjY2VzcyB0aGUgcHJvdGVjdGVkIGluZm9ybWF0aW9uLgogKgogKiA8cD5UZWxlcGhvbnlNYW5hZ2VyIGlzIGludGVuZGVkIGZvciB1c2Ugb24gZGV2aWNlcyB0aGF0IGltcGxlbWVudAogKiB7QGxpbmsgYW5kcm9pZC5jb250ZW50LnBtLlBhY2thZ2VNYW5hZ2VyI0ZFQVRVUkVfVEVMRVBIT05ZIEZFQVRVUkVfVEVMRVBIT05ZfS4gT24gZGV2aWNlcwogKiB0aGF0IGRvIG5vdCBpbXBsZW1lbnQgdGhpcyBmZWF0dXJlLCB0aGUgYmVoYXZpb3IgaXMgbm90IHJlbGlhYmxlLgogKi8KQFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU0VSVklDRSkKcHVibGljIGNsYXNzIFRlbGVwaG9ueU1hbmFnZXIgewogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgU3RyaW5nIFRBRyA9ICJUZWxlcGhvbnlNYW5hZ2VyIjsKCiAgICAvKioKICAgICAqIFRvIGV4cGFuZCB0aGUgZXJyb3IgY29kZXMgZm9yIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI3VwZGF0ZUF2YWlsYWJsZU5ldHdvcmtzfSBhbmQKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI3NldFByZWZlcnJlZE9wcG9ydHVuaXN0aWNEYXRhU3Vic2NyaXB0aW9ufS4KICAgICAqLwogICAgQENoYW5nZUlkCiAgICBARW5hYmxlZEFmdGVyKHRhcmdldFNka1ZlcnNpb24gPSBCdWlsZC5WRVJTSU9OX0NPREVTLlEpCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIENBTExCQUNLX09OX01PUkVfRVJST1JfQ09ERV9DSEFOR0UgPSAxMzA1OTU0NTVMOwoKICAgIC8qKgogICAgICogVGhlIGtleSB0byB1c2Ugd2hlbiBwbGFjaW5nIHRoZSByZXN1bHQgb2Yge0BsaW5rICNyZXF1ZXN0TW9kZW1BY3Rpdml0eUluZm8oUmVzdWx0UmVjZWl2ZXIpfQogICAgICogaW50byB0aGUgUmVzdWx0UmVjZWl2ZXIgQnVuZGxlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTU9ERU1fQUNUSVZJVFlfUkVTVUxUX0tFWSA9ICJjb250cm9sbGVyX2FjdGl2aXR5IjsKCiAgICAvKioKICAgICAqIFRoZSBwcm9jZXNzIG5hbWUgb2YgdGhlIFBob25lIGFwcCBhcyB3ZWxsIGFzIG1hbnkgb3RoZXIgYXBwcyB0aGF0IHVzZSB0aGlzIHByb2Nlc3MgbmFtZSwgc3VjaAogICAgICogYXMgc2V0dGluZ3MgYW5kIHZlbmRvciBjb21wb25lbnRzLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgUEhPTkVfUFJPQ0VTU19OQU1FID0gImNvbS5hbmRyb2lkLnBob25lIjsKCiAgICAvKioKICAgICAqIFRoZSBhbGxvd2VkIHN0YXRlcyBvZiBXaS1GaSBjYWxsaW5nLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBpbnRlcmZhY2UgV2lmaUNhbGxpbmdDaG9pY2VzIHsKICAgICAgICAvKiogQWx3YXlzIHVzZSBXaS1GaSBjYWxsaW5nICovCiAgICAgICAgc3RhdGljIGZpbmFsIGludCBBTFdBWVNfVVNFID0gMDsKICAgICAgICAvKiogQXNrIHRoZSB1c2VyIHdoZXRoZXIgdG8gdXNlIFdpLUZpIG9uIGV2ZXJ5IGNhbGwgKi8KICAgICAgICBzdGF0aWMgZmluYWwgaW50IEFTS19FVkVSWV9USU1FID0gMTsKICAgICAgICAvKiogTmV2ZXIgdXNlIFdpLUZpIGNhbGxpbmcgKi8KICAgICAgICBzdGF0aWMgZmluYWwgaW50IE5FVkVSX1VTRSA9IDI7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiTkVUV09SS19TRUxFQ1RJT05fTU9ERV8ifSwKICAgICAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19TRUxFQ1RJT05fTU9ERV9VTktOT1dOLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfU0VMRUNUSU9OX01PREVfQVVUTywKICAgICAgICAgICAgICAgICAgICBORVRXT1JLX1NFTEVDVElPTl9NT0RFX01BTlVBTH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBOZXR3b3JrU2VsZWN0aW9uTW9kZSB7fQoKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfU0VMRUNUSU9OX01PREVfVU5LTk9XTiA9IDA7CiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1NFTEVDVElPTl9NT0RFX0FVVE8gPSAxOwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19TRUxFQ1RJT05fTU9ERV9NQU5VQUwgPSAyOwoKICAgIC8qKiBUaGUgb3Rhc3BNb2RlIHBhc3NlZCB0byBQaG9uZVN0YXRlTGlzdGVuZXIjb25PdGFzcENoYW5nZWQgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgc3RhdGljIHB1YmxpYyBmaW5hbCBpbnQgT1RBU1BfVU5JTklUSUFMSVpFRCA9IDA7CiAgICAvKiogQGhpZGUgKi8KICAgIHN0YXRpYyBwdWJsaWMgZmluYWwgaW50IE9UQVNQX1VOS05PV04gPSAxOwogICAgLyoqIEBoaWRlICovCiAgICBzdGF0aWMgcHVibGljIGZpbmFsIGludCBPVEFTUF9ORUVERUQgPSAyOwogICAgLyoqIEBoaWRlICovCiAgICBzdGF0aWMgcHVibGljIGZpbmFsIGludCBPVEFTUF9OT1RfTkVFREVEID0gMzsKICAgIC8qIE90YVV0aWwgaGFzIGNvbmZsaWN0IGVudW0gNDogT3RhVXRpbHMuT1RBU1BfRkFJTFVSRV9TUENfUkVUUklFUyAqLwogICAgLyoqIEBoaWRlICovCiAgICBzdGF0aWMgcHVibGljIGZpbmFsIGludCBPVEFTUF9TSU1fVU5QUk9WSVNJT05FRCA9IDU7CgogICAgLyoqCiAgICAgKiBVc2VkIGluIGNhcnJpZXIgV2ktRmkgZm9yIElNU0kgKyBJTVBJIGVuY3J5cHRpb24sIHRoaXMgaW5kaWNhdGVzIGEgcHVibGljIGtleSB0aGF0J3MKICAgICAqIGF2YWlsYWJsZSBmb3IgdXNlIGluIGVQREcgbGlua3MuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgc3RhdGljIHB1YmxpYyBmaW5hbCBpbnQgS0VZX1RZUEVfRVBERyA9IDE7CgogICAgLyoqCiAgICAgKiBVc2VkIGluIGNhcnJpZXIgV2ktRmkgZm9yIElNU0kgKyBJTVBJIGVuY3J5cHRpb24sIHRoaXMgaW5kaWNhdGVzIGEgcHVibGljIGtleSB0aGF0J3MKICAgICAqIGF2YWlsYWJsZSBmb3IgdXNlIGluIFdMQU4gbGlua3MuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgc3RhdGljIHB1YmxpYyBmaW5hbCBpbnQgS0VZX1RZUEVfV0xBTiA9IDI7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiS0VZX1RZUEVfIn0sIHZhbHVlID0ge0tFWV9UWVBFX0VQREcsIEtFWV9UWVBFX1dMQU59KQogICAgcHVibGljIEBpbnRlcmZhY2UgS2V5VHlwZSB7fQoKICAgIC8qKgogICAgICogTm8gU2luZ2xlIFJhZGlvIFZvaWNlIENhbGwgQ29udGludWl0eSAoU1JWQ0MpIGhhbmRvdmVyIGlzIGFjdGl2ZS4KICAgICAqIFNlZSBUUyAyMy4yMTYgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTUlZDQ19TVEFURV9IQU5ET1ZFUl9OT05FICA9IC0xOwoKICAgIC8qKgogICAgICogU2luZ2xlIFJhZGlvIFZvaWNlIENhbGwgQ29udGludWl0eSAoU1JWQ0MpIGhhbmRvdmVyIGhhcyBiZWVuIHN0YXJ0ZWQgb24gdGhlIG5ldHdvcmsuCiAgICAgKiBTZWUgVFMgMjMuMjE2IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1JWQ0NfU1RBVEVfSEFORE9WRVJfU1RBUlRFRCAgPSAwOwoKICAgIC8qKgogICAgICogT25nb2luZyBTaW5nbGUgUmFkaW8gVm9pY2UgQ2FsbCBDb250aW51aXR5IChTUlZDQykgaGFuZG92ZXIgaGFzIHN1Y2Nlc3NmdWxseSBjb21wbGV0ZWQuCiAgICAgKiBTZWUgVFMgMjMuMjE2IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1JWQ0NfU1RBVEVfSEFORE9WRVJfQ09NUExFVEVEID0gMTsKCiAgICAvKioKICAgICAqIE9uZ29pbmcgU2luZ2xlIFJhZGlvIFZvaWNlIENhbGwgQ29udGludWl0eSAoU1JWQ0MpIGhhbmRvdmVyIGhhcyBmYWlsZWQuCiAgICAgKiBTZWUgVFMgMjMuMjE2IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1JWQ0NfU1RBVEVfSEFORE9WRVJfRkFJTEVEICAgPSAyOwoKICAgIC8qKgogICAgICogT25nb2luZyBTaW5nbGUgUmFkaW8gVm9pY2UgQ2FsbCBDb250aW51aXR5IChTUlZDQykgaGFuZG92ZXIgaGFzIGJlZW4gY2FuY2VsZWQuCiAgICAgKiBTZWUgVFMgMjMuMjE2IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1JWQ0NfU1RBVEVfSEFORE9WRVJfQ0FOQ0VMRUQgID0gMzsKCiAgICAvKioKICAgICAqIEEgVUlDQyBjYXJkIGlkZW50aWZpZXIgdXNlZCBpZiB0aGUgZGV2aWNlIGRvZXMgbm90IHN1cHBvcnQgdGhlIG9wZXJhdGlvbi4KICAgICAqIEZvciBleGFtcGxlLCB7QGxpbmsgI2dldENhcmRJZEZvckRlZmF1bHRFdWljYygpfSByZXR1cm5zIHRoaXMgdmFsdWUgaWYgdGhlIGRldmljZSBoYXMgbm8KICAgICAqIGVVSUNDLCBvciB0aGUgZVVJQ0MgY2Fubm90IGJlIHJlYWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVOU1VQUE9SVEVEX0NBUkRfSUQgPSAtMTsKCiAgICAvKioKICAgICAqIEEgVUlDQyBjYXJkIGlkZW50aWZpZXIgdXNlZCBiZWZvcmUgdGhlIFVJQ0MgY2FyZCBpcyBsb2FkZWQuIFNlZQogICAgICoge0BsaW5rICNnZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MoKX0gYW5kIHtAbGluayBVaWNjQ2FyZEluZm8jZ2V0Q2FyZElkKCl9LgogICAgICogPHA+CiAgICAgKiBOb3RlIHRoYXQgb25jZSB0aGUgVUlDQyBjYXJkIGlzIGxvYWRlZCwgdGhlIGNhcmQgSUQgbWF5IGJlY29tZSB7QGxpbmsgI1VOU1VQUE9SVEVEX0NBUkRfSUR9LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVTklOSVRJQUxJWkVEX0NBUkRfSUQgPSAtMjsKCiAgICBwcml2YXRlIGZpbmFsIENvbnRleHQgbUNvbnRleHQ7CiAgICBwcml2YXRlIGZpbmFsIGludCBtU3ViSWQ7CiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHJpdmF0ZSBTdWJzY3JpcHRpb25NYW5hZ2VyIG1TdWJzY3JpcHRpb25NYW5hZ2VyOwogICAgcHJpdmF0ZSBUZWxlcGhvbnlTY2FuTWFuYWdlciBtVGVsZXBob255U2Nhbk1hbmFnZXI7CgogICAgLyoqIENhY2hlZCBzZXJ2aWNlIGhhbmRsZXMsIGNsZWFyZWQgYnkgcmVzZXRTZXJ2aWNlSGFuZGxlcygpIGF0IGRlYXRoICovCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBPYmplY3Qgc0NhY2hlTG9jayA9IG5ldyBPYmplY3QoKTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHByaXZhdGUgc3RhdGljIGJvb2xlYW4gc1NlcnZpY2VIYW5kbGVDYWNoZUVuYWJsZWQgPSB0cnVlOwoKICAgIEBHdWFyZGVkQnkoInNDYWNoZUxvY2siKQogICAgcHJpdmF0ZSBzdGF0aWMgSVBob25lU3ViSW5mbyBzSVBob25lU3ViSW5mbzsKICAgIEBHdWFyZGVkQnkoInNDYWNoZUxvY2siKQogICAgcHJpdmF0ZSBzdGF0aWMgSVN1YiBzSVN1YjsKICAgIEBHdWFyZGVkQnkoInNDYWNoZUxvY2siKQogICAgcHJpdmF0ZSBzdGF0aWMgSVNtcyBzSVNtczsKICAgIEBHdWFyZGVkQnkoInNDYWNoZUxvY2siKQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgRGVhdGhSZWNpcGllbnQgc1NlcnZpY2VEZWF0aCA9IG5ldyBEZWF0aFJlY2lwaWVudCgpOwoKICAgIC8qKiBFbnVtIGluZGljYXRpbmcgbXVsdGlzaW0gdmFyaWFudHMKICAgICAqICBEU0RTIC0gRHVhbCBTSU0gRHVhbCBTdGFuZGJ5CiAgICAgKiAgRFNEQSAtIER1YWwgU0lNIER1YWwgQWN0aXZlCiAgICAgKiAgVFNUUyAtIFRyaXBsZSBTSU0gVHJpcGxlIFN0YW5kYnkKICAgICAqKi8KICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UoaW1wbGljaXRNZW1iZXIgPQogICAgICAgICAgICAidmFsdWVzKClbTGFuZHJvaWQvdGVsZXBob255L1RlbGVwaG9ueU1hbmFnZXIkTXVsdGlTaW1WYXJpYW50czsiKQogICAgcHVibGljIGVudW0gTXVsdGlTaW1WYXJpYW50cyB7CiAgICAgICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgICAgICBEU0RTLAogICAgICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICAgICAgRFNEQSwKICAgICAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgICAgIFRTVFMsCiAgICAgICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgICAgICBVTktOT1dOCiAgICB9OwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBUZWxlcGhvbnlNYW5hZ2VyKENvbnRleHQgY29udGV4dCkgewogICAgICB0aGlzKGNvbnRleHQsIFN1YnNjcmlwdGlvbk1hbmFnZXIuREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBUZWxlcGhvbnlNYW5hZ2VyKENvbnRleHQgY29udGV4dCwgaW50IHN1YklkKSB7CiAgICAgICAgbVN1YklkID0gc3ViSWQ7CiAgICAgICAgQ29udGV4dCBhcHBDb250ZXh0ID0gY29udGV4dC5nZXRBcHBsaWNhdGlvbkNvbnRleHQoKTsKICAgICAgICBpZiAoYXBwQ29udGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChPYmplY3RzLmVxdWFscyhjb250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCksIGFwcENvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSkpIHsKICAgICAgICAgICAgICAgIG1Db250ZXh0ID0gYXBwQ29udGV4dDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1Db250ZXh0ID0gYXBwQ29udGV4dC5jcmVhdGVBdHRyaWJ1dGlvbkNvbnRleHQoY29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1Db250ZXh0ID0gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgbVN1YnNjcmlwdGlvbk1hbmFnZXIgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmZyb20obUNvbnRleHQpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHByaXZhdGUgVGVsZXBob255TWFuYWdlcigpIHsKICAgICAgICBtQ29udGV4dCA9IG51bGw7CiAgICAgICAgbVN1YklkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5JTlZBTElEX1NVQlNDUklQVElPTl9JRDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBUZWxlcGhvbnlNYW5hZ2VyIHNJbnN0YW5jZSA9IG5ldyBUZWxlcGhvbnlNYW5hZ2VyKCk7CgogICAgLyoqIEBoaWRlCiAgICAvKiBAZGVwcmVjYXRlZCAtIHVzZSBnZXRTeXN0ZW1TZXJ2aWNlIGFzIGRlc2NyaWJlZCBhYm92ZSAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBzdGF0aWMgVGVsZXBob255TWFuYWdlciBnZXREZWZhdWx0KCkgewogICAgICAgIHJldHVybiBzSW5zdGFuY2U7CiAgICB9CgogICAgcHJpdmF0ZSBTdHJpbmcgZ2V0T3BQYWNrYWdlTmFtZSgpIHsKICAgICAgICAvLyBGb3IgbGVnYWN5IHJlYXNvbnMgdGhlIFRlbGVwaG9ueU1hbmFnZXIgaGFzIEFQSSBmb3IgZ2V0dGluZwogICAgICAgIC8vIGEgc3RhdGljIGluc3RhbmNlIHdpdGggbm8gY29udGV4dCBzZXQgcHJldmVudGluZyB1cyBmcm9tCiAgICAgICAgLy8gZ2V0dGluZyB0aGUgb3AgcGFja2FnZSBuYW1lLiBBcyBhIHdvcmthcm91bmQgd2UgZG8gYSBiZXN0CiAgICAgICAgLy8gZWZmb3J0IGFuZCBnZXQgdGhlIGNvbnRleHQgZnJvbSB0aGUgY3VycmVudCBhY3Rpdml0eSB0aHJlYWQuCiAgICAgICAgaWYgKG1Db250ZXh0ICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q3VycmVudFBhY2thZ2VOYW1lKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIFN0cmluZyBnZXRBdHRyaWJ1dGlvblRhZygpIHsKICAgICAgICAvLyBGb3IgbGVnYWN5IHJlYXNvbnMgdGhlIFRlbGVwaG9ueU1hbmFnZXIgaGFzIEFQSSBmb3IgZ2V0dGluZwogICAgICAgIC8vIGEgc3RhdGljIGluc3RhbmNlIHdpdGggbm8gY29udGV4dCBzZXQgcHJldmVudGluZyB1cyBmcm9tCiAgICAgICAgLy8gZ2V0dGluZyB0aGUgYXR0cmlidXRpb24gdGFnLgogICAgICAgIGlmIChtQ29udGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBwcml2YXRlIGJvb2xlYW4gaXNTeXN0ZW1Qcm9jZXNzKCkgewogICAgICAgIHJldHVybiBQcm9jZXNzLm15VWlkKCkgPT0gUHJvY2Vzcy5TWVNURU1fVUlEOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbXVsdGkgU0lNIHZhcmlhbnQKICAgICAqIFJldHVybnMgRFNEUyBmb3IgRHVhbCBTSU0gRHVhbCBTdGFuZGJ5CiAgICAgKiBSZXR1cm5zIERTREEgZm9yIER1YWwgU0lNIER1YWwgQWN0aXZlCiAgICAgKiBSZXR1cm5zIFRTVFMgZm9yIFRyaXBsZSBTSU0gVHJpcGxlIFN0YW5kYnkKICAgICAqIFJldHVybnMgVU5LTk9XTiBmb3Igb3RoZXJzCiAgICAgKi8KICAgIC8qKiB7QGhpZGV9ICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIE11bHRpU2ltVmFyaWFudHMgZ2V0TXVsdGlTaW1Db25maWd1cmF0aW9uKCkgewogICAgICAgIFN0cmluZyBtU2ltQ29uZmlnID0KICAgICAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMubXVsdGlfc2ltX2NvbmZpZygpLm9yRWxzZSgiIik7CiAgICAgICAgaWYgKG1TaW1Db25maWcuZXF1YWxzKCJkc2RzIikpIHsKICAgICAgICAgICAgcmV0dXJuIE11bHRpU2ltVmFyaWFudHMuRFNEUzsKICAgICAgICB9IGVsc2UgaWYgKG1TaW1Db25maWcuZXF1YWxzKCJkc2RhIikpIHsKICAgICAgICAgICAgcmV0dXJuIE11bHRpU2ltVmFyaWFudHMuRFNEQTsKICAgICAgICB9IGVsc2UgaWYgKG1TaW1Db25maWcuZXF1YWxzKCJ0c3RzIikpIHsKICAgICAgICAgICAgcmV0dXJuIE11bHRpU2ltVmFyaWFudHMuVFNUUzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gTXVsdGlTaW1WYXJpYW50cy5VTktOT1dOOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBwaG9uZXMgYXZhaWxhYmxlLgogICAgICogUmV0dXJucyAwIGlmIG5vbmUgb2Ygdm9pY2UsIHNtcywgZGF0YSBpcyBub3Qgc3VwcG9ydGVkCiAgICAgKiBSZXR1cm5zIDEgZm9yIFNpbmdsZSBzdGFuZGJ5IG1vZGUgKFNpbmdsZSBTSU0gZnVuY3Rpb25hbGl0eSkuCiAgICAgKiBSZXR1cm5zIDIgZm9yIER1YWwgc3RhbmRieSBtb2RlIChEdWFsIFNJTSBmdW5jdGlvbmFsaXR5KS4KICAgICAqIFJldHVybnMgMyBmb3IgVHJpIHN0YW5kYnkgbW9kZSAoVHJpIFNJTSBmdW5jdGlvbmFsaXR5KS4KICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgI2dldEFjdGl2ZU1vZGVtQ291bnR9IGluc3RlYWQuCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgaW50IGdldFBob25lQ291bnQoKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZU1vZGVtQ291bnQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBsb2dpY2FsIG1vZGVtcyBjdXJyZW50bHkgY29uZmlndXJlZCB0byBiZSBhY3RpdmF0ZWQuCiAgICAgKgogICAgICogUmV0dXJucyAwIGlmIG5vbmUgb2Ygdm9pY2UsIHNtcywgZGF0YSBpcyBub3Qgc3VwcG9ydGVkCiAgICAgKiBSZXR1cm5zIDEgZm9yIFNpbmdsZSBzdGFuZGJ5IG1vZGUgKFNpbmdsZSBTSU0gZnVuY3Rpb25hbGl0eSkuCiAgICAgKiBSZXR1cm5zIDIgZm9yIER1YWwgc3RhbmRieSBtb2RlIChEdWFsIFNJTSBmdW5jdGlvbmFsaXR5KS4KICAgICAqIFJldHVybnMgMyBmb3IgVHJpIHN0YW5kYnkgbW9kZSAoVHJpIFNJTSBmdW5jdGlvbmFsaXR5KS4KICAgICAqLwogICAgcHVibGljIGludCBnZXRBY3RpdmVNb2RlbUNvdW50KCkgewogICAgICAgIGludCBtb2RlbUNvdW50ID0gMTsKICAgICAgICBzd2l0Y2ggKGdldE11bHRpU2ltQ29uZmlndXJhdGlvbigpKSB7CiAgICAgICAgICAgIGNhc2UgVU5LTk9XTjoKICAgICAgICAgICAgICAgIG1vZGVtQ291bnQgPSAxOwogICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIHZvaWNlIGFuZCBkYXRhIHN1cHBvcnQsIDAgaWYgbm90IHN1cHBvcnRlZAogICAgICAgICAgICAgICAgaWYgKCFpc1ZvaWNlQ2FwYWJsZSgpICYmICFpc1Ntc0NhcGFibGUoKSAmJiAhaXNEYXRhQ2FwYWJsZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kZW1Db3VudCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEU0RTOgogICAgICAgICAgICBjYXNlIERTREE6CiAgICAgICAgICAgICAgICBtb2RlbUNvdW50ID0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRTVFM6CiAgICAgICAgICAgICAgICBtb2RlbUNvdW50ID0gMzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kZW1Db3VudDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBob3cgbWFueSBsb2dpY2FsIG1vZGVtIGNhbiBiZSBwb3RlbnRpYWxseSBhY3RpdmUgc2ltdWx0YW5lb3VzbHksIGluIHRlcm1zIG9mIGhhcmR3YXJlCiAgICAgKiBjYXBhYmlsaXR5LgogICAgICogSXQgbWlnaHQgcmV0dXJuIGRpZmZlcmVudCB2YWx1ZSBmcm9tIHtAbGluayAjZ2V0QWN0aXZlTW9kZW1Db3VudH0uIEZvciBleGFtcGxlLCBmb3IgYQogICAgICogZHVhbC1TSU0gY2FwYWJsZSBkZXZpY2Ugb3BlcmF0aW5nIGluIHNpbmdsZSBTSU0gbW9kZSAob25seSBvbmUgbG9naWNhbCBtb2RlbSBpcyB0dXJuZWQgb24pLAogICAgICoge0BsaW5rICNnZXRBY3RpdmVNb2RlbUNvdW50fSByZXR1cm5zIDEgd2hpbGUgdGhpcyBBUEkgcmV0dXJucyAyLgogICAgICovCiAgICBwdWJsaWMgaW50IGdldFN1cHBvcnRlZE1vZGVtQ291bnQoKSB7CiAgICAgICAgcmV0dXJuIFRlbGVwaG9ueVByb3BlcnRpZXMubWF4X2FjdGl2ZV9tb2RlbXMoKS5vckVsc2UoZ2V0QWN0aXZlTW9kZW1Db3VudCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIG1heGltdW0gbnVtYmVyIG9mIFNJTXMgdGhhdCBjYW4gYmUgYWN0aXZlLCBiYXNlZCBvbiB0aGUgZGV2aWNlJ3MgbXVsdGlzaW0KICAgICAqIGNvbmZpZ3VyYXRpb24uCiAgICAgKiBAcmV0dXJuIDEgZm9yIHNpbmdsZS1TSU0sIERTRFMsIGFuZCBUU1RTIGRldmljZXMuIDIgZm9yIERTREEgZGV2aWNlcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBpbnQgZ2V0TWF4TnVtYmVyT2ZTaW11bHRhbmVvdXNseUFjdGl2ZVNpbXMoKSB7CiAgICAgICAgc3dpdGNoIChnZXRNdWx0aVNpbUNvbmZpZ3VyYXRpb24oKSkgewogICAgICAgICAgICBjYXNlIFVOS05PV046CiAgICAgICAgICAgIGNhc2UgRFNEUzoKICAgICAgICAgICAgY2FzZSBUU1RTOgogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIGNhc2UgRFNEQToKICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMTsKICAgIH0KCiAgICAvKioge0BoaWRlfSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyBUZWxlcGhvbnlNYW5hZ2VyIGZyb20oQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIChUZWxlcGhvbnlNYW5hZ2VyKSBjb250ZXh0LmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgVGVsZXBob255TWFuYWdlciBvYmplY3QgcGlubmVkIHRvIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24gSUQuCiAgICAgKgogICAgICogQHJldHVybiBhIFRlbGVwaG9ueU1hbmFnZXIgdGhhdCB1c2VzIHRoZSBnaXZlbiBzdWJJZCBmb3IgYWxsIGNhbGxzLgogICAgICovCiAgICBwdWJsaWMgVGVsZXBob255TWFuYWdlciBjcmVhdGVGb3JTdWJzY3JpcHRpb25JZChpbnQgc3ViSWQpIHsKICAgICAgLy8gRG9uJ3QgcmV1c2UgYW55IFRlbGVwaG9ueU1hbmFnZXIgb2JqZWN0cy4KICAgICAgcmV0dXJuIG5ldyBUZWxlcGhvbnlNYW5hZ2VyKG1Db250ZXh0LCBzdWJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgVGVsZXBob255TWFuYWdlciBvYmplY3QgcGlubmVkIHRvIHRoZSBzdWJzY3JpcHRpb24gSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBnaXZlbgogICAgICogcGhvbmUgYWNjb3VudC4KICAgICAqCiAgICAgKiBAcmV0dXJuIGEgVGVsZXBob255TWFuYWdlciB0aGF0IHVzZXMgdGhlIGdpdmVuIHBob25lIGFjY291bnQgZm9yIGFsbCBjYWxscywgb3Ige0Bjb2RlIG51bGx9CiAgICAgKiBpZiB0aGUgcGhvbmUgYWNjb3VudCBkb2VzIG5vdCBjb3JyZXNwb25kIHRvIGEgdmFsaWQgc3Vic2NyaXB0aW9uIElELgogICAgICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBUZWxlcGhvbnlNYW5hZ2VyIGNyZWF0ZUZvclBob25lQWNjb3VudEhhbmRsZShQaG9uZUFjY291bnRIYW5kbGUgcGhvbmVBY2NvdW50SGFuZGxlKSB7CiAgICAgICAgaW50IHN1YklkID0gZ2V0U3Vic2NyaXB0aW9uSWQocGhvbmVBY2NvdW50SGFuZGxlKTsKICAgICAgICBpZiAoIVN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFN1YnNjcmlwdGlvbklkKHN1YklkKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBUZWxlcGhvbnlNYW5hZ2VyKG1Db250ZXh0LCBzdWJJZCk7CiAgICB9CgogICAgLyoqIHtAaGlkZX0gKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBpc011bHRpU2ltRW5hYmxlZCgpIHsKICAgICAgICByZXR1cm4gZ2V0UGhvbmVDb3VudCgpID4gMTsKICAgIH0KCiAgICAvLwogICAgLy8gQnJvYWRjYXN0IEludGVudCBhY3Rpb25zCiAgICAvLwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IGludGVudCBhY3Rpb24gaW5kaWNhdGluZyB0aGF0IHRoZSBjYWxsIHN0YXRlCiAgICAgKiBvbiB0aGUgZGV2aWNlIGhhcyBjaGFuZ2VkLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayAjRVhUUkFfU1RBVEV9IGV4dHJhIGluZGljYXRlcyB0aGUgbmV3IGNhbGwgc3RhdGUuCiAgICAgKiBJZiBhIHJlY2VpdmluZyBhcHAgaGFzIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9DQUxMX0xPR30gcGVybWlzc2lvbiwgYSBzZWNvbmQKICAgICAqIGV4dHJhIHtAbGluayAjRVhUUkFfSU5DT01JTkdfTlVNQkVSfSBwcm92aWRlcyB0aGUgcGhvbmUgbnVtYmVyIGZvciBpbmNvbWluZyBhbmQgb3V0Z29pbmcKICAgICAqIGNhbGxzIGFzIGEgU3RyaW5nLgogICAgICogPHA+CiAgICAgKiBJZiB0aGUgcmVjZWl2aW5nIGFwcCBoYXMKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9DQUxMX0xPR30gYW5kCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24sIGl0IHdpbGwgcmVjZWl2ZSB0aGUKICAgICAqIGJyb2FkY2FzdCB0d2ljZTsgb25lIHdpdGggdGhlIHtAbGluayAjRVhUUkFfSU5DT01JTkdfTlVNQkVSfSBwb3B1bGF0ZWQgd2l0aCB0aGUgcGhvbmUgbnVtYmVyLAogICAgICogYW5kIGFub3RoZXIgd2l0aCBpdCBibGFuay4gIER1ZSB0byB0aGUgbmF0dXJlIG9mIGJyb2FkY2FzdHMsIHlvdSBjYW5ub3QgYXNzdW1lIHRoZSBvcmRlcgogICAgICogaW4gd2hpY2ggdGhlc2UgYnJvYWRjYXN0cyB3aWxsIGFycml2ZSwgaG93ZXZlciB5b3UgYXJlIGd1YXJhbnRlZWQgdG8gcmVjZWl2ZSB0d28gaW4gdGhpcwogICAgICogY2FzZS4gIEFwcHMgd2hpY2ggYXJlIGludGVyZXN0ZWQgaW4gdGhlIHtAbGluayAjRVhUUkFfSU5DT01JTkdfTlVNQkVSfSBjYW4gaWdub3JlIHRoZQogICAgICogYnJvYWRjYXN0cyB3aGVyZSB7QGxpbmsgI0VYVFJBX0lOQ09NSU5HX05VTUJFUn0gaXMgbm90IHByZXNlbnQgaW4gdGhlIGV4dHJhcyAoZS5nLiB3aGVyZQogICAgICoge0BsaW5rIEludGVudCNoYXNFeHRyYShTdHJpbmcpfSByZXR1cm5zIHtAY29kZSBmYWxzZX0pLgogICAgICogPHAgY2xhc3M9Im5vdGUiPgogICAgICogVGhpcyB3YXMgYSB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkNvbnRleHQjc2VuZFN0aWNreUJyb2FkY2FzdCBzdGlja3l9CiAgICAgKiBicm9hZGNhc3QgaW4gdmVyc2lvbiAxLjAsIGJ1dCBpdCBpcyBubyBsb25nZXIgc3RpY2t5LgogICAgICogSW5zdGVhZCwgdXNlIHtAbGluayAjZ2V0Q2FsbFN0YXRlfSB0byBzeW5jaHJvbm91c2x5IHF1ZXJ5IHRoZSBjdXJyZW50IGNhbGwgc3RhdGUuCiAgICAgKgogICAgICogQHNlZSAjRVhUUkFfU1RBVEUKICAgICAqIEBzZWUgI0VYVFJBX0lOQ09NSU5HX05VTUJFUgogICAgICogQHNlZSAjZ2V0Q2FsbFN0YXRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1BIT05FX1NUQVRFX0NIQU5HRUQgPQogICAgICAgICAgICAiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLlBIT05FX1NUQVRFIjsKCiAgICAvKioKICAgICAqIFRoZSBQaG9uZSBhcHAgc2VuZHMgdGhpcyBpbnRlbnQgd2hlbiBhIHVzZXIgb3B0cyB0byByZXNwb25kLXZpYS1tZXNzYWdlIGR1cmluZyBhbiBpbmNvbWluZwogICAgICogY2FsbC4gQnkgZGVmYXVsdCwgdGhlIGRldmljZSdzIGRlZmF1bHQgU01TIGFwcCBjb25zdW1lcyB0aGlzIG1lc3NhZ2UgYW5kIHNlbmRzIGEgdGV4dCBtZXNzYWdlCiAgICAgKiB0byB0aGUgY2FsbGVyLiBBIHRoaXJkIHBhcnR5IGFwcCBjYW4gYWxzbyBwcm92aWRlIHRoaXMgZnVuY3Rpb25hbGl0eSBieSBjb25zdW1pbmcgdGhpcyBJbnRlbnQKICAgICAqIHdpdGggYSB7QGxpbmsgYW5kcm9pZC5hcHAuU2VydmljZX0gYW5kIHNlbmRpbmcgdGhlIG1lc3NhZ2UgdXNpbmcgaXRzIG93biBtZXNzYWdpbmcgc3lzdGVtLgogICAgICogPHA+VGhlIGludGVudCBjb250YWlucyBhIFVSSSAoYXZhaWxhYmxlIGZyb20ge0BsaW5rIGFuZHJvaWQuY29udGVudC5JbnRlbnQjZ2V0RGF0YX0pCiAgICAgKiBkZXNjcmliaW5nIHRoZSByZWNpcGllbnQsIHVzaW5nIGVpdGhlciB0aGUge0Bjb2RlIHNtczp9LCB7QGNvZGUgc21zdG86fSwge0Bjb2RlIG1tczp9LAogICAgICogb3Ige0Bjb2RlIG1tc3RvOn0gVVJJIHNjaGVtYS4gRWFjaCBvZiB0aGVzZSBVUkkgc2NoZW1hIGNhcnJ5IHRoZSByZWNpcGllbnQgaW5mb3JtYXRpb24gdGhlCiAgICAgKiBzYW1lIHdheTogdGhlIHBhdGggcGFydCBvZiB0aGUgVVJJIGNvbnRhaW5zIHRoZSByZWNpcGllbnQncyBwaG9uZSBudW1iZXIgb3IgYSBjb21tYS1zZXBhcmF0ZWQKICAgICAqIHNldCBvZiBwaG9uZSBudW1iZXJzIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSByZWNpcGllbnRzLiBGb3IgZXhhbXBsZSwge0Bjb2RlCiAgICAgKiBzbXN0bzoyMDY1NTUxMjM0fS48L3A+CiAgICAgKgogICAgICogPHA+VGhlIGludGVudCBtYXkgYWxzbyBjb250YWluIGV4dHJhcyBmb3IgdGhlIG1lc3NhZ2UgdGV4dCAoaW4ge0BsaW5rCiAgICAgKiBhbmRyb2lkLmNvbnRlbnQuSW50ZW50I0VYVFJBX1RFWFR9KSBhbmQgYSBtZXNzYWdlIHN1YmplY3QKICAgICAqIChpbiB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkludGVudCNFWFRSQV9TVUJKRUNUfSkuPC9wPgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj48c3Ryb25nPk5vdGU6PC9zdHJvbmc+CiAgICAgKiBUaGUgaW50ZW50LWZpbHRlciB0aGF0IGNvbnN1bWVzIHRoaXMgSW50ZW50IG5lZWRzIHRvIGJlIGluIGEge0BsaW5rIGFuZHJvaWQuYXBwLlNlcnZpY2V9CiAgICAgKiB0aGF0IHJlcXVpcmVzIHRoZQogICAgICogcGVybWlzc2lvbiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1NFTkRfUkVTUE9ORF9WSUFfTUVTU0FHRX0uPC9wPgogICAgICogPHA+Rm9yIGV4YW1wbGUsIHRoZSBzZXJ2aWNlIHRoYXQgcmVjZWl2ZXMgdGhpcyBpbnRlbnQgY2FuIGJlIGRlY2xhcmVkIGluIHRoZSBtYW5pZmVzdCBmaWxlCiAgICAgKiB3aXRoIGFuIGludGVudCBmaWx0ZXIgbGlrZSB0aGlzOjwvcD4KICAgICAqIDxwcmU+CiAgICAgKiAmbHQ7IS0tIFNlcnZpY2UgdGhhdCBkZWxpdmVycyBTTVMgbWVzc2FnZXMgcmVjZWl2ZWQgZnJvbSB0aGUgcGhvbmUgInF1aWNrIHJlc3BvbnNlIiAtLT4KICAgICAqICZsdDtzZXJ2aWNlIGFuZHJvaWQ6bmFtZT0iLkhlYWRsZXNzU21zU2VuZFNlcnZpY2UiCiAgICAgKiAgICAgICAgICBhbmRyb2lkOnBlcm1pc3Npb249ImFuZHJvaWQucGVybWlzc2lvbi5TRU5EX1JFU1BPTkRfVklBX01FU1NBR0UiCiAgICAgKiAgICAgICAgICBhbmRyb2lkOmV4cG9ydGVkPSJ0cnVlIiA+CiAgICAgKiAgICZsdDtpbnRlbnQtZmlsdGVyPgogICAgICogICAgICZsdDthY3Rpb24gYW5kcm9pZDpuYW1lPSJhbmRyb2lkLmludGVudC5hY3Rpb24uUkVTUE9ORF9WSUFfTUVTU0FHRSIgLz4KICAgICAqICAgICAmbHQ7Y2F0ZWdvcnkgYW5kcm9pZDpuYW1lPSJhbmRyb2lkLmludGVudC5jYXRlZ29yeS5ERUZBVUxUIiAvPgogICAgICogICAgICZsdDtkYXRhIGFuZHJvaWQ6c2NoZW1lPSJzbXMiIC8+CiAgICAgKiAgICAgJmx0O2RhdGEgYW5kcm9pZDpzY2hlbWU9InNtc3RvIiAvPgogICAgICogICAgICZsdDtkYXRhIGFuZHJvaWQ6c2NoZW1lPSJtbXMiIC8+CiAgICAgKiAgICAgJmx0O2RhdGEgYW5kcm9pZDpzY2hlbWU9Im1tc3RvIiAvPgogICAgICogICAmbHQ7L2ludGVudC1maWx0ZXI+CiAgICAgKiAmbHQ7L3NlcnZpY2U+PC9wcmU+CiAgICAgKiA8cD4KICAgICAqIE91dHB1dDogbm90aGluZy4KICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5TRVJWSUNFX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9SRVNQT05EX1ZJQV9NRVNTQUdFID0KICAgICAgICAgICAgImFuZHJvaWQuaW50ZW50LmFjdGlvbi5SRVNQT05EX1ZJQV9NRVNTQUdFIjsKCiAgICAvKioKICAgICAqIFRoZSBlbWVyZ2VuY3kgZGlhbGVyIG1heSBjaG9vc2UgdG8gcHJlc2VudCBhY3Rpdml0aWVzIHdpdGggaW50ZW50IGZpbHRlcnMgZm9yIHRoaXMKICAgICAqIGFjdGlvbiBhcyBlbWVyZ2VuY3kgYXNzaXN0YW5jZSBidXR0b25zIHRoYXQgbGF1bmNoIHRoZSBhY3Rpdml0eSB3aGVuIGNsaWNrZWQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5BQ1RJVklUWV9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0VNRVJHRU5DWV9BU1NJU1RBTkNFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5FTUVSR0VOQ1lfQVNTSVNUQU5DRSI7CgogICAgLyoqCiAgICAgKiBBIGJvb2xlYW4gbWV0YS1kYXRhIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciB0aGUgdm9pY2VtYWlsIHNldHRpbmdzIHNob3VsZCBiZSBoaWRkZW4gaW4gdGhlCiAgICAgKiBjYWxsIHNldHRpbmdzIHBhZ2UgbGF1bmNoZWQgYnkKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjQUNUSU9OX1NIT1dfQ0FMTF9TRVRUSU5HU30uCiAgICAgKiBEaWFsZXIgaW1wbGVtZW50YXRpb25zIChzZWUge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5UZWxlY29tTWFuYWdlciNnZXREZWZhdWx0RGlhbGVyUGFja2FnZSgpfSkKICAgICAqIHdoaWNoIHdvdWxkIGFsc28gbGlrZSB0byBtYW5hZ2Ugdm9pY2VtYWlsIHNldHRpbmdzIHNob3VsZCBzZXQgdGhpcyBtZXRhLWRhdGEgdG8ge0Bjb2RlIHRydWV9CiAgICAgKiBpbiB0aGUgbWFuaWZlc3QgcmVnaXN0cmF0aW9uIG9mIHRoZWlyIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIEBzZWUgYW5kcm9pZC50ZWxlY29tLlRlbGVjb21NYW5hZ2VyI0FDVElPTl9TSE9XX0NBTExfU0VUVElOR1MKICAgICAqIEBzZWUgI0FDVElPTl9DT05GSUdVUkVfVk9JQ0VNQUlMCiAgICAgKiBAc2VlICNFWFRSQV9ISURFX1BVQkxJQ19TRVRUSU5HUwogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNRVRBREFUQV9ISURFX1ZPSUNFTUFJTF9TRVRUSU5HU19NRU5VID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LkhJREVfVk9JQ0VNQUlMX1NFVFRJTkdTX01FTlUiOwoKICAgIC8qKgogICAgICogT3BlbiB0aGUgdm9pY2VtYWlsIHNldHRpbmdzIGFjdGl2aXR5IHRvIG1ha2UgY2hhbmdlcyB0byB2b2ljZW1haWwgY29uZmlndXJhdGlvbi4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSB7QGxpbmsgI0VYVFJBX1BIT05FX0FDQ09VTlRfSEFORExFfSBleHRyYSBpbmRpY2F0ZXMgd2hpY2gge0BsaW5rIFBob25lQWNjb3VudEhhbmRsZX0gdG8KICAgICAqIGNvbmZpZ3VyZSB2b2ljZW1haWwuCiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9ISURFX1BVQkxJQ19TRVRUSU5HU30gaGlkZXMgc2V0dGluZ3MgdGhlIGRpYWxlciB3aWxsIG1vZGlmeSB0aHJvdWdoIHB1YmxpYwogICAgICogQVBJIGlmIHNldC4KICAgICAqCiAgICAgKiBAc2VlICNFWFRSQV9QSE9ORV9BQ0NPVU5UX0hBTkRMRQogICAgICogQHNlZSAjRVhUUkFfSElERV9QVUJMSUNfU0VUVElOR1MKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5BQ1RJVklUWV9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NPTkZJR1VSRV9WT0lDRU1BSUwgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLkNPTkZJR1VSRV9WT0lDRU1BSUwiOwoKICAgIC8qKgogICAgICogVGhlIGJvb2xlYW4gdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB2b2ljZW1haWwgc2V0dGluZ3MgYWN0aXZpdHkgbGF1bmNoZWQgYnkge0BsaW5rCiAgICAgKiAjQUNUSU9OX0NPTkZJR1VSRV9WT0lDRU1BSUx9IHNob3VsZCBoaWRlIHNldHRpbmdzIGFjY2Vzc2libGUgdGhyb3VnaCBwdWJsaWMgQVBJLiBUaGlzIGlzCiAgICAgKiB1c2VkIGJ5IGRpYWxlciBpbXBsZW1lbnRhdGlvbnMgd2hpY2ggcHJvdmlkZXMgdGhlaXIgb3duIHZvaWNlbWFpbCBzZXR0aW5ncyBVSSwgYnV0IHN0aWxsCiAgICAgKiBuZWVkcyB0byBleHBvc2UgZGV2aWNlIHNwZWNpZmljIHZvaWNlbWFpbCBzZXR0aW5ncyB0byB0aGUgdXNlci4KICAgICAqCiAgICAgKiBAc2VlICNBQ1RJT05fQ09ORklHVVJFX1ZPSUNFTUFJTAogICAgICogQHNlZSAjTUVUQURBVEFfSElERV9WT0lDRU1BSUxfU0VUVElOR1NfTUVOVQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9ISURFX1BVQkxJQ19TRVRUSU5HUyA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5ISURFX1BVQkxJQ19TRVRUSU5HUyI7CgogICAgLyoqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGJvb2xlYW4gRU1FUkdFTkNZX0FTU0lTVEFOQ0VfRU5BQkxFRCA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGUgbG9va3VwIGtleSB1c2VkIHdpdGggdGhlIHtAbGluayAjQUNUSU9OX1BIT05FX1NUQVRFX0NIQU5HRUR9IGJyb2FkY2FzdAogICAgICogZm9yIGEgU3RyaW5nIGNvbnRhaW5pbmcgdGhlIG5ldyBjYWxsIHN0YXRlLgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj4KICAgICAqIFJldHJpZXZlIHdpdGgKICAgICAqIHtAbGluayBhbmRyb2lkLmNvbnRlbnQuSW50ZW50I2dldFN0cmluZ0V4dHJhKFN0cmluZyl9LgogICAgICoKICAgICAqIEBzZWUgI0VYVFJBX1NUQVRFX0lETEUKICAgICAqIEBzZWUgI0VYVFJBX1NUQVRFX1JJTkdJTkcKICAgICAqIEBzZWUgI0VYVFJBX1NUQVRFX09GRkhPT0sKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfU1RBVEUgPSBQaG9uZUNvbnN0YW50cy5TVEFURV9LRVk7CgogICAgLyoqCiAgICAgKiBWYWx1ZSB1c2VkIHdpdGgge0BsaW5rICNFWFRSQV9TVEFURX0gY29ycmVzcG9uZGluZyB0bwogICAgICoge0BsaW5rICNDQUxMX1NUQVRFX0lETEV9LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TVEFURV9JRExFID0gUGhvbmVDb25zdGFudHMuU3RhdGUuSURMRS50b1N0cmluZygpOwoKICAgIC8qKgogICAgICogVmFsdWUgdXNlZCB3aXRoIHtAbGluayAjRVhUUkFfU1RBVEV9IGNvcnJlc3BvbmRpbmcgdG8KICAgICAqIHtAbGluayAjQ0FMTF9TVEFURV9SSU5HSU5HfS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfU1RBVEVfUklOR0lORyA9IFBob25lQ29uc3RhbnRzLlN0YXRlLlJJTkdJTkcudG9TdHJpbmcoKTsKCiAgICAvKioKICAgICAqIFZhbHVlIHVzZWQgd2l0aCB7QGxpbmsgI0VYVFJBX1NUQVRFfSBjb3JyZXNwb25kaW5nIHRvCiAgICAgKiB7QGxpbmsgI0NBTExfU1RBVEVfT0ZGSE9PS30uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NUQVRFX09GRkhPT0sgPSBQaG9uZUNvbnN0YW50cy5TdGF0ZS5PRkZIT09LLnRvU3RyaW5nKCk7CgogICAgLyoqCiAgICAgKiBFeHRyYSBrZXkgdXNlZCB3aXRoIHRoZSB7QGxpbmsgI0FDVElPTl9QSE9ORV9TVEFURV9DSEFOR0VEfSBicm9hZGNhc3QKICAgICAqIGZvciBhIFN0cmluZyBjb250YWluaW5nIHRoZSBpbmNvbWluZyBvciBvdXRnb2luZyBwaG9uZSBudW1iZXIuCiAgICAgKiA8cD4KICAgICAqIFRoaXMgZXh0cmEgaXMgb25seSBwb3B1bGF0ZWQgZm9yIHJlY2VpdmVycyBvZiB0aGUge0BsaW5rICNBQ1RJT05fUEhPTkVfU1RBVEVfQ0hBTkdFRH0KICAgICAqIGJyb2FkY2FzdCB3aGljaCBoYXZlIGJlZW4gZ3JhbnRlZCB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX0NBTExfTE9HfSBhbmQKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gcGVybWlzc2lvbnMuCiAgICAgKiA8cD4KICAgICAqIEZvciBpbmNvbWluZyBjYWxscywgdGhlIHBob25lIG51bWJlciBpcyBvbmx5IGd1YXJhbnRlZWQgdG8gYmUgcG9wdWxhdGVkIHdoZW4gdGhlCiAgICAgKiB7QGxpbmsgI0VYVFJBX1NUQVRFfSBjaGFuZ2VzIGZyb20ge0BsaW5rICNFWFRSQV9TVEFURV9JRExFfSB0byB7QGxpbmsgI0VYVFJBX1NUQVRFX1JJTkdJTkd9LgogICAgICogSWYgdGhlIGluY29taW5nIGNhbGxlciBpcyBmcm9tIGFuIHVua25vd24gbnVtYmVyLCB0aGUgZXh0cmEgd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhbiBlbXB0eQogICAgICogc3RyaW5nLgogICAgICogRm9yIG91dGdvaW5nIGNhbGxzLCB0aGUgcGhvbmUgbnVtYmVyIGlzIG9ubHkgZ3VhcmFudGVlZCB0byBiZSBwb3B1bGF0ZWQgd2hlbiB0aGUKICAgICAqIHtAbGluayAjRVhUUkFfU1RBVEV9IGNoYW5nZXMgZnJvbSB7QGxpbmsgI0VYVFJBX1NUQVRFX0lETEV9IHRvIHtAbGluayAjRVhUUkFfU1RBVEVfT0ZGSE9PS30uCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+CiAgICAgKiBSZXRyaWV2ZSB3aXRoCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkludGVudCNnZXRTdHJpbmdFeHRyYShTdHJpbmcpfS4KICAgICAqIDxwPgogICAgICoKICAgICAqIEBkZXByZWNhdGVkIENvbXBhbmlvbiBhcHBzIGZvciB3ZWFyYWJsZSBkZXZpY2VzIHNob3VsZCB1c2UgdGhlIHtAbGluayBJbkNhbGxTZXJ2aWNlfSBBUEkKICAgICAqIHRvIHJldHJpZXZlIHRoZSBwaG9uZSBudW1iZXIgZm9yIGNhbGxzIGluc3RlYWQuICBBcHBzIHBlcmZvcm1pbmcgY2FsbCBzY3JlZW5pbmcgc2hvdWxkIHVzZQogICAgICogdGhlIHtAbGluayBDYWxsU2NyZWVuaW5nU2VydmljZX0gQVBJIGluc3RlYWQuCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9JTkNPTUlOR19OVU1CRVIgPSAiaW5jb21pbmdfbnVtYmVyIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBpbnRlbnQgYWN0aW9uIGluZGljYXRpbmcgdGhhdCBjYWxsIGRpc2Nvbm5lY3QgY2F1c2UgaGFzIGNoYW5nZWQuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9ESVNDT05ORUNUX0NBVVNFfSBleHRyYSBpbmRpY2F0ZXMgdGhlIGRpc2Nvbm5lY3QgY2F1c2UuCiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9QUkVDSVNFX0RJU0NPTk5FQ1RfQ0FVU0V9IGV4dHJhIGluZGljYXRlcyB0aGUgcHJlY2lzZSBkaXNjb25uZWN0IGNhdXNlLgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj4KICAgICAqIFJlcXVpcmVzIHRoZSBSRUFEX1BSRUNJU0VfUEhPTkVfU1RBVEUgcGVybWlzc2lvbi4KICAgICAqCiAgICAgKiBAc2VlICNFWFRSQV9ESVNDT05ORUNUX0NBVVNFCiAgICAgKiBAc2VlICNFWFRSQV9QUkVDSVNFX0RJU0NPTk5FQ1RfQ0FVU0UKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NBTExfRElTQ09OTkVDVF9DQVVTRV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQuaW50ZW50LmFjdGlvbi5DQUxMX0RJU0NPTk5FQ1RfQ0FVU0UiOwoKICAgIC8qKgogICAgICogVGhlIGxvb2t1cCBrZXkgdXNlZCB3aXRoIHRoZSB7QGxpbmsgI0FDVElPTl9QUkVDSVNFX0NBTExfU1RBVEVfQ0hBTkdFRH0gYnJvYWRjYXN0IGFuZAogICAgICoge0BsaW5rIFBob25lU3RhdGVMaXN0ZW5lciNvblByZWNpc2VDYWxsU3RhdGVDaGFuZ2VkKFByZWNpc2VDYWxsU3RhdGUpfSBmb3IgYW4gaW50ZWdlcgogICAgICogY29udGFpbmluZyB0aGUgZGlzY29ubmVjdCBjYXVzZS4KICAgICAqCiAgICAgKiBAc2VlIERpc2Nvbm5lY3RDYXVzZQogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj4KICAgICAqIFJldHJpZXZlIHdpdGgKICAgICAqIHtAbGluayBhbmRyb2lkLmNvbnRlbnQuSW50ZW50I2dldEludEV4dHJhKFN0cmluZyBuYW1lLCBpbnQgZGVmYXVsdFZhbHVlKX0uCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgU2hvdWxkIHVzZSB0aGUge0BsaW5rIFRlbGVjb21NYW5hZ2VyI0VYVFJBX0RJU0NPTk5FQ1RfQ0FVU0V9IGluc3RlYWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfRElTQ09OTkVDVF9DQVVTRSA9ICJkaXNjb25uZWN0X2NhdXNlIjsKCiAgICAvKioKICAgICAqIFRoZSBsb29rdXAga2V5IHVzZWQgd2l0aCB0aGUge0BsaW5rICNBQ1RJT05fUFJFQ0lTRV9DQUxMX1NUQVRFX0NIQU5HRUR9IGJyb2FkY2FzdCBhbmQKICAgICAqIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjb25QcmVjaXNlQ2FsbFN0YXRlQ2hhbmdlZChQcmVjaXNlQ2FsbFN0YXRlKX0gZm9yIGFuIGludGVnZXIKICAgICAqIGNvbnRhaW5pbmcgdGhlIGRpc2Nvbm5lY3QgY2F1c2UgcHJvdmlkZWQgYnkgdGhlIFJJTC4KICAgICAqCiAgICAgKiBAc2VlIFByZWNpc2VEaXNjb25uZWN0Q2F1c2UKICAgICAqCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+CiAgICAgKiBSZXRyaWV2ZSB3aXRoCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkludGVudCNnZXRJbnRFeHRyYShTdHJpbmcgbmFtZSwgaW50IGRlZmF1bHRWYWx1ZSl9LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1BSRUNJU0VfRElTQ09OTkVDVF9DQVVTRSA9ICJwcmVjaXNlX2Rpc2Nvbm5lY3RfY2F1c2UiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IGludGVudCBhY3Rpb24gZm9yIGxldHRpbmcgdGhlIGRlZmF1bHQgZGlhbGVyIHRvIGtub3cgdG8gc2hvdyB2b2ljZW1haWwKICAgICAqIG5vdGlmaWNhdGlvbi4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSB7QGxpbmsgI0VYVFJBX1BIT05FX0FDQ09VTlRfSEFORExFfSBleHRyYSBpbmRpY2F0ZXMgd2hpY2gge0BsaW5rIFBob25lQWNjb3VudEhhbmRsZX0gdGhlCiAgICAgKiB2b2ljZW1haWwgaXMgcmVjZWl2ZWQgb24uCiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9OT1RJRklDQVRJT05fQ09VTlR9IGV4dHJhIGluZGljYXRlcyB0aGUgdG90YWwgbnVtYmVycyBvZiB1bmhlYXJkCiAgICAgKiB2b2ljZW1haWxzLgogICAgICogVGhlIHtAbGluayAjRVhUUkFfVk9JQ0VNQUlMX05VTUJFUn0gZXh0cmEgaW5kaWNhdGVzIHRoZSB2b2ljZW1haWwgbnVtYmVyIGlmIGF2YWlsYWJsZS4KICAgICAqIFRoZSB7QGxpbmsgI0VYVFJBX0NBTExfVk9JQ0VNQUlMX0lOVEVOVH0gZXh0cmEgaXMgYSB7QGxpbmsgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudH0gdGhhdAogICAgICogd2lsbCBjYWxsIHRoZSB2b2ljZW1haWwgbnVtYmVyIHdoZW4gc2VudC4gVGhpcyBleHRyYSB3aWxsIGJlIGVtcHR5IGlmIHRoZSB2b2ljZW1haWwgbnVtYmVyCiAgICAgKiBpcyBub3Qgc2V0LCBhbmQge0BsaW5rICNFWFRSQV9MQVVOQ0hfVk9JQ0VNQUlMX1NFVFRJTkdTX0lOVEVOVH0gd2lsbCBiZSBzZXQgaW5zdGVhZC4KICAgICAqIFRoZSB7QGxpbmsgI0VYVFJBX0xBVU5DSF9WT0lDRU1BSUxfU0VUVElOR1NfSU5URU5UfSBleHRyYSBpcyBhCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudH0gdGhhdCB3aWxsIGxhdW5jaCB0aGUgdm9pY2VtYWlsIHNldHRpbmdzLiBUaGlzIGV4dHJhIGlzIG9ubHkKICAgICAqIGF2YWlsYWJsZSB3aGVuIHRoZSB2b2ljZW1haWwgbnVtYmVyIGlzIG5vdCBzZXQuCiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9JU19SRUZSRVNIfSBleHRyYSBpbmRpY2F0ZXMgd2hldGhlciB0aGUgbm90aWZpY2F0aW9uIGlzIGEgcmVmcmVzaCBvciBhIG5ldwogICAgICogbm90aWZpY2F0aW9uLgogICAgICoKICAgICAqIEBzZWUgI0VYVFJBX1BIT05FX0FDQ09VTlRfSEFORExFCiAgICAgKiBAc2VlICNFWFRSQV9OT1RJRklDQVRJT05fQ09VTlQKICAgICAqIEBzZWUgI0VYVFJBX1ZPSUNFTUFJTF9OVU1CRVIKICAgICAqIEBzZWUgI0VYVFJBX0NBTExfVk9JQ0VNQUlMX0lOVEVOVAogICAgICogQHNlZSAjRVhUUkFfTEFVTkNIX1ZPSUNFTUFJTF9TRVRUSU5HU19JTlRFTlQKICAgICAqIEBzZWUgI0VYVFJBX0lTX1JFRlJFU0gKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1NIT1dfVk9JQ0VNQUlMX05PVElGSUNBVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uU0hPV19WT0lDRU1BSUxfTk9USUZJQ0FUSU9OIjsKCiAgICAvKioKICAgICAqIFRoZSBleHRyYSB1c2VkIHdpdGggYW4ge0BsaW5rICNBQ1RJT05fQ09ORklHVVJFX1ZPSUNFTUFJTH0gYW5kCiAgICAgKiB7QGxpbmsgI0FDVElPTl9TSE9XX1ZPSUNFTUFJTF9OT1RJRklDQVRJT059IHtAY29kZSBJbnRlbnR9IHRvIHNwZWNpZnkgdGhlCiAgICAgKiB7QGxpbmsgUGhvbmVBY2NvdW50SGFuZGxlfSB0aGUgY29uZmlndXJhdGlvbiBvciBub3RpZmljYXRpb24gaXMgZm9yLgogICAgICogPHAgY2xhc3M9Im5vdGUiPgogICAgICogUmV0cmlldmUgd2l0aCB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkludGVudCNnZXRQYXJjZWxhYmxlRXh0cmEoU3RyaW5nKX0uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1BIT05FX0FDQ09VTlRfSEFORExFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLlBIT05FX0FDQ09VTlRfSEFORExFIjsKCiAgICAvKioKICAgICAqIFRoZSBudW1iZXIgb2Ygdm9pY2UgbWVzc2FnZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBub3RpZmljYXRpb24uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX05PVElGSUNBVElPTl9DT1VOVCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5OT1RJRklDQVRJT05fQ09VTlQiOwoKICAgIC8qKgogICAgICogVGhlIHZvaWNlbWFpbCBudW1iZXIuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1ZPSUNFTUFJTF9OVU1CRVIgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuVk9JQ0VNQUlMX05VTUJFUiI7CgogICAgLyoqCiAgICAgKiBUaGUgaW50ZW50IHRvIGNhbGwgdm9pY2VtYWlsLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9DQUxMX1ZPSUNFTUFJTF9JTlRFTlQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuQ0FMTF9WT0lDRU1BSUxfSU5URU5UIjsKCiAgICAvKioKICAgICAqIFRoZSBpbnRlbnQgdG8gbGF1bmNoIHZvaWNlbWFpbCBzZXR0aW5ncy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfTEFVTkNIX1ZPSUNFTUFJTF9TRVRUSU5HU19JTlRFTlQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuTEFVTkNIX1ZPSUNFTUFJTF9TRVRUSU5HU19JTlRFTlQiOwoKICAgIC8qKgogICAgICogQm9vbGVhbiB2YWx1ZSByZXByZXNlbnRpbmcgd2hldGhlciB0aGUge0BsaW5rCiAgICAgKiBUZWxlcGhvbnlNYW5hZ2VyI0FDVElPTl9TSE9XX1ZPSUNFTUFJTF9OT1RJRklDQVRJT059IGlzIG5ldyBvciBhIHJlZnJlc2ggb2YgYW4gZXhpc3RpbmcKICAgICAqIG5vdGlmaWNhdGlvbi4gTm90aWZpY2F0aW9uIHJlZnJlc2ggaGFwcGVucyBhZnRlciByZWJvb3Qgb3IgY29ubmVjdGl2aXR5IGNoYW5nZXMuIFRoZSB1c2VyIGhhcwogICAgICogYWxyZWFkeSBiZWVuIG5vdGlmaWVkIGZvciB0aGUgdm9pY2VtYWlsIHNvIGl0IHNob3VsZCBub3QgYWxlcnQgdGhlIHVzZXIsIGFuZCBzaG91bGQgbm90IGJlCiAgICAgKiBzaG93biBhZ2FpbiBpZiB0aGUgdXNlciBoYXMgZGlzbWlzc2VkIGl0LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9JU19SRUZSRVNIID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLklTX1JFRlJFU0giOwoKICAgIC8qKgogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9ufSBldmVudCB1c2VkIHRvIGluZGljYXRlIHRoYXQgYW4gSU1TIGNhbGwgaGFzIGJlCiAgICAgKiBzdWNjZXNzZnVsbHkgaGFuZGVkIG92ZXIgZnJvbSBXSUZJIHRvIExURS4KICAgICAqIDxwPgogICAgICogU2VudCB2aWEge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uI3NlbmRDb25uZWN0aW9uRXZlbnQoU3RyaW5nLCBCdW5kbGUpfS4KICAgICAqIFRoZSB7QGxpbmsgQnVuZGxlfSBwYXJhbWV0ZXIgaXMgZXhwZWN0ZWQgdG8gYmUgbnVsbCB3aGVuIHRoaXMgY29ubmVjdGlvbiBldmVudCBpcyB1c2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVZFTlRfSEFORE9WRVJfVklERU9fRlJPTV9XSUZJX1RPX0xURSA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5ldmVudC5FVkVOVF9IQU5ET1ZFUl9WSURFT19GUk9NX1dJRklfVE9fTFRFIjsKCiAgICAvKioKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbn0gZXZlbnQgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IGFuIElNUyBjYWxsIGhhcyBiZQogICAgICogc3VjY2Vzc2Z1bGx5IGhhbmRlZCBvdmVyIGZyb20gTFRFIHRvIFdJRkkuCiAgICAgKiA8cD4KICAgICAqIFNlbnQgdmlhIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbiNzZW5kQ29ubmVjdGlvbkV2ZW50KFN0cmluZywgQnVuZGxlKX0uCiAgICAgKiBUaGUge0BsaW5rIEJ1bmRsZX0gcGFyYW1ldGVyIGlzIGV4cGVjdGVkIHRvIGJlIG51bGwgd2hlbiB0aGlzIGNvbm5lY3Rpb24gZXZlbnQgaXMgdXNlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVWRU5UX0hBTkRPVkVSX1ZJREVPX0ZST01fTFRFX1RPX1dJRkkgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXZlbnQuRVZFTlRfSEFORE9WRVJfVklERU9fRlJPTV9MVEVfVE9fV0lGSSI7CgogICAgLyoqCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlY29tLkNvbm5lY3Rpb259IGV2ZW50IHVzZWQgdG8gaW5kaWNhdGUgdGhhdCBhbiBJTVMgY2FsbCBmYWlsZWQgdG8gYmUKICAgICAqIGhhbmRlZCBvdmVyIGZyb20gTFRFIHRvIFdJRkkuCiAgICAgKiA8cD4KICAgICAqIFNlbnQgdmlhIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbiNzZW5kQ29ubmVjdGlvbkV2ZW50KFN0cmluZywgQnVuZGxlKX0uCiAgICAgKiBUaGUge0BsaW5rIEJ1bmRsZX0gcGFyYW1ldGVyIGlzIGV4cGVjdGVkIHRvIGJlIG51bGwgd2hlbiB0aGlzIGNvbm5lY3Rpb24gZXZlbnQgaXMgdXNlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVWRU5UX0hBTkRPVkVSX1RPX1dJRklfRkFJTEVEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV2ZW50LkVWRU5UX0hBTkRPVkVSX1RPX1dJRklfRkFJTEVEIjsKCiAgICAvKioKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbn0gZXZlbnQgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IGEgdmlkZW8gY2FsbCB3YXMgZG93bmdyYWRlZCB0bwogICAgICogYXVkaW8gYmVjYXVzZSB0aGUgZGF0YSBsaW1pdCB3YXMgcmVhY2hlZC4KICAgICAqIDxwPgogICAgICogU2VudCB2aWEge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uI3NlbmRDb25uZWN0aW9uRXZlbnQoU3RyaW5nLCBCdW5kbGUpfS4KICAgICAqIFRoZSB7QGxpbmsgQnVuZGxlfSBwYXJhbWV0ZXIgaXMgZXhwZWN0ZWQgdG8gYmUgbnVsbCB3aGVuIHRoaXMgY29ubmVjdGlvbiBldmVudCBpcyB1c2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVZFTlRfRE9XTkdSQURFX0RBVEFfTElNSVRfUkVBQ0hFRCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5ldmVudC5FVkVOVF9ET1dOR1JBREVfREFUQV9MSU1JVF9SRUFDSEVEIjsKCiAgICAvKioKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbn0gZXZlbnQgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IGEgdmlkZW8gY2FsbCB3YXMgZG93bmdyYWRlZCB0bwogICAgICogYXVkaW8gYmVjYXVzZSB0aGUgZGF0YSB3YXMgZGlzYWJsZWQuCiAgICAgKiA8cD4KICAgICAqIFNlbnQgdmlhIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbiNzZW5kQ29ubmVjdGlvbkV2ZW50KFN0cmluZywgQnVuZGxlKX0uCiAgICAgKiBUaGUge0BsaW5rIEJ1bmRsZX0gcGFyYW1ldGVyIGlzIGV4cGVjdGVkIHRvIGJlIG51bGwgd2hlbiB0aGlzIGNvbm5lY3Rpb24gZXZlbnQgaXMgdXNlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVWRU5UX0RPV05HUkFERV9EQVRBX0RJU0FCTEVEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV2ZW50LkVWRU5UX0RPV05HUkFERV9EQVRBX0RJU0FCTEVEIjsKCiAgICAvKioKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvbn0gZXZlbnQgdXNlZCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBJbkNhbGwgVUkgc2hvdWxkIG5vdGlmeQogICAgICogdGhlIHVzZXIgd2hlbiBhbiBpbnRlcm5hdGlvbmFsIGNhbGwgaXMgcGxhY2VkIHdoaWxlIG9uIFdGQyBvbmx5LgogICAgICogPHA+CiAgICAgKiBVc2VkIHdoZW4gdGhlIGNhcnJpZXIgY29uZmlnIHZhbHVlCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX05PVElGWV9JTlRFUk5BVElPTkFMX0NBTExfT05fV0ZDX0JPT0x9IGlzIHRydWUsIHRoZSBkZXZpY2UKICAgICAqIGlzIG9uIFdGQyAoVm9MVEUgbm90IGF2YWlsYWJsZSkgYW5kIGFuIGludGVybmF0aW9uYWwgbnVtYmVyIGlzIGRpYWxlZC4KICAgICAqIDxwPgogICAgICogU2VudCB2aWEge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uI3NlbmRDb25uZWN0aW9uRXZlbnQoU3RyaW5nLCBCdW5kbGUpfS4KICAgICAqIFRoZSB7QGxpbmsgQnVuZGxlfSBwYXJhbWV0ZXIgaXMgZXhwZWN0ZWQgdG8gYmUgbnVsbCB3aGVuIHRoaXMgY29ubmVjdGlvbiBldmVudCBpcyB1c2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVZFTlRfTk9USUZZX0lOVEVSTkFUSU9OQUxfQ0FMTF9PTl9XRkMgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXZlbnQuRVZFTlRfTk9USUZZX0lOVEVSTkFUSU9OQUxfQ0FMTF9PTl9XRkMiOwoKICAgIC8qKgogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9ufSBldmVudCB1c2VkIHRvIGluZGljYXRlIHRoYXQgYW4gb3V0Z29pbmcgY2FsbCBoYXMgYmVlbgogICAgICogZm9yd2FyZGVkIHRvIGFub3RoZXIgbnVtYmVyLgogICAgICogPHA+CiAgICAgKiBTZW50IGluIHJlc3BvbnNlIHRvIGFuIElNUyBzdXBwbGVtZW50YXJ5IHNlcnZpY2Ugbm90aWZpY2F0aW9uIGluZGljYXRpbmcgdGhlIGNhbGwgaGFzIGJlZW4KICAgICAqIGZvcndhcmRlZC4KICAgICAqIDxwPgogICAgICogU2VudCB2aWEge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uI3NlbmRDb25uZWN0aW9uRXZlbnQoU3RyaW5nLCBCdW5kbGUpfS4KICAgICAqIFRoZSB7QGxpbmsgQnVuZGxlfSBwYXJhbWV0ZXIgaXMgZXhwZWN0ZWQgdG8gYmUgbnVsbCB3aGVuIHRoaXMgY29ubmVjdGlvbiBldmVudCBpcyB1c2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVZFTlRfQ0FMTF9GT1JXQVJERUQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXZlbnQuRVZFTlRfQ0FMTF9GT1JXQVJERUQiOwoKICAgIC8qKgogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9ufSBldmVudCB1c2VkIHRvIGluZGljYXRlIHRoYXQgYSBzdXBwbGVtZW50YXJ5IHNlcnZpY2UKICAgICAqIG5vdGlmaWNhdGlvbiBoYXMgYmVlbiByZWNlaXZlZC4KICAgICAqIDxwPgogICAgICogU2VudCB2aWEge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uI3NlbmRDb25uZWN0aW9uRXZlbnQoU3RyaW5nLCBCdW5kbGUpfS4KICAgICAqIFRoZSB7QGxpbmsgQnVuZGxlfSBwYXJhbWV0ZXIgaXMgZXhwZWN0ZWQgdG8gaW5jbHVkZSB0aGUgZm9sbG93aW5nIGV4dHJhczoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+e0BsaW5rICNFWFRSQV9OT1RJRklDQVRJT05fVFlQRX0gLSB0aGUgbm90aWZpY2F0aW9uIHR5cGUuPC9saT4KICAgICAqICAgICA8bGk+e0BsaW5rICNFWFRSQV9OT1RJRklDQVRJT05fQ09ERX0gLSB0aGUgbm90aWZpY2F0aW9uIGNvZGUuPC9saT4KICAgICAqICAgICA8bGk+e0BsaW5rICNFWFRSQV9OT1RJRklDQVRJT05fTUVTU0FHRX0gLSBodW1hbi1yZWFkYWJsZSBtZXNzYWdlIGFzc29jaWF0ZWQgd2l0aCB0aGUKICAgICAqICAgICBzdXBwbGVtZW50YXJ5IHNlcnZpY2Ugbm90aWZpY2F0aW9uLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVZFTlRfU1VQUExFTUVOVEFSWV9TRVJWSUNFX05PVElGSUNBVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5ldmVudC5FVkVOVF9TVVBQTEVNRU5UQVJZX1NFUlZJQ0VfTk9USUZJQ0FUSU9OIjsKCiAgICAvKioKICAgICAqIEludGVnZXIgZXh0cmEga2V5IHVzZWQgd2l0aCB7QGxpbmsgI0VWRU5UX1NVUFBMRU1FTlRBUllfU0VSVklDRV9OT1RJRklDQVRJT059IHdoaWNoIGluZGljYXRlcwogICAgICogdGhlIHR5cGUgb2Ygc3VwcGxlbWVudGFyeSBzZXJ2aWNlIG5vdGlmaWNhdGlvbiB3aGljaCBvY2N1cnJlZC4KICAgICAqIFdpbGwgYmUgZWl0aGVyCiAgICAgKiB7QGxpbmsgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LmdzbS5TdXBwU2VydmljZU5vdGlmaWNhdGlvbiNOT1RJRklDQVRJT05fVFlQRV9DT0RFXzF9CiAgICAgKiBvcgogICAgICoge0BsaW5rIGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5nc20uU3VwcFNlcnZpY2VOb3RpZmljYXRpb24jTk9USUZJQ0FUSU9OX1RZUEVfQ09ERV8yfQogICAgICogPHA+CiAgICAgKiBTZXQgaW4gdGhlIGV4dHJhcyBmb3IgdGhlIHtAbGluayAjRVZFTlRfU1VQUExFTUVOVEFSWV9TRVJWSUNFX05PVElGSUNBVElPTn0gY29ubmVjdGlvbiBldmVudC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX05PVElGSUNBVElPTl9UWVBFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLk5PVElGSUNBVElPTl9UWVBFIjsKCiAgICAvKioKICAgICAqIEludGVnZXIgZXh0cmEga2V5IHVzZWQgd2l0aCB7QGxpbmsgI0VWRU5UX1NVUFBMRU1FTlRBUllfU0VSVklDRV9OT1RJRklDQVRJT059IHdoaWNoIGluZGljYXRlcwogICAgICogdGhlIHN1cHBsZW1lbnRhcnkgc2VydmljZSBub3RpZmljYXRpb24gd2hpY2ggb2NjdXJyZWQuCiAgICAgKiA8cD4KICAgICAqIERlcGVuZGluZyBvbiB0aGUge0BsaW5rICNFWFRSQV9OT1RJRklDQVRJT05fVFlQRX0sIHRoZSBjb2RlIHdpbGwgYmUgb25lIG9mIHRoZSB7QGNvZGUgQ09ERV8qfQogICAgICogY29kZXMgZGVmaW5lZCBpbiB7QGxpbmsgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LmdzbS5TdXBwU2VydmljZU5vdGlmaWNhdGlvbn0uCiAgICAgKiA8cD4KICAgICAqIFNldCBpbiB0aGUgZXh0cmFzIGZvciB0aGUge0BsaW5rICNFVkVOVF9TVVBQTEVNRU5UQVJZX1NFUlZJQ0VfTk9USUZJQ0FUSU9OfSBjb25uZWN0aW9uIGV2ZW50LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfTk9USUZJQ0FUSU9OX0NPREUgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuTk9USUZJQ0FUSU9OX0NPREUiOwoKICAgIC8qKgogICAgICoge0BsaW5rIENoYXJTZXF1ZW5jZX0gZXh0cmEga2V5IHVzZWQgd2l0aCB7QGxpbmsgI0VWRU5UX1NVUFBMRU1FTlRBUllfU0VSVklDRV9OT1RJRklDQVRJT059CiAgICAgKiB3aGljaCBjb250YWlucyBhIGh1bWFuLXJlYWRhYmxlIG1lc3NhZ2Ugd2hpY2ggY2FuIGJlIGRpc3BsYXllZCB0byB0aGUgdXNlciBmb3IgdGhlCiAgICAgKiBzdXBwbGVtZW50YXJ5IHNlcnZpY2Ugbm90aWZpY2F0aW9uLgogICAgICogPHA+CiAgICAgKiBTZXQgaW4gdGhlIGV4dHJhcyBmb3IgdGhlIHtAbGluayAjRVZFTlRfU1VQUExFTUVOVEFSWV9TRVJWSUNFX05PVElGSUNBVElPTn0gY29ubmVjdGlvbiBldmVudC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX05PVElGSUNBVElPTl9NRVNTQUdFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLk5PVElGSUNBVElPTl9NRVNTQUdFIjsKCiAgICAvKiBWaXN1YWwgdm9pY2VtYWlsIHByb3RvY29scyAqLwoKICAgIC8qKgogICAgICogVGhlIE9NVFAgcHJvdG9jb2wuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFZWTV9UWVBFX09NVFAgPSAidnZtX3R5cGVfb210cCI7CgogICAgLyoqCiAgICAgKiBBIGZsYXZvciBvZiBPTVRQIHByb3RvY29sIHdpdGggYSBkaWZmZXJlbnQgbW9iaWxlIG9yaWdpbmF0ZWQgKE1PKSBmb3JtYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVlZNX1RZUEVfQ1ZWTSA9ICJ2dm1fdHlwZV9jdnZtIjsKCiAgICAvKioKICAgICAqIEtleSBpbiBidW5kbGUgcmV0dXJuZWQgYnkge0BsaW5rICNnZXRWaXN1YWxWb2ljZW1haWxQYWNrYWdlTmFtZSgpfSwgaW5kaWNhdGluZyB3aGV0aGVyIHZpc3VhbAogICAgICogdm9pY2VtYWlsIHdhcyBlbmFibGVkIG9yIGRpc2FibGVkIGJ5IHRoZSB1c2VyLiBJZiB0aGUgdXNlciBuZXZlciBleHBsaWNpdGx5IGNoYW5nZWQgdGhpcwogICAgICogc2V0dGluZywgdGhpcyBrZXkgd2lsbCBub3QgZXhpc3QuCiAgICAgKgogICAgICogQHNlZSAjZ2V0VmlzdWFsVm9pY2VtYWlsU2V0dGluZ3MoKQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfVklTVUFMX1ZPSUNFTUFJTF9FTkFCTEVEX0JZX1VTRVJfQk9PTCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5WSVNVQUxfVk9JQ0VNQUlMX0VOQUJMRURfQllfVVNFUl9CT09MIjsKCiAgICAvKioKICAgICAqIEtleSBpbiBidW5kbGUgcmV0dXJuZWQgYnkge0BsaW5rICNnZXRWaXN1YWxWb2ljZW1haWxQYWNrYWdlTmFtZSgpfSwgaW5kaWNhdGluZyB0aGUgdm9pY2VtYWlsCiAgICAgKiBhY2Nlc3MgUElOIHNjcmFtYmxlZCBkdXJpbmcgdGhlIGF1dG8gcHJvdmlzaW9uaW5nIHByb2Nlc3MuIFRoZSB1c2VyIGlzIGV4cGVjdGVkIHRvIHJlc2V0CiAgICAgKiB0aGVpciBQSU4gaWYgdGhpcyB2YWx1ZSBpcyBub3Qge0Bjb2RlIG51bGx9LgogICAgICoKICAgICAqIEBzZWUgI2dldFZpc3VhbFZvaWNlbWFpbFNldHRpbmdzKCkKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1ZPSUNFTUFJTF9TQ1JBTUJMRURfUElOX1NUUklORyA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5WT0lDRU1BSUxfU0NSQU1CTEVEX1BJTl9TVFJJTkciOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IGFjdGlvbiB0byBiZSByZWNlaXZlZCBieSBCcm9hZGNhc3QgcmVjZWl2ZXJzLgogICAgICoKICAgICAqIEluZGljYXRlcyBtdWx0aS1TSU0gY29uZmlndXJhdGlvbiBpcyBjaGFuZ2VkLiBGb3IgZXhhbXBsZSwgaXQgY2hhbmdlZAogICAgICogZnJvbSBzaW5nbGUgU0lNIGNhcGFibGUgdG8gZHVhbC1TSU0gY2FwYWJsZSAoRFNEUyBvciBEU0RBKSBvciB0cmlwbGUtU0lNIG1vZGUuCiAgICAgKgogICAgICogSXQgZG9lc24ndCBpbmRpY2F0ZSBob3cgbWFueSBzdWJzY3JpcHRpb25zIGFyZSBhY3R1YWxseSBhY3RpdmUsIG9yIHdoaWNoIHN0YXRlcyBTSU1zIGFyZSwKICAgICAqIG9yIHRoYXQgYWxsIHN0ZXBzIGR1cmluZyBtdWx0aS1TSU0gY2hhbmdlIGFyZSBkb25lLiBUbyBrbm93IHRob3NlIGluZm9ybWF0aW9uIHlvdSBzdGlsbCBuZWVkCiAgICAgKiB0byBsaXN0ZW4gdG8gU0lNX1NUQVRFIGNoYW5nZXMgb3IgYWN0aXZlIHN1YnNjcmlwdGlvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFNlZSBleHRyYSBvZiB7QGxpbmsgI0VYVFJBX0FDVElWRV9TSU1fU1VQUE9SVEVEX0NPVU5UfSBmb3IgdXBkYXRlZCB2YWx1ZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX01VTFRJX1NJTV9DT05GSUdfQ0hBTkdFRCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uTVVMVElfU0lNX0NPTkZJR19DSEFOR0VEIjsKCgogICAgLyoqCiAgICAgKiBUaGUgbnVtYmVyIG9mIGFjdGl2ZSBTSU0gc3VwcG9ydGVkIGJ5IGN1cnJlbnQgbXVsdGktU0lNIGNvbmZpZy4gSXQncyBub3QgcmVsYXRlZCB0byBob3cgbWFueQogICAgICogU0lNL3N1YnNjcmlwdGlvbnMgYXJlIGN1cnJlbnRseSBhY3RpdmUuCiAgICAgKgogICAgICogU2FtZSB2YWx1ZSB3aWxsIGJlIHJldHVybmVkIGJ5IHtAbGluayAjZ2V0QWN0aXZlTW9kZW1Db3VudCgpfS4KICAgICAqCiAgICAgKiBGb3Igc2luZ2xlIFNJTSBtb2RlLCBpdCdzIDEuCiAgICAgKiBGb3IgRFNEUyBvciBEU0RBIG1vZGUsIGl0J3MgMi4KICAgICAqIEZvciB0cmlwbGUtU0lNIG1vZGUsIGl0J3MgMy4KICAgICAqCiAgICAgKiBFeHRyYSBvZiB7QGxpbmsgI0FDVElPTl9NVUxUSV9TSU1fQ09ORklHX0NIQU5HRUR9LgogICAgICoKICAgICAqIHR5cGU6IGludGVnZXIKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfQUNUSVZFX1NJTV9TVVBQT1JURURfQ09VTlQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuQUNUSVZFX1NJTV9TVVBQT1JURURfQ09VTlQiOwoKICAgIC8qKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVVNTRF9SRVNQT05TRSA9ICJVU1NEX1JFU1BPTlNFIjsKCiAgICAvKioKICAgICAqIFVTU0QgcmV0dXJuIGNvZGUgc3VjY2Vzcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTU0RfUkVUVVJOX1NVQ0NFU1MgPSAxMDA7CgogICAgLyoqCiAgICAgKiBGYWlsZWQgY29kZSByZXR1cm5lZCB3aGVuIHRoZSBtb2JpbGUgbmV0d29yayBoYXMgZmFpbGVkIHRvIGNvbXBsZXRlIGEgVVNTRCByZXF1ZXN0LgogICAgICogPHA+CiAgICAgKiBSZXR1cm5lZCB2aWEge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIuVXNzZFJlc3BvbnNlQ2FsbGJhY2sjb25SZWNlaXZlVXNzZFJlc3BvbnNlRmFpbGVkKAogICAgICogVGVsZXBob255TWFuYWdlciwgU3RyaW5nLCBpbnQpfS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVNTRF9SRVRVUk5fRkFJTFVSRSA9IC0xOwoKICAgIC8qKgogICAgICogRmFpbHVyZSBjb2RlIHJldHVybmVkIHdoZW4gYSBVU1NEIHJlcXVlc3QgaGFzIGZhaWxlZCB0byBleGVjdXRlIGJlY2F1c2UgdGhlIFRlbGVwaG9ueQogICAgICogc2VydmljZSBpcyB1bmF2YWlsYWJsZS4KICAgICAqIDxwPgogICAgICogUmV0dXJuZWQgdmlhIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyLlVzc2RSZXNwb25zZUNhbGxiYWNrI29uUmVjZWl2ZVVzc2RSZXNwb25zZUZhaWxlZCgKICAgICAqIFRlbGVwaG9ueU1hbmFnZXIsIFN0cmluZywgaW50KX0uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTU0RfRVJST1JfU0VSVklDRV9VTkFWQUlMID0gLTI7CgogICAgLyoqCiAgICAgKiBWYWx1ZSBmb3Ige0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DRE1BX1JPQU1JTkdfTU9ERV9JTlR9IHdoaWNoIGxlYXZlcyB0aGUgcm9hbWluZwogICAgICogbW9kZSBzZXQgdG8gdGhlIHJhZGlvIGRlZmF1bHQgb3IgdG8gdGhlIHVzZXIncyBwcmVmZXJlbmNlIGlmIHRoZXkndmUgaW5kaWNhdGVkIG9uZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0RNQV9ST0FNSU5HX01PREVfUkFESU9fREVGQVVMVCA9IC0xOwogICAgLyoqCiAgICAgKiBWYWx1ZSBmb3Ige0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DRE1BX1JPQU1JTkdfTU9ERV9JTlR9IHdoaWNoIG9ubHkgcGVybWl0cwogICAgICogY29ubmVjdGlvbnMgb24gaG9tZSBuZXR3b3Jrcy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0RNQV9ST0FNSU5HX01PREVfSE9NRSA9IDA7CiAgICAvKioKICAgICAqIFZhbHVlIGZvciB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NETUFfUk9BTUlOR19NT0RFX0lOVH0gd2hpY2ggcGVybWl0cyByb2FtaW5nIG9uCiAgICAgKiBhZmZpbGlhdGVkIG5ldHdvcmtzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDRE1BX1JPQU1JTkdfTU9ERV9BRkZJTElBVEVEID0gMTsKICAgIC8qKgogICAgICogVmFsdWUgZm9yIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ0RNQV9ST0FNSU5HX01PREVfSU5UfSB3aGljaCBwZXJtaXRzIHJvYW1pbmcgb24KICAgICAqIGFueSBuZXR3b3JrLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDRE1BX1JPQU1JTkdfTU9ERV9BTlkgPSAyOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQEludERlZihwcmVmaXggPSB7ICJDRE1BX1JPQU1JTkdfTU9ERV8iIH0sIHZhbHVlID0gewogICAgICAgICAgICBDRE1BX1JPQU1JTkdfTU9ERV9SQURJT19ERUZBVUxULAogICAgICAgICAgICBDRE1BX1JPQU1JTkdfTU9ERV9IT01FLAogICAgICAgICAgICBDRE1BX1JPQU1JTkdfTU9ERV9BRkZJTElBVEVELAogICAgICAgICAgICBDRE1BX1JPQU1JTkdfTU9ERV9BTlkKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBDZG1hUm9hbWluZ01vZGV7fQoKICAgIC8qKgogICAgICogQW4gdW5rbm93biBjYXJyaWVyIGlkLiBJdCBjb3VsZCBlaXRoZXIgYmUgc3Vic2NyaXB0aW9uIHVuYXZhaWxhYmxlIG9yIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIGNhcnJpZXIgY2Fubm90IGJlIHJlY29nbml6ZWQuIFVucmVjb2duaXplZCBjYXJyaWVycyBoZXJlIG1lYW5zCiAgICAgKiB7QGxpbmsgI2dldFNpbU9wZXJhdG9yKCkgTUNDK01OQ30gY2Fubm90IGJlIGlkZW50aWZpZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVOS05PV05fQ0FSUklFUl9JRCA9IC0xOwoKICAgIC8qKgogICAgICogQW4gdW5rbm93biBjYXJyaWVyIGlkIGxpc3QgdmVyc2lvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVTktOT1dOX0NBUlJJRVJfSURfTElTVF9WRVJTSU9OID0gLTE7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgc3Vic2NyaXB0aW9uIGNhcnJpZXIgaWRlbnRpdHkgaGFzIGNoYW5nZWQuCiAgICAgKiBUaGlzIGludGVudCBjb3VsZCBiZSBzZW50IG9uIHRoZSBmb2xsb3dpbmcgZXZlbnRzOgogICAgICogPHVsPgogICAgICogICA8bGk+U3Vic2NyaXB0aW9uIGFic2VudC4gQ2FycmllciBpZGVudGl0eSBjb3VsZCBjaGFuZ2UgZnJvbSBhIHZhbGlkIGlkIHRvCiAgICAgKiAgIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI1VOS05PV05fQ0FSUklFUl9JRH0uPC9saT4KICAgICAqICAgPGxpPlN1YnNjcmlwdGlvbiBsb2FkZWQuIENhcnJpZXIgaWRlbnRpdHkgY291bGQgY2hhbmdlIGZyb20KICAgICAqICAge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjVU5LTk9XTl9DQVJSSUVSX0lEfSB0byBhIHZhbGlkIGlkLjwvbGk+CiAgICAgKiAgIDxsaT5UaGUgc3Vic2NyaXB0aW9uIGNhcnJpZXIgaXMgcmVjb2duaXplZCBhZnRlciBhIHJlbW90ZSB1cGRhdGUuPC9saT4KICAgICAqIDwvdWw+CiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczoKICAgICAqIDx1bD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfQ0FSUklFUl9JRH0gVGhlIHVwLXRvLWRhdGUgY2FycmllciBpZCBvZiB0aGUgY3VycmVudCBzdWJzY3JpcHRpb24gaWQuCiAgICAgKiAgIDwvbGk+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0NBUlJJRVJfTkFNRX0gVGhlIHVwLXRvLWRhdGUgY2FycmllciBuYW1lIG9mIHRoZSBjdXJyZW50IHN1YnNjcmlwdGlvbi4KICAgICAqICAgPC9saT4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lEfSBUaGUgc3Vic2NyaXB0aW9uIGlkIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2hhbmdlZCBjYXJyaWVyCiAgICAgKiAgIGlkZW50aXR5LgogICAgICogICA8L2xpPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4KICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TVUJTQ1JJUFRJT05fQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TVUJTQ1JJUFRJT05fQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEFuIGludCBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0gd2hpY2ggaW5kaWNhdGVzCiAgICAgKiB0aGUgdXBkYXRlZCBjYXJyaWVyIGlkIHJldHVybmVkIGJ5IHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2dldFNpbUNhcnJpZXJJZCgpfS4KICAgICAqIDxwPldpbGwgYmUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjVU5LTk9XTl9DQVJSSUVSX0lEfSBpZiB0aGUgc3Vic2NyaXB0aW9uIGlzIHVuYXZhaWxhYmxlIG9yCiAgICAgKiB0aGUgY2FycmllciBjYW5ub3QgYmUgaWRlbnRpZmllZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfQ0FSUklFUl9JRCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5DQVJSSUVSX0lEIjsKCiAgICAvKioKICAgICAqIEFuIHN0cmluZyBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0gd2hpY2gKICAgICAqIGluZGljYXRlcyB0aGUgdXBkYXRlZCBjYXJyaWVyIG5hbWUgb2YgdGhlIGN1cnJlbnQgc3Vic2NyaXB0aW9uLgogICAgICogQHNlZSBUZWxlcGhvbnlNYW5hZ2VyI2dldFNpbUNhcnJpZXJJZE5hbWUoKQogICAgICogPHA+Q2FycmllciBuYW1lIGlzIGEgdXNlci1mYWNpbmcgbmFtZSBvZiB0aGUgY2FycmllciBpZCB7QGxpbmsgI0VYVFJBX0NBUlJJRVJfSUR9LAogICAgICogdXN1YWxseSB0aGUgYnJhbmQgbmFtZSBvZiB0aGUgc3Vic2lkaWFyeSAoZS5nLiBULU1vYmlsZSkuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX0NBUlJJRVJfTkFNRSA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5DQVJSSUVSX05BTUUiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogVGhlIHN1YnNjcmlwdGlvbiBzcGVjaWZpYyBjYXJyaWVyIGlkZW50aXR5IGhhcyBjaGFuZ2VkLgogICAgICoKICAgICAqIEEgc3BlY2lmaWMgY2FycmllciBJRCByZXR1cm5zIHRoZSBmaW5lLWdyYWluZWQgY2FycmllciBJRCBvZiB0aGUgY3VycmVudCBzdWJzY3JpcHRpb24uCiAgICAgKiBJdCBjYW4gcmVwcmVzZW50IHRoZSBmYWN0IHRoYXQgYSBjYXJyaWVyIG1heSBiZSBpbiBlZmZlY3QgYW4gYWdncmVnYXRpb24gb2Ygb3RoZXIgY2FycmllcnMKICAgICAqIChpZSBpbiBhbiBNVk5PIHR5cGUgc2NlbmFyaW8pIHdoZXJlIGVhY2ggb2YgdGhlc2Ugc3BlY2lmaWMgY2FycmllcnMgd2hpY2ggYXJlIHVzZWQgdG8gbWFrZQogICAgICogdXAgdGhlIGFjdHVhbCBjYXJyaWVyIHNlcnZpY2UgbWF5IGhhdmUgZGlmZmVyZW50IGNhcnJpZXIgY29uZmlndXJhdGlvbnMuCiAgICAgKiBBIHNwZWNpZmljIGNhcnJpZXIgSUQgY291bGQgYWxzbyBiZSB1c2VkLCBmb3IgZXhhbXBsZSwgaW4gYSBzY2VuYXJpbyB3aGVyZSBhIGNhcnJpZXIgcmVxdWlyZXMKICAgICAqIGRpZmZlcmVudCBjYXJyaWVyIGNvbmZpZ3VyYXRpb24gZm9yIGRpZmZlcmVudCBzZXJ2aWNlIG9mZmVyaW5nIHN1Y2ggYXMgYSBwcmVwYWlkIHBsYW4uCiAgICAgKgogICAgICogdGhlIHNwZWNpZmljIGNhcnJpZXIgSUQgd291bGQgYmUgdXNlZCBmb3IgY29uZmlndXJhdGlvbiBwdXJwb3NlcywgYnV0IGFwcHMgd2lzaGluZyB0byBrbm93CiAgICAgKiBhYm91dCB0aGUgY2FycmllciBpdHNlbGYgc2hvdWxkIHVzZSB0aGUgcmVndWxhciBjYXJyaWVyIElEIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZCgpfS4KICAgICAqCiAgICAgKiA8cD5TaW1pbGFyIGxpa2Uge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0sIHRoaXMgaW50ZW50IHdpbGwgYmUKICAgICAqIHNlbnQgb24gdGhlIGV2ZW50IG9mIHtAbGluayAjQUNUSU9OX1NVQlNDUklQVElPTl9DQVJSSUVSX0lERU5USVRZX0NIQU5HRUR9IHdoaWxlIGl0cyBhbHNvCiAgICAgKiBwb3NzaWJsZSB0byBiZSBzZW50IHdpdGhvdXQge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0gd2hlbgogICAgICogc3BlY2lmaWMgY2FycmllciBJRCBjaGFuZ2VzIHdoaWxlIGNhcnJpZXIgSUQgcmVtYWlucyB0aGUgc2FtZS4KICAgICAqIGUuZywgdGhlIHNhbWUgc3Vic2NyaXB0aW9uIHN3aXRjaGVzIHRvIGRpZmZlcmVudCBJTVNJIGNvdWxkIHBvdGVudGlhbGx5IGNoYW5nZSBpdHMKICAgICAqIHNwZWNpZmljIGNhcnJpZXIgSUQgd2hpbGUgY2FycmllciBpZCByZW1haW5zIHRoZSBzYW1lLgogICAgICogQHNlZSAjZ2V0U2ltU3BlY2lmaWNDYXJyaWVySWQoKQogICAgICogQHNlZSAjZ2V0U2ltQ2FycmllcklkKCkKICAgICAqCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczoKICAgICAqIDx1bD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfU1BFQ0lGSUNfQ0FSUklFUl9JRH0gVGhlIHVwLXRvLWRhdGUgc3BlY2lmaWMgY2FycmllciBpZCBvZiB0aGUKICAgICAqICAgY3VycmVudCBzdWJzY3JpcHRpb24uCiAgICAgKiAgIDwvbGk+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX1NQRUNJRklDX0NBUlJJRVJfTkFNRX0gVGhlIHVwLXRvLWRhdGUgbmFtZSBvZiB0aGUgc3BlY2lmaWMgY2FycmllciBpZC4KICAgICAqICAgPC9saT4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lEfSBUaGUgc3Vic2NyaXB0aW9uIGlkIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2hhbmdlZCBjYXJyaWVyCiAgICAgKiAgIGlkZW50aXR5LgogICAgICogICA8L2xpPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4KICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TVUJTQ1JJUFRJT05fU1BFQ0lGSUNfQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TVUJTQ1JJUFRJT05fU1BFQ0lGSUNfQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEFuIGludCBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX1NQRUNJRklDX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0gd2hpY2gKICAgICAqIGluZGljYXRlcyB0aGUgdXBkYXRlZCBzcGVjaWZpYyBjYXJyaWVyIGlkIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNnZXRTaW1TcGVjaWZpY0NhcnJpZXJJZCgpfS4gTm90ZSwgaXRzIHBvc3NpYmxlIHNwZWNpZmljIGNhcnJpZXIgaWQKICAgICAqIGNoYW5nZXMgd2hpbGUge0BsaW5rICNBQ1RJT05fU1VCU0NSSVBUSU9OX0NBUlJJRVJfSURFTlRJVFlfQ0hBTkdFRH0gcmVtYWlucyB0aGUgc2FtZQogICAgICogZS5nLCB3aGVuIHN1YnNjcmlwdGlvbiBzd2l0Y2ggdG8gZGlmZmVyZW50IElNU0lzLgogICAgICogPHA+V2lsbCBiZSB7QGxpbmsgVGVsZXBob255TWFuYWdlciNVTktOT1dOX0NBUlJJRVJfSUR9IGlmIHRoZSBzdWJzY3JpcHRpb24gaXMgdW5hdmFpbGFibGUgb3IKICAgICAqIHRoZSBjYXJyaWVyIGNhbm5vdCBiZSBpZGVudGlmaWVkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TUEVDSUZJQ19DQVJSSUVSX0lEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNQRUNJRklDX0NBUlJJRVJfSUQiOwoKICAgIC8qKgogICAgICogQW4gc3RyaW5nIGV4dHJhIHVzZWQgd2l0aCB7QGxpbmsgI0FDVElPTl9TVUJTQ1JJUFRJT05fU1BFQ0lGSUNfQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEfQogICAgICogd2hpY2ggaW5kaWNhdGVzIHRoZSB1cGRhdGVkIHNwZWNpZmljIGNhcnJpZXIgbmFtZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0U2ltU3BlY2lmaWNDYXJyaWVySWROYW1lKCl9LgogICAgICogPHA+aXQncyBhIHVzZXItZmFjaW5nIG5hbWUgb2YgdGhlIHNwZWNpZmljIGNhcnJpZXIgaWQge0BsaW5rICNFWFRSQV9TUEVDSUZJQ19DQVJSSUVSX0lEfQogICAgICogZS5nLCBUcmFjZm9uZS1BVCZUCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NQRUNJRklDX0NBUlJJRVJfTkFNRSA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TUEVDSUZJQ19DQVJSSUVSX05BTUUiOwoKICAgIC8qKgogICAgICogQW4gaW50IGV4dHJhIHVzZWQgd2l0aCB7QGxpbmsgI0FDVElPTl9TVUJTQ1JJUFRJT05fQ0FSUklFUl9JREVOVElUWV9DSEFOR0VEfSB0byBpbmRpY2F0ZSB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3aGljaCBoYXMgY2hhbmdlZDsgb3IgaW4gZ2VuZXJhbCB3aGVuZXZlciBhIHN1YnNjcmlwdGlvbiBJRCBuZWVkcyBzcGVjaWZpZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NVQlNDUklQVElPTl9JRCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TVUJTQ1JJUFRJT05fSUQiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogVGhlIFNlcnZpY2UgUHJvdmlkZXIgc3RyaW5nKHMpIGhhdmUgYmVlbiB1cGRhdGVkLiBBY3Rpdml0aWVzIG9yCiAgICAgKiBzZXJ2aWNlcyB0aGF0IHVzZSB0aGVzZSBzdHJpbmdzIHNob3VsZCB1cGRhdGUgdGhlaXIgZGlzcGxheS4KICAgICAqCiAgICAgKiA8cD5UaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczoKICAgICAqIDxkbD4KICAgICAqICAgPGR0PntAbGluayAjRVhUUkFfU0hPV19QTE1OfTwvZHQ+CiAgICAgKiAgIDxkZD5Cb29sZWFuIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgdGhlIFBMTU4gc2hvdWxkIGJlIHNob3duLjwvZGQ+CiAgICAgKiAgIDxkdD57QGxpbmsgI0VYVFJBX1BMTU59PC9kdD4KICAgICAqICAgPGRkPlRoZSBvcGVyYXRvciBuYW1lIG9mIHRoZSByZWdpc3RlcmVkIG5ldHdvcmssIGFzIGEgc3RyaW5nLjwvZGQ+CiAgICAgKiAgIDxkdD57QGxpbmsgI0VYVFJBX1NIT1dfU1BOfTwvZHQ+CiAgICAgKiAgIDxkZD5Cb29sZWFuIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgdGhlIFNQTiBzaG91bGQgYmUgc2hvd24uPC9kZD4KICAgICAqICAgPGR0PntAbGluayAjRVhUUkFfU1BOfTwvZHQ+CiAgICAgKiAgIDxkZD5UaGUgc2VydmljZSBwcm92aWRlciBuYW1lLCBhcyBhIHN0cmluZy48L2RkPgogICAgICogICA8ZHQ+e0BsaW5rICNFWFRSQV9EQVRBX1NQTn08L2R0PgogICAgICogICA8ZGQ+VGhlIHNlcnZpY2UgcHJvdmlkZXIgbmFtZSBmb3IgZGF0YSBzZXJ2aWNlLCBhcyBhIHN0cmluZy48L2RkPgogICAgICogPC9kbD4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQge0BsaW5rICNFWFRSQV9TSE9XX1BMTU59IG1heSBpbmRpY2F0ZSB0aGF0IHtAbGluayAjRVhUUkFfUExNTn0gc2hvdWxkIGJlIGRpc3BsYXllZCwKICAgICAqIGV2ZW4gdGhvdWdoIHRoZSB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9QTE1OfSBpcyBudWxsLiBUaGlzIGNhbiBoYXBwZW4sIGZvciBleGFtcGxlLCBpZiB0aGUKICAgICAqIHBob25lIGhhcyBub3QgcmVnaXN0ZXJlZCB0byBhIG5ldHdvcmsgeWV0LiBJbiB0aGlzIGNhc2UgdGhlIHJlY2VpdmVyIG1heSBzdWJzdGl0dXRlIGFuCiAgICAgKiBhcHByb3ByaWF0ZSBwbGFjZWhvbGRlciBzdHJpbmcgKGVnLCAiTm8gc2VydmljZSIpLgogICAgICoKICAgICAqIEl0IGlzIHJlY29tbWVuZGVkIHRvIGRpc3BsYXkge0BsaW5rICNFWFRSQV9QTE1OfSBiZWZvcmUgLyBhYm92ZSB7QGxpbmsgI0VYVFJBX1NQTn0gaWYKICAgICAqIGJvdGggYXJlIGRpc3BsYXllZC4KICAgICAqCiAgICAgKiA8cD5Ob3RlOiB0aGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fU0VSVklDRV9QUk9WSURFUlNfVVBEQVRFRCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uU0VSVklDRV9QUk9WSURFUlNfVVBEQVRFRCI7CgogICAgLyoqCiAgICAgKiBTdHJpbmcgaW50ZW50IGV4dHJhIHRvIGJlIHVzZWQgd2l0aCB7QGxpbmsgQUNUSU9OX1NFUlZJQ0VfUFJPVklERVJTX1VQREFURUR9IHRvIGluZGljYXRlCiAgICAgKiB3aGV0aGVyIHRoZSBQTE1OIHNob3VsZCBiZSBzaG93bi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NIT1dfUExNTiA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TSE9XX1BMTU4iOwoKICAgIC8qKgogICAgICogU3RyaW5nIGludGVudCBleHRyYSB0byBiZSB1c2VkIHdpdGgge0BsaW5rIEFDVElPTl9TRVJWSUNFX1BST1ZJREVSU19VUERBVEVEfSB0byBpbmRpY2F0ZQogICAgICogdGhlIG9wZXJhdG9yIG5hbWUgb2YgdGhlIHJlZ2lzdGVyZWQgbmV0d29yay4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1BMTU4gPSAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuUExNTiI7CgogICAgLyoqCiAgICAgKiBTdHJpbmcgaW50ZW50IGV4dHJhIHRvIGJlIHVzZWQgd2l0aCB7QGxpbmsgQUNUSU9OX1NFUlZJQ0VfUFJPVklERVJTX1VQREFURUR9IHRvIGluZGljYXRlCiAgICAgKiB3aGV0aGVyIHRoZSBQTE1OIHNob3VsZCBiZSBzaG93bi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NIT1dfU1BOID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNIT1dfU1BOIjsKCiAgICAvKioKICAgICAqIFN0cmluZyBpbnRlbnQgZXh0cmEgdG8gYmUgdXNlZCB3aXRoIHtAbGluayBBQ1RJT05fU0VSVklDRV9QUk9WSURFUlNfVVBEQVRFRH0gdG8gaW5kaWNhdGUKICAgICAqIHRoZSBzZXJ2aWNlIHByb3ZpZGVyIG5hbWUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TUE4gPSAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuU1BOIjsKCiAgICAvKioKICAgICAqIFN0cmluZyBpbnRlbnQgZXh0cmEgdG8gYmUgdXNlZCB3aXRoIHtAbGluayBBQ1RJT05fU0VSVklDRV9QUk9WSURFUlNfVVBEQVRFRH0gdG8gaW5kaWNhdGUKICAgICAqIHRoZSBzZXJ2aWNlIHByb3ZpZGVyIG5hbWUgZm9yIGRhdGEgc2VydmljZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX0RBVEFfU1BOID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLkRBVEFfU1BOIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBpbnRlbnQgYWN0aW9uIGluZGljYXRpbmcgdGhhdCB3aGVuIGRhdGEgc3RhbGwgcmVjb3ZlcnkgaXMgYXR0ZW1wdGVkIGJ5IFRlbGVwaG9ueSwKICAgICAqIGludGVuZGVkIGZvciByZXBvcnQgZXZlcnkgZGF0YSBzdGFsbCByZWNvdmVyeSBzdGVwIGF0dGVtcHRlZC4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSB7QGxpbmsgI0VYVFJBX1JFQ09WRVJZX0FDVElPTn0gZXh0cmEgaW5kaWNhdGVzIHRoZSBhY3Rpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBkYXRhCiAgICAgKiBzdGFsbCByZWNvdmVyeS4KICAgICAqIFRoZSBwaG9uZSBpZCB3aGVyZSB0aGUgZGF0YSBzdGFsbCByZWNvdmVyeSBpcyBhdHRlbXB0ZWQuCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPgogICAgICogUmVxdWlyZXMgdGhlIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbi4KICAgICAqCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+CiAgICAgKiBUaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4KICAgICAqCiAgICAgKiBAc2VlICNFWFRSQV9SRUNPVkVSWV9BQ1RJT04KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICAvLyBUT0RPKGIvNzgzNzAwMzApIDogUmVzdHJpY3QgdGhpcyB0byBzeXN0ZW0gYXBwbGljYXRpb25zIG9ubHkKICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0RBVEFfU1RBTExfREVURUNURUQgPQogICAgICAgICAgICAiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLkRBVEFfU1RBTExfREVURUNURUQiOwoKICAgIC8qKgogICAgICogQSBzZXJ2aWNlIGFjdGlvbiB0aGF0IGlkZW50aWZpZXMKICAgICAqIGEge0BsaW5rIGFuZHJvaWQuc2VydmljZS5jYXJyaWVyLkNhcnJpZXJNZXNzYWdpbmdDbGllbnRTZXJ2aWNlfSBzdWJjbGFzcyBpbiB0aGUKICAgICAqIEFuZHJvaWRNYW5pZmVzdC54bWwuCiAgICAgKgogICAgICogPHA+U2VlIHtAbGluayBhbmRyb2lkLnNlcnZpY2UuY2Fycmllci5DYXJyaWVyTWVzc2FnaW5nQ2xpZW50U2VydmljZX0gZm9yIHRoZSBkZXRhaWxzLgogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLlNFUlZJQ0VfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NBUlJJRVJfTUVTU0FHSU5HX0NMSUVOVF9TRVJWSUNFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5DQVJSSUVSX01FU1NBR0lOR19DTElFTlRfU0VSVklDRSI7CgogICAgLyoqCiAgICAgKiBBbiBpbnQgZXh0cmEgdXNlZCB3aXRoIHtAbGluayAjQUNUSU9OX0RBVEFfU1RBTExfREVURUNURUR9IHRvIGluZGljYXRlIHRoZQogICAgICogYWN0aW9uIGFzc29jaWF0ZWQgd2l0aCB0aGUgZGF0YSBzdGFsbCByZWNvdmVyeS4KICAgICAqCiAgICAgKiBAc2VlICNBQ1RJT05fREFUQV9TVEFMTF9ERVRFQ1RFRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1JFQ09WRVJZX0FDVElPTiA9ICJyZWNvdmVyeUFjdGlvbiI7CgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBNQVhfTlVNQkVSX1ZFUklGSUNBVElPTl9USU1FT1VUX01JTExJUyA9IDYwMDAwOwoKICAgIC8qKgogICAgICogSW50ZW50IHNlbnQgd2hlbiBhbiBlcnJvciBvY2N1cnMgdGhhdCBkZWJ1ZyB0b29scyBzaG91bGQgbG9nIGFuZCBwb3NzaWJseSB0YWtlIGZ1cnRoZXIKICAgICAqIGFjdGlvbiBzdWNoIGFzIGNhcHR1cmluZyB2ZW5kb3Itc3BlY2lmaWMgbG9ncy4KICAgICAqCiAgICAgKiBBIHByaXZpbGVnZWQgYXBwbGljYXRpb24gdGhhdCByZWFkcyB0aGVzZSBldmVudHMgc2hvdWxkIHRha2UgYXBwcm9wcmlhdGUgdmVuZG9yLXNwZWNpZmljCiAgICAgKiBhY3Rpb24gdG8gcmVjb3JkIHRoZSBldmVudCBhbmQgY29sbGVjdCBmdXJ0aGVyIGluZm9ybWF0aW9uIHRvIGFzc2lzdCBpbiBhbmFseXNpcywgZGVidWdnaW5nLAogICAgICogYW5kIHJlc29sdXRpb24gb2YgYW55IGFzc29jaWF0ZWQgaXNzdWUuCiAgICAgKgogICAgICogPHA+VGhpcyBldmVudCBzaG91bGQgbm90IGJlIHVzZWQgZm9yIGdlbmVyaWMgbG9nZ2luZyBvciBkaWFnbm9zdGljIG1vbml0b3JpbmcgcHVycG9zZXMgYW5kCiAgICAgKiBzaG91bGQgZ2VuZXJhbGx5IGJlIHNlbnQgYXQgYSBsb3cgcmF0ZS4gSW5zdGVhZCwgdGhpcyBtZWNoYW5pc20gc2hvdWxkIGJlIHVzZWQgZm9yIHRoZQogICAgICogZnJhbWV3b3JrIHRvIG5vdGlmeSBhIGRlYnVnZ2luZyBhcHBsaWNhdGlvbiB0aGF0IGFuIGV2ZW50IChzdWNoIGFzIGEgYnVnKSBoYXMgb2NjdXJlZAogICAgICogd2l0aGluIHRoZSBmcmFtZXdvcmsgaWYgdGhhdCBldmVudCBzaG91bGQgdHJpZ2dlciB0aGUgY29sbGVjdGlvbiBhbmQgcHJlc2VydmF0aW9uIG9mIG90aGVyCiAgICAgKiBtb3JlIGRldGFpbGVkIGRldmljZSBzdGF0ZSBmb3IgZGVidWdnaW5nLgogICAgICoKICAgICAqIDxwPkF0IG1vc3Qgb25lIGFwcGxpY2F0aW9uIGNhbiByZWNlaXZlIHRoZXNlIGV2ZW50cyBhbmQgc2hvdWxkIHJlZ2lzdGVyIGEgcmVjZWl2ZXIgaW4KICAgICAqIGluIHRoZSBhcHBsaWNhdGlvbiBtYW5pZmVzdC4gRm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMsIGlmIG5vIGFwcGxpY2F0aW9uIHRvIHJlY2VpdmUgdGhlc2UKICAgICAqIGV2ZW50cyBpcyBkZXRlY3RlZCBhdCBib290LCB0aGVuIHRoZXNlIGV2ZW50cyB3aWxsIG5vdCBiZSBzZW50LgogICAgICoKICAgICAqIDxwPkVhY2ggZXZlbnQgd2lsbCBpbmNsdWRlIGFuIHtAbGluayBFWFRSQV9BTk9NQUxZX0lEfSB0aGF0IHdpbGwgdW5pcXVlbHkgaWRlbnRpZnkgdGhlCiAgICAgKiBldmVudCB0aGF0IGhhcyBvY2N1cnJlZC4gRWFjaCBldmVudCB3aWxsIGJlIHNlbnQgdG8gdGhlIGRpYWdub3N0aWMgbW9uaXRvciBvbmx5IG9uY2UgcGVyCiAgICAgKiBib290IGN5Y2xlIChhcyBhbm90aGVyIG9wdGltaXphdGlvbikuCiAgICAgKgogICAgICogQHNlZSAjRVhUUkFfQU5PTUFMWV9JRAogICAgICogQHNlZSAjRVhUUkFfQU5PTUFMWV9ERVNDUklQVElPTgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0FOT01BTFlfUkVQT1JURUQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLkFOT01BTFlfUkVQT1JURUQiOwoKICAgIC8qKgogICAgICogQW4gYXJiaXRyYXJ5IFBhcmNlbFV1aWQgd2hpY2ggc2hvdWxkIGJlIGNvbnNpc3RlbnQgZm9yIGVhY2ggb2NjdXJyZW5jZSBvZiBhIERlYnVnRXZlbnQuCiAgICAgKgogICAgICogVGhpcyBmaWVsZCBtdXN0IGJlIGluY2x1ZGVkIGluIGFsbCB7QGxpbmsgQUNUSU9OX0FOT01BTFlfUkVQT1JURUR9IGV2ZW50cy4KICAgICAqCiAgICAgKiBAc2VlICNBQ1RJT05fQU5PTUFMWV9SRVBPUlRFRAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfQU5PTUFMWV9JRCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5BTk9NQUxZX0lEIjsKCiAgICAvKioKICAgICAqIEEgZnJlZWZvcm0gc3RyaW5nIGRlc2NyaXB0aW9uIG9mIHRoZSBBbm9tYWx5LgogICAgICoKICAgICAqIFRoaXMgZmllbGQgaXMgb3B0aW9uYWwgZm9yIGFsbCB7QGxpbmsgQUNUSU9OX0FOT01BTFlfUkVQT1JURUR9cywgYXMgYSBndWlkZWxpbmUgc2hvdWxkIG5vdAogICAgICogZXhjZWVkIDgwIGNoYXJhY3RlcnMsIGFuZCBzaG91bGQgYmUgYXMgc2hvcnQgYXMgcG9zc2libGUgdG8gY29udmV5IHRoZSBlc3NlbmNlIG9mIHRoZSBldmVudC4KICAgICAqCiAgICAgKiBAc2VlICNBQ1RJT05fQU5PTUFMWV9SRVBPUlRFRAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfQU5PTUFMWV9ERVNDUklQVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5BTk9NQUxZX0RFU0NSSVBUSU9OIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBpbnRlbnQgc2VudCB0byBpbmRpY2F0ZSBwcmltYXJ5IChub24tb3Bwb3J0dW5pc3RpYykgc3Vic2NyaXB0aW9uIGxpc3QgaGFzIGNoYW5nZWQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9QUklNQVJZX1NVQlNDUklQVElPTl9MSVNUX0NIQU5HRUQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLlBSSU1BUllfU1VCU0NSSVBUSU9OX0xJU1RfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBJbnRlZ2VyIGludGVudCBleHRyYSB0byBiZSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fUFJJTUFSWV9TVUJTQ1JJUFRJT05fTElTVF9DSEFOR0VEfQogICAgICogdG8gaW5kaWNhdGUgd2hhdCB0eXBlIG9mIFNJTSBzZWxlY3Rpb24gaXMgbmVlZGVkLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX0RFRkFVTFRfU1VCU0NSSVBUSU9OX1NFTEVDVF9UWVBFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLkRFRkFVTFRfU1VCU0NSSVBUSU9OX1NFTEVDVF9UWVBFIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBJbnREZWYoewogICAgICAgICAgICBFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRV9OT05FLAogICAgICAgICAgICBFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRV9EQVRBLAogICAgICAgICAgICBFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRV9WT0lDRSwKICAgICAgICAgICAgRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEVfU01TLAogICAgICAgICAgICBFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRV9BTEwKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBEZWZhdWx0U3Vic2NyaXB0aW9uU2VsZWN0VHlwZXt9CgogICAgLyoqCiAgICAgKiBVc2VkIGFzIGFuIGludCB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRX0KICAgICAqIHRvIGluZGljYXRlIHRoZXJlJ3Mgbm8gbmVlZCB0byByZS1zZWxlY3QgYW55IGRlZmF1bHQgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEVfTk9ORSA9IDA7CgogICAgLyoqCiAgICAgKiBVc2VkIGFzIGFuIGludCB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRX0KICAgICAqIHRvIGluZGljYXRlIHRoZXJlJ3MgYSBuZWVkIHRvIHNlbGVjdCBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEVfREFUQSA9IDE7CgogICAgLyoqCiAgICAgKiBVc2VkIGFzIGFuIGludCB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRX0KICAgICAqIHRvIGluZGljYXRlIHRoZXJlJ3MgYSBuZWVkIHRvIHNlbGVjdCBkZWZhdWx0IHZvaWNlIGNhbGwgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEVfVk9JQ0UgPSAyOwoKICAgIC8qKgogICAgICogVXNlZCBhcyBhbiBpbnQgdmFsdWUgZm9yIHtAbGluayAjRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEV9CiAgICAgKiB0byBpbmRpY2F0ZSB0aGVyZSdzIGEgbmVlZCB0byBzZWxlY3QgZGVmYXVsdCBzbXMgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVhUUkFfREVGQVVMVF9TVUJTQ1JJUFRJT05fU0VMRUNUX1RZUEVfU01TID0gMzsKCiAgICAvKioKICAgICAqIFVzZWQgYXMgYW4gaW50IHZhbHVlIGZvciB7QGxpbmsgI0VYVFJBX0RFRkFVTFRfU1VCU0NSSVBUSU9OX1NFTEVDVF9UWVBFfQogICAgICogdG8gaW5kaWNhdGUgdXNlciB0byBkZWNpZGUgd2hldGhlciBjdXJyZW50IFNJTSBzaG91bGQgYmUgcHJlZmVycmVkIGZvciBhbGwKICAgICAqIGRhdGEgLyB2b2ljZSAvIHNtcy4ge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSUR9IHdpbGwgc3BlY2lmaWVkIHRvIGluZGljYXRlCiAgICAgKiB3aGljaCBzdWJzY3JpcHRpb24gc2hvdWxkIGJlIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVYVFJBX0RFRkFVTFRfU1VCU0NSSVBUSU9OX1NFTEVDVF9UWVBFX0FMTCA9IDQ7CgogICAgLyoqCiAgICAgKiBVc2VkIGFzIGFuIGludCB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRX0KICAgICAqIHRvIGluZGljYXRlIHRoYXQgZGVmYXVsdCBzdWJzY3JpcHRpb24gZm9yIGRhdGEvc21zL3ZvaWNlIGlzIG5vdyBkZXRlcm1pbmVkLCB0aGF0CiAgICAgKiBpdCBzaG91bGQgZGlzbWlzcyBhbnkgZGlhbG9nIG9yIHBvcC11cHMgdGhhdCBpcyBhc2tpbmcgdXNlciB0byBzZWxlY3QgZGVmYXVsdCBzdWIuCiAgICAgKiBUaGlzIGlzIHVzZWQgd2hlbiwgZm9yIGV4YW1wbGUsIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIGlzIGNvbmZpZ3VyZWQuIEF0IHRoYXQKICAgICAqIHRpbWUgdGhlIHByaW1hcnkgYmVjb21lcyBkZWZhdWx0IHN1YiB0aGVyZSdzIG5vIG5lZWQgdG8gYXNrIHVzZXIgdG8gc2VsZWN0IGFueW1vcmUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRV9ESVNNSVNTID0gNTsKCiAgICAvKioKICAgICAqIEludGVnZXIgaW50ZW50IGV4dHJhIHRvIGJlIHVzZWQgd2l0aCB7QGxpbmsgI0FDVElPTl9QUklNQVJZX1NVQlNDUklQVElPTl9MSVNUX0NIQU5HRUR9CiAgICAgKiB0byBpbmRpY2F0ZSBpZiB0aGUgU0lNIGNvbWJpbmF0aW9uIGluIERTRFMgaGFzIGxpbWl0YXRpb24gb3IgY29tcGF0aWJsZSBpc3N1ZS4KICAgICAqIGUuZy4gdHdvIENETUEgU0lNcyBtYXkgZGlzcnVwdCBlYWNoIG90aGVyJ3Mgdm9pY2UgY2FsbCBpbiBjZXJ0YWluIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TSU1fQ09NQklOQVRJT05fV0FSTklOR19UWVBFID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNJTV9DT01CSU5BVElPTl9XQVJOSU5HX1RZUEUiOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQEludERlZih7CiAgICAgICAgICAgIEVYVFJBX1NJTV9DT01CSU5BVElPTl9XQVJOSU5HX1RZUEVfTk9ORSwKICAgICAgICAgICAgRVhUUkFfU0lNX0NPTUJJTkFUSU9OX1dBUk5JTkdfVFlQRV9EVUFMX0NETUEKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBTaW1Db21iaW5hdGlvbldhcm5pbmdUeXBle30KCiAgICAvKioKICAgICAqIFVzZWQgYXMgYW4gaW50IHZhbHVlIGZvciB7QGxpbmsgI0VYVFJBX0RFRkFVTFRfU1VCU0NSSVBUSU9OX1NFTEVDVF9UWVBFfQogICAgICogdG8gaW5kaWNhdGUgdGhlcmUncyBubyBTSU0gY29tYmluYXRpb24gd2FybmluZy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVYVFJBX1NJTV9DT01CSU5BVElPTl9XQVJOSU5HX1RZUEVfTk9ORSA9IDA7CgogICAgLyoqCiAgICAgKiBVc2VkIGFzIGFuIGludCB2YWx1ZSBmb3Ige0BsaW5rICNFWFRSQV9ERUZBVUxUX1NVQlNDUklQVElPTl9TRUxFQ1RfVFlQRX0KICAgICAqIHRvIGluZGljYXRlIHR3byBhY3RpdmUgU0lNcyBhcmUgYm90aCBDRE1BIGhlbmNlIHRoZXJlIG1pZ2h0IGJlIGZ1bmN0aW9uYWwgbGltaXRhdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVYVFJBX1NJTV9DT01CSU5BVElPTl9XQVJOSU5HX1RZUEVfRFVBTF9DRE1BID0gMTsKCiAgICAvKioKICAgICAqIFN0cmluZyBpbnRlbnQgZXh0cmEgdG8gYmUgdXNlZCB3aXRoIHtAbGluayAjQUNUSU9OX1BSSU1BUllfU1VCU0NSSVBUSU9OX0xJU1RfQ0hBTkdFRH0KICAgICAqIHRvIGluZGljYXRlIHdoYXQncyB0aGUgbmFtZSBvZiBTSU0gY29tYmluYXRpb24gaXQgaGFzIGxpbWl0YXRpb24gb3IgY29tcGF0aWJsZSBpc3N1ZS4KICAgICAqIGUuZy4gdHdvIENETUEgU0lNcyBtYXkgZGlzcnVwdCBlYWNoIG90aGVyJ3Mgdm9pY2UgY2FsbCBpbiBjZXJ0YWluIHNjZW5hcmlvcywgYW5kIHRoZQogICAgICogbmFtZSB3aWxsIGJlICJvcGVyYXRvcjEgJiBvcGVyYXRvcjIiLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NJTV9DT01CSU5BVElPTl9OQU1FUyA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TSU1fQ09NQklOQVRJT05fTkFNRVMiOwoKICAgIC8qKgogICAgICogPHA+QnJvYWRjYXN0IEFjdGlvbjogVGhlIGVtZXJnZW5jeSBjYWxsYmFjayBtb2RlIGlzIGNoYW5nZWQuCiAgICAgKiA8dWw+CiAgICAgKiAgIDxsaT48ZW0+RVhUUkFfUEhPTkVfSU5fRUNNX1NUQVRFPC9lbT4gLSBBIGJvb2xlYW4gdmFsdWUsdHJ1ZT1waG9uZSBpbiBFQ00sCiAgICAgKiAgIGZhbHNlPUVDTSBvZmY8L2xpPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj4KICAgICAqIFlvdSBjYW4gPGVtPm5vdDwvZW0+IHJlY2VpdmUgdGhpcyB0aHJvdWdoIGNvbXBvbmVudHMgZGVjbGFyZWQKICAgICAqIGluIG1hbmlmZXN0cywgb25seSBieSBleHBsaWNpdGx5IHJlZ2lzdGVyaW5nIGZvciBpdCB3aXRoCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkNvbnRleHQjcmVnaXN0ZXJSZWNlaXZlcihhbmRyb2lkLmNvbnRlbnQuQnJvYWRjYXN0UmVjZWl2ZXIsCiAgICAgKiBhbmRyb2lkLmNvbnRlbnQuSW50ZW50RmlsdGVyKSBDb250ZXh0LnJlZ2lzdGVyUmVjZWl2ZXIoKX0uCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoaXMgaXMgYSBwcm90ZWN0ZWQgaW50ZW50IHRoYXQgY2FuIG9ubHkgYmUgc2VudCBieSB0aGUgc3lzdGVtLgogICAgICoKICAgICAqIEBzZWUgI0VYVFJBX1BIT05FX0lOX0VDTV9TVEFURQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fRU1FUkdFTkNZX0NBTExCQUNLX01PREVfQ0hBTkdFRCA9CiAgICAgICAgICAgICJhbmRyb2lkLmludGVudC5hY3Rpb24uRU1FUkdFTkNZX0NBTExCQUNLX01PREVfQ0hBTkdFRCI7CgoKICAgIC8qKgogICAgICogRXh0cmEgaW5jbHVkZWQgaW4ge0BsaW5rICNBQ1RJT05fRU1FUkdFTkNZX0NBTExCQUNLX01PREVfQ0hBTkdFRH0uCiAgICAgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgcGhvbmUgaXMgaW4gYW4gZW1lcmdlbmN5IHBob25lIHN0YXRlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1BIT05FX0lOX0VDTV9TVEFURSA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5QSE9ORV9JTl9FQ01fU1RBVEUiOwoKICAgIC8qKgogICAgICogPHA+QnJvYWRjYXN0IEFjdGlvbjogd2hlbiBkYXRhIGNvbm5lY3Rpb25zIGdldCByZWRpcmVjdGVkIHdpdGggdmFsaWRhdGlvbiBmYWlsdXJlLgogICAgICogaW50ZW5kZWQgZm9yIHNpbS9hY2NvdW50IHN0YXR1cyBjaGVja3MgYW5kIG9ubHkgc2VudCB0byB0aGUgc3BlY2lmaWVkIGNhcnJpZXIgYXBwCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczo8L3A+CiAgICAgKiA8dWw+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFfTwvbGk+PGRkPkEgc3RyaW5nIHdpdGggdGhlIGFwbiB0eXBlLjwvZGQ+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFX0lOVH08L2xpPjxkZD5BIGludGVnZXIgd2l0aCB0aGUgYXBuIHR5cGUuPC9kZD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfUkVESVJFQ1RJT05fVVJMfTwvbGk+PGRkPnJlZGlyZWN0aW9uIHVybCBzdHJpbmc8L2RkPgogICAgICogICA8bGk+c3ViSWQ8L2xpPjxkZD5TdWIgSWQgd2hpY2ggYXNzb2NpYXRlZCB0aGUgZGF0YSBjb25uZWN0aW9uIGZhaWx1cmUuPC9kZD4KICAgICAqIDwvdWw+CiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+VGhpcyBpcyBhIHByb3RlY3RlZCBpbnRlbnQgdGhhdCBjYW4gb25seSBiZSBzZW50IGJ5IHRoZSBzeXN0ZW0uPC9wPgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NBUlJJRVJfU0lHTkFMX1JFRElSRUNURUQgPQogICAgICAgICAgICAiY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LkNBUlJJRVJfU0lHTkFMX1JFRElSRUNURUQiOwoKICAgIC8qKgogICAgICogPHA+QnJvYWRjYXN0IEFjdGlvbjogd2hlbiBkYXRhIGNvbm5lY3Rpb25zIHNldHVwIGZhaWxzLgogICAgICogaW50ZW5kZWQgZm9yIHNpbS9hY2NvdW50IHN0YXR1cyBjaGVja3MgYW5kIG9ubHkgc2VudCB0byB0aGUgc3BlY2lmaWVkIGNhcnJpZXIgYXBwCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczo8L3A+CiAgICAgKiA8dWw+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFfTwvbGk+PGRkPkEgc3RyaW5nIHdpdGggdGhlIGFwbiB0eXBlLjwvZGQ+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFX0lOVH08L2xpPjxkZD5BIGludGVnZXIgd2l0aCB0aGUgYXBuIHR5cGUuPC9kZD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfRVJST1JfQ09ERX08L2xpPjxkZD5BIGludGVnZXIgd2l0aCBkYXRhRmFpbENhdXNlLjwvZGQ+CiAgICAgKiAgIDxsaT5zdWJJZDwvbGk+PGRkPlN1YiBJZCB3aGljaCBhc3NvY2lhdGVkIHRoZSBkYXRhIGNvbm5lY3Rpb24gZmFpbHVyZS48L2RkPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4gPC9wPgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NBUlJJRVJfU0lHTkFMX1JFUVVFU1RfTkVUV09SS19GQUlMRUQgPQogICAgICAgICAgICAiY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LkNBUlJJRVJfU0lHTkFMX1JFUVVFU1RfTkVUV09SS19GQUlMRUQiOwoKICAgIC8qKgogICAgICogPHA+QnJvYWRjYXN0IEFjdGlvbjogd2hlbiBwY28gdmFsdWUgaXMgYXZhaWxhYmxlLgogICAgICogaW50ZW5kZWQgZm9yIHNpbS9hY2NvdW50IHN0YXR1cyBjaGVja3MgYW5kIG9ubHkgc2VudCB0byB0aGUgc3BlY2lmaWVkIGNhcnJpZXIgYXBwCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczo8L3A+CiAgICAgKiA8dWw+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFfTwvbGk+PGRkPkEgc3RyaW5nIHdpdGggdGhlIGFwbiB0eXBlLjwvZGQ+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9UWVBFX0lOVH08L2xpPjxkZD5BIGludGVnZXIgd2l0aCB0aGUgYXBuIHR5cGUuPC9kZD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfQVBOX1BST1RPQ09MfTwvbGk+PGRkPkEgc3RyaW5nIHdpdGggdGhlIHByb3RvY29sIG9mIHRoZSBhcG4gY29ubmVjdGlvbgogICAgICogICAgICAoSVAsSVBWNiwgSVBWNFY2KTwvZGQ+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX0FQTl9QUk9UT0NPTF9JTlR9PC9saT48ZGQ+QSBpbnRlZ2VyIHdpdGggdGhlIHByb3RvY29sIG9mIHRoZSBhcG4KICAgICAqICAgICAgY29ubmVjdGlvbiAoSVAsSVBWNiwgSVBWNFY2KTwvZGQ+CiAgICAgKiAgIDxsaT57QGxpbmsgI0VYVFJBX1BDT19JRH08L2xpPjxkZD5BbiBpbnRlZ2VyIGluZGljYXRpbmcgdGhlIHBjbyBpZCBmb3IgdGhlIGRhdGEuPC9kZD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfUENPX1ZBTFVFfTwvbGk+PGRkPkEgYnl0ZSBhcnJheSBvZiBwY28gZGF0YSByZWFkIGZyb20gbW9kZW0uPC9kZD4KICAgICAqICAgPGxpPnN1YklkPC9saT48ZGQ+U3ViIElkIHdoaWNoIGFzc29jaWF0ZWQgdGhlIGRhdGEgY29ubmVjdGlvbi48L2RkPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4gPC9wPgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0NBUlJJRVJfU0lHTkFMX1BDT19WQUxVRSA9CiAgICAgICAgICAgICJjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuQ0FSUklFUl9TSUdOQUxfUENPX1ZBTFVFIjsKCiAgICAvKioKICAgICAqIDxwPkJyb2FkY2FzdCBBY3Rpb246IHdoZW4gc3lzdGVtIGRlZmF1bHQgbmV0d29yayBhdmFpbGFibGUvdW5hdmFpbGFibGUgd2l0aAogICAgICogY2Fycmllci1kaXNhYmxlZCBtb2JpbGUgZGF0YS4gSW50ZW5kZWQgZm9yIGNhcnJpZXIgYXBwcyB0byBzZXQvcmVzZXQgY2FycmllciBhY3Rpb25zIHdoZW4KICAgICAqIG90aGVyIG5ldHdvcmsgYmVjb21lcyBzeXN0ZW0gZGVmYXVsdCBuZXR3b3JrLCBXaS1GaSBmb3IgZXhhbXBsZS4KICAgICAqIFRoZSBpbnRlbnQgd2lsbCBoYXZlIHRoZSBmb2xsb3dpbmcgZXh0cmEgdmFsdWVzOjwvcD4KICAgICAqIDx1bD4KICAgICAqICAgPGxpPntAbGluayAjRVhUUkFfREVGQVVMVF9ORVRXT1JLX0FWQUlMQUJMRX08L2xpPgogICAgICogICA8ZGQ+QSBib29sZWFuIGluZGljYXRlcyBkZWZhdWx0IG5ldHdvcmsgYXZhaWxhYmxlLjwvZGQ+CiAgICAgKiAgIDxsaT5zdWJJZDwvbGk+PGRkPlN1YiBJZCB3aGljaCBhc3NvY2lhdGVkIHRoZSBkZWZhdWx0IGRhdGEuPC9kZD4KICAgICAqIDwvdWw+CiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+VGhpcyBpcyBhIHByb3RlY3RlZCBpbnRlbnQgdGhhdCBjYW4gb25seSBiZSBzZW50IGJ5IHRoZSBzeXN0ZW0uIDwvcD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTdXBwcmVzc0xpbnQoIkFjdGlvblZhbHVlIikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9DQVJSSUVSX1NJR05BTF9ERUZBVUxUX05FVFdPUktfQVZBSUxBQkxFID0KICAgICAgICAgICAgImNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5DQVJSSUVSX1NJR05BTF9ERUZBVUxUX05FVFdPUktfQVZBSUxBQkxFIjsKCiAgICAvKioKICAgICAqIDxwPkJyb2FkY2FzdCBBY3Rpb246IHdoZW4gZnJhbWV3b3JrIHJlc2V0IGFsbCBjYXJyaWVyIGFjdGlvbnMgb24gc2ltIGxvYWQgb3IgYWJzZW50LgogICAgICogaW50ZW5kZWQgZm9yIGNhcnJpZXIgYXBwcyBjbGVhbiB1cCAoY2xlYXIgVUkgZS5nLikgYW5kIG9ubHkgc2VudCB0byB0aGUgc3BlY2lmaWVkIGNhcnJpZXIgYXBwCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczo8L3A+CiAgICAgKiA8dWw+CiAgICAgKiAgIDxsaT5zdWJJZDwvbGk+PGRkPlN1YiBJZCB3aGljaCBhc3NvY2lhdGVkIHRoZSBkYXRhIGNvbm5lY3Rpb24gZmFpbHVyZS48L2RkPgogICAgICogPC91bD4KICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS48L3A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fQ0FSUklFUl9TSUdOQUxfUkVTRVQgPQogICAgICAgICAgICAiY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LkNBUlJJRVJfU0lHTkFMX1JFU0VUIjsKCiAgICAvLyBDQVJSSUVSX1NJR05BTF9BQ1RJT04gZXh0cmEga2V5cwogICAgLyoqCiAgICAgKiAgQW4gc3RyaW5nIGV4dHJhIG9mIHJlZGlyZWN0ZWQgdXJsIHVwb24ge0BsaW5rICNBQ1RJT05fQ0FSUklFUl9TSUdOQUxfUkVESVJFQ1RFRH0uCiAgICAgKiAgQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfUkVESVJFQ1RJT05fVVJMID0gInJlZGlyZWN0aW9uVXJsIjsKCiAgICAvKioKICAgICAqICBBbiBpbnRlZ2VyIGV4dHJhIG9mIGVycm9yIGNvZGUgdXBvbiB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9SRVFVRVNUX05FVFdPUktfRkFJTEVEfS4KICAgICAqICBDaGVjayB7QGxpbmsgRGF0YUZhaWxDYXVzZX0gZm9yIGFsbCBwb3NzaWJsZSB2YWx1ZXMuCiAgICAgKiAgQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfRVJST1JfQ09ERSA9ICJlcnJvckNvZGUiOwoKICAgIC8qKgogICAgICogIEFuIHN0cmluZyBleHRyYSBvZiBjb3JyZXNwb25kaW5nIGFwbiB0eXBlIHVwb24KICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9SRVFVRVNUX05FVFdPUktfRkFJTEVEfSwKICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9SRURJUkVDVEVEfSBhbmQKICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9QQ09fVkFMVUV9IGJyb2FkY2FzdHMuCiAgICAgKiAgQGRlcHJlY2F0ZWQgVGhpcyBpcyBrZXB0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHJlYXNvbi4gVXNlIHtAbGluayAjRVhUUkFfQVBOX1RZUEVfSU5UfQogICAgICogIGluc3RlYWQuCiAgICAgKgogICAgICogIEBoaWRlCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9BUE5fVFlQRSA9ICJhcG5UeXBlIjsKCiAgICAvKioKICAgICAqICBBbiBzdHJpbmcgaW50ZWdlciBvZiBjb3JyZXNwb25kaW5nIGFwbiB0eXBlIHVwb24KICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9SRVFVRVNUX05FVFdPUktfRkFJTEVEfSwKICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9SRURJUkVDVEVEfSBhbmQKICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9QQ09fVkFMVUV9IGJyb2FkY2FzdHMuCiAgICAgKiAgQ2hlY2sge0BsaW5rIEFwblNldHRpbmd9IFRZUEVfKiBmb3IgaXRzIHZhbHVlcy4KICAgICAqICBAaGlkZQogICAgICovCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9BUE5fVFlQRV9JTlQgPSAiYXBuVHlwZUludCI7CgogICAgLyoqCiAgICAgKiAgQW4gc3RyaW5nIGV4dHJhIHdpdGggdGhlIHByb3RvY29sIG9mIHRoZSBhcG4gY29ubmVjdGlvbiAoSVAsSVBWNiwgSVBWNFY2KSB1cG9uCiAgICAgKiAge0BsaW5rICNBQ1RJT05fQ0FSUklFUl9TSUdOQUxfUENPX1ZBTFVFfSBicm9hZGNhc3RzLgogICAgICogIEBkZXByZWNhdGVkIFRoaXMgaXMga2VwdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSByZWFzb24uCiAgICAgKiAgVXNlIHtAbGluayAjRVhUUkFfQVBOX1BST1RPQ09MX0lOVH0gaW5zdGVhZC4KICAgICAqCiAgICAgKiAgQGhpZGUKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBTdXBwcmVzc0xpbnQoIkFjdGlvblZhbHVlIikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX0FQTl9QUk9UT0NPTCA9ICJhcG5Qcm90byI7CgogICAgLyoqCiAgICAgKiAgQW4gaW50ZWdlciBleHRyYSB3aXRoIHRoZSBwcm90b2NvbCBvZiB0aGUgYXBuIGNvbm5lY3Rpb24gKElQLElQVjYsIElQVjRWNikgdXBvbgogICAgICogIHtAbGluayAjQUNUSU9OX0NBUlJJRVJfU0lHTkFMX1BDT19WQUxVRX0gYnJvYWRjYXN0cy4KICAgICAqICBDaGVjayB7QGxpbmsgQXBuU2V0dGluZ30gUFJPVE9DT0xfKiBmb3IgaXRzIHZhbHVlcy4KICAgICAqICBAaGlkZQogICAgICovCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9BUE5fUFJPVE9DT0xfSU5UID0gImFwblByb3RvSW50IjsKCiAgICAvKioKICAgICAqICBBbiBpbnRlZ2VyIGV4dHJhIGluZGljYXRpbmcgdGhlIHBjbyBpZCBmb3IgdGhlIGRhdGEgdXBvbgogICAgICogIHtAbGluayAjQUNUSU9OX0NBUlJJRVJfU0lHTkFMX1BDT19WQUxVRX0gYnJvYWRjYXN0cy4KICAgICAqICBAaGlkZQogICAgICovCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9QQ09fSUQgPSAicGNvSWQiOwoKICAgIC8qKgogICAgICogIEFuIGV4dHJhIG9mIGJ5dGUgYXJyYXkgb2YgcGNvIGRhdGEgcmVhZCBmcm9tIG1vZGVtIHVwb24KICAgICAqICB7QGxpbmsgI0FDVElPTl9DQVJSSUVSX1NJR05BTF9QQ09fVkFMVUV9IGJyb2FkY2FzdHMuCiAgICAgKiAgQGhpZGUKICAgICAqLwogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfUENPX1ZBTFVFID0gInBjb1ZhbHVlIjsKCiAgICAvKioKICAgICAqICBBbiBib29sZWFuIGV4dHJhIGluZGljYXRpbmcgZGVmYXVsdCBuZXR3b3JrIGF2YWlsYWJsZSB1cG9uCiAgICAgKiAge0BsaW5rICNBQ1RJT05fQ0FSUklFUl9TSUdOQUxfREVGQVVMVF9ORVRXT1JLX0FWQUlMQUJMRX0gYnJvYWRjYXN0cy4KICAgICAqICBAaGlkZQogICAgICovCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9ERUZBVUxUX05FVFdPUktfQVZBSUxBQkxFID0gImRlZmF1bHROZXR3b3JrQXZhaWxhYmxlIjsKCiAgICAvKioKICAgICAqIDxwPkJyb2FkY2FzdCBBY3Rpb246IFRoZSBlbWVyZ2VuY3kgY2FsbCBzdGF0ZSBpcyBjaGFuZ2VkLgogICAgICogPHVsPgogICAgICogICA8bGk+PGVtPkVYVFJBX1BIT05FX0lOX0VNRVJHRU5DWV9DQUxMPC9lbT4gLSBBIGJvb2xlYW4gdmFsdWUsIHRydWUgaWYgcGhvbmUgaW4gZW1lcmdlbmN5CiAgICAgKiAgIGNhbGwsIGZhbHNlIG90aGVyd2lzZTwvbGk+CiAgICAgKiA8L3VsPgogICAgICogPHAgY2xhc3M9Im5vdGUiPgogICAgICogWW91IGNhbiA8ZW0+bm90PC9lbT4gcmVjZWl2ZSB0aGlzIHRocm91Z2ggY29tcG9uZW50cyBkZWNsYXJlZAogICAgICogaW4gbWFuaWZlc3RzLCBvbmx5IGJ5IGV4cGxpY2l0bHkgcmVnaXN0ZXJpbmcgZm9yIGl0IHdpdGgKICAgICAqIHtAbGluayBhbmRyb2lkLmNvbnRlbnQuQ29udGV4dCNyZWdpc3RlclJlY2VpdmVyKGFuZHJvaWQuY29udGVudC5Ccm9hZGNhc3RSZWNlaXZlciwKICAgICAqIGFuZHJvaWQuY29udGVudC5JbnRlbnRGaWx0ZXIpIENvbnRleHQucmVnaXN0ZXJSZWNlaXZlcigpfS4KICAgICAqCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+VGhpcyBpcyBhIHByb3RlY3RlZCBpbnRlbnQgdGhhdCBjYW4gb25seSBiZSBzZW50IGJ5IHRoZSBzeXN0ZW0uCiAgICAgKgogICAgICogQHNlZSAjRVhUUkFfUEhPTkVfSU5fRU1FUkdFTkNZX0NBTEwKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgQFN1cHByZXNzTGludCgiQWN0aW9uVmFsdWUiKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX0VNRVJHRU5DWV9DQUxMX1NUQVRFX0NIQU5HRUQgPQogICAgICAgICAgICAiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLkVNRVJHRU5DWV9DQUxMX1NUQVRFX0NIQU5HRUQiOwoKCiAgICAvKioKICAgICAqIEV4dHJhIGluY2x1ZGVkIGluIHtAbGluayAjQUNUSU9OX0VNRVJHRU5DWV9DQUxMX1NUQVRFX0NIQU5HRUR9LgogICAgICogSXQgaW5kaWNhdGVzIHdoZXRoZXIgdGhlIHBob25lIGlzIG1ha2luZyBhbiBlbWVyZ2VuY3kgY2FsbC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9QSE9ORV9JTl9FTUVSR0VOQ1lfQ0FMTCA9CiAgICAgICAgICAgICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5QSE9ORV9JTl9FTUVSR0VOQ1lfQ0FMTCI7CgogICAgLyoqCiAgICAgKiA8cD5Ccm9hZGNhc3QgQWN0aW9uOiBJdCBpbmRpY2F0ZXMgdGhlIEVtZXJnZW5jeSBjYWxsYmFjayBtb2RlIGJsb2NrcyBkYXRhY2FsbC9zbXMKICAgICAqIDxwIGNsYXNzPSJub3RlIj4uCiAgICAgKiBUaGlzIGlzIHRvIHBvcCB1cCBhIG5vdGljZSB0byBzaG93IHVzZXIgdGhhdCB0aGUgcGhvbmUgaXMgaW4gZW1lcmdlbmN5IGNhbGxiYWNrIG1vZGUKICAgICAqIGFuZCBkYXRhIGNhbGxzIGFuZCBvdXRnb2luZyBzbXMgYXJlIGJsb2NrZWQuCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoaXMgaXMgYSBwcm90ZWN0ZWQgaW50ZW50IHRoYXQgY2FuIG9ubHkgYmUgc2VudCBieSB0aGUgc3lzdGVtLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TSE9XX05PVElDRV9FQ01fQkxPQ0tfT1RIRVJTID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TSE9XX05PVElDRV9FQ01fQkxPQ0tfT1RIRVJTIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uIGhhcyBjaGFuZ2VkIGluIGEgbXVsdGktU0lNIGRldmljZS4KICAgICAqIFRoaXMgaGFzIHRoZSBmb2xsb3dpbmcgZXh0cmEgdmFsdWVzOjwvcD4KICAgICAqIDx1bD4KICAgICAqICAgPGxpPjxlbT5zdWJzY3JpcHRpb248L2VtPiAtIEEgaW50LCB0aGUgY3VycmVudCBkYXRhIGRlZmF1bHQgc3Vic2NyaXB0aW9uLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkFjdGlvblZhbHVlIikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX0RBVEFfU1VCU0NSSVBUSU9OX0NIQU5HRUQgPQogICAgICAgICAgICAiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLkFDVElPTl9ERUZBVUxUX0RBVEFfU1VCU0NSSVBUSU9OX0NIQU5HRUQiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogVGhlIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uIGhhcyBjaGFuZ2VkIGluIGEgbXVsdC1TSW0gZGV2aWNlLgogICAgICogVGhpcyBoYXMgdGhlIGZvbGxvd2luZyBleHRyYSB2YWx1ZXM6PC9wPgogICAgICogPHVsPgogICAgICogICA8bGk+PGVtPnN1YnNjcmlwdGlvbjwvZW0+IC0gQSBpbnQsIHRoZSBjdXJyZW50IHZvaWNlIGRlZmF1bHQgc3Vic2NyaXB0aW9uLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkFjdGlvblZhbHVlIikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1ZPSUNFX1NVQlNDUklQVElPTl9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQuaW50ZW50LmFjdGlvbi5BQ1RJT05fREVGQVVMVF9WT0lDRV9TVUJTQ1JJUFRJT05fQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGlzIHRyaWdnZXJzIGEgY2xpZW50IGluaXRpYXRlZCBPTUEtRE0gc2Vzc2lvbiB0byB0aGUgT01BIHNlcnZlci4KICAgICAqIDxwIGNsYXNzPSJub3RlIj4KICAgICAqIE9wZW4gTW9iaWxlIEFsbGlhbmNlIChPTUEpIERldmljZSBNYW5hZ2VtZW50IChETSkuCiAgICAgKgogICAgICogVGhpcyBpbnRlbnQgaXMgdXNlZCBieSB0aGUgc3lzdGVtIGNvbXBvbmVudHMgdG8gdHJpZ2dlciBPTUEtRE0KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU3VwcHJlc3NMaW50KCJBY3Rpb25WYWx1ZSIpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fUkVRVUVTVF9PTUFETV9DT05GSUdVUkFUSU9OX1VQREFURSA9CiAgICAgICAgICAgICJjb20uYW5kcm9pZC5vbWFkbS5zZXJ2aWNlLkNPTkZJR1VSQVRJT05fVVBEQVRFIjsKCiAgICAvLwogICAgLy8KICAgIC8vIERldmljZSBJbmZvCiAgICAvLwogICAgLy8KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHNvZnR3YXJlIHZlcnNpb24gbnVtYmVyIGZvciB0aGUgZGV2aWNlLCBmb3IgZXhhbXBsZSwKICAgICAqIHRoZSBJTUVJL1NWIGZvciBHU00gcGhvbmVzLiBSZXR1cm4gbnVsbCBpZiB0aGUgc29mdHdhcmUgdmVyc2lvbiBpcwogICAgICogbm90IGF2YWlsYWJsZS4KICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9LgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgU3RyaW5nIGdldERldmljZVNvZnR3YXJlVmVyc2lvbigpIHsKICAgICAgICByZXR1cm4gZ2V0RGV2aWNlU29mdHdhcmVWZXJzaW9uKGdldFNsb3RJbmRleCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHNvZnR3YXJlIHZlcnNpb24gbnVtYmVyIGZvciB0aGUgZGV2aWNlLCBmb3IgZXhhbXBsZSwKICAgICAqIHRoZSBJTUVJL1NWIGZvciBHU00gcGhvbmVzLiBSZXR1cm4gbnVsbCBpZiB0aGUgc29mdHdhcmUgdmVyc2lvbiBpcwogICAgICogbm90IGF2YWlsYWJsZS4KICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjogUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLgogICAgICoKICAgICAqIEBwYXJhbSBzbG90SW5kZXggb2Ygd2hpY2ggZGV2aWNlSUQgaXMgcmV0dXJuZWQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBTdHJpbmcgZ2V0RGV2aWNlU29mdHdhcmVWZXJzaW9uKGludCBzbG90SW5kZXgpIHsKICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldERldmljZVNvZnR3YXJlVmVyc2lvbkZvclNsb3Qoc2xvdEluZGV4LCBnZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHVuaXF1ZSBkZXZpY2UgSUQsIGZvciBleGFtcGxlLCB0aGUgSU1FSSBmb3IgR1NNIGFuZCB0aGUgTUVJRAogICAgICogb3IgRVNOIGZvciBDRE1BIHBob25lcy4gUmV0dXJuIG51bGwgaWYgZGV2aWNlIElEIGlzIG5vdCBhdmFpbGFibGUuCiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMjksIHBlcnNpc3RlbnQgZGV2aWNlIGlkZW50aWZpZXJzIGFyZSBndWFyZGVkIGJlaGluZCBhZGRpdGlvbmFsCiAgICAgKiByZXN0cmljdGlvbnMsIGFuZCBhcHBzIGFyZSByZWNvbW1lbmRlZCB0byB1c2UgcmVzZXR0YWJsZSBpZGVudGlmaWVycyAoc2VlIDxhCiAgICAgKiBocmVmPSIvdHJhaW5pbmcvYXJ0aWNsZXMvdXNlci1kYXRhLWlkcyI+QmVzdCBwcmFjdGljZXMgZm9yIHVuaXF1ZSBpZGVudGlmaWVyczwvYT4pLiBUaGlzCiAgICAgKiBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBiZWVuIGdyYW50ZWQgdGhlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uOyB0aGlzCiAgICAgKiAgICAgaXMgYSBwcml2aWxlZ2VkIHBlcm1pc3Npb24gdGhhdCBjYW4gb25seSBiZSBncmFudGVkIHRvIGFwcHMgcHJlbG9hZGVkIG9uIHRoZSBkZXZpY2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGV2aWNlIG9yIHByb2ZpbGUgb3duZXIgYW5kIGhhcyBiZWVuIGdyYW50ZWQgdGhlCiAgICAgKiAgICAge0BsaW5rIE1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gcGVybWlzc2lvbi4gVGhlIHByb2ZpbGUgb3duZXIgaXMgYW4gYXBwIHRoYXQKICAgICAqICAgICBvd25zIGEgbWFuYWdlZCBwcm9maWxlIG9uIHRoZSBkZXZpY2U7IGZvciBtb3JlIGRldGFpbHMgc2VlIDxhCiAgICAgKiAgICAgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vd29yay9tYW5hZ2VkLXByb2ZpbGVzIj5Xb3JrIHByb2ZpbGVzPC9hPi4KICAgICAqICAgICBQcm9maWxlIG93bmVyIGFjY2VzcyBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgcmVsZWFzZS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkgb24gYW55CiAgICAgKiAgICAgYWN0aXZlIHN1YnNjcmlwdGlvbi4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRoZSBkZWZhdWx0IFNNUyByb2xlIGhvbGRlciAoc2VlIHtAbGluawogICAgICogICAgIFJvbGVNYW5hZ2VyI2lzUm9sZUhlbGQoU3RyaW5nKX0pLgogICAgICogPC91bD4KICAgICAqCiAgICAgKiA8cD5JZiB0aGUgY2FsbGluZyBhcHAgZG9lcyBub3QgbWVldCBvbmUgb2YgdGhlc2UgcmVxdWlyZW1lbnRzIHRoZW4gdGhpcyBtZXRob2Qgd2lsbCBiZWhhdmUKICAgICAqIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogPHVsPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBoYXMgdGhlCiAgICAgKiAgICAgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uIHRoZW4gbnVsbCBpcyByZXR1cm5lZC48L2xpPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBkb2VzIG5vdCBoYXZlCiAgICAgKiAgICAgdGhlIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiwgb3IgaWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRhcmdldGluZyBBUEkgbGV2ZWwgMjkgb3IKICAgICAqICAgICBoaWdoZXIsIHRoZW4gYSBTZWN1cml0eUV4Y2VwdGlvbiBpcyB0aHJvd24uPC9saT4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZ2V0SW1laX0gd2hpY2ggcmV0dXJucyBJTUVJIGZvciBHU00gb3Ige0BsaW5rICNnZXRNZWlkfSB3aGljaCByZXR1cm5zCiAgICAgKiBNRUlEIGZvciBDRE1BLgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBObyBzdXBwb3J0IGZvciBkZXZpY2UgLyBwcm9maWxlIG93bmVyIG9yIGNhcnJpZXIgcHJpdmlsZWdlcyAoYi83Mjk2NzIzNikuCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldERldmljZUlkKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXREZXZpY2VJZFdpdGhGZWF0dXJlKG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdW5pcXVlIGRldmljZSBJRCBvZiBhIHN1YnNjcmlwdGlvbiwgZm9yIGV4YW1wbGUsIHRoZSBJTUVJIGZvcgogICAgICogR1NNIGFuZCB0aGUgTUVJRCBmb3IgQ0RNQSBwaG9uZXMuIFJldHVybiBudWxsIGlmIGRldmljZSBJRCBpcyBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pIG9uIGFueQogICAgICogICAgIGFjdGl2ZSBzdWJzY3JpcHRpb24uCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBTTVMgcm9sZSBob2xkZXIgKHNlZSB7QGxpbmsKICAgICAqICAgICBSb2xlTWFuYWdlciNpc1JvbGVIZWxkKFN0cmluZyl9KS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogPHA+SWYgdGhlIGNhbGxpbmcgYXBwIGRvZXMgbm90IG1lZXQgb25lIG9mIHRoZXNlIHJlcXVpcmVtZW50cyB0aGVuIHRoaXMgbWV0aG9kIHdpbGwgYmVoYXZlCiAgICAgKiBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgaGFzIHRoZQogICAgICogICAgIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiB0aGVuIG51bGwgaXMgcmV0dXJuZWQuPC9saT4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgZG9lcyBub3QgaGF2ZQogICAgICogICAgIHRoZSBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24sIG9yIGlmIHRoZSBjYWxsaW5nIGFwcCBpcyB0YXJnZXRpbmcgQVBJIGxldmVsIDI5IG9yCiAgICAgKiAgICAgaGlnaGVyLCB0aGVuIGEgU2VjdXJpdHlFeGNlcHRpb24gaXMgdGhyb3duLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzbG90SW5kZXggb2Ygd2hpY2ggZGV2aWNlSUQgaXMgcmV0dXJuZWQKICAgICAqCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rICNnZXRJbWVpfSB3aGljaCByZXR1cm5zIElNRUkgZm9yIEdTTSBvciB7QGxpbmsgI2dldE1laWR9IHdoaWNoIHJldHVybnMKICAgICAqIE1FSUQgZm9yIENETUEuCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgZm9yIGRldmljZSAvIHByb2ZpbGUgb3duZXIgb3IgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0RGV2aWNlSWQoaW50IHNsb3RJbmRleCkgewogICAgICAgIC8vIEZJWE1FIHRoaXMgYXNzdW1lcyBwaG9uZUlkID09IHNsb3RJbmRleAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldERldmljZUlkRm9yUGhvbmUoc2xvdEluZGV4LCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElNRUkgKEludGVybmF0aW9uYWwgTW9iaWxlIEVxdWlwbWVudCBJZGVudGl0eSkuIFJldHVybiBudWxsIGlmIElNRUkgaXMgbm90CiAgICAgKiBhdmFpbGFibGUuCiAgICAgKgogICAgICogU2VlIHtAbGluayAjZ2V0SW1laShpbnQpfSBmb3IgZGV0YWlscyBvbiB0aGUgcmVxdWlyZWQgcGVybWlzc2lvbnMgYW5kIGJlaGF2aW9yCiAgICAgKiB3aGVuIHRoZSBjYWxsZXIgZG9lcyBub3QgaG9sZCBzdWZmaWNpZW50IHBlcm1pc3Npb25zLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgZm9yIGRldmljZSAvIHByb2ZpbGUgb3duZXIgb3IgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0SW1laSgpIHsKICAgICAgICByZXR1cm4gZ2V0SW1laShnZXRTbG90SW5kZXgoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBJTUVJIChJbnRlcm5hdGlvbmFsIE1vYmlsZSBFcXVpcG1lbnQgSWRlbnRpdHkpLiBSZXR1cm4gbnVsbCBpZiBJTUVJIGlzIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pIG9uIGFueQogICAgICogICAgIGFjdGl2ZSBzdWJzY3JpcHRpb24uCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBTTVMgcm9sZSBob2xkZXIgKHNlZSB7QGxpbmsKICAgICAqICAgICBSb2xlTWFuYWdlciNpc1JvbGVIZWxkKFN0cmluZyl9KS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogPHA+SWYgdGhlIGNhbGxpbmcgYXBwIGRvZXMgbm90IG1lZXQgb25lIG9mIHRoZXNlIHJlcXVpcmVtZW50cyB0aGVuIHRoaXMgbWV0aG9kIHdpbGwgYmVoYXZlCiAgICAgKiBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgaGFzIHRoZQogICAgICogICAgIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiB0aGVuIG51bGwgaXMgcmV0dXJuZWQuPC9saT4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgZG9lcyBub3QgaGF2ZQogICAgICogICAgIHRoZSBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24sIG9yIGlmIHRoZSBjYWxsaW5nIGFwcCBpcyB0YXJnZXRpbmcgQVBJIGxldmVsIDI5IG9yCiAgICAgKiAgICAgaGlnaGVyLCB0aGVuIGEgU2VjdXJpdHlFeGNlcHRpb24gaXMgdGhyb3duLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzbG90SW5kZXggb2Ygd2hpY2ggSU1FSSBpcyByZXR1cm5lZAogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgZm9yIGRldmljZSAvIHByb2ZpbGUgb3duZXIgb3IgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0SW1laShpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSByZXR1cm4gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRJbWVpRm9yU2xvdChzbG90SW5kZXgsIGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIFR5cGUgQWxsb2NhdGlvbiBDb2RlIGZyb20gdGhlIElNRUkuIFJldHVybiBudWxsIGlmIFR5cGUgQWxsb2NhdGlvbiBDb2RlIGlzIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBTdHJpbmcgZ2V0VHlwZUFsbG9jYXRpb25Db2RlKCkgewogICAgICAgIHJldHVybiBnZXRUeXBlQWxsb2NhdGlvbkNvZGUoZ2V0U2xvdEluZGV4KCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgVHlwZSBBbGxvY2F0aW9uIENvZGUgZnJvbSB0aGUgSU1FSS4gUmV0dXJuIG51bGwgaWYgVHlwZSBBbGxvY2F0aW9uIENvZGUgaXMgbm90CiAgICAgKiBhdmFpbGFibGUuCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCBvZiB3aGljaCBUeXBlIEFsbG9jYXRpb24gQ29kZSBpcyByZXR1cm5lZAogICAgICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBTdHJpbmcgZ2V0VHlwZUFsbG9jYXRpb25Db2RlKGludCBzbG90SW5kZXgpIHsKICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldFR5cGVBbGxvY2F0aW9uQ29kZUZvclNsb3Qoc2xvdEluZGV4KTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgTUVJRCAoTW9iaWxlIEVxdWlwbWVudCBJZGVudGlmaWVyKS4gUmV0dXJuIG51bGwgaWYgTUVJRCBpcyBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pIG9uIGFueQogICAgICogICAgIGFjdGl2ZSBzdWJzY3JpcHRpb24uCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBTTVMgcm9sZSBob2xkZXIgKHNlZSB7QGxpbmsKICAgICAqICAgICBSb2xlTWFuYWdlciNpc1JvbGVIZWxkKFN0cmluZyl9KS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogPHA+SWYgdGhlIGNhbGxpbmcgYXBwIGRvZXMgbm90IG1lZXQgb25lIG9mIHRoZXNlIHJlcXVpcmVtZW50cyB0aGVuIHRoaXMgbWV0aG9kIHdpbGwgYmVoYXZlCiAgICAgKiBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgaGFzIHRoZQogICAgICogICAgIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiB0aGVuIG51bGwgaXMgcmV0dXJuZWQuPC9saT4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgZG9lcyBub3QgaGF2ZQogICAgICogICAgIHRoZSBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24sIG9yIGlmIHRoZSBjYWxsaW5nIGFwcCBpcyB0YXJnZXRpbmcgQVBJIGxldmVsIDI5IG9yCiAgICAgKiAgICAgaGlnaGVyLCB0aGVuIGEgU2VjdXJpdHlFeGNlcHRpb24gaXMgdGhyb3duLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgZm9yIGRldmljZSAvIHByb2ZpbGUgb3duZXIgb3IgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TWVpZCgpIHsKICAgICAgICByZXR1cm4gZ2V0TWVpZChnZXRTbG90SW5kZXgoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNRUlEIChNb2JpbGUgRXF1aXBtZW50IElkZW50aWZpZXIpLiBSZXR1cm4gbnVsbCBpZiBNRUlEIGlzIG5vdCBhdmFpbGFibGUuCiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMjksIHBlcnNpc3RlbnQgZGV2aWNlIGlkZW50aWZpZXJzIGFyZSBndWFyZGVkIGJlaGluZCBhZGRpdGlvbmFsCiAgICAgKiByZXN0cmljdGlvbnMsIGFuZCBhcHBzIGFyZSByZWNvbW1lbmRlZCB0byB1c2UgcmVzZXR0YWJsZSBpZGVudGlmaWVycyAoc2VlIDxhCiAgICAgKiBocmVmPSIvdHJhaW5pbmcvYXJ0aWNsZXMvdXNlci1kYXRhLWlkcyI+QmVzdCBwcmFjdGljZXMgZm9yIHVuaXF1ZSBpZGVudGlmaWVyczwvYT4pLiBUaGlzCiAgICAgKiBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBiZWVuIGdyYW50ZWQgdGhlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uOyB0aGlzCiAgICAgKiAgICAgaXMgYSBwcml2aWxlZ2VkIHBlcm1pc3Npb24gdGhhdCBjYW4gb25seSBiZSBncmFudGVkIHRvIGFwcHMgcHJlbG9hZGVkIG9uIHRoZSBkZXZpY2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGV2aWNlIG9yIHByb2ZpbGUgb3duZXIgYW5kIGhhcyBiZWVuIGdyYW50ZWQgdGhlCiAgICAgKiAgICAge0BsaW5rIE1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gcGVybWlzc2lvbi4gVGhlIHByb2ZpbGUgb3duZXIgaXMgYW4gYXBwIHRoYXQKICAgICAqICAgICBvd25zIGEgbWFuYWdlZCBwcm9maWxlIG9uIHRoZSBkZXZpY2U7IGZvciBtb3JlIGRldGFpbHMgc2VlIDxhCiAgICAgKiAgICAgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vd29yay9tYW5hZ2VkLXByb2ZpbGVzIj5Xb3JrIHByb2ZpbGVzPC9hPi4KICAgICAqICAgICBQcm9maWxlIG93bmVyIGFjY2VzcyBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgcmVsZWFzZS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkgb24gYW55CiAgICAgKiAgICAgYWN0aXZlIHN1YnNjcmlwdGlvbi4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRoZSBkZWZhdWx0IFNNUyByb2xlIGhvbGRlciAoc2VlIHtAbGluawogICAgICogICAgIFJvbGVNYW5hZ2VyI2lzUm9sZUhlbGQoU3RyaW5nKX0pLgogICAgICogPC91bD4KICAgICAqCiAgICAgKiA8cD5JZiB0aGUgY2FsbGluZyBhcHAgZG9lcyBub3QgbWVldCBvbmUgb2YgdGhlc2UgcmVxdWlyZW1lbnRzIHRoZW4gdGhpcyBtZXRob2Qgd2lsbCBiZWhhdmUKICAgICAqIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogPHVsPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBoYXMgdGhlCiAgICAgKiAgICAgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uIHRoZW4gbnVsbCBpcyByZXR1cm5lZC48L2xpPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBkb2VzIG5vdCBoYXZlCiAgICAgKiAgICAgdGhlIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiwgb3IgaWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRhcmdldGluZyBBUEkgbGV2ZWwgMjkgb3IKICAgICAqICAgICBoaWdoZXIsIHRoZW4gYSBTZWN1cml0eUV4Y2VwdGlvbiBpcyB0aHJvd24uPC9saT4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCBvZiB3aGljaCBNRUlEIGlzIHJldHVybmVkCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gTm8gc3VwcG9ydCBmb3IgZGV2aWNlIC8gcHJvZmlsZSBvd25lciBvciBjYXJyaWVyIHByaXZpbGVnZXMgKGIvNzI5NjcyMzYpLgogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN0cmluZyBnZXRNZWlkKGludCBzbG90SW5kZXgpIHsKICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBTdHJpbmcgbWVpZCA9IHRlbGVwaG9ueS5nZXRNZWlkRm9yU2xvdChzbG90SW5kZXgsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgaWYgKFRleHRVdGlscy5pc0VtcHR5KG1laWQpKSB7CiAgICAgICAgICAgICAgICBMb2cuZChUQUcsICJnZXRNZWlkOiByZXR1cm4gbnVsbCBiZWNhdXNlIE1FSUQgaXMgbm90IGF2YWlsYWJsZSIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1laWQ7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE1hbnVmYWN0dXJlciBDb2RlIGZyb20gdGhlIE1FSUQuIFJldHVybiBudWxsIGlmIE1hbnVmYWN0dXJlciBDb2RlIGlzIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TWFudWZhY3R1cmVyQ29kZSgpIHsKICAgICAgICByZXR1cm4gZ2V0TWFudWZhY3R1cmVyQ29kZShnZXRTbG90SW5kZXgoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNYW51ZmFjdHVyZXIgQ29kZSBmcm9tIHRoZSBNRUlELiBSZXR1cm4gbnVsbCBpZiBNYW51ZmFjdHVyZXIgQ29kZSBpcyBub3QKICAgICAqIGF2YWlsYWJsZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IG9mIHdoaWNoIFR5cGUgQWxsb2NhdGlvbiBDb2RlIGlzIHJldHVybmVkCiAgICAgKi8KICAgIEBOdWxsYWJsZQogICAgcHVibGljIFN0cmluZyBnZXRNYW51ZmFjdHVyZXJDb2RlKGludCBzbG90SW5kZXgpIHsKICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldE1hbnVmYWN0dXJlckNvZGVGb3JTbG90KHNsb3RJbmRleCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE5ldHdvcmsgQWNjZXNzIElkZW50aWZpZXIgKE5BSSkuIFJldHVybiBudWxsIGlmIE5BSSBpcyBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRlZmF1bHQgU01TIHJvbGUgaG9sZGVyIChzZWUge0BsaW5rCiAgICAgKiAgICAgUm9sZU1hbmFnZXIjaXNSb2xlSGVsZChTdHJpbmcpfSkuCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPklmIHRoZSBjYWxsaW5nIGFwcCBkb2VzIG5vdCBtZWV0IG9uZSBvZiB0aGVzZSByZXF1aXJlbWVudHMgdGhlbiB0aGlzIG1ldGhvZCB3aWxsIGJlaGF2ZQogICAgICogYXMgZm9sbG93czoKICAgICAqCiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGhhcyB0aGUKICAgICAqICAgICBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24gdGhlbiBudWxsIGlzIHJldHVybmVkLjwvbGk+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGRvZXMgbm90IGhhdmUKICAgICAqICAgICB0aGUgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLCBvciBpZiB0aGUgY2FsbGluZyBhcHAgaXMgdGFyZ2V0aW5nIEFQSSBsZXZlbCAyOSBvcgogICAgICogICAgIGhpZ2hlciwgdGhlbiBhIFNlY3VyaXR5RXhjZXB0aW9uIGlzIHRocm93bi48L2xpPgogICAgICogPC91bD4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBObyBzdXBwb3J0IGZvciBkZXZpY2UgLyBwcm9maWxlIG93bmVyIG9yIGNhcnJpZXIgcHJpdmlsZWdlcyAoYi83Mjk2NzIzNikuCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldE5haSgpIHsKICAgICAgICByZXR1cm4gZ2V0TmFpQnlTdWJzY3JpYmVySWQoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBOQUkuIFJldHVybiBudWxsIGlmIE5BSSBpcyBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRlZmF1bHQgU01TIHJvbGUgaG9sZGVyIChzZWUge0BsaW5rCiAgICAgKiAgICAgUm9sZU1hbmFnZXIjaXNSb2xlSGVsZChTdHJpbmcpfSkuCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPklmIHRoZSBjYWxsaW5nIGFwcCBkb2VzIG5vdCBtZWV0IG9uZSBvZiB0aGVzZSByZXF1aXJlbWVudHMgdGhlbiB0aGlzIG1ldGhvZCB3aWxsIGJlaGF2ZQogICAgICogYXMgZm9sbG93czoKICAgICAqCiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGhhcyB0aGUKICAgICAqICAgICBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24gdGhlbiBudWxsIGlzIHJldHVybmVkLjwvbGk+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGRvZXMgbm90IGhhdmUKICAgICAqICAgICB0aGUgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLCBvciBpZiB0aGUgY2FsbGluZyBhcHAgaXMgdGFyZ2V0aW5nIEFQSSBsZXZlbCAyOSBvcgogICAgICogICAgIGhpZ2hlciwgdGhlbiBhIFNlY3VyaXR5RXhjZXB0aW9uIGlzIHRocm93bi48L2xpPgogICAgICogPC91bD4KICAgICAqCiAgICAgKiAgQHBhcmFtIHNsb3RJbmRleCBvZiB3aGljaCBOYWkgaXMgcmV0dXJuZWQKICAgICAqLwogICAgLyoqIHtAaGlkZX0qLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmFpKGludCBzbG90SW5kZXgpIHsKICAgICAgICBpbnRbXSBzdWJJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0U3ViSWQoc2xvdEluZGV4KTsKICAgICAgICBpZiAoc3ViSWQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldE5haUJ5U3Vic2NyaWJlcklkKHN1YklkWzBdKTsKICAgIH0KCiAgICBwcml2YXRlIFN0cmluZyBnZXROYWlCeVN1YnNjcmliZXJJZChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBTdHJpbmcgbmFpID0gaW5mby5nZXROYWlGb3JTdWJzY3JpYmVyKHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIGlmIChMb2cuaXNMb2dnYWJsZShUQUcsIExvZy5WRVJCT1NFKSkgewogICAgICAgICAgICAgICAgUmxvZy52KFRBRywgIk5haSA9ICIgKyBuYWkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuYWk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgbG9jYXRpb24gb2YgdGhlIGRldmljZS4KICAgICAqPHA+CiAgICAgKiBJZiB0aGVyZSBpcyBvbmx5IG9uZSByYWRpbyBpbiB0aGUgZGV2aWNlIGFuZCB0aGF0IHJhZGlvIGhhcyBhbiBMVEUgY29ubmVjdGlvbiwKICAgICAqIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIG51bGwuIFRoZSBpbXBsZW1lbnRhdGlvbiBtdXN0IG5vdCB0byB0cnkgYWRkIExURQogICAgICogaWRlbnRpZmllcnMgaW50byB0aGUgZXhpc3RpbmcgY2RtYS9nc20gY2xhc3Nlcy4KICAgICAqPHA+CiAgICAgKiBAcmV0dXJuIEN1cnJlbnQgbG9jYXRpb24gb2YgdGhlIGRldmljZSBvciBudWxsIGlmIG5vdCBhdmFpbGFibGUuCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgdXNlIHtAbGluayAjZ2V0QWxsQ2VsbEluZm99IGluc3RlYWQsIHdoaWNoIHJldHVybnMgYSBzdXBlcnNldCBvZiB0aGlzIEFQSS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLkFDQ0VTU19GSU5FX0xPQ0FUSU9OKQogICAgcHVibGljIENlbGxMb2NhdGlvbiBnZXRDZWxsTG9jYXRpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmxvZy5kKFRBRywgImdldENlbGxMb2NhdGlvbiByZXR1cm5pbmcgbnVsbCBiZWNhdXNlIHRlbGVwaG9ueSBpcyBudWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQ2VsbElkZW50aXR5IGNlbGxJZGVudGl0eSA9IHRlbGVwaG9ueS5nZXRDZWxsTG9jYXRpb24obUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICBDZWxsTG9jYXRpb24gY2wgPSBjZWxsSWRlbnRpdHkuYXNDZWxsTG9jYXRpb24oKTsKICAgICAgICAgICAgaWYgKGNsID09IG51bGwgfHwgY2wuaXNFbXB0eSgpKSB7CiAgICAgICAgICAgICAgICBSbG9nLmQoVEFHLCAiZ2V0Q2VsbExvY2F0aW9uIHJldHVybmluZyBudWxsIGJlY2F1c2UgQ2VsbExvY2F0aW9uIGlzIGVtcHR5IG9yIgogICAgICAgICAgICAgICAgICAgICAgICArICIgcGhvbmUgdHlwZSBkb2Vzbid0IG1hdGNoIENlbGxMb2NhdGlvbiB0eXBlIik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNsOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmQoVEFHLCAiZ2V0Q2VsbExvY2F0aW9uIHJldHVybmluZyBudWxsIGR1ZSB0byBSZW1vdGVFeGNlcHRpb24gIiArIGV4KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlcyBsb2NhdGlvbiB1cGRhdGUgbm90aWZpY2F0aW9ucy4gIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjb25DZWxsTG9jYXRpb25DaGFuZ2VkCiAgICAgKiBQaG9uZVN0YXRlTGlzdGVuZXIub25DZWxsTG9jYXRpb25DaGFuZ2VkfSB3aWxsIGJlIGNhbGxlZCBvbiBsb2NhdGlvbiB1cGRhdGVzLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLkNPTlRST0xfTE9DQVRJT05fVVBEQVRFUykKICAgIHB1YmxpYyB2b2lkIGVuYWJsZUxvY2F0aW9uVXBkYXRlcygpIHsKICAgICAgICBlbmFibGVMb2NhdGlvblVwZGF0ZXMoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFbmFibGVzIGxvY2F0aW9uIHVwZGF0ZSBub3RpZmljYXRpb25zIGZvciBhIHN1YnNjcmlwdGlvbi4KICAgICAqIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjb25DZWxsTG9jYXRpb25DaGFuZ2VkCiAgICAgKiBQaG9uZVN0YXRlTGlzdGVuZXIub25DZWxsTG9jYXRpb25DaGFuZ2VkfSB3aWxsIGJlIGNhbGxlZCBvbiBsb2NhdGlvbiB1cGRhdGVzLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBmb3Igd2hpY2ggdGhlIGxvY2F0aW9uIHVwZGF0ZXMgYXJlIGVuYWJsZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLkNPTlRST0xfTE9DQVRJT05fVVBEQVRFUykKICAgIHB1YmxpYyB2b2lkIGVuYWJsZUxvY2F0aW9uVXBkYXRlcyhpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgdGVsZXBob255LmVuYWJsZUxvY2F0aW9uVXBkYXRlc0ZvclN1YnNjcmliZXIoc3ViSWQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzYWJsZXMgbG9jYXRpb24gdXBkYXRlIG5vdGlmaWNhdGlvbnMuICB7QGxpbmsgUGhvbmVTdGF0ZUxpc3RlbmVyI29uQ2VsbExvY2F0aW9uQ2hhbmdlZAogICAgICogUGhvbmVTdGF0ZUxpc3RlbmVyLm9uQ2VsbExvY2F0aW9uQ2hhbmdlZH0gd2lsbCBiZSBjYWxsZWQgb24gbG9jYXRpb24gdXBkYXRlcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5DT05UUk9MX0xPQ0FUSU9OX1VQREFURVMpCiAgICBwdWJsaWMgdm9pZCBkaXNhYmxlTG9jYXRpb25VcGRhdGVzKCkgewogICAgICAgIGRpc2FibGVMb2NhdGlvblVwZGF0ZXMoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgdm9pZCBkaXNhYmxlTG9jYXRpb25VcGRhdGVzKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuZGlzYWJsZUxvY2F0aW9uVXBkYXRlc0ZvclN1YnNjcmliZXIoc3ViSWQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbmVpZ2hib3JpbmcgY2VsbCBpbmZvcm1hdGlvbiBvZiB0aGUgZGV2aWNlLgogICAgICoKICAgICAqIEByZXR1cm4gTGlzdCBvZiBOZWlnaGJvcmluZ0NlbGxJbmZvIG9yIG51bGwgaWYgaW5mbyB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiBAcmVtb3ZlZAogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZ2V0QWxsQ2VsbEluZm99IHdoaWNoIHJldHVybnMgYSBzdXBlcnNldCBvZiB0aGUgaW5mb3JtYXRpb24KICAgICAqICAgICAgICAgICAgIGZyb20gTmVpZ2hib3JpbmdDZWxsSW5mbywgaW5jbHVkaW5nIExURSBjZWxsIGluZm9ybWF0aW9uLgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uQUNDRVNTX0NPQVJTRV9MT0NBVElPTikKICAgIHB1YmxpYyBMaXN0PE5laWdoYm9yaW5nQ2VsbEluZm8+IGdldE5laWdoYm9yaW5nQ2VsbEluZm8oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldE5laWdoYm9yaW5nQ2VsbEluZm8obUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqIE5vIHBob25lIHJhZGlvLiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUEhPTkVfVFlQRV9OT05FID0gUGhvbmVDb25zdGFudHMuUEhPTkVfVFlQRV9OT05FOwogICAgLyoqIFBob25lIHJhZGlvIGlzIEdTTS4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX1RZUEVfR1NNID0gUGhvbmVDb25zdGFudHMuUEhPTkVfVFlQRV9HU007CiAgICAvKiogUGhvbmUgcmFkaW8gaXMgQ0RNQS4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX1RZUEVfQ0RNQSA9IFBob25lQ29uc3RhbnRzLlBIT05FX1RZUEVfQ0RNQTsKICAgIC8qKiBQaG9uZSBpcyB2aWEgU0lQLiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUEhPTkVfVFlQRV9TSVAgPSBQaG9uZUNvbnN0YW50cy5QSE9ORV9UWVBFX1NJUDsKCiAgICAvKioKICAgICAqIFBob25lIGlzIHZpYSBJTVMuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUEhPTkVfVFlQRV9JTVMgPSBQaG9uZUNvbnN0YW50cy5QSE9ORV9UWVBFX0lNUzsKCiAgICAvKioKICAgICAqIFBob25lIGlzIHZpYSBUaGlyZCBQYXJ0eS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQSE9ORV9UWVBFX1RISVJEX1BBUlRZID0gUGhvbmVDb25zdGFudHMuUEhPTkVfVFlQRV9USElSRF9QQVJUWTsKCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGhvbmUgdHlwZS4KICAgICAqIFRPRE86IFRoaXMgaXMgYSBsYXN0IG1pbnV0ZSBjaGFuZ2UgYW5kIGhlbmNlIGhpZGRlbi4KICAgICAqCiAgICAgKiBAc2VlICNQSE9ORV9UWVBFX05PTkUKICAgICAqIEBzZWUgI1BIT05FX1RZUEVfR1NNCiAgICAgKiBAc2VlICNQSE9ORV9UWVBFX0NETUEKICAgICAqIEBzZWUgI1BIT05FX1RZUEVfU0lQCiAgICAgKgogICAgICoge0BoaWRlfQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgaW50IGdldEN1cnJlbnRQaG9uZVR5cGUoKSB7CiAgICAgICAgcmV0dXJuIGdldEN1cnJlbnRQaG9uZVR5cGUoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgY29uc3RhbnQgaW5kaWNhdGluZyB0aGUgZGV2aWNlIHBob25lIHR5cGUgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIEBzZWUgI1BIT05FX1RZUEVfTk9ORQogICAgICogQHNlZSAjUEhPTkVfVFlQRV9HU00KICAgICAqIEBzZWUgI1BIT05FX1RZUEVfQ0RNQQogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBmb3Igd2hpY2ggcGhvbmUgdHlwZSBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGludCBnZXRDdXJyZW50UGhvbmVUeXBlKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkOwogICAgICAgIGlmIChzdWJJZCA9PSBTdWJzY3JpcHRpb25NYW5hZ2VyLklOVkFMSURfU1VCU0NSSVBUSU9OX0lEKSB7CiAgICAgICAgICAgIC8vIGlmIHdlIGRvbid0IGhhdmUgYW55IHNpbXMsIHdlIGRvbid0IGhhdmUgc3Vic2NyaXB0aW9ucywgYnV0IHdlCiAgICAgICAgICAgIC8vIHN0aWxsIG1heSB3YW50IHRvIGtub3cgd2hhdCB0eXBlIG9mIHBob25lIHdlJ3ZlIGdvdC4KICAgICAgICAgICAgcGhvbmVJZCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGhvbmVJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0UGhvbmVJZChzdWJJZCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0Q3VycmVudFBob25lVHlwZUZvclNsb3QocGhvbmVJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZWUgZ2V0Q3VycmVudFBob25lVHlwZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgaW50IGdldEN1cnJlbnRQaG9uZVR5cGVGb3JTbG90KGludCBzbG90SW5kZXgpIHsKICAgICAgICB0cnl7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0QWN0aXZlUGhvbmVUeXBlRm9yU2xvdChzbG90SW5kZXgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIHdoZW4gdGhlIElUZWxlcGhvbnkgaW50ZXJmYWNlIGlzIG5vdCB1cCB5ZXQuCiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0UGhvbmVUeXBlRnJvbVByb3BlcnR5KHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBzaG91bGRuJ3QgaGFwcGVuIGluIHRoZSBub3JtYWwgY2FzZSwgYXMgYSBiYWNrdXAgd2UKICAgICAgICAgICAgLy8gcmVhZCBmcm9tIHRoZSBzeXN0ZW0gcHJvcGVydHkuCiAgICAgICAgICAgIHJldHVybiBnZXRQaG9uZVR5cGVGcm9tUHJvcGVydHkoc2xvdEluZGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIHNob3VsZG4ndCBoYXBwZW4gaW4gdGhlIG5vcm1hbCBjYXNlLCBhcyBhIGJhY2t1cCB3ZQogICAgICAgICAgICAvLyByZWFkIGZyb20gdGhlIHN5c3RlbSBwcm9wZXJ0eS4KICAgICAgICAgICAgcmV0dXJuIGdldFBob25lVHlwZUZyb21Qcm9wZXJ0eShzbG90SW5kZXgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSBkZXZpY2UgcGhvbmUgdHlwZS4gIFRoaXMKICAgICAqIGluZGljYXRlcyB0aGUgdHlwZSBvZiByYWRpbyB1c2VkIHRvIHRyYW5zbWl0IHZvaWNlIGNhbGxzLgogICAgICoKICAgICAqIEBzZWUgI1BIT05FX1RZUEVfTk9ORQogICAgICogQHNlZSAjUEhPTkVfVFlQRV9HU00KICAgICAqIEBzZWUgI1BIT05FX1RZUEVfQ0RNQQogICAgICogQHNlZSAjUEhPTkVfVFlQRV9TSVAKICAgICAqLwogICAgcHVibGljIGludCBnZXRQaG9uZVR5cGUoKSB7CiAgICAgICAgaWYgKCFpc1ZvaWNlQ2FwYWJsZSgpKSB7CiAgICAgICAgICAgIHJldHVybiBQSE9ORV9UWVBFX05PTkU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRDdXJyZW50UGhvbmVUeXBlKCk7CiAgICB9CgogICAgcHJpdmF0ZSBpbnQgZ2V0UGhvbmVUeXBlRnJvbVByb3BlcnR5KCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZVR5cGVGcm9tUHJvcGVydHkoZ2V0UGhvbmVJZCgpKTsKICAgIH0KCiAgICAvKioge0BoaWRlfSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHByaXZhdGUgaW50IGdldFBob25lVHlwZUZyb21Qcm9wZXJ0eShpbnQgcGhvbmVJZCkgewogICAgICAgIEludGVnZXIgdHlwZSA9IGdldFRlbGVwaG9ueVByb3BlcnR5KAogICAgICAgICAgICAgICAgcGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5jdXJyZW50X2FjdGl2ZV9waG9uZSgpLCBudWxsKTsKICAgICAgICBpZiAodHlwZSAhPSBudWxsKSByZXR1cm4gdHlwZTsKICAgICAgICByZXR1cm4gZ2V0UGhvbmVUeXBlRnJvbU5ldHdvcmtUeXBlKHBob25lSWQpOwogICAgfQoKICAgIHByaXZhdGUgaW50IGdldFBob25lVHlwZUZyb21OZXR3b3JrVHlwZSgpIHsKICAgICAgICByZXR1cm4gZ2V0UGhvbmVUeXBlRnJvbU5ldHdvcmtUeXBlKGdldFBob25lSWQoKSk7CiAgICB9CgogICAgLyoqIHtAaGlkZX0gKi8KICAgIHByaXZhdGUgaW50IGdldFBob25lVHlwZUZyb21OZXR3b3JrVHlwZShpbnQgcGhvbmVJZCkgewogICAgICAgIC8vIFdoZW4gdGhlIHN5c3RlbSBwcm9wZXJ0eSBDVVJSRU5UX0FDVElWRV9QSE9ORSwgaGFzIG5vdCBiZWVuIHNldCwKICAgICAgICAvLyB1c2UgdGhlIHN5c3RlbSBwcm9wZXJ0eSBmb3IgZGVmYXVsdCBuZXR3b3JrIHR5cGUuCiAgICAgICAgLy8gVGhpcyBpcyBhIGZhaWwgc2FmZSwgYW5kIGNhbiBvbmx5IGhhcHBlbiBhdCBmaXJzdCBib290LgogICAgICAgIEludGVnZXIgbW9kZSA9IGdldFRlbGVwaG9ueVByb3BlcnR5KHBob25lSWQsIFRlbGVwaG9ueVByb3BlcnRpZXMuZGVmYXVsdF9uZXR3b3JrKCksIG51bGwpOwogICAgICAgIGlmIChtb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIFRlbGVwaG9ueU1hbmFnZXIuZ2V0UGhvbmVUeXBlKG1vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gVGVsZXBob255TWFuYWdlci5QSE9ORV9UWVBFX05PTkU7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIHR5cGUgb2YgdGhlIHBob25lLCBkZXBlbmRpbmcKICAgICAqIG9uIHRoZSBuZXR3b3JrIG1vZGUuCiAgICAgKgogICAgICogQHBhcmFtIG5ldHdvcmtNb2RlCiAgICAgKiBAcmV0dXJuIFBob25lIFR5cGUKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0UGhvbmVUeXBlKGludCBuZXR3b3JrTW9kZSkgewogICAgICAgIHN3aXRjaChuZXR3b3JrTW9kZSkgewogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9DRE1BOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9DRE1BX05PX0VWRE86CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0VWRE9fTk9fQ0RNQToKICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLlBIT05FX1RZUEVfQ0RNQTsKCiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX1dDRE1BX1BSRUY6CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0dTTV9PTkxZOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9XQ0RNQV9PTkxZOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9HU01fVU1UUzoKICAgICAgICBjYXNlIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTFRFX0dTTV9XQ0RNQToKICAgICAgICBjYXNlIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTFRFX1dDRE1BOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfQ0RNQV9FVkRPX0dTTV9XQ0RNQToKICAgICAgICBjYXNlIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfVERTQ0RNQV9PTkxZOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9URFNDRE1BX1dDRE1BOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfVERTQ0RNQToKICAgICAgICBjYXNlIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfVERTQ0RNQV9HU006CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9URFNDRE1BX0dTTToKICAgICAgICBjYXNlIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfVERTQ0RNQV9HU01fV0NETUE6CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9URFNDRE1BX1dDRE1BOgogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfVERTQ0RNQV9HU01fV0NETUE6CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9URFNDRE1BX0NETUFfRVZET19HU01fV0NETUE6CiAgICAgICAgICAgIHJldHVybiBQaG9uZUNvbnN0YW50cy5QSE9ORV9UWVBFX0dTTTsKCiAgICAgICAgLy8gVXNlIENETUEgUGhvbmUgZm9yIHRoZSBnbG9iYWwgbW9kZSBpbmNsdWRpbmcgQ0RNQQogICAgICAgIGNhc2UgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9HTE9CQUw6CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9DRE1BX0VWRE86CiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX1REU0NETUFfQ0RNQV9FVkRPX0dTTV9XQ0RNQToKICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLlBIT05FX1RZUEVfQ0RNQTsKCiAgICAgICAgY2FzZSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9PTkxZOgogICAgICAgICAgICBpZiAoZ2V0THRlT25DZG1hTW9kZVN0YXRpYygpID09IFBob25lQ29uc3RhbnRzLkxURV9PTl9DRE1BX1RSVUUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQaG9uZUNvbnN0YW50cy5QSE9ORV9UWVBFX0NETUE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuUEhPTkVfVFlQRV9HU007CiAgICAgICAgICAgIH0KICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuUEhPTkVfVFlQRV9HU007CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhlIGNvbnRlbnRzIG9mIHRoZSAvcHJvYy9jbWRsaW5lIGZpbGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHByaXZhdGUgc3RhdGljIFN0cmluZyBnZXRQcm9jQ21kTGluZSgpCiAgICB7CiAgICAgICAgU3RyaW5nIGNtZGxpbmUgPSAiIjsKICAgICAgICBGaWxlSW5wdXRTdHJlYW0gaXMgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlzID0gbmV3IEZpbGVJbnB1dFN0cmVhbSgiL3Byb2MvY21kbGluZSIpOwogICAgICAgICAgICBieXRlIFtdIGJ1ZmZlciA9IG5ldyBieXRlWzIwNDhdOwogICAgICAgICAgICBpbnQgY291bnQgPSBpcy5yZWFkKGJ1ZmZlcik7CiAgICAgICAgICAgIGlmIChjb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIGNtZGxpbmUgPSBuZXcgU3RyaW5nKGJ1ZmZlciwgMCwgY291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgewogICAgICAgICAgICBSbG9nLmQoVEFHLCAiTm8gL3Byb2MvY21kbGluZSBleGNlcHRpb249IiArIGUpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlmIChpcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgUmxvZy5kKFRBRywgIi9wcm9jL2NtZGxpbmU9IiArIGNtZGxpbmUpOwogICAgICAgIHJldHVybiBjbWRsaW5lOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiBUaGUgbWF4IHZhbHVlIGZvciB0aGUgdGltZW91dCBwYXNzZWQgaW4ge0BsaW5rICNyZXF1ZXN0TnVtYmVyVmVyaWZpY2F0aW9ufS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgbG9uZyBnZXRNYXhOdW1iZXJWZXJpZmljYXRpb25UaW1lb3V0TWlsbGlzKCkgewogICAgICAgIHJldHVybiBNQVhfTlVNQkVSX1ZFUklGSUNBVElPTl9USU1FT1VUX01JTExJUzsKICAgIH0KCiAgICAvKiogS2VybmVsIGNvbW1hbmQgbGluZSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgU3RyaW5nIHNLZXJuZWxDbWRMaW5lID0gZ2V0UHJvY0NtZExpbmUoKTsKCiAgICAvKiogUGF0dGVybiBmb3Igc2VsZWN0aW5nIHRoZSBwcm9kdWN0IHR5cGUgZnJvbSB0aGUga2VybmVsIGNvbW1hbmQgbGluZSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgUGF0dGVybiBzUHJvZHVjdFR5cGVQYXR0ZXJuID0KICAgICAgICBQYXR0ZXJuLmNvbXBpbGUoIlxcc3Byb2R1Y3RfdHlwZVxccyo9XFxzKihcXHcrKSIpOwoKICAgIC8qKiBUaGUgUHJvZHVjdFR5cGUgdXNlZCBmb3IgTFRFIG9uIENETUEgZGV2aWNlcyAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgU3RyaW5nIHNMdGVPbkNkbWFQcm9kdWN0VHlwZSA9CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMubHRlX29uX2NkbWFfcHJvZHVjdF90eXBlKCkub3JFbHNlKCIiKTsKCiAgICAvKioKICAgICAqIFJldHVybiBpZiB0aGUgY3VycmVudCByYWRpbyBpcyBMVEUgb24gQ0RNQS4gVGhpcwogICAgICogaXMgYSB0cmktc3RhdGUgcmV0dXJuIHZhbHVlIGFzIGZvciBhIHBlcmlvZCBvZiB0aW1lCiAgICAgKiB0aGUgbW9kZSBtYXkgYmUgdW5rbm93bi4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAbGluayBQaG9uZUNvbnN0YW50cyNMVEVfT05fQ0RNQV9VTktOT1dOfSwge0BsaW5rIFBob25lQ29uc3RhbnRzI0xURV9PTl9DRE1BX0ZBTFNFfQogICAgICogb3Ige0BsaW5rIFBob25lQ29uc3RhbnRzI0xURV9PTl9DRE1BX1RSVUV9CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldEx0ZU9uQ2RtYU1vZGVTdGF0aWMoKSB7CiAgICAgICAgaW50IHJldFZhbDsKICAgICAgICBpbnQgY3VyVmFsOwogICAgICAgIFN0cmluZyBwcm9kdWN0VHlwZSA9ICIiOwoKICAgICAgICBjdXJWYWwgPSBUZWxlcGhvbnlQcm9wZXJ0aWVzLmx0ZV9vbl9jZG1hX2RldmljZSgpLm9yRWxzZSgKICAgICAgICAgICAgUGhvbmVDb25zdGFudHMuTFRFX09OX0NETUFfVU5LTk9XTik7CiAgICAgICAgcmV0VmFsID0gY3VyVmFsOwogICAgICAgIGlmIChyZXRWYWwgPT0gUGhvbmVDb25zdGFudHMuTFRFX09OX0NETUFfVU5LTk9XTikgewogICAgICAgICAgICBNYXRjaGVyIG1hdGNoZXIgPSBzUHJvZHVjdFR5cGVQYXR0ZXJuLm1hdGNoZXIoc0tlcm5lbENtZExpbmUpOwogICAgICAgICAgICBpZiAobWF0Y2hlci5maW5kKCkpIHsKICAgICAgICAgICAgICAgIHByb2R1Y3RUeXBlID0gbWF0Y2hlci5ncm91cCgxKTsKICAgICAgICAgICAgICAgIGlmIChzTHRlT25DZG1hUHJvZHVjdFR5cGUuZXF1YWxzKHByb2R1Y3RUeXBlKSkgewogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IFBob25lQ29uc3RhbnRzLkxURV9PTl9DRE1BX1RSVUU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IFBob25lQ29uc3RhbnRzLkxURV9PTl9DRE1BX0ZBTFNFOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0VmFsID0gUGhvbmVDb25zdGFudHMuTFRFX09OX0NETUFfRkFMU0U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIFJsb2cuZChUQUcsICJnZXRMdGVPbkNkbWFNb2RlPSIgKyByZXRWYWwgKyAiIGN1clZhbD0iICsgY3VyVmFsICsKICAgICAgICAgICAgICAgICIgcHJvZHVjdF90eXBlPSciICsgcHJvZHVjdFR5cGUgKwogICAgICAgICAgICAgICAgIicgbHRlT25DZG1hUHJvZHVjdFR5cGU9JyIgKyBzTHRlT25DZG1hUHJvZHVjdFR5cGUgKyAiJyIpOwogICAgICAgIHJldHVybiByZXRWYWw7CiAgICB9CgogICAgLy8KICAgIC8vCiAgICAvLyBDdXJyZW50IE5ldHdvcmsKICAgIC8vCiAgICAvLwoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgYWxwaGFiZXRpYyBuYW1lIG9mIGN1cnJlbnQgcmVnaXN0ZXJlZCBvcGVyYXRvci4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBPbmx5IHdoZW4gdXNlciBpcyByZWdpc3RlcmVkIHRvIGEgbmV0d29yay4gUmVzdWx0IG1heSBiZQogICAgICogdW5yZWxpYWJsZSBvbiBDRE1BIG5ldHdvcmtzICh1c2Uge0BsaW5rICNnZXRQaG9uZVR5cGUoKX0gdG8gZGV0ZXJtaW5lIGlmCiAgICAgKiBvbiBhIENETUEgbmV0d29yaykuCiAgICAgKi8KICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmV0d29ya09wZXJhdG9yTmFtZSgpIHsKICAgICAgICByZXR1cm4gZ2V0TmV0d29ya09wZXJhdG9yTmFtZShnZXRTdWJJZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGFscGhhYmV0aWMgbmFtZSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IKICAgICAqIGZvciBhIHBhcnRpY3VsYXIgc3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIGlzIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLiBSZXN1bHQgbWF5IGJlCiAgICAgKiB1bnJlbGlhYmxlIG9uIENETUEgbmV0d29ya3MgKHVzZSB7QGxpbmsgI2dldFBob25lVHlwZSgpfSB0byBkZXRlcm1pbmUgaWYKICAgICAqIG9uIGEgQ0RNQSBuZXR3b3JrKS4KICAgICAqIEBwYXJhbSBzdWJJZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIFN0cmluZyBnZXROZXR3b3JrT3BlcmF0b3JOYW1lKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICByZXR1cm4gZ2V0VGVsZXBob255UHJvcGVydHkocGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5vcGVyYXRvcl9hbHBoYSgpLCAiIik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBudW1lcmljIG5hbWUgKE1DQytNTkMpIG9mIGN1cnJlbnQgcmVnaXN0ZXJlZCBvcGVyYXRvci4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBPbmx5IHdoZW4gdXNlciBpcyByZWdpc3RlcmVkIHRvIGEgbmV0d29yay4gUmVzdWx0IG1heSBiZQogICAgICogdW5yZWxpYWJsZSBvbiBDRE1BIG5ldHdvcmtzICh1c2Uge0BsaW5rICNnZXRQaG9uZVR5cGUoKX0gdG8gZGV0ZXJtaW5lIGlmCiAgICAgKiBvbiBhIENETUEgbmV0d29yaykuCiAgICAgKi8KICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmV0d29ya09wZXJhdG9yKCkgewogICAgICAgIHJldHVybiBnZXROZXR3b3JrT3BlcmF0b3JGb3JQaG9uZShnZXRQaG9uZUlkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbnVtZXJpYyBuYW1lIChNQ0MrTU5DKSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IKICAgICAqIGZvciBhIHBhcnRpY3VsYXIgc3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIGlzIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLiBSZXN1bHQgbWF5IGJlCiAgICAgKiB1bnJlbGlhYmxlIG9uIENETUEgbmV0d29ya3MgKHVzZSB7QGxpbmsgI2dldFBob25lVHlwZSgpfSB0byBkZXRlcm1pbmUgaWYKICAgICAqIG9uIGEgQ0RNQSBuZXR3b3JrKS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmV0d29ya09wZXJhdG9yKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICByZXR1cm4gZ2V0TmV0d29ya09wZXJhdG9yRm9yUGhvbmUocGhvbmVJZCk7CiAgICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbnVtZXJpYyBuYW1lIChNQ0MrTU5DKSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IKICAgICAqIGZvciBhIHBhcnRpY3VsYXIgc3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIGlzIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLiBSZXN1bHQgbWF5IGJlCiAgICAgKiB1bnJlbGlhYmxlIG9uIENETUEgbmV0d29ya3MgKHVzZSB7QGxpbmsgI2dldFBob25lVHlwZSgpfSB0byBkZXRlcm1pbmUgaWYKICAgICAqIG9uIGEgQ0RNQSBuZXR3b3JrKS4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVJZAogICAgICogQGhpZGUKICAgICAqKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldE5ldHdvcmtPcGVyYXRvckZvclBob25lKGludCBwaG9uZUlkKSB7CiAgICAgICAgcmV0dXJuIGdldFRlbGVwaG9ueVByb3BlcnR5KHBob25lSWQsIFRlbGVwaG9ueVByb3BlcnRpZXMub3BlcmF0b3JfbnVtZXJpYygpLCAiIik7CiAgICB9CgoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbmV0d29yayBzcGVjaWZpZXIgb2YgdGhlIHN1YnNjcmlwdGlvbiBJRCBwaW5uZWQgdG8gdGhlIFRlbGVwaG9ueU1hbmFnZXIuIFRoZQogICAgICogbmV0d29yayBzcGVjaWZpZXIgaXMgdXNlZCBieSB7QGxpbmsKICAgICAqIGFuZHJvaWQubmV0Lk5ldHdvcmtSZXF1ZXN0LkJ1aWxkZXIjc2V0TmV0d29ya1NwZWNpZmllcihTdHJpbmcpfSB0byBjcmVhdGUgYSB7QGxpbmsKICAgICAqIGFuZHJvaWQubmV0Lk5ldHdvcmtSZXF1ZXN0fSB0aGF0IGNvbm5lY3RzIHRocm91Z2ggdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAc2VlIGFuZHJvaWQubmV0Lk5ldHdvcmtSZXF1ZXN0LkJ1aWxkZXIjc2V0TmV0d29ya1NwZWNpZmllcihTdHJpbmcpCiAgICAgKiBAc2VlICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZChpbnQpCiAgICAgKiBAc2VlICNjcmVhdGVGb3JQaG9uZUFjY291bnRIYW5kbGUoUGhvbmVBY2NvdW50SGFuZGxlKQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldE5ldHdvcmtTcGVjaWZpZXIoKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZy52YWx1ZU9mKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgY2FycmllciBjb25maWcgb2YgdGhlIHN1YnNjcmlwdGlvbiBJRCBwaW5uZWQgdG8gdGhlIFRlbGVwaG9ueU1hbmFnZXIuIElmIGFuCiAgICAgKiBpbnZhbGlkIHN1YnNjcmlwdGlvbiBJRCBpcyBwaW5uZWQgdG8gdGhlIFRlbGVwaG9ueU1hbmFnZXIsIHRoZSByZXR1cm5lZCBjb25maWcgd2lsbCBjb250YWluCiAgICAgKiBkZWZhdWx0IHZhbHVlcy4KICAgICAqCiAgICAgKiA8cD5UaGlzIG1ldGhvZCBtYXkgdGFrZSBzZXZlcmFsIHNlY29uZHMgdG8gY29tcGxldGUsIHNvIGl0IHNob3VsZCBvbmx5IGJlIGNhbGxlZCBmcm9tIGEKICAgICAqIHdvcmtlciB0aHJlYWQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBzZWUgQ2FycmllckNvbmZpZ01hbmFnZXIjZ2V0Q29uZmlnRm9yU3ViSWQoaW50KQogICAgICogQHNlZSAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWQoaW50KQogICAgICogQHNlZSAjY3JlYXRlRm9yUGhvbmVBY2NvdW50SGFuZGxlKFBob25lQWNjb3VudEhhbmRsZSkKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBXb3JrZXJUaHJlYWQKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgUGVyc2lzdGFibGVCdW5kbGUgZ2V0Q2FycmllckNvbmZpZygpIHsKICAgICAgICBDYXJyaWVyQ29uZmlnTWFuYWdlciBjYXJyaWVyQ29uZmlnTWFuYWdlciA9IG1Db250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDYXJyaWVyQ29uZmlnTWFuYWdlci5jbGFzcyk7CiAgICAgICAgcmV0dXJuIGNhcnJpZXJDb25maWdNYW5hZ2VyLmdldENvbmZpZ0ZvclN1YklkKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBkZXZpY2UgaXMgY29uc2lkZXJlZCByb2FtaW5nIG9uIHRoZSBjdXJyZW50CiAgICAgKiBuZXR3b3JrLCBmb3IgR1NNIHB1cnBvc2VzLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc05ldHdvcmtSb2FtaW5nKCkgewogICAgICAgIHJldHVybiBpc05ldHdvcmtSb2FtaW5nKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBkZXZpY2UgaXMgY29uc2lkZXJlZCByb2FtaW5nIG9uIHRoZSBjdXJyZW50CiAgICAgKiBuZXR3b3JrIGZvciBhIHN1YnNjcmlwdGlvbi4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBPbmx5IHdoZW4gdXNlciByZWdpc3RlcmVkIHRvIGEgbmV0d29yay4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBpc05ldHdvcmtSb2FtaW5nKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICByZXR1cm4gZ2V0VGVsZXBob255UHJvcGVydHkocGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5vcGVyYXRvcl9pc19yb2FtaW5nKCksIGZhbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElTTy0zMTY2LTEgYWxwaGEtMiBjb3VudHJ5IGNvZGUgZXF1aXZhbGVudCBvZiB0aGUgTUNDIChNb2JpbGUgQ291bnRyeSBDb2RlKSBvZgogICAgICogdGhlIGN1cnJlbnQgcmVnaXN0ZXJlZCBvcGVyYXRvciBvciB0aGUgY2VsbCBuZWFyYnksIGlmIGF2YWlsYWJsZS4KICAgICAqCiAgICAgKiBOb3RlOiBSZXN1bHQgbWF5IGJlIHVucmVsaWFibGUgb24gQ0RNQSBuZXR3b3JrcyAodXNlIHtAbGluayAjZ2V0UGhvbmVUeXBlKCl9IHRvIGRldGVybWluZQogICAgICogaWYgb24gYSBDRE1BIG5ldHdvcmspLgogICAgICogPHA+CiAgICAgKiBAcmV0dXJuIHRoZSBsb3dlcmNhc2UgMiBjaGFyYWN0ZXIgSVNPLTMxNjYtMSBhbHBoYS0yIGNvdW50cnkgY29kZSwgb3IgZW1wdHkgc3RyaW5nIGlmIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldE5ldHdvcmtDb3VudHJ5SXNvKCkgewogICAgICAgIHJldHVybiBnZXROZXR3b3JrQ291bnRyeUlzbyhnZXRTbG90SW5kZXgoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBJU08tMzE2Ni0xIGFscGhhLTIgY291bnRyeSBjb2RlIGVxdWl2YWxlbnQgb2YgdGhlIE1DQyAoTW9iaWxlIENvdW50cnkgQ29kZSkgb2YKICAgICAqIHRoZSBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3Igb3IgdGhlIGNlbGwgbmVhcmJ5LCBpZiBhdmFpbGFibGUuIFRoaXMgaXMgc2FtZSBhcwogICAgICoge0BsaW5rICNnZXROZXR3b3JrQ291bnRyeUlzbygpfSBidXQgYWxsb3dpbmcgc3BlY2lmeWluZyB0aGUgU0lNIHNsb3QgaW5kZXguIFRoaXMgaXMgdXNlZCBmb3IKICAgICAqIGFjY2Vzc2luZyBuZXR3b3JrIGNvdW50cnkgaW5mbyBmcm9tIHRoZSBTSU0gc2xvdCB0aGF0IGRvZXMgbm90IGhhdmUgU0lNIGluc2VydGVkLgogICAgICoKICAgICAqIE5vdGU6IFJlc3VsdCBtYXkgYmUgdW5yZWxpYWJsZSBvbiBDRE1BIG5ldHdvcmtzICh1c2Uge0BsaW5rICNnZXRQaG9uZVR5cGUoKX0gdG8gZGV0ZXJtaW5lCiAgICAgKiBpZiBvbiBhIENETUEgbmV0d29yaykuCiAgICAgKiA8cD4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBTSU0gc2xvdCBpbmRleCB0byBnZXQgbmV0d29yayBjb3VudHJ5IElTTy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsb3dlcmNhc2UgMiBjaGFyYWN0ZXIgSVNPLTMxNjYtMSBhbHBoYS0yIGNvdW50cnkgY29kZSwgb3IgZW1wdHkgc3RyaW5nIGlmIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICoKICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIHdoZW4gdGhlIHNsb3RJbmRleCBpcyBpbnZhbGlkLgogICAgICoKICAgICAqLwogICAgQE5vbk51bGwKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmV0d29ya0NvdW50cnlJc28oaW50IHNsb3RJbmRleCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChzbG90SW5kZXggIT0gU3Vic2NyaXB0aW9uTWFuYWdlci5ERUZBVUxUX1NJTV9TTE9UX0lOREVYCiAgICAgICAgICAgICAgICAgICAgJiYgIVN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJpbnZhbGlkIHNsb3QgaW5kZXggIiArIHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiAiIjsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXROZXR3b3JrQ291bnRyeUlzb0ZvclBob25lKHNsb3RJbmRleCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZ2V0TmV0d29ya0NvdW50cnlJc28oaW50KX0gaW5zdGVhZC4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUSwKICAgICAgICAgICAgcHVibGljQWx0ZXJuYXRpdmVzID0gIlVzZSB7QGxpbmsgI2dldE5ldHdvcmtDb3VudHJ5SXNvKGludCl9IGluc3RlYWQuIikKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TmV0d29ya0NvdW50cnlJc29Gb3JQaG9uZShpbnQgcGhvbmVJZCkgewogICAgICAgIHJldHVybiBnZXROZXR3b3JrQ291bnRyeUlzbyhwaG9uZUlkKTsKICAgIH0KCiAgICAvKgogICAgICogV2hlbiBhZGRpbmcgYSBuZXR3b3JrIHR5cGUgdG8gdGhlIGxpc3QgYmVsb3csIG1ha2Ugc3VyZSB0byBhZGQgdGhlIGNvcnJlY3QgaWNvbiB0bwogICAgICogTW9iaWxlU2lnbmFsQ29udHJvbGxlci5tYXBJY29uU2V0cygpIGFzIHdlbGwgYXMgTkVUV09SS19UWVBFUwogICAgICogRG8gbm90IGFkZCBuZWdhdGl2ZSB0eXBlcy4KICAgICAqLwogICAgLyoqIE5ldHdvcmsgdHlwZSBpcyB1bmtub3duICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfVU5LTk9XTiA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX1VOS05PV047IC8vID0gMC4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgR1BSUyAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0dQUlMgPSBUZWxlcGhvbnlQcm90b0VudW1zLk5FVFdPUktfVFlQRV9HUFJTOyAvLyA9IDEuCiAgICAvKiogQ3VycmVudCBuZXR3b3JrIGlzIEVER0UgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfVFlQRV9FREdFID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfRURHRTsgLy8gPSAyLgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBVTVRTICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfVU1UUyA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX1VNVFM7IC8vID0gMy4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgQ0RNQTogRWl0aGVyIElTOTVBIG9yIElTOTVCKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfVFlQRV9DRE1BID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfQ0RNQTsgLy8gPSA0LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBFVkRPIHJldmlzaW9uIDAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0VWRE9fMCA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX0VWRE9fMDsgLy8gPSA1LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBFVkRPIHJldmlzaW9uIEEqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0VWRE9fQSA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX0VWRE9fQTsgLy8gPSA2LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyAxeFJUVCovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfMXhSVFQgPSBUZWxlcGhvbnlQcm90b0VudW1zLk5FVFdPUktfVFlQRV8xWFJUVDsgLy8gPSA3LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBIU0RQQSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0hTRFBBID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfSFNEUEE7IC8vID0gOC4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgSFNVUEEgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfVFlQRV9IU1VQQSA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX0hTVVBBOyAvLyA9IDkuCiAgICAvKiogQ3VycmVudCBuZXR3b3JrIGlzIEhTUEEgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfVFlQRV9IU1BBID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfSFNQQTsgLy8gPSAxMC4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgaURlbiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0lERU4gPSBUZWxlcGhvbnlQcm90b0VudW1zLk5FVFdPUktfVFlQRV9JREVOOyAvLyA9IDExLgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBFVkRPIHJldmlzaW9uIEIqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0VWRE9fQiA9IFRlbGVwaG9ueVByb3RvRW51bXMuTkVUV09SS19UWVBFX0VWRE9fQjsgLy8gPSAxMi4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgTFRFICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfTFRFID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfTFRFOyAvLyA9IDEzLgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBlSFJQRCAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX0VIUlBEID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfRUhSUEQ7IC8vID0gMTQuCiAgICAvKiogQ3VycmVudCBuZXR3b3JrIGlzIEhTUEErICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfSFNQQVAgPSBUZWxlcGhvbnlQcm90b0VudW1zLk5FVFdPUktfVFlQRV9IU1BBUDsgLy8gPSAxNS4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgR1NNICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfR1NNID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfR1NNOyAvLyA9IDE2LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBURF9TQ0RNQSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX1REX1NDRE1BID0KICAgICAgICAgICAgVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfVERfU0NETUE7IC8vID0gMTcuCiAgICAvKiogQ3VycmVudCBuZXR3b3JrIGlzIElXTEFOICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfSVdMQU4gPSBUZWxlcGhvbnlQcm90b0VudW1zLk5FVFdPUktfVFlQRV9JV0xBTjsgLy8gPSAxOC4KICAgIC8qKiBDdXJyZW50IG5ldHdvcmsgaXMgTFRFX0NBIHtAaGlkZX0gKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX1RZUEVfTFRFX0NBID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfTFRFX0NBOyAvLyA9IDE5LgogICAgLyoqIEN1cnJlbnQgbmV0d29yayBpcyBOUihOZXcgUmFkaW8pIDVHLiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19UWVBFX05SID0gVGVsZXBob255UHJvdG9FbnVtcy5ORVRXT1JLX1RZUEVfTlI7IC8vIDIwLgoKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIEBOZXR3b3JrVHlwZSBpbnRbXSBORVRXT1JLX1RZUEVTID0gewogICAgICAgICAgICBORVRXT1JLX1RZUEVfR1BSUywKICAgICAgICAgICAgTkVUV09SS19UWVBFX0VER0UsCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9VTVRTLAogICAgICAgICAgICBORVRXT1JLX1RZUEVfQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19UWVBFX0VWRE9fMCwKICAgICAgICAgICAgTkVUV09SS19UWVBFX0VWRE9fQSwKICAgICAgICAgICAgTkVUV09SS19UWVBFXzF4UlRULAogICAgICAgICAgICBORVRXT1JLX1RZUEVfSFNEUEEsCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9IU1VQQSwKICAgICAgICAgICAgTkVUV09SS19UWVBFX0hTUEEsCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9JREVOLAogICAgICAgICAgICBORVRXT1JLX1RZUEVfRVZET19CLAogICAgICAgICAgICBORVRXT1JLX1RZUEVfTFRFLAogICAgICAgICAgICBORVRXT1JLX1RZUEVfRUhSUEQsCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9IU1BBUCwKICAgICAgICAgICAgTkVUV09SS19UWVBFX0dTTSwKICAgICAgICAgICAgTkVUV09SS19UWVBFX1REX1NDRE1BLAogICAgICAgICAgICBORVRXT1JLX1RZUEVfSVdMQU4sCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9MVEVfQ0EsCiAgICAgICAgICAgIE5FVFdPUktfVFlQRV9OUgogICAgfTsKCiAgICAvKioKICAgICAqIFJldHVybiBhIGNvbGxlY3Rpb24gb2YgYWxsIG5ldHdvcmsgdHlwZXMKICAgICAqIEByZXR1cm4gbmV0d29yayB0eXBlcwogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgQE5vbk51bGwgQE5ldHdvcmtUeXBlIGludFtdIGdldEFsbE5ldHdvcmtUeXBlcygpIHsKICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFUzsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgY3VycmVudCBkYXRhIG5ldHdvcmsgdHlwZS4KICAgICAqCiAgICAgKiBAZGVwcmVjYXRlZCB1c2Uge0BsaW5rICNnZXREYXRhTmV0d29ya1R5cGUoKX0KICAgICAqIEByZXR1cm4gdGhlIE5FVFdPUktfVFlQRV94eHh4IGZvciBjdXJyZW50IGRhdGEgY29ubmVjdGlvbi4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5ldHdvcmtUeXBlIGludCBnZXROZXR3b3JrVHlwZSgpIHsKICAgICAgICByZXR1cm4gZ2V0TmV0d29ya1R5cGUoZ2V0U3ViSWQoU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRBY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWQoKSkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHJhZGlvIHRlY2hub2xvZ3kgKG5ldHdvcmsgdHlwZSkKICAgICAqIGN1cnJlbnRseSBpbiB1c2Ugb24gdGhlIGRldmljZSBmb3IgYSBzdWJzY3JpcHRpb24uCiAgICAgKiBAcmV0dXJuIHRoZSBuZXR3b3JrIHR5cGUKICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgZm9yIHdoaWNoIG5ldHdvcmsgdHlwZSBpcyByZXR1cm5lZAogICAgICoKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9VTktOT1dOCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfR1BSUwogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0VER0UKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9VTVRTCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfSFNEUEEKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9IU1VQQQogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0hTUEEKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9DRE1BCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfRVZET18wCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfRVZET19BCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfRVZET19CCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfMXhSVFQKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9JREVOCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfTFRFCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfRUhSUEQKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9IU1BBUAogICAgICogQHNlZSAjTkVUV09SS19UWVBFX05SCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBpbnQgZ2V0TmV0d29ya1R5cGUoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXROZXR3b3JrVHlwZUZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gd2hlbiB0aGUgSVRlbGVwaG9ueSBpbnRlcmZhY2UgaXMgbm90IHVwIHlldC4KICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfVU5LTk9XTjsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIHNob3VsZG4ndCBoYXBwZW4gaW4gdGhlIG5vcm1hbCBjYXNlCiAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfVU5LTk9XTjsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfVU5LTk9XTjsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgY29uc3RhbnQgaW5kaWNhdGluZyB0aGUgcmFkaW8gdGVjaG5vbG9neSAobmV0d29yayB0eXBlKQogICAgICogY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlIGZvciBkYXRhIHRyYW5zbWlzc2lvbi4KICAgICAqCiAgICAgKiBJZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlIGdpdmVuCiAgICAgKiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgbmV0d29yayB0eXBlCiAgICAgKgogICAgICogQHNlZSAjTkVUV09SS19UWVBFX1VOS05PV04KICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9HUFJTCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfRURHRQogICAgICogQHNlZSAjTkVUV09SS19UWVBFX1VNVFMKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9IU0RQQQogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0hTVVBBCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfSFNQQQogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0NETUEKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9FVkRPXzAKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9FVkRPX0EKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9FVkRPX0IKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV8xeFJUVAogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0lERU4KICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9MVEUKICAgICAqIEBzZWUgI05FVFdPUktfVFlQRV9FSFJQRAogICAgICogQHNlZSAjTkVUV09SS19UWVBFX0hTUEFQCiAgICAgKiBAc2VlICNORVRXT1JLX1RZUEVfTlIKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5ldHdvcmtUeXBlIGludCBnZXREYXRhTmV0d29ya1R5cGUoKSB7CiAgICAgICAgcmV0dXJuIGdldERhdGFOZXR3b3JrVHlwZShnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldEFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZCgpKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgY29uc3RhbnQgaW5kaWNhdGluZyB0aGUgcmFkaW8gdGVjaG5vbG9neSAobmV0d29yayB0eXBlKQogICAgICogY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlIGZvciBkYXRhIHRyYW5zbWlzc2lvbiBmb3IgYSBzdWJzY3JpcHRpb24KICAgICAqIEByZXR1cm4gdGhlIG5ldHdvcmsgdHlwZQogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBmb3Igd2hpY2ggbmV0d29yayB0eXBlIGlzIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIGludCBnZXREYXRhTmV0d29ya1R5cGUoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldERhdGFOZXR3b3JrVHlwZUZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gd2hlbiB0aGUgSVRlbGVwaG9ueSBpbnRlcmZhY2UgaXMgbm90IHVwIHlldC4KICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfVU5LTk9XTjsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2goUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgc2hvdWxkbid0IGhhcHBlbiBpbiB0aGUgbm9ybWFsIGNhc2UKICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9VTktOT1dOOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9VTktOT1dOOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE5FVFdPUktfVFlQRV94eHh4IGZvciB2b2ljZQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5ldHdvcmtUeXBlIGludCBnZXRWb2ljZU5ldHdvcmtUeXBlKCkgewogICAgICAgIHJldHVybiBnZXRWb2ljZU5ldHdvcmtUeXBlKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgTkVUV09SS19UWVBFX3h4eHggZm9yIHZvaWNlIGZvciBhIHN1YklkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIGludCBnZXRWb2ljZU5ldHdvcmtUeXBlKGludCBzdWJJZCkgewogICAgICAgIHRyeXsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRWb2ljZU5ldHdvcmtUeXBlRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiB3aGVuIHRoZSBJVGVsZXBob255IGludGVyZmFjZSBpcyBub3QgdXAgeWV0LgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9VTktOT1dOOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBzaG91bGRuJ3QgaGFwcGVuIGluIHRoZSBub3JtYWwgY2FzZQogICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX1VOS05PV047CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX1VOS05PV047CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmFkaW8gdGVjaG5vbG9neSAobmV0d29yayB0eXBlKQogICAgICogY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlLgogICAgICogQHJldHVybiB0aGUgbmFtZSBvZiB0aGUgcmFkaW8gdGVjaG5vbG9neQogICAgICoKICAgICAqIEBoaWRlIHBlbmRpbmcgQVBJIGNvdW5jaWwgcmV2aWV3CiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldE5ldHdvcmtUeXBlTmFtZSgpIHsKICAgICAgICByZXR1cm4gZ2V0TmV0d29ya1R5cGVOYW1lKGdldE5ldHdvcmtUeXBlKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmFkaW8gdGVjaG5vbG9neSAobmV0d29yayB0eXBlKQogICAgICogY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlLgogICAgICogQHBhcmFtIHN1YklkIGZvciB3aGljaCBuZXR3b3JrIHR5cGUgaXMgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gdGhlIG5hbWUgb2YgdGhlIHJhZGlvIHRlY2hub2xvZ3kKICAgICAqCiAgICAgKi8KICAgIC8qKiB7QGhpZGV9ICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHN0YXRpYyBTdHJpbmcgZ2V0TmV0d29ya1R5cGVOYW1lKEBOZXR3b3JrVHlwZSBpbnQgdHlwZSkgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9HUFJTOgogICAgICAgICAgICAgICAgcmV0dXJuICJHUFJTIjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRURHRToKICAgICAgICAgICAgICAgIHJldHVybiAiRURHRSI7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX1VNVFM6CiAgICAgICAgICAgICAgICByZXR1cm4gIlVNVFMiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9IU0RQQToKICAgICAgICAgICAgICAgIHJldHVybiAiSFNEUEEiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9IU1VQQToKICAgICAgICAgICAgICAgIHJldHVybiAiSFNVUEEiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9IU1BBOgogICAgICAgICAgICAgICAgcmV0dXJuICJIU1BBIjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfQ0RNQToKICAgICAgICAgICAgICAgIHJldHVybiAiQ0RNQSI7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX0VWRE9fMDoKICAgICAgICAgICAgICAgIHJldHVybiAiQ0RNQSAtIEV2RG8gcmV2LiAwIjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRVZET19BOgogICAgICAgICAgICAgICAgcmV0dXJuICJDRE1BIC0gRXZEbyByZXYuIEEiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9FVkRPX0I6CiAgICAgICAgICAgICAgICByZXR1cm4gIkNETUEgLSBFdkRvIHJldi4gQiI7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFXzF4UlRUOgogICAgICAgICAgICAgICAgcmV0dXJuICJDRE1BIC0gMXhSVFQiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9MVEU6CiAgICAgICAgICAgICAgICByZXR1cm4gIkxURSI7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX0VIUlBEOgogICAgICAgICAgICAgICAgcmV0dXJuICJDRE1BIC0gZUhSUEQiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9JREVOOgogICAgICAgICAgICAgICAgcmV0dXJuICJpREVOIjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfSFNQQVA6CiAgICAgICAgICAgICAgICByZXR1cm4gIkhTUEErIjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfR1NNOgogICAgICAgICAgICAgICAgcmV0dXJuICJHU00iOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9URF9TQ0RNQToKICAgICAgICAgICAgICAgIHJldHVybiAiVERfU0NETUEiOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9JV0xBTjoKICAgICAgICAgICAgICAgIHJldHVybiAiSVdMQU4iOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9MVEVfQ0E6CiAgICAgICAgICAgICAgICByZXR1cm4gIkxURV9DQSI7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX05SOgogICAgICAgICAgICAgICAgcmV0dXJuICJOUiI7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIlVOS05PV04iOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGJpdG1hc2sgZm9yIGEgZ2l2ZW4gdGVjaG5vbG9neSAobmV0d29yayB0eXBlKQogICAgICogQHBhcmFtIG5ldHdvcmtUeXBlIGZvciB3aGljaCBiaXRtYXNrIGlzIHJldHVybmVkCiAgICAgKiBAcmV0dXJuIHRoZSBuZXR3b3JrIHR5cGUgYml0bWFzawogICAgICoge0BoaWRlfQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIEBOZXR3b3JrVHlwZUJpdE1hc2sgbG9uZyBnZXRCaXRNYXNrRm9yTmV0d29ya1R5cGUoQE5ldHdvcmtUeXBlIGludCBuZXR3b3JrVHlwZSkgewogICAgICAgIHN3aXRjaChuZXR3b3JrVHlwZSkgewogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9HU006CiAgICAgICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfR1NNOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9HUFJTOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0dQUlM7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX0VER0U6CiAgICAgICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfRURHRTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfQ0RNQToKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19DRE1BOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV8xeFJUVDoKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS18xeFJUVDsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRVZET18wOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fMDsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRVZET19BOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fQTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRVZET19COgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fQjsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfRUhSUEQ6CiAgICAgICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfRUhSUEQ7CiAgICAgICAgICAgIGNhc2UgTkVUV09SS19UWVBFX0hTVVBBOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTVVBBOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9IU0RQQToKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19IU0RQQTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfSFNQQToKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19IU1BBOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9IU1BBUDoKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19IU1BBUDsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfVU1UUzoKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19VTVRTOwogICAgICAgICAgICBjYXNlIE5FVFdPUktfVFlQRV9URF9TQ0RNQToKICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19URF9TQ0RNQTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfTFRFOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0xURTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfTFRFX0NBOgogICAgICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX0xURV9DQTsKICAgICAgICAgICAgY2FzZSBORVRXT1JLX1RZUEVfTlI6CiAgICAgICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfTlI7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfVU5LTk9XTjsKICAgICAgICB9CiAgICB9CgogICAgLy8KICAgIC8vCiAgICAvLyBTSU0gQ2FyZAogICAgLy8KICAgIC8vCgogICAgLyoqIEBoaWRlICovCiAgICBASW50RGVmKHByZWZpeCA9IHsiU0lNX1NUQVRFXyJ9LAogICAgICAgICAgICB2YWx1ZSA9IHsKICAgICAgICAgICAgICAgICAgICBTSU1fU1RBVEVfVU5LTk9XTiwKICAgICAgICAgICAgICAgICAgICBTSU1fU1RBVEVfQUJTRU5ULAogICAgICAgICAgICAgICAgICAgIFNJTV9TVEFURV9QSU5fUkVRVUlSRUQsCiAgICAgICAgICAgICAgICAgICAgU0lNX1NUQVRFX1BVS19SRVFVSVJFRCwKICAgICAgICAgICAgICAgICAgICBTSU1fU1RBVEVfTkVUV09SS19MT0NLRUQsCiAgICAgICAgICAgICAgICAgICAgU0lNX1NUQVRFX1JFQURZLAogICAgICAgICAgICAgICAgICAgIFNJTV9TVEFURV9OT1RfUkVBRFksCiAgICAgICAgICAgICAgICAgICAgU0lNX1NUQVRFX1BFUk1fRElTQUJMRUQsCiAgICAgICAgICAgICAgICAgICAgU0lNX1NUQVRFX0NBUkRfSU9fRVJST1IsCiAgICAgICAgICAgICAgICAgICAgU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRCwKICAgICAgICAgICAgICAgICAgICBTSU1fU1RBVEVfTE9BREVELAogICAgICAgICAgICAgICAgICAgIFNJTV9TVEFURV9QUkVTRU5ULAogICAgICAgICAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgU2ltU3RhdGUge30KCiAgICAvKioKICAgICAqIFNJTSBjYXJkIHN0YXRlOiBVbmtub3duLiBTaWduaWZpZXMgdGhhdCB0aGUgU0lNIGlzIGluIHRyYW5zaXRpb24KICAgICAqIGJldHdlZW4gc3RhdGVzLiBGb3IgZXhhbXBsZSwgd2hlbiB0aGUgdXNlciBpbnB1dHMgdGhlIFNJTSBwaW4KICAgICAqIHVuZGVyIFBJTl9SRVFVSVJFRCBzdGF0ZSwgYSBxdWVyeSBmb3Igc2ltIHN0YXR1cyByZXR1cm5zCiAgICAgKiB0aGlzIHN0YXRlIGJlZm9yZSB0dXJuaW5nIHRvIFNJTV9TVEFURV9SRUFEWS4KICAgICAqCiAgICAgKiBUaGVzZSBhcmUgdGhlIG9yZGluYWwgdmFsdWUgb2YgSWNjQ2FyZENvbnN0YW50cy5TdGF0ZS4KICAgICAqLwoKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9TVEFURV9VTktOT1dOID0gVGVsZXBob255UHJvdG9FbnVtcy5TSU1fU1RBVEVfVU5LTk9XTjsgIC8vIDAKICAgIC8qKiBTSU0gY2FyZCBzdGF0ZTogbm8gU0lNIGNhcmQgaXMgYXZhaWxhYmxlIGluIHRoZSBkZXZpY2UgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9TVEFURV9BQlNFTlQgPSBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9BQlNFTlQ7ICAvLyAxCiAgICAvKiogU0lNIGNhcmQgc3RhdGU6IExvY2tlZDogcmVxdWlyZXMgdGhlIHVzZXIncyBTSU0gUElOIHRvIHVubG9jayAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX1NUQVRFX1BJTl9SRVFVSVJFRCA9CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3RvRW51bXMuU0lNX1NUQVRFX1BJTl9SRVFVSVJFRDsgIC8vIDIKICAgIC8qKiBTSU0gY2FyZCBzdGF0ZTogTG9ja2VkOiByZXF1aXJlcyB0aGUgdXNlcidzIFNJTSBQVUsgdG8gdW5sb2NrICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTSU1fU1RBVEVfUFVLX1JFUVVJUkVEID0KICAgICAgICAgICAgVGVsZXBob255UHJvdG9FbnVtcy5TSU1fU1RBVEVfUFVLX1JFUVVJUkVEOyAgLy8gMwogICAgLyoqIFNJTSBjYXJkIHN0YXRlOiBMb2NrZWQ6IHJlcXVpcmVzIGEgbmV0d29yayBQSU4gdG8gdW5sb2NrICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTSU1fU1RBVEVfTkVUV09SS19MT0NLRUQgPQogICAgICAgICAgICBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRDsgIC8vIDQKICAgIC8qKiBTSU0gY2FyZCBzdGF0ZTogUmVhZHkgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9TVEFURV9SRUFEWSA9IFRlbGVwaG9ueVByb3RvRW51bXMuU0lNX1NUQVRFX1JFQURZOyAgLy8gNQogICAgLyoqIFNJTSBjYXJkIHN0YXRlOiBTSU0gQ2FyZCBpcyBOT1QgUkVBRFkgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9TVEFURV9OT1RfUkVBRFkgPSBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9OT1RfUkVBRFk7ICAvLyA2CiAgICAvKiogU0lNIGNhcmQgc3RhdGU6IFNJTSBDYXJkIEVycm9yLCBwZXJtYW5lbnRseSBkaXNhYmxlZCAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX1NUQVRFX1BFUk1fRElTQUJMRUQgPQogICAgICAgICAgICBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9QRVJNX0RJU0FCTEVEOyAgLy8gNwogICAgLyoqIFNJTSBjYXJkIHN0YXRlOiBTSU0gQ2FyZCBFcnJvciwgcHJlc2VudCBidXQgZmF1bHR5ICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUiA9CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3RvRW51bXMuU0lNX1NUQVRFX0NBUkRfSU9fRVJST1I7ICAvLyA4CiAgICAvKiogU0lNIGNhcmQgc3RhdGU6IFNJTSBDYXJkIHJlc3RyaWN0ZWQsIHByZXNlbnQgYnV0IG5vdCB1c2FibGUgZHVlIHRvCiAgICAgKiBjYXJyaWVyIHJlc3RyaWN0aW9ucy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRCA9CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3RvRW51bXMuU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRDsgIC8vIDkKICAgIC8qKgogICAgICogU0lNIGNhcmQgc3RhdGU6IExvYWRlZDogU0lNIGNhcmQgYXBwbGljYXRpb25zIGhhdmUgYmVlbiBsb2FkZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9TVEFURV9MT0FERUQgPSBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9MT0FERUQ7ICAvLyAxMAogICAgLyoqCiAgICAgKiBTSU0gY2FyZCBzdGF0ZTogU0lNIENhcmQgaXMgcHJlc2VudAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX1NUQVRFX1BSRVNFTlQgPSBUZWxlcGhvbnlQcm90b0VudW1zLlNJTV9TVEFURV9QUkVTRU5UOyAgLy8gMTEKCiAgICAvKioKICAgICAqIEV4dHJhIGluY2x1ZGVkIGluIHtAbGluayAjQUNUSU9OX1NJTV9DQVJEX1NUQVRFX0NIQU5HRUR9IGFuZAogICAgICoge0BsaW5rICNBQ1RJT05fU0lNX0FQUExJQ0FUSU9OX1NUQVRFX0NIQU5HRUR9IHRvIGluZGljYXRlIHRoZSBjYXJkL2FwcGxpY2F0aW9uIHN0YXRlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NJTV9TVEFURSA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TSU1fU1RBVEUiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogVGhlIHNpbSBjYXJkIHN0YXRlIGhhcyBjaGFuZ2VkLgogICAgICogVGhlIGludGVudCB3aWxsIGhhdmUgdGhlIGZvbGxvd2luZyBleHRyYSB2YWx1ZXM6PC9wPgogICAgICogPGRsPgogICAgICogICA8ZHQ+e0BsaW5rICNFWFRSQV9TSU1fU1RBVEV9PC9kdD4KICAgICAqICAgPGRkPlRoZSBzaW0gY2FyZCBzdGF0ZS4gT25lIG9mOgogICAgICogICAgIDxkbD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9BQlNFTlR9PC9kdD4KICAgICAqICAgICAgIDxkZD5TSU0gY2FyZCBub3QgZm91bmQ8L2RkPgogICAgICogICAgICAgPGR0PntAbGluayAjU0lNX1NUQVRFX0NBUkRfSU9fRVJST1J9PC9kdD4KICAgICAqICAgICAgIDxkZD5TSU0gY2FyZCBJTyBlcnJvcjwvZGQ+CiAgICAgKiAgICAgICA8ZHQ+e0BsaW5rICNTSU1fU1RBVEVfQ0FSRF9SRVNUUklDVEVEfTwvZHQ+CiAgICAgKiAgICAgICA8ZGQ+U0lNIGNhcmQgaXMgcmVzdHJpY3RlZDwvZGQ+CiAgICAgKiAgICAgICA8ZHQ+e0BsaW5rICNTSU1fU1RBVEVfUFJFU0VOVH08L2R0PgogICAgICogICAgICAgPGRkPlNJTSBjYXJkIGlzIHByZXNlbnQ8L2RkPgogICAgICogICAgIDwvZGw+CiAgICAgKiAgIDwvZGQ+CiAgICAgKiA8L2RsPgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj5SZXF1aXJlcyB0aGUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24uCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoZSBjdXJyZW50IHN0YXRlIGNhbiBhbHNvIGJlIHF1ZXJpZWQgdXNpbmcge0BsaW5rICNnZXRTaW1DYXJkU3RhdGUoKX0uCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoaXMgaXMgYSBwcm90ZWN0ZWQgaW50ZW50IHRoYXQgY2FuIG9ubHkgYmUgc2VudCBieSB0aGUgc3lzdGVtLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TSU1fQ0FSRF9TVEFURV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TSU1fQ0FSRF9TVEFURV9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBzaW0gYXBwbGljYXRpb24gc3RhdGUgaGFzIGNoYW5nZWQuCiAgICAgKiBUaGUgaW50ZW50IHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGV4dHJhIHZhbHVlczo8L3A+CiAgICAgKiA8ZGw+CiAgICAgKiAgIDxkdD57QGxpbmsgI0VYVFJBX1NJTV9TVEFURX08L2R0PgogICAgICogICA8ZGQ+VGhlIHNpbSBhcHBsaWNhdGlvbiBzdGF0ZS4gT25lIG9mOgogICAgICogICAgIDxkbD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9OT1RfUkVBRFl9PC9kdD4KICAgICAqICAgICAgIDxkZD5TSU0gY2FyZCBhcHBsaWNhdGlvbnMgbm90IHJlYWR5PC9kZD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9QSU5fUkVRVUlSRUR9PC9kdD4KICAgICAqICAgICAgIDxkZD5TSU0gY2FyZCBQSU4gbG9ja2VkPC9kZD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9QVUtfUkVRVUlSRUR9PC9kdD4KICAgICAqICAgICAgIDxkZD5TSU0gY2FyZCBQVUsgbG9ja2VkPC9kZD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRH08L2R0PgogICAgICogICAgICAgPGRkPlNJTSBjYXJkIG5ldHdvcmsgbG9ja2VkPC9kZD4KICAgICAqICAgICAgIDxkdD57QGxpbmsgI1NJTV9TVEFURV9QRVJNX0RJU0FCTEVEfTwvZHQ+CiAgICAgKiAgICAgICA8ZGQ+U0lNIGNhcmQgcGVybWFuZW50bHkgZGlzYWJsZWQgZHVlIHRvIFBVSyBmYWlsdXJlczwvZGQ+CiAgICAgKiAgICAgICA8ZHQ+e0BsaW5rICNTSU1fU1RBVEVfTE9BREVEfTwvZHQ+CiAgICAgKiAgICAgICA8ZGQ+U0lNIGNhcmQgZGF0YSBsb2FkZWQ8L2RkPgogICAgICogICAgIDwvZGw+CiAgICAgKiAgIDwvZGQ+CiAgICAgKiA8L2RsPgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj5SZXF1aXJlcyB0aGUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24uCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoZSBjdXJyZW50IHN0YXRlIGNhbiBhbHNvIGJlIHF1ZXJpZWQgdXNpbmcKICAgICAqIHtAbGluayAjZ2V0U2ltQXBwbGljYXRpb25TdGF0ZSgpfS4KICAgICAqCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+VGhpcyBpcyBhIHByb3RlY3RlZCBpbnRlbnQgdGhhdCBjYW4gb25seSBiZSBzZW50IGJ5IHRoZSBzeXN0ZW0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1NJTV9BUFBMSUNBVElPTl9TVEFURV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TSU1fQVBQTElDQVRJT05fU1RBVEVfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBTdGF0dXMgb2YgdGhlIFNJTSBzbG90cyBvbiB0aGUgZGV2aWNlIGhhcyBjaGFuZ2VkLgogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj5SZXF1aXJlcyB0aGUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24uCiAgICAgKgogICAgICogPHAgY2xhc3M9Im5vdGUiPlRoZSBzdGF0dXMgY2FuIGJlIHF1ZXJpZWQgdXNpbmcKICAgICAqIHtAbGluayAjZ2V0VWljY1Nsb3RzSW5mbygpfQogICAgICoKICAgICAqIDxwIGNsYXNzPSJub3RlIj5UaGlzIGlzIGEgcHJvdGVjdGVkIGludGVudCB0aGF0IGNhbiBvbmx5IGJlIHNlbnQgYnkgdGhlIHN5c3RlbS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fU0lNX1NMT1RfU1RBVFVTX0NIQU5HRUQgPQogICAgICAgICAgICAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLlNJTV9TTE9UX1NUQVRVU19DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IEEgZGVidWcgY29kZSBoYXMgYmVlbiBlbnRlcmVkIGluIHRoZSBkaWFsZXIuCiAgICAgKiA8cD4KICAgICAqIFRoaXMgaW50ZW50IGlzIGJyb2FkY2FzdCBieSB0aGUgc3lzdGVtIGFuZCBPRU0gdGVsZXBob255IGFwcHMgbWF5IG5lZWQgdG8gcmVjZWl2ZSB0aGVzZQogICAgICogYnJvYWRjYXN0cy4gQW5kIGl0IHJlcXVpcmVzIHRoZSBzZW5kZXIgdG8gYmUgZGVmYXVsdCBkaWFsZXIgb3IgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgICogKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKiA8cD4KICAgICAqIFRoZXNlICJzZWNyZXQgY29kZXMiIGFyZSB1c2VkIHRvIGFjdGl2YXRlIGRldmVsb3BlciBtZW51cyBieSBkaWFsaW5nIGNlcnRhaW4gY29kZXMuCiAgICAgKiBBbmQgdGhleSBhcmUgb2YgdGhlIGZvcm0ge0Bjb2RlICojKiM8Y29kZT4jKiMqfS4gVGhlIGludGVudCB3aWxsIGhhdmUgdGhlIGRhdGEKICAgICAqIFVSSToge0Bjb2RlIGFuZHJvaWRfc2VjcmV0X2NvZGU6Ly88Y29kZT59LiBJdCBpcyBwb3NzaWJsZSB0aGF0IGEgbWFuaWZlc3QKICAgICAqIHJlY2VpdmVyIHdvdWxkIGJlIHdva2VuIHVwIGV2ZW4gaWYgaXQgaXMgbm90IGN1cnJlbnRseSBydW5uaW5nLgogICAgICogPHA+CiAgICAgKiBJdCBpcyBzdXBwb3NlZCB0byByZXBsYWNlIHtAbGluayBhbmRyb2lkLnByb3ZpZGVyLlRlbGVwaG9ueS5TbXMuSW50ZW50cyNTRUNSRVRfQ09ERV9BQ1RJT059CiAgICAgKiBpbiB0aGUgbmV4dCBBbmRyb2lkIHZlcnNpb24uCiAgICAgKiBCZWZvcmUgdGhhdCBib3RoIG9mIHRoZXNlIHR3byBhY3Rpb25zIHdpbGwgYmUgYnJvYWRjYXN0LgogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1NFQ1JFVF9DT0RFID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5TRUNSRVRfQ09ERSI7CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgYSBJQ0MgY2FyZCBpcyBwcmVzZW50CiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGhhc0ljY0NhcmQoKSB7CiAgICAgICAgcmV0dXJuIGhhc0ljY0NhcmQoZ2V0U2xvdEluZGV4KCkpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0cnVlIGlmIGEgSUNDIGNhcmQgaXMgcHJlc2VudCBmb3IgYSBzdWJzY3JpcHRpb24KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IGZvciB3aGljaCBpY2MgY2FyZCBwcmVzZW5jZSBpcyBjaGVja2VkCiAgICAgKi8KICAgIC8qKiB7QGhpZGV9ICovCiAgICAvLyBGSVhNRSBJbnB1dCBhcmd1bWVudCBzbG90SW5kZXggc2hvdWxkIGJlIG9mIHR5cGUgaW50CiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGJvb2xlYW4gaGFzSWNjQ2FyZChpbnQgc2xvdEluZGV4KSB7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaGFzSWNjQ2FyZFVzaW5nU2xvdEluZGV4KHNsb3RJbmRleCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIEFzc3VtZSBubyBJQ0MgY2FyZCBpZiByZW1vdGUgZXhjZXB0aW9uIHdoaWNoIHNob3VsZG4ndCBoYXBwZW4KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSBzdGF0ZSBvZiB0aGUgZGVmYXVsdCBTSU0gY2FyZC4KICAgICAqCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfVU5LTk9XTgogICAgICogQHNlZSAjU0lNX1NUQVRFX0FCU0VOVAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BJTl9SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BVS19SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX05FVFdPUktfTE9DS0VECiAgICAgKiBAc2VlICNTSU1fU1RBVEVfUkVBRFkKICAgICAqIEBzZWUgI1NJTV9TVEFURV9OT1RfUkVBRFkKICAgICAqIEBzZWUgI1NJTV9TVEFURV9QRVJNX0RJU0FCTEVECiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUgogICAgICogQHNlZSAjU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRAogICAgICovCiAgICBwdWJsaWMgQFNpbVN0YXRlIGludCBnZXRTaW1TdGF0ZSgpIHsKICAgICAgICBpbnQgc2ltU3RhdGUgPSBnZXRTaW1TdGF0ZUluY2x1ZGluZ0xvYWRlZCgpOwogICAgICAgIGlmIChzaW1TdGF0ZSA9PSBTSU1fU1RBVEVfTE9BREVEKSB7CiAgICAgICAgICAgIHNpbVN0YXRlID0gU0lNX1NUQVRFX1JFQURZOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2ltU3RhdGU7CiAgICB9CgogICAgcHJpdmF0ZSBAU2ltU3RhdGUgaW50IGdldFNpbVN0YXRlSW5jbHVkaW5nTG9hZGVkKCkgewogICAgICAgIGludCBzbG90SW5kZXggPSBnZXRTbG90SW5kZXgoKTsKICAgICAgICAvLyBzbG90SW5kZXggbWF5IGJlIGludmFsaWQgZHVlIHRvIHNpbSBiZWluZyBhYnNlbnQuIEluIHRoYXQgY2FzZSBxdWVyeSBhbGwgc2xvdHMgdG8gZ2V0CiAgICAgICAgLy8gc2ltIHN0YXRlCiAgICAgICAgaWYgKHNsb3RJbmRleCA8IDApIHsKICAgICAgICAgICAgLy8gcXVlcnkgZm9yIGFsbCBzbG90cyBhbmQgcmV0dXJuIGFic2VudCBpZiBhbGwgc2ltIHN0YXRlcyBhcmUgYWJzZW50LCBvdGhlcndpc2UKICAgICAgICAgICAgLy8gcmV0dXJuIHVua25vd24KICAgICAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBnZXRQaG9uZUNvdW50KCk7IGkrKykgewogICAgICAgICAgICAgICAgaW50IHNpbVN0YXRlID0gZ2V0U2ltU3RhdGUoaSk7CiAgICAgICAgICAgICAgICBpZiAoc2ltU3RhdGUgIT0gU0lNX1NUQVRFX0FCU0VOVCkgewogICAgICAgICAgICAgICAgICAgIFJsb2cuZChUQUcsICJnZXRTaW1TdGF0ZTogZGVmYXVsdCBzaW06IiArIHNsb3RJbmRleCArICIsIHNpbSBzdGF0ZSBmb3IgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2xvdEluZGV4PSIgKyBpICsgIiBpcyAiICsgc2ltU3RhdGUgKyAiLCByZXR1cm4gc3RhdGUgYXMgdW5rbm93biIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBTSU1fU1RBVEVfVU5LTk9XTjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBSbG9nLmQoVEFHLCAiZ2V0U2ltU3RhdGU6IGRlZmF1bHQgc2ltOiIgKyBzbG90SW5kZXggKyAiLCBhbGwgU0lNcyBhYnNlbnQsIHJldHVybiAiICsKICAgICAgICAgICAgICAgICAgICAic3RhdGUgYXMgYWJzZW50Iik7CiAgICAgICAgICAgIHJldHVybiBTSU1fU1RBVEVfQUJTRU5UOwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRTaW1TdGF0ZUZvclNsb3RJbmRleChzbG90SW5kZXgpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXRlIG9mIHRoZSBkZWZhdWx0IFNJTSBjYXJkLgogICAgICoKICAgICAqIEBzZWUgI1NJTV9TVEFURV9VTktOT1dOCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQUJTRU5UCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUgogICAgICogQHNlZSAjU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BSRVNFTlQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgQFNpbVN0YXRlIGludCBnZXRTaW1DYXJkU3RhdGUoKSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0gZ2V0U2ltU3RhdGUoKTsKICAgICAgICByZXR1cm4gZ2V0U2ltQ2FyZFN0YXRlRnJvbVNpbVN0YXRlKHNpbVN0YXRlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSBzdGF0ZSBvZiB0aGUgZGV2aWNlIFNJTSBjYXJkIGluIGEgcGh5c2ljYWwgc2xvdC4KICAgICAqCiAgICAgKiBAcGFyYW0gcGh5c2ljYWxTbG90SW5kZXggcGh5c2ljYWwgc2xvdCBpbmRleAogICAgICoKICAgICAqIEBzZWUgI1NJTV9TVEFURV9VTktOT1dOCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQUJTRU5UCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUgogICAgICogQHNlZSAjU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BSRVNFTlQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQFNpbVN0YXRlIGludCBnZXRTaW1DYXJkU3RhdGUoaW50IHBoeXNpY2FsU2xvdEluZGV4KSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0gZ2V0U2ltU3RhdGUoZ2V0TG9naWNhbFNsb3RJbmRleChwaHlzaWNhbFNsb3RJbmRleCkpOwogICAgICAgIHJldHVybiBnZXRTaW1DYXJkU3RhdGVGcm9tU2ltU3RhdGUoc2ltU3RhdGUpOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVydHMgU0lNIHN0YXRlIHRvIFNJTSBjYXJkIHN0YXRlLgogICAgICogQHBhcmFtIHNpbVN0YXRlCiAgICAgKiBAcmV0dXJuIFNJTSBjYXJkIHN0YXRlCiAgICAgKi8KICAgIHByaXZhdGUgQFNpbVN0YXRlIGludCBnZXRTaW1DYXJkU3RhdGVGcm9tU2ltU3RhdGUoaW50IHNpbVN0YXRlKSB7CiAgICAgICAgc3dpdGNoIChzaW1TdGF0ZSkgewogICAgICAgICAgICBjYXNlIFNJTV9TVEFURV9VTktOT1dOOgogICAgICAgICAgICBjYXNlIFNJTV9TVEFURV9BQlNFTlQ6CiAgICAgICAgICAgIGNhc2UgU0lNX1NUQVRFX0NBUkRfSU9fRVJST1I6CiAgICAgICAgICAgIGNhc2UgU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRDoKICAgICAgICAgICAgICAgIHJldHVybiBzaW1TdGF0ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBTSU1fU1RBVEVfUFJFU0VOVDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIHBoeXNpY2FsIHNsb3QgaW5kZXggdG8gbG9naWNhbCBzbG90IGluZGV4LgogICAgICogQHBhcmFtIHBoeXNpY2FsU2xvdEluZGV4IHBoeXNpY2FsIHNsb3QgaW5kZXgKICAgICAqIEByZXR1cm4gbG9naWNhbCBzbG90IGluZGV4CiAgICAgKi8KICAgIHByaXZhdGUgaW50IGdldExvZ2ljYWxTbG90SW5kZXgoaW50IHBoeXNpY2FsU2xvdEluZGV4KSB7CiAgICAgICAgVWljY1Nsb3RJbmZvW10gc2xvdEluZm9zID0gZ2V0VWljY1Nsb3RzSW5mbygpOwogICAgICAgIGlmIChzbG90SW5mb3MgIT0gbnVsbCAmJiBwaHlzaWNhbFNsb3RJbmRleCA+PSAwICYmIHBoeXNpY2FsU2xvdEluZGV4IDwgc2xvdEluZm9zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gc2xvdEluZm9zW3BoeXNpY2FsU2xvdEluZGV4XS5nZXRMb2dpY2FsU2xvdElkeCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFN1YnNjcmlwdGlvbk1hbmFnZXIuSU5WQUxJRF9TSU1fU0xPVF9JTkRFWDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSBzdGF0ZSBvZiB0aGUgY2FyZCBhcHBsaWNhdGlvbnMgb24gdGhlIGRlZmF1bHQgU0lNIGNhcmQuCiAgICAgKgogICAgICogQHNlZSAjU0lNX1NUQVRFX1VOS05PV04KICAgICAqIEBzZWUgI1NJTV9TVEFURV9QSU5fUkVRVUlSRUQKICAgICAqIEBzZWUgI1NJTV9TVEFURV9QVUtfUkVRVUlSRUQKICAgICAqIEBzZWUgI1NJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX05PVF9SRUFEWQogICAgICogQHNlZSAjU0lNX1NUQVRFX1BFUk1fRElTQUJMRUQKICAgICAqIEBzZWUgI1NJTV9TVEFURV9MT0FERUQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgQFNpbVN0YXRlIGludCBnZXRTaW1BcHBsaWNhdGlvblN0YXRlKCkgewogICAgICAgIGludCBzaW1TdGF0ZSA9IGdldFNpbVN0YXRlSW5jbHVkaW5nTG9hZGVkKCk7CiAgICAgICAgcmV0dXJuIGdldFNpbUFwcGxpY2F0aW9uU3RhdGVGcm9tU2ltU3RhdGUoc2ltU3RhdGUpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXRlIG9mIHRoZSBjYXJkIGFwcGxpY2F0aW9ucyBvbiB0aGUgZGV2aWNlIFNJTSBjYXJkIGluCiAgICAgKiBhIHBoeXNpY2FsIHNsb3QuCiAgICAgKgogICAgICogQHBhcmFtIHBoeXNpY2FsU2xvdEluZGV4IHBoeXNpY2FsIHNsb3QgaW5kZXgKICAgICAqCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfVU5LTk9XTgogICAgICogQHNlZSAjU0lNX1NUQVRFX1BJTl9SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BVS19SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX05FVFdPUktfTE9DS0VECiAgICAgKiBAc2VlICNTSU1fU1RBVEVfTk9UX1JFQURZCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfUEVSTV9ESVNBQkxFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX0xPQURFRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBAU2ltU3RhdGUgaW50IGdldFNpbUFwcGxpY2F0aW9uU3RhdGUoaW50IHBoeXNpY2FsU2xvdEluZGV4KSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0KICAgICAgICAgICAgICAgIFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0U2ltU3RhdGVGb3JTbG90SW5kZXgoZ2V0TG9naWNhbFNsb3RJbmRleChwaHlzaWNhbFNsb3RJbmRleCkpOwogICAgICAgIHJldHVybiBnZXRTaW1BcHBsaWNhdGlvblN0YXRlRnJvbVNpbVN0YXRlKHNpbVN0YXRlKTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIFNJTSBzdGF0ZSB0byBTSU0gYXBwbGljYXRpb24gc3RhdGUuCiAgICAgKiBAcGFyYW0gc2ltU3RhdGUKICAgICAqIEByZXR1cm4gU0lNIGFwcGxpY2F0aW9uIHN0YXRlCiAgICAgKi8KICAgIHByaXZhdGUgQFNpbVN0YXRlIGludCBnZXRTaW1BcHBsaWNhdGlvblN0YXRlRnJvbVNpbVN0YXRlKGludCBzaW1TdGF0ZSkgewogICAgICAgIHN3aXRjaCAoc2ltU3RhdGUpIHsKICAgICAgICAgICAgY2FzZSBTSU1fU1RBVEVfVU5LTk9XTjoKICAgICAgICAgICAgY2FzZSBTSU1fU1RBVEVfQUJTRU5UOgogICAgICAgICAgICBjYXNlIFNJTV9TVEFURV9DQVJEX0lPX0VSUk9SOgogICAgICAgICAgICBjYXNlIFNJTV9TVEFURV9DQVJEX1JFU1RSSUNURUQ6CiAgICAgICAgICAgICAgICByZXR1cm4gU0lNX1NUQVRFX1VOS05PV047CiAgICAgICAgICAgIGNhc2UgU0lNX1NUQVRFX1JFQURZOgogICAgICAgICAgICAgICAgLy8gUmVhZHkgaXMgbm90IGEgdmFsaWQgc3RhdGUgYW55bW9yZS4gVGhlIHN0YXRlIHRoYXQgaXMgYnJvYWRjYXN0IGdvZXMgZnJvbQogICAgICAgICAgICAgICAgLy8gTk9UX1JFQURZIHRvIGVpdGhlciBMT0NLRUQgb3IgTE9BREVELgogICAgICAgICAgICAgICAgcmV0dXJuIFNJTV9TVEFURV9OT1RfUkVBRFk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gc2ltU3RhdGU7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIHR5cGUgb2YgYXBwbGljYXRpb24gKGUuZy4ge0BsaW5rICNBUFBUWVBFX0NTSU19IGlzIHByZXNlbnQKICAgICAqIG9uIHRoZSBVSUNDIGNhcmQuCiAgICAgKgogICAgICogUmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uCiAgICAgKgogICAgICogQHBhcmFtIGFwcFR5cGUgdGhlIHVpY2MgYXBwIHR5cGUgbGlrZSB7QGxpbmsgQVBQVFlQRV9DU0lNfQogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgdHlwZSBvZiBhcHBsaWNhdGlvbiBpbiBVSUNDIENBUkQgb3IgZmFsc2UgaWYgbm8gdWljYyBvciBlcnJvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzQXBwbGljYXRpb25PblVpY2MoQFVpY2NBcHBUeXBlIGludCBhcHBUeXBlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5pc0FwcGxpY2F0aW9uT25VaWNjKGdldFN1YklkKCksIGFwcFR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzQXBwbGljYXRpb25PblVpY2MiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXRlIG9mIHRoZSBkZXZpY2UgU0lNIGNhcmQgaW4gYSBsb2dpY2FsIHNsb3QuCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCBsb2dpY2FsIHNsb3QgaW5kZXgKICAgICAqCiAgICAgKiBAc2VlICNTSU1fU1RBVEVfVU5LTk9XTgogICAgICogQHNlZSAjU0lNX1NUQVRFX0FCU0VOVAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BJTl9SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX1BVS19SRVFVSVJFRAogICAgICogQHNlZSAjU0lNX1NUQVRFX05FVFdPUktfTE9DS0VECiAgICAgKiBAc2VlICNTSU1fU1RBVEVfUkVBRFkKICAgICAqIEBzZWUgI1NJTV9TVEFURV9OT1RfUkVBRFkKICAgICAqIEBzZWUgI1NJTV9TVEFURV9QRVJNX0RJU0FCTEVECiAgICAgKiBAc2VlICNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUgogICAgICogQHNlZSAjU0lNX1NUQVRFX0NBUkRfUkVTVFJJQ1RFRAogICAgICovCiAgICBwdWJsaWMgQFNpbVN0YXRlIGludCBnZXRTaW1TdGF0ZShpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRTaW1TdGF0ZUZvclNsb3RJbmRleChzbG90SW5kZXgpOwogICAgICAgIGlmIChzaW1TdGF0ZSA9PSBTSU1fU1RBVEVfTE9BREVEKSB7CiAgICAgICAgICAgIHNpbVN0YXRlID0gU0lNX1NUQVRFX1JFQURZOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2ltU3RhdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNQ0MrTU5DIChtb2JpbGUgY291bnRyeSBjb2RlICsgbW9iaWxlIG5ldHdvcmsgY29kZSkgb2YgdGhlCiAgICAgKiBwcm92aWRlciBvZiB0aGUgU0lNLiA1IG9yIDYgZGVjaW1hbCBkaWdpdHMuCiAgICAgKiA8cD4KICAgICAqIEF2YWlsYWJpbGl0eTogU0lNIHN0YXRlIG11c3QgYmUge0BsaW5rICNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKgogICAgICogQHNlZSAjZ2V0U2ltU3RhdGUKICAgICAqLwogICAgcHVibGljIFN0cmluZyBnZXRTaW1PcGVyYXRvcigpIHsKICAgICAgICByZXR1cm4gZ2V0U2ltT3BlcmF0b3JOdW1lcmljKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNQ0MrTU5DIChtb2JpbGUgY291bnRyeSBjb2RlICsgbW9iaWxlIG5ldHdvcmsgY29kZSkgb2YgdGhlCiAgICAgKiBwcm92aWRlciBvZiB0aGUgU0lNLiA1IG9yIDYgZGVjaW1hbCBkaWdpdHMuCiAgICAgKiA8cD4KICAgICAqIEF2YWlsYWJpbGl0eTogU0lNIHN0YXRlIG11c3QgYmUge0BsaW5rICNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKgogICAgICogQHNlZSAjZ2V0U2ltU3RhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgZm9yIHdoaWNoIFNpbU9wZXJhdG9yIGlzIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgU3RyaW5nIGdldFNpbU9wZXJhdG9yKGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBnZXRTaW1PcGVyYXRvck51bWVyaWMoc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgTUNDK01OQyAobW9iaWxlIGNvdW50cnkgY29kZSArIG1vYmlsZSBuZXR3b3JrIGNvZGUpIG9mIHRoZQogICAgICogcHJvdmlkZXIgb2YgdGhlIFNJTS4gNSBvciA2IGRlY2ltYWwgZGlnaXRzLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IFNJTSBzdGF0ZSBtdXN0IGJlIHtAbGluayAjU0lNX1NUQVRFX1JFQURZfQogICAgICoKICAgICAqIEBzZWUgI2dldFNpbVN0YXRlCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgU3RyaW5nIGdldFNpbU9wZXJhdG9yTnVtZXJpYygpIHsKICAgICAgICBpbnQgc3ViSWQgPSBtU3ViSWQ7CiAgICAgICAgaWYgKCFTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVXNhYmxlU3ViSWRWYWx1ZShzdWJJZCkpIHsKICAgICAgICAgICAgc3ViSWQgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICAgICAgaWYgKCFTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVXNhYmxlU3ViSWRWYWx1ZShzdWJJZCkpIHsKICAgICAgICAgICAgICAgIHN1YklkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICAgICAgICAgIGlmICghU3Vic2NyaXB0aW9uTWFuYWdlci5pc1VzYWJsZVN1YklkVmFsdWUoc3ViSWQpKSB7CiAgICAgICAgICAgICAgICAgICAgc3ViSWQgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVXNhYmxlU3ViSWRWYWx1ZShzdWJJZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3ViSWQgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0U2ltT3BlcmF0b3JOdW1lcmljKHN1YklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE1DQytNTkMgKG1vYmlsZSBjb3VudHJ5IGNvZGUgKyBtb2JpbGUgbmV0d29yayBjb2RlKSBvZiB0aGUKICAgICAqIHByb3ZpZGVyIG9mIHRoZSBTSU0gZm9yIGEgcGFydGljdWxhciBzdWJzY3JpcHRpb24uIDUgb3IgNiBkZWNpbWFsIGRpZ2l0cy4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBTSU0gc3RhdGUgbXVzdCBiZSB7QGxpbmsgI1NJTV9TVEFURV9SRUFEWX0KICAgICAqCiAgICAgKiBAc2VlICNnZXRTaW1TdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBmb3Igd2hpY2ggU2ltT3BlcmF0b3IgaXMgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0U2ltT3BlcmF0b3JOdW1lcmljKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICByZXR1cm4gZ2V0U2ltT3BlcmF0b3JOdW1lcmljRm9yUGhvbmUocGhvbmVJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNQ0MrTU5DIChtb2JpbGUgY291bnRyeSBjb2RlICsgbW9iaWxlIG5ldHdvcmsgY29kZSkgb2YgdGhlCiAgICAgKiBwcm92aWRlciBvZiB0aGUgU0lNIGZvciBhIHBhcnRpY3VsYXIgc3Vic2NyaXB0aW9uLiA1IG9yIDYgZGVjaW1hbCBkaWdpdHMuCiAgICAgKiA8cD4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVJZCBmb3Igd2hpY2ggU2ltT3BlcmF0b3IgaXMgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0U2ltT3BlcmF0b3JOdW1lcmljRm9yUGhvbmUoaW50IHBob25lSWQpIHsKICAgICAgICByZXR1cm4gZ2V0VGVsZXBob255UHJvcGVydHkocGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfbnVtZXJpYygpLCAiIik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBTZXJ2aWNlIFByb3ZpZGVyIE5hbWUgKFNQTikuCiAgICAgKiA8cD4KICAgICAqIEF2YWlsYWJpbGl0eTogU0lNIHN0YXRlIG11c3QgYmUge0BsaW5rICNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKgogICAgICogQHNlZSAjZ2V0U2ltU3RhdGUKICAgICAqLwogICAgcHVibGljIFN0cmluZyBnZXRTaW1PcGVyYXRvck5hbWUoKSB7CiAgICAgICAgcmV0dXJuIGdldFNpbU9wZXJhdG9yTmFtZUZvclBob25lKGdldFBob25lSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBTZXJ2aWNlIFByb3ZpZGVyIE5hbWUgKFNQTikuCiAgICAgKiA8cD4KICAgICAqIEF2YWlsYWJpbGl0eTogU0lNIHN0YXRlIG11c3QgYmUge0BsaW5rICNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKgogICAgICogQHNlZSAjZ2V0U2ltU3RhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgZm9yIHdoaWNoIFNpbU9wZXJhdG9yTmFtZSBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIFN0cmluZyBnZXRTaW1PcGVyYXRvck5hbWUoaW50IHN1YklkKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmdldFBob25lSWQoc3ViSWQpOwogICAgICAgIHJldHVybiBnZXRTaW1PcGVyYXRvck5hbWVGb3JQaG9uZShwaG9uZUlkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIFNlcnZpY2UgUHJvdmlkZXIgTmFtZSAoU1BOKS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN0cmluZyBnZXRTaW1PcGVyYXRvck5hbWVGb3JQaG9uZShpbnQgcGhvbmVJZCkgewogICAgICAgIHJldHVybiBnZXRUZWxlcGhvbnlQcm9wZXJ0eShwaG9uZUlkLCBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9hbHBoYSgpLCAiIik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBJU08tMzE2Ni0xIGFscGhhLTIgY291bnRyeSBjb2RlIGVxdWl2YWxlbnQgZm9yIHRoZSBTSU0gcHJvdmlkZXIncyBjb3VudHJ5IGNvZGUuCiAgICAgKiA8cD4KICAgICAqIFRoZSBJU08tMzE2Ni0xIGFscGhhLTIgY291bnRyeSBjb2RlIGlzIHByb3ZpZGVkIGluIGxvd2VyY2FzZSAyIGNoYXJhY3RlciBmb3JtYXQuCiAgICAgKiBAcmV0dXJuIHRoZSBsb3dlcmNhc2UgMiBjaGFyYWN0ZXIgSVNPLTMxNjYtMSBhbHBoYS0yIGNvdW50cnkgY29kZSwgb3IgZW1wdHkgc3RyaW5nIGlzIG5vdAogICAgICogYXZhaWxhYmxlLgogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldFNpbUNvdW50cnlJc28oKSB7CiAgICAgICAgcmV0dXJuIGdldFNpbUNvdW50cnlJc29Gb3JQaG9uZShnZXRQaG9uZUlkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgSVNPIGNvdW50cnkgY29kZSBlcXVpdmFsZW50IGZvciB0aGUgU0lNIHByb3ZpZGVyJ3MgY291bnRyeSBjb2RlLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBmb3Igd2hpY2ggU2ltQ291bnRyeUlzbyBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyBTdHJpbmcgZ2V0U2ltQ291bnRyeUlzbyhpbnQgc3ViSWQpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0UGhvbmVJZChzdWJJZCk7CiAgICAgICAgcmV0dXJuIGdldFNpbUNvdW50cnlJc29Gb3JQaG9uZShwaG9uZUlkKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElTTyBjb3VudHJ5IGNvZGUgZXF1aXZhbGVudCBmb3IgdGhlIFNJTSBwcm92aWRlcidzIGNvdW50cnkgY29kZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHN0YXRpYyBTdHJpbmcgZ2V0U2ltQ291bnRyeUlzb0ZvclBob25lKGludCBwaG9uZUlkKSB7CiAgICAgICAgcmV0dXJuIGdldFRlbGVwaG9ueVByb3BlcnR5KHBob25lSWQsIFRlbGVwaG9ueVByb3BlcnRpZXMuaWNjX29wZXJhdG9yX2lzb19jb3VudHJ5KCksICIiKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHNlcmlhbCBudW1iZXIgb2YgdGhlIFNJTSwgaWYgYXBwbGljYWJsZS4gUmV0dXJuIG51bGwgaWYgaXQgaXMKICAgICAqIHVuYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlN0YXJ0aW5nIHdpdGggQVBJIGxldmVsIDI5LCBwZXJzaXN0ZW50IGRldmljZSBpZGVudGlmaWVycyBhcmUgZ3VhcmRlZCBiZWhpbmQgYWRkaXRpb25hbAogICAgICogcmVzdHJpY3Rpb25zLCBhbmQgYXBwcyBhcmUgcmVjb21tZW5kZWQgdG8gdXNlIHJlc2V0dGFibGUgaWRlbnRpZmllcnMgKHNlZSA8YQogICAgICogaHJlZj0iL3RyYWluaW5nL2FydGljbGVzL3VzZXItZGF0YS1pZHMiPkJlc3QgcHJhY3RpY2VzIGZvciB1bmlxdWUgaWRlbnRpZmllcnM8L2E+KS4gVGhpcwogICAgICogbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgYmVlbiBncmFudGVkIHRoZSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbjsgdGhpcwogICAgICogICAgIGlzIGEgcHJpdmlsZWdlZCBwZXJtaXNzaW9uIHRoYXQgY2FuIG9ubHkgYmUgZ3JhbnRlZCB0byBhcHBzIHByZWxvYWRlZCBvbiB0aGUgZGV2aWNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRldmljZSBvciBwcm9maWxlIG93bmVyIGFuZCBoYXMgYmVlbiBncmFudGVkIHRoZQogICAgICogICAgIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uIFRoZSBwcm9maWxlIG93bmVyIGlzIGFuIGFwcCB0aGF0CiAgICAgKiAgICAgb3ducyBhIG1hbmFnZWQgcHJvZmlsZSBvbiB0aGUgZGV2aWNlOyBmb3IgbW9yZSBkZXRhaWxzIHNlZSA8YQogICAgICogICAgIGhyZWY9Imh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3dvcmsvbWFuYWdlZC1wcm9maWxlcyI+V29yayBwcm9maWxlczwvYT4uCiAgICAgKiAgICAgUHJvZmlsZSBvd25lciBhY2Nlc3MgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRlZmF1bHQgU01TIHJvbGUgaG9sZGVyIChzZWUge0BsaW5rCiAgICAgKiAgICAgUm9sZU1hbmFnZXIjaXNSb2xlSGVsZChTdHJpbmcpfSkuCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPklmIHRoZSBjYWxsaW5nIGFwcCBkb2VzIG5vdCBtZWV0IG9uZSBvZiB0aGVzZSByZXF1aXJlbWVudHMgdGhlbiB0aGlzIG1ldGhvZCB3aWxsIGJlaGF2ZQogICAgICogYXMgZm9sbG93czoKICAgICAqCiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGhhcyB0aGUKICAgICAqICAgICBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24gdGhlbiBudWxsIGlzIHJldHVybmVkLjwvbGk+CiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCdzIHRhcmdldCBTREsgaXMgQVBJIGxldmVsIDI4IG9yIGxvd2VyIGFuZCB0aGUgYXBwIGRvZXMgbm90IGhhdmUKICAgICAqICAgICB0aGUgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLCBvciBpZiB0aGUgY2FsbGluZyBhcHAgaXMgdGFyZ2V0aW5nIEFQSSBsZXZlbCAyOSBvcgogICAgICogICAgIGhpZ2hlciwgdGhlbiBhIFNlY3VyaXR5RXhjZXB0aW9uIGlzIHRocm93bi48L2xpPgogICAgICogPC91bD4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBObyBzdXBwb3J0IGZvciBkZXZpY2UgLyBwcm9maWxlIG93bmVyIG9yIGNhcnJpZXIgcHJpdmlsZWdlcyAoYi83Mjk2NzIzNikuCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldFNpbVNlcmlhbE51bWJlcigpIHsKICAgICAgICAgcmV0dXJuIGdldFNpbVNlcmlhbE51bWJlcihnZXRTdWJJZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHNlcmlhbCBudW1iZXIgZm9yIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24sIGlmIGFwcGxpY2FibGUuIFJldHVybiBudWxsIGlmIGl0IGlzCiAgICAgKiB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5TdGFydGluZyB3aXRoIEFQSSBsZXZlbCAyOSwgcGVyc2lzdGVudCBkZXZpY2UgaWRlbnRpZmllcnMgYXJlIGd1YXJkZWQgYmVoaW5kIGFkZGl0aW9uYWwKICAgICAqIHJlc3RyaWN0aW9ucywgYW5kIGFwcHMgYXJlIHJlY29tbWVuZGVkIHRvIHVzZSByZXNldHRhYmxlIGlkZW50aWZpZXJzIChzZWUgPGEKICAgICAqIGhyZWY9Ii90cmFpbmluZy9hcnRpY2xlcy91c2VyLWRhdGEtaWRzIj5CZXN0IHByYWN0aWNlcyBmb3IgdW5pcXVlIGlkZW50aWZpZXJzPC9hPikuIFRoaXMKICAgICAqIG1ldGhvZCBjYW4gYmUgaW52b2tlZCBpZiBvbmUgb2YgdGhlIGZvbGxvd2luZyByZXF1aXJlbWVudHMgaXMgbWV0OgogICAgICogPHVsPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaGFzIGJlZW4gZ3JhbnRlZCB0aGUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb247IHRoaXMKICAgICAqICAgICBpcyBhIHByaXZpbGVnZWQgcGVybWlzc2lvbiB0aGF0IGNhbiBvbmx5IGJlIGdyYW50ZWQgdG8gYXBwcyBwcmVsb2FkZWQgb24gdGhlIGRldmljZS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRoZSBkZXZpY2Ugb3IgcHJvZmlsZSBvd25lciBhbmQgaGFzIGJlZW4gZ3JhbnRlZCB0aGUKICAgICAqICAgICB7QGxpbmsgTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFfSBwZXJtaXNzaW9uLiBUaGUgcHJvZmlsZSBvd25lciBpcyBhbiBhcHAgdGhhdAogICAgICogICAgIG93bnMgYSBtYW5hZ2VkIHByb2ZpbGUgb24gdGhlIGRldmljZTsgZm9yIG1vcmUgZGV0YWlscyBzZWUgPGEKICAgICAqICAgICBocmVmPSJodHRwczovL2RldmVsb3Blci5hbmRyb2lkLmNvbS93b3JrL21hbmFnZWQtcHJvZmlsZXMiPldvcmsgcHJvZmlsZXM8L2E+LgogICAgICogICAgIFByb2ZpbGUgb3duZXIgYWNjZXNzIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSByZWxlYXNlLgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRoZSBkZWZhdWx0IFNNUyByb2xlIGhvbGRlciAoc2VlIHtAbGluawogICAgICogICAgIFJvbGVNYW5hZ2VyI2lzUm9sZUhlbGQoU3RyaW5nKX0pLgogICAgICogPC91bD4KICAgICAqCiAgICAgKiA8cD5JZiB0aGUgY2FsbGluZyBhcHAgZG9lcyBub3QgbWVldCBvbmUgb2YgdGhlc2UgcmVxdWlyZW1lbnRzIHRoZW4gdGhpcyBtZXRob2Qgd2lsbCBiZWhhdmUKICAgICAqIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogPHVsPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBoYXMgdGhlCiAgICAgKiAgICAgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uIHRoZW4gbnVsbCBpcyByZXR1cm5lZC48L2xpPgogICAgICogICAgIDxsaT5JZiB0aGUgY2FsbGluZyBhcHAncyB0YXJnZXQgU0RLIGlzIEFQSSBsZXZlbCAyOCBvciBsb3dlciBhbmQgdGhlIGFwcCBkb2VzIG5vdCBoYXZlCiAgICAgKiAgICAgdGhlIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiwgb3IgaWYgdGhlIGNhbGxpbmcgYXBwIGlzIHRhcmdldGluZyBBUEkgbGV2ZWwgMjkgb3IKICAgICAqICAgICBoaWdoZXIsIHRoZW4gYSBTZWN1cml0eUV4Y2VwdGlvbiBpcyB0aHJvd24uPC9saT4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIGZvciB3aGljaCBTaW0gU2VyaWFsIG51bWJlciBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdHJpbmcgZ2V0U2ltU2VyaWFsTnVtYmVyKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldEljY1NlcmlhbE51bWJlckZvclN1YnNjcmliZXIoc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gaWYgdGhlIGN1cnJlbnQgcmFkaW8gY2FuIHN1cHBvcnQgYm90aCAzR1BQIGFuZCAzR1BQMiByYWRpbyB0ZWNobm9sb2dpZXMgYXQgdGhlIHNhbWUKICAgICAqIHRpbWUuIFRoaXMgaXMgYWxzbyBrbm93biBhcyBnbG9iYWwgbW9kZSwgd2hpY2ggaW5jbHVkZXMgTFRFLCBDRE1BLCBFdkRvIGFuZCBHU00vV0NETUEuCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKX0uCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgM0dQUCBhbmQgM0dQUDIgcmFkaW8gdGVjaG5vbG9naWVzIGNhbiBiZSBzdXBwb3J0ZWQgYXQgdGhlIHNhbWUgdGltZQogICAgICogICAgICAgICB7QGNvZGUgZmFsc2V9IGlmIG5vdCBzdXBwb3J0ZWQgb3IgdW5rbm93bgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaXNMdGVDZG1hRXZkb0dzbVdjZG1hRW5hYmxlZCgpIHsKICAgICAgICByZXR1cm4gZ2V0THRlT25DZG1hTW9kZShnZXRTdWJJZCgpKSA9PSBQaG9uZUNvbnN0YW50cy5MVEVfT05fQ0RNQV9UUlVFOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIGlmIHRoZSBjdXJyZW50IHJhZGlvIGlzIExURSBvbiBDRE1BIGZvciBTdWJzY3JpcHRpb24uIFRoaXMKICAgICAqIGlzIGEgdHJpLXN0YXRlIHJldHVybiB2YWx1ZSBhcyBmb3IgYSBwZXJpb2Qgb2YgdGltZQogICAgICogdGhlIG1vZGUgbWF5IGJlIHVua25vd24uCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIGZvciB3aGljaCByYWRpbyBpcyBMVEUgb24gQ0RNQSBpcyByZXR1cm5lZAogICAgICogQHJldHVybiB7QGxpbmsgUGhvbmVDb25zdGFudHMjTFRFX09OX0NETUFfVU5LTk9XTn0sIHtAbGluayBQaG9uZUNvbnN0YW50cyNMVEVfT05fQ0RNQV9GQUxTRX0KICAgICAqIG9yIHtAbGluayBQaG9uZUNvbnN0YW50cyNMVEVfT05fQ0RNQV9UUlVFfQogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBpbnQgZ2V0THRlT25DZG1hTW9kZShpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLkxURV9PTl9DRE1BX1VOS05PV047CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0THRlT25DZG1hTW9kZUZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gQXNzdW1lIG5vIElDQyBjYXJkIGlmIHJlbW90ZSBleGNlcHRpb24gd2hpY2ggc2hvdWxkbid0IGhhcHBlbgogICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuTFRFX09OX0NETUFfVU5LTk9XTjsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBQaG9uZUNvbnN0YW50cy5MVEVfT05fQ0RNQV9VTktOT1dOOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgY2FyZCBJRCBvZiB0aGUgZGVmYXVsdCBlVUlDQyBjYXJkLiBJZiB0aGUgZVVJQ0NzIGhhdmUgbm90IHlldCBiZWVuIGxvYWRlZCwgcmV0dXJucwogICAgICoge0BsaW5rICNVTklOSVRJQUxJWkVEX0NBUkRfSUR9LiBJZiB0aGVyZSBpcyBubyBlVUlDQyBvciB0aGUgZGV2aWNlIGRvZXMgbm90IHN1cHBvcnQgY2FyZCBJRHMKICAgICAqIGZvciBlVUlDQ3MsIHJldHVybnMge0BsaW5rICNVTlNVUFBPUlRFRF9DQVJEX0lEfS4KICAgICAqCiAgICAgKiA8cD5UaGUgY2FyZCBJRCBpcyBhIHVuaXF1ZSBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCBhIFVJQ0Mgb3IgZVVJQ0MgY2FyZC4gQ2FyZCBJRHMgYXJlCiAgICAgKiB1bmlxdWUgdG8gYSBkZXZpY2UsIGFuZCBhbHdheXMgcmVmZXIgdG8gdGhlIHNhbWUgVUlDQyBvciBlVUlDQyBjYXJkIHVubGVzcyB0aGUgZGV2aWNlIGdvZXMKICAgICAqIHRocm91Z2ggYSBmYWN0b3J5IHJlc2V0LgogICAgICoKICAgICAqIEByZXR1cm4gY2FyZCBJRCBvZiB0aGUgZGVmYXVsdCBlVUlDQyBjYXJkLCBpZiBsb2FkZWQuCiAgICAgKi8KICAgIHB1YmxpYyBpbnQgZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVTklOSVRJQUxJWkVEX0NBUkRfSUQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MobVN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIHJldHVybiBVTklOSVRJQUxJWkVEX0NBUkRfSUQ7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBpbmZvcm1hdGlvbiBhYm91dCBjdXJyZW50bHkgaW5zZXJ0ZWQgVUlDQ3MgYW5kIGVVSUNDcy4KICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqIDxwPgogICAgICogSWYgdGhlIGNhbGxlciBoYXMgY2FycmllciBwcml2aWxpZ2VzIG9uIGFueSBhY3RpdmUgc3Vic2NyaXB0aW9uLCB0aGVuIHRoZXkgaGF2ZSBwZXJtaXNzaW9uIHRvCiAgICAgKiBnZXQgc2ltcGxlIGluZm9ybWF0aW9uIGxpa2UgdGhlIGNhcmQgSUQgKHtAbGluayBVaWNjQ2FyZEluZm8jZ2V0Q2FyZElkKCl9KSwgd2hldGhlciB0aGUgY2FyZAogICAgICogaXMgYW4gZVVJQ0MgKHtAbGluayBVaWNjQ2FyZEluZm8jaXNFdWljYygpfSksIGFuZCB0aGUgc2xvdCBpbmRleCB3aGVyZSB0aGUgY2FyZCBpcyBpbnNlcnRlZAogICAgICogKHtAbGluayBVaWNjQ2FyZEluZm8jZ2V0U2xvdEluZGV4KCl9KS4KICAgICAqIDxwPgogICAgICogVG8gZ2V0IHByaXZhdGUgaW5mb3JtYXRpb24gc3VjaCBhcyB0aGUgRUlEICh7QGxpbmsgVWljY0NhcmRJbmZvI2dldEVpZCgpfSkgb3IgSUNDSUQKICAgICAqICh7QGxpbmsgVWljY0NhcmRJbmZvI2dldEljY0lkKCl9KSwgdGhlIGNhbGxlciBtdXN0IGhhdmUgY2FycmllciBwcml2aWxpZ2VzIG9uIHRoYXQgc3BlY2lmaWMKICAgICAqIFVJQ0Mgb3IgZVVJQ0MgY2FyZC4KICAgICAqIDxwPgogICAgICogU2VlIHtAbGluayBVaWNjQ2FyZEluZm99IGZvciBtb3JlIGRldGFpbHMgb24gdGhlIGtpbmQgb2YgaW5mb3JtYXRpb24gYXZhaWxhYmxlLgogICAgICoKICAgICAqIEByZXR1cm4gYSBsaXN0IG9mIFVpY2NDYXJkSW5mbyBvYmplY3RzLCByZXByZXNlbnRpbmcgaW5mb3JtYXRpb24gb24gdGhlIGN1cnJlbnRseSBpbnNlcnRlZAogICAgICogVUlDQ3MgYW5kIGVVSUNDcy4gRWFjaCBVaWNjQ2FyZEluZm8gaW4gdGhlIGxpc3Qgd2lsbCBoYXZlIHByaXZhdGUgaW5mb3JtYXRpb24gZmlsdGVyZWQgb3V0IGlmCiAgICAgKiB0aGUgY2FsbGVyIGRvZXMgbm90IGhhdmUgYWRlcXVhdGUgcGVybWlzc2lvbnMgZm9yIHRoYXQgY2FyZC4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBMaXN0PFVpY2NDYXJkSW5mbz4gZ2V0VWljY0NhcmRzSW5mbygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBpbiBnZXRVaWNjQ2FyZHNJbmZvOiB1bmFibGUgdG8gY29ubmVjdCB0byBUZWxlcGhvbnkgc2VydmljZS4iKTsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXlMaXN0PFVpY2NDYXJkSW5mbz4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldFVpY2NDYXJkc0luZm8obUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBpbiBnZXRVaWNjQ2FyZHNJbmZvOiAiICsgZSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXlMaXN0PFVpY2NDYXJkSW5mbz4oKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIGFsbCB0aGUgVUlDQyBzbG90cy4gVGhlIG9iamVjdHMgaW4gdGhlIGFycmF5IGNhbiBiZSBudWxsIGlmIHRoZSBzbG90IGluZm8gaXMgbm90CiAgICAgKiBhdmFpbGFibGUsIHdoaWNoIGlzIHBvc3NpYmxlIGJldHdlZW4gcGhvbmUgcHJvY2VzcyBzdGFydGluZyBhbmQgZ2V0dGluZyBzbG90IGluZm8gZnJvbSBtb2RlbS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFVpY2NTbG90SW5mbyBhcnJheS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgVWljY1Nsb3RJbmZvW10gZ2V0VWljY1Nsb3RzSW5mbygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldFVpY2NTbG90c0luZm8oKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUZXN0IG1ldGhvZCB0byByZWxvYWQgdGhlIFVJQ0MgcHJvZmlsZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVGVzdEFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgcmVmcmVzaFVpY2NQcm9maWxlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICB0ZWxlcGhvbnkucmVmcmVzaFVpY2NQcm9maWxlKG1TdWJJZCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cudyhUQUcsICJSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogTWFwIGxvZ2ljYWxTbG90IHRvIHBoeXNpY2FsU2xvdCwgYW5kIGFjdGl2YXRlIHRoZSBwaHlzaWNhbFNsb3QgaWYgaXQgaXMgaW5hY3RpdmUuIEZvcgogICAgICogZXhhbXBsZSwgcGFzc2luZyB0aGUgcGh5c2ljYWxTbG90cyBhcnJheSBbMSwgMF0gbWVhbnMgbWFwcGluZyB0aGUgZmlyc3QgaXRlbSAxLCB3aGljaCBpcwogICAgICogcGh5c2ljYWwgc2xvdCBpbmRleCAxLCB0byB0aGUgbG9naWNhbCBzbG90IDA7IGFuZCBtYXBwaW5nIHRoZSBzZWNvbmQgaXRlbSAwLCB3aGljaCBpcwogICAgICogcGh5c2ljYWwgc2xvdCBpbmRleCAwLCB0byB0aGUgbG9naWNhbCBzbG90IDEuIFRoZSBpbmRleCBvZiB0aGUgYXJyYXkgbWVhbnMgdGhlIGluZGV4IG9mIHRoZQogICAgICogbG9naWNhbCBzbG90cy4KICAgICAqCiAgICAgKiBAcGFyYW0gcGh5c2ljYWxTbG90cyBUaGUgY29udGVudCBvZiB0aGUgYXJyYXkgcmVwcmVzZW50cyB0aGUgcGh5c2ljYWwgc2xvdCBpbmRleC4gVGhlIGFycmF5CiAgICAgKiAgICAgICAgc2l6ZSBzaG91bGQgYmUgc2FtZSBhcyB7QGxpbmsgI2dldFVpY2NTbG90c0luZm8oKX0uCiAgICAgKiBAcmV0dXJuIGJvb2xlYW4gUmV0dXJuIHRydWUgaWYgdGhlIHN3aXRjaCBzdWNjZWVkcywgZmFsc2UgaWYgdGhlIHN3aXRjaCBmYWlscy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHN3aXRjaFNsb3RzKGludFtdIHBoeXNpY2FsU2xvdHMpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zd2l0Y2hTbG90cyhwaHlzaWNhbFNsb3RzKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBtYXBwaW5nIGZyb20gbG9naWNhbCBzbG90cyB0byBwaHlzaWNhbCBzbG90cy4gVGhlIGtleSBvZiB0aGUgbWFwIGlzIHRoZSBsb2dpY2FsIHNsb3QKICAgICAqIGlkIGFuZCB0aGUgdmFsdWUgaXMgdGhlIHBoeXNpY2FsIHNsb3RzIGlkIG1hcHBlZCB0byB0aGlzIGxvZ2ljYWwgc2xvdCBpZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIGEgbWFwIGluZGljYXRlcyB0aGUgbWFwcGluZyBmcm9tIGxvZ2ljYWwgc2xvdHMgdG8gcGh5c2ljYWwgc2xvdHMuIFRoZSBzaXplIG9mIHRoZSBtYXAKICAgICAqIHNob3VsZCBiZSB7QGxpbmsgI2dldFBob25lQ291bnQoKX0gaWYgc3VjY2Vzcywgb3RoZXJ3aXNlIHJldHVybiBhbiBlbXB0eSBtYXAuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBNYXA8SW50ZWdlciwgSW50ZWdlcj4gZ2V0TG9naWNhbFRvUGh5c2ljYWxTbG90TWFwcGluZygpIHsKICAgICAgICBNYXA8SW50ZWdlciwgSW50ZWdlcj4gc2xvdE1hcHBpbmcgPSBuZXcgSGFzaE1hcDw+KCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW50W10gc2xvdE1hcHBpbmdBcnJheSA9IHRlbGVwaG9ueS5nZXRTbG90c01hcHBpbmcoKTsKICAgICAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgc2xvdE1hcHBpbmdBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHNsb3RNYXBwaW5nLnB1dChpLCBzbG90TWFwcGluZ0FycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgImdldFNsb3RzTWFwcGluZyBSZW1vdGVFeGNlcHRpb24iLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNsb3RNYXBwaW5nOwogICAgfQoKICAgIC8vCiAgICAvLwogICAgLy8gU3Vic2NyaWJlciBJbmZvCiAgICAvLwogICAgLy8KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHVuaXF1ZSBzdWJzY3JpYmVyIElELCBmb3IgZXhhbXBsZSwgdGhlIElNU0kgZm9yIGEgR1NNIHBob25lLgogICAgICogUmV0dXJuIG51bGwgaWYgaXQgaXMgdW5hdmFpbGFibGUuCiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMjksIHBlcnNpc3RlbnQgZGV2aWNlIGlkZW50aWZpZXJzIGFyZSBndWFyZGVkIGJlaGluZCBhZGRpdGlvbmFsCiAgICAgKiByZXN0cmljdGlvbnMsIGFuZCBhcHBzIGFyZSByZWNvbW1lbmRlZCB0byB1c2UgcmVzZXR0YWJsZSBpZGVudGlmaWVycyAoc2VlIDxhCiAgICAgKiBocmVmPSIvdHJhaW5pbmcvYXJ0aWNsZXMvdXNlci1kYXRhLWlkcyI+QmVzdCBwcmFjdGljZXMgZm9yIHVuaXF1ZSBpZGVudGlmaWVyczwvYT4pLiBUaGlzCiAgICAgKiBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBiZWVuIGdyYW50ZWQgdGhlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uOyB0aGlzCiAgICAgKiAgICAgaXMgYSBwcml2aWxlZ2VkIHBlcm1pc3Npb24gdGhhdCBjYW4gb25seSBiZSBncmFudGVkIHRvIGFwcHMgcHJlbG9hZGVkIG9uIHRoZSBkZXZpY2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGV2aWNlIG9yIHByb2ZpbGUgb3duZXIgYW5kIGhhcyBiZWVuIGdyYW50ZWQgdGhlCiAgICAgKiAgICAge0BsaW5rIE1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gcGVybWlzc2lvbi4gVGhlIHByb2ZpbGUgb3duZXIgaXMgYW4gYXBwIHRoYXQKICAgICAqICAgICBvd25zIGEgbWFuYWdlZCBwcm9maWxlIG9uIHRoZSBkZXZpY2U7IGZvciBtb3JlIGRldGFpbHMgc2VlIDxhCiAgICAgKiAgICAgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vd29yay9tYW5hZ2VkLXByb2ZpbGVzIj5Xb3JrIHByb2ZpbGVzPC9hPi4KICAgICAqICAgICBQcm9maWxlIG93bmVyIGFjY2VzcyBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgcmVsZWFzZS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBTTVMgcm9sZSBob2xkZXIgKHNlZSB7QGxpbmsKICAgICAqICAgICBSb2xlTWFuYWdlciNpc1JvbGVIZWxkKFN0cmluZyl9KS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogPHA+SWYgdGhlIGNhbGxpbmcgYXBwIGRvZXMgbm90IG1lZXQgb25lIG9mIHRoZXNlIHJlcXVpcmVtZW50cyB0aGVuIHRoaXMgbWV0aG9kIHdpbGwgYmVoYXZlCiAgICAgKiBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgaGFzIHRoZQogICAgICogICAgIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiB0aGVuIG51bGwgaXMgcmV0dXJuZWQuPC9saT4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgZG9lcyBub3QgaGF2ZQogICAgICogICAgIHRoZSBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24sIG9yIGlmIHRoZSBjYWxsaW5nIGFwcCBpcyB0YXJnZXRpbmcgQVBJIGxldmVsIDI5IG9yCiAgICAgKiAgICAgaGlnaGVyLCB0aGVuIGEgU2VjdXJpdHlFeGNlcHRpb24gaXMgdGhyb3duLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgZm9yIGRldmljZSAvIHByb2ZpbGUgb3duZXIgb3IgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0U3Vic2NyaWJlcklkKCkgewogICAgICAgIHJldHVybiBnZXRTdWJzY3JpYmVySWQoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB1bmlxdWUgc3Vic2NyaWJlciBJRCwgZm9yIGV4YW1wbGUsIHRoZSBJTVNJIGZvciBhIEdTTSBwaG9uZQogICAgICogZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogUmV0dXJuIG51bGwgaWYgaXQgaXMgdW5hdmFpbGFibGUuCiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMjksIHBlcnNpc3RlbnQgZGV2aWNlIGlkZW50aWZpZXJzIGFyZSBndWFyZGVkIGJlaGluZCBhZGRpdGlvbmFsCiAgICAgKiByZXN0cmljdGlvbnMsIGFuZCBhcHBzIGFyZSByZWNvbW1lbmRlZCB0byB1c2UgcmVzZXR0YWJsZSBpZGVudGlmaWVycyAoc2VlIDxhCiAgICAgKiBocmVmPSIvdHJhaW5pbmcvYXJ0aWNsZXMvdXNlci1kYXRhLWlkcyI+QmVzdCBwcmFjdGljZXMgZm9yIHVuaXF1ZSBpZGVudGlmaWVyczwvYT4pLiBUaGlzCiAgICAgKiBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBiZWVuIGdyYW50ZWQgdGhlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uOyB0aGlzCiAgICAgKiAgICAgaXMgYSBwcml2aWxlZ2VkIHBlcm1pc3Npb24gdGhhdCBjYW4gb25seSBiZSBncmFudGVkIHRvIGFwcHMgcHJlbG9hZGVkIG9uIHRoZSBkZXZpY2UuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGV2aWNlIG9yIHByb2ZpbGUgb3duZXIgYW5kIGhhcyBiZWVuIGdyYW50ZWQgdGhlCiAgICAgKiAgICAge0BsaW5rIE1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gcGVybWlzc2lvbi4gVGhlIHByb2ZpbGUgb3duZXIgaXMgYW4gYXBwIHRoYXQKICAgICAqICAgICBvd25zIGEgbWFuYWdlZCBwcm9maWxlIG9uIHRoZSBkZXZpY2U7IGZvciBtb3JlIGRldGFpbHMgc2VlIDxhCiAgICAgKiAgICAgaHJlZj0iaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vd29yay9tYW5hZ2VkLXByb2ZpbGVzIj5Xb3JrIHByb2ZpbGVzPC9hPi4KICAgICAqICAgICBQcm9maWxlIG93bmVyIGFjY2VzcyBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgcmVsZWFzZS4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKiAgICAgPGxpPklmIHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBTTVMgcm9sZSBob2xkZXIgKHNlZSB7QGxpbmsKICAgICAqICAgICBSb2xlTWFuYWdlciNpc1JvbGVIZWxkKFN0cmluZyl9KS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogPHA+SWYgdGhlIGNhbGxpbmcgYXBwIGRvZXMgbm90IG1lZXQgb25lIG9mIHRoZXNlIHJlcXVpcmVtZW50cyB0aGVuIHRoaXMgbWV0aG9kIHdpbGwgYmVoYXZlCiAgICAgKiBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgaGFzIHRoZQogICAgICogICAgIFJFQURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbiB0aGVuIG51bGwgaXMgcmV0dXJuZWQuPC9saT4KICAgICAqICAgICA8bGk+SWYgdGhlIGNhbGxpbmcgYXBwJ3MgdGFyZ2V0IFNESyBpcyBBUEkgbGV2ZWwgMjggb3IgbG93ZXIgYW5kIHRoZSBhcHAgZG9lcyBub3QgaGF2ZQogICAgICogICAgIHRoZSBSRUFEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24sIG9yIGlmIHRoZSBjYWxsaW5nIGFwcCBpcyB0YXJnZXRpbmcgQVBJIGxldmVsIDI5IG9yCiAgICAgKiAgICAgaGlnaGVyLCB0aGVuIGEgU2VjdXJpdHlFeGNlcHRpb24gaXMgdGhyb3duLjwvbGk+CiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB3aG9zZSBzdWJzY3JpYmVyIGlkIGlzIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgU3RyaW5nIGdldFN1YnNjcmliZXJJZChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gaW5mby5nZXRTdWJzY3JpYmVySWRGb3JTdWJzY3JpYmVyKHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYXJyaWVyIHNwZWNpZmljIGluZm9ybWF0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGVuY3J5cHQgdGhlIElNU0kgYW5kIElNUEksCiAgICAgKiBpbmNsdWRpbmcgdGhlIHB1YmxpYyBrZXkgYW5kIHRoZSBrZXkgaWRlbnRpZmllcjsgb3Ige0Bjb2RlIG51bGx9IGlmIG5vdCBhdmFpbGFibGUuCiAgICAgKiA8cD4KICAgICAqIEZvciBhIG11bHRpLXNpbSBkZXZpY2UsIHRoZSBkYWZhdWx0IGRhdGEgc2ltIGlzIHVzZWQgaWYgbm90IHNwZWNpZmllZC4KICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjogUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLgogICAgICoKICAgICAqIEBwYXJhbSBrZXlUeXBlIHdoZXRoZXIgdGhlIGtleSBpcyBiZWluZyB1c2VkIGZvciBFUERHIG9yIFdMQU4uIFZhbGlkIHZhbHVlcyBhcmUKICAgICAqICAgICAgICB7QGxpbmsgI0tFWV9UWVBFX0VQREd9IG9yIHtAbGluayAjS0VZX1RZUEVfV0xBTn0uCiAgICAgKiBAcmV0dXJuIEltc2lFbmNyeXB0aW9uSW5mbyBDYXJyaWVyIHNwZWNpZmljIGluZm9ybWF0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGVuY3J5cHQgdGhlCiAgICAgKiAgICAgICAgIElNU0kgYW5kIElNUEkuIFRoaXMgaW5jbHVkZXMgdGhlIHB1YmxpYyBrZXkgYW5kIHRoZSBrZXkgaWRlbnRpZmllci4gVGhpcyBpbmZvcm1hdGlvbgogICAgICogICAgICAgICB3aWxsIGJlIHN0b3JlZCBpbiB0aGUgZGV2aWNlIGtleXN0b3JlLiB7QGNvZGUgbnVsbH0gd2lsbCBiZSByZXR1cm5lZCB3aGVuIG5vIGtleSBpcwogICAgICogICAgICAgICBmb3VuZCwgYW5kIHRoZSBjYXJyaWVyIGRvZXMgbm90IHJlcXVpcmUgYSBrZXkuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiB3aGVuIGFuIGludmFsaWQga2V5IGlzIGZvdW5kIG9yIHdoZW4ga2V5IGlzIHJlcXVpcmVkIGJ1dAogICAgICogICAgICAgICBub3QgZm91bmQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBJbXNpRW5jcnlwdGlvbkluZm8gZ2V0Q2FycmllckluZm9Gb3JJbXNpRW5jcnlwdGlvbihAS2V5VHlwZSBpbnQga2V5VHlwZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSbG9nLmUoVEFHLCJJTVNJIGVycm9yOiBTdWJzY3JpYmVyIEluZm8gaXMgbnVsbCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IHN1YklkID0gZ2V0U3ViSWQoU3Vic2NyaXB0aW9uTWFuYWdlci5nZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkpOwogICAgICAgICAgICBpZiAoa2V5VHlwZSAhPSBLRVlfVFlQRV9FUERHICYmIGtleVR5cGUgIT0gS0VZX1RZUEVfV0xBTikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigiSU1TSSBlcnJvcjogSW52YWxpZCBrZXkgdHlwZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEltc2lFbmNyeXB0aW9uSW5mbyBpbXNpRW5jcnlwdGlvbkluZm8gPSBpbmZvLmdldENhcnJpZXJJbmZvRm9ySW1zaUVuY3J5cHRpb24oCiAgICAgICAgICAgICAgICAgICAgc3ViSWQsIGtleVR5cGUsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICAgICAgICAgIGlmIChpbXNpRW5jcnlwdGlvbkluZm8gPT0gbnVsbCAmJiBpc0ltc2lFbmNyeXB0aW9uUmVxdWlyZWQoc3ViSWQsIGtleVR5cGUpKSB7CiAgICAgICAgICAgICAgICBSbG9nLmUoVEFHLCAiSU1TSSBlcnJvcjoga2V5IGlzIHJlcXVpcmVkIGJ1dCBub3QgZm91bmQiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oIklNU0kgZXJyb3I6IGtleSBpcyByZXF1aXJlZCBidXQgbm90IGZvdW5kIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGltc2lFbmNyeXB0aW9uSW5mbzsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldENhcnJpZXJJbmZvRm9ySW1zaUVuY3J5cHRpb24gUmVtb3RlRXhjZXB0aW9uIiArIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRDYXJyaWVySW5mb0Zvckltc2lFbmNyeXB0aW9uIE51bGxQb2ludGVyRXhjZXB0aW9uIiArIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXNldHMgdGhlIGNhcnJpZXIga2V5cyB1c2VkIHRvIGVuY3J5cHQgdGhlIElNU0kgYW5kIElNUEkuCiAgICAgKiA8cD4KICAgICAqIFRoaXMgaW52b2x2ZXMgMiBzdGVwczoKICAgICAqICAxLiBEZWxldGUgdGhlIGtleXMgZnJvbSB0aGUgZGF0YWJhc2UuCiAgICAgKiAgMi4gU2VuZCBhbiBpbnRlbnQgdG8gZG93bmxvYWQgbmV3IENlcnRpZmljYXRlcy4KICAgICAqIDxwPgogICAgICogRm9yIGEgbXVsdGktc2ltIGRldmljZSwgdGhlIGRhZmF1bHQgZGF0YSBzaW0gaXMgdXNlZCBpZiBub3Qgc3BlY2lmaWVkLgogICAgICogPHA+CiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOiBNT0RJRllfUEhPTkVfU1RBVEUuCiAgICAgKgogICAgICogQHNlZSAjZ2V0Q2FycmllckluZm9Gb3JJbXNpRW5jcnlwdGlvbgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHZvaWQgcmVzZXRDYXJyaWVyS2V5c0Zvckltc2lFbmNyeXB0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSbG9nLmUoVEFHLCAiSU1TSSBlcnJvcjogU3Vic2NyaWJlciBJbmZvIGlzIG51bGwiKTsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUV4Y2VwdGlvbigiSU1TSSBlcnJvcjogU3Vic2NyaWJlciBJbmZvIGlzIG51bGwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgc3ViSWQgPSBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSk7CiAgICAgICAgICAgIGluZm8ucmVzZXRDYXJyaWVyS2V5c0Zvckltc2lFbmNyeXB0aW9uKHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0Q2FycmllckluZm9Gb3JJbXNpRW5jcnlwdGlvbiBSZW1vdGVFeGNlcHRpb24iICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAvKioKICAgICAqIEBwYXJhbSBrZXlBdmFpbGFiaWxpdHkgYml0bWFzayB0aGF0IGRlZmluZXMgdGhlIGF2YWlsYWJpbHR5IG9mIGtleXMgZm9yIGEgdHlwZS4KICAgICAqIEBwYXJhbSBrZXlUeXBlIHRoZSBrZXkgdHlwZSB3aGljaCBpcyBiZWluZyBjaGVja2VkLiAoV0xBTiwgRVBERykKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgZGlnaXQgYXQgcG9zaXRpb24ga2V5VHlwZSBpcyAxLCBlbHNlIGZhbHNlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgYm9vbGVhbiBpc0tleUVuYWJsZWQoaW50IGtleUF2YWlsYWJpbGl0eSwgQEtleVR5cGUgaW50IGtleVR5cGUpIHsKICAgICAgICBpbnQgcmV0dXJuVmFsdWUgPSAoa2V5QXZhaWxhYmlsaXR5ID4+IChrZXlUeXBlIC0gMSkpICYgMTsKICAgICAgICByZXR1cm4gKHJldHVyblZhbHVlID09IDEpID8gdHJ1ZSA6IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogSWYgQ2FycmllciByZXF1aXJlcyBJbXNpIHRvIGJlIGVuY3J5cHRlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHByaXZhdGUgYm9vbGVhbiBpc0ltc2lFbmNyeXB0aW9uUmVxdWlyZWQoaW50IHN1YklkLCBAS2V5VHlwZSBpbnQga2V5VHlwZSkgewogICAgICAgIENhcnJpZXJDb25maWdNYW5hZ2VyIGNvbmZpZ01hbmFnZXIgPQogICAgICAgICAgICAgICAgKENhcnJpZXJDb25maWdNYW5hZ2VyKSBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuQ0FSUklFUl9DT05GSUdfU0VSVklDRSk7CiAgICAgICAgaWYgKGNvbmZpZ01hbmFnZXIgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIFBlcnNpc3RhYmxlQnVuZGxlIHBiID0gY29uZmlnTWFuYWdlci5nZXRDb25maWdGb3JTdWJJZChzdWJJZCk7CiAgICAgICAgaWYgKHBiID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpbnQga2V5QXZhaWxhYmlsaXR5ID0gcGIuZ2V0SW50KENhcnJpZXJDb25maWdNYW5hZ2VyLklNU0lfS0VZX0FWQUlMQUJJTElUWV9JTlQpOwogICAgICAgIHJldHVybiBpc0tleUVuYWJsZWQoa2V5QXZhaWxhYmlsaXR5LCBrZXlUeXBlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIENhcnJpZXIgc3BlY2lmaWMgaW5mb3JtYXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gZW5jcnlwdCB0aGUgSU1TSSBhbmQgSU1QSS4KICAgICAqIFRoaXMgaW5jbHVkZXMgdGhlIHB1YmxpYyBrZXkgYW5kIHRoZSBrZXkgaWRlbnRpZmllci4gVGhpcyBpbmZvcm1hdGlvbiB3aWxsIGJlIHN0b3JlZCBpbiB0aGUKICAgICAqIGRldmljZSBrZXlzdG9yZS4KICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICogQHBhcmFtIGltc2lFbmNyeXB0aW9uSW5mbyB3aGljaCBpbmNsdWRlcyB0aGUgS2V5IFR5cGUsIHRoZSBQdWJsaWMgS2V5CiAgICAgKiAgICAgICAgKGphdmEuc2VjdXJpdHkuUHVibGljS2V5KSBhbmQgdGhlIEtleSBJZGVudGlmaWVyLmFuZCB0aGUgS2V5IElkZW50aWZpZXIuCiAgICAgKiAgICAgICAgVGhlIGtleUlkZW50aWZpZXIgQXR0cmlidXRlIHZhbHVlIHBhaXIgdGhhdCBoZWxwcyBhIHNlcnZlciBsb2NhdGUKICAgICAqICAgICAgICB0aGUgcHJpdmF0ZSBrZXkgdG8gZGVjcnlwdCB0aGUgcGVybWFuZW50IGlkZW50aXR5LiBUaGlzIGZpZWxkIGlzCiAgICAgKiAgICAgICAgb3B0aW9uYWwgYW5kIGlmIGl0IGlzIHByZXNlbnQgdGhlbiBpdOKAmXMgYWx3YXlzIHNlcGFyYXRlZCBmcm9tIGVuY3J5cHRlZAogICAgICogICAgICAgIHBlcm1hbmVudCBpZGVudGl0eSB3aXRoIOKAnCzigJ0uIEtleSBpZGVudGlmaWVyIEFWUCBpcyBwcmVzZW50ZWQgaW4gQVNDSUkgc3RyaW5nCiAgICAgKiAgICAgICAgd2l0aCDigJxuYW1lPXZhbHVl4oCdIGZvcm1hdC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldENhcnJpZXJJbmZvRm9ySW1zaUVuY3J5cHRpb24oSW1zaUVuY3J5cHRpb25JbmZvIGltc2lFbmNyeXB0aW9uSW5mbykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKSByZXR1cm47CiAgICAgICAgICAgIGluZm8uc2V0Q2FycmllckluZm9Gb3JJbXNpRW5jcnlwdGlvbihtU3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBpbXNpRW5jcnlwdGlvbkluZm8pOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0Q2FycmllckluZm9Gb3JJbXNpRW5jcnlwdGlvbiBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBHcm91cCBJZGVudGlmaWVyIExldmVsMSBmb3IgYSBHU00gcGhvbmUuCiAgICAgKiBSZXR1cm4gbnVsbCBpZiBpdCBpcyB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN0cmluZyBnZXRHcm91cElkTGV2ZWwxKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldEdyb3VwSWRMZXZlbDFGb3JTdWJzY3JpYmVyKGdldFN1YklkKCksIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBHcm91cCBJZGVudGlmaWVyIExldmVsMSBmb3IgYSBHU00gcGhvbmUgZm9yIGEgcGFydGljdWxhciBzdWJzY3JpcHRpb24uCiAgICAgKiBSZXR1cm4gbnVsbCBpZiBpdCBpcyB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgd2hvc2Ugc3Vic2NyaWJlciBpZCBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldEdyb3VwSWRMZXZlbDEoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVBob25lU3ViSW5mbyBpbmZvID0gZ2V0U3Vic2NyaWJlckluZm9TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpbmZvID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGluZm8uZ2V0R3JvdXBJZExldmVsMUZvclN1YnNjcmliZXIoc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBzZXRMaW5lMU51bWJlcihTdHJpbmcgdmFsdWUpIHsKICAgICAgICBQaG9uZUNvbnN0YW50cy5zZXRNU0lTRE4odmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcGhvbmUgbnVtYmVyIHN0cmluZyBmb3IgbGluZSAxLCBmb3IgZXhhbXBsZSwgdGhlIE1TSVNETgogICAgICogZm9yIGEgR1NNIHBob25lIGZvciBhIHBhcnRpY3VsYXIgc3Vic2NyaXB0aW9uLiBSZXR1cm4gbnVsbCBpZiBpdCBpcyB1bmF2YWlsYWJsZS4KICAgICAqIDxwPgogICAgICogVGhlIGRlZmF1bHQgU01TIGFwcCBjYW4gYWxzbyB1c2UgdGhpcy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9TTVMgUkVBRF9TTVN9LAogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9OVU1CRVJTIFJFQURfUEhPTkVfTlVNQkVSU30sCiAgICAgKiAgICAgdGhhdCB0aGUgY2FsbGVyIGlzIHRoZSBkZWZhdWx0IFNNUyBhcHAsCiAgICAgKiAgICAgb3IgdGhhdCB0aGUgY2FsbGVyIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkKICAgICAqICAgICBmb3IgYW55IEFQSSBsZXZlbC4KICAgICAqICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqICAgICBmb3IgYXBwcyB0YXJnZXRpbmcgU0RLIEFQSSBsZXZlbCAyOSBhbmQgYmVsb3cuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzIG9yIGRlZmF1bHQgU01TIGFwcAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1NNUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUwogICAgfSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TGluZTFOdW1iZXIoKSB7CiAgICAgICAgcmV0dXJuIGdldExpbmUxTnVtYmVyKGdldFN1YklkKCkpOwogICAgICAgIC8vcmV0dXJuIGdldExpbmUxTnVtYmVyKGdldFN1YklkKCkpOwogICAgICAgIHJldHVybiBQaG9uZUNvbnN0YW50cy5nZXRNU0lTRE4oKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHBob25lIG51bWJlciBzdHJpbmcgZm9yIGxpbmUgMSwgZm9yIGV4YW1wbGUsIHRoZSBNU0lTRE4KICAgICAqIGZvciBhIEdTTSBwaG9uZSBmb3IgYSBwYXJ0aWN1bGFyIHN1YnNjcmlwdGlvbi4gUmV0dXJuIG51bGwgaWYgaXQgaXMgdW5hdmFpbGFibGUuCiAgICAgKiA8cD4KICAgICAqIFRoZSBkZWZhdWx0IFNNUyBhcHAgY2FuIGFsc28gdXNlIHRoaXMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfU01TIFJFQURfU01TfSwKICAgICAqICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfTlVNQkVSUyBSRUFEX1BIT05FX05VTUJFUlN9LAogICAgICogICAgIHRoYXQgdGhlIGNhbGxlciBpcyB0aGUgZGVmYXVsdCBTTVMgYXBwLAogICAgICogICAgIG9yIHRoYXQgdGhlIGNhbGxlciBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pCiAgICAgKiAgICAgZm9yIGFueSBBUEkgbGV2ZWwuCiAgICAgKiAgICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiAgICAgZm9yIGFwcHMgdGFyZ2V0aW5nIFNESyBBUEkgbGV2ZWwgMjkgYW5kIGJlbG93LgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB3aG9zZSBwaG9uZSBudW1iZXIgZm9yIGxpbmUgMSBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1NNUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUwogICAgfSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldExpbmUxTnVtYmVyKGludCBzdWJJZCkgewogICAgICAgIFN0cmluZyBudW1iZXIgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICBudW1iZXIgPSB0ZWxlcGhvbnkuZ2V0TGluZTFOdW1iZXJGb3JEaXNwbGF5KHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgLy9JVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgLy9udW1iZXIgPSB0ZWxlcGhvbnkuZ2V0TGluZTFOdW1iZXJGb3JEaXNwbGF5KHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgIC8vICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIG51bWJlciA9IFBob25lQ29uc3RhbnRzLmdldE1TSVNETigpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXIgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVtYmVyOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gaW5mby5nZXRMaW5lMU51bWJlckZvclN1YnNjcmliZXIoc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgLy9yZXR1cm4gaW5mby5nZXRMaW5lMU51bWJlckZvclN1YnNjcmliZXIoc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgLy8gICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuZ2V0TVNJU0ROKCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBsaW5lIDEgcGhvbmUgbnVtYmVyIHN0cmluZyBhbmQgaXRzIGFscGhhdGFnIGZvciB0aGUgY3VycmVudCBJQ0NJRAogICAgICogZm9yIGRpc3BsYXkgcHVycG9zZSBvbmx5LCBmb3IgZXhhbXBsZSwgZGlzcGxheWVkIGluIFBob25lIFN0YXR1cy4gSXQgd29uJ3QKICAgICAqIGNoYW5nZSB0aGUgYWN0dWFsIE1TSVNETi9NRE4uIFRvIHVuc2V0IGFscGhhdGFnIG9yIG51bWJlciwgcGFzcyBpbiBhIG51bGwKICAgICAqIHZhbHVlLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGFscGhhVGFnIGFscGhhLXRhZ2dpbmcgb2YgdGhlIGRhaWxpbmcgbnVibWVyCiAgICAgKiBAcGFyYW0gbnVtYmVyIFRoZSBkaWFsaW5nIG51bWJlcgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBvcGVyYXRpb24gd2FzIGV4ZWN1dGVkIGNvcnJlY3RseS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0TGluZTFOdW1iZXJGb3JEaXNwbGF5KFN0cmluZyBhbHBoYVRhZywgU3RyaW5nIG51bWJlcikgewogICAgICAgIHJldHVybiBzZXRMaW5lMU51bWJlckZvckRpc3BsYXkoZ2V0U3ViSWQoKSwgYWxwaGFUYWcsIG51bWJlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGxpbmUgMSBwaG9uZSBudW1iZXIgc3RyaW5nIGFuZCBpdHMgYWxwaGF0YWcgZm9yIHRoZSBjdXJyZW50IElDQ0lECiAgICAgKiBmb3IgZGlzcGxheSBwdXJwb3NlIG9ubHksIGZvciBleGFtcGxlLCBkaXNwbGF5ZWQgaW4gUGhvbmUgU3RhdHVzLiBJdCB3b24ndAogICAgICogY2hhbmdlIHRoZSBhY3R1YWwgTVNJU0ROL01ETi4gVG8gdW5zZXQgYWxwaGF0YWcgb3IgbnVtYmVyLCBwYXNzIGluIGEgbnVsbAogICAgICogdmFsdWUuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhhdCB0aGUgYWxwaGF0YWcgYW5kIGRpYWxpbmcgbnVtYmVyIGJlbG9uZ3MgdG8uCiAgICAgKiBAcGFyYW0gYWxwaGFUYWcgYWxwaGEtdGFnZ2luZyBvZiB0aGUgZGFpbGluZyBudWJtZXIKICAgICAqIEBwYXJhbSBudW1iZXIgVGhlIGRpYWxpbmcgbnVtYmVyCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIG9wZXJhdGlvbiB3YXMgZXhlY3V0ZWQgY29ycmVjdGx5LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0TGluZTFOdW1iZXJGb3JEaXNwbGF5KGludCBzdWJJZCwgU3RyaW5nIGFscGhhVGFnLCBTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuc2V0TGluZTFOdW1iZXJGb3JEaXNwbGF5Rm9yU3Vic2NyaWJlcihzdWJJZCwgYWxwaGFUYWcsIG51bWJlcik7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgYWxwaGFiZXRpYyBpZGVudGlmaWVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgbGluZSAxIG51bWJlci4KICAgICAqIFJldHVybiBudWxsIGlmIGl0IGlzIHVuYXZhaWxhYmxlLgogICAgICogQGhpZGUKICAgICAqIG5vYm9keSBzZWVtcyB0byBjYWxsIHRoaXMuCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBAVGVzdEFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TGluZTFBbHBoYVRhZygpIHsKICAgICAgICByZXR1cm4gZ2V0TGluZTFBbHBoYVRhZyhnZXRTdWJJZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGFscGhhYmV0aWMgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggdGhlIGxpbmUgMSBudW1iZXIKICAgICAqIGZvciBhIHN1YnNjcmlwdGlvbi4KICAgICAqIFJldHVybiBudWxsIGlmIGl0IGlzIHVuYXZhaWxhYmxlLgogICAgICogQHBhcmFtIHN1YklkIHdob3NlIGFscGhhYmV0aWMgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggbGluZSAxIGlzIHJldHVybmVkCiAgICAgKiBub2JvZHkgc2VlbXMgdG8gY2FsbCB0aGlzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldExpbmUxQWxwaGFUYWcoaW50IHN1YklkKSB7CiAgICAgICAgU3RyaW5nIGFscGhhVGFnID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgYWxwaGFUYWcgPSB0ZWxlcGhvbnkuZ2V0TGluZTFBbHBoYVRhZ0ZvckRpc3BsYXkoc3ViSWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgaWYgKGFscGhhVGFnICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGFscGhhVGFnOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gaW5mby5nZXRMaW5lMUFscGhhVGFnRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgc2V0IG9mIHN1YnNjcmliZXIgSURzIHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgIm1lcmdlZCB0b2dldGhlciIgZm9yIGRhdGEgdXNhZ2UKICAgICAqIHB1cnBvc2VzLiBUaGlzIGlzIGNvbW1vbmx5IHtAY29kZSBudWxsfSB0byBpbmRpY2F0ZSBubyBtZXJnaW5nIGlzIHJlcXVpcmVkLiBBbnkgcmV0dXJuZWQKICAgICAqIHN1YnNjcmliZXJzIGFyZSBzb3J0ZWQgaW4gYSBkZXRlcm1pbmlzdGljIG9yZGVyLgogICAgICogPHA+CiAgICAgKiBUaGUgcmV0dXJuZWQgc2V0IG9mIHN1YnNjcmliZXIgSURzIHdpbGwgaW5jbHVkZSB0aGUgc3Vic2NyaWJlciBJRCBjb3JyZXNwb25kaW5nIHRvIHRoaXMKICAgICAqIFRlbGVwaG9ueU1hbmFnZXIncyBzdWJJZC4KICAgICAqCiAgICAgKiBUaGlzIGlzIGRlcHJlY2F0ZWQgYW5kIHtAbGluayAjZ2V0TWVyZ2VkSW1zaXNGcm9tR3JvdXAoKX0gc2hvdWxkIGJlIHVzZWQgZm9yIGRhdGEKICAgICAqIHVzYWdlIG1lcmdpbmcgcHVycG9zZS4KICAgICAqIFRPRE86IHJlbW92ZSB0aGlzIEFQSS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBATnVsbGFibGUgU3RyaW5nW10gZ2V0TWVyZ2VkU3Vic2NyaWJlcklkcygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRNZXJnZWRTdWJzY3JpYmVySWRzKGdldFN1YklkKCksIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHNldCBvZiBJTVNJcyB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkICJtZXJnZWQgdG9nZXRoZXIiIGZvciBkYXRhIHVzYWdlCiAgICAgKiBwdXJwb3Nlcy4gVW5saWtlIHtAbGluayAjZ2V0TWVyZ2VkU3Vic2NyaWJlcklkcygpfSB0aGlzIEFQSSBtZXJnZSBJTVNJcyBiYXNlZCBvbgogICAgICogc3Vic2NyaXB0aW9uIGdyb3VwaW5nOiBJTVNJIG9mIHRob3NlIGluIHRoZSBzYW1lIGdyb3VwIHdpbGwgYWxsIGJlIHJldHVybmVkLgogICAgICogUmV0dXJuIHRoZSBjdXJyZW50IElNU0kgaWYgdGhlcmUgaXMgbm8gc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoZSBjYWxsaW5nIGFwcCB0byBoYXZlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBTdHJpbmdbXSBnZXRNZXJnZWRJbXNpc0Zyb21Hcm91cCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldE1lcmdlZEltc2lzRnJvbUdyb3VwKGdldFN1YklkKCksIGdldE9wUGFja2FnZU5hbWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFN0cmluZ1swXTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE1TSVNETiBzdHJpbmcgZm9yIGEgR1NNIHBob25lLiBSZXR1cm4gbnVsbCBpZiBpdCBpcyB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9TTVMgUkVBRF9TTVN9LAogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9OVU1CRVJTIFJFQURfUEhPTkVfTlVNQkVSU30sCiAgICAgKiAgICAgdGhhdCB0aGUgY2FsbGVyIGlzIHRoZSBkZWZhdWx0IFNNUyBhcHAsCiAgICAgKiAgICAgb3IgdGhhdCB0aGUgY2FsbGVyIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkKICAgICAqICAgICBmb3IgYW55IEFQSSBsZXZlbC4KICAgICAqICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqICAgICBmb3IgYXBwcyB0YXJnZXRpbmcgU0RLIEFQSSBsZXZlbCAyOSBhbmQgYmVsb3cuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1NNUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUwogICAgfSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldE1zaXNkbigpIHsKICAgICAgICByZXR1cm4gZ2V0TXNpc2RuKGdldFN1YklkKCkpOwogICAgICAgIC8vcmV0dXJuIGdldE1zaXNkbihnZXRTdWJJZCgpKTsKICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuZ2V0TVNJU0ROKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNU0lTRE4gc3RyaW5nIGZvciBhIEdTTSBwaG9uZS4gUmV0dXJuIG51bGwgaWYgaXQgaXMgdW5hdmFpbGFibGUuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIGZvciB3aGljaCBtc2lzZG4gaXMgcmV0dXJuZWQKICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9TTVMgUkVBRF9TTVN9LAogICAgICogICAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9OVU1CRVJTIFJFQURfUEhPTkVfTlVNQkVSU30sCiAgICAgKiAgICAgdGhhdCB0aGUgY2FsbGVyIGlzIHRoZSBkZWZhdWx0IFNNUyBhcHAsCiAgICAgKiAgICAgb3IgdGhhdCB0aGUgY2FsbGVyIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkKICAgICAqICAgICBmb3IgYW55IEFQSSBsZXZlbC4KICAgICAqICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqICAgICBmb3IgYXBwcyB0YXJnZXRpbmcgU0RLIEFQSSBsZXZlbCAyOSBhbmQgYmVsb3cuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1NNUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUwogICAgfSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0TXNpc2RuKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldE1zaXNkbkZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIC8vcmV0dXJuIGluZm8uZ2V0TXNpc2RuRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLmdldE1TSVNETigpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZvaWNlIG1haWwgbnVtYmVyLiBSZXR1cm4gbnVsbCBpZiBpdCBpcyB1bmF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN0cmluZyBnZXRWb2ljZU1haWxOdW1iZXIoKSB7CiAgICAgICAgcmV0dXJuIGdldFZvaWNlTWFpbE51bWJlcihnZXRTdWJJZCgpKTsKICAgICAgICAvL3JldHVybiBnZXRWb2ljZU1haWxOdW1iZXIoZ2V0U3ViSWQoKSk7CiAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLmdldE1TSVNETigpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdm9pY2UgbWFpbCBudW1iZXIgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogUmV0dXJuIG51bGwgaWYgaXQgaXMgdW5hdmFpbGFibGUuCiAgICAgKiBAcGFyYW0gc3ViSWQgd2hvc2Ugdm9pY2UgbWFpbCBudW1iZXIgaXMgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN0cmluZyBnZXRWb2ljZU1haWxOdW1iZXIoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVBob25lU3ViSW5mbyBpbmZvID0gZ2V0U3Vic2NyaWJlckluZm9TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpbmZvID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGluZm8uZ2V0Vm9pY2VNYWlsTnVtYmVyRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICAvL3JldHVybiBpbmZvLmdldFZvaWNlTWFpbE51bWJlckZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgLy8gICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuZ2V0TVNJU0ROKCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgdm9pY2UgbWFpbCBudW1iZXIuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gYWxwaGFUYWcgVGhlIGFscGhhIHRhZyB0byBkaXNwbGF5LgogICAgICogQHBhcmFtIG51bWJlciBUaGUgdm9pY2VtYWlsIG51bWJlci4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0Vm9pY2VNYWlsTnVtYmVyKFN0cmluZyBhbHBoYVRhZywgU3RyaW5nIG51bWJlcikgewogICAgICAgIHJldHVybiBzZXRWb2ljZU1haWxOdW1iZXIoZ2V0U3ViSWQoKSwgYWxwaGFUYWcsIG51bWJlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSB2b2ljZW1haWwgbnVtYmVyIGZvciB0aGUgZ2l2ZW4gc3Vic2NyaWJlci4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIGlkLgogICAgICogQHBhcmFtIGFscGhhVGFnIFRoZSBhbHBoYSB0YWcgdG8gZGlzcGxheS4KICAgICAqIEBwYXJhbSBudW1iZXIgVGhlIHZvaWNlbWFpbCBudW1iZXIuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRWb2ljZU1haWxOdW1iZXIoaW50IHN1YklkLCBTdHJpbmcgYWxwaGFUYWcsIFN0cmluZyBudW1iZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRWb2ljZU1haWxOdW1iZXIoc3ViSWQsIGFscGhhVGFnLCBudW1iZXIpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgb3IgZGlzYWJsZXMgdGhlIHZpc3VhbCB2b2ljZW1haWwgY2xpZW50IGZvciBhIHBob25lIGFjY291bnQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRlZmF1bHQgZGlhbGVyLCBvciBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KSwgb3IgaGFzIHBlcm1pc3Npb24KICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0uCiAgICAgKgogICAgICogQHBhcmFtIHBob25lQWNjb3VudEhhbmRsZSB0aGUgcGhvbmUgYWNjb3VudCB0byBjaGFuZ2UgdGhlIGNsaWVudCBzdGF0ZQogICAgICogQHBhcmFtIGVuYWJsZWQgdGhlIG5ldyBzdGF0ZSBvZiB0aGUgY2xpZW50CiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVmlzdWFsIHZvaWNlbWFpbCBubyBsb25nZXIgaW4gdGVsZXBob255LiB7QGxpbmsgVmlzdWFsVm9pY2VtYWlsU2VydmljZX0gc2hvdWxkCiAgICAgKiBiZSBpbXBsZW1lbnRlZCBpbnN0ZWFkLgogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU3VwcHJlc3NMaW50KCJEb2NsYXZhMTI1IikKICAgIHB1YmxpYyB2b2lkIHNldFZpc3VhbFZvaWNlbWFpbEVuYWJsZWQoUGhvbmVBY2NvdW50SGFuZGxlIHBob25lQWNjb3VudEhhbmRsZSwgYm9vbGVhbiBlbmFibGVkKXsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2hldGhlciB0aGUgdmlzdWFsIHZvaWNlbWFpbCBjbGllbnQgaXMgZW5hYmxlZC4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVBY2NvdW50SGFuZGxlIHRoZSBwaG9uZSBhY2NvdW50IHRvIGNoZWNrIGZvci4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IHdoZW4gdGhlIHZpc3VhbCB2b2ljZW1haWwgY2xpZW50IGlzIGVuYWJsZWQgZm9yIHRoaXMgY2xpZW50CiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVmlzdWFsIHZvaWNlbWFpbCBubyBsb25nZXIgaW4gdGVsZXBob255LiB7QGxpbmsgVmlzdWFsVm9pY2VtYWlsU2VydmljZX0gc2hvdWxkCiAgICAgKiBiZSBpbXBsZW1lbnRlZCBpbnN0ZWFkLgogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQFN1cHByZXNzTGludCgiRG9jbGF2YTEyNSIpCiAgICBwdWJsaWMgYm9vbGVhbiBpc1Zpc3VhbFZvaWNlbWFpbEVuYWJsZWQoUGhvbmVBY2NvdW50SGFuZGxlIHBob25lQWNjb3VudEhhbmRsZSl7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhbiBvcGFxdWUgYnVuZGxlIG9mIHNldHRpbmdzIGZvcm1lcmx5IHVzZWQgYnkgdGhlIHZpc3VhbCB2b2ljZW1haWwgY2xpZW50IGZvciB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBwaW5uZWQgdG8gdGhlIFRlbGVwaG9ueU1hbmFnZXIsIG9yIHtAY29kZSBudWxsfSBpZiB0aGUgc3Vic2NyaXB0aW9uIElEIGlzCiAgICAgKiBpbnZhbGlkLiBUaGlzIG1ldGhvZCBhbGxvd3MgdGhlIHN5c3RlbSBkaWFsZXIgdG8gbWlncmF0ZSBzZXR0aW5ncyBvdXQgb2YgdGhlIHByZS1PIHZpc3VhbAogICAgICogdm9pY2VtYWlsIGNsaWVudCBpbiB0ZWxlcGhvbnkuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgdGhlIGNhbGxlciB0byBiZSB0aGUgc3lzdGVtIGRpYWxlci4KICAgICAqCiAgICAgKiBAc2VlICNLRVlfVklTVUFMX1ZPSUNFTUFJTF9FTkFCTEVEX0JZX1VTRVJfQk9PTAogICAgICogQHNlZSAjS0VZX1ZPSUNFTUFJTF9TQ1JBTUJMRURfUElOX1NUUklORwogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkRvY2xhdmExMjUiKQogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgQnVuZGxlIGdldFZpc3VhbFZvaWNlbWFpbFNldHRpbmdzKCl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueQogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0VmlzdWFsVm9pY2VtYWlsU2V0dGluZ3MobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtU3ViSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBwYWNrYWdlIHJlc3BvbnNpYmxlIG9mIHByb2Nlc3NpbmcgdmlzdWFsIHZvaWNlbWFpbCBmb3IgdGhlIHN1YnNjcmlwdGlvbiBJRCBwaW5uZWQKICAgICAqIHRvIHRoZSBUZWxlcGhvbnlNYW5hZ2VyLiBSZXR1cm5zIHtAY29kZSBudWxsfSB3aGVuIHRoZXJlIGlzIG5vIHBhY2thZ2UgcmVzcG9uc2libGUgZm9yCiAgICAgKiBwcm9jZXNzaW5nIHZpc3VhbCB2b2ljZW1haWwgZm9yIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBzZWUgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkKGludCkKICAgICAqIEBzZWUgI2NyZWF0ZUZvclBob25lQWNjb3VudEhhbmRsZShQaG9uZUFjY291bnRIYW5kbGUpCiAgICAgKiBAc2VlIFZpc3VhbFZvaWNlbWFpbFNlcnZpY2UKICAgICAqLwogICAgQE51bGxhYmxlCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0VmlzdWFsVm9pY2VtYWlsUGFja2FnZU5hbWUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRWaXN1YWxWb2ljZW1haWxQYWNrYWdlTmFtZShtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCksIGdldFN1YklkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZpc3VhbCB2b2ljZW1haWwgU01TIGZpbHRlciBzZXR0aW5ncyBmb3IgdGhlIHN1YnNjcmlwdGlvbiBJRCBwaW5uZWQKICAgICAqIHRvIHRoZSBUZWxlcGhvbnlNYW5hZ2VyLgogICAgICogV2hlbiB0aGUgZmlsdGVyIGlzIGVuYWJsZWQsIHtAbGluawogICAgICogVmlzdWFsVm9pY2VtYWlsU2VydmljZSNvblNtc1JlY2VpdmVkKFZpc3VhbFZvaWNlbWFpbFRhc2ssIFZpc3VhbFZvaWNlbWFpbFNtcyl9IHdpbGwgYmUKICAgICAqIGNhbGxlZCB3aGVuIGEgU01TIG1hdGNoaW5nIHRoZSBzZXR0aW5ncyBpcyByZWNlaXZlZC4gQ2FsbGVyIG11c3QgYmUgdGhlIGRlZmF1bHQgZGlhbGVyLAogICAgICogc3lzdGVtIGRpYWxlciwgb3IgY2FycmllciB2aXN1YWwgdm9pY2VtYWlsIGFwcC4KICAgICAqCiAgICAgKiBAcGFyYW0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIGZvciB0aGUgZmlsdGVyLCBvciB7QGNvZGUgbnVsbH0gdG8gZGlzYWJsZSB0aGUgZmlsdGVyLgogICAgICoKICAgICAqIEBzZWUgVGVsZWNvbU1hbmFnZXIjZ2V0RGVmYXVsdERpYWxlclBhY2thZ2UoKQogICAgICogQHNlZSBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ0FSUklFUl9WVk1fUEFDS0FHRV9OQU1FX1NUUklOR19BUlJBWQogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyhWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyBzZXR0aW5ncykgewogICAgICAgIGlmIChzZXR0aW5ncyA9PSBudWxsKSB7CiAgICAgICAgICAgIGRpc2FibGVWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXIobVN1YklkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbmFibGVWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXIobVN1YklkLCBzZXR0aW5ncyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBhIHZpc3VhbCB2b2ljZW1haWwgU01TLiBUaGUgY2FsbGVyIG11c3QgYmUgdGhlIGN1cnJlbnQgZGVmYXVsdCBkaWFsZXIuCiAgICAgKiBBIHtAbGluayBWaXN1YWxWb2ljZW1haWxTZXJ2aWNlfSB1c2VzIHRoaXMgbWV0aG9kIHRvIHNlbmQgYSBjb21tYW5kIHZpYSBTTVMgdG8gdGhlIGNhcnJpZXIncwogICAgICogdmlzdWFsIHZvaWNlbWFpbCBzZXJ2ZXIuICBTb21lIGV4YW1wbGVzIGZvciBjYXJyaWVycyB1c2luZyB0aGUgT01UUCBzdGFuZGFyZCBpbmNsdWRlCiAgICAgKiBhY3RpdmF0aW5nIGFuZCBkZWFjdGl2YXRpbmcgdmlzdWFsIHZvaWNlbWFpbCwgb3IgcmVxdWVzdGluZyB0aGUgY3VycmVudCB2aXN1YWwgdm9pY2VtYWlsCiAgICAgKiBwcm92aXNpb25pbmcgc3RhdHVzLiAgU2VlIHRoZSBPTVRQIFZpc3VhbCBWb2ljZW1haWwgc3BlY2lmaWNhdGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiB0aGUKICAgICAqIGZvcm1hdCBvZiB0aGVzZSBTTVMgbWVzc2FnZXMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jU0VORF9TTVMgU0VORF9TTVN9CiAgICAgKgogICAgICogQHBhcmFtIG51bWJlciBUaGUgZGVzdGluYXRpb24gbnVtYmVyLgogICAgICogQHBhcmFtIHBvcnQgVGhlIGRlc3RpbmF0aW9uIHBvcnQgZm9yIGRhdGEgU01TLCBvciAwIGZvciB0ZXh0IFNNUy4KICAgICAqIEBwYXJhbSB0ZXh0IFRoZSBtZXNzYWdlIGNvbnRlbnQuIEZvciBkYXRhIHNtcywgaXQgd2lsbCBiZSBlbmNvZGVkIGFzIGEgVVRGLTggYnl0ZSBzdHJlYW0uCiAgICAgKiBAcGFyYW0gc2VudEludGVudCBUaGUgc2VudCBpbnRlbnQgcGFzc2VkIHRvIHRoZSB7QGxpbmsgU21zTWFuYWdlcn0KICAgICAqCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgaXMgbm90IHRoZSBjdXJyZW50IGRlZmF1bHQgZGlhbGVyCiAgICAgKgogICAgICogQHNlZSBTbXNNYW5hZ2VyI3NlbmREYXRhTWVzc2FnZShTdHJpbmcsIFN0cmluZywgc2hvcnQsIGJ5dGVbXSwgUGVuZGluZ0ludGVudCwgUGVuZGluZ0ludGVudCkKICAgICAqIEBzZWUgU21zTWFuYWdlciNzZW5kVGV4dE1lc3NhZ2UoU3RyaW5nLCBTdHJpbmcsIFN0cmluZywgUGVuZGluZ0ludGVudCwgUGVuZGluZ0ludGVudCkKICAgICAqLwogICAgcHVibGljIHZvaWQgc2VuZFZpc3VhbFZvaWNlbWFpbFNtcyhTdHJpbmcgbnVtYmVyLCBpbnQgcG9ydCwgU3RyaW5nIHRleHQsCiAgICAgICAgICAgIFBlbmRpbmdJbnRlbnQgc2VudEludGVudCkgewogICAgICAgIHNlbmRWaXN1YWxWb2ljZW1haWxTbXNGb3JTdWJzY3JpYmVyKG1TdWJJZCwgbnVtYmVyLCBwb3J0LCB0ZXh0LCBzZW50SW50ZW50KTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgdGhlIHZpc3VhbCB2b2ljZW1haWwgU01TIGZpbHRlciBmb3IgYSBwaG9uZSBhY2NvdW50LiBXaGVuIHRoZSBmaWx0ZXIgaXMKICAgICAqIGVuYWJsZWQsIEluY29taW5nIFNNUyBtZXNzYWdlcyBtYXRjaGluZyB0aGUgT01UUCBWVk0gU01TIGludGVyZmFjZSB3aWxsIGJlIHJlZGlyZWN0ZWQgdG8gdGhlCiAgICAgKiB2aXN1YWwgdm9pY2VtYWlsIGNsaWVudCB3aXRoCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5wcm92aWRlci5Wb2ljZW1haWxDb250cmFjdC5BQ1RJT05fVk9JQ0VNQUlMX1NNU19SRUNFSVZFRH0uCiAgICAgKgogICAgICogPHA+VGhpcyB0YWtlcyBlZmZlY3Qgb25seSB3aGVuIHRoZSBjYWxsZXIgaXMgdGhlIGRlZmF1bHQgZGlhbGVyLiBUaGUgZW5hYmxlZCBzdGF0dXMgYW5kCiAgICAgKiBzZXR0aW5ncyBwZXJzaXN0IHRocm91Z2ggZGVmYXVsdCBkaWFsZXIgY2hhbmdlcywgYnV0IHRoZSBmaWx0ZXIgd2lsbCBvbmx5IGhvbm9yIHRoZSBzZXR0aW5nCiAgICAgKiBzZXQgYnkgdGhlIGN1cnJlbnQgZGVmYXVsdCBkaWFsZXIuCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIGlkIG9mIHRoZSBwaG9uZSBhY2NvdW50LgogICAgICogQHBhcmFtIHNldHRpbmdzIFRoZSBzZXR0aW5ncyBmb3IgdGhlIGZpbHRlci4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgdm9pZCBlbmFibGVWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXIoaW50IHN1YklkLAogICAgICAgICAgICBWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyBzZXR0aW5ncykgewogICAgICAgIGlmKHNldHRpbmdzID09IG51bGwpewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJTZXR0aW5ncyBjYW5ub3QgYmUgbnVsbCIpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuZW5hYmxlVmlzdWFsVm9pY2VtYWlsU21zRmlsdGVyKG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgc3ViSWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzYWJsZXMgdGhlIHZpc3VhbCB2b2ljZW1haWwgU01TIGZpbHRlciBmb3IgYSBwaG9uZSBhY2NvdW50LgogICAgICoKICAgICAqIDxwPlRoaXMgdGFrZXMgZWZmZWN0IG9ubHkgd2hlbiB0aGUgY2FsbGVyIGlzIHRoZSBkZWZhdWx0IGRpYWxlci4gVGhlIGVuYWJsZWQgc3RhdHVzIGFuZAogICAgICogc2V0dGluZ3MgcGVyc2lzdCB0aHJvdWdoIGRlZmF1bHQgZGlhbGVyIGNoYW5nZXMsIGJ1dCB0aGUgZmlsdGVyIHdpbGwgb25seSBob25vciB0aGUgc2V0dGluZwogICAgICogc2V0IGJ5IHRoZSBjdXJyZW50IGRlZmF1bHQgZGlhbGVyLgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyB2b2lkIGRpc2FibGVWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXIoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LmRpc2FibGVWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXIobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBzdWJJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHRoZSBzZXR0aW5ncyBvZiB0aGUgdmlzdWFsIHZvaWNlbWFpbCBTTVMgZmlsdGVyIGZvciBhIHBob25lIGFjY291bnQsIG9yIHtAY29kZSBudWxsfQogICAgICogaWYgdGhlIGZpbHRlciBpcyBkaXNhYmxlZC4KICAgICAqCiAgICAgKiA8cD5UaGlzIHRha2VzIGVmZmVjdCBvbmx5IHdoZW4gdGhlIGNhbGxlciBpcyB0aGUgZGVmYXVsdCBkaWFsZXIuIFRoZSBlbmFibGVkIHN0YXR1cyBhbmQKICAgICAqIHNldHRpbmdzIHBlcnNpc3QgdGhyb3VnaCBkZWZhdWx0IGRpYWxlciBjaGFuZ2VzLCBidXQgdGhlIGZpbHRlciB3aWxsIG9ubHkgaG9ub3IgdGhlIHNldHRpbmcKICAgICAqIHNldCBieSB0aGUgY3VycmVudCBkZWZhdWx0IGRpYWxlci4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyBnZXRWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyhpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255CiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRWaXN1YWxWb2ljZW1haWxTbXNGaWx0ZXJTZXR0aW5ncyhtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIHN1YklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHRoZSBzZXR0aW5ncyBvZiB0aGUgdmlzdWFsIHZvaWNlbWFpbCBTTVMgZmlsdGVyIGZvciBhIHBob25lIGFjY291bnQgc2V0IGJ5IHRoZQogICAgICogY3VycmVudCBhY3RpdmUgdmlzdWFsIHZvaWNlbWFpbCBjbGllbnQsIG9yIHtAY29kZSBudWxsfSBpZiB0aGUgZmlsdGVyIGlzIGRpc2FibGVkLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoZSBjYWxsaW5nIGFwcCB0byBoYXZlIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIEBOdWxsYWJsZQogICAgcHVibGljIFZpc3VhbFZvaWNlbWFpbFNtc0ZpbHRlclNldHRpbmdzIGdldEFjdGl2ZVZpc3VhbFZvaWNlbWFpbFNtc0ZpbHRlclNldHRpbmdzKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0QWN0aXZlVmlzdWFsVm9pY2VtYWlsU21zRmlsdGVyU2V0dGluZ3Moc3ViSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBhIHZpc3VhbCB2b2ljZW1haWwgU01TLiBUaGUgSVBDIGNhbGxlciBtdXN0IGJlIHRoZSBjdXJyZW50IGRlZmF1bHQgZGlhbGVyLgogICAgICoKICAgICAqIEBwYXJhbSBwaG9uZUFjY291bnRIYW5kbGUgVGhlIGFjY291bnQgdG8gc2VuZCB0aGUgU01TIHdpdGguCiAgICAgKiBAcGFyYW0gbnVtYmVyIFRoZSBkZXN0aW5hdGlvbiBudW1iZXIuCiAgICAgKiBAcGFyYW0gcG9ydCBUaGUgZGVzdGluYXRpb24gcG9ydCBmb3IgZGF0YSBTTVMsIG9yIDAgZm9yIHRleHQgU01TLgogICAgICogQHBhcmFtIHRleHQgVGhlIG1lc3NhZ2UgY29udGVudC4gRm9yIGRhdGEgc21zLCBpdCB3aWxsIGJlIGVuY29kZWQgYXMgYSBVVEYtOCBieXRlIHN0cmVhbS4KICAgICAqIEBwYXJhbSBzZW50SW50ZW50IFRoZSBzZW50IGludGVudCBwYXNzZWQgdG8gdGhlIHtAbGluayBTbXNNYW5hZ2VyfQogICAgICoKICAgICAqIEBzZWUgU21zTWFuYWdlciNzZW5kRGF0YU1lc3NhZ2UoU3RyaW5nLCBTdHJpbmcsIHNob3J0LCBieXRlW10sIFBlbmRpbmdJbnRlbnQsIFBlbmRpbmdJbnRlbnQpCiAgICAgKiBAc2VlIFNtc01hbmFnZXIjc2VuZFRleHRNZXNzYWdlKFN0cmluZywgU3RyaW5nLCBTdHJpbmcsIFBlbmRpbmdJbnRlbnQsIFBlbmRpbmdJbnRlbnQpCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uU0VORF9TTVMpCiAgICBwdWJsaWMgdm9pZCBzZW5kVmlzdWFsVm9pY2VtYWlsU21zRm9yU3Vic2NyaWJlcihpbnQgc3ViSWQsIFN0cmluZyBudW1iZXIsIGludCBwb3J0LAogICAgICAgICAgICBTdHJpbmcgdGV4dCwgUGVuZGluZ0ludGVudCBzZW50SW50ZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LnNlbmRWaXN1YWxWb2ljZW1haWxTbXNGb3JTdWJzY3JpYmVyKAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCksIHN1YklkLCBudW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQsIHRleHQsIHNlbnRJbnRlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSW5pdGlhbCBTSU0gYWN0aXZhdGlvbiBzdGF0ZSwgdW5rbm93bi4gTm90IHNldCBieSBhbnkgY2FycmllciBhcHBzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX0FDVElWQVRJT05fU1RBVEVfVU5LTk9XTiA9IDA7CgogICAgLyoqCiAgICAgKiBpbmRpY2F0ZSBTSU0gaXMgdW5kZXIgYWN0aXZhdGlvbiBwcm9jZWR1cmUgbm93LgogICAgICogaW50ZXJtZWRpYXRlIHN0YXRlIGZvbGxvd2VkIGJ5IGFub3RoZXIgc3RhdGUgdXBkYXRlIHdpdGggYWN0aXZhdGlvbiBwcm9jZWR1cmUgcmVzdWx0OgogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVEVECiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9ERUFDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfUkVTVFJJQ1RFRAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVElORyA9IDE7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSBTSU0gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFjdGl2YXRlZCB3aXRoIGZ1bGwgc2VydmljZQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVEVEID0gMjsKCiAgICAvKioKICAgICAqIEluZGljYXRlIFNJTSBoYXMgYmVlbiBkZWFjdGl2YXRlZCBieSB0aGUgY2FycmllciBzbyB0aGF0IHNlcnZpY2UgaXMgbm90IGF2YWlsYWJsZQogICAgICogYW5kIHJlcXVpcmVzIGFjdGl2YXRpb24gc2VydmljZSB0byBlbmFibGUgc2VydmljZXMuCiAgICAgKiBDYXJyaWVyIGFwcHMgY291bGQgYmUgc2lnbmFsbGVkIHRvIHNldCBhY3RpdmF0aW9uIHN0YXRlIHRvIGRlYWN0aXZhdGVkIGlmIGRldGVjdGVkCiAgICAgKiBkZWFjdGl2YXRlZCBzaW0gc3RhdGUgYW5kIHNldCBpdCBiYWNrIHRvIGFjdGl2YXRlZCBhZnRlciBzdWNjZXNzZnVsbHkgcnVuIGFjdGl2YXRpb24gc2VydmljZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9BQ1RJVkFUSU9OX1NUQVRFX0RFQUNUSVZBVEVEID0gMzsKCiAgICAvKioKICAgICAqIFJlc3RyaWN0ZWQgc3RhdGUgaW5kaWNhdGUgU0lNIGhhcyBiZWVuIGFjdGl2YXRlZCBidXQgc2VydmljZSBhcmUgcmVzdHJpY3RlZC4KICAgICAqIG5vdGUgdGhpcyBpcyBjdXJyZW50bHkgYXZhaWxhYmxlIGZvciBkYXRhIGFjdGl2YXRpb24gc3RhdGUuIEZvciBleGFtcGxlIG91dCBvZiBieXRlIHNpbS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9BQ1RJVkFUSU9OX1NUQVRFX1JFU1RSSUNURUQgPSA0OwoKICAgICAvKioKICAgICAgKiBTZXRzIHRoZSB2b2ljZSBhY3RpdmF0aW9uIHN0YXRlCiAgICAgICoKICAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUKICAgICAgKiBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICAqCiAgICAgICogQHBhcmFtIGFjdGl2YXRpb25TdGF0ZSBUaGUgdm9pY2UgYWN0aXZhdGlvbiBzdGF0ZQogICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX1VOS05PV04KICAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9BQ1RJVkFUSU5HCiAgICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVEVECiAgICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfREVBQ1RJVkFURUQKICAgICAgKiBAaGlkZQogICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0Vm9pY2VBY3RpdmF0aW9uU3RhdGUoQFNpbUFjdGl2YXRpb25TdGF0ZSBpbnQgYWN0aXZhdGlvblN0YXRlKSB7CiAgICAgICAgc2V0Vm9pY2VBY3RpdmF0aW9uU3RhdGUoZ2V0U3ViSWQoKSwgYWN0aXZhdGlvblN0YXRlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIHZvaWNlIGFjdGl2YXRpb24gc3RhdGUgZm9yIHRoZSBnaXZlbiBzdWJzY3JpYmVyLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlCiAgICAgKiBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIGlkLgogICAgICogQHBhcmFtIGFjdGl2YXRpb25TdGF0ZSBUaGUgdm9pY2UgYWN0aXZhdGlvbiBzdGF0ZSBvZiB0aGUgZ2l2ZW4gc3Vic2NyaWJlci4KICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX1VOS05PV04KICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRJTkcKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfREVBQ1RJVkFURUQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFZvaWNlQWN0aXZhdGlvblN0YXRlKGludCBzdWJJZCwgQFNpbUFjdGl2YXRpb25TdGF0ZSBpbnQgYWN0aXZhdGlvblN0YXRlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRWb2ljZUFjdGl2YXRpb25TdGF0ZShzdWJJZCwgYWN0aXZhdGlvblN0YXRlKTsKICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIGRhdGEgYWN0aXZhdGlvbiBzdGF0ZQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlCiAgICAgKiBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBhY3RpdmF0aW9uU3RhdGUgVGhlIGRhdGEgYWN0aXZhdGlvbiBzdGF0ZQogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfVU5LTk9XTgogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVElORwogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVEVECiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9ERUFDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfUkVTVFJJQ1RFRAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGF0YUFjdGl2YXRpb25TdGF0ZShAU2ltQWN0aXZhdGlvblN0YXRlIGludCBhY3RpdmF0aW9uU3RhdGUpIHsKICAgICAgICBzZXREYXRhQWN0aXZhdGlvblN0YXRlKGdldFN1YklkKCksIGFjdGl2YXRpb25TdGF0ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBkYXRhIGFjdGl2YXRpb24gc3RhdGUgZm9yIHRoZSBnaXZlbiBzdWJzY3JpYmVyLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlCiAgICAgKiBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIGlkLgogICAgICogQHBhcmFtIGFjdGl2YXRpb25TdGF0ZSBUaGUgZGF0YSBhY3RpdmF0aW9uIHN0YXRlIG9mIHRoZSBnaXZlbiBzdWJzY3JpYmVyLgogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfVU5LTk9XTgogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVElORwogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfQUNUSVZBVEVECiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9ERUFDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfUkVTVFJJQ1RFRAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGF0YUFjdGl2YXRpb25TdGF0ZShpbnQgc3ViSWQsIEBTaW1BY3RpdmF0aW9uU3RhdGUgaW50IGFjdGl2YXRpb25TdGF0ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuc2V0RGF0YUFjdGl2YXRpb25TdGF0ZShzdWJJZCwgYWN0aXZhdGlvblN0YXRlKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZvaWNlIGFjdGl2YXRpb24gc3RhdGUKICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHZvaWNlQWN0aXZhdGlvblN0YXRlCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9VTktOT1dOCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9BQ1RJVkFUSU5HCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9BQ1RJVkFURUQKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0RFQUNUSVZBVEVECiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQFNpbUFjdGl2YXRpb25TdGF0ZSBpbnQgZ2V0Vm9pY2VBY3RpdmF0aW9uU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIGdldFZvaWNlQWN0aXZhdGlvblN0YXRlKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdm9pY2UgYWN0aXZhdGlvbiBzdGF0ZSBmb3IgdGhlIGdpdmVuIHN1YnNjcmliZXIuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogQHJldHVybiB2b2ljZUFjdGl2YXRpb25TdGF0ZSBmb3IgdGhlIGdpdmVuIHN1YnNjcmliZXIKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX1VOS05PV04KICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRJTkcKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfREVBQ1RJVkFURUQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBAU2ltQWN0aXZhdGlvblN0YXRlIGludCBnZXRWb2ljZUFjdGl2YXRpb25TdGF0ZShpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRWb2ljZUFjdGl2YXRpb25TdGF0ZShzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gU0lNX0FDVElWQVRJT05fU1RBVEVfVU5LTk9XTjsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGRhdGEgYWN0aXZhdGlvbiBzdGF0ZQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gZGF0YUFjdGl2YXRpb25TdGF0ZSBmb3IgdGhlIGdpdmVuIHN1YnNjcmliZXIKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX1VOS05PV04KICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRJTkcKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0FDVElWQVRFRAogICAgICogQHNlZSAjU0lNX0FDVElWQVRJT05fU1RBVEVfREVBQ1RJVkFURUQKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX1JFU1RSSUNURUQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBAU2ltQWN0aXZhdGlvblN0YXRlIGludCBnZXREYXRhQWN0aXZhdGlvblN0YXRlKCkgewogICAgICAgIHJldHVybiBnZXREYXRhQWN0aXZhdGlvblN0YXRlKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgZGF0YSBhY3RpdmF0aW9uIHN0YXRlIGZvciB0aGUgZ2l2ZW4gc3Vic2NyaWJlci4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIGRhdGFBY3RpdmF0aW9uU3RhdGUgZm9yIHRoZSBnaXZlbiBzdWJzY3JpYmVyCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9VTktOT1dOCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9BQ1RJVkFUSU5HCiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9BQ1RJVkFURUQKICAgICAqIEBzZWUgI1NJTV9BQ1RJVkFUSU9OX1NUQVRFX0RFQUNUSVZBVEVECiAgICAgKiBAc2VlICNTSU1fQUNUSVZBVElPTl9TVEFURV9SRVNUUklDVEVECiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQFNpbUFjdGl2YXRpb25TdGF0ZSBpbnQgZ2V0RGF0YUFjdGl2YXRpb25TdGF0ZShpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXREYXRhQWN0aXZhdGlvblN0YXRlKHN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTSU1fQUNUSVZBVElPTl9TVEFURV9VTktOT1dOOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdm9pY2UgbWFpbCBjb3VudC4gUmV0dXJuIDAgaWYgdW5hdmFpbGFibGUsIC0xIGlmIHRoZXJlIGFyZSB1bnJlYWQgdm9pY2UgbWVzc2FnZXMKICAgICAqIGJ1dCB0aGUgY291bnQgaXMgdW5rbm93bi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRWb2ljZU1lc3NhZ2VDb3VudCgpIHsKICAgICAgICByZXR1cm4gZ2V0Vm9pY2VNZXNzYWdlQ291bnQoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2b2ljZSBtYWlsIGNvdW50IGZvciBhIHN1YnNjcmlwdGlvbi4gUmV0dXJuIDAgaWYgdW5hdmFpbGFibGUgb3IgdGhlIGNhbGxlciBkb2VzCiAgICAgKiBub3QgaGF2ZSB0aGUgUkVBRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uLgogICAgICogQHBhcmFtIHN1YklkIHdob3NlIHZvaWNlIG1lc3NhZ2UgY291bnQgaXMgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRWb2ljZU1lc3NhZ2VDb3VudChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Vm9pY2VNZXNzYWdlQ291bnRGb3JTdWJzY3JpYmVyKHN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSByZXN0YXJ0cyBkdWUgdG8gY3Jhc2hpbmcKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBhbHBoYWJldGljIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSB2b2ljZQogICAgICogbWFpbCBudW1iZXIuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0Vm9pY2VNYWlsQWxwaGFUYWcoKSB7CiAgICAgICAgcmV0dXJuIGdldFZvaWNlTWFpbEFscGhhVGFnKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBhbHBoYWJldGljIGlkZW50aWZpZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSB2b2ljZQogICAgICogbWFpbCBudW1iZXIgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIHN1YklkIHdob3NlIGFscGhhYmV0aWMgaWRlbnRpZmllciBhc3NvY2lhdGVkIHdpdGggdGhlCiAgICAgKiB2b2ljZSBtYWlsIG51bWJlciBpcyByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIGdldFZvaWNlTWFpbEFscGhhVGFnKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldFZvaWNlTWFpbEFscGhhVGFnRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNlbmQgdGhlIHNwZWNpYWwgZGlhbGVyIGNvZGUuIFRoZSBJUEMgY2FsbGVyIG11c3QgYmUgdGhlIGN1cnJlbnQgZGVmYXVsdCBkaWFsZXIgb3IgaGF2ZQogICAgICogY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBpbnB1dENvZGUgVGhlIHNwZWNpYWwgZGlhbGVyIGNvZGUgdG8gc2VuZAogICAgICoKICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2VzIG5vdCBoYXZlIGNhcnJpZXIgcHJpdmlsZWdlcyBvciBpcyBub3QgdGhlCiAgICAgKiAgICAgICAgIGN1cnJlbnQgZGVmYXVsdCBkaWFsZXIKICAgICAqLwogICAgcHVibGljIHZvaWQgc2VuZERpYWxlclNwZWNpYWxDb2RlKFN0cmluZyBpbnB1dENvZGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBmaW5hbCBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oIlRlbGVwaG9ueSBzZXJ2aWNlIHVuYXZhaWxhYmxlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVsZXBob255LnNlbmREaWFsZXJTcGVjaWFsQ29kZShtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIGlucHV0Q29kZSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElNUyBwcml2YXRlIHVzZXIgaWRlbnRpdHkgKElNUEkpIHRoYXQgd2FzIGxvYWRlZCBmcm9tIHRoZSBJU0lNLgogICAgICogQHJldHVybiB0aGUgSU1QSSwgb3IgbnVsbCBpZiBub3QgcHJlc2VudCBvciBub3QgbG9hZGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN0cmluZyBnZXRJc2ltSW1waSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAvL2dldCB0aGUgSXNpbSBJbXBpIGJhc2VkIG9uIHN1YklkCiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldElzaW1JbXBpKGdldFN1YklkKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElNUyBob21lIG5ldHdvcmsgZG9tYWluIG5hbWUgdGhhdCB3YXMgbG9hZGVkIGZyb20gdGhlIElTSU0ge0BzZWUgI0FQUFRZUEVfSVNJTX0uCiAgICAgKiBAcmV0dXJuIHRoZSBJTVMgZG9tYWluIG5hbWUuIFJldHVybnMge0Bjb2RlIG51bGx9IGlmIElTSU0gaGFzbid0IGJlZW4gbG9hZGVkIG9yIElNUyBkb21haW4KICAgICAqIGhhc24ndCBiZWVuIGxvYWRlZCBvciBpc24ndCBwcmVzZW50IG9uIHRoZSBJU0lNLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEV9CiAgICAgKiBAaGlkZQogICAgICovCiAgICBATnVsbGFibGUKICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0SXNpbURvbWFpbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJUGhvbmVTdWJJbmZvIGluZm8gPSBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAvL2dldCB0aGUgSXNpbSBEb21haW4gYmFzZWQgb24gc3ViSWQKICAgICAgICAgICAgcmV0dXJuIGluZm8uZ2V0SXNpbURvbWFpbihnZXRTdWJJZCgpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBJTVMgcHVibGljIHVzZXIgaWRlbnRpdGllcyAoSU1QVSkgdGhhdCB3ZXJlIGxvYWRlZCBmcm9tIHRoZSBJU0lNLgogICAgICogQHJldHVybiBhbiBhcnJheSBvZiBJTVBVIHN0cmluZ3MsIHdpdGggb25lIElNUFUgcGVyIHN0cmluZywgb3IgbnVsbCBpZgogICAgICogICAgICBub3QgcHJlc2VudCBvciBub3QgbG9hZGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgQE51bGxhYmxlCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nW10gZ2V0SXNpbUltcHUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVBob25lU3ViSW5mbyBpbmZvID0gZ2V0U3Vic2NyaWJlckluZm9TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpbmZvID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgLy9nZXQgdGhlIElzaW0gSW1wdSBiYXNlZCBvbiBzdWJJZAogICAgICAgICAgICByZXR1cm4gaW5mby5nZXRJc2ltSW1wdShnZXRTdWJJZCgpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEZXZpY2UgY2FsbCBzdGF0ZTogTm8gYWN0aXZpdHkuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENBTExfU1RBVEVfSURMRSA9IDA7CiAgICAvKioKICAgICAqIERldmljZSBjYWxsIHN0YXRlOiBSaW5naW5nLiBBIG5ldyBjYWxsIGFycml2ZWQgYW5kIGlzCiAgICAgKiAgcmluZ2luZyBvciB3YWl0aW5nLiBJbiB0aGUgbGF0dGVyIGNhc2UsIGFub3RoZXIgY2FsbCBpcwogICAgICogIGFscmVhZHkgYWN0aXZlLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQUxMX1NUQVRFX1JJTkdJTkcgPSAxOwogICAgLyoqCiAgICAgKiBEZXZpY2UgY2FsbCBzdGF0ZTogT2ZmLWhvb2suIEF0IGxlYXN0IG9uZSBjYWxsIGV4aXN0cwogICAgICogdGhhdCBpcyBkaWFsaW5nLCBhY3RpdmUsIG9yIG9uIGhvbGQsIGFuZCBubyBjYWxscyBhcmUgcmluZ2luZwogICAgICogb3Igd2FpdGluZy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FMTF9TVEFURV9PRkZIT09LID0gMjsKCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHN0YXRlIG9mIGFsbCBjYWxscyBvbiB0aGUgZGV2aWNlLgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBjb25zaWRlcnMgbm90IG9ubHkgY2FsbHMgaW4gdGhlIFRlbGVwaG9ueSBzdGFjaywgYnV0IGFsc28gY2FsbHMgdmlhIG90aGVyCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlY29tLkNvbm5lY3Rpb25TZXJ2aWNlfSBpbXBsZW1lbnRhdGlvbnMuCiAgICAgKiA8cD4KICAgICAqIE5vdGU6IFRoZSBjYWxsIHN0YXRlIHJldHVybmVkIHZpYSB0aGlzIG1ldGhvZCBtYXkgZGlmZmVyIGZyb20gd2hhdCBpcyByZXBvcnRlZCBieQogICAgICoge0BsaW5rIFBob25lU3RhdGVMaXN0ZW5lciNvbkNhbGxTdGF0ZUNoYW5nZWQoaW50LCBTdHJpbmcpfSwgYXMgdGhhdCBjYWxsYmFjayBvbmx5IGNvbnNpZGVycwogICAgICogVGVsZXBob255IChtb2JpbGUpIGNhbGxzLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGN1cnJlbnQgY2FsbCBzdGF0ZS4KICAgICAqLwogICAgcHVibGljIEBDYWxsU3RhdGUgaW50IGdldENhbGxTdGF0ZSgpIHsKICAgICAgICBpZiAobUNvbnRleHQgIT0gbnVsbCkgewogICAgICAgICAgICBUZWxlY29tTWFuYWdlciB0ZWxlY29tTWFuYWdlciA9IG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoVGVsZWNvbU1hbmFnZXIuY2xhc3MpOwogICAgICAgICAgICBpZiAodGVsZWNvbU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVjb21NYW5hZ2VyLmdldENhbGxTdGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBDQUxMX1NUQVRFX0lETEU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBUZWxlcGhvbnkgY2FsbCBzdGF0ZSBmb3IgY2FsbHMgb24gYSBzcGVjaWZpYyBzdWJzY3JpcHRpb24uCiAgICAgKiA8cD4KICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGNvbnNpZGVycyBPTkxZIHRlbGVwaG9ueS9tb2JpbGUgY2FsbHMsIHdoZXJlIHtAbGluayAjZ2V0Q2FsbFN0YXRlKCl9CiAgICAgKiBjb25zaWRlcnMgdGhlIHN0YXRlIG9mIGNhbGxzIGZyb20gb3RoZXIge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5Db25uZWN0aW9uU2VydmljZX0KICAgICAqIGltcGxlbWVudGF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmlwdGlvbiB0byBjaGVjayBjYWxsIHN0YXRlIGZvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgQENhbGxTdGF0ZSBpbnQgZ2V0Q2FsbFN0YXRlKGludCBzdWJJZCkgewogICAgICAgIGludCBwaG9uZUlkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICByZXR1cm4gZ2V0Q2FsbFN0YXRlRm9yU2xvdChwaG9uZUlkKTsKICAgIH0KCiAgICAvKioKICAgICogQGhpZGUKICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHJpdmF0ZSBJUGhvbmVTdWJJbmZvIGdldFN1YnNjcmliZXJJbmZvKCkgewogICAgICAgIHJldHVybiBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIFRlbGVwaG9ueSBjYWxsIHN0YXRlIGZvciBjYWxscyBvbiBhIHNwZWNpZmljIFNJTSBzbG90LgogICAgICogPHA+CiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBjb25zaWRlcnMgT05MWSB0ZWxlcGhvbnkvbW9iaWxlIGNhbGxzLCB3aGVyZSB7QGxpbmsgI2dldENhbGxTdGF0ZSgpfQogICAgICogY29uc2lkZXJzIHRoZSBzdGF0ZSBvZiBjYWxscyBmcm9tIG90aGVyIHtAbGluayBhbmRyb2lkLnRlbGVjb20uQ29ubmVjdGlvblNlcnZpY2V9CiAgICAgKiBpbXBsZW1lbnRhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCB0aGUgU0lNIHNsb3QgaW5kZXggdG8gY2hlY2sgY2FsbCBzdGF0ZSBmb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgQENhbGxTdGF0ZSBpbnQgZ2V0Q2FsbFN0YXRlRm9yU2xvdChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBDQUxMX1NUQVRFX0lETEU7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2FsbFN0YXRlRm9yU2xvdChzbG90SW5kZXgpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyB0aGUgcGhvbmUgcHJvY2VzcyBpcyByZXN0YXJ0aW5nLgogICAgICAgICAgICByZXR1cm4gQ0FMTF9TVEFURV9JRExFOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAvLyB0aGUgcGhvbmUgcHJvY2VzcyBpcyByZXN0YXJ0aW5nLgogICAgICAgICAgcmV0dXJuIENBTExfU1RBVEVfSURMRTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKiBEYXRhIGNvbm5lY3Rpb24gYWN0aXZpdHk6IE5vIHRyYWZmaWMuICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX0FDVElWSVRZX05PTkUgPSAweDAwMDAwMDAwOwogICAgLyoqIERhdGEgY29ubmVjdGlvbiBhY3Rpdml0eTogQ3VycmVudGx5IHJlY2VpdmluZyBJUCBQUFAgdHJhZmZpYy4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfQUNUSVZJVFlfSU4gPSAweDAwMDAwMDAxOwogICAgLyoqIERhdGEgY29ubmVjdGlvbiBhY3Rpdml0eTogQ3VycmVudGx5IHNlbmRpbmcgSVAgUFBQIHRyYWZmaWMuICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX0FDVElWSVRZX09VVCA9IDB4MDAwMDAwMDI7CiAgICAvKiogRGF0YSBjb25uZWN0aW9uIGFjdGl2aXR5OiBDdXJyZW50bHkgYm90aCBzZW5kaW5nIGFuZCByZWNlaXZpbmcKICAgICAqICBJUCBQUFAgdHJhZmZpYy4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfQUNUSVZJVFlfSU5PVVQgPSBEQVRBX0FDVElWSVRZX0lOIHwgREFUQV9BQ1RJVklUWV9PVVQ7CiAgICAvKioKICAgICAqIERhdGEgY29ubmVjdGlvbiBpcyBhY3RpdmUsIGJ1dCBwaHlzaWNhbCBsaW5rIGlzIGRvd24KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREFUQV9BQ1RJVklUWV9ET1JNQU5UID0gMHgwMDAwMDAwNDsKCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSB0eXBlIG9mIGFjdGl2aXR5IG9uIGEgZGF0YSBjb25uZWN0aW9uCiAgICAgKiAoY2VsbHVsYXIpLgogICAgICoKICAgICAqIEBzZWUgI0RBVEFfQUNUSVZJVFlfTk9ORQogICAgICogQHNlZSAjREFUQV9BQ1RJVklUWV9JTgogICAgICogQHNlZSAjREFUQV9BQ1RJVklUWV9PVVQKICAgICAqIEBzZWUgI0RBVEFfQUNUSVZJVFlfSU5PVVQKICAgICAqIEBzZWUgI0RBVEFfQUNUSVZJVFlfRE9STUFOVAogICAgICovCiAgICBwdWJsaWMgaW50IGdldERhdGFBY3Rpdml0eSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIERBVEFfQUNUSVZJVFlfTk9ORTsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXREYXRhQWN0aXZpdHlGb3JTdWJJZCgKICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldEFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZCgpKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIHRoZSBwaG9uZSBwcm9jZXNzIGlzIHJlc3RhcnRpbmcuCiAgICAgICAgICAgIHJldHVybiBEQVRBX0FDVElWSVRZX05PTkU7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgIC8vIHRoZSBwaG9uZSBwcm9jZXNzIGlzIHJlc3RhcnRpbmcuCiAgICAgICAgICByZXR1cm4gREFUQV9BQ1RJVklUWV9OT05FOwogICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBASW50RGVmKHByZWZpeCA9IHsiREFUQV8ifSwgdmFsdWUgPSB7CiAgICAgICAgICAgIERBVEFfVU5LTk9XTiwKICAgICAgICAgICAgREFUQV9ESVNDT05ORUNURUQsCiAgICAgICAgICAgIERBVEFfQ09OTkVDVElORywKICAgICAgICAgICAgREFUQV9DT05ORUNURUQsCiAgICAgICAgICAgIERBVEFfU1VTUEVOREVELAogICAgICAgICAgICBEQVRBX0RJU0NPTk5FQ1RJTkcsCiAgICB9KQogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgcHVibGljIEBpbnRlcmZhY2UgRGF0YVN0YXRle30KCiAgICAvKiogRGF0YSBjb25uZWN0aW9uIHN0YXRlOiBVbmtub3duLiAgVXNlZCBiZWZvcmUgd2Uga25vdyB0aGUgc3RhdGUuICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX1VOS05PV04gICAgICAgID0gLTE7CiAgICAvKiogRGF0YSBjb25uZWN0aW9uIHN0YXRlOiBEaXNjb25uZWN0ZWQuIElQIHRyYWZmaWMgbm90IGF2YWlsYWJsZS4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfRElTQ09OTkVDVEVEICAgPSAwOwogICAgLyoqIERhdGEgY29ubmVjdGlvbiBzdGF0ZTogQ3VycmVudGx5IHNldHRpbmcgdXAgYSBkYXRhIGNvbm5lY3Rpb24uICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX0NPTk5FQ1RJTkcgICAgID0gMTsKICAgIC8qKiBEYXRhIGNvbm5lY3Rpb24gc3RhdGU6IENvbm5lY3RlZC4gSVAgdHJhZmZpYyBzaG91bGQgYmUgYXZhaWxhYmxlLiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREFUQV9DT05ORUNURUQgICAgICA9IDI7CiAgICAvKiogRGF0YSBjb25uZWN0aW9uIHN0YXRlOiBTdXNwZW5kZWQuIFRoZSBjb25uZWN0aW9uIGlzIHVwLCBidXQgSVAKICAgICAqIHRyYWZmaWMgaXMgdGVtcG9yYXJpbHkgdW5hdmFpbGFibGUuIEZvciBleGFtcGxlLCBpbiBhIDJHIG5ldHdvcmssCiAgICAgKiBkYXRhIGFjdGl2aXR5IG1heSBiZSBzdXNwZW5kZWQgd2hlbiBhIHZvaWNlIGNhbGwgYXJyaXZlcy4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfU1VTUEVOREVEICAgICAgPSAzOwogICAgLyoqCiAgICAgKiBEYXRhIGNvbm5lY3Rpb24gc3RhdGU6IERpc2Nvbm5lY3RpbmcuCiAgICAgKgogICAgICogSVAgdHJhZmZpYyBtYXkgYmUgYXZhaWxhYmxlIGJ1dCB3aWxsIGNlYXNlIHdvcmtpbmcgaW1taW5lbnRseS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREFUQV9ESVNDT05ORUNUSU5HID0gNDsKCiAgICAvKioKICAgICAqIFVzZWQgZm9yIGNoZWNraW5nIGlmIHRoZSBTREsgdmVyc2lvbiBmb3Ige0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0RGF0YVN0YXRlfSBpcyBhYm92ZSBRLgogICAgICovCiAgICBAQ2hhbmdlSWQKICAgIEBFbmFibGVkQWZ0ZXIodGFyZ2V0U2RrVmVyc2lvbiA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUSkKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgR0VUX0RBVEFfU1RBVEVfUl9WRVJTSU9OID0gMTQ4NTM0MzQ4TDsKCiAgICAvKioKICAgICAqIFJldHVybnMgYSBjb25zdGFudCBpbmRpY2F0aW5nIHRoZSBjdXJyZW50IGRhdGEgY29ubmVjdGlvbiBzdGF0ZQogICAgICogKGNlbGx1bGFyKS4KICAgICAqCiAgICAgKiBAc2VlICNEQVRBX0RJU0NPTk5FQ1RFRAogICAgICogQHNlZSAjREFUQV9DT05ORUNUSU5HCiAgICAgKiBAc2VlICNEQVRBX0NPTk5FQ1RFRAogICAgICogQHNlZSAjREFUQV9TVVNQRU5ERUQKICAgICAqIEBzZWUgI0RBVEFfRElTQ09OTkVDVElORwogICAgICovCiAgICBwdWJsaWMgaW50IGdldERhdGFTdGF0ZSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIERBVEFfRElTQ09OTkVDVEVEOwogICAgICAgICAgICBpbnQgc3RhdGUgPSB0ZWxlcGhvbnkuZ2V0RGF0YVN0YXRlRm9yU3ViSWQoCiAgICAgICAgICAgICAgICAgICAgZ2V0U3ViSWQoU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRBY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWQoKSkpOwogICAgICAgICAgICBpZiAoc3RhdGUgPT0gVGVsZXBob255TWFuYWdlci5EQVRBX0RJU0NPTk5FQ1RJTkcKICAgICAgICAgICAgICAgICAgICAmJiAhQ29tcGF0aWJpbGl0eS5pc0NoYW5nZUVuYWJsZWQoR0VUX0RBVEFfU1RBVEVfUl9WRVJTSU9OKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFRlbGVwaG9ueU1hbmFnZXIuREFUQV9DT05ORUNURUQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gdGhlIHBob25lIHByb2Nlc3MgaXMgcmVzdGFydGluZy4KICAgICAgICAgICAgcmV0dXJuIERBVEFfRElTQ09OTkVDVEVEOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBEQVRBX0RJU0NPTk5FQ1RFRDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0IGRhdGEgc3RhdGUgdG8gc3RyaW5nCiAgICAgKgogICAgICogQHJldHVybiBUaGUgZGF0YSBzdGF0ZSBpbiBzdHJpbmcgZm9ybWF0LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBTdHJpbmcgZGF0YVN0YXRlVG9TdHJpbmcoQERhdGFTdGF0ZSBpbnQgc3RhdGUpIHsKICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7CiAgICAgICAgICAgIGNhc2UgREFUQV9ESVNDT05ORUNURUQ6IHJldHVybiAiRElTQ09OTkVDVEVEIjsKICAgICAgICAgICAgY2FzZSBEQVRBX0NPTk5FQ1RJTkc6IHJldHVybiAiQ09OTkVDVElORyI7CiAgICAgICAgICAgIGNhc2UgREFUQV9DT05ORUNURUQ6IHJldHVybiAiQ09OTkVDVEVEIjsKICAgICAgICAgICAgY2FzZSBEQVRBX1NVU1BFTkRFRDogcmV0dXJuICJTVVNQRU5ERUQiOwogICAgICAgICAgICBjYXNlIERBVEFfRElTQ09OTkVDVElORzogcmV0dXJuICJESVNDT05ORUNUSU5HIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJVTktOT1dOKCIgKyBzdGF0ZSArICIpIjsKICAgIH0KCiAgIC8qKgogICAgKiBAaGlkZQogICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHByaXZhdGUgSVRlbGVwaG9ueSBnZXRJVGVsZXBob255KCkgewogICAgICAgIHJldHVybiBJVGVsZXBob255LlN0dWIuYXNJbnRlcmZhY2UoVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpLmdldFRlbGVwaG9ueVNlcnZpY2VSZWdpc3RlcmVyKCkuZ2V0KCkpOwogICAgfQoKICAgIHByaXZhdGUgSU9ucyBnZXRJT25zKCkgewogICAgICAgIHJldHVybiBJT25zLlN0dWIuYXNJbnRlcmZhY2UoCiAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0VGVsZXBob255U2VydmljZU1hbmFnZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0T3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXQoKSk7CiAgICB9CgogICAgLy8KICAgIC8vCiAgICAvLyBQaG9uZVN0YXRlTGlzdGVuZXIKICAgIC8vCiAgICAvLwoKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGEgbGlzdGVuZXIgb2JqZWN0IHRvIHJlY2VpdmUgbm90aWZpY2F0aW9uIG9mIGNoYW5nZXMKICAgICAqIGluIHNwZWNpZmllZCB0ZWxlcGhvbnkgc3RhdGVzLgogICAgICogPHA+CiAgICAgKiBUbyByZWdpc3RlciBhIGxpc3RlbmVyLCBwYXNzIGEge0BsaW5rIFBob25lU3RhdGVMaXN0ZW5lcn0gYW5kIHNwZWNpZnkgYXQgbGVhc3Qgb25lIHRlbGVwaG9ueQogICAgICogc3RhdGUgb2YgaW50ZXJlc3QgaW4gdGhlIGV2ZW50cyBhcmd1bWVudC4KICAgICAqCiAgICAgKiBBdCByZWdpc3RyYXRpb24sIGFuZCB3aGVuIGEgc3BlY2lmaWVkIHRlbGVwaG9ueSBzdGF0ZSBjaGFuZ2VzLCB0aGUgdGVsZXBob255IG1hbmFnZXIgaW52b2tlcwogICAgICogdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrIG1ldGhvZCBvbiB0aGUgbGlzdGVuZXIgb2JqZWN0IGFuZCBwYXNzZXMgdGhlIGN1cnJlbnQgKHVwZGF0ZWQpCiAgICAgKiB2YWx1ZXMuCiAgICAgKiA8cD4KICAgICAqIFRvIHVuLXJlZ2lzdGVyIGEgbGlzdGVuZXIsIHBhc3MgdGhlIGxpc3RlbmVyIG9iamVjdCBhbmQgc2V0IHRoZSBldmVudHMgYXJndW1lbnQgdG8KICAgICAqIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjTElTVEVOX05PTkUgTElTVEVOX05PTkV9ICgwKS4KICAgICAqCiAgICAgKiBJZiB0aGlzIFRlbGVwaG9ueU1hbmFnZXIgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwKICAgICAqIGFwcGxpZXMgdG8gdGhlIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8KICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpfS4gVG8gbGlzdGVuIGV2ZW50cyBmb3IgbXVsdGlwbGUgc3ViSWRzLAogICAgICogcGFzcyBhIHNlcGFyYXRlIGxpc3RlbmVyIG9iamVjdCB0byBlYWNoIFRlbGVwaG9ueU1hbmFnZXIgb2JqZWN0IGNyZWF0ZWQgd2l0aAogICAgICoge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogTm90ZTogaWYgeW91IGNhbGwgdGhpcyBtZXRob2Qgd2hpbGUgaW4gdGhlIG1pZGRsZSBvZiBhIGJpbmRlciB0cmFuc2FjdGlvbiwgeW91IDxiPm11c3Q8L2I+CiAgICAgKiBjYWxsIHtAbGluayBhbmRyb2lkLm9zLkJpbmRlciNjbGVhckNhbGxpbmdJZGVudGl0eSgpfSBiZWZvcmUgY2FsbGluZyB0aGlzIG1ldGhvZC4gQQogICAgICoge0BsaW5rIFNlY3VyaXR5RXhjZXB0aW9ufSB3aWxsIGJlIHRocm93biBvdGhlcndpc2UuCiAgICAgKgogICAgICogVGhpcyBBUEkgc2hvdWxkIGJlIHVzZWQgc3BhcmluZ2x5IC0tIGxhcmdlIG51bWJlcnMgb2YgbGlzdGVuZXJzIHdpbGwgY2F1c2Ugc3lzdGVtCiAgICAgKiBpbnN0YWJpbGl0eS4gSWYgYSBwcm9jZXNzIGhhcyByZWdpc3RlcmVkIHRvbyBtYW55IGxpc3RlbmVycyB3aXRob3V0IHVucmVnaXN0ZXJpbmcgdGhlbSwgaXQKICAgICAqIG1heSBlbmNvdW50ZXIgYW4ge0BsaW5rIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbn0gd2hlbiB0cnlpbmcgdG8gcmVnaXN0ZXIgbW9yZSBsaXN0ZW5lcnMuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIFRoZSB7QGxpbmsgUGhvbmVTdGF0ZUxpc3RlbmVyfSBvYmplY3QgdG8gcmVnaXN0ZXIKICAgICAqICAgICAgICAgICAgICAgICAob3IgdW5yZWdpc3RlcikKICAgICAqIEBwYXJhbSBldmVudHMgVGhlIHRlbGVwaG9ueSBzdGF0ZShzKSBvZiBpbnRlcmVzdCB0byB0aGUgbGlzdGVuZXIsCiAgICAgKiAgICAgICAgICAgICAgIGFzIGEgYml0d2lzZS1PUiBjb21iaW5hdGlvbiBvZiB7QGxpbmsgUGhvbmVTdGF0ZUxpc3RlbmVyfQogICAgICogICAgICAgICAgICAgICBMSVNURU5fIGZsYWdzLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBsaXN0ZW4oUGhvbmVTdGF0ZUxpc3RlbmVyIGxpc3RlbmVyLCBpbnQgZXZlbnRzKSB7CiAgICAgICAgaWYgKG1Db250ZXh0ID09IG51bGwpIHJldHVybjsKICAgICAgICBib29sZWFuIG5vdGlmeU5vdyA9IChnZXRJVGVsZXBob255KCkgIT0gbnVsbCk7CiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5ID0KICAgICAgICAgICAgICAgIChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSk7CiAgICAgICAgaWYgKHRlbGVwaG9ueVJlZ2lzdHJ5ICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnkubGlzdGVuRm9yU3Vic2NyaWJlcihtU3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSwKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciwgZXZlbnRzLCBub3RpZnlOb3cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFJsb2cudyhUQUcsICJ0ZWxlcGhvbnkgcmVnaXN0cnkgbm90IHJlYWR5LiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgQ0RNQSBFUkkgKEVuaGFuY2VkIFJvYW1pbmcgSW5kaWNhdG9yKSBpbmZvcm1hdGlvbgogICAgICoKICAgICAqIFJldHVybnMge0BsaW5rIGFuZHJvaWQudGVsZXBob255I0NkbWFFcmlJbmZvcm1hdGlvbn0KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBATm9uTnVsbAogICAgcHVibGljIENkbWFFcmlJbmZvcm1hdGlvbiBnZXRDZG1hRXJpSW5mb3JtYXRpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDZG1hRXJpSW5mb3JtYXRpb24oCiAgICAgICAgICAgICAgIGdldENkbWFFcmlJY29uSW5kZXgoZ2V0U3ViSWQoKSksIGdldENkbWFFcmlJY29uTW9kZShnZXRTdWJJZCgpKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBDRE1BIEVSSSBpY29uIGluZGV4IHRvIGRpc3BsYXkgZm9yIGEgc3Vic2NyaXB0aW9uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRDZG1hRXJpSWNvbkluZGV4KGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2RtYUVyaUljb25JbmRleEZvclN1YnNjcmliZXIoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gdGhlIHBob25lIHByb2Nlc3MgaXMgcmVzdGFydGluZy4KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBDRE1BIEVSSSBpY29uIG1vZGUgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogMCAtIE9OCiAgICAgKiAxIC0gRkxBU0hJTkcKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRDZG1hRXJpSWNvbk1vZGUoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRDZG1hRXJpSWNvbk1vZGVGb3JTdWJzY3JpYmVyKHN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIHRoZSBwaG9uZSBwcm9jZXNzIGlzIHJlc3RhcnRpbmcuCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgQ0RNQSBFUkkgdGV4dCwKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN0cmluZyBnZXRDZG1hRXJpVGV4dCgpIHsKICAgICAgICByZXR1cm4gZ2V0Q2RtYUVyaVRleHQoZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBDRE1BIEVSSSB0ZXh0LCBvZiBhIHN1YnNjcmlwdGlvbgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN0cmluZyBnZXRDZG1hRXJpVGV4dChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2RtYUVyaVRleHRGb3JTdWJzY3JpYmVyKHN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIHRoZSBwaG9uZSBwcm9jZXNzIGlzIHJlc3RhcnRpbmcuCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgInZvaWNlIGNhcGFibGUiLgogICAgICogPHA+CiAgICAgKiAiVm9pY2UgY2FwYWJsZSIgbWVhbnMgdGhhdCB0aGlzIGRldmljZSBzdXBwb3J0cyBjaXJjdWl0LXN3aXRjaGVkCiAgICAgKiAoaS5lLiB2b2ljZSkgcGhvbmUgY2FsbHMgb3ZlciB0aGUgdGVsZXBob255IG5ldHdvcmssIGFuZCBpcyBhbGxvd2VkCiAgICAgKiB0byBkaXNwbGF5IHRoZSBpbi1jYWxsIFVJIHdoaWxlIGEgY2VsbHVsYXIgdm9pY2UgY2FsbCBpcyBhY3RpdmUuCiAgICAgKiBUaGlzIHdpbGwgYmUgZmFsc2Ugb24gImRhdGEgb25seSIgZGV2aWNlcyB3aGljaCBjYW4ndCBtYWtlIHZvaWNlCiAgICAgKiBjYWxscyBhbmQgZG9uJ3Qgc3VwcG9ydCBhbnkgaW4tY2FsbCBVSS4KICAgICAqIDxwPgogICAgICogTm90ZTogdGhlIG1lYW5pbmcgb2YgdGhpcyBmbGFnIGlzIHN1YnRseSBkaWZmZXJlbnQgZnJvbSB0aGUKICAgICAqIFBhY2thZ2VNYW5hZ2VyLkZFQVRVUkVfVEVMRVBIT05ZIHN5c3RlbSBmZWF0dXJlLCB3aGljaCBpcyBhdmFpbGFibGUKICAgICAqIG9uIGFueSBkZXZpY2Ugd2l0aCBhIHRlbGVwaG9ueSByYWRpbywgZXZlbiBpZiB0aGUgZGV2aWNlIGlzCiAgICAgKiBkYXRhLW9ubHkuCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGlzVm9pY2VDYXBhYmxlKCkgewogICAgICAgIGlmIChtQ29udGV4dCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gbUNvbnRleHQuZ2V0UmVzb3VyY2VzKCkuZ2V0Qm9vbGVhbigKICAgICAgICAgICAgICAgIGNvbS5hbmRyb2lkLmludGVybmFsLlIuYm9vbC5jb25maWdfdm9pY2VfY2FwYWJsZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIGN1cnJlbnQgZGV2aWNlIHN1cHBvcnRzIHNtcyBzZXJ2aWNlLgogICAgICogPHA+CiAgICAgKiBJZiB0cnVlLCB0aGlzIG1lYW5zIHRoYXQgdGhlIGRldmljZSBzdXBwb3J0cyBib3RoIHNlbmRpbmcgYW5kCiAgICAgKiByZWNlaXZpbmcgc21zIHZpYSB0aGUgdGVsZXBob255IG5ldHdvcmsuCiAgICAgKiA8cD4KICAgICAqIE5vdGU6IFZvaWNlbWFpbCB3YWl0aW5nIHNtcywgY2VsbCBicm9hZGNhc3Rpbmcgc21zLCBhbmQgTU1TIGFyZQogICAgICogICAgICAgZGlzYWJsZWQgd2hlbiBkZXZpY2UgZG9lc24ndCBzdXBwb3J0IHNtcy4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNTbXNDYXBhYmxlKCkgewogICAgICAgIGlmIChtQ29udGV4dCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gbUNvbnRleHQuZ2V0UmVzb3VyY2VzKCkuZ2V0Qm9vbGVhbigKICAgICAgICAgICAgICAgIGNvbS5hbmRyb2lkLmludGVybmFsLlIuYm9vbC5jb25maWdfc21zX2NhcGFibGUpOwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdHMgYWxsIGF2YWlsYWJsZSBjZWxsIGluZm9ybWF0aW9uIGZyb20gYWxsIHJhZGlvcyBvbiB0aGUgZGV2aWNlIGluY2x1ZGluZyB0aGUKICAgICAqIGNhbXBlZC9yZWdpc3RlcmVkLCBzZXJ2aW5nLCBhbmQgbmVpZ2hib3JpbmcgY2VsbHMuCiAgICAgKgogICAgICogPHA+VGhlIHJlc3BvbnNlIGNhbiBpbmNsdWRlIG9uZSBvciBtb3JlIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5DZWxsSW5mb0dzbSBDZWxsSW5mb0dzbX0sCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm9DZG1hIENlbGxJbmZvQ2RtYX0sCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm9UZHNjZG1hIENlbGxJbmZvVGRzY2RtYX0sCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm9MdGUgQ2VsbEluZm9MdGV9LCBhbmQKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5DZWxsSW5mb1djZG1hIENlbGxJbmZvV2NkbWF9IG9iamVjdHMsIGluIGFueSBjb21iaW5hdGlvbi4KICAgICAqIEl0IGlzIHR5cGljYWwgdG8gc2VlIGluc3RhbmNlcyBvZiBvbmUgb3IgbW9yZSBvZiBhbnkgdGhlc2UgaW4gdGhlIGxpc3QuIEluIGFkZGl0aW9uLCB6ZXJvCiAgICAgKiBvciBtb3JlIG9mIHRoZSByZXR1cm5lZCBvYmplY3RzIG1heSBiZSBjb25zaWRlcmVkIHJlZ2lzdGVyZWQ7IHRoYXQgaXMsIHRoZWlyCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm8jaXNSZWdpc3RlcmVkIENlbGxJbmZvLmlzUmVnaXN0ZXJlZCgpfQogICAgICogbWV0aG9kcyBtYXkgcmV0dXJuIHRydWUsIGluZGljYXRpbmcgdGhhdCB0aGUgY2VsbCBpcyBiZWluZyB1c2VkIG9yIHdvdWxkIGJlIHVzZWQgZm9yCiAgICAgKiBzaWduYWxpbmcgY29tbXVuaWNhdGlvbiBpZiBuZWNlc3NhcnkuCiAgICAgKgogICAgICogPHA+QmVnaW5uaW5nIHdpdGgge0BsaW5rIGFuZHJvaWQub3MuQnVpbGQuVkVSU0lPTl9DT0RFUyNRIEFuZHJvaWQgUX0sCiAgICAgKiBpZiB0aGlzIEFQSSByZXN1bHRzIGluIGEgY2hhbmdlIG9mIHRoZSBjYWNoZWQgQ2VsbEluZm8sIHRoYXQgY2hhbmdlIHdpbGwgYmUgcmVwb3J0ZWQgdmlhCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuUGhvbmVTdGF0ZUxpc3RlbmVyI29uQ2VsbEluZm9DaGFuZ2VkIG9uQ2VsbEluZm9DaGFuZ2VkKCl9LgogICAgICoKICAgICAqIDxwPkFwcHMgdGFyZ2V0aW5nIHtAbGluayBhbmRyb2lkLm9zLkJ1aWxkLlZFUlNJT05fQ09ERVMjUSBBbmRyb2lkIFF9IG9yIGhpZ2hlciB3aWxsIG5vCiAgICAgKiBsb25nZXIgdHJpZ2dlciBhIHJlZnJlc2ggb2YgdGhlIGNhY2hlZCBDZWxsSW5mbyBieSBpbnZva2luZyB0aGlzIEFQSS4gSW5zdGVhZCwgdGhvc2UgYXBwcwogICAgICogd2lsbCByZWNlaXZlIHRoZSBsYXRlc3QgY2FjaGVkIHJlc3VsdHMsIHdoaWNoIG1heSBub3QgYmUgY3VycmVudC4gQXBwcyB0YXJnZXRpbmcKICAgICAqIHtAbGluayBhbmRyb2lkLm9zLkJ1aWxkLlZFUlNJT05fQ09ERVMjUSBBbmRyb2lkIFF9IG9yIGhpZ2hlciB0aGF0IHdpc2ggdG8gcmVxdWVzdCB1cGRhdGVkCiAgICAgKiBDZWxsSW5mbyBzaG91bGQgY2FsbAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlRlbGVwaG9ueU1hbmFnZXIjcmVxdWVzdENlbGxJbmZvVXBkYXRlIHJlcXVlc3RDZWxsSW5mb1VwZGF0ZSgpfTsKICAgICAqIGhvd2V2ZXIsIGluIGFsbCBjYXNlcywgdXBkYXRlcyB3aWxsIGJlIHJhdGUtbGltaXRlZCBhbmQgYXJlIG5vdCBndWFyYW50ZWVkLiBUbyBkZXRlcm1pbmUgdGhlCiAgICAgKiByZWNlbmN5IG9mIENlbGxJbmZvIGRhdGEsIGNhbGxlcnMgc2hvdWxkIGNoZWNrCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm8jZ2V0VGltZVN0YW1wIENlbGxJbmZvI2dldFRpbWVTdGFtcCgpfS4KICAgICAqCiAgICAgKiA8cD5UaGlzIG1ldGhvZCByZXR1cm5zIHZhbGlkIGRhdGEgZm9yIGRldmljZXMgd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlciNGRUFUVVJFX1RFTEVQSE9OWSBGRUFUVVJFX1RFTEVQSE9OWX0uIEluIGNhc2VzCiAgICAgKiB3aGVyZSBvbmx5IHBhcnRpYWwgaW5mb3JtYXRpb24gaXMgYXZhaWxhYmxlIGZvciBhIHBhcnRpY3VsYXIgQ2VsbEluZm8gZW50cnksIHVuYXZhaWxhYmxlCiAgICAgKiBmaWVsZHMgd2lsbCBiZSByZXBvcnRlZCBhcyB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm8jVU5BVkFJTEFCTEV9LiBBbGwgcmVwb3J0ZWQKICAgICAqIGNlbGxzIHdpbGwgaW5jbHVkZSBhdCBsZWFzdCBhIHZhbGlkIHNldCBvZiB0ZWNobm9sb2d5LXNwZWNpZmljIGlkZW50aWZpY2F0aW9uIGluZm8gYW5kIGEKICAgICAqIHBvd2VyIGxldmVsIG1lYXN1cmVtZW50LgogICAgICoKICAgICAqIDxwPlRoaXMgbWV0aG9kIGlzIHByZWZlcnJlZCBvdmVyIHVzaW5nIHtAbGluawogICAgICogYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNnZXRDZWxsTG9jYXRpb24gZ2V0Q2VsbExvY2F0aW9uKCl9LgogICAgICoKICAgICAqIEByZXR1cm4gTGlzdCBvZiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuQ2VsbEluZm99OyBudWxsIGlmIGNlbGwKICAgICAqIGluZm9ybWF0aW9uIGlzIHVuYXZhaWxhYmxlLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5BQ0NFU1NfRklORV9MT0NBVElPTikKICAgIHB1YmxpYyBMaXN0PENlbGxJbmZvPiBnZXRBbGxDZWxsSW5mbygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0QWxsQ2VsbEluZm8oZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKiogQ2FsbGJhY2sgZm9yIHByb3ZpZGluZyBhc3luY2hyb25vdXMge0BsaW5rIENlbGxJbmZvfSBvbiByZXF1ZXN0ICovCiAgICBwdWJsaWMgYWJzdHJhY3Qgc3RhdGljIGNsYXNzIENlbGxJbmZvQ2FsbGJhY2sgewogICAgICAgIC8qKgogICAgICAgICAqIFN1Y2Nlc3MgcmVzcG9uc2UgdG8KICAgICAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNyZXF1ZXN0Q2VsbEluZm9VcGRhdGUgcmVxdWVzdENlbGxJbmZvVXBkYXRlKCl9LgogICAgICAgICAqCiAgICAgICAgICogSW52b2tlZCB3aGVuIHRoZXJlIGlzIGEgcmVzcG9uc2UgdG8KICAgICAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNyZXF1ZXN0Q2VsbEluZm9VcGRhdGUgcmVxdWVzdENlbGxJbmZvVXBkYXRlKCl9CiAgICAgICAgICogdG8gcHJvdmlkZSBhIGxpc3Qgb2Yge0BsaW5rIENlbGxJbmZvfS4gSWYgbm8ge0BsaW5rIENlbGxJbmZvfSBpcyBhdmFpbGFibGUgdGhlbiBhbiBlbXB0eQogICAgICAgICAqIGxpc3Qgd2lsbCBiZSBwcm92aWRlZC4gSWYgYW4gZXJyb3Igb2NjdXJzLCBudWxsIHdpbGwgYmUgcHJvdmlkZWQgdW5sZXNzIHRoZSBvbkVycm9yCiAgICAgICAgICogY2FsbGJhY2sgaXMgb3ZlcnJpZGRlbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBjZWxsSW5mbyBhIGxpc3Qgb2Yge0BsaW5rIENlbGxJbmZvfSwgYW4gZW1wdHkgbGlzdCwgb3IgbnVsbC4KICAgICAgICAgKgogICAgICAgICAqIHtAc2VlIGFuZHJvaWQudGVsZXBob255LlRlbGVwaG9ueU1hbmFnZXIjZ2V0QWxsQ2VsbEluZm8gZ2V0QWxsQ2VsbEluZm8oKX0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgYWJzdHJhY3Qgdm9pZCBvbkNlbGxJbmZvKEBOb25OdWxsIExpc3Q8Q2VsbEluZm8+IGNlbGxJbmZvKTsKCiAgICAgICAgLyoqIEBoaWRlICovCiAgICAgICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgICAgIEBJbnREZWYocHJlZml4ID0geyJFUlJPUl8ifSwgdmFsdWUgPSB7RVJST1JfVElNRU9VVCwgRVJST1JfTU9ERU1fRVJST1J9KQogICAgICAgIHB1YmxpYyBAaW50ZXJmYWNlIENlbGxJbmZvQ2FsbGJhY2tFcnJvciB7fQoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgc3lzdGVtIHRpbWVkIG91dCB3YWl0aW5nIGZvciBhIHJlc3BvbnNlIGZyb20gdGhlIFJhZGlvLgogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVSUk9SX1RJTUVPVVQgPSAxOwoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbW9kZW0gcmV0dXJuZWQgYSBmYWlsdXJlLgogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVSUk9SX01PREVNX0VSUk9SID0gMjsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXJyb3IgcmVzcG9uc2UgdG8KICAgICAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNyZXF1ZXN0Q2VsbEluZm9VcGRhdGUgcmVxdWVzdENlbGxJbmZvVXBkYXRlKCl9LgogICAgICAgICAqCiAgICAgICAgICogSW52b2tlZCB3aGVuIGFuIGVycm9yIGNvbmRpdGlvbiBwcmV2ZW50cyB1cGRhdGVkIHtAbGluayBDZWxsSW5mb30gZnJvbSBiZWluZyBmZXRjaGVkCiAgICAgICAgICogYW5kIHJldHVybmVkIGZyb20gdGhlIG1vZGVtLiBDYWxsZXJzIG9mIHJlcXVlc3RDZWxsSW5mb1VwZGF0ZSgpIHNob3VsZCBvdmVycmlkZSB0aGlzCiAgICAgICAgICogZnVuY3Rpb24gdG8gcmVjZWl2ZSBkZXRhaWxlZCBzdGF0dXMgaW5mb3JtYXRpb24gaW4gdGhlIGV2ZW50IG9mIGFuIGVycm9yLiBCeSBkZWZhdWx0LAogICAgICAgICAqIHRoaXMgZnVuY3Rpb24gd2lsbCBpbnZva2Ugb25DZWxsSW5mbygpIHdpdGggbnVsbC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBlcnJvckNvZGUgYW4gZXJyb3IgY29kZSBpbmRpY2F0aW5nIHRoZSB0eXBlIG9mIGZhaWx1cmUuCiAgICAgICAgICogQHBhcmFtIGRldGFpbCBhIFRocm93YWJsZSBvYmplY3Qgd2l0aCBhZGRpdGlvbmFsIGRldGFpbCByZWdhcmRpbmcgdGhlIGZhaWx1cmUgaWYKICAgICAgICAgKiAgICAgYXZhaWxhYmxlLCBvdGhlcndpc2UgbnVsbC4KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvbkVycm9yKEBDZWxsSW5mb0NhbGxiYWNrRXJyb3IgaW50IGVycm9yQ29kZSwgQE51bGxhYmxlIFRocm93YWJsZSBkZXRhaWwpIHsKICAgICAgICAgICAgLy8gQnkgZGVmYXVsdCwgc2ltcGx5IGludm9rZSB0aGUgc3VjY2VzcyBjYWxsYmFjayB3aXRoIGFuIGVtcHR5IGxpc3QuCiAgICAgICAgICAgIG9uQ2VsbEluZm8obmV3IEFycmF5TGlzdDxDZWxsSW5mbz4oKSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIFJlcXVlc3RzIGFsbCBhdmFpbGFibGUgY2VsbCBpbmZvcm1hdGlvbiBmcm9tIHRoZSBjdXJyZW50IHN1YnNjcmlwdGlvbiBmb3Igb2JzZXJ2ZWQKICAgICAqIGNhbXBlZC9yZWdpc3RlcmVkLCBzZXJ2aW5nLCBhbmQgbmVpZ2hib3JpbmcgY2VsbHMuCiAgICAgKgogICAgICogPHA+QW55IGF2YWlsYWJsZSByZXN1bHRzIGZyb20gdGhpcyByZXF1ZXN0IHdpbGwgYmUgcHJvdmlkZWQgYnkgY2FsbHMgdG8KICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5QaG9uZVN0YXRlTGlzdGVuZXIjb25DZWxsSW5mb0NoYW5nZWQgb25DZWxsSW5mb0NoYW5nZWQoKX0KICAgICAqIGZvciBlYWNoIGFjdGl2ZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogPHA+VGhpcyBtZXRob2QgcmV0dXJucyB2YWxpZCBkYXRhIGZvciBkZXZpY2VzIHdpdGgKICAgICAqIHtAbGluayBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTlkgRkVBVFVSRV9URUxFUEhPTll9LiBPbiBkZXZpY2VzCiAgICAgKiB0aGF0IGRvIG5vdCBpbXBsZW1lbnQgdGhpcyBmZWF0dXJlLCB0aGUgYmVoYXZpb3IgaXMgbm90IHJlbGlhYmxlLgogICAgICoKICAgICAqIEBwYXJhbSBleGVjdXRvciB0aGUgZXhlY3V0b3Igb24gd2hpY2ggY2FsbGJhY2sgd2lsbCBiZSBpbnZva2VkLgogICAgICogQHBhcmFtIGNhbGxiYWNrIGEgY2FsbGJhY2sgdG8gcmVjZWl2ZSBDZWxsSW5mby4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uQUNDRVNTX0ZJTkVfTE9DQVRJT04pCiAgICBwdWJsaWMgdm9pZCByZXF1ZXN0Q2VsbEluZm9VcGRhdGUoCiAgICAgICAgICAgIEBOb25OdWxsIEBDYWxsYmFja0V4ZWN1dG9yIEV4ZWN1dG9yIGV4ZWN1dG9yLCBATm9uTnVsbCBDZWxsSW5mb0NhbGxiYWNrIGNhbGxiYWNrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkgcmV0dXJuOwogICAgICAgICAgICB0ZWxlcGhvbnkucmVxdWVzdENlbGxJbmZvVXBkYXRlKAogICAgICAgICAgICAgICAgICAgIGdldFN1YklkKCksCiAgICAgICAgICAgICAgICAgICAgbmV3IElDZWxsSW5mb0NhbGxiYWNrLlN0dWIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgdm9pZCBvbkNlbGxJbmZvKExpc3Q8Q2VsbEluZm8+IGNlbGxJbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbCBsb25nIGlkZW50aXR5ID0gQmluZGVyLmNsZWFyQ2FsbGluZ0lkZW50aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gY2FsbGJhY2sub25DZWxsSW5mbyhjZWxsSW5mbykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgdm9pZCBvbkVycm9yKGludCBlcnJvckNvZGUsIFN0cmluZyBleGNlcHRpb25OYW1lLCBTdHJpbmcgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IGNhbGxiYWNrLm9uRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVUaHJvd2FibGVCeUNsYXNzTmFtZShleGNlcHRpb25OYW1lLCBtZXNzYWdlKSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBnZXRPcFBhY2thZ2VOYW1lKCksIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3RzIGFsbCBhdmFpbGFibGUgY2VsbCBpbmZvcm1hdGlvbiBmcm9tIHRoZSBjdXJyZW50IHN1YnNjcmlwdGlvbiBmb3Igb2JzZXJ2ZWQKICAgICAqIGNhbXBlZC9yZWdpc3RlcmVkLCBzZXJ2aW5nLCBhbmQgbmVpZ2hib3JpbmcgY2VsbHMuCiAgICAgKgogICAgICogPHA+QW55IGF2YWlsYWJsZSByZXN1bHRzIGZyb20gdGhpcyByZXF1ZXN0IHdpbGwgYmUgcHJvdmlkZWQgYnkgY2FsbHMgdG8KICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5QaG9uZVN0YXRlTGlzdGVuZXIjb25DZWxsSW5mb0NoYW5nZWQgb25DZWxsSW5mb0NoYW5nZWQoKX0KICAgICAqIGZvciBlYWNoIGFjdGl2ZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogPHA+VGhpcyBtZXRob2QgcmV0dXJucyB2YWxpZCBkYXRhIGZvciBkZXZpY2VzIHdpdGgKICAgICAqIHtAbGluayBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTlkgRkVBVFVSRV9URUxFUEhPTll9LiBPbiBkZXZpY2VzCiAgICAgKiB0aGF0IGRvIG5vdCBpbXBsZW1lbnQgdGhpcyBmZWF0dXJlLCB0aGUgYmVoYXZpb3IgaXMgbm90IHJlbGlhYmxlLgogICAgICoKICAgICAqIEBwYXJhbSB3b3JrU291cmNlIHRoZSByZXF1ZXN0b3IgdG8gd2hvbSB0aGUgcG93ZXIgY29uc3VtcHRpb24gZm9yIHRoaXMgc2hvdWxkIGJlIGF0dHJpYnV0ZWQuCiAgICAgKiBAcGFyYW0gZXhlY3V0b3IgdGhlIGV4ZWN1dG9yIG9uIHdoaWNoIGNhbGxiYWNrIHdpbGwgYmUgaW52b2tlZC4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBhIGNhbGxiYWNrIHRvIHJlY2VpdmUgQ2VsbEluZm8uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFsbE9mID0ge2FuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5BQ0NFU1NfRklORV9MT0NBVElPTiwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURX0pCiAgICBwdWJsaWMgdm9pZCByZXF1ZXN0Q2VsbEluZm9VcGRhdGUoQE5vbk51bGwgV29ya1NvdXJjZSB3b3JrU291cmNlLAogICAgICAgICAgICBATm9uTnVsbCBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwgQE5vbk51bGwgQ2VsbEluZm9DYWxsYmFjayBjYWxsYmFjaykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybjsKICAgICAgICAgICAgdGVsZXBob255LnJlcXVlc3RDZWxsSW5mb1VwZGF0ZVdpdGhXb3JrU291cmNlKAogICAgICAgICAgICAgICAgICAgIGdldFN1YklkKCksCiAgICAgICAgICAgICAgICAgICAgbmV3IElDZWxsSW5mb0NhbGxiYWNrLlN0dWIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgdm9pZCBvbkNlbGxJbmZvKExpc3Q8Q2VsbEluZm8+IGNlbGxJbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbCBsb25nIGlkZW50aXR5ID0gQmluZGVyLmNsZWFyQ2FsbGluZ0lkZW50aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gY2FsbGJhY2sub25DZWxsSW5mbyhjZWxsSW5mbykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgICAgICAgICAgICAgICAgcHVibGljIHZvaWQgb25FcnJvcihpbnQgZXJyb3JDb2RlLCBTdHJpbmcgZXhjZXB0aW9uTmFtZSwgU3RyaW5nIG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsIGxvbmcgaWRlbnRpdHkgPSBCaW5kZXIuY2xlYXJDYWxsaW5nSWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0b3IuZXhlY3V0ZSgoKSAtPiBjYWxsYmFjay5vbkVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlVGhyb3dhYmxlQnlDbGFzc05hbWUoZXhjZXB0aW9uTmFtZSwgbWVzc2FnZSkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQmluZGVyLnJlc3RvcmVDYWxsaW5nSWRlbnRpdHkoaWRlbnRpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpLCB3b3JrU291cmNlKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgVGhyb3dhYmxlIGNyZWF0ZVRocm93YWJsZUJ5Q2xhc3NOYW1lKFN0cmluZyBjbGFzc05hbWUsIFN0cmluZyBtZXNzYWdlKSB7CiAgICAgICAgaWYgKGNsYXNzTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBDbGFzczw/PiBjID0gQ2xhc3MuZm9yTmFtZShjbGFzc05hbWUpOwogICAgICAgICAgICByZXR1cm4gKFRocm93YWJsZSkgYy5nZXRDb25zdHJ1Y3RvcihTdHJpbmcuY2xhc3MpLm5ld0luc3RhbmNlKG1lc3NhZ2UpOwogICAgICAgIH0gY2F0Y2ggKFJlZmxlY3RpdmVPcGVyYXRpb25FeGNlcHRpb24gfCBDbGFzc0Nhc3RFeGNlcHRpb24gZSkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFJ1bnRpbWVFeGNlcHRpb24oY2xhc3NOYW1lICsgIjogIiArIG1lc3NhZ2UpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgbWluaW11bSB0aW1lIGluIG1pbGxpLXNlY29uZHMgYmV0d2VlbiB7QGxpbmsgUGhvbmVTdGF0ZUxpc3RlbmVyI29uQ2VsbEluZm9DaGFuZ2VkCiAgICAgKiBQaG9uZVN0YXRlTGlzdGVuZXIub25DZWxsSW5mb0NoYW5nZWR9IHdpbGwgYmUgaW52b2tlZC4KICAgICAqPHA+CiAgICAgKiBUaGUgZGVmYXVsdCwgMCwgbWVhbnMgaW52b2tlIG9uQ2VsbEluZm9DaGFuZ2VkIHdoZW4gYW55IG9mIHRoZSByZXBvcnRlZAogICAgICogaW5mb3JtYXRpb24gY2hhbmdlcy4gU2V0dGluZyB0aGUgdmFsdWUgdG8gSU5UX01BWCgweDdmZmZmZmZmKSBtZWFucyBuZXZlciBpc3N1ZQogICAgICogQSBvbkNlbGxJbmZvQ2hhbmdlZC4KICAgICAqPHA+CiAgICAgKiBAcGFyYW0gcmF0ZUluTWlsbGlzIHRoZSByYXRlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0Q2VsbEluZm9MaXN0UmF0ZShpbnQgcmF0ZUluTWlsbGlzKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRDZWxsSW5mb0xpc3RSYXRlKHJhdGVJbk1pbGxpcyk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBNTVMgdXNlciBhZ2VudC4KICAgICAqLwogICAgcHVibGljIFN0cmluZyBnZXRNbXNVc2VyQWdlbnQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRNbXNVc2VyQWdlbnQoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIE1NUyB1c2VyIGFnZW50IHByb2ZpbGUgVVJMLgogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldE1tc1VBUHJvZlVybCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldE1tc1VBUHJvZlVybChnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogT3BlbnMgYSBsb2dpY2FsIGNoYW5uZWwgdG8gdGhlIElDQyBjYXJkLgogICAgICoKICAgICAqIElucHV0IHBhcmFtZXRlcnMgZXF1aXZhbGVudCB0byBUUyAyNy4wMDcgQVQrQ0NITyBjb21tYW5kLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBBSUQgQXBwbGljYXRpb24gaWQuIFNlZSBFVFNJIDEwMi4yMjEgYW5kIDEwMS4yMjAuCiAgICAgKiBAcmV0dXJuIGFuIEljY09wZW5Mb2dpY2FsQ2hhbm5lbFJlc3BvbnNlIG9iamVjdC4KICAgICAqIEBkZXByZWNhdGVkIFJlcGxhY2VkIGJ5IHtAbGluayAjaWNjT3BlbkxvZ2ljYWxDaGFubmVsKFN0cmluZywgaW50KX0KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBJY2NPcGVuTG9naWNhbENoYW5uZWxSZXNwb25zZSBpY2NPcGVuTG9naWNhbENoYW5uZWwoU3RyaW5nIEFJRCkgewogICAgICAgIHJldHVybiBpY2NPcGVuTG9naWNhbENoYW5uZWwoZ2V0U3ViSWQoKSwgQUlELCAtMSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBPcGVucyBhIGxvZ2ljYWwgY2hhbm5lbCB0byB0aGUgSUNDIGNhcmQgdXNpbmcgdGhlIHBoeXNpY2FsIHNsb3QgaW5kZXguCiAgICAgKgogICAgICogVXNlIHRoaXMgbWV0aG9kIHdoZW4gbm8gc3Vic2NyaXB0aW9ucyBhcmUgYXZhaWxhYmxlIG9uIHRoZSBTSU0gYW5kIHRoZSBvcGVyYXRpb24gbXVzdCBiZQogICAgICogcGVyZm9ybWVkIHVzaW5nIHRoZSBwaHlzaWNhbCBzbG90IGluZGV4LgogICAgICoKICAgICAqIFRoaXMgb3BlcmF0aW9uIHdyYXBzIHR3byBBUERVIGluc3RydWN0aW9uczoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+TUFOQUdFIENIQU5ORUwgdG8gb3BlbiBhIGxvZ2ljYWwgY2hhbm5lbDwvbGk+CiAgICAgKiAgICAgPGxpPlNFTEVDVCB0aGUgZ2l2ZW4ge0Bjb2RlIEFJRH0gdXNpbmcgdGhlIGdpdmVuIHtAY29kZSBwMn08L2xpPgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBQZXIgT3BlbiBNb2JpbGUgQVBJIFNwZWNpZmljYXRpb24gdjMuMiBzZWN0aW9uIDYuMi43LmgsIG9ubHkgcDIgdmFsdWVzIG9mIDB4MDAsIDB4MDQsIDB4MDgsCiAgICAgKiBhbmQgMHgwQyBhcmUgZ3VhcmFudGVlZCB0byBiZSBzdXBwb3J0ZWQuCiAgICAgKgogICAgICogSWYgdGhlIFNFTEVDVCBjb21tYW5kJ3Mgc3RhdHVzIHdvcmQgaXMgbm90ICc5MDAwJywgJzYyeHgnLCBvciAnNjN4eCcsIHRoZSBzdGF0dXMgd29yZCB3aWxsIGJlCiAgICAgKiBjb25zaWRlcmVkIGFuIGVycm9yIGFuZCB0aGUgY2hhbm5lbCBzaGFsbCBub3QgYmUgb3BlbmVkLgogICAgICoKICAgICAqIElucHV0IHBhcmFtZXRlcnMgZXF1aXZhbGVudCB0byBUUyAyNy4wMDcgQVQrQ0NITyBjb21tYW5kLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9LgogICAgICoKICAgICAqIEBwYXJhbSBzbG90SW5kZXggdGhlIHBoeXNpY2FsIHNsb3QgaW5kZXggb2YgdGhlIElDQyBjYXJkCiAgICAgKiBAcGFyYW0gYWlkIEFwcGxpY2F0aW9uIGlkLiBTZWUgRVRTSSAxMDIuMjIxIGFuZCAxMDEuMjIwLgogICAgICogQHBhcmFtIHAyIFAyIHBhcmFtZXRlciAoZGVzY3JpYmVkIGluIElTTyA3ODE2LTQpLgogICAgICogQHJldHVybiBhbiBJY2NPcGVuTG9naWNhbENoYW5uZWxSZXNwb25zZSBvYmplY3QuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgQFN5c3RlbUFwaQogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgSWNjT3BlbkxvZ2ljYWxDaGFubmVsUmVzcG9uc2UgaWNjT3BlbkxvZ2ljYWxDaGFubmVsQnlTbG90KGludCBzbG90SW5kZXgsCiAgICAgICAgICAgIEBOdWxsYWJsZSBTdHJpbmcgYWlkLCBpbnQgcDIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmljY09wZW5Mb2dpY2FsQ2hhbm5lbEJ5U2xvdChzbG90SW5kZXgsIGdldE9wUGFja2FnZU5hbWUoKSwgYWlkLAogICAgICAgICAgICAgICAgICAgICAgICBwMik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIE9wZW5zIGEgbG9naWNhbCBjaGFubmVsIHRvIHRoZSBJQ0MgY2FyZC4KICAgICAqCiAgICAgKiBUaGlzIG9wZXJhdGlvbiB3cmFwcyB0d28gQVBEVSBpbnN0cnVjdGlvbnM6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPk1BTkFHRSBDSEFOTkVMIHRvIG9wZW4gYSBsb2dpY2FsIGNoYW5uZWw8L2xpPgogICAgICogICAgIDxsaT5TRUxFQ1QgdGhlIGdpdmVuIHtAY29kZSBBSUR9IHVzaW5nIHRoZSBnaXZlbiB7QGNvZGUgcDJ9PC9saT4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogUGVyIE9wZW4gTW9iaWxlIEFQSSBTcGVjaWZpY2F0aW9uIHYzLjIgc2VjdGlvbiA2LjIuNy5oLCBvbmx5IHAyIHZhbHVlcyBvZiAweDAwLCAweDA0LCAweDA4LAogICAgICogYW5kIDB4MEMgYXJlIGd1YXJhbnRlZWQgdG8gYmUgc3VwcG9ydGVkLgogICAgICoKICAgICAqIElmIHRoZSBTRUxFQ1QgY29tbWFuZCdzIHN0YXR1cyB3b3JkIGlzIG5vdCAnOTAwMCcsICc2Mnh4Jywgb3IgJzYzeHgnLCB0aGUgc3RhdHVzIHdvcmQgd2lsbCBiZQogICAgICogY29uc2lkZXJlZCBhbiBlcnJvciBhbmQgdGhlIGNoYW5uZWwgc2hhbGwgbm90IGJlIG9wZW5lZC4KICAgICAqCiAgICAgKiBJbnB1dCBwYXJhbWV0ZXJzIGVxdWl2YWxlbnQgdG8gVFMgMjcuMDA3IEFUK0NDSE8gY29tbWFuZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gQUlEIEFwcGxpY2F0aW9uIGlkLiBTZWUgRVRTSSAxMDIuMjIxIGFuZCAxMDEuMjIwLgogICAgICogQHBhcmFtIHAyIFAyIHBhcmFtZXRlciAoZGVzY3JpYmVkIGluIElTTyA3ODE2LTQpLgogICAgICogQHJldHVybiBhbiBJY2NPcGVuTG9naWNhbENoYW5uZWxSZXNwb25zZSBvYmplY3QuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlI2dldFVpY2NSZWFkZXIoaW50KX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5SZWFkZXIjb3BlblNlc3Npb24oKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TZXNzaW9uI29wZW5Mb2dpY2FsQ2hhbm5lbChieXRlW10sIGJ5dGUpfS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBJY2NPcGVuTG9naWNhbENoYW5uZWxSZXNwb25zZSBpY2NPcGVuTG9naWNhbENoYW5uZWwoU3RyaW5nIEFJRCwgaW50IHAyKSB7CiAgICAgICAgcmV0dXJuIGljY09wZW5Mb2dpY2FsQ2hhbm5lbChnZXRTdWJJZCgpLCBBSUQsIHAyKTsKICAgIH0KCiAgICAvKioKICAgICAqIE9wZW5zIGEgbG9naWNhbCBjaGFubmVsIHRvIHRoZSBJQ0MgY2FyZC4KICAgICAqCiAgICAgKiBUaGlzIG9wZXJhdGlvbiB3cmFwcyB0d28gQVBEVSBpbnN0cnVjdGlvbnM6CiAgICAgKiA8dWw+CiAgICAgKiAgICAgPGxpPk1BTkFHRSBDSEFOTkVMIHRvIG9wZW4gYSBsb2dpY2FsIGNoYW5uZWw8L2xpPgogICAgICogICAgIDxsaT5TRUxFQ1QgdGhlIGdpdmVuIHtAY29kZSBBSUR9IHVzaW5nIHRoZSBnaXZlbiB7QGNvZGUgcDJ9PC9saT4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogUGVyIE9wZW4gTW9iaWxlIEFQSSBTcGVjaWZpY2F0aW9uIHYzLjIgc2VjdGlvbiA2LjIuNy5oLCBvbmx5IHAyIHZhbHVlcyBvZiAweDAwLCAweDA0LCAweDA4LAogICAgICogYW5kIDB4MEMgYXJlIGd1YXJhbnRlZWQgdG8gYmUgc3VwcG9ydGVkLgogICAgICoKICAgICAqIElmIHRoZSBTRUxFQ1QgY29tbWFuZCdzIHN0YXR1cyB3b3JkIGlzIG5vdCAnOTAwMCcsICc2Mnh4Jywgb3IgJzYzeHgnLCB0aGUgc3RhdHVzIHdvcmQgd2lsbCBiZQogICAgICogY29uc2lkZXJlZCBhbiBlcnJvciBhbmQgdGhlIGNoYW5uZWwgc2hhbGwgbm90IGJlIG9wZW5lZC4KICAgICAqCiAgICAgKiBJbnB1dCBwYXJhbWV0ZXJzIGVxdWl2YWxlbnQgdG8gVFMgMjcuMDA3IEFUK0NDSE8gY29tbWFuZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHN1YnNjcmlwdGlvbiB0byB1c2UuCiAgICAgKiBAcGFyYW0gQUlEIEFwcGxpY2F0aW9uIGlkLiBTZWUgRVRTSSAxMDIuMjIxIGFuZCAxMDEuMjIwLgogICAgICogQHBhcmFtIHAyIFAyIHBhcmFtZXRlciAoZGVzY3JpYmVkIGluIElTTyA3ODE2LTQpLgogICAgICogQHJldHVybiBhbiBJY2NPcGVuTG9naWNhbENoYW5uZWxSZXNwb25zZSBvYmplY3QuCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZX0gQVBJcyBpbnN0ZWFkLiBTZWUKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZSNnZXRVaWNjUmVhZGVyKGludCl9LAogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuUmVhZGVyI29wZW5TZXNzaW9uKCl9LAogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU2Vzc2lvbiNvcGVuTG9naWNhbENoYW5uZWwoYnl0ZVtdLCBieXRlKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgSWNjT3BlbkxvZ2ljYWxDaGFubmVsUmVzcG9uc2UgaWNjT3BlbkxvZ2ljYWxDaGFubmVsKGludCBzdWJJZCwgU3RyaW5nIEFJRCwgaW50IHAyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaWNjT3BlbkxvZ2ljYWxDaGFubmVsKHN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCksIEFJRCwgcDIpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQ2xvc2VzIGEgcHJldmlvdXNseSBvcGVuZWQgbG9naWNhbCBjaGFubmVsIHRvIHRoZSBJQ0MgY2FyZCB1c2luZyB0aGUgcGh5c2ljYWwgc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiBVc2UgdGhpcyBtZXRob2Qgd2hlbiBubyBzdWJzY3JpcHRpb25zIGFyZSBhdmFpbGFibGUgb24gdGhlIFNJTSBhbmQgdGhlIG9wZXJhdGlvbiBtdXN0IGJlCiAgICAgKiBwZXJmb3JtZWQgdXNpbmcgdGhlIHBoeXNpY2FsIHNsb3QgaW5kZXguCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDQ0hDIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0uCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCB0aGUgcGh5c2ljYWwgc2xvdCBpbmRleCBvZiB0aGUgSUNDIGNhcmQKICAgICAqIEBwYXJhbSBjaGFubmVsIGlzIHRoZSBjaGFubmVsIGlkIHRvIGJlIGNsb3NlZCBhcyByZXR1cm5lZCBieSBhIHN1Y2Nlc3NmdWwKICAgICAqICAgICAgICAgICAgaWNjT3BlbkxvZ2ljYWxDaGFubmVsLgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBjaGFubmVsIHdhcyBjbG9zZWQgc3VjY2Vzc2Z1bGx5LgogICAgICogQGhpZGUKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2V9IEFQSXMgaW5zdGVhZC4gU2VlCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI2Nsb3NlKCl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBib29sZWFuIGljY0Nsb3NlTG9naWNhbENoYW5uZWxCeVNsb3QoaW50IHNsb3RJbmRleCwgaW50IGNoYW5uZWwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmljY0Nsb3NlTG9naWNhbENoYW5uZWxCeVNsb3Qoc2xvdEluZGV4LCBjaGFubmVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENsb3NlcyBhIHByZXZpb3VzbHkgb3BlbmVkIGxvZ2ljYWwgY2hhbm5lbCB0byB0aGUgSUNDIGNhcmQuCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDQ0hDIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGNoYW5uZWwgaXMgdGhlIGNoYW5uZWwgaWQgdG8gYmUgY2xvc2VkIGFzIHJldHVybmVkIGJ5IGEgc3VjY2Vzc2Z1bAogICAgICogICAgICAgICAgICBpY2NPcGVuTG9naWNhbENoYW5uZWwuCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIGNoYW5uZWwgd2FzIGNsb3NlZCBzdWNjZXNzZnVsbHkuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuQ2hhbm5lbCNjbG9zZSgpfS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBib29sZWFuIGljY0Nsb3NlTG9naWNhbENoYW5uZWwoaW50IGNoYW5uZWwpIHsKICAgICAgICByZXR1cm4gaWNjQ2xvc2VMb2dpY2FsQ2hhbm5lbChnZXRTdWJJZCgpLCBjaGFubmVsKTsKICAgIH0KCiAgICAvKioKICAgICAqIENsb3NlcyBhIHByZXZpb3VzbHkgb3BlbmVkIGxvZ2ljYWwgY2hhbm5lbCB0byB0aGUgSUNDIGNhcmQuCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDQ0hDIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gdG8gdXNlLgogICAgICogQHBhcmFtIGNoYW5uZWwgaXMgdGhlIGNoYW5uZWwgaWQgdG8gYmUgY2xvc2VkIGFzIHJldHVybmVkIGJ5IGEgc3VjY2Vzc2Z1bAogICAgICogICAgICAgICAgICBpY2NPcGVuTG9naWNhbENoYW5uZWwuCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIGNoYW5uZWwgd2FzIGNsb3NlZCBzdWNjZXNzZnVsbHkuCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZX0gQVBJcyBpbnN0ZWFkLiBTZWUKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLkNoYW5uZWwjY2xvc2UoKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgYm9vbGVhbiBpY2NDbG9zZUxvZ2ljYWxDaGFubmVsKGludCBzdWJJZCwgaW50IGNoYW5uZWwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pY2NDbG9zZUxvZ2ljYWxDaGFubmVsKHN1YklkLCBjaGFubmVsKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmFuc21pdCBhbiBBUERVIHRvIHRoZSBJQ0MgY2FyZCBvdmVyIGEgbG9naWNhbCBjaGFubmVsIHVzaW5nIHRoZSBwaHlzaWNhbCBzbG90IGluZGV4LgogICAgICoKICAgICAqIFVzZSB0aGlzIG1ldGhvZCB3aGVuIG5vIHN1YnNjcmlwdGlvbnMgYXJlIGF2YWlsYWJsZSBvbiB0aGUgU0lNIGFuZCB0aGUgb3BlcmF0aW9uIG11c3QgYmUKICAgICAqIHBlcmZvcm1lZCB1c2luZyB0aGUgcGh5c2ljYWwgc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiBJbnB1dCBwYXJhbWV0ZXJzIGVxdWl2YWxlbnQgdG8gVFMgMjcuMDA3IEFUK0NHTEEgY29tbWFuZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBwaHlzaWNhbCBzbG90IGluZGV4IG9mIHRoZSBJQ0MgY2FyZAogICAgICogQHBhcmFtIGNoYW5uZWwgaXMgdGhlIGNoYW5uZWwgaWQgdG8gYmUgY2xvc2VkIGFzIHJldHVybmVkIGJ5IGEgc3VjY2Vzc2Z1bAogICAgICogICAgICAgICAgICBpY2NPcGVuTG9naWNhbENoYW5uZWwuCiAgICAgKiBAcGFyYW0gY2xhIENsYXNzIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gaW5zdHJ1Y3Rpb24gSW5zdHJ1Y3Rpb24gb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMSBQMSB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAyIFAyIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDMgUDMgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4gSWYgcDMgaXMgbmVnYXRpdmUgYSA0IGJ5dGUgQVBEVQogICAgICogICAgICAgICAgICBpcyBzZW50IHRvIHRoZSBTSU0uCiAgICAgKiBAcGFyYW0gZGF0YSBEYXRhIHRvIGJlIHNlbnQgd2l0aCB0aGUgQVBEVS4KICAgICAqIEByZXR1cm4gVGhlIEFQRFUgcmVzcG9uc2UgZnJvbSB0aGUgSUNDIGNhcmQgd2l0aCB0aGUgc3RhdHVzIGFwcGVuZGVkIGF0IHRoZSBlbmQsIG9yIG51bGwgaWYKICAgICAqIHRoZXJlIGlzIGFuIGlzc3VlIGNvbm5lY3RpbmcgdG8gdGhlIFRlbGVwaG9ueSBzZXJ2aWNlLgogICAgICogQGhpZGUKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2V9IEFQSXMgaW5zdGVhZC4gU2VlCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI3RyYW5zbWl0KGJ5dGVbXSl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTeXN0ZW1BcGkKICAgIEBOdWxsYWJsZQogICAgcHVibGljIFN0cmluZyBpY2NUcmFuc21pdEFwZHVMb2dpY2FsQ2hhbm5lbEJ5U2xvdChpbnQgc2xvdEluZGV4LCBpbnQgY2hhbm5lbCwgaW50IGNsYSwKICAgICAgICAgICAgaW50IGluc3RydWN0aW9uLCBpbnQgcDEsIGludCBwMiwgaW50IHAzLCBATnVsbGFibGUgU3RyaW5nIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmljY1RyYW5zbWl0QXBkdUxvZ2ljYWxDaGFubmVsQnlTbG90KHNsb3RJbmRleCwgY2hhbm5lbCwgY2xhLAogICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVjdGlvbiwgcDEsIHAyLCBwMywgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFRyYW5zbWl0IGFuIEFQRFUgdG8gdGhlIElDQyBjYXJkIG92ZXIgYSBsb2dpY2FsIGNoYW5uZWwuCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDR0xBIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGNoYW5uZWwgaXMgdGhlIGNoYW5uZWwgaWQgdG8gYmUgY2xvc2VkIGFzIHJldHVybmVkIGJ5IGEgc3VjY2Vzc2Z1bAogICAgICogICAgICAgICAgICBpY2NPcGVuTG9naWNhbENoYW5uZWwuCiAgICAgKiBAcGFyYW0gY2xhIENsYXNzIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gaW5zdHJ1Y3Rpb24gSW5zdHJ1Y3Rpb24gb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMSBQMSB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAyIFAyIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDMgUDMgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4gSWYgcDMgaXMgbmVnYXRpdmUgYSA0IGJ5dGUgQVBEVQogICAgICogICAgICAgICAgICBpcyBzZW50IHRvIHRoZSBTSU0uCiAgICAgKiBAcGFyYW0gZGF0YSBEYXRhIHRvIGJlIHNlbnQgd2l0aCB0aGUgQVBEVS4KICAgICAqIEByZXR1cm4gVGhlIEFQRFUgcmVzcG9uc2UgZnJvbSB0aGUgSUNDIGNhcmQgd2l0aCB0aGUgc3RhdHVzIGFwcGVuZGVkIGF0CiAgICAgKiAgICAgICAgICAgIHRoZSBlbmQuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuQ2hhbm5lbCN0cmFuc21pdChieXRlW10pfS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBTdHJpbmcgaWNjVHJhbnNtaXRBcGR1TG9naWNhbENoYW5uZWwoaW50IGNoYW5uZWwsIGludCBjbGEsCiAgICAgICAgICAgIGludCBpbnN0cnVjdGlvbiwgaW50IHAxLCBpbnQgcDIsIGludCBwMywgU3RyaW5nIGRhdGEpIHsKICAgICAgICByZXR1cm4gaWNjVHJhbnNtaXRBcGR1TG9naWNhbENoYW5uZWwoZ2V0U3ViSWQoKSwgY2hhbm5lbCwgY2xhLAogICAgICAgICAgICAgICAgICAgIGluc3RydWN0aW9uLCBwMSwgcDIsIHAzLCBkYXRhKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRyYW5zbWl0IGFuIEFQRFUgdG8gdGhlIElDQyBjYXJkIG92ZXIgYSBsb2dpY2FsIGNoYW5uZWwuCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDR0xBIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gdG8gdXNlLgogICAgICogQHBhcmFtIGNoYW5uZWwgaXMgdGhlIGNoYW5uZWwgaWQgdG8gYmUgY2xvc2VkIGFzIHJldHVybmVkIGJ5IGEgc3VjY2Vzc2Z1bAogICAgICogICAgICAgICAgICBpY2NPcGVuTG9naWNhbENoYW5uZWwuCiAgICAgKiBAcGFyYW0gY2xhIENsYXNzIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gaW5zdHJ1Y3Rpb24gSW5zdHJ1Y3Rpb24gb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMSBQMSB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAyIFAyIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDMgUDMgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4gSWYgcDMgaXMgbmVnYXRpdmUgYSA0IGJ5dGUgQVBEVQogICAgICogICAgICAgICAgICBpcyBzZW50IHRvIHRoZSBTSU0uCiAgICAgKiBAcGFyYW0gZGF0YSBEYXRhIHRvIGJlIHNlbnQgd2l0aCB0aGUgQVBEVS4KICAgICAqIEByZXR1cm4gVGhlIEFQRFUgcmVzcG9uc2UgZnJvbSB0aGUgSUNDIGNhcmQgd2l0aCB0aGUgc3RhdHVzIGFwcGVuZGVkIGF0CiAgICAgKiAgICAgICAgICAgIHRoZSBlbmQuCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZX0gQVBJcyBpbnN0ZWFkLiBTZWUKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLkNoYW5uZWwjdHJhbnNtaXQoYnl0ZVtdKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgU3RyaW5nIGljY1RyYW5zbWl0QXBkdUxvZ2ljYWxDaGFubmVsKGludCBzdWJJZCwgaW50IGNoYW5uZWwsIGludCBjbGEsCiAgICAgICAgICAgIGludCBpbnN0cnVjdGlvbiwgaW50IHAxLCBpbnQgcDIsIGludCBwMywgU3RyaW5nIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pY2NUcmFuc21pdEFwZHVMb2dpY2FsQ2hhbm5lbChzdWJJZCwgY2hhbm5lbCwgY2xhLAogICAgICAgICAgICAgICAgICAgIGluc3RydWN0aW9uLCBwMSwgcDIsIHAzLCBkYXRhKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gIiI7CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmFuc21pdCBhbiBBUERVIHRvIHRoZSBJQ0MgY2FyZCBvdmVyIHRoZSBiYXNpYyBjaGFubmVsIHVzaW5nIHRoZSBwaHlzaWNhbCBzbG90IGluZGV4LgogICAgICoKICAgICAqIFVzZSB0aGlzIG1ldGhvZCB3aGVuIG5vIHN1YnNjcmlwdGlvbnMgYXJlIGF2YWlsYWJsZSBvbiB0aGUgU0lNIGFuZCB0aGUgb3BlcmF0aW9uIG11c3QgYmUKICAgICAqIHBlcmZvcm1lZCB1c2luZyB0aGUgcGh5c2ljYWwgc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiBJbnB1dCBwYXJhbWV0ZXJzIGVxdWl2YWxlbnQgdG8gVFMgMjcuMDA3IEFUK0NTSU0gY29tbWFuZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBwaHlzaWNhbCBzbG90IGluZGV4IG9mIHRoZSBJQ0MgY2FyZCB0byB0YXJnZXQKICAgICAqIEBwYXJhbSBjbGEgQ2xhc3Mgb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBpbnN0cnVjdGlvbiBJbnN0cnVjdGlvbiBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAxIFAxIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDIgUDIgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMyBQMyB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLiBJZiBwMyBpcyBuZWdhdGl2ZSBhIDQgYnl0ZSBBUERVCiAgICAgKiAgICAgICAgICAgIGlzIHNlbnQgdG8gdGhlIFNJTS4KICAgICAqIEBwYXJhbSBkYXRhIERhdGEgdG8gYmUgc2VudCB3aXRoIHRoZSBBUERVLgogICAgICogQHJldHVybiBUaGUgQVBEVSByZXNwb25zZSBmcm9tIHRoZSBJQ0MgY2FyZCB3aXRoIHRoZSBzdGF0dXMgYXBwZW5kZWQgYXQKICAgICAqICAgICAgICAgICAgdGhlIGVuZC4KICAgICAqIEBoaWRlCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlI2dldFVpY2NSZWFkZXIoaW50KX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5SZWFkZXIjb3BlblNlc3Npb24oKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TZXNzaW9uI29wZW5CYXNpY0NoYW5uZWwoYnl0ZVtdLCBieXRlKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI3RyYW5zbWl0KGJ5dGVbXSl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTeXN0ZW1BcGkKICAgIEBOb25OdWxsCiAgICBwdWJsaWMgU3RyaW5nIGljY1RyYW5zbWl0QXBkdUJhc2ljQ2hhbm5lbEJ5U2xvdChpbnQgc2xvdEluZGV4LCBpbnQgY2xhLCBpbnQgaW5zdHJ1Y3Rpb24sIGludCBwMSwKICAgICAgICAgICAgaW50IHAyLCBpbnQgcDMsIEBOdWxsYWJsZSBTdHJpbmcgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaWNjVHJhbnNtaXRBcGR1QmFzaWNDaGFubmVsQnlTbG90KHNsb3RJbmRleCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBjbGEsIGluc3RydWN0aW9uLCBwMSwgcDIsIHAzLCBkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogVHJhbnNtaXQgYW4gQVBEVSB0byB0aGUgSUNDIGNhcmQgb3ZlciB0aGUgYmFzaWMgY2hhbm5lbC4KICAgICAqCiAgICAgKiBJbnB1dCBwYXJhbWV0ZXJzIGVxdWl2YWxlbnQgdG8gVFMgMjcuMDA3IEFUK0NTSU0gY29tbWFuZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gY2xhIENsYXNzIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gaW5zdHJ1Y3Rpb24gSW5zdHJ1Y3Rpb24gb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMSBQMSB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAyIFAyIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDMgUDMgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4gSWYgcDMgaXMgbmVnYXRpdmUgYSA0IGJ5dGUgQVBEVQogICAgICogICAgICAgICAgICBpcyBzZW50IHRvIHRoZSBTSU0uCiAgICAgKiBAcGFyYW0gZGF0YSBEYXRhIHRvIGJlIHNlbnQgd2l0aCB0aGUgQVBEVS4KICAgICAqIEByZXR1cm4gVGhlIEFQRFUgcmVzcG9uc2UgZnJvbSB0aGUgSUNDIGNhcmQgd2l0aCB0aGUgc3RhdHVzIGFwcGVuZGVkIGF0CiAgICAgKiAgICAgICAgICAgIHRoZSBlbmQuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlI2dldFVpY2NSZWFkZXIoaW50KX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5SZWFkZXIjb3BlblNlc3Npb24oKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TZXNzaW9uI29wZW5CYXNpY0NoYW5uZWwoYnl0ZVtdLCBieXRlKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI3RyYW5zbWl0KGJ5dGVbXSl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIFN0cmluZyBpY2NUcmFuc21pdEFwZHVCYXNpY0NoYW5uZWwoaW50IGNsYSwKICAgICAgICAgICAgaW50IGluc3RydWN0aW9uLCBpbnQgcDEsIGludCBwMiwgaW50IHAzLCBTdHJpbmcgZGF0YSkgewogICAgICAgIHJldHVybiBpY2NUcmFuc21pdEFwZHVCYXNpY0NoYW5uZWwoZ2V0U3ViSWQoKSwgY2xhLAogICAgICAgICAgICAgICAgICAgIGluc3RydWN0aW9uLCBwMSwgcDIsIHAzLCBkYXRhKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRyYW5zbWl0IGFuIEFQRFUgdG8gdGhlIElDQyBjYXJkIG92ZXIgdGhlIGJhc2ljIGNoYW5uZWwuCiAgICAgKgogICAgICogSW5wdXQgcGFyYW1ldGVycyBlcXVpdmFsZW50IHRvIFRTIDI3LjAwNyBBVCtDU0lNIGNvbW1hbmQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gdG8gdXNlLgogICAgICogQHBhcmFtIGNsYSBDbGFzcyBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIGluc3RydWN0aW9uIEluc3RydWN0aW9uIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDEgUDEgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMiBQMiB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAzIFAzIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuIElmIHAzIGlzIG5lZ2F0aXZlIGEgNCBieXRlIEFQRFUKICAgICAqICAgICAgICAgICAgaXMgc2VudCB0byB0aGUgU0lNLgogICAgICogQHBhcmFtIGRhdGEgRGF0YSB0byBiZSBzZW50IHdpdGggdGhlIEFQRFUuCiAgICAgKiBAcmV0dXJuIFRoZSBBUERVIHJlc3BvbnNlIGZyb20gdGhlIElDQyBjYXJkIHdpdGggdGhlIHN0YXR1cyBhcHBlbmRlZCBhdAogICAgICogICAgICAgICAgICB0aGUgZW5kLgogICAgICogQGhpZGUKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2V9IEFQSXMgaW5zdGVhZC4gU2VlCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2UjZ2V0VWljY1JlYWRlcihpbnQpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlJlYWRlciNvcGVuU2Vzc2lvbigpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNlc3Npb24jb3BlbkJhc2ljQ2hhbm5lbChieXRlW10sIGJ5dGUpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLkNoYW5uZWwjdHJhbnNtaXQoYnl0ZVtdKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgU3RyaW5nIGljY1RyYW5zbWl0QXBkdUJhc2ljQ2hhbm5lbChpbnQgc3ViSWQsIGludCBjbGEsCiAgICAgICAgICAgIGludCBpbnN0cnVjdGlvbiwgaW50IHAxLCBpbnQgcDIsIGludCBwMywgU3RyaW5nIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pY2NUcmFuc21pdEFwZHVCYXNpY0NoYW5uZWwoc3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwgY2xhLAogICAgICAgICAgICAgICAgICAgIGluc3RydWN0aW9uLCBwMSwgcDIsIHAzLCBkYXRhKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gIiI7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSByZXNwb25zZSBBUERVIGZvciBhIGNvbW1hbmQgQVBEVSBzZW50IHRocm91Z2ggU0lNX0lPLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBmaWxlSUQKICAgICAqIEBwYXJhbSBjb21tYW5kCiAgICAgKiBAcGFyYW0gcDEgUDEgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBwMiBQMiB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAzIFAzIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gZmlsZVBhdGgKICAgICAqIEByZXR1cm4gVGhlIEFQRFUgcmVzcG9uc2UuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlI2dldFVpY2NSZWFkZXIoaW50KX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5SZWFkZXIjb3BlblNlc3Npb24oKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TZXNzaW9uI29wZW5CYXNpY0NoYW5uZWwoYnl0ZVtdLCBieXRlKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI3RyYW5zbWl0KGJ5dGVbXSl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIGJ5dGVbXSBpY2NFeGNoYW5nZVNpbUlPKGludCBmaWxlSUQsIGludCBjb21tYW5kLCBpbnQgcDEsIGludCBwMiwgaW50IHAzLAogICAgICAgICAgICBTdHJpbmcgZmlsZVBhdGgpIHsKICAgICAgICByZXR1cm4gaWNjRXhjaGFuZ2VTaW1JTyhnZXRTdWJJZCgpLCBmaWxlSUQsIGNvbW1hbmQsIHAxLCBwMiwgcDMsIGZpbGVQYXRoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHJlc3BvbnNlIEFQRFUgZm9yIGEgY29tbWFuZCBBUERVIHNlbnQgdGhyb3VnaCBTSU1fSU8uCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gdG8gdXNlLgogICAgICogQHBhcmFtIGZpbGVJRAogICAgICogQHBhcmFtIGNvbW1hbmQKICAgICAqIEBwYXJhbSBwMSBQMSB2YWx1ZSBvZiB0aGUgQVBEVSBjb21tYW5kLgogICAgICogQHBhcmFtIHAyIFAyIHZhbHVlIG9mIHRoZSBBUERVIGNvbW1hbmQuCiAgICAgKiBAcGFyYW0gcDMgUDMgdmFsdWUgb2YgdGhlIEFQRFUgY29tbWFuZC4KICAgICAqIEBwYXJhbSBmaWxlUGF0aAogICAgICogQHJldHVybiBUaGUgQVBEVSByZXNwb25zZS4KICAgICAqIEBoaWRlCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlfSBBUElzIGluc3RlYWQuIFNlZQogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU0VTZXJ2aWNlI2dldFVpY2NSZWFkZXIoaW50KX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5SZWFkZXIjb3BlblNlc3Npb24oKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TZXNzaW9uI29wZW5CYXNpY0NoYW5uZWwoYnl0ZVtdLCBieXRlKX0sCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5DaGFubmVsI3RyYW5zbWl0KGJ5dGVbXSl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIGJ5dGVbXSBpY2NFeGNoYW5nZVNpbUlPKGludCBzdWJJZCwgaW50IGZpbGVJRCwgaW50IGNvbW1hbmQsIGludCBwMSwgaW50IHAyLAogICAgICAgICAgICBpbnQgcDMsIFN0cmluZyBmaWxlUGF0aCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmljY0V4Y2hhbmdlU2ltSU8oc3ViSWQsIGZpbGVJRCwgY29tbWFuZCwgcDEsIHAyLCBwMywgZmlsZVBhdGgpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBFTlZFTE9QRSB0byB0aGUgU0lNIGFuZCByZXR1cm4gdGhlIHJlc3BvbnNlLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBjb250ZW50IFN0cmluZyBjb250YWluaW5nIFNBVC9VU0FUIHJlc3BvbnNlIGluIGhleGFkZWNpbWFsCiAgICAgKiAgICAgICAgICAgICAgICBmb3JtYXQgc3RhcnRpbmcgd2l0aCBjb21tYW5kIHRhZy4gU2VlIFRTIDEwMiAyMjMgZm9yCiAgICAgKiAgICAgICAgICAgICAgICBkZXRhaWxzLgogICAgICogQHJldHVybiBUaGUgQVBEVSByZXNwb25zZSBmcm9tIHRoZSBJQ0MgY2FyZCBpbiBoZXhhZGVjaW1hbCBmb3JtYXQKICAgICAqICAgICAgICAgd2l0aCB0aGUgbGFzdCA0IGJ5dGVzIGJlaW5nIHRoZSBzdGF0dXMgd29yZC4gSWYgdGhlIGNvbW1hbmQgZmFpbHMsCiAgICAgKiAgICAgICAgIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZX0gQVBJcyBpbnN0ZWFkLiBTZWUKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNFU2VydmljZSNnZXRVaWNjUmVhZGVyKGludCl9LAogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuUmVhZGVyI29wZW5TZXNzaW9uKCl9LAogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuU2Vzc2lvbiNvcGVuQmFzaWNDaGFubmVsKGJ5dGVbXSwgYnl0ZSl9LAogICAgICogICAgICAgICAgICAge0BsaW5rIGFuZHJvaWQuc2Uub21hcGkuQ2hhbm5lbCN0cmFuc21pdChieXRlW10pfS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBTdHJpbmcgc2VuZEVudmVsb3BlV2l0aFN0YXR1cyhTdHJpbmcgY29udGVudCkgewogICAgICAgIHJldHVybiBzZW5kRW52ZWxvcGVXaXRoU3RhdHVzKGdldFN1YklkKCksIGNvbnRlbnQpOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBFTlZFTE9QRSB0byB0aGUgU0lNIGFuZCByZXR1cm4gdGhlIHJlc3BvbnNlLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIHRvIHVzZS4KICAgICAqIEBwYXJhbSBjb250ZW50IFN0cmluZyBjb250YWluaW5nIFNBVC9VU0FUIHJlc3BvbnNlIGluIGhleGFkZWNpbWFsCiAgICAgKiAgICAgICAgICAgICAgICBmb3JtYXQgc3RhcnRpbmcgd2l0aCBjb21tYW5kIHRhZy4gU2VlIFRTIDEwMiAyMjMgZm9yCiAgICAgKiAgICAgICAgICAgICAgICBkZXRhaWxzLgogICAgICogQHJldHVybiBUaGUgQVBEVSByZXNwb25zZSBmcm9tIHRoZSBJQ0MgY2FyZCBpbiBoZXhhZGVjaW1hbCBmb3JtYXQKICAgICAqICAgICAgICAgd2l0aCB0aGUgbGFzdCA0IGJ5dGVzIGJlaW5nIHRoZSBzdGF0dXMgd29yZC4gSWYgdGhlIGNvbW1hbmQgZmFpbHMsCiAgICAgKiAgICAgICAgIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLgogICAgICogQGhpZGUKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2V9IEFQSXMgaW5zdGVhZC4gU2VlCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5zZS5vbWFwaS5TRVNlcnZpY2UjZ2V0VWljY1JlYWRlcihpbnQpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlJlYWRlciNvcGVuU2Vzc2lvbigpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLlNlc3Npb24jb3BlbkJhc2ljQ2hhbm5lbChieXRlW10sIGJ5dGUpfSwKICAgICAqICAgICAgICAgICAgIHtAbGluayBhbmRyb2lkLnNlLm9tYXBpLkNoYW5uZWwjdHJhbnNtaXQoYnl0ZVtdKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgU3RyaW5nIHNlbmRFbnZlbG9wZVdpdGhTdGF0dXMoaW50IHN1YklkLCBTdHJpbmcgY29udGVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNlbmRFbnZlbG9wZVdpdGhTdGF0dXMoc3ViSWQsIGNvbnRlbnQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvKioKICAgICAqIFJlYWQgb25lIG9mIHRoZSBOViBpdGVtcyBkZWZpbmVkIGluIGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5SYWRpb05WSXRlbXMuCiAgICAgKiBVc2VkIGZvciBkZXZpY2UgY29uZmlndXJhdGlvbiBieSBzb21lIENETUEgb3BlcmF0b3JzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBpdGVtSUQgdGhlIElEIG9mIHRoZSBpdGVtIHRvIHJlYWQuCiAgICAgKiBAcmV0dXJuIHRoZSBOViBpdGVtIGFzIGEgU3RyaW5nLCBvciBudWxsIG9uIGFueSBmYWlsdXJlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3RyaW5nIG52UmVhZEl0ZW0oaW50IGl0ZW1JRCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255Lm52UmVhZEl0ZW0oaXRlbUlEKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgIm52UmVhZEl0ZW0gUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJudlJlYWRJdGVtIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICIiOwogICAgfQoKICAgIC8qKgogICAgICogV3JpdGUgb25lIG9mIHRoZSBOViBpdGVtcyBkZWZpbmVkIGluIGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5SYWRpb05WSXRlbXMuCiAgICAgKiBVc2VkIGZvciBkZXZpY2UgY29uZmlndXJhdGlvbiBieSBzb21lIENETUEgb3BlcmF0b3JzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBpdGVtSUQgdGhlIElEIG9mIHRoZSBpdGVtIHRvIHJlYWQuCiAgICAgKiBAcGFyYW0gaXRlbVZhbHVlIHRoZSB2YWx1ZSB0byB3cml0ZSwgYXMgYSBTdHJpbmcuCiAgICAgKiBAcmV0dXJuIHRydWUgb24gc3VjY2VzczsgZmFsc2Ugb24gYW55IGZhaWx1cmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gbnZXcml0ZUl0ZW0oaW50IGl0ZW1JRCwgU3RyaW5nIGl0ZW1WYWx1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255Lm52V3JpdGVJdGVtKGl0ZW1JRCwgaXRlbVZhbHVlKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgIm52V3JpdGVJdGVtIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAibnZXcml0ZUl0ZW0gTlBFIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIENETUEgUHJlZmVycmVkIFJvYW1pbmcgTGlzdCAoUFJMKSBpbiB0aGUgcmFkaW8gTlYgc3RvcmFnZS4KICAgICAqIFVzZWQgZm9yIGRldmljZSBjb25maWd1cmF0aW9uIGJ5IHNvbWUgQ0RNQSBvcGVyYXRvcnMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHByZWZlcnJlZFJvYW1pbmdMaXN0IGJ5dGUgYXJyYXkgY29udGFpbmluZyB0aGUgbmV3IFBSTC4KICAgICAqIEByZXR1cm4gdHJ1ZSBvbiBzdWNjZXNzOyBmYWxzZSBvbiBhbnkgZmFpbHVyZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBudldyaXRlQ2RtYVBybChieXRlW10gcHJlZmVycmVkUm9hbWluZ0xpc3QpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5udldyaXRlQ2RtYVBybChwcmVmZXJyZWRSb2FtaW5nTGlzdCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJudldyaXRlQ2RtYVBybCBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgIm52V3JpdGVDZG1hUHJsIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUGVyZm9ybSB0aGUgc3BlY2lmaWVkIHR5cGUgb2YgTlYgY29uZmlnIHJlc2V0LiBUaGUgcmFkaW8gd2lsbCBiZSB0YWtlbiBvZmZsaW5lCiAgICAgKiBhbmQgdGhlIGRldmljZSBtdXN0IGJlIHJlYm9vdGVkIGFmdGVyIHRoZSBvcGVyYXRpb24uIFVzZWQgZm9yIGRldmljZQogICAgICogY29uZmlndXJhdGlvbiBieSBzb21lIENETUEgb3BlcmF0b3JzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIFRPRE86IHJlbW92ZSB0aGlzIG9uZS4gdXNlIHtAbGluayAjcmVib290UmFkaW8oKX0gZm9yIHJlc2V0IHR5cGUgMSBhbmQKICAgICAqIHtAbGluayAjcmVzZXRSYWRpb0NvbmZpZygpfSBmb3IgcmVzZXQgdHlwZSAzCiAgICAgKgogICAgICogQHBhcmFtIHJlc2V0VHlwZSByZXNldCB0eXBlOiAxOiByZWxvYWQgTlYgcmVzZXQsIDI6IGVyYXNlIE5WIHJlc2V0LCAzOiBmYWN0b3J5IE5WIHJlc2V0CiAgICAgKiBAcmV0dXJuIHRydWUgb24gc3VjY2VzczsgZmFsc2Ugb24gYW55IGZhaWx1cmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBib29sZWFuIG52UmVzZXRDb25maWcoaW50IHJlc2V0VHlwZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChyZXNldFR5cGUgPT0gMSAvKjE6IHJlbG9hZCBOViByZXNldCAqLykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkucmVib290TW9kZW0oZ2V0U2xvdEluZGV4KCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNldFR5cGUgPT0gMyAvKjM6IGZhY3RvcnkgTlYgcmVzZXQgKi8pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnJlc2V0TW9kZW1Db25maWcoZ2V0U2xvdEluZGV4KCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBSbG9nLmUoVEFHLCAibnZSZXNldENvbmZpZyB1bnN1cHBvcnRlZCByZXNldCB0eXBlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgIm52UmVzZXRDb25maWcgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJudlJlc2V0Q29uZmlnIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUm9sbGJhY2sgbW9kZW0gY29uZmlndXJhdGlvbnMgdG8gZmFjdG9yeSBkZWZhdWx0IGV4Y2VwdCBzb21lIGNvbmZpZyB3aGljaCBhcmUgaW4gd2hpdGVsaXN0LgogICAgICogVXNlZCBmb3IgZGV2aWNlIGNvbmZpZ3VyYXRpb24gYnkgc29tZSBjYXJyaWVycy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBvbiBzdWNjZXNzOyB7QGNvZGUgZmFsc2V9IG9uIGFueSBmYWlsdXJlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiByZXNldFJhZGlvQ29uZmlnKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkucmVzZXRNb2RlbUNvbmZpZyhnZXRTbG90SW5kZXgoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInJlc2V0UmFkaW9Db25maWcgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJyZXNldFJhZGlvQ29uZmlnIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogR2VuZXJhdGUgYSByYWRpbyBtb2RlbSByZXNldC4gVXNlZCBmb3IgZGV2aWNlIGNvbmZpZ3VyYXRpb24gYnkgc29tZSBjYXJyaWVycy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBvbiBzdWNjZXNzOyB7QGNvZGUgZmFsc2V9IG9uIGFueSBmYWlsdXJlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiByZWJvb3RSYWRpbygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnJlYm9vdE1vZGVtKGdldFNsb3RJbmRleCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAicmVib290UmFkaW8gUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJyZWJvb3RSYWRpbyBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhbiBhcHByb3ByaWF0ZSBzdWJzY3JpcHRpb24gSUQgZm9yIGFueSBzaXR1YXRpb24uCiAgICAgKgogICAgICogSWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCB0aGVuIHRoZSBwcm92aWRlZAogICAgICogc3Vic2NyaXB0aW9uIElEIGlzIHJldHVybmVkLiBPdGhlcndpc2UsIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbiBJRCB3aWxsIGJlIHJldHVybmVkLgogICAgICoKICAgICAqLwogICAgcHVibGljIGludCBnZXRTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gZ2V0U3ViSWQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhbiBhcHByb3ByaWF0ZSBzdWJzY3JpcHRpb24gSUQgZm9yIGFueSBzaXR1YXRpb24uCiAgICAgKgogICAgICogSWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCB0aGVuIHRoZSBwcm92aWRlZAogICAgICogc3Vic2NyaXB0aW9uIElEIGlzIHJldHVybmVkLiBPdGhlcndpc2UsIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbiBJRCB3aWxsIGJlIHJldHVybmVkLgogICAgICoKICAgICAqLwogICAgcHJpdmF0ZSBpbnQgZ2V0U3ViSWQoKSB7CiAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVXNhYmxlU3ViSWRWYWx1ZShtU3ViSWQpKSB7CiAgICAgICAgcmV0dXJuIG1TdWJJZDsKICAgICAgfQogICAgICByZXR1cm4gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhbiBhcHByb3ByaWF0ZSBzdWJzY3JpcHRpb24gSUQgZm9yIGFueSBzaXR1YXRpb24uCiAgICAgKgogICAgICogSWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCB0aGVuIHRoZSBwcm92aWRlZAogICAgICogc3ViSWQgaXMgcmV0dXJuZWQuIE90aGVyd2lzZSwgdGhlIHByZWZlcnJlZCBzdWJJZCB3aGljaCBpcyBiYXNlZCBvbiBjYWxsZXIncyBjb250ZXh0IGlzCiAgICAgKiByZXR1cm5lZC4KICAgICAqIHtAc2VlIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICoge0BzZWUgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpfQogICAgICoge0BzZWUgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHByaXZhdGUgaW50IGdldFN1YklkKGludCBwcmVmZXJyZWRTdWJJZCkgewogICAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVXNhYmxlU3ViSWRWYWx1ZShtU3ViSWQpKSB7CiAgICAgICAgICAgIHJldHVybiBtU3ViSWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcmVmZXJyZWRTdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhbiBhcHByb3ByaWF0ZSBwaG9uZSBJRCBmb3IgYW55IHNpdHVhdGlvbi4KICAgICAqCiAgICAgKiBJZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIHRoZW4gdGhlIHBob25lSWQKICAgICAqIGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvdmlkZWQgc3ViSWQgaXMgcmV0dXJuZWQuIE90aGVyd2lzZSwgdGhlIGRlZmF1bHQgcGhvbmVJZCBhc3NvY2lhdGVkCiAgICAgKiB3aXRoIHRoZSBkZWZhdWx0IHN1YklkIHdpbGwgYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIHByaXZhdGUgaW50IGdldFBob25lSWQoKSB7CiAgICAgICAgcmV0dXJuIFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0UGhvbmVJZChnZXRTdWJJZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBhbiBhcHByb3ByaWF0ZSBwaG9uZSBJRCBmb3IgYW55IHNpdHVhdGlvbi4KICAgICAqCiAgICAgKiBJZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIHRoZW4gdGhlIHBob25lSWQKICAgICAqIGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvdmlkZWQgc3ViSWQgaXMgcmV0dXJuZWQuIE90aGVyd2lzZSwgcmV0dXJuIHRoZSBwaG9uZUlkIGFzc29jaWF0ZWQKICAgICAqIHdpdGggdGhlIHByZWZlcnJlZCBzdWJJZCBiYXNlZCBvbiBjYWxsZXIncyBjb250ZXh0LgogICAgICoge0BzZWUgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCl9CiAgICAgKiB7QHNlZSBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCl9CiAgICAgKiB7QHNlZSBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpfQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHJpdmF0ZSBpbnQgZ2V0UGhvbmVJZChpbnQgcHJlZmVycmVkU3ViSWQpIHsKICAgICAgICByZXR1cm4gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRQaG9uZUlkKGdldFN1YklkKHByZWZlcnJlZFN1YklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYW4gYXBwcm9wcmlhdGUgc2xvdCBpbmRleCBmb3IgYW55IHNpdHVhdGlvbi4KICAgICAqCiAgICAgKiBpZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIHRoZW4gdGhlIHNsb3QgaW5kZXgKICAgICAqIGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvdmlkZWQgc3ViSWQgaXMgcmV0dXJuZWQuIE90aGVyd2lzZSwgcmV0dXJuIHRoZSBzbG90IGluZGV4IGFzc29jaWF0ZWQKICAgICAqIHdpdGggdGhlIGRlZmF1bHQgc3ViSWQuCiAgICAgKiBJZiBTSU0gaXMgbm90IGluc2VydGVkLCByZXR1cm4gZGVmYXVsdCBTSU0gc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiB7QGhpZGV9CiAgICAgKi8KICAgIEBWaXNpYmxlRm9yVGVzdGluZwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBpbnQgZ2V0U2xvdEluZGV4KCkgewogICAgICAgIGludCBzbG90SW5kZXggPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmdldFNsb3RJbmRleChnZXRTdWJJZCgpKTsKICAgICAgICBpZiAoc2xvdEluZGV4ID09IFN1YnNjcmlwdGlvbk1hbmFnZXIuU0lNX05PVF9JTlNFUlRFRCkgewogICAgICAgICAgICBzbG90SW5kZXggPSBTdWJzY3JpcHRpb25NYW5hZ2VyLkRFRkFVTFRfU0lNX1NMT1RfSU5ERVg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzbG90SW5kZXg7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IHRoYXQgdGhlIG5leHQgaW5jb21pbmcgY2FsbCBmcm9tIGEgbnVtYmVyIG1hdGNoaW5nIHtAY29kZSByYW5nZX0gYmUgaW50ZXJjZXB0ZWQuCiAgICAgKgogICAgICogVGhpcyBBUEkgaXMgaW50ZW5kZWQgZm9yIE9FTXMgdG8gcHJvdmlkZSBhIHNlcnZpY2UgZm9yIGFwcHMgdG8gdmVyaWZ5IHRoZSBkZXZpY2UncyBwaG9uZQogICAgICogbnVtYmVyLiBXaGVuIGNhbGxlZCwgdGhlIFRlbGVwaG9ueSBzdGFjayB3aWxsIHN0b3JlIHRoZSBwcm92aWRlZCB7QGxpbmsgUGhvbmVOdW1iZXJSYW5nZX0gYW5kCiAgICAgKiBpbnRlcmNlcHQgdGhlIG5leHQgaW5jb21pbmcgY2FsbCBmcm9tIGEgbnVtYmVyIHRoYXQgbGllcyB3aXRoaW4gdGhlIHJhbmdlLCB3aXRoaW4gYSB0aW1lb3V0CiAgICAgKiBzcGVjaWZpZWQgYnkge0Bjb2RlIHRpbWVvdXRNaWxsaXN9LgogICAgICoKICAgICAqIElmIHN1Y2ggYSBwaG9uZSBjYWxsIGlzIHJlY2VpdmVkLCB0aGUgY2FsbGVyIHdpbGwgYmUgbm90aWZpZWQgdmlhCiAgICAgKiB7QGxpbmsgTnVtYmVyVmVyaWZpY2F0aW9uQ2FsbGJhY2sjb25DYWxsUmVjZWl2ZWQoU3RyaW5nKX0gb24gdGhlIHByb3ZpZGVkIHtAbGluayBFeGVjdXRvcn0uCiAgICAgKiBJZiB2ZXJpZmljYXRpb24gZmFpbHMgZm9yIGFueSByZWFzb24sIHRoZSBjYWxsZXIgd2lsbCBiZSBub3RpZmllZCB2aWEKICAgICAqIHtAbGluayBOdW1iZXJWZXJpZmljYXRpb25DYWxsYmFjayNvblZlcmlmaWNhdGlvbkZhaWxlZChpbnQpfQogICAgICogb24gdGhlIHByb3ZpZGVkIHtAbGluayBFeGVjdXRvcn0uCiAgICAgKgogICAgICogSW4gYWRkaXRpb24gdG8gdGhlIHtAbGluayBNYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0gcGVybWlzc2lvbiwgY2FsbGVycyBvZiB0aGlzCiAgICAgKiBBUEkgbXVzdCBhbHNvIGJlIGxpc3RlZCBpbiB0aGUgZGV2aWNlIGNvbmZpZ3VyYXRpb24gYXMgYW4gYXV0aG9yaXplZCBhcHAgaW4KICAgICAqIHtAY29kZSBwYWNrYWdlcy9zZXJ2aWNlcy9UZWxlcGhvbnkvcmVzL3ZhbHVlcy9jb25maWcueG1sfSB1bmRlciB0aGUKICAgICAqIHtAY29kZSBjb25maWdfbnVtYmVyX3ZlcmlmaWNhdGlvbl9wYWNrYWdlX25hbWV9IGtleS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICogQHBhcmFtIHJhbmdlIFRoZSByYW5nZSBvZiBwaG9uZSBudW1iZXJzIHRoZSBjYWxsZXIgZXhwZWN0cyBhIHBob25lIGNhbGwgZnJvbS4KICAgICAqIEBwYXJhbSB0aW1lb3V0TWlsbGlzIFRoZSBhbW91bnQgb2YgdGltZSB0byB3YWl0IGZvciBzdWNoIGEgY2FsbCwgb3IgdGhlIHZhbHVlIG9mCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgI2dldE1heE51bWJlclZlcmlmaWNhdGlvblRpbWVvdXRNaWxsaXMoKX0sIHdoaWNoZXZlciBpcyBsZXNzZXIuCiAgICAgKiBAcGFyYW0gZXhlY3V0b3IgVGhlIHtAbGluayBFeGVjdXRvcn0gdGhhdCBjYWxsYmFja3Mgc2hvdWxkIGJlIGV4ZWN1dGVkIG9uLgogICAgICogQHBhcmFtIGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byB1c2UgZm9yIGRlbGl2ZXJpbmcgcmVzdWx0cy4KICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3ROdW1iZXJWZXJpZmljYXRpb24oQE5vbk51bGwgUGhvbmVOdW1iZXJSYW5nZSByYW5nZSwgbG9uZyB0aW1lb3V0TWlsbGlzLAogICAgICAgICAgICBATm9uTnVsbCBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE5vbk51bGwgTnVtYmVyVmVyaWZpY2F0aW9uQ2FsbGJhY2sgY2FsbGJhY2spIHsKICAgICAgICBpZiAoZXhlY3V0b3IgPT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oIkV4ZWN1dG9yIG11c3QgYmUgbm9uLW51bGwiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNhbGxiYWNrID09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCJDYWxsYmFjayBtdXN0IGJlIG5vbi1udWxsIik7CiAgICAgICAgfQoKICAgICAgICBJTnVtYmVyVmVyaWZpY2F0aW9uQ2FsbGJhY2sgaW50ZXJuYWxDYWxsYmFjayA9IG5ldyBJTnVtYmVyVmVyaWZpY2F0aW9uQ2FsbGJhY2suU3R1YigpIHsKICAgICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uQ2FsbFJlY2VpdmVkKFN0cmluZyBwaG9uZU51bWJlcikgewogICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5vbkNhbGxSZWNlaXZlZChwaG9uZU51bWJlcikpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICBwdWJsaWMgdm9pZCBvblZlcmlmaWNhdGlvbkZhaWxlZChpbnQgcmVhc29uKSB7CiAgICAgICAgICAgICAgICBmaW5hbCBsb25nIGlkZW50aXR5ID0gQmluZGVyLmNsZWFyQ2FsbGluZ0lkZW50aXR5KCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLm9uVmVyaWZpY2F0aW9uRmFpbGVkKHJlYXNvbikpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkucmVxdWVzdE51bWJlclZlcmlmaWNhdGlvbihyYW5nZSwgdGltZW91dE1pbGxpcywgaW50ZXJuYWxDYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAicmVxdWVzdE51bWJlclZlcmlmaWNhdGlvbiBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4KICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5vblZlcmlmaWNhdGlvbkZhaWxlZChOdW1iZXJWZXJpZmljYXRpb25DYWxsYmFjay5SRUFTT05fVU5TUEVDSUZJRUQpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnNlcnRzIG9yIHVwZGF0ZXMgYSBsaXN0IHByb3BlcnR5LiBFeHBhbmRzIHRoZSBsaXN0IGlmIGl0cyBsZW5ndGggaXMgbm90IGVub3VnaC4KICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgPFQ+IExpc3Q8VD4gdXBkYXRlVGVsZXBob255UHJvcGVydHkoTGlzdDxUPiBwcm9wLCBpbnQgcGhvbmVJZCwgVCB2YWx1ZSkgewogICAgICAgIExpc3Q8VD4gcmV0ID0gbmV3IEFycmF5TGlzdDw+KHByb3ApOwogICAgICAgIHdoaWxlIChyZXQuc2l6ZSgpIDw9IHBob25lSWQpIHJldC5hZGQobnVsbCk7CiAgICAgICAgcmV0LnNldChwaG9uZUlkLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVuaWVuY2UgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgYSB2YWx1ZSBmcm9tIHRoZSBzZWN1cmUgc2V0dGluZ3MKICAgICAqIHZhbHVlIGxpc3QgYXMgYW4gaW50ZWdlci4gIE5vdGUgdGhhdCBpbnRlcm5hbGx5IHNldHRpbmcgdmFsdWVzIGFyZQogICAgICogYWx3YXlzIHN0b3JlZCBhcyBzdHJpbmdzOyB0aGlzIGZ1bmN0aW9uIGNvbnZlcnRzIHRoZSBzdHJpbmcgdG8gYW4KICAgICAqIGludGVnZXIgZm9yIHlvdS4KICAgICAqIDxwPgogICAgICogVGhpcyB2ZXJzaW9uIGRvZXMgbm90IHRha2UgYSBkZWZhdWx0IHZhbHVlLiAgSWYgdGhlIHNldHRpbmcgaGFzIG5vdAogICAgICogYmVlbiBzZXQsIG9yIHRoZSBzdHJpbmcgdmFsdWUgaXMgbm90IGEgbnVtYmVyLAogICAgICogaXQgdGhyb3dzIHtAbGluayBTZXR0aW5nTm90Rm91bmRFeGNlcHRpb259LgogICAgICoKICAgICAqIEBwYXJhbSBjciBUaGUgQ29udGVudFJlc29sdmVyIHRvIGFjY2Vzcy4KICAgICAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzZXR0aW5nIHRvIHJldHJpZXZlLgogICAgICogQHBhcmFtIGluZGV4IFRoZSBpbmRleCBvZiB0aGUgbGlzdAogICAgICoKICAgICAqIEB0aHJvd3MgU2V0dGluZ05vdEZvdW5kRXhjZXB0aW9uIFRocm93biBpZiBhIHNldHRpbmcgYnkgdGhlIGdpdmVuCiAgICAgKiBuYW1lIGNhbid0IGJlIGZvdW5kIG9yIHRoZSBzZXR0aW5nIHZhbHVlIGlzIG5vdCBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqIEByZXR1cm4gVGhlIHZhbHVlIGF0IHRoZSBnaXZlbiBpbmRleCBvZiBzZXR0aW5ncy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRJbnRBdEluZGV4KGFuZHJvaWQuY29udGVudC5Db250ZW50UmVzb2x2ZXIgY3IsCiAgICAgICAgICAgIFN0cmluZyBuYW1lLCBpbnQgaW5kZXgpCiAgICAgICAgICAgIHRocm93cyBhbmRyb2lkLnByb3ZpZGVyLlNldHRpbmdzLlNldHRpbmdOb3RGb3VuZEV4Y2VwdGlvbiB7CiAgICAgICAgU3RyaW5nIHYgPSBhbmRyb2lkLnByb3ZpZGVyLlNldHRpbmdzLkdsb2JhbC5nZXRTdHJpbmcoY3IsIG5hbWUpOwogICAgICAgIGlmICh2ICE9IG51bGwpIHsKICAgICAgICAgICAgU3RyaW5nIHZhbEFycmF5W10gPSB2LnNwbGl0KCIsIik7CiAgICAgICAgICAgIGlmICgoaW5kZXggPj0gMCkgJiYgKGluZGV4IDwgdmFsQXJyYXkubGVuZ3RoKSAmJiAodmFsQXJyYXlbaW5kZXhdICE9IG51bGwpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBJbnRlZ2VyLnBhcnNlSW50KHZhbEFycmF5W2luZGV4XSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChOdW1iZXJGb3JtYXRFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgICAgIC8vTG9nLmUoVEFHLCAiRXhjZXB0aW9uIHdoaWxlIHBhcnNpbmcgSW50ZWdlcjogIiwgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IGFuZHJvaWQucHJvdmlkZXIuU2V0dGluZ3MuU2V0dGluZ05vdEZvdW5kRXhjZXB0aW9uKG5hbWUpOwogICAgfQoKICAgIC8qKgogICAgICogQ29udmVuaWVuY2UgZnVuY3Rpb24gZm9yIHVwZGF0aW5nIHNldHRpbmdzIHZhbHVlIGFzIGNvbWEgc2VwYXJhdGVkCiAgICAgKiBpbnRlZ2VyIHZhbHVlcy4gVGhpcyB3aWxsIGVpdGhlciBjcmVhdGUgYSBuZXcgZW50cnkgaW4gdGhlIHRhYmxlIGlmIHRoZQogICAgICogZ2l2ZW4gbmFtZSBkb2VzIG5vdCBleGlzdCwgb3IgbW9kaWZ5IHRoZSB2YWx1ZSBvZiB0aGUgZXhpc3Rpbmcgcm93CiAgICAgKiB3aXRoIHRoYXQgbmFtZS4gIE5vdGUgdGhhdCBpbnRlcm5hbGx5IHNldHRpbmcgdmFsdWVzIGFyZSBhbHdheXMKICAgICAqIHN0b3JlZCBhcyBzdHJpbmdzLCBzbyB0aGlzIGZ1bmN0aW9uIGNvbnZlcnRzIHRoZSBnaXZlbiB2YWx1ZSB0byBhCiAgICAgKiBzdHJpbmcgYmVmb3JlIHN0b3JpbmcgaXQuCiAgICAgKgogICAgICogQHBhcmFtIGNyIFRoZSBDb250ZW50UmVzb2x2ZXIgdG8gYWNjZXNzLgogICAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNldHRpbmcgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIGluZGV4IFRoZSBpbmRleCBvZiB0aGUgbGlzdAogICAgICogQHBhcmFtIHZhbHVlIFRoZSBuZXcgdmFsdWUgZm9yIHRoZSBzZXR0aW5nIHRvIGJlIGFkZGVkIHRvIHRoZSBsaXN0LgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSB2YWx1ZSB3YXMgc2V0LCBmYWxzZSBvbiBkYXRhYmFzZSBlcnJvcnMKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGJvb2xlYW4gcHV0SW50QXRJbmRleChhbmRyb2lkLmNvbnRlbnQuQ29udGVudFJlc29sdmVyIGNyLAogICAgICAgICAgICBTdHJpbmcgbmFtZSwgaW50IGluZGV4LCBpbnQgdmFsdWUpIHsKICAgICAgICBTdHJpbmcgZGF0YSA9ICIiOwogICAgICAgIFN0cmluZyB2YWxBcnJheVtdID0gbnVsbDsKICAgICAgICBTdHJpbmcgdiA9IGFuZHJvaWQucHJvdmlkZXIuU2V0dGluZ3MuR2xvYmFsLmdldFN0cmluZyhjciwgbmFtZSk7CgogICAgICAgIGlmIChpbmRleCA9PSBJbnRlZ2VyLk1BWF9WQUxVRSkgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJwdXRJbnRBdEluZGV4IGluZGV4ID09IE1BWF9WQUxVRSBpbmRleD0iICsgaW5kZXgpOwogICAgICAgIH0KICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oInB1dEludEF0SW5kZXggaW5kZXggPCAwIGluZGV4PSIgKyBpbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmICh2ICE9IG51bGwpIHsKICAgICAgICAgICAgdmFsQXJyYXkgPSB2LnNwbGl0KCIsIik7CiAgICAgICAgfQoKICAgICAgICAvLyBDb3B5IHRoZSBlbGVtZW50cyBmcm9tIHZhbEFycmF5IHRpbGwgaW5kZXgKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGluZGV4OyBpKyspIHsKICAgICAgICAgICAgU3RyaW5nIHN0ciA9ICIiOwogICAgICAgICAgICBpZiAoKHZhbEFycmF5ICE9IG51bGwpICYmIChpIDwgdmFsQXJyYXkubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgc3RyID0gdmFsQXJyYXlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YSA9IGRhdGEgKyBzdHIgKyAiLCI7CiAgICAgICAgfQoKICAgICAgICBkYXRhID0gZGF0YSArIHZhbHVlOwoKICAgICAgICAvLyBDb3B5IHRoZSByZW1haW5pbmcgZWxlbWVudHMgZnJvbSB2YWxBcnJheSBpZiBhbnkuCiAgICAgICAgaWYgKHZhbEFycmF5ICE9IG51bGwpIHsKICAgICAgICAgICAgZm9yIChpbnQgaSA9IGluZGV4KzE7IGkgPCB2YWxBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEgKyAiLCIgKyB2YWxBcnJheVtpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYW5kcm9pZC5wcm92aWRlci5TZXR0aW5ncy5HbG9iYWwucHV0U3RyaW5nKGNyLCBuYW1lLCBkYXRhKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgYSBwZXItcGhvbmUgdGVsZXBob255IHByb3BlcnR5IGZyb20gYSBwcm9wZXJ0eSBuYW1lLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIFN0cmluZyBnZXRUZWxlcGhvbnlQcm9wZXJ0eShpbnQgcGhvbmVJZCwgU3RyaW5nIHByb3BlcnR5LCBTdHJpbmcgZGVmYXVsdFZhbCkgewogICAgICAgIFN0cmluZyBwcm9wVmFsID0gbnVsbDsKICAgICAgICBTdHJpbmcgcHJvcCA9IFN5c3RlbVByb3BlcnRpZXMuZ2V0KHByb3BlcnR5KTsKICAgICAgICBpZiAoKHByb3AgIT0gbnVsbCkgJiYgKHByb3AubGVuZ3RoKCkgPiAwKSkgewogICAgICAgICAgICBTdHJpbmcgdmFsdWVzW10gPSBwcm9wLnNwbGl0KCIsIik7CiAgICAgICAgICAgIGlmICgocGhvbmVJZCA+PSAwKSAmJiAocGhvbmVJZCA8IHZhbHVlcy5sZW5ndGgpICYmICh2YWx1ZXNbcGhvbmVJZF0gIT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgIHByb3BWYWwgPSB2YWx1ZXNbcGhvbmVJZF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb3BWYWwgPT0gbnVsbCA/IGRlZmF1bHRWYWwgOiBwcm9wVmFsOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhIHR5cGVkIHBlci1waG9uZSB0ZWxlcGhvbnkgcHJvcGVydHkgZnJvbSBhIHNjaGVtYXRpemVkIGxpc3QgcHJvcGVydHkuCiAgICAgKi8KICAgIHByaXZhdGUgc3RhdGljIDxUPiBUIGdldFRlbGVwaG9ueVByb3BlcnR5KGludCBwaG9uZUlkLCBMaXN0PFQ+IHByb3AsIFQgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgVCByZXQgPSBudWxsOwogICAgICAgIGlmIChwaG9uZUlkID49IDAgJiYgcGhvbmVJZCA8IHByb3Auc2l6ZSgpKSByZXQgPSBwcm9wLmdldChwaG9uZUlkKTsKICAgICAgICByZXR1cm4gcmV0ICE9IG51bGwgPyByZXQgOiBkZWZhdWx0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIGEgZ2xvYmFsIHRlbGVwaG9ueSBwcm9wZXJ0eS4KICAgICAqCiAgICAgKiBTZWUgYWxzbyBnZXRUZWxlcGhvbnlQcm9wZXJ0eShwaG9uZUlkLCBwcm9wZXJ0eSwgZGVmYXVsdFZhbCkuIE1vc3QgdGVsZXBob255IHByb3BlcnRpZXMgYXJlCiAgICAgKiBwZXItcGhvbmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBzdGF0aWMgU3RyaW5nIGdldFRlbGVwaG9ueVByb3BlcnR5KFN0cmluZyBwcm9wZXJ0eSwgU3RyaW5nIGRlZmF1bHRWYWwpIHsKICAgICAgICBTdHJpbmcgcHJvcFZhbCA9IFN5c3RlbVByb3BlcnRpZXMuZ2V0KHByb3BlcnR5KTsKICAgICAgICByZXR1cm4gVGV4dFV0aWxzLmlzRW1wdHkocHJvcFZhbCkgPyBkZWZhdWx0VmFsIDogcHJvcFZhbDsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IGdldFNpbUNvdW50KCkgewogICAgICAgIC8vIEZJWE1FIE5lZWQgdG8gZ2V0IGl0IGZyb20gVGVsZXBob255IERldiBDb250cm9sbGVyIHdoZW4gdGhhdCBnZXRzIGltcGxlbWVudGVkIQogICAgICAgIC8vIGFuZCB0aGVuIHRoaXMgbWV0aG9kIHNob3VsZG4ndCBiZSB1c2VkIGF0IGFsbCEKICAgICAgICByZXR1cm4gZ2V0UGhvbmVDb3VudCgpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgSU1TIFNlcnZpY2UgVGFibGUgKElTVCkgdGhhdCB3YXMgbG9hZGVkIGZyb20gdGhlIElTSU0uCiAgICAgKgogICAgICogU2VlIDNHUFAgVFMgMzEuMTAzIChTZWN0aW9uIDQuMi43KSBmb3IgdGhlIGRlZmluaXRpb24gYW5kIG1vcmUgaW5mb3JtYXRpb24gb24gdGhpcyB0YWJsZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIElNUyBTZXJ2aWNlIFRhYmxlIG9yIG51bGwgaWYgbm90IHByZXNlbnQgb3Igbm90IGxvYWRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQE51bGxhYmxlCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN0cmluZyBnZXRJc2ltSXN0KCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIC8vZ2V0IHRoZSBJc2ltIElzdCBiYXNlZCBvbiBzdWJJZAogICAgICAgICAgICByZXR1cm4gaW5mby5nZXRJc2ltSXN0KGdldFN1YklkKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElNUyBQcm94eSBDYWxsIFNlc3Npb24gQ29udHJvbCBGdW5jdGlvbihQQ1NDRikgdGhhdCB3ZXJlIGxvYWRlZCBmcm9tIHRoZSBJU0lNLgogICAgICogQHJldHVybiBhbiBhcnJheSBvZiBQQ1NDRiBzdHJpbmdzIHdpdGggb25lIFBDU0NGIHBlciBzdHJpbmcsIG9yIG51bGwgaWYKICAgICAqICAgICAgICAgbm90IHByZXNlbnQgb3Igbm90IGxvYWRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdHJpbmdbXSBnZXRJc2ltUGNzY2YoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVBob25lU3ViSW5mbyBpbmZvID0gZ2V0U3Vic2NyaWJlckluZm9TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpbmZvID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgLy9nZXQgdGhlIElzaW0gUGNzY2YgYmFzZWQgb24gc3ViSWQKICAgICAgICAgICAgcmV0dXJuIGluZm8uZ2V0SXNpbVBjc2NmKGdldFN1YklkKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgcmVzdGFydHMgZHVlIHRvIGNyYXNoaW5nCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKiogVUlDQyBhcHBsaWNhdGlvbiB0eXBlIGlzIFNJTSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQVBQVFlQRV9TSU0gPSBQaG9uZUNvbnN0YW50cy5BUFBUWVBFX1NJTTsKICAgIC8qKiBVSUNDIGFwcGxpY2F0aW9uIHR5cGUgaXMgVVNJTSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQVBQVFlQRV9VU0lNID0gUGhvbmVDb25zdGFudHMuQVBQVFlQRV9VU0lNOwogICAgLyoqIFVJQ0MgYXBwbGljYXRpb24gdHlwZSBpcyBSVUlNICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBBUFBUWVBFX1JVSU0gPSBQaG9uZUNvbnN0YW50cy5BUFBUWVBFX1JVSU07CiAgICAvKiogVUlDQyBhcHBsaWNhdGlvbiB0eXBlIGlzIENTSU0gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEFQUFRZUEVfQ1NJTSA9IFBob25lQ29uc3RhbnRzLkFQUFRZUEVfQ1NJTTsKICAgIC8qKiBVSUNDIGFwcGxpY2F0aW9uIHR5cGUgaXMgSVNJTSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQVBQVFlQRV9JU0lNID0gUGhvbmVDb25zdGFudHMuQVBQVFlQRV9JU0lNOwoKICAgIC8vIGF1dGhDb250ZXh0IChwYXJhbWV0ZXIgUDIpIHdoZW4gZG9pbmcgVUlDQyBjaGFsbGVuZ2UsCiAgICAvLyBwZXIgM0dQUCBUUyAzMS4xMDIgKFNlY3Rpb24gNy4xLjIpCiAgICAvKiogQXV0aGVudGljYXRpb24gdHlwZSBmb3IgVUlDQyBjaGFsbGVuZ2UgaXMgRUFQIFNJTS4gU2VlIFJGQyA0MTg2IGZvciBkZXRhaWxzLiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQVVUSFRZUEVfRUFQX1NJTSA9IFBob25lQ29uc3RhbnRzLkFVVEhfQ09OVEVYVF9FQVBfU0lNOwogICAgLyoqIEF1dGhlbnRpY2F0aW9uIHR5cGUgZm9yIFVJQ0MgY2hhbGxlbmdlIGlzIEVBUCBBS0EuIFNlZSBSRkMgNDE4NyBmb3IgZGV0YWlscy4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEFVVEhUWVBFX0VBUF9BS0EgPSBQaG9uZUNvbnN0YW50cy5BVVRIX0NPTlRFWFRfRUFQX0FLQTsKCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHJlc3BvbnNlIG9mIGF1dGhlbnRpY2F0aW9uIGZvciB0aGUgZGVmYXVsdCBzdWJzY3JpcHRpb24uCiAgICAgKiBSZXR1cm5zIG51bGwgaWYgdGhlIGF1dGhlbnRpY2F0aW9uIGhhc24ndCBiZWVuIHN1Y2Nlc3NmdWwKICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGFwcFR5cGUgdGhlIGljYyBhcHBsaWNhdGlvbiB0eXBlLCBsaWtlIHtAbGluayAjQVBQVFlQRV9VU0lNfQogICAgICogQHBhcmFtIGF1dGhUeXBlIHRoZSBhdXRoZW50aWNhdGlvbiB0eXBlLCB7QGxpbmsgI0FVVEhUWVBFX0VBUF9BS0F9IG9yCiAgICAgKiB7QGxpbmsgI0FVVEhUWVBFX0VBUF9TSU19CiAgICAgKiBAcGFyYW0gZGF0YSBhdXRoZW50aWNhdGlvbiBjaGFsbGVuZ2UgZGF0YSwgYmFzZTY0IGVuY29kZWQuCiAgICAgKiBTZWUgM0dQUCBUUyAzMS4xMDIgNy4xLjIgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEByZXR1cm4gdGhlIHJlc3BvbnNlIG9mIGF1dGhlbnRpY2F0aW9uLiBUaGlzIHZhbHVlIHdpbGwgYmUgbnVsbCBpbiB0aGUgZm9sbG93aW5nIGNhc2VzOgogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgaW5jb3JyZWN0IE1BQwogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgc2VjdXJpdHkgY29udGV4dCBub3Qgc3VwcG9ydGVkCiAgICAgKiAgIEtleSBmcmVzaG5lc3MgZmFpbHVyZQogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgbm8gbWVtb3J5IHNwYWNlIGF2YWlsYWJsZQogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgbm8gbWVtb3J5IHNwYWNlIGF2YWlsYWJsZSBpbiBFRk1VSwogICAgICovCiAgICAvLyBUT0RPKGIvNzM2NjAxOTApOiBUaGlzIHNob3VsZCBwcm9iYWJseSByZXF1aXJlIE1PRElGWV9QSE9ORV9TVEFURSwgbm90CiAgICAvLyBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUuIEl0IGNlcnRhaW5seSBzaG91bGRuJ3QgcmVmZXJlbmNlIHRoZSBwZXJtaXNzaW9uIGluIEphdmFkb2Mgc2luY2UKICAgIC8vIGl0J3Mgbm90IHB1YmxpYyBBUEkuCiAgICBwdWJsaWMgU3RyaW5nIGdldEljY0F1dGhlbnRpY2F0aW9uKGludCBhcHBUeXBlLCBpbnQgYXV0aFR5cGUsIFN0cmluZyBkYXRhKSB7CiAgICAgICAgcmV0dXJuIGdldEljY0F1dGhlbnRpY2F0aW9uKGdldFN1YklkKCksIGFwcFR5cGUsIGF1dGhUeXBlLCBkYXRhKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHJlc3BvbnNlIG9mIFVTSU0gQXV0aGVudGljYXRpb24gZm9yIHNwZWNpZmllZCBzdWJJZC4KICAgICAqIFJldHVybnMgbnVsbCBpZiB0aGUgYXV0aGVudGljYXRpb24gaGFzbid0IGJlZW4gc3VjY2Vzc2Z1bAogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHN1YnNjcmlwdGlvbiBJRCB1c2VkIGZvciBhdXRoZW50aWNhdGlvbgogICAgICogQHBhcmFtIGFwcFR5cGUgdGhlIGljYyBhcHBsaWNhdGlvbiB0eXBlLCBsaWtlIHtAbGluayAjQVBQVFlQRV9VU0lNfQogICAgICogQHBhcmFtIGF1dGhUeXBlIHRoZSBhdXRoZW50aWNhdGlvbiB0eXBlLCB7QGxpbmsgI0FVVEhUWVBFX0VBUF9BS0F9IG9yCiAgICAgKiB7QGxpbmsgI0FVVEhUWVBFX0VBUF9TSU19CiAgICAgKiBAcGFyYW0gZGF0YSBhdXRoZW50aWNhdGlvbiBjaGFsbGVuZ2UgZGF0YSwgYmFzZTY0IGVuY29kZWQuCiAgICAgKiBTZWUgM0dQUCBUUyAzMS4xMDIgNy4xLjIgZm9yIG1vcmUgZGV0YWlscy4KICAgICAqIEByZXR1cm4gdGhlIHJlc3BvbnNlIG9mIGF1dGhlbnRpY2F0aW9uLiBUaGlzIHZhbHVlIHdpbGwgYmUgbnVsbCBpbiB0aGUgZm9sbG93aW5nIGNhc2VzIG9ubHkKICAgICAqIChzZWUgM0dQUCBUUyAzMS4xMDIgNy4zLjEpOgogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgaW5jb3JyZWN0IE1BQwogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgc2VjdXJpdHkgY29udGV4dCBub3Qgc3VwcG9ydGVkCiAgICAgKiAgIEtleSBmcmVzaG5lc3MgZmFpbHVyZQogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgbm8gbWVtb3J5IHNwYWNlIGF2YWlsYWJsZQogICAgICogICBBdXRoZW50aWNhdGlvbiBlcnJvciwgbm8gbWVtb3J5IHNwYWNlIGF2YWlsYWJsZSBpbiBFRk1VSwogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdHJpbmcgZ2V0SWNjQXV0aGVudGljYXRpb24oaW50IHN1YklkLCBpbnQgYXBwVHlwZSwgaW50IGF1dGhUeXBlLCBTdHJpbmcgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElQaG9uZVN1YkluZm8gaW5mbyA9IGdldFN1YnNjcmliZXJJbmZvU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaW5mbyA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiBpbmZvLmdldEljY1NpbUNoYWxsZW5nZVJlc3BvbnNlKHN1YklkLCBhcHBUeXBlLCBhdXRoVHlwZSwgZGF0YSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGJlZm9yZSBwaG9uZSBzdGFydHMKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBGb3JiaWRkZW4gUExNTnMgZnJvbSB0aGUgVVNJTSBBcHAKICAgICAqIFJldHVybnMgbnVsbCBpZiB0aGUgcXVlcnkgZmFpbHMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gYW4gYXJyYXkgb2YgZm9yYmlkZGVuIFBMTU5zIG9yIG51bGwgaWYgbm90IGF2YWlsYWJsZQogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmdbXSBnZXRGb3JiaWRkZW5QbG1ucygpIHsKICAgICAgcmV0dXJuIGdldEZvcmJpZGRlblBsbW5zKGdldFN1YklkKCksIEFQUFRZUEVfVVNJTSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIEZvcmJpZGRlbiBQTE1OcyBmcm9tIHRoZSBzcGVjaWZpZWQgU0lNIEFwcAogICAgICogUmV0dXJucyBudWxsIGlmIHRoZSBxdWVyeSBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgc3Vic2NyaXB0aW9uIElEIHVzZWQgZm9yIGF1dGhlbnRpY2F0aW9uCiAgICAgKiBAcGFyYW0gYXBwVHlwZSB0aGUgaWNjIGFwcGxpY2F0aW9uIHR5cGUsIGxpa2Uge0BsaW5rICNBUFBUWVBFX1VTSU19CiAgICAgKiBAcmV0dXJuIGZwbG1ucyBhbiBhcnJheSBvZiBmb3JiaWRkZW4gUExNTnMKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nW10gZ2V0Rm9yYmlkZGVuUGxtbnMoaW50IHN1YklkLCBpbnQgYXBwVHlwZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRGb3JiaWRkZW5QbG1ucyhzdWJJZCwgYXBwVHlwZSwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBiZWZvcmUgcGhvbmUgc3RhcnRzCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBmb3JiaWRkZW4gUExNTiBTSU0gZmlsZSB3aXRoIHRoZSBwcm92aWRlZCB2YWx1ZXMuCiAgICAgKiBQYXNzaW5nIGFuIGVtcHR5IGxpc3Qgd2lsbCBjbGVhciB0aGUgY29udGVudHMgb2YgdGhlIEVGZnBsbW4gZmlsZS4KICAgICAqIElmIHRoZSBwcm92aWRlZCBsaXN0IGlzIHNob3J0ZXIgdGhhbiB0aGUgc2l6ZSBvZiBFRmZwbG1uLCB0aGVuIHRoZSBsaXN0IHdpbGwgYmUgcGFkZGVkCiAgICAgKiB1cCB0byB0aGUgZmlsZSBzaXplIHdpdGggJ0ZGRkZGRicuIChyZXF1aXJlZCBieSAzR1BQIFRTIDMxLjEwMiBzcGVjIDQuMi4xNikKICAgICAqIElmIHRoZSBsaXN0IGlzIGxvbmdlciB0aGFuIHRoZSBzaXplIG9mIEVGZnBsbW4sIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSB3cml0dGVuIGZyb20gdGhlCiAgICAgKiBiZWdpbm5pbmcgb2YgdGhlIGxpc3QgdXAgdG8gdGhlIGZpbGUgc2l6ZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURQogICAgICogTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gZnBsbW5zIGEgbGlzdCBvZiBQTE1OcyB0byBiZSBmb3JiaWRkZW4uCiAgICAgKgogICAgICogQHJldHVybiBudW1iZXIgb2YgUExNTnMgdGhhdCB3ZXJlIHN1Y2Nlc3NmdWxseSB3cml0dGVuIHRvIHRoZSBTSU0gRlBMTU4gbGlzdC4KICAgICAqIFRoaXMgbWF5IGJlIGxlc3MgdGhhbiB0aGUgbnVtYmVyIG9mIFBMTU5zIHBhc3NlZCBpbiB3aGVyZSB0aGUgU0lNIGZpbGUgZG9lcyBub3QgaGF2ZSBlbm91Z2gKICAgICAqIHJvb20gZm9yIGFsbCBvZiB0aGUgdmFsdWVzIHBhc3NlZCBpbi4gUmV0dXJuIC0xIGluIHRoZSBldmVudCBvZiBhbiB1bmV4cGVjdGVkIGZhaWx1cmUKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgc2V0Rm9yYmlkZGVuUGxtbnMoQE5vbk51bGwgTGlzdDxTdHJpbmc+IGZwbG1ucykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHJldHVybiAtMTsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRGb3JiaWRkZW5QbG1ucygKICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZCgpLCBBUFBUWVBFX1VTSU0sIGZwbG1ucywgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldEZvcmJpZGRlblBsbW5zIFJlbW90ZUV4Y2VwdGlvbjogIiArIGV4LmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHN0YXJ0cwogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0Rm9yYmlkZGVuUGxtbnMgTnVsbFBvaW50ZXJFeGNlcHRpb246ICIgKyBleC5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgUC1DU0NGIGFkZHJlc3MgZnJvbSBQQ08gYWZ0ZXIgZGF0YSBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkIG9yIG1vZGlmaWVkLgogICAgICogQHBhcmFtIGFwblR5cGUgdGhlIGFwblR5cGUsICJpbXMiIGZvciBJTVMgQVBOLCAiZW1lcmdlbmN5IiBmb3IgRU1FUkdFTkNZIEFQTgogICAgICogQHJldHVybiBhcnJheSBvZiBQLUNTQ0YgYWRkcmVzcwogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIFN0cmluZ1tdIGdldFBjc2NmQWRkcmVzcyhTdHJpbmcgYXBuVHlwZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0cmluZ1swXTsKICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRQY3NjZkFkZHJlc3MoYXBuVHlwZSwgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFN0cmluZ1swXTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogUmVzZXRzIHRoZSB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLkltc1NlcnZpY2V9IGFzc29jaWF0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIHNpbSBzbG90LgogICAgICogVXNlZCBieSBkaWFnbm9zdGljIGFwcHMgdG8gZm9yY2UgdGhlIElNUyBzdGFjayB0byBiZSBkaXNhYmxlZCBhbmQgcmUtZW5hYmxlZCBpbiBhbiBlZmZvcnQgdG8KICAgICAqIHJlY292ZXIgZnJvbSBzY2VuYXJpb3Mgd2hlcmUgdGhlIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuSW1zU2VydmljZX0gZ2V0cyBpbiB0byBhIGJhZAogICAgICogc3RhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCB0aGUgc2ltIHNsb3QgdG8gcmVzZXQgdGhlIElNUyBzdGFjayBvbi4KICAgICAqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAV29ya2VyVGhyZWFkCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCByZXNldEltcyhpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LnJlc2V0SW1zKHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAidG9nZ2xlSW1zT25PZmYsIFJlbW90ZUV4Y2VwdGlvbjogIgogICAgICAgICAgICAgICAgICAgICsgZS5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgSU1TIGZvciB0aGUgZnJhbWV3b3JrLiBUaGlzIHdpbGwgdHJpZ2dlciBJTVMgcmVnaXN0cmF0aW9uIGFuZCBJbXNGZWF0dXJlIGNhcGFiaWxpdHkKICAgICAqIHN0YXR1cyB1cGRhdGVzLCBpZiBub3QgYWxyZWFkeSBlbmFibGVkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgZW5hYmxlSW1zKGludCBzbG90SWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuZW5hYmxlSW1zKHNsb3RJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZW5hYmxlSW1zLCBSZW1vdGVFeGNlcHRpb246ICIKICAgICAgICAgICAgICAgICAgICArIGUuZ2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBJTVMgZm9yIHRoZSBmcmFtZXdvcmsuIFRoaXMgd2lsbCB0cmlnZ2VyIElNUyBkZS1yZWdpc3RyYXRpb24gYW5kIHRyaWdnZXIgSW1zRmVhdHVyZQogICAgICogc3RhdHVzIHVwZGF0ZXMgdG8gZGlzYWJsZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgdm9pZCBkaXNhYmxlSW1zKGludCBzbG90SWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuZGlzYWJsZUltcyhzbG90SWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImRpc2FibGVJbXMsIFJlbW90ZUV4Y2VwdGlvbjogIgogICAgICAgICAgICAgICAgICAgICsgZS5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHtAbGluayBJSW1zTW1UZWxGZWF0dXJlfSB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBnaXZlbiBzbG90IElkIGFuZCBNTVRlbAogICAgICogZmVhdHVyZSBvciB7QGxpbmsgbnVsbH0gaWYgdGhlIHNlcnZpY2UgaXMgbm90IGF2YWlsYWJsZS4gSWYgYW4gTU1UZWxGZWF0dXJlIGlzIGF2YWlsYWJsZSwgdGhlCiAgICAgKiB7QGxpbmsgSUltc1NlcnZpY2VGZWF0dXJlQ2FsbGJhY2t9IGNhbGxiYWNrIGlzIHJlZ2lzdGVyZWQgYXMgYSBsaXN0ZW5lciBmb3IgZmVhdHVyZSB1cGRhdGVzLgogICAgICogQHBhcmFtIHNsb3RJbmRleCBUaGUgU0lNIHNsb3QgdGhhdCB3ZSBhcmUgcmVxdWVzdGluZyB0aGUge0BsaW5rIElJbXNNbVRlbEZlYXR1cmV9IGZvci4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBMaXN0ZW5lciB0aGF0IHdpbGwgc2VuZCB1cGRhdGVzIHRvIEltc01hbmFnZXIgd2hlbiB0aGVyZSBhcmUgdXBkYXRlcyB0bwogICAgICogSW1zU2VydmljZUNvbnRyb2xsZXIuCiAgICAgKiBAcmV0dXJuIHtAbGluayBJSW1zTW1UZWxGZWF0dXJlfSBpbnRlcmZhY2UgZm9yIHRoZSBmZWF0dXJlIHNwZWNpZmllZCBvciB7QGNvZGUgbnVsbH0gaWYKICAgICAqIGl0IGlzIHVuYXZhaWxhYmxlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOdWxsYWJsZSBJSW1zTW1UZWxGZWF0dXJlIGdldEltc01tVGVsRmVhdHVyZUFuZExpc3RlbihpbnQgc2xvdEluZGV4LAogICAgICAgICAgICBJSW1zU2VydmljZUZlYXR1cmVDYWxsYmFjayBjYWxsYmFjaykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0TW1UZWxGZWF0dXJlQW5kTGlzdGVuKHNsb3RJbmRleCwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldEltc01tVGVsRmVhdHVyZUFuZExpc3RlbiwgUmVtb3RlRXhjZXB0aW9uOiAiCiAgICAgICAgICAgICAgICAgICAgKyBlLmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUge0BsaW5rIElJbXNSY3NGZWF0dXJlfSB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBnaXZlbiBzbG90IElkIGFuZCBSQ1MKICAgICAqIGZlYXR1cmUgZm9yIGVtZXJnZW5jeSBjYWxsaW5nIG9yIHtAbGluayBudWxsfSBpZiB0aGUgc2VydmljZSBpcyBub3QgYXZhaWxhYmxlLiBJZiBhbgogICAgICogUmNzRmVhdHVyZSBpcyBhdmFpbGFibGUsIHRoZSB7QGxpbmsgSUltc1NlcnZpY2VGZWF0dXJlQ2FsbGJhY2t9IGNhbGxiYWNrIGlzIHJlZ2lzdGVyZWQgYXMgYQogICAgICogbGlzdGVuZXIgZm9yIGZlYXR1cmUgdXBkYXRlcy4KICAgICAqIEBwYXJhbSBzbG90SW5kZXggVGhlIFNJTSBzbG90IHRoYXQgd2UgYXJlIHJlcXVlc3RpbmcgdGhlIHtAbGluayBJSW1zUmNzRmVhdHVyZX0gZm9yLgogICAgICogQHBhcmFtIGNhbGxiYWNrIExpc3RlbmVyIHRoYXQgd2lsbCBzZW5kIHVwZGF0ZXMgdG8gSW1zTWFuYWdlciB3aGVuIHRoZXJlIGFyZSB1cGRhdGVzIHRvCiAgICAgKiBJbXNTZXJ2aWNlQ29udHJvbGxlci4KICAgICAqIEByZXR1cm4ge0BsaW5rIElJbXNSY3NGZWF0dXJlfSBpbnRlcmZhY2UgZm9yIHRoZSBmZWF0dXJlIHNwZWNpZmllZCBvciB7QGNvZGUgbnVsbH0gaWYKICAgICAqIGl0IGlzIHVuYXZhaWxhYmxlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOdWxsYWJsZSBJSW1zUmNzRmVhdHVyZSBnZXRJbXNSY3NGZWF0dXJlQW5kTGlzdGVuKGludCBzbG90SW5kZXgsCiAgICAgICAgICAgIElJbXNTZXJ2aWNlRmVhdHVyZUNhbGxiYWNrIGNhbGxiYWNrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRSY3NGZWF0dXJlQW5kTGlzdGVuKHNsb3RJbmRleCwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldEltc1Jjc0ZlYXR1cmVBbmRMaXN0ZW4sIFJlbW90ZUV4Y2VwdGlvbjogIgogICAgICAgICAgICAgICAgICAgICsgZS5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFVucmVnaXN0ZXIgYSBJSW1zU2VydmljZUZlYXR1cmVDYWxsYmFjayBwcmV2aW91c2x5IGFzc29jaWF0ZWQgd2l0aCBhbiBJbXNGZWF0dXJlIHRocm91Z2gKICAgICAqIHtAbGluayAjZ2V0SW1zTW1UZWxGZWF0dXJlQW5kTGlzdGVuKGludCwgSUltc1NlcnZpY2VGZWF0dXJlQ2FsbGJhY2spfSBvcgogICAgICoge0BsaW5rICNnZXRJbXNSY3NGZWF0dXJlQW5kTGlzdGVuKGludCwgSUltc1NlcnZpY2VGZWF0dXJlQ2FsbGJhY2spfS4KICAgICAqIEBwYXJhbSBzbG90SW5kZXggVGhlIFNJTSBzbG90IGFzc29jaWF0ZWQgd2l0aCB0aGUgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0gZmVhdHVyZVR5cGUgVGhlIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuZmVhdHVyZS5JbXNGZWF0dXJlLkZlYXR1cmVUeXBlfQogICAgICogICAgICAgICAgICAgICAgICAgIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGJlIHVucmVnaXN0ZXJlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHVucmVnaXN0ZXJJbXNGZWF0dXJlQ2FsbGJhY2soaW50IHNsb3RJbmRleCwgaW50IGZlYXR1cmVUeXBlLAogICAgICAgICAgICBJSW1zU2VydmljZUZlYXR1cmVDYWxsYmFjayBjYWxsYmFjaykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS51bnJlZ2lzdGVySW1zRmVhdHVyZUNhbGxiYWNrKHNsb3RJbmRleCwgZmVhdHVyZVR5cGUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJ1bnJlZ2lzdGVySW1zRmVhdHVyZUNhbGxiYWNrLCBSZW1vdGVFeGNlcHRpb246ICIKICAgICAgICAgICAgICAgICAgICArIGUuZ2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRoZSB7QElJbXNSZWdpc3RyYXRpb259IGludGVyZmFjZSB0aGF0IGNvcnJlc3BvbmRzIHdpdGggdGhlIHNsb3QgaW5kZXggYW5kIGZlYXR1cmUuCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IFRoZSBTSU0gc2xvdCBjb3JyZXNwb25kaW5nIHRvIHRoZSBJbXNTZXJ2aWNlIEltc1JlZ2lzdHJhdGlvbiBpcyBhY3RpdmUgZm9yLgogICAgICogQHBhcmFtIGZlYXR1cmUgQW4gaW50ZWdlciBpbmRpY2F0aW5nIHRoZSBmZWF0dXJlIHRoYXQgd2Ugd2lzaCB0byBnZXQgdGhlIEltc1JlZ2lzdHJhdGlvbiBmb3IuCiAgICAgKiBDb3JyZXNwb25kcyB0byBmZWF0dXJlcyBkZWZpbmVkIGluIEltc0ZlYXR1cmUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIEBOdWxsYWJsZSBJSW1zUmVnaXN0cmF0aW9uIGdldEltc1JlZ2lzdHJhdGlvbihpbnQgc2xvdEluZGV4LCBpbnQgZmVhdHVyZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0SW1zUmVnaXN0cmF0aW9uKHNsb3RJbmRleCwgZmVhdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0SW1zUmVnaXN0cmF0aW9uLCBSZW1vdGVFeGNlcHRpb246ICIgKyBlLmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0aGUge0BJSW1zQ29uZmlnfSBpbnRlcmZhY2UgdGhhdCBjb3JyZXNwb25kcyB3aXRoIHRoZSBzbG90IGluZGV4IGFuZCBmZWF0dXJlLgogICAgICogQHBhcmFtIHNsb3RJbmRleCBUaGUgU0lNIHNsb3QgY29ycmVzcG9uZGluZyB0byB0aGUgSW1zU2VydmljZSBJbXNDb25maWcgaXMgYWN0aXZlIGZvci4KICAgICAqIEBwYXJhbSBmZWF0dXJlIEFuIGludGVnZXIgaW5kaWNhdGluZyB0aGUgZmVhdHVyZSB0aGF0IHdlIHdpc2ggdG8gZ2V0IHRoZSBJbXNDb25maWcgZm9yLgogICAgICogQ29ycmVzcG9uZHMgdG8gZmVhdHVyZXMgZGVmaW5lZCBpbiBJbXNGZWF0dXJlLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBATnVsbGFibGUgSUltc0NvbmZpZyBnZXRJbXNDb25maWcoaW50IHNsb3RJbmRleCwgaW50IGZlYXR1cmUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldEltc0NvbmZpZyhzbG90SW5kZXgsIGZlYXR1cmUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldEltc1JlZ2lzdHJhdGlvbiwgUmVtb3RlRXhjZXB0aW9uOiAiICsgZS5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBJTVMgcmVnaXN0cmF0aW9uIHN0YXRlCiAgICAgKgogICAgICogQHBhcmFtIFJlZ2lzdHJhdGlvbiBzdGF0ZQogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyB2b2lkIHNldEltc1JlZ2lzdHJhdGlvblN0YXRlKGJvb2xlYW4gcmVnaXN0ZXJlZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuc2V0SW1zUmVnaXN0cmF0aW9uU3RhdGUocmVnaXN0ZXJlZCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBASW50RGVmKHByZWZpeCA9IHsgIk5FVFdPUktfTU9ERV8iIH0sIHZhbHVlID0gewogICAgICAgICAgICBORVRXT1JLX01PREVfV0NETUFfUFJFRiwKICAgICAgICAgICAgTkVUV09SS19NT0RFX0dTTV9PTkxZLAogICAgICAgICAgICBORVRXT1JLX01PREVfV0NETUFfT05MWSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX0dTTV9VTVRTLAogICAgICAgICAgICBORVRXT1JLX01PREVfQ0RNQV9FVkRPLAogICAgICAgICAgICBORVRXT1JLX01PREVfQ0RNQV9OT19FVkRPLAogICAgICAgICAgICBORVRXT1JLX01PREVfRVZET19OT19DRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfR0xPQkFMLAogICAgICAgICAgICBORVRXT1JLX01PREVfTFRFX0NETUFfRVZETywKICAgICAgICAgICAgTkVUV09SS19NT0RFX0xURV9HU01fV0NETUEsCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9MVEVfQ0RNQV9FVkRPX0dTTV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX0xURV9PTkxZLAogICAgICAgICAgICBORVRXT1JLX01PREVfTFRFX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfVERTQ0RNQV9PTkxZLAogICAgICAgICAgICBORVRXT1JLX01PREVfVERTQ0RNQV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX0xURV9URFNDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfVERTQ0RNQV9HU00sCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9MVEVfVERTQ0RNQV9HU00sCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9URFNDRE1BX0dTTV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX0xURV9URFNDRE1BX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfTFRFX1REU0NETUFfR1NNX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfVERTQ0RNQV9DRE1BX0VWRE9fR1NNX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfTFRFX1REU0NETUFfQ0RNQV9FVkRPX0dTTV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX05SX09OTFksCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9OUl9MVEUsCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9OUl9MVEVfQ0RNQV9FVkRPLAogICAgICAgICAgICBORVRXT1JLX01PREVfTlJfTFRFX0dTTV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX05SX0xURV9DRE1BX0VWRE9fR1NNX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfTlJfTFRFX1dDRE1BLAogICAgICAgICAgICBORVRXT1JLX01PREVfTlJfTFRFX1REU0NETUEsCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQV9HU00sCiAgICAgICAgICAgIE5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX0dTTV9XQ0RNQSwKICAgICAgICAgICAgTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX0NETUFfRVZET19HU01fV0NETUEKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBQcmVmTmV0d29ya01vZGV7fQoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBHU00vV0NETUEgKFdDRE1BIHByZWZlcnJlZCkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfV0NETUFfUFJFRiA9IFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfV0NETUFfUFJFRjsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgR1NNIG9ubHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfR1NNX09OTFkgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0dTTV9PTkxZOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBXQ0RNQSBvbmx5LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX1dDRE1BX09OTFkgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX1dDRE1BX09OTFk7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIEdTTS9XQ0RNQSAoYXV0byBtb2RlLCBhY2NvcmRpbmcgdG8gUFJMKS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9HU01fVU1UUyA9IFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfR1NNX1VNVFM7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIENETUEgYW5kIEV2RG8gKGF1dG8gbW9kZSwgYWNjb3JkaW5nIHRvIFBSTCkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfQ0RNQV9FVkRPID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9DRE1BOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBDRE1BIG9ubHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfQ0RNQV9OT19FVkRPID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9DRE1BX05PX0VWRE87CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIEV2RG8gb25seS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9FVkRPX05PX0NETUEgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0VWRE9fTk9fQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgR1NNL1dDRE1BLCBDRE1BLCBhbmQgRXZEbyAoYXV0byBtb2RlLCBhY2NvcmRpbmcgdG8gUFJMKS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9HTE9CQUwgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0dMT0JBTDsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTFRFLCBDRE1BIGFuZCBFdkRvLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX0xURV9DRE1BX0VWRE8gPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9DRE1BX0VWRE87CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIExURSwgR1NNL1dDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX0xURV9HU01fV0NETUEgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9HU01fV0NETUE7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIExURSwgQ0RNQSwgRXZEbywgR1NNL1dDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX0xURV9DRE1BX0VWRE9fR1NNX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfQ0RNQV9FVkRPX0dTTV9XQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTFRFIE9ubHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTFRFX09OTFkgPSBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9PTkxZOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBMVEUvV0NETUEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTFRFX1dDRE1BID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfV0NETUE7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIFRELVNDRE1BIG9ubHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfVERTQ0RNQV9PTkxZID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9URFNDRE1BX09OTFk7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIFRELVNDRE1BIGFuZCBXQ0RNQS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9URFNDRE1BX1dDRE1BID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9URFNDRE1BX1dDRE1BOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBURC1TQ0RNQSBhbmQgTFRFLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX0xURV9URFNDRE1BID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfVERTQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgVEQtU0NETUEgYW5kIEdTTS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9URFNDRE1BX0dTTSA9IFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfVERTQ0RNQV9HU007CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIFRELVNDRE1BLEdTTSBhbmQgTFRFLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX0xURV9URFNDRE1BX0dTTSA9CiAgICAgICAgICAgIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTFRFX1REU0NETUFfR1NNOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBURC1TQ0RNQSwgR1NNL1dDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX1REU0NETUFfR1NNX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9URFNDRE1BX0dTTV9XQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgVEQtU0NETUEsIFdDRE1BIGFuZCBMVEUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTFRFX1REU0NETUFfV0NETUEgPQogICAgICAgICAgICBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX0xURV9URFNDRE1BX1dDRE1BOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBURC1TQ0RNQSwgR1NNL1dDRE1BIGFuZCBMVEUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTFRFX1REU0NETUFfR1NNX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9MVEVfVERTQ0RNQV9HU01fV0NETUE7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIFRELVNDRE1BLEV2RG8sQ0RNQSxHU00vV0NETUEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfVERTQ0RNQV9DRE1BX0VWRE9fR1NNX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9URFNDRE1BX0NETUFfRVZET19HU01fV0NETUE7CiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgVEQtU0NETUEvTFRFL0dTTS9XQ0RNQSwgQ0RNQSwgYW5kIEV2RG8uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTFRFX1REU0NETUFfQ0RNQV9FVkRPX0dTTV9XQ0RNQSA9CiAgICAgICAgICAgIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTFRFX1REU0NETUFfQ0RNQV9FVkRPX0dTTV9XQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTlIgNUcgb25seS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9OUl9PTkxZID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9OUl9PTkxZOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBOUiA1RywgTFRFLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURSA9IFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTlJfTFRFOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBOUiA1RywgTFRFLCBDRE1BIGFuZCBFdkRvLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURV9DRE1BX0VWRE8gPQogICAgICAgICAgICBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX05SX0xURV9DRE1BX0VWRE87CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIE5SIDVHLCBMVEUsIEdTTSBhbmQgV0NETUEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTlJfTFRFX0dTTV9XQ0RNQSA9CiAgICAgICAgICAgIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTlJfTFRFX0dTTV9XQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTlIgNUcsIExURSwgQ0RNQSwgRXZEbywgR1NNIGFuZCBXQ0RNQS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9OUl9MVEVfQ0RNQV9FVkRPX0dTTV9XQ0RNQSA9CiAgICAgICAgICAgIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTlJfTFRFX0NETUFfRVZET19HU01fV0NETUE7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIE5SIDVHLCBMVEUgYW5kIFdDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURV9XQ0RNQSA9IFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTlJfTFRFX1dDRE1BOwoKICAgIC8qKgogICAgICogUHJlZmVycmVkIG5ldHdvcmsgbW9kZSBpcyBOUiA1RywgTFRFIGFuZCBURFNDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BID0gUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTlIgNUcsIExURSwgVEQtU0NETUEgYW5kIEdTTS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQV9HU00gPQogICAgICAgICAgICBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX0dTTTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTlIgNUcsIExURSwgVEQtU0NETUEsIFdDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQV9XQ0RNQTsKCiAgICAvKioKICAgICAqIFByZWZlcnJlZCBuZXR3b3JrIG1vZGUgaXMgTlIgNUcsIExURSwgVEQtU0NETUEsIEdTTSBhbmQgV0NETUEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBORVRXT1JLX01PREVfTlJfTFRFX1REU0NETUFfR1NNX1dDRE1BID0KICAgICAgICAgICAgUklMQ29uc3RhbnRzLk5FVFdPUktfTU9ERV9OUl9MVEVfVERTQ0RNQV9HU01fV0NETUE7CgogICAgLyoqCiAgICAgKiBQcmVmZXJyZWQgbmV0d29yayBtb2RlIGlzIE5SIDVHLCBMVEUsIFRELVNDRE1BLCBDRE1BLCBFVkRPLCBHU00gYW5kIFdDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX0NETUFfRVZET19HU01fV0NETUEgPQogICAgICAgICAgICBSSUxDb25zdGFudHMuTkVUV09SS19NT0RFX05SX0xURV9URFNDRE1BX0NETUFfRVZET19HU01fV0NETUE7CgogICAgLyoqCiAgICAgKiBUaGUgZGVmYXVsdCBwcmVmZXJyZWQgbmV0d29yayBtb2RlIGNvbnN0YW50LgogICAgICoKICAgICAqIDxwPiBUaGlzIGNvbnN0YW50IGlzIHVzZWQgaW4gY2FzZSBvZiBub3RoaW5nIGlzIHNldCBpbgogICAgICogVGVsZXBob255UHJvcGVydGllcyNkZWZhdWx0X25ldHdvcmsoKS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUZBVUxUX1BSRUZFUlJFRF9ORVRXT1JLX01PREUgPQogICAgICAgICAgICBSSUxDb25zdGFudHMuUFJFRkVSUkVEX05FVFdPUktfTU9ERTsKCiAgICAvKioKICAgICAqIEdldCB0aGUgcHJlZmVycmVkIG5ldHdvcmsgdHlwZS4KICAgICAqIFVzZWQgZm9yIGRldmljZSBjb25maWd1cmF0aW9uIGJ5IHNvbWUgQ0RNQSBvcGVyYXRvcnMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIHByZWZlcnJlZCBuZXR3b3JrIHR5cGUuCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZ2V0UHJlZmVycmVkTmV0d29ya1R5cGVCaXRtYXNrfSBpbnN0ZWFkLgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbigoYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkpCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIEBQcmVmTmV0d29ya01vZGUgaW50IGdldFByZWZlcnJlZE5ldHdvcmtUeXBlKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0UHJlZmVycmVkTmV0d29ya1R5cGUoc3ViSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRQcmVmZXJyZWROZXR3b3JrVHlwZSBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgcHJlZmVycmVkIG5ldHdvcmsgdHlwZSBiaXRtYXNrLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiBUaGUgYml0bWFzayBvZiBwcmVmZXJyZWQgbmV0d29yayB0eXBlcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgQE5ldHdvcmtUeXBlQml0TWFzayBsb25nIGdldFByZWZlcnJlZE5ldHdvcmtUeXBlQml0bWFzaygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGxvbmcpIFJhZGlvQWNjZXNzRmFtaWx5LmdldFJhZkZyb21OZXR3b3JrVHlwZSgKICAgICAgICAgICAgICAgICAgICAgICAgdGVsZXBob255LmdldFByZWZlcnJlZE5ldHdvcmtUeXBlKGdldFN1YklkKCkpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0UHJlZmVycmVkTmV0d29ya1R5cGVCaXRtYXNrIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlcy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBhbGxvd2VkIG5ldHdvcmsgdHlwZSBiaXRtYXNrCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgQE5ldHdvcmtUeXBlQml0TWFzayBsb25nIGdldEFsbG93ZWROZXR3b3JrVHlwZXMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRBbGxvd2VkTmV0d29ya1R5cGVzKGdldFN1YklkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRBbGxvd2VkTmV0d29ya1R5cGVzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgbmV0d29yayBzZWxlY3Rpb24gbW9kZSB0byBhdXRvbWF0aWMuCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldE5ldHdvcmtTZWxlY3Rpb25Nb2RlQXV0b21hdGljKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXROZXR3b3JrU2VsZWN0aW9uTW9kZUF1dG9tYXRpYyhnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0TmV0d29ya1NlbGVjdGlvbk1vZGVBdXRvbWF0aWMgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXROZXR3b3JrU2VsZWN0aW9uTW9kZUF1dG9tYXRpYyBOUEUiLCBleCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUGVyZm9ybSBhIHJhZGlvIHNjYW4gYW5kIHJldHVybiB0aGUgbGlzdCBvZiBhdmFpbGFibGUgbmV0d29ya3MuCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD4gTm90ZSB0aGF0IHRoaXMgc2NhbiBjYW4gdGFrZSBhIGxvbmcgdGltZSAoc29tZXRpbWVzIG1pbnV0ZXMpIHRvIGhhcHBlbi4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uczoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllcgogICAgICogcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KQogICAgICogYW5kIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jQUNDRVNTX0NPQVJTRV9MT0NBVElPTn0uCiAgICAgKgogICAgICogQHJldHVybiB7QGxpbmsgQ2VsbE5ldHdvcmtTY2FuUmVzdWx0fSB3aXRoIHRoZSBzdGF0dXMKICAgICAqIHtAbGluayBDZWxsTmV0d29ya1NjYW5SZXN1bHQjU1RBVFVTX1NVQ0NFU1N9IGFuZCBhIGxpc3Qgb2YKICAgICAqIHtAbGluayBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuT3BlcmF0b3JJbmZvfSBpZiBpdCdzIGF2YWlsYWJsZS4gT3RoZXJ3aXNlLCB0aGUgZmFpbHVyZQogICAgICogY2F1c2VkIHdpbGwgYmUgaW5jbHVkZWQgaW4gdGhlIHJlc3VsdC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFsbE9mID0gewogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFLAogICAgICAgICAgICBNYW5pZmVzdC5wZXJtaXNzaW9uLkFDQ0VTU19DT0FSU0VfTE9DQVRJT04KICAgIH0pCiAgICBwdWJsaWMgQ2VsbE5ldHdvcmtTY2FuUmVzdWx0IGdldEF2YWlsYWJsZU5ldHdvcmtzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2VsbE5ldHdvcmtTY2FuUmVzdWx0cyhnZXRTdWJJZCgpLCBnZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRBdmFpbGFibGVOZXR3b3JrcyBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldEF2YWlsYWJsZU5ldHdvcmtzIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDZWxsTmV0d29ya1NjYW5SZXN1bHQoCiAgICAgICAgICAgICAgICBDZWxsTmV0d29ya1NjYW5SZXN1bHQuU1RBVFVTX1VOS05PV05fRVJST1IsIG51bGwgLyogT3BlcmF0b3JJbmZvICovKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSBuZXR3b3JrIHNjYW4uCiAgICAgKgogICAgICogVGhpcyBtZXRob2QgaXMgYXN5bmNocm9ub3VzLCBzbyB0aGUgbmV0d29yayBzY2FuIHJlc3VsdHMgd2lsbCBiZSByZXR1cm5lZCBieSBjYWxsYmFjay4KICAgICAqIFRoZSByZXR1cm5lZCBOZXR3b3JrU2NhbiB3aWxsIGNvbnRhaW4gYSBjYWxsYmFjayBtZXRob2Qgd2hpY2ggY2FuIGJlIHVzZWQgdG8gc3RvcCB0aGUgc2Nhbi4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KQogICAgICogYW5kIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jQUNDRVNTX0ZJTkVfTE9DQVRJT059LgogICAgICoKICAgICAqIElmIHRoZSBzeXN0ZW0td2lkZSBsb2NhdGlvbiBzd2l0Y2ggaXMgb2ZmLCBhcHBzIG1heSBzdGlsbCBjYWxsIHRoaXMgQVBJLCB3aXRoIHRoZQogICAgICogZm9sbG93aW5nIGNvbnN0cmFpbnRzOgogICAgICogPG9sPgogICAgICogICAgIDxsaT5UaGUgYXBwIG11c3QgaG9sZCB0aGUge0Bjb2RlIGFuZHJvaWQucGVybWlzc2lvbi5ORVRXT1JLX1NDQU59IHBlcm1pc3Npb24uPC9saT4KICAgICAqICAgICA8bGk+VGhlIGFwcCBtdXN0IG5vdCBzdXBwbHkgYW55IHNwZWNpZmljIGJhbmRzIG9yIGNoYW5uZWxzIHRvIHNjYW4uPC9saT4KICAgICAqICAgICA8bGk+VGhlIGFwcCBtdXN0IG9ubHkgc3BlY2lmeSBNQ0MvTU5DIHBhaXJzIHRoYXQgYXJlCiAgICAgKiAgICAgYXNzb2NpYXRlZCB0byBhIFNJTSBpbiB0aGUgZGV2aWNlLjwvbGk+CiAgICAgKiAgICAgPGxpPlJldHVybmVkIHJlc3VsdHMgd2lsbCBoYXZlIG5vIG1lYW5pbmdmdWwgaW5mbyBvdGhlciB0aGFuIHNpZ25hbCBzdHJlbmd0aAogICAgICogICAgIGFuZCBNQ0MvTU5DIGluZm8uPC9saT4KICAgICAqIDwvb2w+CiAgICAgKgogICAgICogQHBhcmFtIHJlcXVlc3QgQ29udGFpbnMgYWxsIHRoZSBSQVQgd2l0aCBiYW5kcy9jaGFubmVscyB0aGF0IG5lZWQgdG8gYmUgc2Nhbm5lZC4KICAgICAqIEBwYXJhbSBleGVjdXRvciBUaGUgZXhlY3V0b3IgdGhyb3VnaCB3aGljaCB0aGUgY2FsbGJhY2sgc2hvdWxkIGJlIGludm9rZWQuIFNpbmNlIHRoZSBzY2FuCiAgICAgKiAgICAgICAgcmVxdWVzdCBtYXkgdHJpZ2dlciBtdWx0aXBsZSBjYWxsYmFja3MgYW5kIHRoZXkgbXVzdCBiZSBpbnZva2VkIGluIHRoZSBzYW1lIG9yZGVyIGFzCiAgICAgKiAgICAgICAgdGhleSBhcmUgcmVjZWl2ZWQgYnkgdGhlIHBsYXRmb3JtLCB0aGUgdXNlciBzaG91bGQgcHJvdmlkZSBhbiBleGVjdXRvciB3aGljaCBleGVjdXRlcwogICAgICogICAgICAgIHRhc2tzIG9uZSBhdCBhIHRpbWUgaW4gc2VyaWFsIG9yZGVyLiBGb3IgZXhhbXBsZSBBc3luY1Rhc2suU0VSSUFMX0VYRUNVVE9SLgogICAgICogQHBhcmFtIGNhbGxiYWNrIFJldHVybnMgbmV0d29yayBzY2FuIHJlc3VsdHMgb3IgZXJyb3JzLgogICAgICogQHJldHVybiBBIE5ldHdvcmtTY2FuIG9iaiB3aGljaCBjb250YWlucyBhIGNhbGxiYWNrIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHN0b3AgdGhlIHNjYW4uCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFsbE9mID0gewogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFLAogICAgICAgICAgICBNYW5pZmVzdC5wZXJtaXNzaW9uLkFDQ0VTU19GSU5FX0xPQ0FUSU9OCiAgICB9KQogICAgcHVibGljIE5ldHdvcmtTY2FuIHJlcXVlc3ROZXR3b3JrU2NhbigKICAgICAgICAgICAgTmV0d29ya1NjYW5SZXF1ZXN0IHJlcXVlc3QsIEV4ZWN1dG9yIGV4ZWN1dG9yLAogICAgICAgICAgICBUZWxlcGhvbnlTY2FuTWFuYWdlci5OZXR3b3JrU2NhbkNhbGxiYWNrIGNhbGxiYWNrKSB7CiAgICAgICAgc3luY2hyb25pemVkICh0aGlzKSB7CiAgICAgICAgICAgIGlmIChtVGVsZXBob255U2Nhbk1hbmFnZXIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbVRlbGVwaG9ueVNjYW5NYW5hZ2VyID0gbmV3IFRlbGVwaG9ueVNjYW5NYW5hZ2VyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1UZWxlcGhvbnlTY2FuTWFuYWdlci5yZXF1ZXN0TmV0d29ya1NjYW4oZ2V0U3ViSWQoKSwgcmVxdWVzdCwgZXhlY3V0b3IsIGNhbGxiYWNrLAogICAgICAgICAgICAgICAgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkCiAgICAgKiBVc2Uge0BsaW5rCiAgICAgKiAjcmVxdWVzdE5ldHdvcmtTY2FuKE5ldHdvcmtTY2FuUmVxdWVzdCwgRXhlY3V0b3IsIFRlbGVwaG9ueVNjYW5NYW5hZ2VyLk5ldHdvcmtTY2FuQ2FsbGJhY2spfQogICAgICogQHJlbW92ZWQKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYWxsT2YgPSB7CiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIE1hbmlmZXN0LnBlcm1pc3Npb24uQUNDRVNTX0ZJTkVfTE9DQVRJT04KICAgIH0pCiAgICBwdWJsaWMgTmV0d29ya1NjYW4gcmVxdWVzdE5ldHdvcmtTY2FuKAogICAgICAgIE5ldHdvcmtTY2FuUmVxdWVzdCByZXF1ZXN0LCBUZWxlcGhvbnlTY2FuTWFuYWdlci5OZXR3b3JrU2NhbkNhbGxiYWNrIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHJlcXVlc3ROZXR3b3JrU2NhbihyZXF1ZXN0LCBBc3luY1Rhc2suU0VSSUFMX0VYRUNVVE9SLCBjYWxsYmFjayk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBc2sgdGhlIHJhZGlvIHRvIGNvbm5lY3QgdG8gdGhlIGlucHV0IG5ldHdvcmsgYW5kIGNoYW5nZSBzZWxlY3Rpb24gbW9kZSB0byBtYW51YWwuCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0b3JOdW1lcmljIHRoZSBQTE1OIElEIG9mIHRoZSBuZXR3b3JrIHRvIHNlbGVjdC4KICAgICAqIEBwYXJhbSBwZXJzaXN0U2VsZWN0aW9uIHdoZXRoZXIgdGhlIHNlbGVjdGlvbiB3aWxsIHBlcnNpc3QgdW50aWwgcmVib290LiBJZiB0cnVlLCBvbmx5IGFsbG93cwogICAgICogYXR0YWNoaW5nIHRvIHRoZSBzZWxlY3RlZCBQTE1OIHVudGlsIHJlYm9vdDsgb3RoZXJ3aXNlLCBhdHRhY2ggdG8gdGhlIGNob3NlbiBQTE1OIGFuZCByZXN1bWUKICAgICAqIG5vcm1hbCBuZXR3b3JrIHNlbGVjdGlvbiBuZXh0IHRpbWUuCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBvbiBzdWNjZXNzOyB7QGNvZGUgZmFsc2V9IG9uIGFueSBmYWlsdXJlLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0TmV0d29ya1NlbGVjdGlvbk1vZGVNYW51YWwoU3RyaW5nIG9wZXJhdG9yTnVtZXJpYywgYm9vbGVhbiBwZXJzaXN0U2VsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIHNldE5ldHdvcmtTZWxlY3Rpb25Nb2RlTWFudWFsKAogICAgICAgICAgICAgICAgbmV3IE9wZXJhdG9ySW5mbygKICAgICAgICAgICAgICAgICAgICAgICAgIiIgLyogb3BlcmF0b3JBbHBoYUxvbmcgKi8sICIiIC8qIG9wZXJhdG9yQWxwaGFTaG9ydCAqLywgb3BlcmF0b3JOdW1lcmljKSwKICAgICAgICAgICAgICAgIHBlcnNpc3RTZWxlY3Rpb24pOwogICAgfQoKICAgIC8qKgogICAgICogQXNrIHRoZSByYWRpbyB0byBjb25uZWN0IHRvIHRoZSBpbnB1dCBuZXR3b3JrIGFuZCBjaGFuZ2Ugc2VsZWN0aW9uIG1vZGUgdG8gbWFudWFsLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdG9yTnVtZXJpYyB0aGUgUExNTiBJRCBvZiB0aGUgbmV0d29yayB0byBzZWxlY3QuCiAgICAgKiBAcGFyYW0gcGVyc2lzdFNlbGVjdGlvbiB3aGV0aGVyIHRoZSBzZWxlY3Rpb24gd2lsbCBwZXJzaXN0IHVudGlsIHJlYm9vdC4KICAgICAqICAgICAgICAgSWYgdHJ1ZSwgb25seSBhbGxvd3MgYXR0YWNoaW5nIHRvIHRoZSBzZWxlY3RlZCBQTE1OIHVudGlsIHJlYm9vdDsgb3RoZXJ3aXNlLAogICAgICogICAgICAgICBhdHRhY2ggdG8gdGhlIGNob3NlbiBQTE1OIGFuZCByZXN1bWUgbm9ybWFsIG5ldHdvcmsgc2VsZWN0aW9uIG5leHQgdGltZS4KICAgICAqIEBwYXJhbSByYW4gdGhlIGluaXRpYWwgc3VnZ2VzdGVkIHJhZGlvIGFjY2VzcyBuZXR3b3JrIHR5cGUuCiAgICAgKiAgICAgICAgIElmIHJlZ2lzdHJhdGlvbiBmYWlscywgdGhlIFJBTiBpcyBub3QgYXZhaWxhYmxlIGFmdGVyLCB0aGUgUkFOIGlzIG5vdCB3aXRoaW4gdGhlCiAgICAgKiAgICAgICAgIG5ldHdvcmsgdHlwZXMgc3BlY2lmaWVkIGJ5IHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlcywgb3IgdGhlIHZhbHVlIGlzCiAgICAgKiAgICAgICAgIHtAbGluayBBY2Nlc3NOZXR3b3JrQ29uc3RhbnRzLkFjY2Vzc05ldHdvcmtUeXBlI1VOS05PV059LCBtb2RlbSB3aWxsIHNlbGVjdAogICAgICogICAgICAgICB0aGUgbmV4dCBiZXN0IFJBTiBmb3IgbmV0d29yayByZWdpc3RyYXRpb24uCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBvbiBzdWNjZXNzOyB7QGNvZGUgZmFsc2V9IG9uIGFueSBmYWlsdXJlLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXROZXR3b3JrU2VsZWN0aW9uTW9kZU1hbnVhbChATm9uTnVsbCBTdHJpbmcgb3BlcmF0b3JOdW1lcmljLAogICAgICAgICAgICBib29sZWFuIHBlcnNpc3RTZWxlY3Rpb24sIEBBY2Nlc3NOZXR3b3JrQ29uc3RhbnRzLlJhZGlvQWNjZXNzTmV0d29ya1R5cGUgaW50IHJhbikgewogICAgICAgIHJldHVybiBzZXROZXR3b3JrU2VsZWN0aW9uTW9kZU1hbnVhbChuZXcgT3BlcmF0b3JJbmZvKCIiIC8qIG9wZXJhdG9yQWxwaGFMb25nICovLAogICAgICAgICAgICAgICAgIiIgLyogb3BlcmF0b3JBbHBoYVNob3J0ICovLCBvcGVyYXRvck51bWVyaWMsIHJhbiksIHBlcnNpc3RTZWxlY3Rpb24pOwogICAgfQoKICAgIC8qKgogICAgICogQXNrIHRoZSByYWRpbyB0byBjb25uZWN0IHRvIHRoZSBpbnB1dCBuZXR3b3JrIGFuZCBjaGFuZ2Ugc2VsZWN0aW9uIG1vZGUgdG8gbWFudWFsLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdG9ySW5mbyBpbmNsdWRlZCB0aGUgUExNTiBpZCwgbG9uZyBuYW1lLCBzaG9ydCBuYW1lIG9mIHRoZSBvcGVyYXRvciB0byBhdHRhY2ggdG8uCiAgICAgKiBAcGFyYW0gcGVyc2lzdFNlbGVjdGlvbiB3aGV0aGVyIHRoZSBzZWxlY3Rpb24gd2lsbCBwZXJzaXN0IHVudGlsIHJlYm9vdC4gSWYgdHJ1ZSwgb25seSBhbGxvd3MKICAgICAqIGF0dGFjaGluZyB0byB0aGUgc2VsZWN0ZWQgUExNTiB1bnRpbCByZWJvb3Q7IG90aGVyd2lzZSwgYXR0YWNoIHRvIHRoZSBjaG9zZW4gUExNTiBhbmQgcmVzdW1lCiAgICAgKiBub3JtYWwgbmV0d29yayBzZWxlY3Rpb24gbmV4dCB0aW1lLgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gb24gc3VjY2Vzczsge0Bjb2RlIHRydWV9IG9uIGFueSBmYWlsdXJlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldE5ldHdvcmtTZWxlY3Rpb25Nb2RlTWFudWFsKAogICAgICAgICAgICBPcGVyYXRvckluZm8gb3BlcmF0b3JJbmZvLCBib29sZWFuIHBlcnNpc3RTZWxlY3Rpb24pIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldE5ldHdvcmtTZWxlY3Rpb25Nb2RlTWFudWFsKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZCgpLCBvcGVyYXRvckluZm8sIHBlcnNpc3RTZWxlY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXROZXR3b3JrU2VsZWN0aW9uTW9kZU1hbnVhbCBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgIC8qKgogICAgICogR2V0IHRoZSBuZXR3b3JrIHNlbGVjdGlvbiBtb2RlLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKiAgPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSRUNJU0VfUEhPTkVfU1RBVEUKICAgICAqIFJFQURfUFJFQ0lTRV9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgbmV0d29yayBzZWxlY3Rpb24gbW9kZS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBObyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMgKGIvNzI5NjcyMzYpLgogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJFQ0lTRV9QSE9ORV9TVEFURQogICAgfSkKICAgIHB1YmxpYyBATmV0d29ya1NlbGVjdGlvbk1vZGUgaW50IGdldE5ldHdvcmtTZWxlY3Rpb25Nb2RlKCkgewogICAgICAgIGludCBtb2RlID0gTkVUV09SS19TRUxFQ1RJT05fTU9ERV9VTktOT1dOOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIG1vZGUgPSB0ZWxlcGhvbnkuZ2V0TmV0d29ya1NlbGVjdGlvbk1vZGUoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldE5ldHdvcmtTZWxlY3Rpb25Nb2RlIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1vZGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIFBMTU4gY2hvc2VuIGZvciBNYW51YWwgTmV0d29yayBTZWxlY3Rpb24gaWYgYWN0aXZlLgogICAgICogUmV0dXJuIGVtcHR5IHN0cmluZyBpZiBpbiBhdXRvbWF0aWMgc2VsZWN0aW9uLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUkVDSVNFX1BIT05FX1NUQVRFCiAgICAgKiBSRUFEX1BSRUNJU0VfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMKICAgICAqIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pCiAgICAgKgogICAgICogQHJldHVybiBtYW51YWxseSBzZWxlY3RlZCBuZXR3b3JrIGluZm8gb24gc3VjY2VzcyBvciBlbXB0eSBzdHJpbmcgb24gZmFpbHVyZQogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJFQ0lTRV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBTdHJpbmcgZ2V0TWFudWFsTmV0d29ya1NlbGVjdGlvblBsbW4oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCAmJiBpc01hbnVhbE5ldHdvcmtTZWxlY3Rpb25BbGxvd2VkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0TWFudWFsTmV0d29ya1NlbGVjdGlvblBsbW4oZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldE1hbnVhbE5ldHdvcmtTZWxlY3Rpb25QbG1uIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICIiOwogICAgfQoKICAgIC8qKgogICAgICogUXVlcnkgVGVsZXBob255IHRvIHNlZSBpZiB0aGVyZSBoYXMgcmVjZW50bHkgYmVlbiBhbiBlbWVyZ2VuY3kgU01TIHNlbnQgdG8gdGhlIG5ldHdvcmsgYnkgdGhlCiAgICAgKiB1c2VyIGFuZCB3ZSBhcmUgc3RpbGwgd2l0aGluIHRoZSB0aW1lIGludGVydmFsIGFmdGVyIHRoZSBlbWVyZ2VuY3kgU01TIHdhcyBzZW50IHRoYXQgd2UgYXJlCiAgICAgKiBjb25zaWRlcmVkIGluIEVtZXJnZW5jeSBTTVMgbW9kZS4KICAgICAqCiAgICAgKiA8cD5UaGlzIG1vZGUgaXMgdXNlZCBieSBvdGhlciBhcHBsaWNhdGlvbnMgdG8gYWxsb3cgdGhlbSB0byBwZXJmb3JtIHNwZWNpYWwgZnVuY3Rpb25hbGl0eSwKICAgICAqIHN1Y2ggYXMgYWxsb3cgdGhlIEdOU1Mgc2VydmljZSB0byBwcm92aWRlIHVzZXIgbG9jYXRpb24gdG8gdGhlIGNhcnJpZXIgbmV0d29yayBmb3IgZW1lcmdlbmN5CiAgICAgKiB3aGVuIGFuIGVtZXJnZW5jeSBTTVMgaXMgc2VudC4gVGhpcyBpbnRlcnZhbCBpcyBzZXQgYnkKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfRU1FUkdFTkNZX1NNU19NT0RFX1RJTUVSX01TX0lOVH0uIElmCiAgICAgKiB0aGUgY2FycmllciBkb2VzIG5vdCBzdXBwb3J0IHRoaXMgbW9kZSwgdGhpcyBmdW5jdGlvbiB3aWxsIGFsd2F5cyByZXR1cm4gZmFsc2UuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhpcyBkZXZpY2UgaXMgaW4gZW1lcmdlbmN5IFNNUyBtb2RlLCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0luRW1lcmdlbmN5U21zTW9kZSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmlzSW5FbWVyZ2VuY3lTbXNNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImlzSW5FbWVyZ2VuY3lTbXNNb2RlIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcKICAgICAqIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgaWQgb2YgdGhlIHN1YnNjcmlwdGlvbiB0byBzZXQgdGhlIHByZWZlcnJlZCBuZXR3b3JrIHR5cGUgZm9yLgogICAgICogQHBhcmFtIG5ldHdvcmtUeXBlIHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlCiAgICAgKiBAcmV0dXJuIHRydWUgb24gc3VjY2VzczsgZmFsc2Ugb24gYW55IGZhaWx1cmUuCiAgICAgKiBAaGlkZQogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjc2V0UHJlZmVycmVkTmV0d29ya1R5cGVCaXRtYXNrfSBpbnN0ZWFkLgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBib29sZWFuIHNldFByZWZlcnJlZE5ldHdvcmtUeXBlKGludCBzdWJJZCwgQFByZWZOZXR3b3JrTW9kZSBpbnQgbmV0d29ya1R5cGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldFByZWZlcnJlZE5ldHdvcmtUeXBlKHN1YklkLCBuZXR3b3JrVHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldFByZWZlcnJlZE5ldHdvcmtUeXBlIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlIGJpdG1hc2sgYnV0IGlmIHtAbGluayAjc2V0QWxsb3dlZE5ldHdvcmtUeXBlc30gaGFzIGJlZW4gc2V0LAogICAgICogb25seSB0aGUgYWxsb3dlZCBuZXR3b3JrIHR5cGUgd2lsbCBzZXQgdG8gdGhlIG1vZGVtLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIG5ldHdvcmtUeXBlQml0bWFzayBUaGUgYml0bWFzayBvZiBwcmVmZXJyZWQgbmV0d29yayB0eXBlcy4KICAgICAqIEByZXR1cm4gdHJ1ZSBvbiBzdWNjZXNzOyBmYWxzZSBvbiBhbnkgZmFpbHVyZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBib29sZWFuIHNldFByZWZlcnJlZE5ldHdvcmtUeXBlQml0bWFzayhATmV0d29ya1R5cGVCaXRNYXNrIGxvbmcgbmV0d29ya1R5cGVCaXRtYXNrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRQcmVmZXJyZWROZXR3b3JrVHlwZSgKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U3ViSWQoKSwgUmFkaW9BY2Nlc3NGYW1pbHkuZ2V0TmV0d29ya1R5cGVGcm9tUmFmKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpbnQpIG5ldHdvcmtUeXBlQml0bWFzaykpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXRQcmVmZXJyZWROZXR3b3JrVHlwZUJpdG1hc2sgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlcyBvZiB0aGUgZGV2aWNlLiBUaGlzIGlzIGZvciBjYXJyaWVyIG9yIHByaXZpbGVnZWQgYXBwcyB0bwogICAgICogZW5hYmxlL2Rpc2FibGUgY2VydGFpbiBuZXR3b3JrIHR5cGVzIG9uIHRoZSBkZXZpY2UuIFRoZSB1c2VyIHByZWZlcnJlZCBuZXR3b3JrIHR5cGVzIHNob3VsZAogICAgICogYmUgc2V0IHRocm91Z2gge0BsaW5rICNzZXRQcmVmZXJyZWROZXR3b3JrVHlwZUJpdG1hc2t9LgogICAgICoKICAgICAqIEBwYXJhbSBhbGxvd2VkTmV0d29ya1R5cGVzIFRoZSBiaXRtYXNrIG9mIGFsbG93ZWQgbmV0d29yayB0eXBlcy4KICAgICAqIEByZXR1cm4gdHJ1ZSBvbiBzdWNjZXNzOyBmYWxzZSBvbiBhbnkgZmFpbHVyZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBib29sZWFuIHNldEFsbG93ZWROZXR3b3JrVHlwZXMoQE5ldHdvcmtUeXBlQml0TWFzayBsb25nIGFsbG93ZWROZXR3b3JrVHlwZXMpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldEFsbG93ZWROZXR3b3JrVHlwZXMoZ2V0U3ViSWQoKSwgYWxsb3dlZE5ldHdvcmtUeXBlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldEFsbG93ZWROZXR3b3JrVHlwZXMgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBASW50RGVmKHsKICAgICAgICAgICAgQUxMT1dFRF9ORVRXT1JLX1RZUEVTX1JFQVNPTl9QT1dFUgogICAgfSkKICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIEFsbG93ZWROZXR3b3JrVHlwZXNSZWFzb257fQoKICAgIC8qKgogICAgICogVG8gaW5kaWNhdGUgYWxsb3dlZCBuZXR3b3JrIHR5cGUgY2hhbmdlIGlzIHJlcXVlc3RlZCBieSBwb3dlciBtYW5hZ2VyLgogICAgICogUG93ZXIgTWFuZ2VyIGNvbmZpZ3VyYXRpb24gd29uJ3QgYWZmZWN0IHRoZSBzZXR0aW5ncyBjb25maWd1cmVkIHRocm91Z2gKICAgICAqIHtAbGluayBzZXRBbGxvd2VkTmV0d29ya1R5cGVzfSBhbmQgd2lsbCByZXN1bHQgaW4gYWxsb3dpbmcgbmV0d29yayB0eXBlcyB0aGF0IGFyZSBpbiBib3RoCiAgICAgKiBjb25maWd1cmF0aW9ucyAoaS5lIGludGVyc2VjdGlvbiBvZiBib3RoIHNldHMpLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQUxMT1dFRF9ORVRXT1JLX1RZUEVTX1JFQVNPTl9QT1dFUiA9IDA7CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlcyBvZiB0aGUgZGV2aWNlIGFuZAogICAgICogcHJvdmlkZSB0aGUgcmVhc29uIHRyaWdnZXJpbmcgdGhlIGFsbG93ZWQgbmV0d29yayBjaGFuZ2UuCiAgICAgKiBUaGlzIGNhbiBiZSBjYWxsZWQgZm9yIGZvbGxvd2luZyByZWFzb25zCiAgICAgKiA8b2w+CiAgICAgKiA8bGk+QWxsb3dlZCBuZXR3b3JrIHR5cGVzIGNvbnRyb2wgYnkgcG93ZXIgbWFuYWdlcgogICAgICoge0BsaW5rICNBTExPV0VEX05FVFdPUktfVFlQRVNfUkVBU09OX1BPV0VSfQogICAgICogPC9vbD4KICAgICAqIFRoaXMgQVBJIHdpbGwgcmVzdWx0IGluIGFsbG93aW5nIGFuIGludGVyc2VjdGlvbiBvZiBhbGxvd2VkIG5ldHdvcmsgdHlwZXMgZm9yIGFsbCByZWFzb25zLAogICAgICogaW5jbHVkaW5nIHRoZSBjb25maWd1cmF0aW9uIGRvbmUgdGhyb3VnaCB7QGxpbmsgc2V0QWxsb3dlZE5ldHdvcmtUeXBlc30uCiAgICAgKiBXaGlsZSB0aGlzIEFQSSBhbmQge0BsaW5rIHNldEFsbG93ZWROZXR3b3JrVHlwZXN9IGlzIGNvbnRyb2xsaW5nIGFsbG93ZWQgbmV0d29yayB0eXBlcwogICAgICogb24gZGV2aWNlLCB1c2VyIHByZWZlcmVuY2Ugd2lsbCBzdGlsbCBiZSBzZXQgdGhyb3VnaCB7QGxpbmsgI3NldFByZWZlcnJlZE5ldHdvcmtUeXBlQml0bWFza30uCiAgICAgKiBUaHVzIHJlc3VsdGFudCBuZXR3b3JrIHR5cGUgY29uZmlndXJlZCBvbiBtb2RlbSB3aWxsIGJlIGFuIGludGVyc2VjdGlvbiBvZiB0aGUgbmV0d29yayB0eXBlcwogICAgICogZnJvbSBzZXRBbGxvd2VkTmV0d29ya1R5cGVzRm9yUmVhc29uLCB7QGxpbmsgc2V0QWxsb3dlZE5ldHdvcmtUeXBlc30KICAgICAqIGFuZCB7QGxpbmsgI3NldFByZWZlcnJlZE5ldHdvcmtUeXBlQml0bWFza30uCiAgICAgKgogICAgICogQHBhcmFtIHJlYXNvbiB0aGUgcmVhc29uIHRoZSBhbGxvd2VkIG5ldHdvcmsgdHlwZSBjaGFuZ2UgaXMgdGFraW5nIHBsYWNlCiAgICAgKiBAcGFyYW0gYWxsb3dlZE5ldHdvcmtUeXBlcyBUaGUgYml0bWFzayBvZiBhbGxvd2VkIG5ldHdvcmsgdHlwZXMuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgVGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBpbnZhbGlkIEFsbG93ZWROZXR3b3JrVHlwZXNSZWFzb24gaXMgcGFzc2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0QWxsb3dlZE5ldHdvcmtUeXBlc0ZvclJlYXNvbihAQWxsb3dlZE5ldHdvcmtUeXBlc1JlYXNvbiBpbnQgcmVhc29uLAogICAgICAgICAgICBATmV0d29ya1R5cGVCaXRNYXNrIGxvbmcgYWxsb3dlZE5ldHdvcmtUeXBlcykgewogICAgICAgIGlmIChyZWFzb24gIT0gQUxMT1dFRF9ORVRXT1JLX1RZUEVTX1JFQVNPTl9QT1dFUikgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJpbnZhbGlkIEFsbG93ZWROZXR3b3JrVHlwZXNSZWFzb24uIik7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRBbGxvd2VkTmV0d29ya1R5cGVzRm9yUmVhc29uKGdldFN1YklkKCksIHJlYXNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dlZE5ldHdvcmtUeXBlcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXRBbGxvd2VkTmV0d29ya1R5cGVzRm9yUmVhc29uIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0Zyb21TeXN0ZW1TZXJ2ZXIoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlcyBmb3IgY2VydGFpbiByZWFzb24uCiAgICAgKgogICAgICoge0BsaW5rICNnZXRBbGxvd2VkTmV0d29ya1R5cGVzRm9yUmVhc29ufSByZXR1cm5zIGFsbG93ZWQgbmV0d29yayB0eXBlIGZvciBhCiAgICAgKiBzcGVjaWZpYyByZWFzb24uIEZvciBlZmZlY3RpdmUgYWxsb3dlZCBuZXR3b3JrIHR5cGVzIGNvbmZpZ3VyZWQgb24gZGV2aWNlLAogICAgICogcXVlcnkge0BsaW5rIGdldEVmZmVjdGl2ZUFsbG93ZWROZXR3b3JrVHlwZXN9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKnMKICAgICAqIEBwYXJhbSByZWFzb24gdGhlIHJlYXNvbiB0aGUgYWxsb3dlZCBuZXR3b3JrIHR5cGUgY2hhbmdlIGlzIHRha2luZyBwbGFjZQogICAgICogQHJldHVybiB0aGUgYWxsb3dlZCBuZXR3b3JrIHR5cGUgYml0bWFzawogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgdGhlIFRlbGVwaG9ueSBwcm9jZXNzIGlzIG5vdCBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgaW52YWxpZCBBbGxvd2VkTmV0d29ya1R5cGVzUmVhc29uIGlzIHBhc3NlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATmV0d29ya1R5cGVCaXRNYXNrIGxvbmcgZ2V0QWxsb3dlZE5ldHdvcmtUeXBlc0ZvclJlYXNvbigKICAgICAgICAgICAgQEFsbG93ZWROZXR3b3JrVHlwZXNSZWFzb24gaW50IHJlYXNvbikgewogICAgICAgIGlmIChyZWFzb24gIT0gQUxMT1dFRF9ORVRXT1JLX1RZUEVTX1JFQVNPTl9QT1dFUikgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJpbnZhbGlkIEFsbG93ZWROZXR3b3JrVHlwZXNSZWFzb24uIik7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0QWxsb3dlZE5ldHdvcmtUeXBlc0ZvclJlYXNvbihnZXRTdWJJZCgpLCByZWFzb24pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0QWxsb3dlZE5ldHdvcmtUeXBlc0ZvclJlYXNvbiBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgICAgIGV4LnJldGhyb3dGcm9tU3lzdGVtU2VydmVyKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBiaXQgbWFzayBvZiBhbGwgbmV0d29yayB0eXBlcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIGJpdCBtYXNrIG9mIGFsbCBuZXR3b3JrIHR5cGVzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIEBOZXR3b3JrVHlwZUJpdE1hc2sgbG9uZyBnZXRBbGxOZXR3b3JrVHlwZXNCaXRtYXNrKCkgewogICAgICAgIHJldHVybiBORVRXT1JLX1NUQU5EQVJEU19GQU1JTFlfQklUTUFTS18zR1BQIHwgTkVUV09SS19TVEFOREFSRFNfRkFNSUxZX0JJVE1BU0tfM0dQUDI7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlcyBjb25maWd1cmVkIG9uIHRoZSBkZXZpY2UuCiAgICAgKiBUaGlzIEFQSSB3aWxsIHJldHVybiBhbiBpbnRlcnNlY3Rpb24gb2YgYWxsb3dlZCBuZXR3b3JrIHR5cGVzIGZvciBhbGwgcmVhc29ucywKICAgICAqIGluY2x1ZGluZyB0aGUgY29uZmlndXJhdGlvbiBkb25lIHRocm91Z2ggc2V0QWxsb3dlZE5ldHdvcmtUeXBlcwogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGFsbG93ZWQgbmV0d29yayB0eXBlIGJpdG1hc2sKICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIHRoZSBUZWxlcGhvbnkgcHJvY2VzcyBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATmV0d29ya1R5cGVCaXRNYXNrIGxvbmcgZ2V0RWZmZWN0aXZlQWxsb3dlZE5ldHdvcmtUeXBlcygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldEVmZmVjdGl2ZUFsbG93ZWROZXR3b3JrVHlwZXMoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRFZmZlY3RpdmVBbGxvd2VkTmV0d29ya1R5cGVzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0Zyb21TeXN0ZW1TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlIHRvIGdsb2JhbCBtb2RlIHdoaWNoIGluY2x1ZGVzIExURSwgQ0RNQSwgRXZEbyBhbmQgR1NNL1dDRE1BLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB0cnVlIG9uIHN1Y2Nlc3M7IGZhbHNlIG9uIGFueSBmYWlsdXJlLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRQcmVmZXJyZWROZXR3b3JrVHlwZVRvR2xvYmFsKCkgewogICAgICAgIHJldHVybiBzZXRQcmVmZXJyZWROZXR3b3JrVHlwZVRvR2xvYmFsKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBwcmVmZXJyZWQgbmV0d29yayB0eXBlIHRvIGdsb2JhbCBtb2RlIHdoaWNoIGluY2x1ZGVzIExURSwgQ0RNQSwgRXZEbyBhbmQgR1NNL1dDRE1BLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB0cnVlIG9uIHN1Y2Nlc3M7IGZhbHNlIG9uIGFueSBmYWlsdXJlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0UHJlZmVycmVkTmV0d29ya1R5cGVUb0dsb2JhbChpbnQgc3ViSWQpIHsKICAgICAgICByZXR1cm4gc2V0UHJlZmVycmVkTmV0d29ya1R5cGUoc3ViSWQsIFJJTENvbnN0YW50cy5ORVRXT1JLX01PREVfTFRFX0NETUFfRVZET19HU01fV0NETUEpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgd2hldGhlciBEVU4gQVBOIGlzIHJlcXVpcmVkIGZvciB0ZXRoZXJpbmcuCiAgICAgKiA8cD4KICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IE1PRElGWV9QSE9ORV9TVEFURS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBEVU4gQVBOIGlzIHJlcXVpcmVkIGZvciB0ZXRoZXJpbmcuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiBpc1RldGhlcmluZ0FwblJlcXVpcmVkKCkgewogICAgICAgIHJldHVybiBpc1RldGhlcmluZ0FwblJlcXVpcmVkKGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QWN0aXZlRGF0YVN1YnNjcmlwdGlvbklkKCkpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrIHdoZXRoZXIgRFVOIEFQTiBpcyByZXF1aXJlZCBmb3IgdGV0aGVyaW5nIHdpdGggc3ViSWQuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHRoZSBpZCBvZiB0aGUgc3Vic2NyaXB0aW9uIHRvIHJlcXVpcmUgdGV0aGVyaW5nLgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgRFVOIEFQTiBpcyByZXF1aXJlZCBmb3IgdGV0aGVyaW5nLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNUZXRoZXJpbmdBcG5SZXF1aXJlZChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pc1RldGhlcmluZ0FwblJlcXVpcmVkRm9yU3Vic2NyaWJlcihzdWJJZCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJoYXNNYXRjaGVkVGV0aGVyQXBuU2V0dGluZyBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImhhc01hdGNoZWRUZXRoZXJBcG5TZXR0aW5nIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKCiAgICAvKioKICAgICAqIFZhbHVlcyB1c2VkIHRvIHJldHVybiBzdGF0dXMgZm9yIGhhc0NhcnJpZXJQcml2aWxlZ2VzIGNhbGwuCiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLyBAU3lzdGVtQXBpIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQVJSSUVSX1BSSVZJTEVHRV9TVEFUVVNfSEFTX0FDQ0VTUyA9IDE7CiAgICAvKiogQGhpZGUgKi8gQFN5c3RlbUFwaSBAVGVzdEFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX05PX0FDQ0VTUyA9IDA7CiAgICAvKiogQGhpZGUgKi8gQFN5c3RlbUFwaSBAVGVzdEFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX1JVTEVTX05PVF9MT0FERUQgPSAtMTsKICAgIC8qKiBAaGlkZSAqLyBAU3lzdGVtQXBpIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQVJSSUVSX1BSSVZJTEVHRV9TVEFUVVNfRVJST1JfTE9BRElOR19SVUxFUyA9IC0yOwoKICAgIC8qKgogICAgICogSGFzIHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uIGJlZW4gZ3JhbnRlZCBjYXJyaWVyIHByaXZpbGVnZXMgYnkgdGhlIGNhcnJpZXIuCiAgICAgKgogICAgICogSWYgYW55IG9mIHRoZSBwYWNrYWdlcyBpbiB0aGUgY2FsbGluZyBVSUQgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcywgdGhlCiAgICAgKiBjYWxsIHdpbGwgcmV0dXJuIHRydWUuIFRoaXMgYWNjZXNzIGlzIGdyYW50ZWQgYnkgdGhlIG93bmVyIG9mIHRoZSBVSUNDCiAgICAgKiBjYXJkIGFuZCBkb2VzIG5vdCBkZXBlbmQgb24gdGhlIHJlZ2lzdGVyZWQgY2Fycmllci4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgdGhpcyBBUEkgYXBwbGllcyB0byBib3RoIHBoeXNpY2FsIGFuZCBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIGFuZAogICAgICogaXMgYSBzdXBlcnNldCBvZiB0aGUgY2hlY2tzIGRvbmUgaW4gU3Vic2NyaXB0aW9uTWFuYWdlciNjYW5NYW5hZ2VTdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcy4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaGFzQ2FycmllclByaXZpbGVnZXMoKSB7CiAgICAgICAgcmV0dXJuIGhhc0NhcnJpZXJQcml2aWxlZ2VzKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogSGFzIHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uIGJlZW4gZ3JhbnRlZCBjYXJyaWVyIHByaXZpbGVnZXMgYnkgdGhlIGNhcnJpZXIuCiAgICAgKgogICAgICogSWYgYW55IG9mIHRoZSBwYWNrYWdlcyBpbiB0aGUgY2FsbGluZyBVSUQgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcywgdGhlCiAgICAgKiBjYWxsIHdpbGwgcmV0dXJuIHRydWUuIFRoaXMgYWNjZXNzIGlzIGdyYW50ZWQgYnkgdGhlIG93bmVyIG9mIHRoZSBVSUNDCiAgICAgKiBjYXJkIGFuZCBkb2VzIG5vdCBkZXBlbmQgb24gdGhlIHJlZ2lzdGVyZWQgY2Fycmllci4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgdGhpcyBBUEkgYXBwbGllcyB0byBib3RoIHBoeXNpY2FsIGFuZCBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIGFuZAogICAgICogaXMgYSBzdXBlcnNldCBvZiB0aGUgY2hlY2tzIGRvbmUgaW4gU3Vic2NyaXB0aW9uTWFuYWdlciNjYW5NYW5hZ2VTdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIFRoZSBzdWJzY3JpcHRpb24gdG8gdXNlLgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGhhc0NhcnJpZXJQcml2aWxlZ2VzKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2FycmllclByaXZpbGVnZVN0YXR1cyhzdWJJZCkKICAgICAgICAgICAgICAgICAgICAgICAgPT0gQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX0hBU19BQ0NFU1M7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImhhc0NhcnJpZXJQcml2aWxlZ2VzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiaGFzQ2FycmllclByaXZpbGVnZXMgTlBFIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBPdmVycmlkZSB0aGUgYnJhbmRpbmcgZm9yIHRoZSBjdXJyZW50IElDQ0lELgogICAgICoKICAgICAqIE9uY2Ugc2V0LCB3aGVuZXZlciB0aGUgU0lNIGlzIHByZXNlbnQgaW4gdGhlIGRldmljZSwgdGhlIHNlcnZpY2UKICAgICAqIHByb3ZpZGVyIG5hbWUgKFNQTikgYW5kIHRoZSBvcGVyYXRvciBuYW1lIHdpbGwgYm90aCBiZSByZXBsYWNlZCBieSB0aGUKICAgICAqIGJyYW5kIHZhbHVlIGlucHV0LiBUbyB1bnNldCB0aGUgdmFsdWUsIHRoZSBzYW1lIGZ1bmN0aW9uIHNob3VsZCBiZQogICAgICogY2FsbGVkIHdpdGggYSBudWxsIGJyYW5kIHZhbHVlLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGJyYW5kIFRoZSBicmFuZCBuYW1lIHRvIGRpc3BsYXkvc2V0LgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBvcGVyYXRpb24gd2FzIGV4ZWN1dGVkIGNvcnJlY3RseS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0T3BlcmF0b3JCcmFuZE92ZXJyaWRlKFN0cmluZyBicmFuZCkgewogICAgICAgIHJldHVybiBzZXRPcGVyYXRvckJyYW5kT3ZlcnJpZGUoZ2V0U3ViSWQoKSwgYnJhbmQpOwogICAgfQoKICAgIC8qKgogICAgICogT3ZlcnJpZGUgdGhlIGJyYW5kaW5nIGZvciB0aGUgY3VycmVudCBJQ0NJRC4KICAgICAqCiAgICAgKiBPbmNlIHNldCwgd2hlbmV2ZXIgdGhlIFNJTSBpcyBwcmVzZW50IGluIHRoZSBkZXZpY2UsIHRoZSBzZXJ2aWNlCiAgICAgKiBwcm92aWRlciBuYW1lIChTUE4pIGFuZCB0aGUgb3BlcmF0b3IgbmFtZSB3aWxsIGJvdGggYmUgcmVwbGFjZWQgYnkgdGhlCiAgICAgKiBicmFuZCB2YWx1ZSBpbnB1dC4gVG8gdW5zZXQgdGhlIHZhbHVlLCB0aGUgc2FtZSBmdW5jdGlvbiBzaG91bGQgYmUKICAgICAqIGNhbGxlZCB3aXRoIGEgbnVsbCBicmFuZCB2YWx1ZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIHRvIHVzZS4KICAgICAqIEBwYXJhbSBicmFuZCBUaGUgYnJhbmQgbmFtZSB0byBkaXNwbGF5L3NldC4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgb3BlcmF0aW9uIHdhcyBleGVjdXRlZCBjb3JyZWN0bHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRPcGVyYXRvckJyYW5kT3ZlcnJpZGUoaW50IHN1YklkLCBTdHJpbmcgYnJhbmQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRPcGVyYXRvckJyYW5kT3ZlcnJpZGUoc3ViSWQsIGJyYW5kKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldE9wZXJhdG9yQnJhbmRPdmVycmlkZSBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldE9wZXJhdG9yQnJhbmRPdmVycmlkZSBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIE92ZXJyaWRlIHRoZSByb2FtaW5nIHByZWZlcmVuY2UgZm9yIHRoZSBjdXJyZW50IElDQ0lELgogICAgICoKICAgICAqIFVzaW5nIHRoaXMgY2FsbCwgdGhlIGNhcnJpZXIgYXBwIChzZWUgI2hhc0NhcnJpZXJQcml2aWxlZ2VzKSBjYW4gb3ZlcnJpZGUKICAgICAqIHRoZSBwbGF0Zm9ybSdzIG5vdGlvbiBvZiBhIG5ldHdvcmsgb3BlcmF0b3IgYmVpbmcgY29uc2lkZXJlZCByb2FtaW5nIG9yIG5vdC4KICAgICAqIFRoZSBjaGFuZ2Ugb25seSBhZmZlY3RzIHRoZSBJQ0NJRCB0aGF0IHdhcyBhY3RpdmUgd2hlbiB0aGlzIGNhbGwgd2FzIG1hZGUuCiAgICAgKgogICAgICogSWYgbnVsbCBpcyBwYXNzZWQgYXMgYW55IG9mIHRoZSBpbnB1dCwgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgaXMgZGVsZXRlZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGF0IHRoZSBjYWxsZXIgaGF2ZSBjYXJyaWVyIHByaXZpbGVnZS4gU2VlICNoYXNDYXJyaWVyUHJpdmlsZWdlcy4KICAgICAqCiAgICAgKiBAcGFyYW0gZ3NtUm9hbWluZ0xpc3QgLSBMaXN0IG9mIE1DQ01OQ3MgdG8gYmUgY29uc2lkZXJlZCByb2FtaW5nIGZvciAzR1BQIFJBVHMuCiAgICAgKiBAcGFyYW0gZ3NtTm9uUm9hbWluZ0xpc3QgLSBMaXN0IG9mIE1DQ01OQ3MgdG8gYmUgY29uc2lkZXJlZCBub3Qgcm9hbWluZyBmb3IgM0dQUCBSQVRzLgogICAgICogQHBhcmFtIGNkbWFSb2FtaW5nTGlzdCAtIExpc3Qgb2YgU0lEcyB0byBiZSBjb25zaWRlcmVkIHJvYW1pbmcgZm9yIDNHUFAyIFJBVHMuCiAgICAgKiBAcGFyYW0gY2RtYU5vblJvYW1pbmdMaXN0IC0gTGlzdCBvZiBTSURzIHRvIGJlIGNvbnNpZGVyZWQgbm90IHJvYW1pbmcgZm9yIDNHUFAyIFJBVHMuCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIG9wZXJhdGlvbiB3YXMgZXhlY3V0ZWQgY29ycmVjdGx5LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRSb2FtaW5nT3ZlcnJpZGUoTGlzdDxTdHJpbmc+IGdzbVJvYW1pbmdMaXN0LAogICAgICAgICAgICBMaXN0PFN0cmluZz4gZ3NtTm9uUm9hbWluZ0xpc3QsIExpc3Q8U3RyaW5nPiBjZG1hUm9hbWluZ0xpc3QsCiAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBjZG1hTm9uUm9hbWluZ0xpc3QpIHsKICAgICAgICByZXR1cm4gc2V0Um9hbWluZ092ZXJyaWRlKGdldFN1YklkKCksIGdzbVJvYW1pbmdMaXN0LCBnc21Ob25Sb2FtaW5nTGlzdCwKICAgICAgICAgICAgICAgIGNkbWFSb2FtaW5nTGlzdCwgY2RtYU5vblJvYW1pbmdMaXN0KTsKICAgIH0KCiAgICAvKioKICAgICAqIE92ZXJyaWRlIHRoZSByb2FtaW5nIHByZWZlcmVuY2UgZm9yIHRoZSBjdXJyZW50IElDQ0lELgogICAgICoKICAgICAqIFVzaW5nIHRoaXMgY2FsbCwgdGhlIGNhcnJpZXIgYXBwIChzZWUgI2hhc0NhcnJpZXJQcml2aWxlZ2VzKSBjYW4gb3ZlcnJpZGUKICAgICAqIHRoZSBwbGF0Zm9ybSdzIG5vdGlvbiBvZiBhIG5ldHdvcmsgb3BlcmF0b3IgYmVpbmcgY29uc2lkZXJlZCByb2FtaW5nIG9yIG5vdC4KICAgICAqIFRoZSBjaGFuZ2Ugb25seSBhZmZlY3RzIHRoZSBJQ0NJRCB0aGF0IHdhcyBhY3RpdmUgd2hlbiB0aGlzIGNhbGwgd2FzIG1hZGUuCiAgICAgKgogICAgICogSWYgbnVsbCBpcyBwYXNzZWQgYXMgYW55IG9mIHRoZSBpbnB1dCwgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgaXMgZGVsZXRlZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGF0IHRoZSBjYWxsZXIgaGF2ZSBjYXJyaWVyIHByaXZpbGVnZS4gU2VlICNoYXNDYXJyaWVyUHJpdmlsZWdlcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgZm9yIHdoaWNoIHRoZSByb2FtaW5nIG92ZXJyaWRlcyBhcHBseS4KICAgICAqIEBwYXJhbSBnc21Sb2FtaW5nTGlzdCAtIExpc3Qgb2YgTUNDTU5DcyB0byBiZSBjb25zaWRlcmVkIHJvYW1pbmcgZm9yIDNHUFAgUkFUcy4KICAgICAqIEBwYXJhbSBnc21Ob25Sb2FtaW5nTGlzdCAtIExpc3Qgb2YgTUNDTU5DcyB0byBiZSBjb25zaWRlcmVkIG5vdCByb2FtaW5nIGZvciAzR1BQIFJBVHMuCiAgICAgKiBAcGFyYW0gY2RtYVJvYW1pbmdMaXN0IC0gTGlzdCBvZiBTSURzIHRvIGJlIGNvbnNpZGVyZWQgcm9hbWluZyBmb3IgM0dQUDIgUkFUcy4KICAgICAqIEBwYXJhbSBjZG1hTm9uUm9hbWluZ0xpc3QgLSBMaXN0IG9mIFNJRHMgdG8gYmUgY29uc2lkZXJlZCBub3Qgcm9hbWluZyBmb3IgM0dQUDIgUkFUcy4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgb3BlcmF0aW9uIHdhcyBleGVjdXRlZCBjb3JyZWN0bHkuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gc2V0Um9hbWluZ092ZXJyaWRlKGludCBzdWJJZCwgTGlzdDxTdHJpbmc+IGdzbVJvYW1pbmdMaXN0LAogICAgICAgICAgICBMaXN0PFN0cmluZz4gZ3NtTm9uUm9hbWluZ0xpc3QsIExpc3Q8U3RyaW5nPiBjZG1hUm9hbWluZ0xpc3QsCiAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBjZG1hTm9uUm9hbWluZ0xpc3QpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRSb2FtaW5nT3ZlcnJpZGUoc3ViSWQsIGdzbVJvYW1pbmdMaXN0LCBnc21Ob25Sb2FtaW5nTGlzdCwKICAgICAgICAgICAgICAgICAgICAgICAgY2RtYVJvYW1pbmdMaXN0LCBjZG1hTm9uUm9hbWluZ0xpc3QpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0Um9hbWluZ092ZXJyaWRlIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0Um9hbWluZ092ZXJyaWRlIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogRXhwb3NlIHRoZSByZXN0IG9mIElUZWxlcGhvbnkgdG8gQFN5c3RlbUFwaQogICAgICovCgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldENkbWFNZG4oKSB7CiAgICAgICAgcmV0dXJuIGdldENkbWFNZG4oZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldENkbWFNZG4oaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldENkbWFNZG4oc3ViSWQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldENkbWFNaW4oKSB7CiAgICAgICAgcmV0dXJuIGdldENkbWFNaW4oZ2V0U3ViSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3RyaW5nIGdldENkbWFNaW4oaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldENkbWFNaW4oc3ViSWQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAVGVzdEFwaQogICAgQFN1cHByZXNzTGludCgiRG9jbGF2YTEyNSIpCiAgICBwdWJsaWMgaW50IGNoZWNrQ2FycmllclByaXZpbGVnZXNGb3JQYWNrYWdlKFN0cmluZyBwa2dOYW1lKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuY2hlY2tDYXJyaWVyUHJpdmlsZWdlc0ZvclBhY2thZ2UoZ2V0U3ViSWQoKSwgcGtnTmFtZSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJjaGVja0NhcnJpZXJQcml2aWxlZ2VzRm9yUGFja2FnZSBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImNoZWNrQ2FycmllclByaXZpbGVnZXNGb3JQYWNrYWdlIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENBUlJJRVJfUFJJVklMRUdFX1NUQVRVU19OT19BQ0NFU1M7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAU3VwcHJlc3NMaW50KCJEb2NsYXZhMTI1IikKICAgIHB1YmxpYyBpbnQgY2hlY2tDYXJyaWVyUHJpdmlsZWdlc0ZvclBhY2thZ2VBbnlQaG9uZShTdHJpbmcgcGtnTmFtZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmNoZWNrQ2FycmllclByaXZpbGVnZXNGb3JQYWNrYWdlQW55UGhvbmUocGtnTmFtZSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJjaGVja0NhcnJpZXJQcml2aWxlZ2VzRm9yUGFja2FnZUFueVBob25lIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiY2hlY2tDYXJyaWVyUHJpdmlsZWdlc0ZvclBhY2thZ2VBbnlQaG9uZSBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDQVJSSUVSX1BSSVZJTEVHRV9TVEFUVVNfTk9fQUNDRVNTOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFN5c3RlbUFwaQogICAgQFRlc3RBcGkKICAgIHB1YmxpYyBMaXN0PFN0cmluZz4gZ2V0Q2FycmllclBhY2thZ2VOYW1lc0ZvckludGVudChJbnRlbnQgaW50ZW50KSB7CiAgICAgICAgcmV0dXJuIGdldENhcnJpZXJQYWNrYWdlTmFtZXNGb3JJbnRlbnRBbmRQaG9uZShpbnRlbnQsIGdldFBob25lSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgTGlzdDxTdHJpbmc+IGdldENhcnJpZXJQYWNrYWdlTmFtZXNGb3JJbnRlbnRBbmRQaG9uZShJbnRlbnQgaW50ZW50LCBpbnQgcGhvbmVJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldENhcnJpZXJQYWNrYWdlTmFtZXNGb3JJbnRlbnRBbmRQaG9uZShpbnRlbnQsIHBob25lSWQpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0Q2FycmllclBhY2thZ2VOYW1lc0ZvckludGVudEFuZFBob25lIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0Q2FycmllclBhY2thZ2VOYW1lc0ZvckludGVudEFuZFBob25lIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgTGlzdDxTdHJpbmc+IGdldFBhY2thZ2VzV2l0aENhcnJpZXJQcml2aWxlZ2VzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0UGFja2FnZXNXaXRoQ2FycmllclByaXZpbGVnZXMoZ2V0UGhvbmVJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0UGFja2FnZXNXaXRoQ2FycmllclByaXZpbGVnZXMgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRQYWNrYWdlc1dpdGhDYXJyaWVyUHJpdmlsZWdlcyBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDb2xsZWN0aW9ucy5FTVBUWV9MSVNUOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBuYW1lcyBvZiBwYWNrYWdlcyB3aXRoIGNhcnJpZXIgcHJpdmlsZWdlcyBmb3IgYWxsIHRoZSBhY3RpdmUgc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBATm9uTnVsbAogICAgcHVibGljIExpc3Q8U3RyaW5nPiBnZXRDYXJyaWVyUHJpdmlsZWdlZFBhY2thZ2VzRm9yQWxsQWN0aXZlU3Vic2NyaXB0aW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldFBhY2thZ2VzV2l0aENhcnJpZXJQcml2aWxlZ2VzRm9yQWxsUGhvbmVzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldENhcnJpZXJQcml2aWxlZ2VkUGFja2FnZXNGb3JBbGxBY3RpdmVTdWJzY3JpcHRpb25zIFJlbW90ZUV4Y2VwdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJnZXRDYXJyaWVyUHJpdmlsZWdlZFBhY2thZ2VzRm9yQWxsQWN0aXZlU3Vic2NyaXB0aW9ucyBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDb2xsZWN0aW9ucy5FTVBUWV9MSVNUOwogICAgfQoKCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkRvY2xhdmExMjUiKQogICAgcHVibGljIHZvaWQgZGlhbChTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5kaWFsKG51bWJlcik7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2RpYWwiLCBlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBVc2UgIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjcGxhY2VDYWxsKFVyaSBhZGRyZXNzLAogICAgICogQnVuZGxlIGV4dHJhcyl9IGluc3RlYWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uQ0FMTF9QSE9ORSkKICAgIHB1YmxpYyB2b2lkIGNhbGwoU3RyaW5nIGNhbGxpbmdQYWNrYWdlLCBTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5jYWxsKGNhbGxpbmdQYWNrYWdlLCBudW1iZXIpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNjYWxsIiwgZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQHJlbW92ZWQgVXNlIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjZW5kQ2FsbCgpfSBpbnN0ZWFkLgogICAgICogQGhpZGUKICAgICAqIEByZW1vdmVkCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5DQUxMX1BIT05FKQogICAgcHVibGljIGJvb2xlYW4gZW5kQ2FsbCgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmVtb3ZlZCBVc2Uge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5UZWxlY29tTWFuYWdlciNhY2NlcHRSaW5naW5nQ2FsbH0gaW5zdGVhZAogICAgICogQGhpZGUKICAgICAqIEByZW1vdmVkCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBhbnN3ZXJSaW5naW5nQ2FsbCgpIHsKICAgICAgICAvLyBOby1vcAogICAgfQoKICAgIC8qKgogICAgICogQHJlbW92ZWQgVXNlIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjc2lsZW5jZVJpbmdlcn0gaW5zdGVhZAogICAgICogQGhpZGUKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkRvY2xhdmExMjUiKQogICAgcHVibGljIHZvaWQgc2lsZW5jZVJpbmdlcigpIHsKICAgICAgICAvLyBOby1vcAogICAgfQoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjaXNJbkNhbGx9IGluc3RlYWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFueU9mID0gewogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLAogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURQogICAgfSkKICAgIHB1YmxpYyBib29sZWFuIGlzT2ZmaG9vaygpIHsKICAgICAgICBUZWxlY29tTWFuYWdlciB0bSA9IChUZWxlY29tTWFuYWdlcikgbUNvbnRleHQuZ2V0U3lzdGVtU2VydmljZShURUxFQ09NX1NFUlZJQ0UpOwogICAgICAgIHJldHVybiB0bS5pc0luQ2FsbCgpOwogICAgfQoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnRlbGVjb20uVGVsZWNvbU1hbmFnZXIjaXNSaW5naW5nfSBpbnN0ZWFkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUKICAgIH0pCiAgICBwdWJsaWMgYm9vbGVhbiBpc1JpbmdpbmcoKSB7CiAgICAgICAgVGVsZWNvbU1hbmFnZXIgdG0gPSAoVGVsZWNvbU1hbmFnZXIpIG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoVEVMRUNPTV9TRVJWSUNFKTsKICAgICAgICByZXR1cm4gdG0uaXNSaW5naW5nKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQudGVsZWNvbS5UZWxlY29tTWFuYWdlciNpc0luQ2FsbH0gaW5zdGVhZAogICAgICogQGhpZGUKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW55T2YgPSB7CiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFCiAgICB9KQogICAgcHVibGljIGJvb2xlYW4gaXNJZGxlKCkgewogICAgICAgIFRlbGVjb21NYW5hZ2VyIHRtID0gKFRlbGVjb21NYW5hZ2VyKSBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKFRFTEVDT01fU0VSVklDRSk7CiAgICAgICAgcmV0dXJuICF0bS5pc0luQ2FsbCgpOwogICAgfQoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2dldFNlcnZpY2VTdGF0ZX0gaW5zdGVhZAogICAgICogQGhpZGUKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW55T2YgPSB7CiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFCiAgICB9KQogICAgcHVibGljIGJvb2xlYW4gaXNSYWRpb09uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmlzUmFkaW9PbldpdGhGZWF0dXJlKGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzUmFkaW9PbiIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzdXBwbHlQaW4oU3RyaW5nIHBpbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnN1cHBseVBpbkZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcGluKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc3VwcGx5UGluRm9yU3Vic2NyaWJlciIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzdXBwbHlQdWsoU3RyaW5nIHB1aywgU3RyaW5nIHBpbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnN1cHBseVB1a0ZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcHVrLCBwaW4pOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzdXBwbHlQdWtGb3JTdWJzY3JpYmVyIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnRbXSBzdXBwbHlQaW5SZXBvcnRSZXN1bHQoU3RyaW5nIHBpbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnN1cHBseVBpblJlcG9ydFJlc3VsdEZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcGluKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc3VwcGx5UGluUmVwb3J0UmVzdWx0Rm9yU3Vic2NyaWJlciIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IGludFswXTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnRbXSBzdXBwbHlQdWtSZXBvcnRSZXN1bHQoU3RyaW5nIHB1aywgU3RyaW5nIHBpbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnN1cHBseVB1a1JlcG9ydFJlc3VsdEZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcHVrLCBwaW4pOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNdIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgaW50WzBdOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCB3aGVuIHRoZSB1c2VyIGF0dGVtcHRzIHRvIGVudGVyIHRoZWlyIHBpbi4KICAgICAqCiAgICAgKiBAcGFyYW0gcGluIFRoZSB1c2VyIGVudGVyZWQgcGluLgogICAgICogQHJldHVybiBUaGUgcmVzdWx0IG9mIHRoZSBwaW4uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQE51bGxhYmxlCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgUGluUmVzdWx0IHN1cHBseVBpblJlcG9ydFBpblJlc3VsdChATm9uTnVsbCBTdHJpbmcgcGluKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW50W10gcmVzdWx0ID0gdGVsZXBob255LnN1cHBseVBpblJlcG9ydFJlc3VsdEZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcGluKTsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUGluUmVzdWx0KHJlc3VsdFswXSwgcmVzdWx0WzFdKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzdXBwbHlQaW5SZXBvcnRSZXN1bHRGb3JTdWJzY3JpYmVyIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCB3aGVuIHRoZSB1c2VyIGF0dGVtcHRzIHRvIGVudGVyIHRoZSBwdWsgb3IgdGhlaXIgcGluLgogICAgICoKICAgICAqIEBwYXJhbSBwdWsgVGhlIHByb2R1Y3QgdW5ibG9ja2luZyBrZXkuCiAgICAgKiBAcGFyYW0gcGluIFRoZSB1c2VyIGVudGVyZWQgcGluLgogICAgICogQHJldHVybiBUaGUgcmVzdWx0IG9mIHRoZSBwaW4uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQE51bGxhYmxlCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgUGluUmVzdWx0IHN1cHBseVB1a1JlcG9ydFBpblJlc3VsdChATm9uTnVsbCBTdHJpbmcgcHVrLCBATm9uTnVsbCBTdHJpbmcgcGluKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW50W10gcmVzdWx0ID0gdGVsZXBob255LnN1cHBseVB1a1JlcG9ydFJlc3VsdEZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSwgcHVrLCBwaW4pOwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQaW5SZXN1bHQocmVzdWx0WzBdLCByZXN1bHRbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I10iLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIG5vdGlmeSBjYWxsZXJzIG9mCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNzZW5kVXNzZFJlcXVlc3QoU3RyaW5nLCBVc3NkUmVzcG9uc2VDYWxsYmFjaywgSGFuZGxlcil9IHdoZW4gdGhlCiAgICAgKiBuZXR3b3JrIGVpdGhlciBzdWNjZXNzZnVsbHkgZXhlY3V0ZXMgYSBVU1NEIHJlcXVlc3QsIG9yIGlmIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUKICAgICAqIGV4ZWN1dGluZyB0aGUgcmVxdWVzdC4KICAgICAqIDxwPgogICAgICoge0BsaW5rICNvblJlY2VpdmVVc3NkUmVzcG9uc2UoVGVsZXBob255TWFuYWdlciwgU3RyaW5nLCBDaGFyU2VxdWVuY2UpfSB3aWxsIGJlIGNhbGxlZCBpZiB0aGUKICAgICAqIFVTU0QgcmVxdWVzdCBoYXMgc3VjY2VlZGVkLgogICAgICoge0BsaW5rICNvblJlY2VpdmVVc3NkUmVzcG9uc2VGYWlsZWQoVGVsZXBob255TWFuYWdlciwgU3RyaW5nLCBpbnQpfSB3aWxsIGJlIGNhbGxlZCBpZiB0aGUKICAgICAqIFVTU0QgcmVxdWVzdCBoYXMgZmFpbGVkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGFic3RyYWN0IGNsYXNzIFVzc2RSZXNwb25zZUNhbGxiYWNrIHsKICAgICAgIC8qKgogICAgICAgICogQ2FsbGVkIHdoZW4gYSBVU1NEIHJlcXVlc3QgaGFzIHN1Y2NlZWRlZC4gIFRoZSB7QGNvZGUgcmVzcG9uc2V9IGNvbnRhaW5zIHRoZSBVU1NECiAgICAgICAgKiByZXNwb25zZSByZWNlaXZlZCBmcm9tIHRoZSBuZXR3b3JrLiAgVGhlIGNhbGxpbmcgYXBwIGNhbiBjaG9vc2UgdG8gZWl0aGVyIGRpc3BsYXkgdGhlCiAgICAgICAgKiByZXNwb25zZSB0byB0aGUgdXNlciBvciBwZXJmb3JtIHNvbWUgb3BlcmF0aW9uIGJhc2VkIG9uIHRoZSByZXNwb25zZS4KICAgICAgICAqIDxwPgogICAgICAgICogVVNTRCByZXNwb25zZXMgYXJlIHVuc3RydWN0dXJlZCB0ZXh0IGFuZCB0aGVpciBjb250ZW50IGlzIGRldGVybWluZWQgYnkgdGhlIG1vYmlsZSBuZXR3b3JrCiAgICAgICAgKiBvcGVyYXRvci4KICAgICAgICAqCiAgICAgICAgKiBAcGFyYW0gdGVsZXBob255TWFuYWdlciB0aGUgVGVsZXBob255TWFuYWdlciB0aGUgY2FsbGJhY2sgaXMgcmVnaXN0ZXJlZCB0by4KICAgICAgICAqIEBwYXJhbSByZXF1ZXN0IHRoZSBVU1NEIHJlcXVlc3Qgc2VudCB0byB0aGUgbW9iaWxlIG5ldHdvcmsuCiAgICAgICAgKiBAcGFyYW0gcmVzcG9uc2UgdGhlIHJlc3BvbnNlIHRvIHRoZSBVU1NEIHJlcXVlc3QgcHJvdmlkZWQgYnkgdGhlIG1vYmlsZSBuZXR3b3JrLgogICAgICAgICoqLwogICAgICAgcHVibGljIHZvaWQgb25SZWNlaXZlVXNzZFJlc3BvbnNlKGZpbmFsIFRlbGVwaG9ueU1hbmFnZXIgdGVsZXBob255TWFuYWdlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgcmVxdWVzdCwgQ2hhclNlcXVlbmNlIHJlc3BvbnNlKSB7fTsKCiAgICAgICAvKioKICAgICAgICAqIENhbGxlZCB3aGVuIGEgVVNTRCByZXF1ZXN0IGhhcyBmYWlsZWQgdG8gY29tcGxldGUuCiAgICAgICAgKgogICAgICAgICogQHBhcmFtIHRlbGVwaG9ueU1hbmFnZXIgdGhlIFRlbGVwaG9ueU1hbmFnZXIgdGhlIGNhbGxiYWNrIGlzIHJlZ2lzdGVyZWQgdG8uCiAgICAgICAgKiBAcGFyYW0gcmVxdWVzdCB0aGUgVVNTRCByZXF1ZXN0IHNlbnQgdG8gdGhlIG1vYmlsZSBuZXR3b3JrLgogICAgICAgICogQHBhcmFtIGZhaWx1cmVDb2RlIGZhaWx1cmUgY29kZSBpbmRpY2F0aW5nIHdoeSB0aGUgcmVxdWVzdCBmYWlsZWQuICBXaWxsIGJlIGVpdGhlcgogICAgICAgICogICAgICAgIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI1VTU0RfUkVUVVJOX0ZBSUxVUkV9IG9yCiAgICAgICAgKiAgICAgICAge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjVVNTRF9FUlJPUl9TRVJWSUNFX1VOQVZBSUx9LgogICAgICAgICoqLwogICAgICAgcHVibGljIHZvaWQgb25SZWNlaXZlVXNzZFJlc3BvbnNlRmFpbGVkKGZpbmFsIFRlbGVwaG9ueU1hbmFnZXIgdGVsZXBob255TWFuYWdlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgcmVxdWVzdCwgaW50IGZhaWx1cmVDb2RlKSB7fTsKICAgIH0KCiAgICAvKioKICAgICAqIFNlbmRzIGFuIFVuc3RydWN0dXJlZCBTdXBwbGVtZW50YXJ5IFNlcnZpY2UgRGF0YSAoVVNTRCkgcmVxdWVzdCB0byB0aGUgbW9iaWxlIG5ldHdvcmsgYW5kCiAgICAgKiBpbmZvcm1zIHRoZSBjYWxsZXIgb2YgdGhlIHJlc3BvbnNlIHZpYSB0aGUgc3VwcGxpZWQge0Bjb2RlIGNhbGxiYWNrfS4KICAgICAqIDxwPkNhcnJpZXJzIGRlZmluZSBVU1NEIGNvZGVzIHdoaWNoIGNhbiBiZSBzZW50IGJ5IHRoZSB1c2VyIHRvIHJlcXVlc3QgaW5mb3JtYXRpb24gc3VjaCBhcwogICAgICogdGhlIHVzZXIncyBjdXJyZW50IGRhdGEgYmFsYW5jZSBvciBtaW51dGVzIGJhbGFuY2UuCiAgICAgKiA8cD5SZXF1aXJlcyBwZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNDQUxMX1BIT05FfQogICAgICogQHBhcmFtIHVzc2RSZXF1ZXN0IHRoZSBVU1NEIGNvbW1hbmQgdG8gYmUgZXhlY3V0ZWQuCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgY2FsbGVkIGJ5IHRoZSBmcmFtZXdvcmsgdG8gaW5mb3JtIHRoZSBjYWxsZXIgb2YgdGhlIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgVVNTRCByZXF1ZXN0IChzZWUge0BsaW5rIFVzc2RSZXNwb25zZUNhbGxiYWNrfSkuCiAgICAgKiBAcGFyYW0gaGFuZGxlciB0aGUge0BsaW5rIEhhbmRsZXJ9IHRvIHJ1biB0aGUgcmVxdWVzdCBvbi4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uQ0FMTF9QSE9ORSkKICAgIHB1YmxpYyB2b2lkIHNlbmRVc3NkUmVxdWVzdChTdHJpbmcgdXNzZFJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWwgVXNzZFJlc3BvbnNlQ2FsbGJhY2sgY2FsbGJhY2ssIEhhbmRsZXIgaGFuZGxlcikgewogICAgICAgIGNoZWNrTm90TnVsbChjYWxsYmFjaywgIlVzc2RSZXNwb25zZUNhbGxiYWNrIGNhbm5vdCBiZSBudWxsLiIpOwogICAgICAgIGZpbmFsIFRlbGVwaG9ueU1hbmFnZXIgdGVsZXBob255TWFuYWdlciA9IHRoaXM7CgogICAgICAgIFJlc3VsdFJlY2VpdmVyIHdyYXBwZWRDYWxsYmFjayA9IG5ldyBSZXN1bHRSZWNlaXZlcihoYW5kbGVyKSB7CiAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICBwcm90ZWN0ZWQgdm9pZCBvblJlY2VpdmVSZXN1bHQoaW50IHJlc3VsdENvZGUsIEJ1bmRsZSB1c3NkUmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgIFJsb2cuZChUQUcsICJVU1NEOiIgKyByZXN1bHRDb2RlKTsKICAgICAgICAgICAgICAgIGNoZWNrTm90TnVsbCh1c3NkUmVzcG9uc2UsICJ1c3NkUmVzcG9uc2UgY2Fubm90IGJlIG51bGwuIik7CiAgICAgICAgICAgICAgICBVc3NkUmVzcG9uc2UgcmVzcG9uc2UgPSB1c3NkUmVzcG9uc2UuZ2V0UGFyY2VsYWJsZShVU1NEX1JFU1BPTlNFKTsKCiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Q29kZSA9PSBVU1NEX1JFVFVSTl9TVUNDRVNTKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sub25SZWNlaXZlVXNzZFJlc3BvbnNlKHRlbGVwaG9ueU1hbmFnZXIsIHJlc3BvbnNlLmdldFVzc2RSZXF1ZXN0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5nZXRSZXR1cm5NZXNzYWdlKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5vblJlY2VpdmVVc3NkUmVzcG9uc2VGYWlsZWQodGVsZXBob255TWFuYWdlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmdldFVzc2RSZXF1ZXN0KCksIHJlc3VsdENvZGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LmhhbmRsZVVzc2RSZXF1ZXN0KGdldFN1YklkKCksIHVzc2RSZXF1ZXN0LCB3cmFwcGVkQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I3NlbmRVU1NEQ29kZSIsIGUpOwogICAgICAgICAgICBVc3NkUmVzcG9uc2UgcmVzcG9uc2UgPSBuZXcgVXNzZFJlc3BvbnNlKHVzc2RSZXF1ZXN0LCAiIik7CiAgICAgICAgICAgIEJ1bmRsZSByZXR1cm5EYXRhID0gbmV3IEJ1bmRsZSgpOwogICAgICAgICAgICByZXR1cm5EYXRhLnB1dFBhcmNlbGFibGUoVVNTRF9SRVNQT05TRSwgcmVzcG9uc2UpOwogICAgICAgICAgICB3cmFwcGVkQ2FsbGJhY2suc2VuZChVU1NEX0VSUk9SX1NFUlZJQ0VfVU5BVkFJTCwgcmV0dXJuRGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogV2hldGhlciB0aGUgZGV2aWNlIGlzIGN1cnJlbnRseSBvbiBhIHRlY2hub2xvZ3kgKGUuZy4gVU1UUyBvciBMVEUpIHdoaWNoIGNhbiBzdXBwb3J0CiAgICAgKiB2b2ljZSBhbmQgZGF0YSBzaW11bHRhbmVvdXNseS4gVGhpcyBjYW4gY2hhbmdlIGJhc2VkIG9uIGxvY2F0aW9uIG9yIG5ldHdvcmsgY29uZGl0aW9uLgogICAgICoKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHNpbXVsdGFuZW91cyB2b2ljZSBhbmQgZGF0YSBzdXBwb3J0ZWQsIGFuZCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNDb25jdXJyZW50Vm9pY2VBbmREYXRhU3VwcG9ydGVkKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICByZXR1cm4gKHRlbGVwaG9ueSA9PSBudWxsID8gZmFsc2UgOiB0ZWxlcGhvbnkuaXNDb25jdXJyZW50Vm9pY2VBbmREYXRhQWxsb3dlZCgKICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZCgpKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzQ29uY3VycmVudFZvaWNlQW5kRGF0YUFsbG93ZWQiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaGFuZGxlUGluTW1pKFN0cmluZyBkaWFsU3RyaW5nKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaGFuZGxlUGluTW1pKGRpYWxTdHJpbmcpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNoYW5kbGVQaW5NbWkiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaGFuZGxlUGluTW1pRm9yU3Vic2NyaWJlcihpbnQgc3ViSWQsIFN0cmluZyBkaWFsU3RyaW5nKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaGFuZGxlUGluTW1pRm9yU3Vic2NyaWJlcihzdWJJZCwgZGlhbFN0cmluZyk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2hhbmRsZVBpbk1taSIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCB0b2dnbGVSYWRpb09uT2ZmKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkudG9nZ2xlUmFkaW9Pbk9mZigpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSN0b2dnbGVSYWRpb09uT2ZmIiwgZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0UmFkaW8oYm9vbGVhbiB0dXJuT24pIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRSYWRpbyh0dXJuT24pOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRSYWRpbyIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRSYWRpb1Bvd2VyKGJvb2xlYW4gdHVybk9uKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuc2V0UmFkaW9Qb3dlcih0dXJuT24pOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRSYWRpb1Bvd2VyIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNodXQgZG93biBhbGwgdGhlIGxpdmUgcmFkaW9zIG92ZXIgYWxsIHRoZSBzbG90IGluZGV4ZXMuCiAgICAgKgogICAgICogPHA+VG8ga25vdyB3aGVuIHRoZSByYWRpbyBoYXMgY29tcGxldGVkIHBvd2VyaW5nIG9mZiwgdXNlCiAgICAgKiB7QGxpbmsgUGhvbmVTdGF0ZUxpc3RlbmVyI0xJU1RFTl9TRVJWSUNFX1NUQVRFIExJU1RFTl9TRVJWSUNFX1NUQVRFfS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzaHV0ZG93bkFsbFJhZGlvcygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuc2h1dGRvd25Nb2JpbGVSYWRpb3MoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzaHV0ZG93bkFsbFJhZGlvcyIsIGUpOwogICAgICAgICAgICBlLnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiBhbnkgcmFkaW8gaXMgb24gb3ZlciBhbGwgdGhlIHNsb3QgaW5kZXhlcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBhbnkgcmFkaW8gaXMgb24gb3ZlciBhbnkgc2xvdCBpbmRleC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzQW55UmFkaW9Qb3dlcmVkT24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5uZWVkTW9iaWxlUmFkaW9TaHV0ZG93bigpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzQW55UmFkaW9Qb3dlcmVkT24iLCBlKTsKICAgICAgICAgICAgZS5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJhZGlvIGV4cGxpY2l0bHkgcG93ZXJlZCBvZmYgKGUuZywgYWlycGxhbmUgbW9kZSkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSQURJT19QT1dFUl9PRkYgPSAwOwoKICAgIC8qKgogICAgICogUmFkaW8gcG93ZXIgaXMgb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSQURJT19QT1dFUl9PTiA9IDE7CgogICAgLyoqCiAgICAgKiBSYWRpbyBwb3dlciB1bmF2YWlsYWJsZSAoZWcsIG1vZGVtIHJlc2V0dGluZyBvciBub3QgYm9vdGVkKS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJBRElPX1BPV0VSX1VOQVZBSUxBQkxFID0gMjsKCiAgICAvKioKICAgICAqIEByZXR1cm4gY3VycmVudCBtb2RlbSByYWRpbyBzdGF0ZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBwZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0gb3IKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHthbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLAogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURX0pCiAgICBwdWJsaWMgQFJhZGlvUG93ZXJTdGF0ZSBpbnQgZ2V0UmFkaW9Qb3dlclN0YXRlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0UmFkaW9Qb3dlclN0YXRlKGdldFNsb3RJbmRleCgpLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgfQogICAgICAgIHJldHVybiBSQURJT19QT1dFUl9VTkFWQUlMQUJMRTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBTdXBwcmVzc0xpbnQoIkRvY2xhdmExMjUiKQogICAgcHVibGljIHZvaWQgdXBkYXRlU2VydmljZUxvY2F0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkudXBkYXRlU2VydmljZUxvY2F0aW9uKCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I3VwZGF0ZVNlcnZpY2VMb2NhdGlvbiIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGVuYWJsZURhdGFDb25uZWN0aXZpdHkoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZW5hYmxlRGF0YUNvbm5lY3Rpdml0eSgpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNlbmFibGVEYXRhQ29ubmVjdGl2aXR5IiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGRpc2FibGVEYXRhQ29ubmVjdGl2aXR5KCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmRpc2FibGVEYXRhQ29ubmVjdGl2aXR5KCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2Rpc2FibGVEYXRhQ29ubmVjdGl2aXR5IiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBib29sZWFuIGlzRGF0YUNvbm5lY3Rpdml0eVBvc3NpYmxlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmlzRGF0YUNvbm5lY3Rpdml0eVBvc3NpYmxlKGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmdldEFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZCgpKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzRGF0YUFsbG93ZWQiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gbmVlZHNPdGFTZXJ2aWNlUHJvdmlzaW9uaW5nKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255Lm5lZWRzT3RhU2VydmljZVByb3Zpc2lvbmluZygpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNuZWVkc090YVNlcnZpY2VQcm92aXNpb25pbmciLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogVHVybnMgbW9iaWxlIGRhdGEgb24gb3Igb2ZmLgogICAgICogSWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZSBnaXZlbgogICAgICogc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGVuYWJsZSBXaGV0aGVyIHRvIGVuYWJsZSBtb2JpbGUgZGF0YS4KICAgICAqCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREYXRhRW5hYmxlZChib29sZWFuIGVuYWJsZSkgewogICAgICAgIHNldERhdGFFbmFibGVkKGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKSwgZW5hYmxlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBoaWRlCiAgICAgKiBAZGVwcmVjYXRlZCB1c2Uge0BsaW5rICNzZXREYXRhRW5hYmxlZChib29sZWFuKX0gaW5zdGVhZC4KICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBARGVwcmVjYXRlZAogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGF0YUVuYWJsZWQoaW50IHN1YklkLCBib29sZWFuIGVuYWJsZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIExvZy5kKFRBRywgInNldERhdGFFbmFibGVkOiBlbmFibGVkPSIgKyBlbmFibGUpOwogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgdGVsZXBob255LnNldFVzZXJEYXRhRW5hYmxlZChzdWJJZCwgZW5hYmxlKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc2V0VXNlckRhdGFFbmFibGVkIiwgZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgdXNlIHtAbGluayAjaXNEYXRhRW5hYmxlZCgpfSBpbnN0ZWFkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBib29sZWFuIGdldERhdGFFbmFibGVkKCkgewogICAgICAgIHJldHVybiBpc0RhdGFFbmFibGVkKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdoZXRoZXIgbW9iaWxlIGRhdGEgaXMgZW5hYmxlZCBvciBub3QgcGVyIHVzZXIgc2V0dGluZy4gVGhlcmUgYXJlIG90aGVyIGZhY3RvcnMKICAgICAqIHRoYXQgY291bGQgZGlzYWJsZSBtb2JpbGUgZGF0YSwgYnV0IHRoZXkgYXJlIG5vdCBjb25zaWRlcmVkIGhlcmUuCiAgICAgKgogICAgICogSWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZSBnaXZlbgogICAgICogc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgb25lIG9mIHRoZSBmb2xsb3dpbmcgcGVybWlzc2lvbnM6CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI0FDQ0VTU19ORVRXT1JLX1NUQVRFfSwKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfSwgb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIKICAgICAqIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogPHA+Tm90ZSB0aGF0IHRoaXMgZG9lcyBub3QgdGFrZSBpbnRvIGFjY291bnQgYW55IGRhdGEgcmVzdHJpY3Rpb25zIHRoYXQgbWF5IGJlIHByZXNlbnQgb24gdGhlCiAgICAgKiBjYWxsaW5nIGFwcC4gU3VjaCByZXN0cmljdGlvbnMgbWF5IGJlIGluc3BlY3RlZCB3aXRoCiAgICAgKiB7QGxpbmsgQ29ubmVjdGl2aXR5TWFuYWdlciNnZXRSZXN0cmljdEJhY2tncm91bmRTdGF0dXN9LgogICAgICoKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBtb2JpbGUgZGF0YSBpcyBlbmFibGVkLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFueU9mID0ge2FuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5BQ0NFU1NfTkVUV09SS19TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURX0pCiAgICBwdWJsaWMgYm9vbGVhbiBpc0RhdGFFbmFibGVkKCkgewogICAgICAgIHJldHVybiBnZXREYXRhRW5hYmxlZChnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3aGV0aGVyIG1vYmlsZSBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZCBvbiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIG9uZSBvZiB0aGUgZm9sbG93aW5nIHBlcm1pc3Npb25zOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNBQ0NFU1NfTkVUV09SS19TVEFURX0sCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwCiAgICAgKiBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZCBvbiB0aGUgc3Vic2NyaXB0aW9uLCBvdGhlcndpc2UgcmV0dXJuCiAgICAgKiB7QGNvZGUgZmFsc2V9LgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFueU9mID0ge2FuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5BQ0NFU1NfTkVUV09SS19TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEV9KQogICAgcHVibGljIGJvb2xlYW4gaXNEYXRhUm9hbWluZ0VuYWJsZWQoKSB7CiAgICAgICAgYm9vbGVhbiBpc0RhdGFSb2FtaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlzRGF0YVJvYW1pbmdFbmFibGVkID0gdGVsZXBob255LmlzRGF0YVJvYW1pbmdFbmFibGVkKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzRGF0YVJvYW1pbmdFbmFibGVkIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc0RhdGFSb2FtaW5nRW5hYmxlZDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIHJvYW1pbmcgbW9kZSBmb3IgQ0RNQSBwaG9uZS4KICAgICAqCiAgICAgKiA8cD5JZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBnaXZlbiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpfQogICAgICoKICAgICAqIEByZXR1cm4gb25lIG9mIHtAbGluayAjQ0RNQV9ST0FNSU5HX01PREVfUkFESU9fREVGQVVMVH0sIHtAbGluayAjQ0RNQV9ST0FNSU5HX01PREVfSE9NRX0sCiAgICAgKiB7QGxpbmsgI0NETUFfUk9BTUlOR19NT0RFX0FGRklMSUFURUR9LCB7QGxpbmsgI0NETUFfUk9BTUlOR19NT0RFX0FOWX0uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBDZG1hUm9hbWluZ01vZGUgaW50IGdldENkbWFSb2FtaW5nTW9kZSgpIHsKICAgICAgICBpbnQgbW9kZSA9IENETUFfUk9BTUlOR19NT0RFX1JBRElPX0RFRkFVTFQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbW9kZSA9IHRlbGVwaG9ueS5nZXRDZG1hUm9hbWluZ01vZGUoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2dldENkbWFSb2FtaW5nTW9kZSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1vZGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSByb2FtaW5nIG1vZGUgZm9yIENETUEgcGhvbmUgdG8gdGhlIGdpdmVuIG1vZGUge0Bjb2RlIG1vZGV9LgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogQHBhcmFtIG1vZGUgc2hvdWxkIGJlIG9uZSBvZiB7QGxpbmsgI0NETUFfUk9BTUlOR19NT0RFX1JBRElPX0RFRkFVTFR9LAogICAgICoge0BsaW5rICNDRE1BX1JPQU1JTkdfTU9ERV9IT01FfSwge0BsaW5rICNDRE1BX1JPQU1JTkdfTU9ERV9BRkZJTElBVEVEfSwKICAgICAqIHtAbGluayAjQ0RNQV9ST0FNSU5HX01PREVfQU5ZfS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBzdWNjZXNzZWQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0Q2RtYVJvYW1pbmdNb2RlKEBDZG1hUm9hbWluZ01vZGUgaW50IG1vZGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldENkbWFSb2FtaW5nTW9kZShnZXRTdWJJZCgpLCBtb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc2V0Q2RtYVJvYW1pbmdNb2RlIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBASW50RGVmKGZsYWcgPSB0cnVlLCBwcmVmaXggPSB7ICJDRE1BX1NVQlNDUklQVElPTl8iIH0sIHZhbHVlID0gewogICAgICAgICAgICBDRE1BX1NVQlNDUklQVElPTl9VTktOT1dOLAogICAgICAgICAgICBDRE1BX1NVQlNDUklQVElPTl9SVUlNX1NJTSwKICAgICAgICAgICAgQ0RNQV9TVUJTQ1JJUFRJT05fTlYKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBDZG1hU3Vic2NyaXB0aW9ue30KCiAgICAvKiogVXNlZCBmb3IgQ0RNQSBzdWJzY3JpcHRpb24gbW9kZSwgaXQnbGwgYmUgVU5LTk9XTiBpZiB0aGVyZSBpcyBubyBTdWJzY3JpcHRpb24gc291cmNlLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0RNQV9TVUJTQ1JJUFRJT05fVU5LTk9XTiAgPSAtMTsKCiAgICAvKiogVXNlZCBmb3IgQ0RNQSBzdWJzY3JpcHRpb24gbW9kZTogUlVJTS9TSU0gKGRlZmF1bHQpCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDRE1BX1NVQlNDUklQVElPTl9SVUlNX1NJTSA9IDA7CgogICAgLyoqIFVzZWQgZm9yIENETUEgc3Vic2NyaXB0aW9uIG1vZGU6IE5WIC0+IG5vbi12b2xhdGlsZSBtZW1vcnkKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENETUFfU1VCU0NSSVBUSU9OX05WICAgICAgID0gMTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBSRUZFUlJFRF9DRE1BX1NVQlNDUklQVElPTiA9IENETUFfU1VCU0NSSVBUSU9OX1JVSU1fU0lNOwoKICAgIC8qKgogICAgICogU2V0cyB0aGUgc3Vic2NyaXB0aW9uIG1vZGUgZm9yIENETUEgcGhvbmUgdG8gdGhlIGdpdmVuIG1vZGUge0Bjb2RlIG1vZGV9LgogICAgICoKICAgICAqIEBwYXJhbSBtb2RlIENETUEgc3Vic2NyaXB0aW9uIG1vZGUKICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBzdWNjZXNzZWQuCiAgICAgKgogICAgICogQHNlZSAjQ0RNQV9TVUJTQ1JJUFRJT05fVU5LTk9XTgogICAgICogQHNlZSAjQ0RNQV9TVUJTQ1JJUFRJT05fUlVJTV9TSU0KICAgICAqIEBzZWUgI0NETUFfU1VCU0NSSVBUSU9OX05WCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0Q2RtYVN1YnNjcmlwdGlvbk1vZGUoQENkbWFTdWJzY3JpcHRpb24gaW50IG1vZGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldENkbWFTdWJzY3JpcHRpb25Nb2RlKGdldFN1YklkKCksIG1vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRDZG1hU3Vic2NyaXB0aW9uTW9kZSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlcy9EaXNhYmxlcyB0aGUgZGF0YSByb2FtaW5nIG9uIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCl9CiAgICAgKgogICAgICogPHA+IFJlcXVpcmVzIHBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIKICAgICAqIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIGlzRW5hYmxlZCB7QGNvZGUgdHJ1ZX0gdG8gZW5hYmxlIG1vYmlsZSBkYXRhIHJvYW1pbmcsIG90aGVyd2lzZSBkaXNhYmxlIGl0LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERhdGFSb2FtaW5nRW5hYmxlZChib29sZWFuIGlzRW5hYmxlZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXREYXRhUm9hbWluZ0VuYWJsZWQoCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKSwgaXNFbmFibGVkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXREYXRhUm9hbWluZ0VuYWJsZWQiLCBlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCB1c2Uge0BsaW5rICNpc0RhdGFFbmFibGVkKCl9IGluc3RlYWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gZ2V0RGF0YUVuYWJsZWQoaW50IHN1YklkKSB7CiAgICAgICAgYm9vbGVhbiByZXRWYWwgPSBmYWxzZTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0VmFsID0gdGVsZXBob255LmlzVXNlckRhdGFFbmFibGVkKHN1YklkKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gfCBOdWxsUG9pbnRlckV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc1VzZXJEYXRhRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0VmFsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcmVzdWx0IGFuZCByZXNwb25zZSBmcm9tIFJJTCBmb3Igb2VtIHJlcXVlc3QKICAgICAqCiAgICAgKiBAcGFyYW0gb2VtUmVxIHRoZSBkYXRhIGlzIHNlbnQgdG8gcmlsLgogICAgICogQHBhcmFtIG9lbVJlc3AgdGhlIHJlc3Bvc2UgZGF0YSBmcm9tIFJJTC4KICAgICAqIEByZXR1cm4gbmVnYXRpdmUgdmFsdWUgcmVxdWVzdCB3YXMgbm90IGhhbmRsZWQgb3IgZ2V0IGVycm9yCiAgICAgKiAgICAgICAgIDAgcmVxdWVzdCB3YXMgaGFuZGxlZCBzdWNjZXNmdWxseSwgYnV0IG5vIHJlc3BvbnNlIGRhdGEKICAgICAqICAgICAgICAgcG9zaXRpdmUgdmFsdWUgc3VjY2VzcywgZGF0YSBsZW5ndGggb2YgcmVzcG9uc2UKICAgICAqIEBoaWRlCiAgICAgKiBAZGVwcmVjYXRlZCBPRU0gbmVlZHMgYSB2ZW5kb3ItZXh0ZW5zaW9uIGhhbCBhbmQgdGhlaXIgYXBwcyBzaG91bGQgdXNlIHRoYXQgaW5zdGVhZAogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIGludCBpbnZva2VPZW1SaWxSZXF1ZXN0UmF3KGJ5dGVbXSBvZW1SZXEsIGJ5dGVbXSBvZW1SZXNwKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaW52b2tlT2VtUmlsUmVxdWVzdFJhdyhvZW1SZXEsIG9lbVJlc3ApOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLkltc01tVGVsTWFuYWdlciNzZXRWdFNldHRpbmdFbmFibGVkKGJvb2xlYW4pfQogICAgICogaW5zdGVhZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBlbmFibGVWaWRlb0NhbGxpbmcoYm9vbGVhbiBlbmFibGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKQogICAgICAgICAgICAgICAgdGVsZXBob255LmVuYWJsZVZpZGVvQ2FsbGluZyhlbmFibGUpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNlbmFibGVWaWRlb0NhbGxpbmciLCBlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc1Z0U2V0dGluZ0VuYWJsZWQoKX0gaW5zdGVhZCB0byBjaGVjayBpZiB0aGUgdXNlcgogICAgICogaGFzIGVuYWJsZWQgdGhlIFZpZGVvIENhbGxpbmcgc2V0dGluZywge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0F2YWlsYWJsZShpbnQsIGludCl9IHRvCiAgICAgKiBkZXRlcm1pbmUgaWYgdmlkZW8gY2FsbGluZyBpcyBhdmFpbGFibGUsIG9yIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjaXNDYXBhYmxlKGludCwgaW50KX0gdG8KICAgICAqIGRldGVybWluZSBpZiB2aWRlbyBjYWxsaW5nIGlzIGNhcGFibGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUKICAgIH0pCiAgICBwdWJsaWMgYm9vbGVhbiBpc1ZpZGVvQ2FsbGluZ0VuYWJsZWQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaXNWaWRlb0NhbGxpbmdFbmFibGVkKGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzVmlkZW9DYWxsaW5nRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoZSBkZXZpY2Ugc3VwcG9ydHMgY29uZmlndXJpbmcgdGhlIERUTUYgdG9uZSBsZW5ndGguCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIERUTUYgdG9uZSBsZW5ndGggY2FuIGJlIGNoYW5nZWQsIGFuZCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gY2FuQ2hhbmdlRHRtZlRvbmVMZW5ndGgoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5jYW5DaGFuZ2VEdG1mVG9uZUxlbmd0aChtU3ViSWQsIGdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjY2FuQ2hhbmdlRHRtZlRvbmVMZW5ndGgiLCBlKTsKICAgICAgICB9IGNhdGNoIChTZWN1cml0eUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIlBlcm1pc3Npb24gZXJyb3IgY2FsbGluZyBJVGVsZXBob255I2NhbkNoYW5nZUR0bWZUb25lTGVuZ3RoIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZXRoZXIgdGhlIGRldmljZSBpcyBhIHdvcmxkIHBob25lLgogICAgICoKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBkZXZpY2UgaXMgYSB3b3JsZCBwaG9uZSwgYW5kIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc1dvcmxkUGhvbmUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pc1dvcmxkUGhvbmUobVN1YklkLCBnZXRPcFBhY2thZ2VOYW1lKCksIGdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzV29ybGRQaG9uZSIsIGUpOwogICAgICAgIH0gY2F0Y2ggKFNlY3VyaXR5RXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiUGVybWlzc2lvbiBlcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjaXNXb3JsZFBob25lIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgVGVsZWNvbU1hbmFnZXIjaXNUdHlTdXBwb3J0ZWQoKX0gaW5zdGVhZAogICAgICogV2hldGhlciB0aGUgcGhvbmUgc3VwcG9ydHMgVFRZIG1vZGUuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIGRldmljZSBzdXBwb3J0cyBUVFkgbW9kZSwgYW5kIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICoKICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBib29sZWFuIGlzVHR5TW9kZVN1cHBvcnRlZCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBUZWxlY29tTWFuYWdlciB0ZWxlY29tTWFuYWdlciA9IG51bGw7CiAgICAgICAgICAgIGlmIChtQ29udGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlY29tTWFuYWdlciA9IG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoVGVsZWNvbU1hbmFnZXIuY2xhc3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0ZWxlY29tTWFuYWdlciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZWNvbU1hbmFnZXIuaXNUdHlTdXBwb3J0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFNlY3VyaXR5RXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiUGVybWlzc2lvbiBlcnJvciBjYWxsaW5nIFRlbGVjb21NYW5hZ2VyI2lzVHR5U3VwcG9ydGVkIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZGV2aWNlIGN1cnJlbnRseSBzdXBwb3J0cyBSVFQgKFJlYWwtdGltZSB0ZXh0KS4gQmFzZWQgYm90aCBvbiBjYXJyaWVyCiAgICAgKiBzdXBwb3J0IGZvciB0aGUgZmVhdHVyZSBhbmQgZGV2aWNlIGZpcm13YXJlIHN1cHBvcnQuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIGRldmljZSBhbmQgY2FycmllciBib3RoIHN1cHBvcnQgUlRULCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNSdHRTdXBwb3J0ZWQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pc1J0dFN1cHBvcnRlZChtU3ViSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzUnR0U3VwcG9ydGVkIiwgZSk7CiAgICAgICAgfSBjYXRjaCAoU2VjdXJpdHlFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJQZXJtaXNzaW9uIGVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc1dvcmxkUGhvbmUiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoZSBwaG9uZSBzdXBwb3J0cyBoZWFyaW5nIGFpZCBjb21wYXRpYmlsaXR5LgogICAgICoKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBkZXZpY2Ugc3VwcG9ydHMgaGVhcmluZyBhaWQgY29tcGF0aWJpbGl0eSwgYW5kIHtAY29kZSBmYWxzZX0KICAgICAqIG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNIZWFyaW5nQWlkQ29tcGF0aWJpbGl0eVN1cHBvcnRlZCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmlzSGVhcmluZ0FpZENvbXBhdGliaWxpdHlTdXBwb3J0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc0hlYXJpbmdBaWRDb21wYXRpYmlsaXR5U3VwcG9ydGVkIiwgZSk7CiAgICAgICAgfSBjYXRjaCAoU2VjdXJpdHlFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJQZXJtaXNzaW9uIGVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc0hlYXJpbmdBaWRDb21wYXRpYmlsaXR5U3VwcG9ydGVkIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIElNUyBSZWdpc3RyYXRpb24gU3RhdHVzIGZvciBhIHBhcnRpY3VsYXIgU3Vic2NyaXB0aW9uIElELgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSUQKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBJTVMgc3RhdHVzIGlzIHJlZ2lzdGVyZWQsIGZhbHNlIGlmIHRoZSBJTVMgc3RhdHVzIGlzIG5vdCByZWdpc3RlcmVkIG9yIGEKICAgICAqIFJlbW90ZUV4Y2VwdGlvbiBvY2N1cnJlZC4KICAgICAqIFVzZSB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyLlJlZ2lzdHJhdGlvbkNhbGxiYWNrfSBpbnN0ZWFkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gaXNJbXNSZWdpc3RlcmVkKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJVGVsZXBob255KCkuaXNJbXNSZWdpc3RlcmVkKHN1YklkKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gfCBOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgSU1TIFJlZ2lzdHJhdGlvbiBTdGF0dXMgZm9yIGEgcGFydGljdWxhciBTdWJzY3JpcHRpb24gSUQsIHdoaWNoIGlzIGRldGVybWluZWQKICAgICAqIHdoZW4gdGhlIFRlbGVwaG9ueU1hbmFnZXIgaXMgY3JlYXRlZCB1c2luZyB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkKGludCl9LiBJZiBhbgogICAgICogaW52YWxpZCBzdWJzY3JpcHRpb24gSUQgaXMgdXNlZCBkdXJpbmcgY3JlYXRpb24sIHdpbGwgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9uIElEIHdpbGwgYmUKICAgICAqIHVzZWQuCiAgICAgKgogICAgICogQHJldHVybiB0cnVlIGlmIElNUyBzdGF0dXMgaXMgcmVnaXN0ZXJlZCwgZmFsc2UgaWYgdGhlIElNUyBzdGF0dXMgaXMgbm90IHJlZ2lzdGVyZWQgb3IgYQogICAgICogUmVtb3RlRXhjZXB0aW9uIG9jY3VycmVkLgogICAgICogQHNlZSBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgYm9vbGVhbiBpc0ltc1JlZ2lzdGVyZWQoKSB7CiAgICAgICB0cnkgewogICAgICAgICAgIHJldHVybiBnZXRJVGVsZXBob255KCkuaXNJbXNSZWdpc3RlcmVkKGdldFN1YklkKCkpOwogICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIHwgTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgY3VycmVudCBzdGF0dXMgb2YgVm9pY2Ugb3ZlciBMVEUgZm9yIHRoZSBzdWJzY3JpcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoaXMgaW5zdGFuY2Ugd2hlbgogICAgICogaXQgd2FzIGNyZWF0ZWQgdXNpbmcge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZChpbnQpfS4gSWYgYW4gaW52YWxpZCBzdWJzY3JpcHRpb24gSUQgd2FzCiAgICAgKiB1c2VkIGR1cmluZyBjcmVhdGlvbiwgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9uIElEIHdpbGwgYmUgdXNlZC4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBWb2ljZSBvdmVyIExURSBpcyBhdmFpbGFibGUgb3IgZmFsc2UgaWYgaXQgaXMgdW5hdmFpbGFibGUgb3IgdW5rbm93bi4KICAgICAqIEBzZWUgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKQogICAgICogPHA+CiAgICAgKiBVc2Uge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0F2YWlsYWJsZShpbnQsIGludCl9IGluc3RlYWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGJvb2xlYW4gaXNWb2x0ZUF2YWlsYWJsZSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZ2V0SVRlbGVwaG9ueSgpLmlzQXZhaWxhYmxlKGdldFN1YklkKCksCiAgICAgICAgICAgICAgICAgICAgTW1UZWxGZWF0dXJlLk1tVGVsQ2FwYWJpbGl0aWVzLkNBUEFCSUxJVFlfVFlQRV9WT0lDRSwKICAgICAgICAgICAgICAgICAgICBJbXNSZWdpc3RyYXRpb25JbXBsQmFzZS5SRUdJU1RSQVRJT05fVEVDSF9MVEUpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiB8IE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYXZhaWxhYmlsaXR5IG9mIFZpZGVvIFRlbGVwaG9ueSAoVlQpIGZvciB0aGUgc3Vic2NyaXB0aW9uIElEIHNwZWNpZmllZCB3aGVuIHRoaXMgaW5zdGFuY2UKICAgICAqIHdhcyBjcmVhdGVkIHVzaW5nIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWQoaW50KX0uIElmIGFuIGludmFsaWQgc3Vic2NyaXB0aW9uIElEIHdhcwogICAgICogdXNlZCBkdXJpbmcgY3JlYXRpb24sIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbiBJRCB3aWxsIGJlIHVzZWQuIFRvIHF1ZXJ5IHRoZQogICAgICogdW5kZXJseWluZyB0ZWNobm9sb2d5IHRoYXQgVlQgaXMgYXZhaWxhYmxlIG9uLCB1c2Uge0BsaW5rICNnZXRJbXNSZWdUZWNobm9sb2d5Rm9yTW1UZWx9LgogICAgICogQHJldHVybiB0cnVlIGlmIFZUIGlzIGF2YWlsYWJsZSwgb3IgZmFsc2UgaWYgaXQgaXMgdW5hdmFpbGFibGUgb3IgdW5rbm93bi4KICAgICAqIFVzZSB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzQXZhaWxhYmxlKGludCwgaW50KX0gaW5zdGVhZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBpc1ZpZGVvVGVsZXBob255QXZhaWxhYmxlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJVGVsZXBob255KCkuaXNWaWRlb1RlbGVwaG9ueUF2YWlsYWJsZShnZXRTdWJJZCgpKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gfCBOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgU3RhdHVzIG9mIFdpLUZpIGNhbGxpbmcgKFZvaWNlIG92ZXIgV2lGaSkgZm9yIHRoZSBzdWJzY3JpcHRpb24gSUQgc3BlY2lmaWVkLgogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpcHRpb24gSUQuCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgVm9XaUZpIGlzIGF2YWlsYWJsZSwgb3IgZmFsc2UgaWYgaXQgaXMgdW5hdmFpbGFibGUgb3IgdW5rbm93bi4KICAgICAqIFVzZSB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzQXZhaWxhYmxlKGludCwgaW50KX0gaW5zdGVhZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBpc1dpZmlDYWxsaW5nQXZhaWxhYmxlKCkgewogICAgICAgdHJ5IHsKICAgICAgICAgICByZXR1cm4gZ2V0SVRlbGVwaG9ueSgpLmlzV2lmaUNhbGxpbmdBdmFpbGFibGUoZ2V0U3ViSWQoKSk7CiAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gfCBOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgIH0KICAgfQoKICAgIC8qKgogICAgICogVGhlIHRlY2hub2xvZ3kgdGhhdCBJTVMgaXMgcmVnaXN0ZXJlZCBmb3IgZm9yIHRoZSBNTVRFTCBmZWF0dXJlLgogICAgICogQHBhcmFtIHN1YklkIHN1YnNjcmlwdGlvbiBJRCB0byBnZXQgSU1TIHJlZ2lzdHJhdGlvbiB0ZWNobm9sb2d5IGZvci4KICAgICAqIEByZXR1cm4gVGhlIElNUyByZWdpc3RyYXRpb24gdGVjaG5vbG9neSB0aGF0IElNUyBpcyByZWdpc3RlcmVkIHRvIGZvciB0aGUgTU1URUwgZmVhdHVyZS4KICAgICAqIFZhbGlkIHJldHVybiByZXN1bHRzIGFyZToKICAgICAqICAtIHtAbGluayBJbXNSZWdpc3RyYXRpb25JbXBsQmFzZSNSRUdJU1RSQVRJT05fVEVDSF9MVEV9IGZvciBMVEUgcmVnaXN0cmF0aW9uLAogICAgICogIC0ge0BsaW5rIEltc1JlZ2lzdHJhdGlvbkltcGxCYXNlI1JFR0lTVFJBVElPTl9URUNIX0lXTEFOfSBmb3IgSVdMQU4gcmVnaXN0cmF0aW9uLCBvcgogICAgICogIC0ge0BsaW5rIEltc1JlZ2lzdHJhdGlvbkltcGxCYXNlI1JFR0lTVFJBVElPTl9URUNIX05PTkV9IGlmIHdlIGFyZSBub3QgcmVnaXN0ZXJlZCBvciB0aGUKICAgICAqICByZXN1bHQgaXMgdW5hdmFpbGFibGUuCiAgICAgKiAgVXNlIHtAbGluayBJbXNNbVRlbE1hbmFnZXIuUmVnaXN0cmF0aW9uQ2FsbGJhY2t9IGluc3RlYWQuCiAgICAgKiAgQGhpZGUKICAgICAqLwogICAgcHVibGljIEBJbXNSZWdpc3RyYXRpb25JbXBsQmFzZS5JbXNSZWdpc3RyYXRpb25UZWNoIGludCBnZXRJbXNSZWdUZWNobm9sb2d5Rm9yTW1UZWwoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGdldElUZWxlcGhvbnkoKS5nZXRJbXNSZWdUZWNobm9sb2d5Rm9yTW1UZWwoZ2V0U3ViSWQoKSk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHJldHVybiBJbXNSZWdpc3RyYXRpb25JbXBsQmFzZS5SRUdJU1RSQVRJT05fVEVDSF9OT05FOwogICAgICAgIH0KICAgIH0KCiAgIC8qKgogICAgKiBTZXQgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfbnVtZXJpYyBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAqCiAgICAqIEBoaWRlCiAgICAqLwogICAgcHVibGljIHZvaWQgc2V0U2ltT3BlcmF0b3JOdW1lcmljKFN0cmluZyBudW1lcmljKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKCk7CiAgICAgICAgc2V0U2ltT3BlcmF0b3JOdW1lcmljRm9yUGhvbmUocGhvbmVJZCwgbnVtZXJpYyk7CiAgICB9CgogICAvKioKICAgICogU2V0IFRlbGVwaG9ueVByb3BlcnRpZXMuaWNjX29wZXJhdG9yX251bWVyaWMgZm9yIHRoZSBnaXZlbiBwaG9uZS4KICAgICoKICAgICogQGhpZGUKICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHZvaWQgc2V0U2ltT3BlcmF0b3JOdW1lcmljRm9yUGhvbmUoaW50IHBob25lSWQsIFN0cmluZyBudW1lcmljKSB7CiAgICAgICAgaWYgKFN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFBob25lSWQocGhvbmVJZCkpIHsKICAgICAgICAgICAgTGlzdDxTdHJpbmc+IG5ld0xpc3QgPSB1cGRhdGVUZWxlcGhvbnlQcm9wZXJ0eSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9udW1lcmljKCksIHBob25lSWQsIG51bWVyaWMpOwogICAgICAgICAgICBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9udW1lcmljKG5ld0xpc3QpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldCBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9hbHBoYSBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0U2ltT3BlcmF0b3JOYW1lKFN0cmluZyBuYW1lKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKCk7CiAgICAgICAgc2V0U2ltT3BlcmF0b3JOYW1lRm9yUGhvbmUocGhvbmVJZCwgbmFtZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfYWxwaGEgZm9yIHRoZSBnaXZlbiBwaG9uZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlAsIHRyYWNraW5nQnVnID0gMTE1NjA5MDIzKQogICAgcHVibGljIHZvaWQgc2V0U2ltT3BlcmF0b3JOYW1lRm9yUGhvbmUoaW50IHBob25lSWQsIFN0cmluZyBuYW1lKSB7CiAgICAgICAgaWYgKFN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFBob25lSWQocGhvbmVJZCkpIHsKICAgICAgICAgICAgTGlzdDxTdHJpbmc+IG5ld0xpc3QgPSB1cGRhdGVUZWxlcGhvbnlQcm9wZXJ0eSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9hbHBoYSgpLCBwaG9uZUlkLCBuYW1lKTsKICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfYWxwaGEobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgLyoqCiAgICAqIFNldCBUZWxlcGhvbnlQcm9wZXJ0aWVzLmljY19vcGVyYXRvcl9pc29fY291bnRyeSBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAqCiAgICAqIEBoaWRlCiAgICAqLwogICAgcHVibGljIHZvaWQgc2V0U2ltQ291bnRyeUlzbyhTdHJpbmcgaXNvKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKCk7CiAgICAgICAgc2V0U2ltQ291bnRyeUlzb0ZvclBob25lKHBob25lSWQsIGlzbyk7CiAgICB9CgogICAvKioKICAgICogU2V0IFRlbGVwaG9ueVByb3BlcnRpZXMuaWNjX29wZXJhdG9yX2lzb19jb3VudHJ5IGZvciB0aGUgZ2l2ZW4gcGhvbmUuCiAgICAqCiAgICAqIEBoaWRlCiAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyB2b2lkIHNldFNpbUNvdW50cnlJc29Gb3JQaG9uZShpbnQgcGhvbmVJZCwgU3RyaW5nIGlzbykgewogICAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVmFsaWRQaG9uZUlkKHBob25lSWQpKSB7CiAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBuZXdMaXN0ID0gdXBkYXRlVGVsZXBob255UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfaXNvX2NvdW50cnkoKSwgcGhvbmVJZCwgaXNvKTsKICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5pY2Nfb3BlcmF0b3JfaXNvX2NvdW50cnkobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IFRlbGVwaG9ueVByb3BlcnRpZXMuc2ltX3N0YXRlIGZvciB0aGUgZGVmYXVsdCBwaG9uZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTaW1TdGF0ZShTdHJpbmcgc3RhdGUpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICBzZXRTaW1TdGF0ZUZvclBob25lKHBob25lSWQsIHN0YXRlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBUZWxlcGhvbnlQcm9wZXJ0aWVzLnNpbV9zdGF0ZSBmb3IgdGhlIGdpdmVuIHBob25lLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCwgdHJhY2tpbmdCdWcgPSAxMTU2MDkwMjMpCiAgICBwdWJsaWMgdm9pZCBzZXRTaW1TdGF0ZUZvclBob25lKGludCBwaG9uZUlkLCBTdHJpbmcgc3RhdGUpIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChwaG9uZUlkKSkgewogICAgICAgICAgICBMaXN0PFN0cmluZz4gbmV3TGlzdCA9IHVwZGF0ZVRlbGVwaG9ueVByb3BlcnR5KAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMuc2ltX3N0YXRlKCksIHBob25lSWQsIHN0YXRlKTsKICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5zaW1fc3RhdGUobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUG93ZXJzIGRvd24gdGhlIFNJTS4gU0lNIG11c3QgYmUgdXAgcHJpb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQVJEX1BPV0VSX0RPV04gPSAwOwoKICAgIC8qKgogICAgICogUG93ZXJzIHVwIHRoZSBTSU0gbm9ybWFsbHkuIFNJTSBtdXN0IGJlIGRvd24gcHJpb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQVJEX1BPV0VSX1VQID0gMTsKCiAgICAvKioKICAgICAqIFBvd2VycyB1cCB0aGUgU0lNIGluIFBBU1NfVEhST1VHSCBtb2RlLiBTSU0gbXVzdCBiZSBkb3duIHByaW9yLgogICAgICogV2hlbiBTSU0gaXMgcG93ZXJlZCB1cCBpbiBQQVNTX1RIT1VHSCBtb2RlLCB0aGUgbW9kZW0gZG9lcyBub3Qgc2VuZAogICAgICogYW55IGNvbW1hbmQgdG8gaXQgKGZvciBleGFtcGxlIFNFTEVDVCBvZiBNRiwgb3IgVEVSTUlOQUwgQ0FQQUJJTElUWSksCiAgICAgKiBhbmQgdGhlIFNJTSBjYXJkIGlzIGNvbnRyb2xsZWQgY29tcGxldGVseSBieSBUZWxlcGhvbnkgc2VuZGluZyBBUERVcwogICAgICogZGlyZWN0bHkuIFRoZSBTSU0gY2FyZCBzdGF0ZSB3aWxsIGJlIFJJTF9DQVJEU1RBVEVfUFJFU0VOVCBhbmQgdGhlCiAgICAgKiBudW1iZXIgb2YgY2FyZCBhcHBzIHdpbGwgYmUgMC4KICAgICAqIE5vIG5ldyBlcnJvciBjb2RlIGlzIGdlbmVyYXRlZC4gRW1lcmdlbmN5IGNhbGxzIGFyZSBzdXBwb3J0ZWQgaW4gdGhlCiAgICAgKiBzYW1lIHdheSBhcyBpZiB0aGUgU0lNIGNhcmQgaXMgYWJzZW50LgogICAgICogVGhlIFBBU1NfVEhST1VHSCBtb2RlIGlzIHZhbGlkIG9ubHkgZm9yIHRoZSBzcGVjaWZpYyBjYXJkIHNlc3Npb24gd2hlcmUgaXQKICAgICAqIGlzIGFjdGl2YXRlZCwgYW5kIG5vcm1hbCBiZWhhdmlvciBvY2N1cnMgYXQgdGhlIG5leHQgU0lNIGluaXRpYWxpemF0aW9uLAogICAgICogdW5sZXNzIFBBU1NfVEhST1VHSCBtb2RlIGlzIHJlcXVlc3RlZCBhZ2Fpbi4gSGVuY2UsIHRoZSBsYXN0IHBvd2VyLXVwIG1vZGUKICAgICAqIGlzIE5PVCBwZXJzaXN0ZW50IGFjcm9zcyBib290cy4gT24gcmVib290LCBTSU0gd2lsbCBwb3dlciB1cCBub3JtYWxseS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENBUkRfUE9XRVJfVVBfUEFTU19USFJPVUdIID0gMjsKCiAgICAvKioKICAgICAqIFNldCBTSU0gY2FyZCBwb3dlciBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3RhdGUgIFN0YXRlIG9mIFNJTSAocG93ZXIgZG93biwgcG93ZXIgdXAsIHBhc3MgdGhyb3VnaCkKICAgICAqIEBzZWUgI0NBUkRfUE9XRVJfRE9XTgogICAgICogQHNlZSAjQ0FSRF9QT1dFUl9VUAogICAgICogQHNlZSAjQ0FSRF9QT1dFUl9VUF9QQVNTX1RIUk9VR0gKICAgICAqIENhbGxlcnMgc2hvdWxkIG1vbml0b3IgZm9yIHtAbGluayBUZWxlcGhvbnlJbnRlbnRzI0FDVElPTl9TSU1fU1RBVEVfQ0hBTkdFRH0KICAgICAqIGJyb2FkY2FzdHMgdG8gZGV0ZXJtaW5lIHN1Y2Nlc3Mgb3IgZmFpbHVyZSBhbmQgdGltZW91dCBpZiBuZWVkZWQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICoKICAgICAqIHtAaGlkZX0KICAgICAqKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFNpbVBvd2VyU3RhdGUoaW50IHN0YXRlKSB7CiAgICAgICAgc2V0U2ltUG93ZXJTdGF0ZUZvclNsb3QoZ2V0U2xvdEluZGV4KCksIHN0YXRlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBTSU0gY2FyZCBwb3dlciBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IFNJTSBzbG90IGlkCiAgICAgKiBAcGFyYW0gc3RhdGUgIFN0YXRlIG9mIFNJTSAocG93ZXIgZG93biwgcG93ZXIgdXAsIHBhc3MgdGhyb3VnaCkKICAgICAqIEBzZWUgI0NBUkRfUE9XRVJfRE9XTgogICAgICogQHNlZSAjQ0FSRF9QT1dFUl9VUAogICAgICogQHNlZSAjQ0FSRF9QT1dFUl9VUF9QQVNTX1RIUk9VR0gKICAgICAqIENhbGxlcnMgc2hvdWxkIG1vbml0b3IgZm9yIHtAbGluayBUZWxlcGhvbnlJbnRlbnRzI0FDVElPTl9TSU1fU1RBVEVfQ0hBTkdFRH0KICAgICAqIGJyb2FkY2FzdHMgdG8gZGV0ZXJtaW5lIHN1Y2Nlc3Mgb3IgZmFpbHVyZSBhbmQgdGltZW91dCBpZiBuZWVkZWQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICoKICAgICAqIHtAaGlkZX0KICAgICAqKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFNpbVBvd2VyU3RhdGVGb3JTbG90KGludCBzbG90SW5kZXgsIGludCBzdGF0ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRTaW1Qb3dlclN0YXRlRm9yU2xvdChzbG90SW5kZXgsIHN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRTaW1Qb3dlclN0YXRlRm9yU2xvdCIsIGUpOwogICAgICAgIH0gY2F0Y2ggKFNlY3VyaXR5RXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiUGVybWlzc2lvbiBlcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc2V0U2ltUG93ZXJTdGF0ZUZvclNsb3QiLCBlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgYmFzZWJhbmQgdmVyc2lvbiBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAgKgogICAgICogQHBhcmFtIHZlcnNpb24gYmFzZWJhbmQgdmVyc2lvbgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0QmFzZWJhbmRWZXJzaW9uKFN0cmluZyB2ZXJzaW9uKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKCk7CiAgICAgICAgc2V0QmFzZWJhbmRWZXJzaW9uRm9yUGhvbmUocGhvbmVJZCwgdmVyc2lvbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgYmFzZWJhbmQgdmVyc2lvbiBieSBwaG9uZSBpZC4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVJZCBmb3Igd2hpY2ggYmFzZWJhbmQgdmVyc2lvbiBpcyBzZXQKICAgICAqIEBwYXJhbSB2ZXJzaW9uIGJhc2ViYW5kIHZlcnNpb24KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCwgdHJhY2tpbmdCdWcgPSAxMTU2MDkwMjMpCiAgICBwdWJsaWMgdm9pZCBzZXRCYXNlYmFuZFZlcnNpb25Gb3JQaG9uZShpbnQgcGhvbmVJZCwgU3RyaW5nIHZlcnNpb24pIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChwaG9uZUlkKSkgewogICAgICAgICAgICBMaXN0PFN0cmluZz4gbmV3TGlzdCA9IHVwZGF0ZVRlbGVwaG9ueVByb3BlcnR5KAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMuYmFzZWJhbmRfdmVyc2lvbigpLCBwaG9uZUlkLCB2ZXJzaW9uKTsKICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5iYXNlYmFuZF92ZXJzaW9uKG5ld0xpc3QpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCBiYXNlYmFuZCB2ZXJzaW9uIGZvciB0aGUgZGVmYXVsdCBwaG9uZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIGJhc2ViYW5kIHZlcnNpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldEJhc2ViYW5kVmVyc2lvbigpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICByZXR1cm4gZ2V0QmFzZWJhbmRWZXJzaW9uRm9yUGhvbmUocGhvbmVJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYmFzZWJhbmQgdmVyc2lvbiBieSBwaG9uZSBpZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIGJhc2ViYW5kIHZlcnNpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldEJhc2ViYW5kVmVyc2lvbkZvclBob25lKGludCBwaG9uZUlkKSB7CiAgICAgICAgcmV0dXJuIGdldFRlbGVwaG9ueVByb3BlcnR5KHBob25lSWQsIFRlbGVwaG9ueVByb3BlcnRpZXMuYmFzZWJhbmRfdmVyc2lvbigpLCAiIik7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgcGhvbmUgdHlwZSBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAgKgogICAgICogQHBhcmFtIHR5cGUgcGhvbmUgdHlwZQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFBob25lVHlwZShpbnQgdHlwZSkgewogICAgICAgIGludCBwaG9uZUlkID0gZ2V0UGhvbmVJZCgpOwogICAgICAgIHNldFBob25lVHlwZShwaG9uZUlkLCB0eXBlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBwaG9uZSB0eXBlIGJ5IHBob25lIGlkLgogICAgICoKICAgICAqIEBwYXJhbSBwaG9uZUlkIGZvciB3aGljaCBwaG9uZSB0eXBlIGlzIHNldAogICAgICogQHBhcmFtIHR5cGUgcGhvbmUgdHlwZQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCwgdHJhY2tpbmdCdWcgPSAxMTU2MDkwMjMpCiAgICBwdWJsaWMgdm9pZCBzZXRQaG9uZVR5cGUoaW50IHBob25lSWQsIGludCB0eXBlKSB7CiAgICAgICAgaWYgKFN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFBob25lSWQocGhvbmVJZCkpIHsKICAgICAgICAgICAgTGlzdDxJbnRlZ2VyPiBuZXdMaXN0ID0gdXBkYXRlVGVsZXBob255UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5jdXJyZW50X2FjdGl2ZV9waG9uZSgpLCBwaG9uZUlkLCB0eXBlKTsKICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5jdXJyZW50X2FjdGl2ZV9waG9uZShuZXdMaXN0KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgT1RBU1AgbnVtYmVyIHNjaGVtYSBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAgKgogICAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBkZWZhdWx0IHZhbHVlCiAgICAgKiBAcmV0dXJuIE9UQSBTUCBudW1iZXIgc2NoZW1hCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIFN0cmluZyBnZXRPdGFTcE51bWJlclNjaGVtYShTdHJpbmcgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKCk7CiAgICAgICAgcmV0dXJuIGdldE90YVNwTnVtYmVyU2NoZW1hRm9yUGhvbmUocGhvbmVJZCwgZGVmYXVsdFZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBPVEFTUCBudW1iZXIgc2NoZW1hIGJ5IHBob25lIGlkLgogICAgICoKICAgICAqIEBwYXJhbSBwaG9uZUlkIGZvciB3aGljaCBPVEEgU1AgbnVtYmVyIHNjaGVtYSBpcyBnZXQKICAgICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgZGVmYXVsdCB2YWx1ZQogICAgICogQHJldHVybiBPVEEgU1AgbnVtYmVyIHNjaGVtYQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCwgdHJhY2tpbmdCdWcgPSAxMTU2MDkwMjMpCiAgICBwdWJsaWMgU3RyaW5nIGdldE90YVNwTnVtYmVyU2NoZW1hRm9yUGhvbmUoaW50IHBob25lSWQsIFN0cmluZyBkZWZhdWx0VmFsdWUpIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChwaG9uZUlkKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0VGVsZXBob255UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgcGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5vdGFzcF9udW1fc2NoZW1hKCksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IFNNUyByZWNlaXZlIGNhcGFibGUgZnJvbSBzeXN0ZW0gcHJvcGVydHkgZm9yIHRoZSBkZWZhdWx0IHBob25lLgogICAgICoKICAgICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgZGVmYXVsdCB2YWx1ZQogICAgICogQHJldHVybiBTTVMgcmVjZWl2ZSBjYXBhYmxlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gZ2V0U21zUmVjZWl2ZUNhcGFibGUoYm9vbGVhbiBkZWZhdWx0VmFsdWUpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICByZXR1cm4gZ2V0U21zUmVjZWl2ZUNhcGFibGVGb3JQaG9uZShwaG9uZUlkLCBkZWZhdWx0VmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IFNNUyByZWNlaXZlIGNhcGFibGUgZnJvbSBzeXN0ZW0gcHJvcGVydHkgYnkgcGhvbmUgaWQuCiAgICAgKgogICAgICogQHBhcmFtIHBob25lSWQgZm9yIHdoaWNoIFNNUyByZWNlaXZlIGNhcGFibGUgaXMgZ2V0CiAgICAgKiBAcGFyYW0gZGVmYXVsdFZhbHVlIGRlZmF1bHQgdmFsdWUKICAgICAqIEByZXR1cm4gU01TIHJlY2VpdmUgY2FwYWJsZQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGdldFNtc1JlY2VpdmVDYXBhYmxlRm9yUGhvbmUoaW50IHBob25lSWQsIGJvb2xlYW4gZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgaWYgKFN1YnNjcmlwdGlvbk1hbmFnZXIuaXNWYWxpZFBob25lSWQocGhvbmVJZCkpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFRlbGVwaG9ueVByb3BlcnR5KHBob25lSWQsIFRlbGVwaG9ueVByb3BlcnRpZXMuc21zX3JlY2VpdmUoKSwgZGVmYXVsdFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgU01TIHNlbmQgY2FwYWJsZSBmcm9tIHN5c3RlbSBwcm9wZXJ0eSBmb3IgdGhlIGRlZmF1bHQgcGhvbmUuCiAgICAgKgogICAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBkZWZhdWx0IHZhbHVlCiAgICAgKiBAcmV0dXJuIFNNUyBzZW5kIGNhcGFibGUKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBnZXRTbXNTZW5kQ2FwYWJsZShib29sZWFuIGRlZmF1bHRWYWx1ZSkgewogICAgICAgIGludCBwaG9uZUlkID0gZ2V0UGhvbmVJZCgpOwogICAgICAgIHJldHVybiBnZXRTbXNTZW5kQ2FwYWJsZUZvclBob25lKHBob25lSWQsIGRlZmF1bHRWYWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgU01TIHNlbmQgY2FwYWJsZSBmcm9tIHN5c3RlbSBwcm9wZXJ0eSBieSBwaG9uZSBpZC4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVJZCBmb3Igd2hpY2ggU01TIHNlbmQgY2FwYWJsZSBpcyBnZXQKICAgICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgZGVmYXVsdCB2YWx1ZQogICAgICogQHJldHVybiBTTVMgc2VuZCBjYXBhYmxlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gZ2V0U21zU2VuZENhcGFibGVGb3JQaG9uZShpbnQgcGhvbmVJZCwgYm9vbGVhbiBkZWZhdWx0VmFsdWUpIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChwaG9uZUlkKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0VGVsZXBob255UHJvcGVydHkocGhvbmVJZCwgVGVsZXBob255UHJvcGVydGllcy5zbXNfc2VuZCgpLCBkZWZhdWx0VmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGRlZmF1bHQgUmVzcG9uZCBWaWEgTWVzc2FnZSBhcHBsaWNhdGlvbiwgdXBkYXRpbmcgdGhlIGNhY2hlIGlmIHRoZXJlIGlzIG5vCiAgICAgKiByZXNwb25kLXZpYS1tZXNzYWdlIGFwcGxpY2F0aW9uIGN1cnJlbnRseSBjb25maWd1cmVkLgogICAgICogQHJldHVybiBjb21wb25lbnQgbmFtZSBvZiB0aGUgYXBwIGFuZCBjbGFzcyB0byBkaXJlY3QgUmVzcG9uZCBWaWEgTWVzc2FnZSBpbnRlbnQgdG8sIG9yCiAgICAgKiB7QGNvZGUgbnVsbH0gaWYgdGhlIGZ1bmN0aW9uYWxpdHkgaXMgbm90IHN1cHBvcnRlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uSU5URVJBQ1RfQUNST1NTX1VTRVJTKQogICAgcHVibGljIEBOdWxsYWJsZSBDb21wb25lbnROYW1lIGdldEFuZFVwZGF0ZURlZmF1bHRSZXNwb25kVmlhTWVzc2FnZUFwcGxpY2F0aW9uKCkgewogICAgICAgIHJldHVybiBTbXNBcHBsaWNhdGlvbi5nZXREZWZhdWx0UmVzcG9uZFZpYU1lc3NhZ2VBcHBsaWNhdGlvbihtQ29udGV4dCwgdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBkZWZhdWx0IFJlc3BvbmQgVmlhIE1lc3NhZ2UgYXBwbGljYXRpb24uCiAgICAgKiBAcmV0dXJuIGNvbXBvbmVudCBuYW1lIG9mIHRoZSBhcHAgYW5kIGNsYXNzIHRvIGRpcmVjdCBSZXNwb25kIFZpYSBNZXNzYWdlIGludGVudCB0bywgb3IKICAgICAqIHtAY29kZSBudWxsfSBpZiB0aGUgZnVuY3Rpb25hbGl0eSBpcyBub3Qgc3VwcG9ydGVkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFRlc3RBcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5JTlRFUkFDVF9BQ1JPU1NfVVNFUlMpCiAgICBwdWJsaWMgQE51bGxhYmxlIENvbXBvbmVudE5hbWUgZ2V0RGVmYXVsdFJlc3BvbmRWaWFNZXNzYWdlQXBwbGljYXRpb24oKSB7CiAgICAgICAgcmV0dXJuIFNtc0FwcGxpY2F0aW9uLmdldERlZmF1bHRSZXNwb25kVmlhTWVzc2FnZUFwcGxpY2F0aW9uKG1Db250ZXh0LCBmYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFscGhhYmV0aWMgbmFtZSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IuCiAgICAgKiBAcGFyYW0gbmFtZSB0aGUgYWxwaGFiZXRpYyBuYW1lIG9mIGN1cnJlbnQgcmVnaXN0ZXJlZCBvcGVyYXRvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldE5ldHdvcmtPcGVyYXRvck5hbWUoU3RyaW5nIG5hbWUpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICBzZXROZXR3b3JrT3BlcmF0b3JOYW1lRm9yUGhvbmUocGhvbmVJZCwgbmFtZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFscGhhYmV0aWMgbmFtZSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IuCiAgICAgKiBAcGFyYW0gcGhvbmVJZCB3aGljaCBwaG9uZSB5b3Ugd2FudCB0byBzZXQKICAgICAqIEBwYXJhbSBuYW1lIHRoZSBhbHBoYWJldGljIG5hbWUgb2YgY3VycmVudCByZWdpc3RlcmVkIG9wZXJhdG9yLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyB2b2lkIHNldE5ldHdvcmtPcGVyYXRvck5hbWVGb3JQaG9uZShpbnQgcGhvbmVJZCwgU3RyaW5nIG5hbWUpIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChwaG9uZUlkKSkgewogICAgICAgICAgICBMaXN0PFN0cmluZz4gbmV3TGlzdCA9IHVwZGF0ZVRlbGVwaG9ueVByb3BlcnR5KAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMub3BlcmF0b3JfYWxwaGEoKSwgcGhvbmVJZCwgbmFtZSk7CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMub3BlcmF0b3JfYWxwaGEobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBudW1lcmljIG5hbWUgKE1DQytNTkMpIG9mIGN1cnJlbnQgcmVnaXN0ZXJlZCBvcGVyYXRvci4KICAgICAqIEBwYXJhbSBvcGVyYXRvciB0aGUgbnVtZXJpYyBuYW1lIChNQ0MrTU5DKSBvZiBjdXJyZW50IHJlZ2lzdGVyZWQgb3BlcmF0b3IKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldE5ldHdvcmtPcGVyYXRvck51bWVyaWMoU3RyaW5nIG51bWVyaWMpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICBzZXROZXR3b3JrT3BlcmF0b3JOdW1lcmljRm9yUGhvbmUocGhvbmVJZCwgbnVtZXJpYyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIG51bWVyaWMgbmFtZSAoTUNDK01OQykgb2YgY3VycmVudCByZWdpc3RlcmVkIG9wZXJhdG9yLgogICAgICogQHBhcmFtIHBob25lSWQgZm9yIHdoaWNoIHBob25lIHR5cGUgaXMgc2V0CiAgICAgKiBAcGFyYW0gb3BlcmF0b3IgdGhlIG51bWVyaWMgbmFtZSAoTUNDK01OQykgb2YgY3VycmVudCByZWdpc3RlcmVkIG9wZXJhdG9yCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHZvaWQgc2V0TmV0d29ya09wZXJhdG9yTnVtZXJpY0ZvclBob25lKGludCBwaG9uZUlkLCBTdHJpbmcgbnVtZXJpYykgewogICAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVmFsaWRQaG9uZUlkKHBob25lSWQpKSB7CiAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBuZXdMaXN0ID0gdXBkYXRlVGVsZXBob255UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5vcGVyYXRvcl9udW1lcmljKCksIHBob25lSWQsIG51bWVyaWMpOwogICAgICAgICAgICBUZWxlcGhvbnlQcm9wZXJ0aWVzLm9wZXJhdG9yX251bWVyaWMobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IHJvYW1pbmcgc3RhdGUgb2YgdGhlIGN1cnJlbnQgbmV0d29yaywgZm9yIEdTTSBwdXJwb3Nlcy4KICAgICAqIEBwYXJhbSBpc1JvYW1pbmcgaXMgbmV0d29yayBpbiByb21haW5nIHN0YXRlIG9yIG5vdAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0TmV0d29ya1JvYW1pbmcoYm9vbGVhbiBpc1JvYW1pbmcpIHsKICAgICAgICBpbnQgcGhvbmVJZCA9IGdldFBob25lSWQoKTsKICAgICAgICBzZXROZXR3b3JrUm9hbWluZ0ZvclBob25lKHBob25lSWQsIGlzUm9hbWluZyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgcm9hbWluZyBzdGF0ZSBvZiB0aGUgY3VycmVudCBuZXR3b3JrLCBmb3IgR1NNIHB1cnBvc2VzLgogICAgICogQHBhcmFtIHBob25lSWQgd2hpY2ggcGhvbmUgeW91IHdhbnQgdG8gc2V0CiAgICAgKiBAcGFyYW0gaXNSb2FtaW5nIGlzIG5ldHdvcmsgaW4gcm9tYWluZyBzdGF0ZSBvciBub3QKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgdm9pZCBzZXROZXR3b3JrUm9hbWluZ0ZvclBob25lKGludCBwaG9uZUlkLCBib29sZWFuIGlzUm9hbWluZykgewogICAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVmFsaWRQaG9uZUlkKHBob25lSWQpKSB7CiAgICAgICAgICAgIExpc3Q8Qm9vbGVhbj4gbmV3TGlzdCA9IHVwZGF0ZVRlbGVwaG9ueVByb3BlcnR5KAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMub3BlcmF0b3JfaXNfcm9hbWluZygpLCBwaG9uZUlkLCBpc1JvYW1pbmcpOwogICAgICAgICAgICBUZWxlcGhvbnlQcm9wZXJ0aWVzLm9wZXJhdG9yX2lzX3JvYW1pbmcobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBuZXR3b3JrIHR5cGUgY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlIGZvciBkYXRhIHRyYW5zbWlzc2lvbi4KICAgICAqCiAgICAgKiBJZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBwaG9uZUlkIGFzc29jaWF0ZWQgd2l0aCB0aGUgZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB0aGUgcGhvbmVJZCBhc3NvY2lhdGVkIHdpdGgKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqIEBwYXJhbSB0eXBlIHRoZSBuZXR3b3JrIHR5cGUgY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlIGZvciBkYXRhIHRyYW5zbWlzc2lvbgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0RGF0YU5ldHdvcmtUeXBlKGludCB0eXBlKSB7CiAgICAgICAgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKTsKICAgICAgICBzZXREYXRhTmV0d29ya1R5cGVGb3JQaG9uZShwaG9uZUlkLCB0eXBlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgbmV0d29yayB0eXBlIGN1cnJlbnRseSBpbiB1c2Ugb24gdGhlIGRldmljZSBmb3IgZGF0YSB0cmFuc21pc3Npb24uCiAgICAgKiBAcGFyYW0gcGhvbmVJZCB3aGljaCBwaG9uZSB5b3Ugd2FudCB0byBzZXQKICAgICAqIEBwYXJhbSB0eXBlIHRoZSBuZXR3b3JrIHR5cGUgY3VycmVudGx5IGluIHVzZSBvbiB0aGUgZGV2aWNlIGZvciBkYXRhIHRyYW5zbWlzc2lvbgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyB2b2lkIHNldERhdGFOZXR3b3JrVHlwZUZvclBob25lKGludCBwaG9uZUlkLCBpbnQgdHlwZSkgewogICAgICAgIGlmIChTdWJzY3JpcHRpb25NYW5hZ2VyLmlzVmFsaWRQaG9uZUlkKHBob25lSWQpKSB7CiAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBuZXdMaXN0ID0gdXBkYXRlVGVsZXBob255UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255UHJvcGVydGllcy5kYXRhX25ldHdvcmtfdHlwZSgpLCBwaG9uZUlkLAogICAgICAgICAgICAgICAgICAgIFNlcnZpY2VTdGF0ZS5yaWxSYWRpb1RlY2hub2xvZ3lUb1N0cmluZyh0eXBlKSk7CiAgICAgICAgICAgIFRlbGVwaG9ueVByb3BlcnRpZXMuZGF0YV9uZXR3b3JrX3R5cGUobmV3TGlzdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3Vic2NyaXB0aW9uIElEIGZvciB0aGUgZ2l2ZW4gcGhvbmUgYWNjb3VudC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IGdldFN1YklkRm9yUGhvbmVBY2NvdW50KEBOdWxsYWJsZSBQaG9uZUFjY291bnQgcGhvbmVBY2NvdW50KSB7CiAgICAgICAgaW50IHJldHZhbCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR2YWwgPSBzZXJ2aWNlLmdldFN1YklkRm9yUGhvbmVBY2NvdW50KHBob25lQWNjb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldHZhbDsKICAgIH0KCiAgICAvKioKICAgICAqIERldGVybWluZXMgdGhlIHtAbGluayBQaG9uZUFjY291bnRIYW5kbGV9IGFzc29jaWF0ZWQgd2l0aCBhIHN1YnNjcmlwdGlvbiBJZC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgVGhlIHN1YnNjcmlwdGlvbiBJZCB0byBjaGVjay4KICAgICAqIEByZXR1cm4gVGhlIHtAbGluayBQaG9uZUFjY291bnRIYW5kbGV9IGFzc29jaWF0ZWQgd2l0aCBhIHN1YnNjcmlwdGlvbiBJZCwgb3Ige0Bjb2RlIG51bGx9IGlmCiAgICAgKiB0aGVyZSBpcyBubyBhc3NvY2lhdGVkIHtAbGluayBQaG9uZUFjY291bnRIYW5kbGV9LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOdWxsYWJsZSBQaG9uZUFjY291bnRIYW5kbGUgZ2V0UGhvbmVBY2NvdW50SGFuZGxlRm9yU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgUGhvbmVBY2NvdW50SGFuZGxlIHJldHVyblZhbHVlID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVyblZhbHVlID0gc2VydmljZS5nZXRQaG9uZUFjY291bnRIYW5kbGVGb3JTdWJzY3JpcHRpb25JZChzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldHVyblZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3Vic2NyaXB0aW9uIElEIGZvciB0aGUgZ2l2ZW4gcGhvbmUgYWNjb3VudCBoYW5kbGUuCiAgICAgKgogICAgICogQHBhcmFtIHBob25lQWNjb3VudEhhbmRsZSB0aGUgcGhvbmUgYWNjb3VudCBoYW5kbGUgZm9yIG91dGdvaW5nIGNhbGxzCiAgICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBJRCBmb3IgdGhlIGdpdmVuIHBob25lIGFjY291bnQgaGFuZGxlOyBvcgogICAgICogICAgICAgICB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNJTlZBTElEX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgaWYgbm90IGF2YWlsYWJsZTsgb3IgdGhyb3cgYSBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgaGF2ZSB0aGUKICAgICAqICAgICAgICAgcGVybWlzc2lvbi4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgZ2V0U3Vic2NyaXB0aW9uSWQoQE5vbk51bGwgUGhvbmVBY2NvdW50SGFuZGxlIHBob25lQWNjb3VudEhhbmRsZSkgewogICAgICAgIGludCByZXR2YWwgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLklOVkFMSURfU1VCU0NSSVBUSU9OX0lEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dmFsID0gc2VydmljZS5nZXRTdWJJZEZvclBob25lQWNjb3VudEhhbmRsZSgKICAgICAgICAgICAgICAgICAgICAgICAgcGhvbmVBY2NvdW50SGFuZGxlLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgImdldFN1YnNjcmlwdGlvbklkIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0dmFsOwogICAgfQoKICAgIC8qKgogICAgICogUmVzZXRzIHRlbGVwaG9ueSBtYW5hZ2VyIHNldHRpbmdzIGJhY2sgdG8gZmFjdG9yeSBkZWZhdWx0cy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgdm9pZCBmYWN0b3J5UmVzZXQoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgTG9nLmQoVEFHLCAiZmFjdG9yeVJlc2V0OiBzdWJJZD0iICsgc3ViSWQpOwogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuZmFjdG9yeVJlc2V0KHN1YklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIFJlc2V0cyBUZWxlcGhvbnkgYW5kIElNUyBzZXR0aW5ncyBiYWNrIHRvIGZhY3RvcnkgZGVmYXVsdHMgb25seSBmb3IgdGhlIHN1YnNjcmlwdGlvbgogICAgICogYXNzb2NpYXRlZCB3aXRoIHRoaXMgaW5zdGFuY2UuCiAgICAgKiBAc2VlICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZChpbnQpCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uQ09OTkVDVElWSVRZX0lOVEVSTkFMKQogICAgcHVibGljIHZvaWQgcmVzZXRTZXR0aW5ncygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBMb2cuZChUQUcsICJyZXNldFNldHRpbmdzOiBzdWJJZD0iICsgZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5mYWN0b3J5UmVzZXQoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgbG9jYWxlIGJhc2VkIG9uIHRoZSBjb3VudHJ5IGFuZCBsYW5ndWFnZSBmcm9tIHRoZSBTSU0uIFJldHVybnMge0Bjb2RlIG51bGx9IGlmCiAgICAgKiBubyBsb2NhbGUgY291bGQgYmUgZGVyaXZlZCBmcm9tIHN1YnNjcmlwdGlvbnMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiBAc2VlIExvY2FsZSN0b0xhbmd1YWdlVGFnKCkKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBATnVsbGFibGUgcHVibGljIExvY2FsZSBnZXRTaW1Mb2NhbGUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmluYWwgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgU3RyaW5nIGxhbmd1YWdlVGFnID0gdGVsZXBob255LmdldFNpbUxvY2FsZUZvclN1YnNjcmliZXIoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgICAgICBpZiAoIVRleHRVdGlscy5pc0VtcHR5KGxhbmd1YWdlVGFnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBMb2NhbGUuZm9yTGFuZ3VhZ2VUYWcobGFuZ3VhZ2VUYWcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogVE9ETyBkZWxldGUgYWZ0ZXIgU3VXIG1pZ3JhdGVzIHRvIG5ldyBBUEkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldExvY2FsZUZyb21EZWZhdWx0U2ltKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZpbmFsIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0U2ltTG9jYWxlRm9yU3Vic2NyaWJlcihnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXF1ZXN0cyB0aGUgbW9kZW0gYWN0aXZpdHkgaW5mby4gVGhlIHJlY2lwaWVudCB3aWxsIHBsYWNlIHRoZSByZXN1bHQKICAgICAqIGluIGByZXN1bHRgLgogICAgICogQHBhcmFtIHJlc3VsdCBUaGUgb2JqZWN0IG9uIHdoaWNoIHRoZSByZWNpcGllbnQgd2lsbCBzZW5kIHRoZSByZXN1bHRpbmcKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5Nb2RlbUFjdGl2aXR5SW5mb30gb2JqZWN0IHdpdGgga2V5IG9mCiAgICAgKiB7QGxpbmsgI01PREVNX0FDVElWSVRZX1JFU1VMVF9LRVl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgcmVxdWVzdE1vZGVtQWN0aXZpdHlJbmZvKEBOb25OdWxsIFJlc3VsdFJlY2VpdmVyIHJlc3VsdCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VydmljZS5yZXF1ZXN0TW9kZW1BY3Rpdml0eUluZm8ocmVzdWx0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNnZXRNb2RlbUFjdGl2aXR5SW5mbyIsIGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuc2VuZCgwLCBudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQge0BsaW5rIFNlcnZpY2VTdGF0ZX0gaW5mb3JtYXRpb24uCiAgICAgKgogICAgICogPHA+SWYgdGhpcyBvYmplY3QgaGFzIGJlZW4gY3JlYXRlZCB3aXRoIHtAbGluayAjY3JlYXRlRm9yU3Vic2NyaXB0aW9uSWR9LCBhcHBsaWVzIHRvIHRoZQogICAgICogZ2l2ZW4gc3ViSWQuIE90aGVyd2lzZSwgYXBwbGllcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkKICAgICAqIGFuZCB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI0FDQ0VTU19DT0FSU0VfTE9DQVRJT059LgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbGxPZiA9IHsKICAgICAgICAgICAgTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFLAogICAgICAgICAgICBNYW5pZmVzdC5wZXJtaXNzaW9uLkFDQ0VTU19DT0FSU0VfTE9DQVRJT04KICAgIH0pCiAgICBwdWJsaWMgU2VydmljZVN0YXRlIGdldFNlcnZpY2VTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gZ2V0U2VydmljZVN0YXRlRm9yU3Vic2NyaWJlcihnZXRTdWJJZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHNlcnZpY2Ugc3RhdGUgaW5mb3JtYXRpb24gb24gc3BlY2lmaWVkIHN1YnNjcmlwdGlvbi4gQ2FsbGVycyByZXF1aXJlCiAgICAgKiBlaXRoZXIgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIG9yIFJFQURfUEhPTkVfU1RBVEUgdG8gcmV0cmlldmUgdGhlIGluZm9ybWF0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIFNlcnZpY2VTdGF0ZSBnZXRTZXJ2aWNlU3RhdGVGb3JTdWJzY3JpYmVyKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0U2VydmljZVN0YXRlRm9yU3Vic2NyaWJlcihzdWJJZCwgZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNnZXRTZXJ2aWNlU3RhdGVGb3JTdWJzY3JpYmVyIiwgZSk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZSkgewogICAgICAgICAgICBBbm9tYWx5UmVwb3J0ZXIucmVwb3J0QW5vbWFseSgKICAgICAgICAgICAgICAgICAgICBVVUlELmZyb21TdHJpbmcoImEzYWIwYjlkLWYyYWEtNGJhZi05MTFkLTcwOTZjMGQ0NjQ1YSIpLAogICAgICAgICAgICAgICAgICAgICJnZXRTZXJ2aWNlU3RhdGVGb3JTdWJzY3JpYmVyICIgKyBzdWJJZCArICIgTlBFIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgVVJJIGZvciB0aGUgcGVyLWFjY291bnQgdm9pY2VtYWlsIHJpbmd0b25lIHNldCBpbiBQaG9uZSBzZXR0aW5ncy4KICAgICAqCiAgICAgKiBAcGFyYW0gYWNjb3VudEhhbmRsZSBUaGUgaGFuZGxlIGZvciB0aGUge0BsaW5rIFBob25lQWNjb3VudH0gZm9yIHdoaWNoIHRvIHJldHJpZXZlIHRoZQogICAgICogdm9pY2VtYWlsIHJpbmd0b25lLgogICAgICogQHJldHVybiBUaGUgVVJJIGZvciB0aGUgcmluZ3RvbmUgdG8gcGxheSB3aGVuIHJlY2VpdmluZyBhIHZvaWNlbWFpbCBmcm9tIGEgc3BlY2lmaWMKICAgICAqIFBob25lQWNjb3VudC4KICAgICAqLwogICAgcHVibGljIFVyaSBnZXRWb2ljZW1haWxSaW5ndG9uZVVyaShQaG9uZUFjY291bnRIYW5kbGUgYWNjb3VudEhhbmRsZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0Vm9pY2VtYWlsUmluZ3RvbmVVcmkoYWNjb3VudEhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjZ2V0Vm9pY2VtYWlsUmluZ3RvbmVVcmkiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBwZXItYWNjb3VudCB2b2ljZW1haWwgcmluZ3RvbmUuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaXMgdGhlIGRlZmF1bHQgZGlhbGVyLCBvciBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9LCBvciBoYXMgcGVybWlzc2lvbgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gcGhvbmVBY2NvdW50SGFuZGxlIFRoZSBoYW5kbGUgZm9yIHRoZSB7QGxpbmsgUGhvbmVBY2NvdW50fSBmb3Igd2hpY2ggdG8gc2V0IHRoZQogICAgICogdm9pY2VtYWlsIHJpbmd0b25lLgogICAgICogQHBhcmFtIHVyaSBUaGUgVVJJIGZvciB0aGUgcmluZ3RvbmUgdG8gcGxheSB3aGVuIHJlY2VpdmluZyBhIHZvaWNlbWFpbCBmcm9tIGEgc3BlY2lmaWMKICAgICAqIFBob25lQWNjb3VudC4KICAgICAqCiAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rIGFuZHJvaWQucHJvdmlkZXIuU2V0dGluZ3MjQUNUSU9OX0NIQU5ORUxfTk9USUZJQ0FUSU9OX1NFVFRJTkdTfQogICAgICogaW5zdGVhZC4KICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0Vm9pY2VtYWlsUmluZ3RvbmVVcmkoUGhvbmVBY2NvdW50SGFuZGxlIHBob25lQWNjb3VudEhhbmRsZSwgVXJpIHVyaSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VydmljZS5zZXRWb2ljZW1haWxSaW5ndG9uZVVyaShnZXRPcFBhY2thZ2VOYW1lKCksIHBob25lQWNjb3VudEhhbmRsZSwgdXJpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRWb2ljZW1haWxSaW5ndG9uZVVyaSIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2hldGhlciB2aWJyYXRpb24gaXMgc2V0IGZvciB2b2ljZW1haWwgbm90aWZpY2F0aW9uIGluIFBob25lIHNldHRpbmdzLgogICAgICoKICAgICAqIEBwYXJhbSBhY2NvdW50SGFuZGxlIFRoZSBoYW5kbGUgZm9yIHRoZSB7QGxpbmsgUGhvbmVBY2NvdW50fSBmb3Igd2hpY2ggdG8gcmV0cmlldmUgdGhlCiAgICAgKiB2b2ljZW1haWwgdmlicmF0aW9uIHNldHRpbmcuCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgdmlicmF0aW9uIGlzIHNldCBmb3IgdGhpcyBQaG9uZUFjY291bnQsIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc1ZvaWNlbWFpbFZpYnJhdGlvbkVuYWJsZWQoUGhvbmVBY2NvdW50SGFuZGxlIGFjY291bnRIYW5kbGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmlzVm9pY2VtYWlsVmlicmF0aW9uRW5hYmxlZChhY2NvdW50SGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc1ZvaWNlbWFpbFZpYnJhdGlvbkVuYWJsZWQiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGVyLWFjY291bnQgcHJlZmVyZW5jZSB3aGV0aGVyIHZpYnJhdGlvbiBpcyBlbmFibGVkIGZvciB2b2ljZW1haWwgbm90aWZpY2F0aW9ucy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGF0IHRoZSBjYWxsaW5nIGFwcCBpcyB0aGUgZGVmYXVsdCBkaWFsZXIsIG9yIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30sIG9yIGhhcyBwZXJtaXNzaW9uCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9LgogICAgICoKICAgICAqIEBwYXJhbSBwaG9uZUFjY291bnRIYW5kbGUgVGhlIGhhbmRsZSBmb3IgdGhlIHtAbGluayBQaG9uZUFjY291bnR9IGZvciB3aGljaCB0byBzZXQgdGhlCiAgICAgKiB2b2ljZW1haWwgdmlicmF0aW9uIHNldHRpbmcuCiAgICAgKiBAcGFyYW0gZW5hYmxlZCBXaGV0aGVyIHRvIGVuYWJsZSBvciBkaXNhYmxlIHZpYnJhdGlvbiBmb3Igdm9pY2VtYWlsIG5vdGlmaWNhdGlvbnMgZnJvbSBhCiAgICAgKiBzcGVjaWZpYyBQaG9uZUFjY291bnQuCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBhbmRyb2lkLnByb3ZpZGVyLlNldHRpbmdzI0FDVElPTl9DSEFOTkVMX05PVElGSUNBVElPTl9TRVRUSU5HU30KICAgICAqIGluc3RlYWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFZvaWNlbWFpbFZpYnJhdGlvbkVuYWJsZWQoUGhvbmVBY2NvdW50SGFuZGxlIHBob25lQWNjb3VudEhhbmRsZSwKICAgICAgICAgICAgYm9vbGVhbiBlbmFibGVkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXJ2aWNlLnNldFZvaWNlbWFpbFZpYnJhdGlvbkVuYWJsZWQoZ2V0T3BQYWNrYWdlTmFtZSgpLCBwaG9uZUFjY291bnRIYW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2lzVm9pY2VtYWlsVmlicmF0aW9uRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgY2FycmllciBpZCBvZiB0aGUgY3VycmVudCBzdWJzY3JpcHRpb24uCiAgICAgKiA8cD5UbyByZWNvZ25pemUgYSBjYXJyaWVyIChpbmNsdWRpbmcgTVZOTykgYXMgYSBmaXJzdC1jbGFzcyBpZGVudGl0eSwgQW5kcm9pZCBhc3NpZ25zIGVhY2gKICAgICAqIGNhcnJpZXIgd2l0aCBhIGNhbm9uaWNhbCBpbnRlZ2VyIGEuay5hLiBjYXJyaWVyIGlkLiBUaGUgY2FycmllciBJRCBpcyBhbiBBbmRyb2lkCiAgICAgKiBwbGF0Zm9ybS13aWRlIGlkZW50aWZpZXIgZm9yIGEgY2Fycmllci4gQU9TUCBtYWludGFpbnMgY2FycmllciBJRCBhc3NpZ25tZW50cyBpbgogICAgICogPGEgaHJlZj0iaHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vcGFja2FnZXMvcHJvdmlkZXJzL1RlbGVwaG9ueVByb3ZpZGVyLysvbWFzdGVyL2Fzc2V0cy9sYXRlc3RfY2Fycmllcl9pZC9jYXJyaWVyX2xpc3QudGV4dHBiIj5oZXJlPC9hPgogICAgICoKICAgICAqIDxwPkFwcHMgd2hpY2ggaGF2ZSBjYXJyaWVyLXNwZWNpZmljIGNvbmZpZ3VyYXRpb25zIG9yIGJ1c2luZXNzIGxvZ2ljIGNhbiB1c2UgdGhlIGNhcnJpZXIgaWQKICAgICAqIGFzIGFuIEFuZHJvaWQgcGxhdGZvcm0td2lkZSBpZGVudGlmaWVyIGZvciBjYXJyaWVycy4KICAgICAqCiAgICAgKiBAcmV0dXJuIENhcnJpZXIgaWQgb2YgdGhlIGN1cnJlbnQgc3Vic2NyaXB0aW9uLiBSZXR1cm4ge0BsaW5rICNVTktOT1dOX0NBUlJJRVJfSUR9IGlmIHRoZQogICAgICogc3Vic2NyaXB0aW9uIGlzIHVuYXZhaWxhYmxlIG9yIHRoZSBjYXJyaWVyIGNhbm5vdCBiZSBpZGVudGlmaWVkLgogICAgICovCiAgICBwdWJsaWMgaW50IGdldFNpbUNhcnJpZXJJZCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmdldFN1YnNjcmlwdGlvbkNhcnJpZXJJZChnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgICAgICByZXR1cm4gVU5LTk9XTl9DQVJSSUVSX0lEOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYXJyaWVyIGlkIG5hbWUgb2YgdGhlIGN1cnJlbnQgc3Vic2NyaXB0aW9uLgogICAgICogPHA+Q2FycmllciBpZCBuYW1lIGlzIGEgdXNlci1mYWNpbmcgbmFtZSBvZiBjYXJyaWVyIGlkIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZCgpfSwgdXN1YWxseSB0aGUgYnJhbmQgbmFtZSBvZiB0aGUgc3Vic2lkaWFyeQogICAgICogKGUuZy4gVC1Nb2JpbGUpLiBFYWNoIGNhcnJpZXIgY291bGQgY29uZmlndXJlIG11bHRpcGxlIHtAbGluayAjZ2V0U2ltT3BlcmF0b3JOYW1lKCkgU1BOfSBidXQKICAgICAqIHNob3VsZCBoYXZlIGEgc2luZ2xlIGNhcnJpZXIgbmFtZS4gQ2FycmllciBuYW1lIGlzIG5vdCBhIGNhbm9uaWNhbCBpZGVudGl0eSwKICAgICAqIHVzZSB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZCgpfSBpbnN0ZWFkLgogICAgICogPHA+VGhlIHJldHVybmVkIGNhcnJpZXIgbmFtZSBpcyB1bmxvY2FsaXplZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIENhcnJpZXIgbmFtZSBvZiB0aGUgY3VycmVudCBzdWJzY3JpcHRpb24uIFJldHVybiB7QGNvZGUgbnVsbH0gaWYgdGhlIHN1YnNjcmlwdGlvbiBpcwogICAgICogdW5hdmFpbGFibGUgb3IgdGhlIGNhcnJpZXIgY2Fubm90IGJlIGlkZW50aWZpZWQuCiAgICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgQ2hhclNlcXVlbmNlIGdldFNpbUNhcnJpZXJJZE5hbWUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRTdWJzY3JpcHRpb25DYXJyaWVyTmFtZShnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgZmluZS1ncmFpbmVkIGNhcnJpZXIgSUQgb2YgdGhlIGN1cnJlbnQgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIEEgc3BlY2lmaWMgY2FycmllciBJRCBjYW4gcmVwcmVzZW50IHRoZSBmYWN0IHRoYXQgYSBjYXJyaWVyIG1heSBiZSBpbiBlZmZlY3QgYW4gYWdncmVnYXRpb24KICAgICAqIG9mIG90aGVyIGNhcnJpZXJzIChpZSBpbiBhbiBNVk5PIHR5cGUgc2NlbmFyaW8pIHdoZXJlIGVhY2ggb2YgdGhlc2Ugc3BlY2lmaWMgY2FycmllcnMgd2hpY2gKICAgICAqIGFyZSB1c2VkIHRvIG1ha2UgdXAgdGhlIGFjdHVhbCBjYXJyaWVyIHNlcnZpY2UgbWF5IGhhdmUgZGlmZmVyZW50IGNhcnJpZXIgY29uZmlndXJhdGlvbnMuCiAgICAgKiBBIHNwZWNpZmljIGNhcnJpZXIgSUQgY291bGQgYWxzbyBiZSB1c2VkLCBmb3IgZXhhbXBsZSwgaW4gYSBzY2VuYXJpbyB3aGVyZSBhIGNhcnJpZXIgcmVxdWlyZXMKICAgICAqIGRpZmZlcmVudCBjYXJyaWVyIGNvbmZpZ3VyYXRpb24gZm9yIGRpZmZlcmVudCBzZXJ2aWNlIG9mZmVyaW5nIHN1Y2ggYXMgYSBwcmVwYWlkIHBsYW4uCiAgICAgKgogICAgICogdGhlIHNwZWNpZmljIGNhcnJpZXIgSUQgd291bGQgYmUgdXNlZCBmb3IgY29uZmlndXJhdGlvbiBwdXJwb3NlcywgYnV0IGFwcHMgd2lzaGluZyB0byBrbm93CiAgICAgKiBhYm91dCB0aGUgY2FycmllciBpdHNlbGYgc2hvdWxkIHVzZSB0aGUgcmVndWxhciBjYXJyaWVyIElEIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZCgpfS4KICAgICAqCiAgICAgKiBlLmcsIFRyYWNmb25lIFNJTXMgY291bGQgcmV0dXJuIGRpZmZlcmVudCBzcGVjaWZpYyBjYXJyaWVyIElEIGJhc2VkIG9uIElNU0kgZnJvbSBjdXJyZW50CiAgICAgKiBzdWJzY3JpcHRpb24gd2hpbGUgY2FycmllciBJRCByZW1haW5zIHRoZSBzYW1lLgogICAgICoKICAgICAqIDxwPkZvciBjYXJyaWVycyB3aXRob3V0IGZpbmUtZ3JhaW5lZCBzcGVjaWZpYyBjYXJyaWVyIGlkcywgcmV0dXJuIHtAbGluayAjZ2V0U2ltQ2FycmllcklkKCl9CiAgICAgKiA8cD5TcGVjaWZpYyBjYXJyaWVyIGlkcyBhcmUgZGVmaW5lZCBpbiB0aGUgc2FtZSB3YXkgYXMgY2FycmllciBpZAogICAgICogPGEgaHJlZj0iaHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vcGFja2FnZXMvcHJvdmlkZXJzL1RlbGVwaG9ueVByb3ZpZGVyLysvbWFzdGVyL2Fzc2V0cy9sYXRlc3RfY2Fycmllcl9pZC9jYXJyaWVyX2xpc3QudGV4dHBiIj5oZXJlPC9hPgogICAgICogZXhjZXB0IGVhY2ggd2l0aCBhICJwYXJlbnQiIGlkIGxpbmtpbmcgdG8gaXRzIHRvcC1sZXZlbCBjYXJyaWVyIGlkLgogICAgICoKICAgICAqIEByZXR1cm4gUmV0dXJucyBmaW5lLWdyYWluZWQgY2FycmllciBpZCBvZiB0aGUgY3VycmVudCBzdWJzY3JpcHRpb24uCiAgICAgKiBSZXR1cm4ge0BsaW5rICNVTktOT1dOX0NBUlJJRVJfSUR9IGlmIHRoZSBzdWJzY3JpcHRpb24gaXMgdW5hdmFpbGFibGUgb3IgdGhlIGNhcnJpZXIgY2Fubm90CiAgICAgKiBiZSBpZGVudGlmaWVkLgogICAgICovCiAgICBwdWJsaWMgaW50IGdldFNpbVNwZWNpZmljQ2FycmllcklkKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0U3Vic2NyaXB0aW9uU3BlY2lmaWNDYXJyaWVySWQoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gaWYgYmluZGVyIHByb2Nlc3MgY3Jhc2hlcy4KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFVOS05PV05fQ0FSUklFUl9JRDsKICAgIH0KCiAgICAvKioKICAgICAqIFNpbWlsYXIgbGlrZSB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZE5hbWUoKX0sIHJldHVybnMgdXNlci1mYWNpbmcgbmFtZSBvZiB0aGUKICAgICAqIHNwZWNpZmljIGNhcnJpZXIgaWQgcmV0dXJuZWQgYnkge0BsaW5rICNnZXRTaW1TcGVjaWZpY0NhcnJpZXJJZCgpfS4KICAgICAqCiAgICAgKiBUaGUgc3BlY2lmaWMgY2FycmllciBJRCB3b3VsZCBiZSB1c2VkIGZvciBjb25maWd1cmF0aW9uIHB1cnBvc2VzLCBidXQgYXBwcyB3aXNoaW5nIHRvIGtub3cKICAgICAqIGFib3V0IHRoZSBjYXJyaWVyIGl0c2VsZiBzaG91bGQgdXNlIHRoZSByZWd1bGFyIGNhcnJpZXIgSUQgcmV0dXJuZWQgYnkKICAgICAqIHtAbGluayAjZ2V0U2ltQ2FycmllcklkTmFtZSgpfS4KICAgICAqCiAgICAgKiA8cD5UaGUgcmV0dXJuZWQgbmFtZSBpcyB1bmxvY2FsaXplZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHVzZXItZmFjaW5nIG5hbWUgb2YgdGhlIHN1YnNjcmlwdGlvbiBzcGVjaWZpYyBjYXJyaWVyIGlkLiBSZXR1cm4ge0Bjb2RlIG51bGx9IGlmIHRoZQogICAgICogc3Vic2NyaXB0aW9uIGlzIHVuYXZhaWxhYmxlIG9yIHRoZSBjYXJyaWVyIGNhbm5vdCBiZSBpZGVudGlmaWVkLgogICAgICovCiAgICBwdWJsaWMgQE51bGxhYmxlIENoYXJTZXF1ZW5jZSBnZXRTaW1TcGVjaWZpY0NhcnJpZXJJZE5hbWUoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRTdWJzY3JpcHRpb25TcGVjaWZpY0NhcnJpZXJOYW1lKGdldFN1YklkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBjYXJyaWVyIGlkIGJhc2VkIG9uIHNpbSBNQ0NNTkMgKHJldHVybmVkIGJ5IHtAbGluayAjZ2V0U2ltT3BlcmF0b3IoKX0pIG9ubHkuCiAgICAgKiBUaGlzIGlzIHVzZWQgZm9yIGZhbGxiYWNrIHdoZW4gY29uZmlndXJhdGlvbnMvbG9naWMgZm9yIGV4YWN0IGNhcnJpZXIgaWQKICAgICAqIHtAbGluayAjZ2V0U2ltQ2FycmllcklkKCl9IGFyZSBub3QgZm91bmQuCiAgICAgKgogICAgICogQW5kcm9pZCBjYXJyaWVyIGlkIHRhYmxlIDxhIGhyZWY9Imh0dHBzOi8vYW5kcm9pZC5nb29nbGVzb3VyY2UuY29tL3BsYXRmb3JtL3BhY2thZ2VzL3Byb3ZpZGVycy9UZWxlcGhvbnlQcm92aWRlci8rL21hc3Rlci9hc3NldHMvbGF0ZXN0X2NhcnJpZXJfaWQvY2Fycmllcl9saXN0LnRleHRwYiI+aGVyZTwvYT4KICAgICAqIGNhbiBiZSB1cGRhdGVkIG91dC1vZi1iYW5kLCBpdHMgcG9zc2libGUgYSBNVk5PIChNb2JpbGUgVmlydHVhbCBOZXR3b3JrIE9wZXJhdG9yKSBjYXJyaWVyCiAgICAgKiB3YXMgbm90IGZ1bGx5IHJlY29nbml6ZWQgYW5kIGFzc2lnbmVkIHRvIGl0cyBNTk8gKE1vYmlsZSBOZXR3b3JrIE9wZXJhdG9yKSBjYXJyaWVyIGlkCiAgICAgKiBieSBkZWZhdWx0LiBBZnRlciBjYXJyaWVyIGlkIHRhYmxlIHVwZGF0ZSwgYSBuZXcgY2FycmllciBpZCB3YXMgYXNzaWduZWQuIElmIGFwcHMgZG9uJ3QKICAgICAqIHRha2UgdGhlIHVwZGF0ZSB3aXRoIHRoZSBuZXcgaWQsIGl0IG1pZ2h0IGJlIGhlbHBmdWwgdG8gYWx3YXlzIGZhbGxiYWNrIGJ5IHVzaW5nIGNhcnJpZXIKICAgICAqIGlkIGJhc2VkIG9uIE1DQ01OQyBpZiB0aGVyZSBpcyBubyBtYXRjaC4KICAgICAqCiAgICAgKiBAcmV0dXJuIG1hdGNoaW5nIGNhcnJpZXIgaWQgZnJvbSBzaW0gTUNDTU5DLiBSZXR1cm4ge0BsaW5rICNVTktOT1dOX0NBUlJJRVJfSUR9IGlmIHRoZQogICAgICogc3Vic2NyaXB0aW9uIGlzIHVuYXZhaWxhYmxlIG9yIHRoZSBjYXJyaWVyIGNhbm5vdCBiZSBpZGVudGlmaWVkLgogICAgICovCiAgICBwdWJsaWMgaW50IGdldENhcnJpZXJJZEZyb21TaW1NY2NNbmMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRDYXJyaWVySWRGcm9tTWNjTW5jKGdldFNsb3RJbmRleCgpLCBnZXRTaW1PcGVyYXRvcigpLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgICAgICByZXR1cm4gVU5LTk9XTl9DQVJSSUVSX0lEOwogICAgfQoKICAgICAvKioKICAgICAgKiBSZXR1cm5zIGNhcnJpZXIgaWQgYmFzZWQgb24gTUNDTU5DIChyZXR1cm5lZCBieSB7QGxpbmsgI2dldFNpbU9wZXJhdG9yKCl9KSBvbmx5LiBUaGlzIGlzCiAgICAgICogdXNlZCBmb3IgZmFsbGJhY2sgd2hlbiBjb25maWd1cmF0aW9ucy9sb2dpYyBmb3IgZXhhY3QgY2FycmllciBpZCB7QGxpbmsgI2dldFNpbUNhcnJpZXJJZCgpfQogICAgICAqIGFyZSBub3QgZm91bmQuCiAgICAgICoKICAgICAgKiBBbmRyb2lkIGNhcnJpZXIgaWQgdGFibGUgPGEgaHJlZj0iaHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vcGFja2FnZXMvcHJvdmlkZXJzL1RlbGVwaG9ueVByb3ZpZGVyLysvbWFzdGVyL2Fzc2V0cy9sYXRlc3RfY2Fycmllcl9pZC9jYXJyaWVyX2xpc3QudGV4dHBiIj5oZXJlPC9hPgogICAgICAqIGNhbiBiZSB1cGRhdGVkIG91dC1vZi1iYW5kLCBpdHMgcG9zc2libGUgYSBNVk5PIChNb2JpbGUgVmlydHVhbCBOZXR3b3JrIE9wZXJhdG9yKSBjYXJyaWVyCiAgICAgICogd2FzIG5vdCBmdWxseSByZWNvZ25pemVkIGFuZCBhc3NpZ25lZCB0byBpdHMgTU5PIChNb2JpbGUgTmV0d29yayBPcGVyYXRvcikgY2FycmllciBpZAogICAgICAqIGJ5IGRlZmF1bHQuIEFmdGVyIGNhcnJpZXIgaWQgdGFibGUgdXBkYXRlLCBhIG5ldyBjYXJyaWVyIGlkIHdhcyBhc3NpZ25lZC4gSWYgYXBwcyBkb24ndAogICAgICAqIHRha2UgdGhlIHVwZGF0ZSB3aXRoIHRoZSBuZXcgaWQsIGl0IG1pZ2h0IGJlIGhlbHBmdWwgdG8gYWx3YXlzIGZhbGxiYWNrIGJ5IHVzaW5nIGNhcnJpZXIKICAgICAgKiBpZCBiYXNlZCBvbiBNQ0NNTkMgaWYgdGhlcmUgaXMgbm8gbWF0Y2guCiAgICAgICoKICAgICAgKiBAcmV0dXJuIG1hdGNoaW5nIGNhcnJpZXIgaWQgZnJvbSBwYXNzaW5nIE1DQ01OQy4gUmV0dXJuIHtAbGluayAjVU5LTk9XTl9DQVJSSUVSX0lEfSBpZiB0aGUKICAgICAgKiBzdWJzY3JpcHRpb24gaXMgdW5hdmFpbGFibGUgb3IgdGhlIGNhcnJpZXIgY2Fubm90IGJlIGlkZW50aWZpZWQuCiAgICAgICogQGhpZGUKICAgICAgKi8KICAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICAgcHVibGljIGludCBnZXRDYXJyaWVySWRGcm9tTWNjTW5jKFN0cmluZyBtY2NtbmMpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmdldENhcnJpZXJJZEZyb21NY2NNbmMoZ2V0U2xvdEluZGV4KCksIG1jY21uYywgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgfQogICAgICAgIHJldHVybiBVTktOT1dOX0NBUlJJRVJfSUQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBsaXN0IG9mIGNlcnRzIGluIGhleCBzdHJpbmcgZnJvbSBsb2FkZWQgY2FycmllciBwcml2aWxlZ2VzIGFjY2VzcyBydWxlcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIGEgbGlzdCBvZiBjZXJ0aWZpY2F0ZSBpbiBoZXggc3RyaW5nLiByZXR1cm4ge0Bjb2RlIG51bGx9IGlmIHRoZXJlIGlzIG5vIGNlcnRzCiAgICAgKiBvciBwcml2aWxlZ2UgcnVsZXMgYXJlIG5vdCBsb2FkZWQgeWV0LgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBMaXN0PFN0cmluZz4gZ2V0Q2VydHNGcm9tQ2FycmllclByaXZpbGVnZUFjY2Vzc1J1bGVzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0Q2VydHNGcm9tQ2FycmllclByaXZpbGVnZUFjY2Vzc1J1bGVzKGdldFN1YklkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBhcHBsaWNhdGlvbiBJRCBmb3IgdGhlIHVpY2MgYXBwbGljYXRpb24gdHlwZSBsaWtlIHtAbGluayAjQVBQVFlQRV9DU0lNfS4KICAgICAqIEFsbCB1aWNjIGFwcGxpY2F0aW9ucyBhcmUgdW5pcXVlbHkgaWRlbnRpZmllZCBieSBhcHBsaWNhdGlvbiBJRCwgcmVwcmVzZW50ZWQgYnkgdGhlIGhleAogICAgICogc3RyaW5nLiBlLmcsIEEwMDAwMDAxNTE0MTQzNEMwMC4gU2VlIEVUU0kgMTAyLjIyMSBhbmQgMTAxLjIyMAogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICogQHBhcmFtIGFwcFR5cGUgdGhlIHVpY2MgYXBwIHR5cGUuCiAgICAgKiBAcmV0dXJuIEFwcGxpY2F0aW9uIElEIGZvciBzcGVjaWZpZWQgYXBwIHR5cGUgb3Ige0Bjb2RlIG51bGx9IGlmIG5vIHVpY2Mgb3IgZXJyb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATnVsbGFibGUKICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0QWlkRm9yQXBwVHlwZShAVWljY0FwcFR5cGUgaW50IGFwcFR5cGUpIHsKICAgICAgICByZXR1cm4gZ2V0QWlkRm9yQXBwVHlwZShnZXRTdWJJZCgpLCBhcHBUeXBlKTsKICAgIH0KCiAgICAvKioKICAgICAqIHNhbWUgYXMge0BsaW5rICNnZXRBaWRGb3JBcHBUeXBlKGludCl9CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldEFpZEZvckFwcFR5cGUoaW50IHN1YklkLCBpbnQgYXBwVHlwZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0QWlkRm9yQXBwVHlwZShzdWJJZCwgYXBwVHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjZ2V0QWlkRm9yQXBwVHlwZSIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgRWxlY3Ryb25pYyBTZXJpYWwgTnVtYmVyLgogICAgICoKICAgICAqIFJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgcGVybWlzc2lvbgogICAgICoKICAgICAqIEByZXR1cm4gRVNOIG9yIG51bGwgaWYgZXJyb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldEVzbigpIHsKICAgICAgICByZXR1cm4gZ2V0RXNuKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBFbGVjdHJvbmljIFNlcmlhbCBOdW1iZXIuCiAgICAgKgogICAgICogUmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBwZXJtaXNzaW9uCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpcHRpb24gSUQgdGhhdCB0aGlzIHJlcXVlc3QgYXBwbGllcyB0by4KICAgICAqIEByZXR1cm4gRVNOIG9yIG51bGwgaWYgZXJyb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldEVzbihpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmdldEVzbihzdWJJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjZ2V0RXNuIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBQcmVmZXJyZWQgUm9hbWluZyBMaXN0IFZlcnNpb24KICAgICAqCiAgICAgKiBSZXF1aXJlcyB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24KICAgICAqCiAgICAgKiBAcmV0dXJuIFBSTFZlcnNpb24gb3IgbnVsbCBpZiBlcnJvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBTdHJpbmcgZ2V0Q2RtYVBybFZlcnNpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldENkbWFQcmxWZXJzaW9uKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBQcmVmZXJyZWQgUm9hbWluZyBMaXN0IFZlcnNpb24KICAgICAqCiAgICAgKiBSZXF1aXJlcyB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIHBlcm1pc3Npb24KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCB0aGF0IHRoaXMgcmVxdWVzdCBhcHBsaWVzIHRvLgogICAgICogQHJldHVybiBQUkxWZXJzaW9uIG9yIG51bGwgaWYgZXJyb3IuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgU3RyaW5nIGdldENkbWFQcmxWZXJzaW9uKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0Q2RtYVBybFZlcnNpb24oc3ViSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2dldENkbWFQcmxWZXJzaW9uIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHNuYXBzaG90IG9mIFRlbGVwaG9ueSBoaXN0b2dyYW1zCiAgICAgKiBAcmV0dXJuIExpc3Qgb2YgVGVsZXBob255IGhpc3RvZ3JhbXMKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIE9yIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIExpc3Q8VGVsZXBob255SGlzdG9ncmFtPiBnZXRUZWxlcGhvbnlIaXN0b2dyYW1zKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuZ2V0VGVsZXBob255SGlzdG9ncmFtcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2dldFRlbGVwaG9ueUhpc3RvZ3JhbXMiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFsbG93ZWQgY2FycmllciBsaXN0IGZvciBzbG90SW5kZXgKICAgICAqIFJlcXVpcmUgc3lzdGVtIHByaXZpbGVnZXMuIEluIHRoZSBmdXR1cmUgd2UgbWF5IGFkZCB0aGlzIHRvIGNhcnJpZXIgQVBJcy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiA8cD5UaGlzIG1ldGhvZCB3b3JrcyBvbmx5IG9uIGRldmljZXMgd2l0aCB7QGxpbmsKICAgICAqIGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlciNGRUFUVVJFX1RFTEVQSE9OWV9DQVJSSUVSTE9DS30gZW5hYmxlZC4KICAgICAqCiAgICAgKiBAZGVwcmVjYXRlZCB1c2Ugc2V0Q2FycmllclJlc3RyaWN0aW9uUnVsZXMgaW5zdGVhZAogICAgICoKICAgICAqIEByZXR1cm4gVGhlIG51bWJlciBvZiBjYXJyaWVycyBzZXQgc3VjY2Vzc2Z1bGx5LiBTaG91bGQgYmUgbGVuZ3RoIG9mCiAgICAgKiBjYXJyaWVyTGlzdCBvbiBzdWNjZXNzOyAtMSBpZiBjYXJyaWVyTGlzdCBudWxsIG9yIG9uIGVycm9yLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBzZXRBbGxvd2VkQ2FycmllcnMoaW50IHNsb3RJbmRleCwgTGlzdDxDYXJyaWVySWRlbnRpZmllcj4gY2FycmllcnMpIHsKICAgICAgICBpZiAoY2FycmllcnMgPT0gbnVsbCB8fCAhU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgLy8gRXhlY3V0ZSB0aGUgbWV0aG9kIHNldENhcnJpZXJSZXN0cmljdGlvblJ1bGVzIHdpdGggYW4gZW1wdHkgZXhjbHVkZWQgbGlzdCBhbmQKICAgICAgICAvLyBpbmRpY2F0aW5nIHByaW9yaXR5IGZvciB0aGUgYWxsb3dlZCBsaXN0LgogICAgICAgIENhcnJpZXJSZXN0cmljdGlvblJ1bGVzIGNhcnJpZXJSZXN0cmljdGlvblJ1bGVzID0gQ2FycmllclJlc3RyaWN0aW9uUnVsZXMubmV3QnVpbGRlcigpCiAgICAgICAgICAgICAgICAuc2V0QWxsb3dlZENhcnJpZXJzKGNhcnJpZXJzKQogICAgICAgICAgICAgICAgLnNldERlZmF1bHRDYXJyaWVyUmVzdHJpY3Rpb24oCiAgICAgICAgICAgICAgICAgICAgQ2FycmllclJlc3RyaWN0aW9uUnVsZXMuQ0FSUklFUl9SRVNUUklDVElPTl9ERUZBVUxUX05PVF9BTExPV0VEKQogICAgICAgICAgICAgICAgLmJ1aWxkKCk7CgogICAgICAgIGludCByZXN1bHQgPSBzZXRDYXJyaWVyUmVzdHJpY3Rpb25SdWxlcyhjYXJyaWVyUmVzdHJpY3Rpb25SdWxlcyk7CgogICAgICAgIC8vIENvbnZlcnQgcmVzdWx0IGludG8gaW50LCBhcyByZXF1aXJlZCBieSB0aGlzIG1ldGhvZC4KICAgICAgICBpZiAocmVzdWx0ID09IFNFVF9DQVJSSUVSX1JFU1RSSUNUSU9OX1NVQ0NFU1MpIHsKICAgICAgICAgICAgcmV0dXJuIGNhcnJpZXJzLnNpemUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhlIGNhcnJpZXIgcmVzdHJpY3Rpb25zIHdlcmUgc3VjY2Vzc2Z1bGx5IHNldC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNFVF9DQVJSSUVSX1JFU1RSSUNUSU9OX1NVQ0NFU1MgPSAwOwoKICAgIC8qKgogICAgICogVGhlIGNhcnJpZXIgcmVzdHJpY3Rpb25zIHdlcmUgbm90IHNldCBkdWUgdG8gbGFjayBvZiBzdXBwb3J0IGluIHRoZSBtb2RlbS4gVGhpcyBjYW4gaGFwcGVuCiAgICAgKiBpZiB0aGUgbW9kZW0gZG9lcyBub3Qgc3VwcG9ydCBzZXR0aW5nIHRoZSBjYXJyaWVyIHJlc3RyaWN0aW9ucyBvciBpZiB0aGUgY29uZmlndXJhdGlvbgogICAgICogcGFzc2VkIGluIHRoZSB7QGNvZGUgc2V0Q2FycmllclJlc3RyaWN0aW9uUnVsZXN9IGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIG1vZGVtLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VUX0NBUlJJRVJfUkVTVFJJQ1RJT05fTk9UX1NVUFBPUlRFRCA9IDE7CgogICAgLyoqCiAgICAgKiBUaGUgc2V0dGluZyBvZiBjYXJyaWVyIHJlc3RyaWN0aW9ucyBmYWlsZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTRVRfQ0FSUklFUl9SRVNUUklDVElPTl9FUlJPUiA9IDI7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiU0VUX0NBUlJJRVJfUkVTVFJJQ1RJT05fIn0sCiAgICAgICAgICAgIHZhbHVlID0gewogICAgICAgICAgICAgICAgICAgIFNFVF9DQVJSSUVSX1JFU1RSSUNUSU9OX1NVQ0NFU1MsCiAgICAgICAgICAgICAgICAgICAgU0VUX0NBUlJJRVJfUkVTVFJJQ1RJT05fTk9UX1NVUFBPUlRFRCwKICAgICAgICAgICAgICAgICAgICBTRVRfQ0FSUklFUl9SRVNUUklDVElPTl9FUlJPUgogICAgICAgICAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgU2V0Q2FycmllclJlc3RyaWN0aW9uUmVzdWx0IHt9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFsbG93ZWQgY2FycmllciBsaXN0IGFuZCB0aGUgZXhjbHVkZWQgY2FycmllciBsaXN0IGluZGljYXRpbmcgdGhlIHByaW9yaXR5IGJldHdlZW4KICAgICAqIHRoZSB0d28gbGlzdHMuCiAgICAgKiBSZXF1aXJlcyBzeXN0ZW0gcHJpdmlsZWdlcy4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiA8cD5UaGlzIG1ldGhvZCB3b3JrcyBvbmx5IG9uIGRldmljZXMgd2l0aCB7QGxpbmsKICAgICAqIGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlciNGRUFUVVJFX1RFTEVQSE9OWV9DQVJSSUVSTE9DS30gZW5hYmxlZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAbGluayAjU0VUX0NBUlJJRVJfUkVTVFJJQ1RJT05fU1VDQ0VTU30gaW4gY2FzZSBvZiBzdWNjZXNzLgogICAgICoge0BsaW5rICNTRVRfQ0FSUklFUl9SRVNUUklDVElPTl9OT1RfU1VQUE9SVEVEfSBpZiB0aGUgbW9kZW0gZG9lcyBub3Qgc3VwcG9ydCB0aGUKICAgICAqIGNvbmZpZ3VyYXRpb24uIHtAbGluayAjU0VUX0NBUlJJRVJfUkVTVFJJQ1RJT05fRVJST1J9IGluIGFsbCBvdGhlciBlcnJvciBjYXNlcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIEBTZXRDYXJyaWVyUmVzdHJpY3Rpb25SZXN1bHQKICAgIHB1YmxpYyBpbnQgc2V0Q2FycmllclJlc3RyaWN0aW9uUnVsZXMoQE5vbk51bGwgQ2FycmllclJlc3RyaWN0aW9uUnVsZXMgcnVsZXMpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLnNldEFsbG93ZWRDYXJyaWVycyhydWxlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc2V0QWxsb3dlZENhcnJpZXJzIiwgZSk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjc2V0QWxsb3dlZENhcnJpZXJzIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTRVRfQ0FSUklFUl9SRVNUUklDVElPTl9FUlJPUjsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgYWxsb3dlZCBjYXJyaWVyIGxpc3QgZm9yIHNsb3RJbmRleC4KICAgICAqIFJlcXVpcmVzIHN5c3RlbSBwcml2aWxlZ2VzLgogICAgICoKICAgICAqIDxwPlRoaXMgbWV0aG9kIHJldHVybnMgdmFsaWQgZGF0YSBvbiBkZXZpY2VzIHdpdGgge0BsaW5rCiAgICAgKiBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTllfQ0FSUklFUkxPQ0t9IGVuYWJsZWQuCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgQXBwcyBzaG91bGQgdXNlIHtAbGluayBnZXRDYXJyaWVyc1Jlc3RyaWN0aW9uUnVsZXN9IHRvIHJldHJpZXZlIHRoZSBsaXN0IG9mCiAgICAgKiBhbGxvd2VkIGFuZCBleGNsaXVkZWQgY2FycmllcnMsIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBBUEkgaXMgdmFsaWQgb25seSB3aGVuIHRoZSBleGNsdWRlZAogICAgICogbGlzdCBpcyBlbXB0eS4gVGhpcyBBUEkgY291bGQgcmV0dXJuIGFuIGVtcHR5IGxpc3QsIGV2ZW4gaWYgc29tZSByZXN0cmljdGlvbnMgYXJlIHByZXNlbnQuCiAgICAgKgogICAgICogQHJldHVybiBMaXN0IG9mIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5DYXJyaWVySWRlbnRpZmllcn07IGVtcHR5IGxpc3QKICAgICAqIG1lYW5zIGFsbCBjYXJyaWVycyBhcmUgYWxsb3dlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgTGlzdDxDYXJyaWVySWRlbnRpZmllcj4gZ2V0QWxsb3dlZENhcnJpZXJzKGludCBzbG90SW5kZXgpIHsKICAgICAgICBpZiAoU3Vic2NyaXB0aW9uTWFuYWdlci5pc1ZhbGlkUGhvbmVJZChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIENhcnJpZXJSZXN0cmljdGlvblJ1bGVzIGNhcnJpZXJSZXN0cmljdGlvblJ1bGUgPSBnZXRDYXJyaWVyUmVzdHJpY3Rpb25SdWxlcygpOwogICAgICAgICAgICBpZiAoY2FycmllclJlc3RyaWN0aW9uUnVsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FycmllclJlc3RyaWN0aW9uUnVsZS5nZXRBbGxvd2VkQ2FycmllcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEFycmF5TGlzdDxDYXJyaWVySWRlbnRpZmllcj4oMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFsbG93ZWQgY2FycmllciBsaXN0IGFuZCB0aGUgZXhjbHVkZWQgY2FycmllciBsaXN0IGluZGljYXRpbmcgdGhlIHByaW9yaXR5IGJldHdlZW4KICAgICAqIHRoZSB0d28gbGlzdHMuCiAgICAgKiBSZXF1aXJlIHN5c3RlbSBwcml2aWxlZ2VzLiBJbiB0aGUgZnV0dXJlIHdlIG1heSBhZGQgdGhpcyB0byBjYXJyaWVyIEFQSXMuCiAgICAgKgogICAgICogPHA+VGhpcyBtZXRob2QgcmV0dXJucyB2YWxpZCBkYXRhIG9uIGRldmljZXMgd2l0aCB7QGxpbmsKICAgICAqIGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlciNGRUFUVVJFX1RFTEVQSE9OWV9DQVJSSUVSTE9DS30gZW5hYmxlZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAbGluayBDYXJyaWVyUmVzdHJpY3Rpb25SdWxlc30gd2hpY2ggY29udGFpbnMgdGhlIGFsbG93ZWQgY2FycmllciBsaXN0IGFuZCB0aGUKICAgICAqIGV4Y2x1ZGVkIGNhcnJpZXIgbGlzdCB3aXRoIHRoZSBwcmlvcml0eSBiZXR3ZWVuIHRoZSB0d28gbGlzdHMuIFJldHVybnMge0Bjb2RlIG51bGx9CiAgICAgKiBpbiBjYXNlIG9mIGVycm9yLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgQ2FycmllclJlc3RyaWN0aW9uUnVsZXMgZ2V0Q2FycmllclJlc3RyaWN0aW9uUnVsZXMoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRBbGxvd2VkQ2FycmllcnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNnZXRBbGxvd2VkQ2FycmllcnMiLCBlKTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNnZXRBbGxvd2VkQ2FycmllcnMiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIHRvIGVuYWJsZSBvciBkaXNhYmxlIGNhcnJpZXIgZGF0YSBieSB0aGUgc3lzdGVtIGJhc2VkIG9uIGNhcnJpZXIgc2lnbmFsbGluZyBvcgogICAgICogY2FycmllciBwcml2aWxlZ2VkIGFwcHMuIERpZmZlcmVudCBmcm9tIHtAbGluayAjc2V0RGF0YUVuYWJsZWQoYm9vbGVhbil9IHdoaWNoIGlzIGxpbmtlZCB0bwogICAgICogdXNlciBzZXR0aW5ncywgY2FycmllciBkYXRhIG9uL29mZiB3b24ndCBhZmZlY3QgdXNlciBzZXR0aW5ncyBidXQgd2lsbCBieXBhc3MgdGhlCiAgICAgKiBzZXR0aW5ncyBhbmQgdHVybnMgb2ZmIGRhdGEgaW50ZXJuYWxseSBpZiBzZXQgdG8ge0Bjb2RlIGZhbHNlfS4KICAgICAqCiAgICAgKiA8cD5JZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBnaXZlbiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gZW5hYmxlZCBjb250cm9sIGVuYWJsZSBvciBkaXNhYmxlIGNhcnJpZXIgZGF0YS4KICAgICAqIEBzZWUgI3Jlc2V0QWxsQ2FycmllckFjdGlvbnMoKQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0Q2FycmllckRhdGFFbmFibGVkKGJvb2xlYW4gZW5hYmxlZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VydmljZS5jYXJyaWVyQWN0aW9uU2V0TWV0ZXJlZEFwbnNFbmFibGVkKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSksIGVuYWJsZWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I3NldENhcnJpZXJEYXRhRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhcnJpZXIgYWN0aW9uIHRvIGVuYWJsZSBvciBkaXNhYmxlIHRoZSByYWRpby4KICAgICAqCiAgICAgKiA8cD5JZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBnaXZlbiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gZW5hYmxlZCBjb250cm9sIGVuYWJsZSBvciBkaXNhYmxlIHJhZGlvLgogICAgICogQHNlZSAjcmVzZXRBbGxDYXJyaWVyQWN0aW9ucygpCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRSYWRpb0VuYWJsZWQoYm9vbGVhbiBlbmFibGVkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXJ2aWNlLmNhcnJpZXJBY3Rpb25TZXRSYWRpb0VuYWJsZWQoCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKSwgZW5hYmxlZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjY2FycmllckFjdGlvblNldFJhZGlvRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhcnJpZXIgYWN0aW9uIHRvIHN0YXJ0IG9yIHN0b3AgcmVwb3J0aW5nIGRlZmF1bHQgbmV0d29yayBhdmFpbGFibGUgZXZlbnRzLgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9LgogICAgICoKICAgICAqIEBwYXJhbSByZXBvcnQgY29udHJvbCBzdGFydC9zdG9wIHJlcG9ydGluZyBuZXR3b3JrIHN0YXR1cy4KICAgICAqIEBzZWUgI3Jlc2V0QWxsQ2FycmllckFjdGlvbnMoKQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgcmVwb3J0RGVmYXVsdE5ldHdvcmtTdGF0dXMoYm9vbGVhbiByZXBvcnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNlcnZpY2UuY2FycmllckFjdGlvblJlcG9ydERlZmF1bHROZXR3b3JrU3RhdHVzKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSksIHJlcG9ydCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjY2FycmllckFjdGlvblJlcG9ydERlZmF1bHROZXR3b3JrU3RhdHVzIiwgZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVzZXQgYWxsIGNhcnJpZXIgYWN0aW9ucyBwcmV2aW91c2x5IHNldCBieSB7QGxpbmsgI3NldFJhZGlvRW5hYmxlZH0sCiAgICAgKiB7QGxpbmsgI3JlcG9ydERlZmF1bHROZXR3b3JrU3RhdHVzfSBhbmQge0BsaW5rICNzZXRDYXJyaWVyRGF0YUVuYWJsZWR9LgogICAgICoKICAgICAqIDxwPklmIHRoaXMgb2JqZWN0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB7QGxpbmsgI2NyZWF0ZUZvclN1YnNjcmlwdGlvbklkfSwgYXBwbGllcyB0byB0aGUKICAgICAqIGdpdmVuIHN1YklkLiBPdGhlcndpc2UsIGFwcGxpZXMgdG8ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgcmVzZXRBbGxDYXJyaWVyQWN0aW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNlcnZpY2UuY2FycmllckFjdGlvblJlc2V0QWxsKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZChTdWJzY3JpcHRpb25NYW5hZ2VyLmdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2NhcnJpZXJBY3Rpb25SZXNldEFsbCIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFBvbGljeSBjb250cm9sIG9mIGRhdGEgY29ubmVjdGlvbi4gVXN1YWxseSB1c2VkIHdoZW4gZGF0YSBsaW1pdCBpcyBwYXNzZWQuCiAgICAgKiBAcGFyYW0gZW5hYmxlZCBUcnVlIGlmIGVuYWJsaW5nIHRoZSBkYXRhLCBvdGhlcndpc2UgZGlzYWJsaW5nLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFBvbGljeURhdGFFbmFibGVkKGJvb2xlYW4gZW5hYmxlZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VydmljZS5zZXRQb2xpY3lEYXRhRW5hYmxlZChlbmFibGVkLCBnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNzZXRQb2xpY3lEYXRhRW5hYmxlZCIsIGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCBDbGllbnQgcmVxdWVzdCBzdGF0cyB3aGljaCB3aWxsIGNvbnRhaW4gc3RhdGlzdGljYWwgaW5mb3JtYXRpb24KICAgICAqIG9uIGVhY2ggcmVxdWVzdCBtYWRlIGJ5IGNsaWVudC4KICAgICAqIENhbGxlcnMgcmVxdWlyZSBlaXRoZXIgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIG9yCiAgICAgKiBSRUFEX1BIT05FX1NUQVRFIHRvIHJldHJpZXZlIHRoZSBpbmZvcm1hdGlvbi4KICAgICAqIEBwYXJhbSBzdWJJZCBzdWIgaWQKICAgICAqIEByZXR1cm4gTGlzdCBvZiBDbGllbnQgUmVxdWVzdCBTdGF0cwogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIExpc3Q8Q2xpZW50UmVxdWVzdFN0YXRzPiBnZXRDbGllbnRSZXF1ZXN0U3RhdHMoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRDbGllbnRSZXF1ZXN0U3RhdHMoZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpLAogICAgICAgICAgICAgICAgICAgICAgICBzdWJJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBjYWxsaW5nIElUZWxlcGhvbnkjZ2V0Q2xpZW50UmVxdWVzdFN0YXRzIiwgZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBwaG9uZSBpcyBpbiBlbWVyZ2VuY3kgY2FsbGJhY2sgbW9kZS4KICAgICAqCiAgICAgKiA8cD5JZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBnaXZlbiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpfQogICAgICoKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBwaG9uZSBpcyBpbiBlbWVyZ2VuY3kgY2FsbGJhY2sgbW9kZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGdldEVtZXJnZW5jeUNhbGxiYWNrTW9kZSgpIHsKICAgICAgICByZXR1cm4gZ2V0RW1lcmdlbmN5Q2FsbGJhY2tNb2RlKGdldFN1YklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgcGhvbmUgaXMgaW4gZW1lcmdlbmN5IGNhbGxiYWNrIG1vZGUKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBwaG9uZSBpcyBpbiBlbWVyZ2VuY3kgY2FsbGJhY2sgbW9kZQogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpcHRpb24gSUQgdGhhdCB0aGlzIGFjdGlvbiBhcHBsaWVzIHRvLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gZ2V0RW1lcmdlbmN5Q2FsbGJhY2tNb2RlKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldEVtZXJnZW5jeUNhbGxiYWNrTW9kZShzdWJJZCk7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiRXJyb3IgY2FsbGluZyBJVGVsZXBob255I2dldEVtZXJnZW5jeUNhbGxiYWNrTW9kZSIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgbWFudWFsIG5ldHdvcmsgc2VsZWN0aW9uIGlzIGFsbG93ZWQuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSRUNJU0VfUEhPTkVfU1RBVEUKICAgICAqIFJFQURfUFJFQ0lTRV9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgICogKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkKICAgICAqCiAgICAgKiA8cD5JZiB0aGlzIG9iamVjdCBoYXMgYmVlbiBjcmVhdGVkIHdpdGgge0BsaW5rICNjcmVhdGVGb3JTdWJzY3JpcHRpb25JZH0sIGFwcGxpZXMgdG8gdGhlCiAgICAgKiBnaXZlbiBzdWJJZC4gT3RoZXJ3aXNlLCBhcHBsaWVzIHRvIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpfS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBtYW51YWwgbmV0d29yayBzZWxlY3Rpb24gaXMgYWxsb3dlZCwgb3RoZXJ3aXNlIHJldHVybiB7QGNvZGUgZmFsc2V9LgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIE5vIHN1cHBvcnQgY2FycmllciBwcml2aWxlZ2VzIChiLzcyOTY3MjM2KS4KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW55T2YgPSB7YW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJFQ0lTRV9QSE9ORV9TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0pCiAgICBwdWJsaWMgYm9vbGVhbiBpc01hbnVhbE5ldHdvcmtTZWxlY3Rpb25BbGxvd2VkKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaXNNYW51YWxOZXR3b3JrU2VsZWN0aW9uQWxsb3dlZChnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNpc01hbnVhbE5ldHdvcmtTZWxlY3Rpb25BbGxvd2VkIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlIG9yIGRpc2FibGUgc2lnbmFsIHN0cmVuZ3RoIGNoYW5nZXMgZnJvbSByYWRpbyB3aWxsIGFsd2F5cyBiZSByZXBvcnRlZCBpbiBhbnkKICAgICAqIGNvbmRpdGlvbiAoZS5nLiBzY3JlZW4gaXMgb2ZmKS4gVGhpcyBpcyBvbmx5IGFsbG93ZWQgZm9yIFN5c3RlbSBjYWxsZXIuCiAgICAgKgogICAgICogQHBhcmFtIGlzRW5hYmxlZCB7QGNvZGUgdHJ1ZX0gZm9yIGVuYWJsaW5nOyB7QGNvZGUgZmFsc2V9IGZvciBkaXNhYmxpbmcuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRBbHdheXNSZXBvcnRTaWduYWxTdHJlbmd0aChib29sZWFuIGlzRW5hYmxlZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRBbHdheXNSZXBvcnRTaWduYWxTdHJlbmd0aChnZXRTdWJJZCgpLCBpc0VuYWJsZWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgInNldEFsd2F5c1JlcG9ydFNpZ25hbFN0cmVuZ3RoIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgbW9zdCByZWNlbnRseSBhdmFpbGFibGUgc2lnbmFsIHN0cmVuZ3RoIGluZm9ybWF0aW9uLgogICAgICoKICAgICAqIEdldCB0aGUgbW9zdCByZWNlbnQgU2lnbmFsU3RyZW5ndGggaW5mb3JtYXRpb24gcmVwb3J0ZWQgYnkgdGhlIG1vZGVtLiBEdWUKICAgICAqIHRvIHBvd2VyIHNhdmluZyB0aGlzIGluZm9ybWF0aW9uIG1heSBub3QgYWx3YXlzIGJlIGN1cnJlbnQuCiAgICAgKiBAcmV0dXJuIHRoZSBtb3N0IHJlY2VudCBjYWNoZWQgc2lnbmFsIHN0cmVuZ3RoIGluZm8gZnJvbSB0aGUgbW9kZW0KICAgICAqLwogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgU2lnbmFsU3RyZW5ndGggZ2V0U2lnbmFsU3RyZW5ndGgoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5nZXRTaWduYWxTdHJlbmd0aChnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIkVycm9yIGNhbGxpbmcgSVRlbGVwaG9ueSNnZXRTaWduYWxTdHJlbmd0aCIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIGNlbGx1bGFyIGRhdGEgY29ubmVjdGlvbiBpcyBhbGxvd2VkIGluIHRoZSBkZXZpY2UuCiAgICAgKgogICAgICogPHA+V2hldGhlciBjZWxsdWxhciBkYXRhIGNvbm5lY3Rpb24gaXMgYWxsb3dlZCBjb25zaWRlcnMgYWxsIGZhY3RvcnMgYmVsb3c6CiAgICAgKiA8VUw+CiAgICAgKiAgIDxMST5Vc2VyIHR1cm5lZCBvbiBkYXRhIHNldHRpbmcge0BsaW5rICNpc0RhdGFFbmFibGVkfS48L0xJPgogICAgICogICA8TEk+Q2FycmllciBhbGxvd3MgZGF0YSB0byBiZSBvbi48L0xJPgogICAgICogICA8TEk+TmV0d29yayBwb2xpY3kuPC9MST4KICAgICAqICAgPExJPkFuZCBwb3NzaWJseSBvdGhlcnMuPC9MST4KICAgICAqIDwvVUw+CiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgb3ZlcmFsbCBkYXRhIGNvbm5lY3Rpb24gaXMgYWxsb3dlZDsge0Bjb2RlIGZhbHNlfSBpZiBub3QuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0RhdGFDb25uZWN0aW9uQWxsb3dlZCgpIHsKICAgICAgICBib29sZWFuIHJldFZhbCA9IGZhbHNlOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGludCBzdWJJZCA9IGdldFN1YklkKFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKTsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldFZhbCA9IHRlbGVwaG9ueS5pc0RhdGFFbmFibGVkKHN1YklkKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJFcnJvciBpc0RhdGFDb25uZWN0aW9uQWxsb3dlZCIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0VmFsOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBjdXJyZW50IGRldmljZSBpcyAiZGF0YSBjYXBhYmxlIiBvdmVyIGEgcmFkaW8gb24gdGhlIGRldmljZS4KICAgICAqIDxwPgogICAgICogIkRhdGEgY2FwYWJsZSIgbWVhbnMgdGhhdCB0aGlzIGRldmljZSBzdXBwb3J0cyBwYWNrZXQtc3dpdGNoZWQKICAgICAqIGRhdGEgY29ubmVjdGlvbnMgb3ZlciB0aGUgdGVsZXBob255IG5ldHdvcmsuCiAgICAgKiA8cD4KICAgICAqIE5vdGU6IHRoZSBtZWFuaW5nIG9mIHRoaXMgZmxhZyBpcyBzdWJ0bHkgZGlmZmVyZW50IGZyb20gdGhlCiAgICAgKiBQYWNrYWdlTWFuYWdlci5GRUFUVVJFX1RFTEVQSE9OWSBzeXN0ZW0gZmVhdHVyZSwgd2hpY2ggaXMgYXZhaWxhYmxlCiAgICAgKiBvbiBhbnkgZGV2aWNlIHdpdGggYSB0ZWxlcGhvbnkgcmFkaW8sIGV2ZW4gaWYgdGhlIGRldmljZSBpcwogICAgICogdm9pY2Utb25seS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc0RhdGFDYXBhYmxlKCkgewogICAgICAgIGlmIChtQ29udGV4dCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gbUNvbnRleHQuZ2V0UmVzb3VyY2VzKCkuZ2V0Qm9vbGVhbigKICAgICAgICAgICAgICAgIGNvbS5hbmRyb2lkLmludGVybmFsLlIuYm9vbC5jb25maWdfbW9iaWxlX2RhdGFfY2FwYWJsZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbiB0aGlzIG1vZGUsIG1vZGVtIHdpbGwgbm90IHNlbmQgc3BlY2lmaWVkIGluZGljYXRpb25zIHdoZW4gc2NyZWVuIGlzIG9mZi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElORElDQVRJT05fVVBEQVRFX01PREVfTk9STUFMICAgICAgICAgICAgICAgICAgID0gMTsKCiAgICAvKioKICAgICAqIEluIHRoaXMgbW9kZSwgbW9kZW0gd2lsbCBzdGlsbCBzZW5kIHNwZWNpZmllZCBpbmRpY2F0aW9ucyB3aGVuIHNjcmVlbiBpcyBvZmYuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTkRJQ0FUSU9OX1VQREFURV9NT0RFX0lHTk9SRV9TQ1JFRU5fT0ZGICAgICAgICA9IDI7CgogICAgLyoqCiAgICAgKiBUaGUgaW5kaWNhdGlvbiBmb3Igc2lnbmFsIHN0cmVuZ3RoIHVwZGF0ZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElORElDQVRJT05fRklMVEVSX1NJR05BTF9TVFJFTkdUSCAgICAgICAgICAgICAgID0gMHgxOwoKICAgIC8qKgogICAgICogVGhlIGluZGljYXRpb24gZm9yIGZ1bGwgbmV0d29yayBzdGF0ZSB1cGRhdGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTkRJQ0FUSU9OX0ZJTFRFUl9GVUxMX05FVFdPUktfU1RBVEUgICAgICAgICAgICA9IDB4MjsKCiAgICAvKioKICAgICAqIFRoZSBpbmRpY2F0aW9uIGZvciBkYXRhIGNhbGwgZG9ybWFuY3kgY2hhbmdlZCB1cGRhdGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTkRJQ0FUSU9OX0ZJTFRFUl9EQVRBX0NBTExfRE9STUFOQ1lfQ0hBTkdFRCAgICA9IDB4NDsKCiAgICAvKioKICAgICAqIFRoZSBpbmRpY2F0aW9uIGZvciBsaW5rIGNhcGFjaXR5IGVzdGltYXRlIHVwZGF0ZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElORElDQVRJT05fRklMVEVSX0xJTktfQ0FQQUNJVFlfRVNUSU1BVEUgICAgICAgID0gMHg4OwoKICAgIC8qKgogICAgICogVGhlIGluZGljYXRpb24gZm9yIHBoeXNpY2FsIGNoYW5uZWwgY29uZmlnIHVwZGF0ZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElORElDQVRJT05fRklMVEVSX1BIWVNJQ0FMX0NIQU5ORUxfQ09ORklHICAgICAgID0gMHgxMDsKCiAgICAvKioKICAgICAqIEEgdGVzdCBBUEkgdG8gb3ZlcnJpZGUgY2FycmllciBpbmZvcm1hdGlvbiBpbmNsdWRpbmcgbWNjbW5jLCBpbXNpLCBpY2NpZCwgZ2lkMSwgZ2lkMiwKICAgICAqIHBsbW4gYW5kIHNwbi4gVGhpcyB3b3VsZCBiZSBoYW5keSBmb3IsIGVnLCBmb3JjaW5nIGEgcGFydGljdWxhciBjYXJyaWVyIGlkLCBjYXJyaWVyJ3MgY29uZmlnCiAgICAgKiAoYWxzbyBhbnkgY291bnRyeSBvciBjYXJyaWVyIG92ZXJsYXlzKSB0byBiZSBsb2FkZWQgd2hlbiB1c2luZyBhIHRlc3QgU0lNIHdpdGggYSBjYWxsIGJveC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICoKICAgICAqIEBkZXByZWNhdGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgQFRlc3RBcGkKICAgIHB1YmxpYyB2b2lkIHNldENhcnJpZXJUZXN0T3ZlcnJpZGUoU3RyaW5nIG1jY21uYywgU3RyaW5nIGltc2ksIFN0cmluZyBpY2NpZCwgU3RyaW5nIGdpZDEsCiAgICAgICAgICAgIFN0cmluZyBnaWQyLCBTdHJpbmcgcGxtbiwgU3RyaW5nIHNwbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbGVwaG9ueS5zZXRDYXJyaWVyVGVzdE92ZXJyaWRlKAogICAgICAgICAgICAgICAgICAgICAgICBnZXRTdWJJZCgpLCBtY2NtbmMsIGltc2ksIGljY2lkLCBnaWQxLCBnaWQyLCBwbG1uLCBzcG4sCiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQSB0ZXN0IEFQSSB0byBvdmVycmlkZSBjYXJyaWVyIGluZm9ybWF0aW9uIGluY2x1ZGluZyBtY2NtbmMsIGltc2ksIGljY2lkLCBnaWQxLCBnaWQyLAogICAgICogcGxtbiwgc3BuLCBhcG4gYW5kIGNhcnJpZXIgcHJpdmlsZWRnZS4gVGhpcyB3b3VsZCBiZSBoYW5keSBmb3IsIGVnLCBmb3JjaW5nIGEgcGFydGljdWxhcgogICAgICogY2FycmllciBpZCwgY2FycmllcidzIGNvbmZpZyAoYWxzbyBhbnkgY291bnRyeSBvciBjYXJyaWVyIG92ZXJsYXlzKSB0byBiZSBsb2FkZWQgd2hlbiB1c2luZwogICAgICogYSB0ZXN0IFNJTSB3aXRoIGEgY2FsbCBib3guCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgdm9pZCBzZXRDYXJyaWVyVGVzdE92ZXJyaWRlKFN0cmluZyBtY2NtbmMsIFN0cmluZyBpbXNpLCBTdHJpbmcgaWNjaWQsIFN0cmluZyBnaWQxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZ2lkMiwgU3RyaW5nIHBsbW4sIFN0cmluZyBzcG4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBjYXJyaWVyUHJpdmlsZWRnZVJ1bGVzLCBTdHJpbmcgYXBuKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LnNldENhcnJpZXJUZXN0T3ZlcnJpZGUoCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFN1YklkKCksIG1jY21uYywgaW1zaSwgaWNjaWQsIGdpZDEsIGdpZDIsIHBsbW4sIHNwbiwKICAgICAgICAgICAgICAgICAgICAgICAgY2FycmllclByaXZpbGVkZ2VSdWxlcywgYXBuKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgdGVzdCBBUEkgdG8gcmV0dXJuIGluc3RhbGxlZCBjYXJyaWVyIGlkIGxpc3QgdmVyc2lvbgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgQFRlc3RBcGkKICAgIHB1YmxpYyBpbnQgZ2V0Q2FycmllcklkTGlzdFZlcnNpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRDYXJyaWVySWRMaXN0VmVyc2lvbihnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgICAgICByZXR1cm4gVU5LTk9XTl9DQVJSSUVSX0lEX0xJU1RfVkVSU0lPTjsKICAgIH0KCiAgICAvKioKICAgICAqIEhvdyBtYW55IG1vZGVtcyBjYW4gaGF2ZSBzaW11bHRhbmVvdXMgZGF0YSBjb25uZWN0aW9ucy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IGdldE51bWJlck9mTW9kZW1zV2l0aFNpbXVsdGFuZW91c0RhdGFDb25uZWN0aW9ucygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldE51bWJlck9mTW9kZW1zV2l0aFNpbXVsdGFuZW91c0RhdGFDb25uZWN0aW9ucygKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U3ViSWQoKSwgZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpZiBiaW5kZXIgcHJvY2VzcyBjcmFzaGVzLgogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZSBvciBkaXNhYmxlIE9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZS4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHRvIGVuYWJsZSBvciBkaXNhYmxlCiAgICAgKiBPcHBvcnR1bmlzdGljTmV0d29yayBzZXJ2aWNlIG9uIHRoZSBkZXZpY2UuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICogICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICogQHBhcmFtIGVuYWJsZSBlbmFibGUoVHJ1ZSkgb3IgZGlzYWJsZShGYWxzZSkKICAgICAqIEByZXR1cm4gcmV0dXJucyB0cnVlIGlmIHN1Y2Nlc3NmdWxseSBzZXQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRPcHBvcnR1bmlzdGljTmV0d29ya1N0YXRlKGJvb2xlYW4gZW5hYmxlKSB7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGJvb2xlYW4gcmV0ID0gZmFsc2U7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSU9ucyBpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlID0gZ2V0SU9ucygpOwogICAgICAgICAgICBpZiAoaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXQgPSBpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlLnNldEVuYWJsZShlbmFibGUsIHBrZ0ZvckRlYnVnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZW5hYmxlT3Bwb3J0dW5pc3RpY05ldHdvcmsgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKioKICAgICAqIGlzIE9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSBlbmFibGVkCiAgICAgKgogICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB0byBkZXRlcm1pbmUgaWYgdGhlIE9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSBpcwogICAgICogZW5hYmxlZAogICAgICoKICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqICAge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfQogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gaXNPcHBvcnR1bmlzdGljTmV0d29ya0VuYWJsZWQoKSB7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGJvb2xlYW4gaXNFbmFibGVkID0gZmFsc2U7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElPbnMgaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSA9IGdldElPbnMoKTsKICAgICAgICAgICAgaWYgKGlPcHBvcnR1bmlzdGljTmV0d29ya1NlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaXNFbmFibGVkID0gaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZS5pc0VuYWJsZWQocGtnRm9yRGVidWcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJlbmFibGVPcHBvcnR1bmlzdGljTmV0d29yayBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNFbmFibGVkOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQExvbmdEZWYoZmxhZyA9IHRydWUsIHByZWZpeCA9IHsiTkVUV09SS19UWVBFX0JJVE1BU0tfIn0sCiAgICAgICAgICAgIHZhbHVlID0ge05FVFdPUktfVFlQRV9CSVRNQVNLX1VOS05PV04sCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfR1NNLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0dQUlMsCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfRURHRSwKICAgICAgICAgICAgICAgICAgICBORVRXT1JLX1RZUEVfQklUTUFTS19DRE1BLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLXzF4UlRULAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fMCwKICAgICAgICAgICAgICAgICAgICBORVRXT1JLX1RZUEVfQklUTUFTS19FVkRPX0EsCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfRVZET19CLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VIUlBELAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTVVBBLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTRFBBLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTUEEsCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNQQVAsCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfVU1UUywKICAgICAgICAgICAgICAgICAgICBORVRXT1JLX1RZUEVfQklUTUFTS19URF9TQ0RNQSwKICAgICAgICAgICAgICAgICAgICBORVRXT1JLX1RZUEVfQklUTUFTS19MVEUsCiAgICAgICAgICAgICAgICAgICAgTkVUV09SS19UWVBFX0JJVE1BU0tfTFRFX0NBLAogICAgICAgICAgICAgICAgICAgIE5FVFdPUktfVFlQRV9CSVRNQVNLX05SLAogICAgICAgICAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgTmV0d29ya1R5cGVCaXRNYXNrIHt9CgogICAgLy8gMkcKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgdW5rbm93bi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19VTktOT1dOID0gMEw7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBHU00uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfR1NNID0gKDEgPDwgKE5FVFdPUktfVFlQRV9HU00gLTEpKTsKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIEdQUlMuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfR1BSUyA9ICgxIDw8IChORVRXT1JLX1RZUEVfR1BSUyAtMSkpOwogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggRURHRS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19FREdFID0gKDEgPDwgKE5FVFdPUktfVFlQRV9FREdFIC0xKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBDRE1BKElTOTVBL0lTOTVCKS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19DRE1BID0gKDEgPDwgKE5FVFdPUktfVFlQRV9DRE1BIC0xKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCAxeFJUVC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS18xeFJUVCA9ICgxIDw8IChORVRXT1JLX1RZUEVfMXhSVFQgLSAxKSk7CiAgICAvLyAzRwogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggRVZETyAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBsb25nIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fMCA9ICgxIDw8IChORVRXT1JLX1RZUEVfRVZET18wIC0xKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBFVkRPIEEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfRVZET19BID0gKDEgPDwgKE5FVFdPUktfVFlQRV9FVkRPX0EgLSAxKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBFVkRPIEIuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfRVZET19CID0gKDEgPDwgKE5FVFdPUktfVFlQRV9FVkRPX0IgLTEpKTsKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIEVIUlBELgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBsb25nIE5FVFdPUktfVFlQRV9CSVRNQVNLX0VIUlBEID0gKDEgPDwgKE5FVFdPUktfVFlQRV9FSFJQRCAtMSkpOwogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggSFNVUEEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNVUEEgPSAoMSA8PCAoTkVUV09SS19UWVBFX0hTVVBBIC0xKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBIU0RQQS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19IU0RQQSA9ICgxIDw8IChORVRXT1JLX1RZUEVfSFNEUEEgLTEpKTsKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIEhTUEEuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNQQSA9ICgxIDw8IChORVRXT1JLX1RZUEVfSFNQQSAtMSkpOwogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggSFNQQVAuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNQQVAgPSAoMSA8PCAoTkVUV09SS19UWVBFX0hTUEFQIC0xKSk7CiAgICAvKioKICAgICAqIG5ldHdvcmsgdHlwZSBiaXRtYXNrIGluZGljYXRpbmcgdGhlIHN1cHBvcnQgb2YgcmFkaW8gdGVjaCBVTVRTLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBsb25nIE5FVFdPUktfVFlQRV9CSVRNQVNLX1VNVFMgPSAoMSA8PCAoTkVUV09SS19UWVBFX1VNVFMgLTEpKTsKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIFREX1NDRE1BLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBsb25nIE5FVFdPUktfVFlQRV9CSVRNQVNLX1REX1NDRE1BID0gKDEgPDwgKE5FVFdPUktfVFlQRV9URF9TQ0RNQSAtMSkpOwogICAgLy8gNEcKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIExURS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19MVEUgPSAoMSA8PCAoTkVUV09SS19UWVBFX0xURSAtMSkpOwogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggTFRFIENBIChjYXJyaWVyIGFnZ3JlZ2F0aW9uKS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1RZUEVfQklUTUFTS19MVEVfQ0EgPSAoMSA8PCAoTkVUV09SS19UWVBFX0xURV9DQSAtMSkpOwoKICAgIC8qKgogICAgICogbmV0d29yayB0eXBlIGJpdG1hc2sgaW5kaWNhdGluZyB0aGUgc3VwcG9ydCBvZiByYWRpbyB0ZWNoIE5SKE5ldyBSYWRpbykgNUcuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfTlIgPSAoMSA8PCAoTkVUV09SS19UWVBFX05SIC0xKSk7CgogICAgLyoqCiAgICAgKiBuZXR3b3JrIHR5cGUgYml0bWFzayBpbmRpY2F0aW5nIHRoZSBzdXBwb3J0IG9mIHJhZGlvIHRlY2ggSVdMQU4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19UWVBFX0JJVE1BU0tfSVdMQU4gPSAoMSA8PCAoTkVUV09SS19UWVBFX0lXTEFOIC0xKSk7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19DTEFTU19CSVRNQVNLXzJHID0gTkVUV09SS19UWVBFX0JJVE1BU0tfR1NNCiAgICAgICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0dQUlMKICAgICAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfRURHRQogICAgICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19DRE1BCiAgICAgICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLXzF4UlRUOwoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBsb25nIE5FVFdPUktfQ0xBU1NfQklUTUFTS18zRyA9IE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fMAogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fQQogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0VWRE9fQgogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0VIUlBECiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNVUEEKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19IU0RQQQogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTUEEKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19IU1BBUAogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX1VNVFMKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19URF9TQ0RNQTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX0NMQVNTX0JJVE1BU0tfNEcgPSBORVRXT1JLX1RZUEVfQklUTUFTS19MVEUKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19MVEVfQ0EKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19JV0xBTjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX0NMQVNTX0JJVE1BU0tfNUcgPSBORVRXT1JLX1RZUEVfQklUTUFTS19OUjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgbG9uZyBORVRXT1JLX1NUQU5EQVJEU19GQU1JTFlfQklUTUFTS18zR1BQID0gTkVUV09SS19UWVBFX0JJVE1BU0tfR1NNCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfR1BSUwogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0VER0UKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19IU1VQQQogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTRFBBCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfSFNQQQogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX0hTUEFQCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfVU1UUwogICAgICAgICAgICB8IE5FVFdPUktfVFlQRV9CSVRNQVNLX1REX1NDRE1BCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfTFRFCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfTFRFX0NBCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfTlI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGxvbmcgTkVUV09SS19TVEFOREFSRFNfRkFNSUxZX0JJVE1BU0tfM0dQUDIgPSBORVRXT1JLX1RZUEVfQklUTUFTS19DRE1BCiAgICAgICAgICAgIHwgTkVUV09SS19UWVBFX0JJVE1BU0tfMXhSVFQKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19FVkRPXzAKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19FVkRPX0EKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19FVkRPX0IKICAgICAgICAgICAgfCBORVRXT1JLX1RZUEVfQklUTUFTS19FSFJQRDsKCiAgICAvKioKICAgICAqIEByZXR1cm4gTW9kZW0gc3VwcG9ydGVkIHJhZGlvIGFjY2VzcyBmYW1pbHkgYml0bWFzawogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfSBvcgogICAgICogdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATmV0d29ya1R5cGVCaXRNYXNrIGxvbmcgZ2V0U3VwcG9ydGVkUmFkaW9BY2Nlc3NGYW1pbHkoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIChsb25nKSB0ZWxlcGhvbnkuZ2V0UmFkaW9BY2Nlc3NGYW1pbHkoZ2V0U2xvdEluZGV4KCksIGdldE9wUGFja2FnZU5hbWUoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gd2hlbiB0aGUgSVRlbGVwaG9ueSBpbnRlcmZhY2UgaXMgbm90IHVwIHlldC4KICAgICAgICAgICAgICAgIHJldHVybiBORVRXT1JLX1RZUEVfQklUTUFTS19VTktOT1dOOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgc2hvdWxkbid0IGhhcHBlbiBpbiB0aGUgbm9ybWFsIGNhc2UKICAgICAgICAgICAgcmV0dXJuIE5FVFdPUktfVFlQRV9CSVRNQVNLX1VOS05PV047CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gYmVmb3JlIHBob25lIHJlc3RhcnRzIGR1ZSB0byBjcmFzaGluZwogICAgICAgICAgICByZXR1cm4gTkVUV09SS19UWVBFX0JJVE1BU0tfVU5LTk9XTjsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgRW1lcmdlbmN5IG51bWJlciBkYXRhYmFzZSB2ZXJzaW9uIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFRlc3RBcGkKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElOVkFMSURfRU1FUkdFTkNZX05VTUJFUl9EQl9WRVJTSU9OID0gLTE7CgogICAgLyoqCiAgICAgKiBOb3RpZnkgVGVsZXBob255IGZvciBPVEEgZW1lcmdlbmN5IG51bWJlciBkYXRhYmFzZSBpbnN0YWxsYXRpb24gY29tcGxldGUuCiAgICAgKgogICAgICogPHA+IFJlcXVpcmVzIHBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURSBNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHZvaWQgbm90aWZ5T3RhRW1lcmdlbmN5TnVtYmVyRGJJbnN0YWxsZWQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255Lm5vdGlmeU90YUVtZXJnZW5jeU51bWJlckRiSW5zdGFsbGVkKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgIm5vdGlmeU90YUVtZXJnZW5jeU51bWJlckRhdGFiYXNlSW5zdGFsbGVkIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIE92ZXJyaWRlIHRoZSBmaWxlIHBhdGggZm9yIE9UQSBlbWVyZ2VuY3kgbnVtYmVyIGRhdGFiYXNlIGluIGEgZmlsZSBwYXJ0aXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIG90YVBhcmNlbEZpbGVEZXNjcmlwdG9yIHBhcmNlbGFibGUgZmlsZSBkZXNjcmlwdG9yIGZvciBPVEEgZW1lcmdlbmN5IG51bWJlciBkYXRhYmFzZS4KICAgICAqCiAgICAgKiA8cD4gUmVxdWlyZXMgcGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9BQ1RJVkVfRU1FUkdFTkNZX1NFU1NJT059CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9BQ1RJVkVfRU1FUkdFTkNZX1NFU1NJT04pCiAgICBAU3lzdGVtQXBpCiAgICBAVGVzdEFwaQogICAgcHVibGljIHZvaWQgdXBkYXRlT3RhRW1lcmdlbmN5TnVtYmVyRGJGaWxlUGF0aCgKICAgICAgICAgICAgQE5vbk51bGwgUGFyY2VsRmlsZURlc2NyaXB0b3Igb3RhUGFyY2VsRmlsZURlc2NyaXB0b3IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkudXBkYXRlT3RhRW1lcmdlbmN5TnVtYmVyRGJGaWxlUGF0aChvdGFQYXJjZWxGaWxlRGVzY3JpcHRvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgInVwZGF0ZU90YUVtZXJnZW5jeU51bWJlckRiRmlsZVBhdGggUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVzZXQgdGhlIGZpbGUgcGF0aCB0byBkZWZhdWx0IGZvciBPVEEgZW1lcmdlbmN5IG51bWJlciBkYXRhYmFzZSBpbiBhIGZpbGUgcGFydGl0aW9uLgogICAgICoKICAgICAqIDxwPiBSZXF1aXJlcyBwZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX0FDVElWRV9FTUVSR0VOQ1lfU0VTU0lPTn0KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX0FDVElWRV9FTUVSR0VOQ1lfU0VTU0lPTikKICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgdm9pZCByZXNldE90YUVtZXJnZW5jeU51bWJlckRiRmlsZVBhdGgoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVsZXBob255LnJlc2V0T3RhRW1lcmdlbmN5TnVtYmVyRGJGaWxlUGF0aCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJyZXNldE90YUVtZXJnZW5jeU51bWJlckRiRmlsZVBhdGggUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3aGV0aGVyIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI0FDVElPTl9FTUVSR0VOQ1lfQVNTSVNUQU5DRSBlbWVyZ2VuY3kgYXNzaXN0YW5jZX0gaXMKICAgICAqIGF2YWlsYWJsZSBvbiB0aGUgZGV2aWNlLgogICAgICogPHA+CiAgICAgKiBSZXF1aXJlcyBwZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBlbWVyZ2VuY3kgYXNzaXN0YW5jZSBpcyBhdmFpbGFibGUsIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gaXNFbWVyZ2VuY3lBc3Npc3RhbmNlRW5hYmxlZCgpIHsKICAgICAgICBtQ29udGV4dC5lbmZvcmNlQ2FsbGluZ09yU2VsZlBlcm1pc3Npb24oCiAgICAgICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLAogICAgICAgICAgICAgICAgImlzRW1lcmdlbmN5QXNzaXN0YW5jZUVuYWJsZWQiKTsKICAgICAgICByZXR1cm4gRU1FUkdFTkNZX0FTU0lTVEFOQ0VfRU5BQkxFRDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgZW1lcmdlbmN5IG51bWJlciBsaXN0IGJhc2VkIG9uIGN1cnJlbnQgbG9jYWxlLCBzaW0sIGRlZmF1bHQsIG1vZGVtIGFuZCBuZXR3b3JrLgogICAgICoKICAgICAqIDxwPkluIGVhY2ggcmV0dXJuZWQgbGlzdCwgdGhlIGVtZXJnZW5jeSBudW1iZXIge0BsaW5rIEVtZXJnZW5jeU51bWJlcn0gY29taW5nIGZyb20gaGlnaGVyCiAgICAgKiBwcmlvcml0eSBzb3VyY2VzIHdpbGwgYmUgbG9jYXRlZCBhdCB0aGUgc21hbGxlciBpbmRleDsgdGhlIHByaW9yaXR5IG9yZGVyIG9mIHNvdXJjZXMgYXJlOgogICAgICoge0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfTlVNQkVSX1NPVVJDRV9ORVRXT1JLX1NJR05BTElOR30gPgogICAgICoge0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfTlVNQkVSX1NPVVJDRV9TSU19ID4KICAgICAqIHtAbGluayBFbWVyZ2VuY3lOdW1iZXIjRU1FUkdFTkNZX05VTUJFUl9TT1VSQ0VfREFUQUJBU0V9ID4KICAgICAqIHtAbGluayBFbWVyZ2VuY3lOdW1iZXIjRU1FUkdFTkNZX05VTUJFUl9TT1VSQ0VfREVGQVVMVH0gPgogICAgICoge0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfTlVNQkVSX1NPVVJDRV9NT0RFTV9DT05GSUd9CiAgICAgKgogICAgICogPHA+VGhlIHN1YnNjcmlwdGlvbnMgd2hpY2ggdGhlIHJldHVybmVkIGxpc3Qgd291bGQgYmUgYmFzZWQgb24sIGFyZSBhbGwgdGhlIGFjdGl2ZQogICAgICogc3Vic2NyaXB0aW9ucywgbm8gbWF0dGVyIHdoaWNoIHN1YnNjcmlwdGlvbiBjb3VsZCBiZSB1c2VkIHRvIGNyZWF0ZSBUZWxlcGhvbnlNYW5hZ2VyLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHBlcm1pc3Npb24ge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFfSBvciB0aGUgY2FsbGluZwogICAgICogYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiBNYXAgaW5jbHVkaW5nIHRoZSBrZXlzIGFzIHRoZSBhY3RpdmUgc3Vic2NyaXB0aW9uIElEcyAoTm90ZTogaWYgdGhlcmUgaXMgbm8gYWN0aXZlCiAgICAgKiBzdWJzY3JpcHRpb24sIHRoZSBrZXkgaXMge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkfSkgYW5kIHRoZSB2YWx1ZQogICAgICogYXMgdGhlIGxpc3Qgb2Yge0BsaW5rIEVtZXJnZW5jeU51bWJlcn07IGVtcHR5IE1hcCBpZiB0aGlzIGluZm9ybWF0aW9uIGlzIG5vdCBhdmFpbGFibGU7CiAgICAgKiBvciB0aHJvdyBhIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lcyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbi4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIEBOb25OdWxsCiAgICBwdWJsaWMgTWFwPEludGVnZXIsIExpc3Q8RW1lcmdlbmN5TnVtYmVyPj4gZ2V0RW1lcmdlbmN5TnVtYmVyTGlzdCgpIHsKICAgICAgICBNYXA8SW50ZWdlciwgTGlzdDxFbWVyZ2VuY3lOdW1iZXI+PiBlbWVyZ2VuY3lOdW1iZXJMaXN0ID0gbmV3IEhhc2hNYXA8PigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0RW1lcmdlbmN5TnVtYmVyTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJnZXRFbWVyZ2VuY3lOdW1iZXJMaXN0IFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW1lcmdlbmN5TnVtYmVyTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgcGVyLWNhdGVnb3J5IGVtZXJnZW5jeSBudW1iZXIgbGlzdCBiYXNlZCBvbiBjdXJyZW50IGxvY2FsZSwgc2ltLCBkZWZhdWx0LCBtb2RlbQogICAgICogYW5kIG5ldHdvcmsuCiAgICAgKgogICAgICogPHA+SW4gZWFjaCByZXR1cm5lZCBsaXN0LCB0aGUgZW1lcmdlbmN5IG51bWJlciB7QGxpbmsgRW1lcmdlbmN5TnVtYmVyfSBjb21pbmcgZnJvbSBoaWdoZXIKICAgICAqIHByaW9yaXR5IHNvdXJjZXMgd2lsbCBiZSBsb2NhdGVkIGF0IHRoZSBzbWFsbGVyIGluZGV4OyB0aGUgcHJpb3JpdHkgb3JkZXIgb2Ygc291cmNlcyBhcmU6CiAgICAgKiB7QGxpbmsgRW1lcmdlbmN5TnVtYmVyI0VNRVJHRU5DWV9OVU1CRVJfU09VUkNFX05FVFdPUktfU0lHTkFMSU5HfSA+CiAgICAgKiB7QGxpbmsgRW1lcmdlbmN5TnVtYmVyI0VNRVJHRU5DWV9OVU1CRVJfU09VUkNFX1NJTX0gPgogICAgICoge0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfTlVNQkVSX1NPVVJDRV9EQVRBQkFTRX0gPgogICAgICoge0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfTlVNQkVSX1NPVVJDRV9ERUZBVUxUfSA+CiAgICAgKiB7QGxpbmsgRW1lcmdlbmN5TnVtYmVyI0VNRVJHRU5DWV9OVU1CRVJfU09VUkNFX01PREVNX0NPTkZJR30KICAgICAqCiAgICAgKiA8cD5UaGUgc3Vic2NyaXB0aW9ucyB3aGljaCB0aGUgcmV0dXJuZWQgbGlzdCB3b3VsZCBiZSBiYXNlZCBvbiwgYXJlIGFsbCB0aGUgYWN0aXZlCiAgICAgKiBzdWJzY3JpcHRpb25zLCBubyBtYXR0ZXIgd2hpY2ggc3Vic2NyaXB0aW9uIGNvdWxkIGJlIHVzZWQgdG8gY3JlYXRlIFRlbGVwaG9ueU1hbmFnZXIuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgcGVybWlzc2lvbiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IG9yIHRoZSBjYWxsaW5nCiAgICAgKiBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gY2F0ZWdvcmllcyB0aGUgZW1lcmdlbmN5IHNlcnZpY2UgY2F0ZWdvcmllcyB3aGljaCBhcmUgdGhlIGJpdHdpc2UtT1IgY29tYmluYXRpb24gb2YKICAgICAqIHRoZSBmb2xsb3dpbmcgY29uc3RhbnRzOgogICAgICogPG9sPgogICAgICogPGxpPntAbGluayBFbWVyZ2VuY3lOdW1iZXIjRU1FUkdFTkNZX1NFUlZJQ0VfQ0FURUdPUllfVU5TUEVDSUZJRUR9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9QT0xJQ0V9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9BTUJVTEFOQ0V9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9GSVJFX0JSSUdBREV9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9NQVJJTkVfR1VBUkR9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9NT1VOVEFJTl9SRVNDVUV9IDwvbGk+CiAgICAgKiA8bGk+e0BsaW5rIEVtZXJnZW5jeU51bWJlciNFTUVSR0VOQ1lfU0VSVklDRV9DQVRFR09SWV9NSUVDfSA8L2xpPgogICAgICogPGxpPntAbGluayBFbWVyZ2VuY3lOdW1iZXIjRU1FUkdFTkNZX1NFUlZJQ0VfQ0FURUdPUllfQUlFQ30gPC9saT4KICAgICAqIDwvb2w+CiAgICAgKiBAcmV0dXJuIE1hcCBpbmNsdWRpbmcgdGhlIGtleXMgYXMgdGhlIGFjdGl2ZSBzdWJzY3JpcHRpb24gSURzIChOb3RlOiBpZiB0aGVyZSBpcyBubyBhY3RpdmUKICAgICAqIHN1YnNjcmlwdGlvbiwgdGhlIGtleSBpcyB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWR9KSBhbmQgdGhlIHZhbHVlCiAgICAgKiBhcyB0aGUgbGlzdCBvZiB7QGxpbmsgRW1lcmdlbmN5TnVtYmVyfTsgZW1wdHkgTWFwIGlmIHRoaXMgaW5mb3JtYXRpb24gaXMgbm90IGF2YWlsYWJsZTsKICAgICAqIG9yIHRocm93IGEgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2VzIG5vdCBoYXZlIHRoZSBwZXJtaXNzaW9uLgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgdGhlIFRlbGVwaG9ueSBwcm9jZXNzIGlzIG5vdCBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBNYXA8SW50ZWdlciwgTGlzdDxFbWVyZ2VuY3lOdW1iZXI+PiBnZXRFbWVyZ2VuY3lOdW1iZXJMaXN0KAogICAgICAgICAgICBARW1lcmdlbmN5U2VydmljZUNhdGVnb3JpZXMgaW50IGNhdGVnb3JpZXMpIHsKICAgICAgICBNYXA8SW50ZWdlciwgTGlzdDxFbWVyZ2VuY3lOdW1iZXI+PiBlbWVyZ2VuY3lOdW1iZXJMaXN0ID0gbmV3IEhhc2hNYXA8PigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVtZXJnZW5jeU51bWJlckxpc3QgPSB0ZWxlcGhvbnkuZ2V0RW1lcmdlbmN5TnVtYmVyTGlzdCgKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgICAgIGlmIChlbWVyZ2VuY3lOdW1iZXJMaXN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKEludGVnZXIgc3Vic2NyaXB0aW9uSWQgOiBlbWVyZ2VuY3lOdW1iZXJMaXN0LmtleVNldCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExpc3Q8RW1lcmdlbmN5TnVtYmVyPiBudW1iZXJMaXN0ID0gZW1lcmdlbmN5TnVtYmVyTGlzdC5nZXQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKEVtZXJnZW5jeU51bWJlciBudW1iZXIgOiBudW1iZXJMaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW51bWJlci5pc0luRW1lcmdlbmN5U2VydmljZUNhdGVnb3JpZXMoY2F0ZWdvcmllcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXJMaXN0LnJlbW92ZShudW1iZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVtZXJnZW5jeU51bWJlckxpc3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgImdldEVtZXJnZW5jeU51bWJlckxpc3Qgd2l0aCBDYXRlZ29yaWVzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW1lcmdlbmN5TnVtYmVyTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIElkZW50aWZpZXMgaWYgdGhlIHN1cHBsaWVkIHBob25lIG51bWJlciBpcyBhbiBlbWVyZ2VuY3kgbnVtYmVyIHRoYXQgbWF0Y2hlcyBhIGtub3duCiAgICAgKiBlbWVyZ2VuY3kgbnVtYmVyIGJhc2VkIG9uIGN1cnJlbnQgbG9jYWxlLCBTSU0gY2FyZChzKSwgQW5kcm9pZCBkYXRhYmFzZSwgbW9kZW0sIG5ldHdvcmssCiAgICAgKiBvciBkZWZhdWx0cy4KICAgICAqCiAgICAgKiA8cD5UaGlzIG1ldGhvZCBhc3N1bWVzIHRoYXQgb25seSBkaWFsYWJsZSBwaG9uZSBudW1iZXJzIGFyZSBwYXNzZWQgaW47IG5vbi1kaWFsYWJsZQogICAgICogbnVtYmVycyBhcmUgbm90IGNvbnNpZGVyZWQgZW1lcmdlbmN5IG51bWJlcnMuIEEgZGlhbGFibGUgcGhvbmUgbnVtYmVyIGNvbnNpc3RzIG9ubHkKICAgICAqIG9mIGNoYXJhY3RlcnMvZGlnaXRzIGlkZW50aWZpZWQgYnkge0BsaW5rIFBob25lTnVtYmVyVXRpbHMjaXNEaWFsYWJsZShjaGFyKX0uCiAgICAgKgogICAgICogPHA+VGhlIHN1YnNjcmlwdGlvbnMgd2hpY2ggdGhlIGlkZW50aWZpY2F0aW9uIHdvdWxkIGJlIGJhc2VkIG9uLCBhcmUgYWxsIHRoZSBhY3RpdmUKICAgICAqIHN1YnNjcmlwdGlvbnMsIG5vIG1hdHRlciB3aGljaCBzdWJzY3JpcHRpb24gY291bGQgYmUgdXNlZCB0byBjcmVhdGUgVGVsZXBob255TWFuYWdlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbnVtYmVyIC0gdGhlIG51bWJlciB0byBsb29rIHVwCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIGFuIGVtZXJnZW5jeSBudW1iZXIgYmFzZWQgb24gY3VycmVudCBsb2NhbGUsCiAgICAgKiBTSU0gY2FyZChzKSwgQW5kcm9pZCBkYXRhYmFzZSwgbW9kZW0sIG5ldHdvcmsgb3IgZGVmYXVsdHM7IHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgdGhlIFRlbGVwaG9ueSBwcm9jZXNzIGlzIG5vdCBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc0VtZXJnZW5jeU51bWJlcihATm9uTnVsbCBTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5pc0VtZXJnZW5jeU51bWJlcihudW1iZXIsIHRydWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJpc0VtZXJnZW5jeU51bWJlciBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBzdXBwbGllZCBudW1iZXIgaXMgYW4gZW1lcmdlbmN5IG51bWJlciBiYXNlZCBvbiBjdXJyZW50IGxvY2FsZSwgc2ltLCBkZWZhdWx0LAogICAgICogbW9kZW0gYW5kIG5ldHdvcmsuCiAgICAgKgogICAgICogPHA+IFNwZWNpZmljYWxseSwgdGhpcyBtZXRob2Qgd2lsbCByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzcGVjaWZpZWQgbnVtYmVyIGlzIGFuCiAgICAgKiBlbWVyZ2VuY3kgbnVtYmVyLCAqb3IqIGlmIHRoZSBudW1iZXIgc2ltcGx5IHN0YXJ0cyB3aXRoIHRoZSBzYW1lIGRpZ2l0cyBhcyBhbnkgY3VycmVudAogICAgICogZW1lcmdlbmN5IG51bWJlci4KICAgICAqCiAgICAgKiA8cD5UaGUgc3Vic2NyaXB0aW9ucyB3aGljaCB0aGUgaWRlbnRpZmljYXRpb24gd291bGQgYmUgYmFzZWQgb24sIGFyZSBhbGwgdGhlIGFjdGl2ZQogICAgICogc3Vic2NyaXB0aW9ucywgbm8gbWF0dGVyIHdoaWNoIHN1YnNjcmlwdGlvbiBjb3VsZCBiZSB1c2VkIHRvIGNyZWF0ZSBUZWxlcGhvbnlNYW5hZ2VyLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFfSBvcgogICAgICogdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gbnVtYmVyIC0gdGhlIG51bWJlciB0byBsb29rIHVwCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIGFuIGVtZXJnZW5jeSBudW1iZXIgb3IgaXQgc2ltcGx5IHN0YXJ0cyB3aXRoCiAgICAgKiB0aGUgc2FtZSBkaWdpdHMgb2YgYW55IGN1cnJlbnQgZW1lcmdlbmN5IG51bWJlciBiYXNlZCBvbiBjdXJyZW50IGxvY2FsZSwgc2ltLCBtb2RlbSBhbmQKICAgICAqIG5ldHdvcms7IHtAY29kZSBmYWxzZX0gaWYgaXQgaXMgbm90OyBvciB0aHJvdyBhbiBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXMgbm90CiAgICAgKiBoYXZlIHRoZSByZXF1aXJlZCBwZXJtaXNzaW9uL3ByaXZpbGVnZXMKICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIHRoZSBUZWxlcGhvbnkgcHJvY2VzcyBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzUG90ZW50aWFsRW1lcmdlbmN5TnVtYmVyKEBOb25OdWxsIFN0cmluZyBudW1iZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmlzRW1lcmdlbmN5TnVtYmVyKG51bWJlciwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJpc0VtZXJnZW5jeU51bWJlciBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgZW1lcmdlbmN5IG51bWJlciBkYXRhYmFzZSB2ZXJzaW9uLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiAgIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURX0KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVGVzdEFwaQogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRFbWVyZ2VuY3lOdW1iZXJEYlZlcnNpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRFbWVyZ2VuY3lOdW1iZXJEYlZlcnNpb24oZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAiZ2V0RW1lcmdlbmN5TnVtYmVyRGJWZXJzaW9uIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSU5WQUxJRF9FTUVSR0VOQ1lfTlVNQkVSX0RCX1ZFUlNJT047CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiU0VUX09QUE9SVFVOSVNUSUNfU1VCIn0sIHZhbHVlID0gewogICAgICAgICAgICBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfU1VDQ0VTUywKICAgICAgICAgICAgU0VUX09QUE9SVFVOSVNUSUNfU1VCX1ZBTElEQVRJT05fRkFJTEVELAogICAgICAgICAgICBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfSU5BQ1RJVkVfU1VCU0NSSVBUSU9OLAogICAgICAgICAgICBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfTk9fT1BQT1JUVU5JU1RJQ19TVUJfQVZBSUxBQkxFLAogICAgICAgICAgICBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfUkVNT1RFX1NFUlZJQ0VfRVhDRVBUSU9OfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFNldE9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25SZXN1bHQge30KCiAgICAvKioKICAgICAqIE5vIGVycm9yLiBPcGVyYXRpb24gc3VjY2VlZGVkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfU1VDQ0VTUyA9IDA7CgogICAgLyoqCiAgICAgKiBWYWxpZGF0aW9uIGZhaWxlZCB3aGVuIHRyeWluZyB0byBzd2l0Y2ggdG8gcHJlZmVycmVkIHN1YnNjcmlwdGlvbi4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VUX09QUE9SVFVOSVNUSUNfU1VCX1ZBTElEQVRJT05fRkFJTEVEID0gMTsKCiAgICAvKioKICAgICAqIFRoZSBzdWJzY3JpcHRpb24gaXMgbm90IHZhbGlkLiBJdCBtdXN0IGJlIGFuIGFjdGl2ZSBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbi4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VUX09QUE9SVFVOSVNUSUNfU1VCX0lOQUNUSVZFX1NVQlNDUklQVElPTiA9IDI7CgogICAgLyoqCiAgICAgKiBUaGUgc3Vic2NyaXB0aW9uIGlzIG5vdCB2YWxpZC4gSXQgbXVzdCBiZSBhbiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbi4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VUX09QUE9SVFVOSVNUSUNfU1VCX05PX09QUE9SVFVOSVNUSUNfU1VCX0FWQUlMQUJMRSA9IDM7CgogICAgLyoqCiAgICAgKiBTdWJzY3JpcHRpb24gc2VydmljZSBoYXBwZW5lZCByZW1vdGUgZXhjZXB0aW9uLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTRVRfT1BQT1JUVU5JU1RJQ19TVUJfUkVNT1RFX1NFUlZJQ0VfRVhDRVBUSU9OID0gNDsKCgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLUyJ9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19TVUNDRVNTLAogICAgICAgICAgICBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX1VOS05PV05fRkFJTFVSRSwKICAgICAgICAgICAgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19BQk9SVEVELAogICAgICAgICAgICBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX0lOVkFMSURfQVJHVU1FTlRTLAogICAgICAgICAgICBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX05PX0NBUlJJRVJfUFJJVklMRUdFLAogICAgICAgICAgICBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX0RJU0FCTEVfTU9ERU1fRkFJTCwKICAgICAgICAgICAgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19FTkFCTEVfTU9ERU1fRkFJTCwKICAgICAgICAgICAgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19NVUxUSVBMRV9ORVRXT1JLU19OT1RfU1VQUE9SVEVELAogICAgICAgICAgICBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX05PX09QUE9SVFVOSVNUSUNfU1VCX0FWQUlMQUJMRSwKICAgICAgICAgICAgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19SRU1PVEVfU0VSVklDRV9FWENFUFRJT04sCiAgICAgICAgICAgIFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfU0VSVklDRV9JU19ESVNBQkxFRH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBVcGRhdGVBdmFpbGFibGVOZXR3b3Jrc1Jlc3VsdCB7fQoKICAgIC8qKgogICAgICogTm8gZXJyb3IuIE9wZXJhdGlvbiBzdWNjZWVkZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfU1VDQ0VTUyA9IDA7CgogICAgLyoqCiAgICAgKiBUaGVyZSBpcyBhIHVua25vd24gZmFpbHVyZSBoYXBwZW5lZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19VTktOT1dOX0ZBSUxVUkUgPSAxOwoKICAgIC8qKgogICAgICogVGhlIHJlcXVlc3QgaXMgYWJvcnRlZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19BQk9SVEVEID0gMjsKCiAgICAvKioKICAgICAqIFRoZSBwYXJhbWV0ZXIgcGFzc2VkIGluIGlzIGludmFsaWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfSU5WQUxJRF9BUkdVTUVOVFMgPSAzOwoKICAgIC8qKgogICAgICogTm8gY2FycmllciBwcml2aWxlZ2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfTk9fQ0FSUklFUl9QUklWSUxFR0UgPSA0OwoKICAgIC8qKgogICAgICogRGlzYWJsZSBtb2RlbSBmYWlsLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX0RJU0FCTEVfTU9ERU1fRkFJTCA9IDU7CgogICAgLyoqCiAgICAgKiBFbmFibGUgbW9kZW0gZmFpbC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19FTkFCTEVfTU9ERU1fRkFJTCA9IDY7CgogICAgLyoqCiAgICAgKiBDYXJyaWVyIGFwcCBkb2VzIG5vdCBzdXBwb3J0IG11bHRpcGxlIGF2YWlsYWJsZSBuZXR3b3Jrcy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19NVUxUSVBMRV9ORVRXT1JLU19OT1RfU1VQUE9SVEVEID0gNzsKCiAgICAvKioKICAgICAqIFRoZSBzdWJzY3JpcHRpb24gaXMgbm90IHZhbGlkLiBJdCBtdXN0IGJlIGFuIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVUERBVEVfQVZBSUxBQkxFX05FVFdPUktTX05PX09QUE9SVFVOSVNUSUNfU1VCX0FWQUlMQUJMRSA9IDg7CgogICAgLyoqCiAgICAgKiBUaGVyZSBpcyBubyBPcHBvcnR1bmlzdGljTmV0d29ya1NlcnZpY2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfUkVNT1RFX1NFUlZJQ0VfRVhDRVBUSU9OID0gOTsKCiAgICAvKioKICAgICAqIE9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSBpcyBkaXNhYmxlZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVBEQVRFX0FWQUlMQUJMRV9ORVRXT1JLU19TRVJWSUNFX0lTX0RJU0FCTEVEID0gMTA7CgogICAgLyoqCiAgICAgKiBTZXQgcHJlZmVycmVkIG9wcG9ydHVuaXN0aWMgZGF0YSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogU3dpdGNoIGludGVybmV0IGRhdGEgdG8gcHJlZmVycmVkIG9wcG9ydHVuaXN0aWMgZGF0YSBzdWJzY3JpcHRpb24gaWQuIFRoaXMgYXBpCiAgICAgKiBjYW4gcmVzdWx0IGluIGxvc2Ugb2YgaW50ZXJuZXQgY29ubmVjdGl2aXR5IGZvciBzaG9ydCBwZXJpb2Qgb2YgdGltZSB3aGlsZSBpbnRlcm5ldCBkYXRhCiAgICAgKiBpcyBoYW5kZWQgb3Zlci4KICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgb24gYm90aCBwcmltYXJ5IGFuZAogICAgICogc2Vjb25kYXJ5IHN1YnNjcmlwdGlvbnMgKHNlZQogICAgICoge0BsaW5rICNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLCBvciBoYXMgcGVybWlzc2lvbgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgd2hpY2ggb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24KICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldE9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zfSBpcyBwcmVmZXJyZWQgZm9yIGNlbGx1bGFyIGRhdGEuCiAgICAgKiBQYXNzIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfSB0byB1bnNldCB0aGUgcHJlZmVyZW5jZQogICAgICogQHBhcmFtIG5lZWRWYWxpZGF0aW9uIHdoZXRoZXIgdmFsaWRhdGlvbiBpcyBuZWVkZWQgYmVmb3JlIHN3aXRjaCBoYXBwZW5zLgogICAgICogQHBhcmFtIGV4ZWN1dG9yIFRoZSBleGVjdXRvciBvZiB3aGVyZSB0aGUgY2FsbGJhY2sgd2lsbCBleGVjdXRlLgogICAgICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIHdpbGwgYmUgdHJpZ2dlcmVkIG9uY2UgaXQgc3VjY2VlZHMgb3IgZmFpbGVkLgogICAgICogICAgICAgICAgICAgICAgIFNlZSB7QGxpbmsgVGVsZXBob255TWFuYWdlci5TZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uUmVzdWx0fQogICAgICogICAgICAgICAgICAgICAgIGZvciBtb3JlIGRldGFpbHMuIFBhc3MgbnVsbCBpZiBkb24ndCBjYXJlIGFib3V0IHRoZSByZXN1bHQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFByZWZlcnJlZE9wcG9ydHVuaXN0aWNEYXRhU3Vic2NyaXB0aW9uKGludCBzdWJJZCwgYm9vbGVhbiBuZWVkVmFsaWRhdGlvbiwKICAgICAgICAgICAgQE51bGxhYmxlIEBDYWxsYmFja0V4ZWN1dG9yIEV4ZWN1dG9yIGV4ZWN1dG9yLCBATnVsbGFibGUgQ29uc3VtZXI8SW50ZWdlcj4gY2FsbGJhY2spIHsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSU9ucyBpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlID0gZ2V0SU9ucygpOwogICAgICAgICAgICBpZiAoaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhlY3V0b3IgPT0gbnVsbCB8fCBjYWxsYmFjayA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKENvbXBhdGliaWxpdHkuaXNDaGFuZ2VFbmFibGVkKENBTExCQUNLX09OX01PUkVfRVJST1JfQ09ERV9DSEFOR0UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hY2NlcHQoU0VUX09QUE9SVFVOSVNUSUNfU1VCX1JFTU9URV9TRVJWSUNFX0VYQ0VQVElPTik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hY2NlcHQoU0VUX09QUE9SVFVOSVNUSUNfU1VCX0lOQUNUSVZFX1NVQlNDUklQVElPTik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgQmluZGVyLnJlc3RvcmVDYWxsaW5nSWRlbnRpdHkoaWRlbnRpdHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrIGNhbGxiYWNrU3R1YiA9IG5ldyBJU2V0T3Bwb3J0dW5pc3RpY0RhdGFDYWxsYmFjay5TdHViKCkgewogICAgICAgICAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgICAgICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlKGludCByZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXhlY3V0b3IgPT0gbnVsbCB8fCBjYWxsYmFjayA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYWNjZXB0KHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpbmRlci5yZXN0b3JlQ2FsbGluZ0lkZW50aXR5KGlkZW50aXR5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgLnNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZChzdWJJZCwgbmVlZFZhbGlkYXRpb24sIGNhbGxiYWNrU3R1YiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBrZ0ZvckRlYnVnKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZCBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBwcmVmZXJyZWQgb3Bwb3J0dW5pc3RpYyBkYXRhIHN1YnNjcmlwdGlvbiBJZAogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSksCiAgICAgKiBvciBoYXMgZWl0aGVyIFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURQogICAgICogb3Ige0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24uCiAgICAgKiBAcmV0dXJuIHN1YklkIHByZWZlcnJlZCBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiBpZCBvcgogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9IGlmIHRoZXJlIGFyZSBubyBwcmVmZXJyZWQKICAgICAqIHN1YnNjcmlwdGlvbiBpZAogICAgICoKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUKICAgIH0pCiAgICBwdWJsaWMgaW50IGdldFByZWZlcnJlZE9wcG9ydHVuaXN0aWNEYXRhU3Vic2NyaXB0aW9uKCkgewogICAgICAgIFN0cmluZyBwYWNrYWdlTmFtZSA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBTdHJpbmcgYXR0cmlidXRpb25UYWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSA6IG51bGw7CiAgICAgICAgaW50IHN1YklkID0gU3Vic2NyaXB0aW9uTWFuYWdlci5JTlZBTElEX1NVQlNDUklQVElPTl9JRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJT25zIGlPcHBvcnR1bmlzdGljTmV0d29ya1NlcnZpY2UgPSBnZXRJT25zKCk7CiAgICAgICAgICAgIGlmIChpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YklkID0gaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZS5nZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoCiAgICAgICAgICAgICAgICAgICAgICAgIHBhY2thZ2VOYW1lLCBhdHRyaWJ1dGlvblRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZCBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFVwZGF0ZSBhdmFpbGFiaWxpdHkgb2YgYSBsaXN0IG9mIG5ldHdvcmtzIGluIHRoZSBjdXJyZW50IGxvY2F0aW9uLgogICAgICoKICAgICAqIFRoaXMgYXBpIHNob3VsZCBiZSBjYWxsZWQgdG8gaW5mb3JtIE9wcG9ydHVuaXN0aWNOZXR3b3JrIFNlcnZpY2UgYWJvdXQgdGhlIGF2YWlsYWJpbGl0eQogICAgICogb2YgYSBuZXR3b3JrIGF0IHRoZSBjdXJyZW50IGxvY2F0aW9uLiBUaGlzIGluZm9ybWF0aW9uIHdpbGwgYmUgdXNlZCBieSBPcHBvcnR1bmlzdGljTmV0d29yawogICAgICogc2VydmljZSB0byBlbmFibGUgbW9kZW0gc3RhY2sgYW5kIHRvIGF0dGFjaCB0byB0aGUgbmV0d29yay4gSWYgYW4gZW1wdHkgbGlzdCBpcyBwYXNzZWQsCiAgICAgKiBpdCBpcyBhc3N1bWVkIHRoYXQgbm8gbmV0d29yayBpcyBhdmFpbGFibGUgYW5kIHdpbGwgcmVzdWx0IGluIGRpc2FibGluZyB0aGUgbW9kZW0gc3RhY2sKICAgICAqIHRvIHNhdmUgcG93ZXIuIFRoaXMgYXBpIGRvIG5vdCBzd2l0Y2ggaW50ZXJuZXQgZGF0YSBvbmNlIG5ldHdvcmsgYXR0YWNoIGlzIGNvbXBsZXRlZC4KICAgICAqIFVzZSB7QGxpbmsgVGVsZXBob255TWFuYWdlciNzZXRQcmVmZXJyZWRPcHBvcnR1bmlzdGljRGF0YVN1YnNjcmlwdGlvbn0KICAgICAqIHRvIHN3aXRjaCBpbnRlcm5ldCBkYXRhIGFmdGVyIG5ldHdvcmsgYXR0YWNoIGlzIGNvbXBsZXRlLgogICAgICogUmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyBvbiBib3RoIHByaW1hcnkgYW5kCiAgICAgKiBzZWNvbmRhcnkgc3Vic2NyaXB0aW9ucyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KSwgb3IgaGFzIHBlcm1pc3Npb24KICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0uCiAgICAgKiBAcGFyYW0gYXZhaWxhYmxlTmV0d29ya3MgaXMgYSBsaXN0IG9mIGF2YWlsYWJsZSBuZXR3b3JrIGluZm9ybWF0aW9uLgogICAgICogQHBhcmFtIGV4ZWN1dG9yIFRoZSBleGVjdXRvciBvZiB3aGVyZSB0aGUgY2FsbGJhY2sgd2lsbCBleGVjdXRlLgogICAgICogQHBhcmFtIGNhbGxiYWNrIENhbGxiYWNrIHdpbGwgYmUgdHJpZ2dlcmVkIG9uY2UgaXQgc3VjY2VlZHMgb3IgZmFpbGVkLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIHB1YmxpYyB2b2lkIHVwZGF0ZUF2YWlsYWJsZU5ldHdvcmtzKEBOb25OdWxsIExpc3Q8QXZhaWxhYmxlTmV0d29ya0luZm8+IGF2YWlsYWJsZU5ldHdvcmtzLAogICAgICAgICAgICBATnVsbGFibGUgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsCiAgICAgICAgICAgIEBVcGRhdGVBdmFpbGFibGVOZXR3b3Jrc1Jlc3VsdCBATnVsbGFibGUgQ29uc3VtZXI8SW50ZWdlcj4gY2FsbGJhY2spIHsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSU9ucyBpT3Bwb3J0dW5pc3RpY05ldHdvcmtTZXJ2aWNlID0gZ2V0SU9ucygpOwogICAgICAgICAgICBpZiAoaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSA9PSBudWxsIHx8IGF2YWlsYWJsZU5ldHdvcmtzID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGNhbGxiYWNrID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKENvbXBhdGliaWxpdHkuaXNDaGFuZ2VFbmFibGVkKENBTExCQUNLX09OX01PUkVfRVJST1JfQ09ERV9DSEFOR0UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYWNjZXB0KFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfUkVNT1RFX1NFUlZJQ0VfRVhDRVBUSU9OKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYWNjZXB0KFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfVU5LTk9XTl9GQUlMVVJFKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgQmluZGVyLnJlc3RvcmVDYWxsaW5nSWRlbnRpdHkoaWRlbnRpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWwgbG9uZyBpZGVudGl0eSA9IEJpbmRlci5jbGVhckNhbGxpbmdJZGVudGl0eSgpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYWNjZXB0KFVQREFURV9BVkFJTEFCTEVfTkVUV09SS1NfSU5WQUxJRF9BUkdVTUVOVFMpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElVcGRhdGVBdmFpbGFibGVOZXR3b3Jrc0NhbGxiYWNrIGNhbGxiYWNrU3R1YiA9CiAgICAgICAgICAgICAgICAgICAgbmV3IElVcGRhdGVBdmFpbGFibGVOZXR3b3Jrc0NhbGxiYWNrLlN0dWIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlKGludCByZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGNhbGxiYWNrID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbCBsb25nIGlkZW50aXR5ID0gQmluZGVyLmNsZWFyQ2FsbGluZ0lkZW50aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hY2NlcHQocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQmluZGVyLnJlc3RvcmVDYWxsaW5nSWRlbnRpdHkoaWRlbnRpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgaU9wcG9ydHVuaXN0aWNOZXR3b3JrU2VydmljZS51cGRhdGVBdmFpbGFibGVOZXR3b3JrcyhhdmFpbGFibGVOZXR3b3JrcywgY2FsbGJhY2tTdHViLAogICAgICAgICAgICAgICAgICAgIHBrZ0ZvckRlYnVnKTsKICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInVwZGF0ZUF2YWlsYWJsZU5ldHdvcmtzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBFbmFibGUgb3IgZGlzYWJsZSBhIGxvZ2ljYWwgbW9kZW0gc3RhY2suIFdoZW4gYSBsb2dpY2FsIG1vZGVtIGlzIGRpc2FibGVkLCB0aGUgY29ycmVzcG9uZGluZwogICAgICogU0lNIHdpbGwgc3RpbGwgYmUgdmlzaWJsZSB0byB0aGUgdXNlciBidXQgaXRzIG1hcHBpbmcgbW9kZW0gd2lsbCBub3QgaGF2ZSBhbnkgcmFkaW8gYWN0aXZpdHkuCiAgICAgKiBGb3IgZXhhbXBsZSwgd2Ugd2lsbCBkaXNhYmxlIGEgbW9kZW0gd2hlbiB1c2VyIG9yIHN5c3RlbSBiZWxpZXZlcyB0aGUgY29ycmVzcG9uZGluZyBTSU0KICAgICAqIGlzIHRlbXBvcmFyaWx5IG5vdCBuZWVkZWQgKGUuZy4gb3V0IG9mIGNvdmVyYWdlKSwgYW5kIHdpbGwgZW5hYmxlIGl0IGJhY2sgb24gd2hlbiBuZWVkZWQuCiAgICAgKgogICAgICogUmVxdWlyZXMgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIHBlcm1pc3Npb24KICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFIE1PRElGWV9QSE9ORV9TVEFURX0uCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHdoaWNoIGNvcnJlc3BvbmRpbmcgbW9kZW0gd2lsbCBvcGVyYXRlIG9uLgogICAgICogQHBhcmFtIGVuYWJsZSB3aGV0aGVyIHRvIGVuYWJsZSBvciBkaXNhYmxlIHRoZSBtb2RlbSBzdGFjay4KICAgICAqIEByZXR1cm4gd2hldGhlciB0aGUgb3BlcmF0aW9uIGlzIHN1Y2Nlc3NmdWwuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gZW5hYmxlTW9kZW1Gb3JTbG90KGludCBzbG90SW5kZXgsIGJvb2xlYW4gZW5hYmxlKSB7CiAgICAgICAgYm9vbGVhbiByZXQgPSBmYWxzZTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXQgPSB0ZWxlcGhvbnkuZW5hYmxlTW9kZW1Gb3JTbG90KHNsb3RJbmRleCwgZW5hYmxlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJlbmFibGVNb2RlbSBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdCBpbmRpY2F0ZXMgd2hldGhlciBtb2RlbSBpcyBlbmFibGVkIG9yIG5vdCBwZXIgc2xvdC4KICAgICAqIEl0J3MgdGhlIGNvcnJlc3BvbmRpbmcgc3RhdHVzIG9mIFRlbGVwaG9ueU1hbmFnZXIuZW5hYmxlTW9kZW1Gb3JTbG90LgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgb3IKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogQHBhcmFtIHNsb3RJbmRleCB3aGljaCBzbG90IGl0J3MgY2hlY2tpbmcuCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc01vZGVtRW5hYmxlZEZvclNsb3QoaW50IHNsb3RJbmRleCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaXNNb2RlbUVuYWJsZWRGb3JTbG90KHNsb3RJbmRleCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJlbmFibGVNb2RlbSBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBpbnRlbnQgYWN0aW9uIGZvciBuZXR3b3JrIGNvdW50cnkgY29kZSBjaGFuZ2VzLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayAjRVhUUkFfTkVUV09SS19DT1VOVFJZfSBleHRyYSBpbmRpY2F0ZXMgdGhlIGNvdW50cnkgY29kZSBvZiB0aGUgY3VycmVudAogICAgICogbmV0d29yayByZXR1cm5lZCBieSB7QGxpbmsgI2dldE5ldHdvcmtDb3VudHJ5SXNvKCl9LgogICAgICoKICAgICAqIDxwPlRoZXJlIG1heSBiZSBhIGRlbGF5IG9mIHNldmVyYWwgbWludXRlcyBiZWZvcmUgcmVwb3J0aW5nIHRoYXQgbm8gY291bnRyeSBpcyBkZXRlY3RlZC4KICAgICAqCiAgICAgKiBAc2VlICNFWFRSQV9ORVRXT1JLX0NPVU5UUlkKICAgICAqIEBzZWUgI2dldE5ldHdvcmtDb3VudHJ5SXNvKCkKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX05FVFdPUktfQ09VTlRSWV9DSEFOR0VEID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5ORVRXT1JLX0NPVU5UUllfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBUaGUgZXh0cmEgdXNlZCB3aXRoIGFuIHtAbGluayAjQUNUSU9OX05FVFdPUktfQ09VTlRSWV9DSEFOR0VEfSB0byBzcGVjaWZ5IHRoZQogICAgICogdGhlIGNvdW50cnkgY29kZSBpbiBJU08tMzE2Ni0xIGFscGhhLTIgZm9ybWF0LgogICAgICogPHAgY2xhc3M9Im5vdGUiPgogICAgICogUmV0cmlldmUgd2l0aCB7QGxpbmsgYW5kcm9pZC5jb250ZW50LkludGVudCNnZXRTdHJpbmdFeHRyYShTdHJpbmcpfS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfTkVUV09SS19DT1VOVFJZID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLk5FVFdPUktfQ09VTlRSWSI7CgogICAgLyoqCiAgICAgKiBUaGUgZXh0cmEgdXNlZCB3aXRoIGFuIHtAbGluayAjQUNUSU9OX05FVFdPUktfQ09VTlRSWV9DSEFOR0VEfSB0byBzcGVjaWZ5IHRoZQogICAgICogbGFzdCBrbm93biB0aGUgY291bnRyeSBjb2RlIGluIElTTy0zMTY2LTEgYWxwaGEtMiBmb3JtYXQuCiAgICAgKiA8cCBjbGFzcz0ibm90ZSI+CiAgICAgKiBSZXRyaWV2ZSB3aXRoIHtAbGluayBhbmRyb2lkLmNvbnRlbnQuSW50ZW50I2dldFN0cmluZ0V4dHJhKFN0cmluZyl9LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX0xBU1RfS05PV05fTkVUV09SS19DT1VOVFJZID0KICAgICAgICAgICAgImFuZHJvaWQudGVsZXBob255LmV4dHJhLkxBU1RfS05PV05fTkVUV09SS19DT1VOVFJZIjsKCiAgICAvKioKICAgICAqIEluZGljYXRlIGlmIHRoZSB1c2VyIGlzIGFsbG93ZWQgdG8gdXNlIG11bHRpcGxlIFNJTSBjYXJkcyBhdCB0aGUgc2FtZSB0aW1lIHRvIHJlZ2lzdGVyCiAgICAgKiBvbiB0aGUgbmV0d29yayAoZS5nLiBEdWFsIFN0YW5kYnkgb3IgRHVhbCBBY3RpdmUpIHdoZW4gdGhlIGRldmljZSBzdXBwb3J0cyBpdCwgb3IgaWYgdGhlCiAgICAgKiB1c2FnZSBpcyByZXN0cmljdGVkLiBUaGlzIEFQSSBpcyB1c2VkIHRvIHByZXZlbnQgdXNhZ2Ugb2YgbXVsdGlwbGUgU0lNIGNhcmQsIGJhc2VkIG9uCiAgICAgKiBwb2xpY2llcyBvZiB0aGUgY2Fycmllci4KICAgICAqIDxwPk5vdGU6IHRoZSBBUEkgZG9lcyBub3QgcHJldmVudCBhY2Nlc3MgdG8gdGhlIFNJTSBjYXJkcyBmb3Igb3BlcmF0aW9ucyB0aGF0IGRvbid0IHJlcXVpcmUKICAgICAqIGFjY2VzcyB0byB0aGUgbmV0d29yay4KICAgICAqCiAgICAgKiBAcGFyYW0gaXNNdWx0aVNpbUNhcnJpZXJSZXN0cmljdGVkIHRydWUgaWYgdXNhZ2Ugb2YgbXVsdGlwbGUgU0lNcyBpcyByZXN0cmljdGVkLCBmYWxzZQogICAgICogb3RoZXJ3aXNlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldE11bHRpU2ltQ2FycmllclJlc3RyaWN0aW9uKGJvb2xlYW4gaXNNdWx0aVNpbUNhcnJpZXJSZXN0cmljdGVkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXJ2aWNlLnNldE11bHRpU2ltQ2FycmllclJlc3RyaWN0aW9uKGlzTXVsdGlTaW1DYXJyaWVyUmVzdHJpY3RlZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJzZXRNdWx0aVNpbUNhcnJpZXJSZXN0cmljdGlvbiBSZW1vdGVFeGNlcHRpb24iLCBlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgdXNhZ2Ugb2YgbXVsdGlwbGUgU0lNIGNhcmRzIGF0IHRoZSBzYW1lIHRpbWUgdG8gcmVnaXN0ZXIgb24gdGhlIG5ldHdvcmsgKGUuZy4gRHVhbAogICAgICogU3RhbmRieSBvciBEdWFsIEFjdGl2ZSkgaXMgc3VwcG9ydGVkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNVUxUSVNJTV9BTExPV0VEID0gMDsKCiAgICAvKioKICAgICAqIFRoZSB1c2FnZSBvZiBtdWx0aXBsZSBTSU0gY2FyZHMgYXQgdGhlIHNhbWUgdGltZSB0byByZWdpc3RlciBvbiB0aGUgbmV0d29yayAoZS5nLiBEdWFsCiAgICAgKiBTdGFuZGJ5IG9yIER1YWwgQWN0aXZlKSBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBoYXJkd2FyZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTVVMVElTSU1fTk9UX1NVUFBPUlRFRF9CWV9IQVJEV0FSRSA9IDE7CgogICAgLyoqCiAgICAgKiBUaGUgdXNhZ2Ugb2YgbXVsdGlwbGUgU0lNIGNhcmRzIGF0IHRoZSBzYW1lIHRpbWUgdG8gcmVnaXN0ZXIgb24gdGhlIG5ldHdvcmsgKGUuZy4gRHVhbAogICAgICogU3RhbmRieSBvciBEdWFsIEFjdGl2ZSkgaXMgc3VwcG9ydGVkIGJ5IHRoZSBoYXJkd2FyZSwgYnV0IHJlc3RyaWN0ZWQgYnkgdGhlIGNhcnJpZXIuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1VTFRJU0lNX05PVF9TVVBQT1JURURfQllfQ0FSUklFUiA9IDI7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiTVVMVElTSU1fIn0sCiAgICAgICAgICAgIHZhbHVlID0gewogICAgICAgICAgICAgICAgICAgIE1VTFRJU0lNX0FMTE9XRUQsCiAgICAgICAgICAgICAgICAgICAgTVVMVElTSU1fTk9UX1NVUFBPUlRFRF9CWV9IQVJEV0FSRSwKICAgICAgICAgICAgICAgICAgICBNVUxUSVNJTV9OT1RfU1VQUE9SVEVEX0JZX0NBUlJJRVIKICAgICAgICAgICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIElzTXVsdGlTaW1TdXBwb3J0ZWRSZXN1bHQge30KCiAgICAvKioKICAgICAqIFJldHVybnMgaWYgdGhlIHVzYWdlIG9mIG11bHRpcGxlIFNJTSBjYXJkcyBhdCB0aGUgc2FtZSB0aW1lIHRvIHJlZ2lzdGVyIG9uIHRoZSBuZXR3b3JrCiAgICAgKiAoZS5nLiBEdWFsIFN0YW5kYnkgb3IgRHVhbCBBY3RpdmUpIGlzIHN1cHBvcnRlZCBieSB0aGUgZGV2aWNlIGFuZCBieSB0aGUgY2Fycmllci4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB7QGxpbmsgI01VTFRJU0lNX0FMTE9XRUR9IGlmIHRoZSBkZXZpY2Ugc3VwcG9ydHMgbXVsdGlwbGUgU0lNcy4KICAgICAqIHtAbGluayAjTVVMVElTSU1fTk9UX1NVUFBPUlRFRF9CWV9IQVJEV0FSRX0gaWYgdGhlIGRldmljZSBkb2VzIG5vdCBzdXBwb3J0IG11bHRpcGxlIFNJTXMuCiAgICAgKiB7QGxpbmsgI01VTFRJU0lNX05PVF9TVVBQT1JURURfQllfQ0FSUklFUn0gaW4gdGhlIGRldmljZSBzdXBwb3J0cyBtdWx0aXBsZSBTSU1zLCBidXQgdGhlCiAgICAgKiBmdW5jdGlvbmFsaXR5IGlzIHJlc3RyaWN0ZWQgYnkgdGhlIGNhcnJpZXIuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgQElzTXVsdGlTaW1TdXBwb3J0ZWRSZXN1bHQKICAgIHB1YmxpYyBpbnQgaXNNdWx0aVNpbVN1cHBvcnRlZCgpIHsKICAgICAgICBpZiAoZ2V0U3VwcG9ydGVkTW9kZW1Db3VudCgpIDwgMikgewogICAgICAgICAgICByZXR1cm4gVGVsZXBob255TWFuYWdlci5NVUxUSVNJTV9OT1RfU1VQUE9SVEVEX0JZX0hBUkRXQVJFOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmlzTXVsdGlTaW1TdXBwb3J0ZWQoZ2V0T3BQYWNrYWdlTmFtZSgpLCBnZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgImlzTXVsdGlTaW1TdXBwb3J0ZWQgUmVtb3RlRXhjZXB0aW9uIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNVUxUSVNJTV9OT1RfU1VQUE9SVEVEX0JZX0hBUkRXQVJFOwogICAgfQoKICAgIC8qKgogICAgICogU3dpdGNoIGNvbmZpZ3MgdG8gZW5hYmxlIG11bHRpLXNpbSBvciBzd2l0Y2ggYmFjayB0byBzaW5nbGUtc2ltCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOgogICAgICoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEUgTU9ESUZZX1BIT05FX1NUQVRFfSBvciB0aGF0IHRoZQogICAgICogY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlIHtAbGluayAjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBOb3RlOiB3aXRoIG9ubHkgY2FycmllciBwcml2aWxlZ2VzLCBpdCBpcyBub3QgYWxsb3dlZCB0byBzd2l0Y2ggZnJvbSBtdWx0aS1zaW0KICAgICAqIHRvIHNpbmdsZS1zaW0KICAgICAqCiAgICAgKiBAcGFyYW0gbnVtT2ZTaW1zIG51bWJlciBvZiBsaXZlIFNJTXMgd2Ugd2FudCB0byBzd2l0Y2ggdG8KICAgICAqIEB0aHJvd3MgYW5kcm9pZC5vcy5SZW1vdGVFeGNlcHRpb24KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHN3aXRjaE11bHRpU2ltQ29uZmlnKGludCBudW1PZlNpbXMpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0ZWxlcGhvbnkuc3dpdGNoTXVsdGlTaW1Db25maWcobnVtT2ZTaW1zKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic3dpdGNoTXVsdGlTaW1Db25maWcgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB3aGV0aGVyIG1ha2luZyBjaGFuZ2VzIHRvIG1vZGVtIGNvbmZpZ3VyYXRpb25zIGJ5IHtAbGluayAjc3dpdGNoTXVsdGlTaW1Db25maWcoaW50KX0gd2lsbAogICAgICogdHJpZ2dlciBkZXZpY2UgcmVib290LgogICAgICogVGhlIG1vZGVtIGNvbmZpZ3VyYXRpb24gY2hhbmdlIHJlZmVycyB0byBzd2l0Y2hpbmcgZnJvbSBzaW5nbGUgU0lNIGNvbmZpZ3VyYXRpb24gdG8gRFNEUwogICAgICogb3IgdGhlIG90aGVyIHdheSBhcm91bmQuCiAgICAgKgogICAgICogIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0gb3IgdGhhdCB0aGUKICAgICAqIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZSB7QGxpbmsgI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgcmVib290IHdpbGwgYmUgdHJpZ2dlcmVkIGFmdGVyIG1ha2luZyBjaGFuZ2VzIHRvIG1vZGVtCiAgICAgKiBjb25maWd1cmF0aW9ucywgb3RoZXJ3aXNlIHJldHVybiB7QGNvZGUgZmFsc2V9LgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGRvZXNTd2l0Y2hNdWx0aVNpbUNvbmZpZ1RyaWdnZXJSZWJvb3QoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5kb2VzU3dpdGNoTXVsdGlTaW1Db25maWdUcmlnZ2VyUmVib290KGdldFN1YklkKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGdldE9wUGFja2FnZU5hbWUoKSwgZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJkb2VzU3dpdGNoTXVsdGlTaW1Db25maWdUcmlnZ2VyUmVib290IFJlbW90ZUV4Y2VwdGlvbiIsIGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXRyaWV2ZSB0aGUgUmFkaW8gSEFMIFZlcnNpb24gZm9yIHRoaXMgZGV2aWNlLgogICAgICoKICAgICAqIEdldCB0aGUgSEFMIHZlcnNpb24gZm9yIHRoZSBJUmFkaW8gaW50ZXJmYWNlIGZvciB0ZXN0IHB1cnBvc2VzLgogICAgICoKICAgICAqIEByZXR1cm4gYSBQYWlyIG9mIChtYWpvciB2ZXJzaW9uLCBtaW5vciB2ZXJzaW9uKSBvciAoLTEsLTEpIGlmIHVua25vd24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgUGFpcjxJbnRlZ2VyLCBJbnRlZ2VyPiBnZXRSYWRpb0hhbFZlcnNpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnQgdmVyc2lvbiA9IHNlcnZpY2UuZ2V0UmFkaW9IYWxWZXJzaW9uKCk7CiAgICAgICAgICAgICAgICBpZiAodmVyc2lvbiA9PSAtMSkgcmV0dXJuIG5ldyBQYWlyPEludGVnZXIsIEludGVnZXI+KC0xLCAtMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFBhaXI8SW50ZWdlciwgSW50ZWdlcj4odmVyc2lvbiAvIDEwMCwgdmVyc2lvbiAlIDEwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJnZXRSYWRpb0hhbFZlcnNpb24oKSBSZW1vdGVFeGNlcHRpb24iLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBQYWlyPEludGVnZXIsIEludGVnZXI+KC0xLCAtMSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNhbGxpbmcgYXBwbGljYXRpb24gc3RhdHVzIGFib3V0IGNhcnJpZXIgcHJpdmlsZWdlcyBmb3IgdGhlIHN1YnNjcmlwdGlvbiBjcmVhdGVkCiAgICAgKiBpbiBUZWxlcGhvbnlNYW5hZ2VyLiBVc2VkIGJ5IFRlbGVwaG9ueSBNb2R1bGUgZm9yIHBlcm1pc3Npb24gY2hlY2tpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHVpZCBVaWQgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJuIGFueSB2YWx1ZSBvZiB7QGxpbmsgI0NBUlJJRVJfUFJJVklMRUdFX1NUQVRVU19IQVNfQUNDRVNTfSwKICAgICAqICAgICAgICAge0BsaW5rICNDQVJSSUVSX1BSSVZJTEVHRV9TVEFUVVNfTk9fQUNDRVNTfSwKICAgICAqICAgICAgICAge0BsaW5rICNDQVJSSUVSX1BSSVZJTEVHRV9TVEFUVVNfUlVMRVNfTk9UX0xPQURFRH0sIG9yCiAgICAgKiAgICAgICAgIHtAbGluayAjQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX0VSUk9SX0xPQURJTkdfUlVMRVN9CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBDYXJyaWVyUHJpdmlsZWdlU3RhdHVzIGludCBnZXRDYXJyaWVyUHJpdmlsZWdlU3RhdHVzKGludCB1aWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmdldENhcnJpZXJQcml2aWxlZ2VTdGF0dXNGb3JVaWQoZ2V0U3ViSWQoKSwgdWlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBMb2cuZShUQUcsICJnZXRDYXJyaWVyUHJpdmlsZWdlU3RhdHVzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFRlbGVwaG9ueU1hbmFnZXIuQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX05PX0FDQ0VTUzsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBsaXN0IG9mIEFQTnMgc2V0IGFzIG92ZXJyaWRlcyBieSB0aGUgZGV2aWNlIHBvbGljeSBtYW5hZ2VyIHZpYQogICAgICoge0BsaW5rICNhZGREZXZpY2VQb2xpY3lPdmVycmlkZUFwbn0uCiAgICAgKiBUaGlzIG1ldGhvZCBtdXN0IG9ubHkgYmUgY2FsbGVkIGZyb20gdGhlIHN5c3RlbSBvciBwaG9uZSBwcm9jZXNzZXMuCiAgICAgKgogICAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCB0byB1c2UuCiAgICAgKiBAcmV0dXJuIHtAbGluayBMaXN0fSBvZiBBUE5zIHRoYXQgaGF2ZSBiZWVuIHNldCBhcyBvdmVycmlkZXMuCiAgICAgKiBAdGhyb3dzIHtAbGluayBTZWN1cml0eUV4Y2VwdGlvbn0gaWYgdGhlIGNhbGxlciBpcyBub3QgdGhlIHN5c3RlbSBvciBwaG9uZSBwcm9jZXNzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFRlc3RBcGkKICAgIC8vIFRPRE86IGFkZCBuZXcgcGVybWlzc2lvbiB0YWcgaW5kaWNhdGluZyB0aGF0IHRoaXMgaXMgc3lzdGVtLW9ubHkuCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxBcG5TZXR0aW5nPiBnZXREZXZpY2VQb2xpY3lPdmVycmlkZUFwbnMoQE5vbk51bGwgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgdHJ5IChDdXJzb3IgY3Vyc29yID0gY29udGV4dC5nZXRDb250ZW50UmVzb2x2ZXIoKS5xdWVyeShEUENfVVJJLCBudWxsLCBudWxsLCBudWxsLCBudWxsKSkgewogICAgICAgICAgICBpZiAoY3Vyc29yID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBDb2xsZWN0aW9ucy5lbXB0eUxpc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBMaXN0PEFwblNldHRpbmc+IGFwbkxpc3QgPSBuZXcgQXJyYXlMaXN0PEFwblNldHRpbmc+KCk7CiAgICAgICAgICAgIGN1cnNvci5tb3ZlVG9Qb3NpdGlvbigtMSk7CiAgICAgICAgICAgIHdoaWxlIChjdXJzb3IubW92ZVRvTmV4dCgpKSB7CiAgICAgICAgICAgICAgICBBcG5TZXR0aW5nIGFwbiA9IEFwblNldHRpbmcubWFrZUFwblNldHRpbmcoY3Vyc29yKTsKICAgICAgICAgICAgICAgIGFwbkxpc3QuYWRkKGFwbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFwbkxpc3Q7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSB0aGUgZGV2aWNlIHBvbGljeSBtYW5hZ2VyIHRvIGFkZCBhIG5ldyBvdmVycmlkZSBBUE4uCiAgICAgKiBUaGlzIG1ldGhvZCBtdXN0IG9ubHkgYmUgY2FsbGVkIGZyb20gdGhlIHN5c3RlbSBvciBwaG9uZSBwcm9jZXNzZXMuCiAgICAgKgogICAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCB0byB1c2UuCiAgICAgKiBAcGFyYW0gYXBuU2V0dGluZyBUaGUge0BsaW5rIEFwblNldHRpbmd9IGRlc2NyaWJpbmcgdGhlIG5ldyBBUE4uCiAgICAgKiBAcmV0dXJuIEFuIGludGVnZXIsIGNvcnJlc3BvbmRpbmcgdG8gYSBwcmltYXJ5IGtleSBpbiBhIGRhdGFiYXNlLCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvCiAgICAgKiAgICAgICAgIG1vZGlmeSB0aGUgQVBOIGluIHRoZSBmdXR1cmUgdmlhIHtAbGluayAjbW9kaWZ5RGV2aWNlUG9saWN5T3ZlcnJpZGVBcG59LCBvcgogICAgICogICAgICAgICB7QGxpbmsgYW5kcm9pZC5wcm92aWRlci5UZWxlcGhvbnkuQ2FycmllcnMuSU5WQUxJRF9BUE5fSUR9IGlmIHRoZSBvdmVycmlkZSBvcGVyYXRpb24KICAgICAqICAgICAgICAgZmFpbGVkLgogICAgICogQHRocm93cyB7QGxpbmsgU2VjdXJpdHlFeGNlcHRpb259IGlmIHRoZSBjYWxsZXIgaXMgbm90IHRoZSBzeXN0ZW0gb3IgcGhvbmUgcHJvY2Vzcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBUZXN0QXBpCiAgICAvLyBUT0RPOiBhZGQgbmV3IHBlcm1pc3Npb24gdGFnIGluZGljYXRpbmcgdGhhdCB0aGlzIGlzIHN5c3RlbS1vbmx5LgogICAgcHVibGljIGludCBhZGREZXZpY2VQb2xpY3lPdmVycmlkZUFwbihATm9uTnVsbCBDb250ZXh0IGNvbnRleHQsCiAgICAgICAgICAgIEBOb25OdWxsIEFwblNldHRpbmcgYXBuU2V0dGluZykgewogICAgICAgIFVyaSByZXN1bHRVcmkgPSBjb250ZXh0LmdldENvbnRlbnRSZXNvbHZlcigpLmluc2VydChEUENfVVJJLCBhcG5TZXR0aW5nLnRvQ29udGVudFZhbHVlcygpKTsKCiAgICAgICAgaW50IHJlc3VsdElkID0gSU5WQUxJRF9BUE5fSUQ7CiAgICAgICAgaWYgKHJlc3VsdFVyaSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHRJZCA9IEludGVnZXIucGFyc2VJbnQocmVzdWx0VXJpLmdldExhc3RQYXRoU2VnbWVudCgpKTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgICAgIFJsb2cuZShUQUcsICJGYWlsZWQgdG8gcGFyc2UgaW5zZXJ0ZWQgb3ZlcnJpZGUgQVBOIGlkOiAiCiAgICAgICAgICAgICAgICAgICAgICAgICsgcmVzdWx0VXJpLmdldExhc3RQYXRoU2VnbWVudCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0SWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIGJ5IHRoZSBkZXZpY2UgcG9saWN5IG1hbmFnZXIgdG8gbW9kaWZ5IGFuIG92ZXJyaWRlIEFQTi4KICAgICAqIFRoaXMgbWV0aG9kIG11c3Qgb25seSBiZSBjYWxsZWQgZnJvbSB0aGUgc3lzdGVtIG9yIHBob25lIHByb2Nlc3Nlcy4KICAgICAqCiAgICAgKiBAcGFyYW0gY29udGV4dCBDb250ZXh0IHRvIHVzZS4KICAgICAqIEBwYXJhbSBhcG5JZCBUaGUgaW50ZWdlciBrZXkgb2YgdGhlIEFQTiB0byBtb2RpZnksIGFzIHJldHVybmVkIGJ5CiAgICAgKiAgICAgICAgICAgICAge0BsaW5rICNhZGREZXZpY2VQb2xpY3lPdmVycmlkZUFwbn0KICAgICAqIEBwYXJhbSBhcG5TZXR0aW5nIFRoZSB7QGxpbmsgQXBuU2V0dGluZ30gZGVzY3JpYmluZyB0aGUgdXBkYXRlZCBBUE4uCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBzdWNjZXNzZnVsLCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqIEB0aHJvd3Mge0BsaW5rIFNlY3VyaXR5RXhjZXB0aW9ufSBpZiB0aGUgY2FsbGVyIGlzIG5vdCB0aGUgc3lzdGVtIG9yIHBob25lIHByb2Nlc3MuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVGVzdEFwaQogICAgLy8gVE9ETzogYWRkIG5ldyBwZXJtaXNzaW9uIHRhZyBpbmRpY2F0aW5nIHRoYXQgdGhpcyBpcyBzeXN0ZW0tb25seS4KICAgIHB1YmxpYyBib29sZWFuIG1vZGlmeURldmljZVBvbGljeU92ZXJyaWRlQXBuKEBOb25OdWxsIENvbnRleHQgY29udGV4dCwgaW50IGFwbklkLAogICAgICAgICAgICBATm9uTnVsbCBBcG5TZXR0aW5nIGFwblNldHRpbmcpIHsKICAgICAgICByZXR1cm4gY29udGV4dC5nZXRDb250ZW50UmVzb2x2ZXIoKS51cGRhdGUoCiAgICAgICAgICAgICAgICBVcmkud2l0aEFwcGVuZGVkUGF0aChEUENfVVJJLCBJbnRlZ2VyLnRvU3RyaW5nKGFwbklkKSksCiAgICAgICAgICAgICAgICBhcG5TZXR0aW5nLnRvQ29udGVudFZhbHVlcygpLCBudWxsLCBudWxsKSA+IDA7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gd2hldGhlciBkYXRhIGlzIGVuYWJsZWQgZm9yIGNlcnRhaW4gQVBOIHR5cGUuIFRoaXMgd2lsbCB0ZWxsIGlmIGZyYW1ld29yayB3aWxsIGFjY2VwdAogICAgICogY29ycmVzcG9uZGluZyBuZXR3b3JrIHJlcXVlc3RzIG9uIGEgc3ViSWQuCiAgICAgKgogICAgICoge0BsaW5rICNpc0RhdGFFbmFibGVkKCl9IGlzIGRpcmVjdGx5IGFzc29jaWF0ZWQgd2l0aCB1c2VycycgTW9iaWxlIGRhdGEgdG9nZ2xlIG9uIC8gb2ZmLiBJZgogICAgICoge0BsaW5rICNpc0RhdGFFbmFibGVkKCl9IHJldHVybnMgZmFsc2UsIGl0IG1lYW5zIGluIGdlbmVyYWwgYWxsIG1ldGVyLWVkIGRhdGEgYXJlIGRpc2FibGVkLgogICAgICoKICAgICAqIFRoaXMgcGVyIEFQTiB0eXBlIEFQSSBnaXZlcyBhIGJldHRlciBpZGVhIHdoZXRoZXIgZGF0YSBpcyBhbGxvd2VkIG9uIGEgc3BlY2lmaWMgQVBOIHR5cGUuCiAgICAgKiBJdCB3aWxsIHJldHVybiB0cnVlIGlmOgogICAgICoKICAgICAqICAxKSBVc2VyIGRhdGEgaXMgdHVybmVkIG9uLCBvcgogICAgICogIDIpIEFQTiBpcyB1bi1tZXRlcmVkIGZvciB0aGlzIHN1YnNjcmlwdGlvbiwgb3IKICAgICAqICAzKSBBUE4gdHlwZSBpcyB3aGl0ZWxpc3RlZC4gRS5nLiBNTVMgaXMgd2hpdGVsaXN0ZWQgaWYKICAgICAqICB7QGxpbmsgI3NldEFsd2F5c0FsbG93TW1zRGF0YShib29sZWFuKX0gaXMgdHVybmVkIG9uLgogICAgICoKICAgICAqIEBwYXJhbSBhcG5UeXBlIFZhbHVlIGluZGljYXRpbmcgdGhlIGFwbiB0eXBlLiBBcG4gdHlwZXMgYXJlIGRlZmluZWQgaW4ge0BsaW5rIEFwblNldHRpbmd9LgogICAgICogQHJldHVybiB3aGV0aGVyIGRhdGEgaXMgZW5hYmxlZCBmb3IgYSBhcG4gdHlwZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0RhdGFFbmFibGVkRm9yQXBuKEBBcG5UeXBlIGludCBhcG5UeXBlKSB7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuaXNEYXRhRW5hYmxlZEZvckFwbihhcG5UeXBlLCBnZXRTdWJJZCgpLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZXRoZXIgYW4gQVBOIHR5cGUgaXMgbWV0ZXJlZCBvciBub3QuIEl0IHdpbGwgYmUgZXZhbHVhdGVkIHdpdGggdGhlIHN1YklkIGFzc29jaWF0ZWQKICAgICAqIHdpdGggdGhlIFRlbGVwaG9ueU1hbmFnZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaXNBcG5NZXRlcmVkKEBBcG5UeXBlIGludCBhcG5UeXBlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5pc0Fwbk1ldGVyZWQoYXBuVHlwZSwgZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogU3BlY2lmeSB3aGljaCBiYW5kcyBtb2RlbSdzIGJhY2tncm91bmQgc2NhbiBtdXN0IGFjdCBvbi4KICAgICAqIElmIHtAY29kZSBzcGVjaWZpZXJzfSBpcyBub24tZW1wdHksIHRoZSBzY2FuIHdpbGwgYmUgcmVzdHJpY3RlZCB0byB0aGUgYmFuZHMgc3BlY2lmaWVkLgogICAgICogT3RoZXJ3aXNlLCBpdCBzY2FucyBhbGwgYmFuZHMuCiAgICAgKgogICAgICogRm9yIGV4YW1wbGUsIENCUlMgaXMgb25seSBvbiBMVEUgYmFuZCA0OC4gQnkgc3BlY2lmeWluZyB0aGlzIGJhbmQsCiAgICAgKiBtb2RlbSBzYXZlcyBtb3JlIHBvd2VyLgogICAgICoKICAgICAqIEBwYXJhbSBzcGVjaWZpZXJzIHdoaWNoIGJhbmRzIHRvIHNjYW4uCiAgICAgKiBAcGFyYW0gZXhlY3V0b3IgVGhlIGV4ZWN1dG9yIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrIG9uCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRoYXQgZ2V0cyBpbnZva2VkIHdoZW4gdGhlIHJhZGlvIHJlc3BvbmRzIHRvIHRoZSByZXF1ZXN0LiBDYWxsZWQKICAgICAqICAgICAgICAgICAgICAgICB3aXRoIHtAY29kZSB0cnVlfSBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkZWQsIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFRlc3RBcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFN5c3RlbVNlbGVjdGlvbkNoYW5uZWxzKEBOb25OdWxsIExpc3Q8UmFkaW9BY2Nlc3NTcGVjaWZpZXI+IHNwZWNpZmllcnMsCiAgICAgICAgICAgIEBOb25OdWxsIEBDYWxsYmFja0V4ZWN1dG9yIEV4ZWN1dG9yIGV4ZWN1dG9yLAogICAgICAgICAgICBATm9uTnVsbCBDb25zdW1lcjxCb29sZWFuPiBjYWxsYmFjaykgewogICAgICAgIE9iamVjdHMucmVxdWlyZU5vbk51bGwoc3BlY2lmaWVycywgIlNwZWNpZmllcnMgbXVzdCBub3QgYmUgbnVsbC4iKTsKICAgICAgICBPYmplY3RzLnJlcXVpcmVOb25OdWxsKGV4ZWN1dG9yLCAiRXhlY3V0b3IgbXVzdCBub3QgYmUgbnVsbC4iKTsKICAgICAgICBPYmplY3RzLnJlcXVpcmVOb25OdWxsKGNhbGxiYWNrLCAiQ2FsbGJhY2sgbXVzdCBub3QgYmUgbnVsbC4iKTsKICAgICAgICBzZXRTeXN0ZW1TZWxlY3Rpb25DaGFubmVsc0ludGVybmFsKHNwZWNpZmllcnMsIGV4ZWN1dG9yLCBjYWxsYmFjayk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTYW1lIGFzIHtAbGluayAjc2V0U3lzdGVtU2VsZWN0aW9uQ2hhbm5lbHMoTGlzdCwgRXhlY3V0b3IsIENvbnN1bWVyPEJvb2xlYW4+KX0sIGJ1dCB0byBiZQogICAgICogdXNlZCB3aGVuIHRoZSBjYWxsZXIgZG9lcyBub3QgbmVlZCBmZWVkYmFjayBvbiB0aGUgcmVzdWx0cyBvZiB0aGUgb3BlcmF0aW9uLgogICAgICogQHBhcmFtIHNwZWNpZmllcnMgd2hpY2ggYmFuZHMgdG8gc2Nhbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRTeXN0ZW1TZWxlY3Rpb25DaGFubmVscyhATm9uTnVsbCBMaXN0PFJhZGlvQWNjZXNzU3BlY2lmaWVyPiBzcGVjaWZpZXJzKSB7CiAgICAgICAgT2JqZWN0cy5yZXF1aXJlTm9uTnVsbChzcGVjaWZpZXJzLCAiU3BlY2lmaWVycyBtdXN0IG5vdCBiZSBudWxsLiIpOwogICAgICAgIHNldFN5c3RlbVNlbGVjdGlvbkNoYW5uZWxzSW50ZXJuYWwoc3BlY2lmaWVycywgbnVsbCwgbnVsbCk7CiAgICB9CgoKICAgIHByaXZhdGUgdm9pZCBzZXRTeXN0ZW1TZWxlY3Rpb25DaGFubmVsc0ludGVybmFsKEBOb25OdWxsIExpc3Q8UmFkaW9BY2Nlc3NTcGVjaWZpZXI+IHNwZWNpZmllcnMsCiAgICAgICAgICAgIEBOdWxsYWJsZSBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE51bGxhYmxlIENvbnN1bWVyPEJvb2xlYW4+IGNhbGxiYWNrKSB7CiAgICAgICAgSUJvb2xlYW5Db25zdW1lciBhaWRsQ29uc3VtZXIgPSBjYWxsYmFjayA9PSBudWxsID8gbnVsbCA6IG5ldyBJQm9vbGVhbkNvbnN1bWVyLlN0dWIoKSB7CiAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICBwdWJsaWMgdm9pZCBhY2NlcHQoYm9vbGVhbiByZXN1bHQpIHsKICAgICAgICAgICAgICAgIGV4ZWN1dG9yLmV4ZWN1dGUoKCkgLT4gY2FsbGJhY2suYWNjZXB0KHJlc3VsdCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXJ2aWNlLnNldFN5c3RlbVNlbGVjdGlvbkNoYW5uZWxzKHNwZWNpZmllcnMsIGdldFN1YklkKCksIGFpZGxDb25zdW1lcik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVmVyaWZpZXMgd2hldGhlciB0aGUgaW5wdXQgTUNDL01OQyBhbmQgTVZOTyBjb3JyZXNwb25kIHRvIHRoZSBjdXJyZW50IGNhcnJpZXIuCiAgICAgKgogICAgICogQHBhcmFtIG1jY21uYyB0aGUgY2FycmllcidzIG1jY21uYyB0aGF0IHlvdSB3YW50IHRvIG1hdGNoCiAgICAgKiBAcGFyYW0gbXZub1R5cGUgdGhlIG12bm9UeXBlIHRoYXQgZGVmaW5lZCBpbiB7QGxpbmsgQXBuU2V0dGluZ30KICAgICAqIEBwYXJhbSBtdm5vTWF0Y2hEYXRhIHRoZSBNVk5PIG1hdGNoIGRhdGEKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIGlucHV0IG1jY21uYyBhbmQgbXZubyBtYXRjaGVzIHdpdGggZGF0YSBmcm9tIHNpbSBvcGVyYXRvci4KICAgICAqIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICoKICAgICAqIHtAaGlkZX0KICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gbWF0Y2hlc0N1cnJlbnRTaW1PcGVyYXRvcihATm9uTnVsbCBTdHJpbmcgbWNjbW5jLCBATXZub1R5cGUgaW50IG12bm9UeXBlLAogICAgICAgICAgICBATnVsbGFibGUgU3RyaW5nIG12bm9NYXRjaERhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIW1jY21uYy5lcXVhbHMoZ2V0U2ltT3BlcmF0b3IoKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZXJ2aWNlLmlzTXZub01hdGNoZWQoZ2V0U3ViSWQoKSwgbXZub1R5cGUsIG12bm9NYXRjaERhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSB2b2ljZSBjYWxsIGZvcndhcmRpbmcgaW5mbyB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvfSwgZ2l2ZW4gdGhlIGNhbGwgZm9yd2FyZAogICAgICogcmVhc29uLgogICAgICoKICAgICAqIEBwYXJhbSBjYWxsRm9yd2FyZGluZ1JlYXNvbiB0aGUgY2FsbCBmb3J3YXJkaW5nIHJlYXNvbnMKICAgICAqCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBjYWxsRm9yd2FyZGluZ1JlYXNvbiBpcyBub3QgYW55IG9mCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvLlJFQVNPTl9VTkNPTkRJVElPTkFMfSwge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQlVTWX0sCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvLlJFQVNPTl9OT19SRVBMWX0sIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8uUkVBU09OX05PVF9SRUFDSEFCTEV9LAogICAgICoge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQUxMfSwge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQUxMX0NPTkRJVElPTkFMfQogICAgICoKICAgICAqIEByZXR1cm4ge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mb30gd2l0aCB0aGUgc3RhdHVzIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8jU1RBVFVTX0FDVElWRX0KICAgICAqIG9yIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8jU1RBVFVTX0lOQUNUSVZFfSBhbmQgdGhlIHRhcmdldCBwaG9uZSBudW1iZXIgdG8gZm9yd2FyZCBjYWxscwogICAgICogdG8sIGlmIGl0J3MgYXZhaWxhYmxlLiBPdGhlcndpc2UsIGl0IHdpbGwgcmV0dXJuIGEge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mb30gd2l0aCBzdGF0dXMKICAgICAqIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8jU1RBVFVTX1VOS05PV05fRVJST1J9LAogICAgICoge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mbyNTVEFUVVNfTk9UX1NVUFBPUlRFRH0sCiAgICAgKiBvciB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI1NUQVRVU19GRE5fQ0hFQ0tfRkFJTFVSRX0gZGVwZW5kaW5nIG9uIHRoZSBzaXR1YXRpb24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBDYWxsRm9yd2FyZGluZ0luZm8gZ2V0Q2FsbEZvcndhcmRpbmcoQENhbGxGb3J3YXJkaW5nUmVhc29uIGludCBjYWxsRm9yd2FyZGluZ1JlYXNvbikgewogICAgICAgIGlmIChjYWxsRm9yd2FyZGluZ1JlYXNvbiA8IENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fVU5DT05ESVRJT05BTAogICAgICAgICAgICAgICAgfHwgY2FsbEZvcndhcmRpbmdSZWFzb24gPiBDYWxsRm9yd2FyZGluZ0luZm8uUkVBU09OX0FMTF9DT05ESVRJT05BTCkgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJjYWxsRm9yd2FyZGluZ1JlYXNvbiBpcyBvdXQgb2YgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5nZXRDYWxsRm9yd2FyZGluZyhnZXRTdWJJZCgpLCBjYWxsRm9yd2FyZGluZ1JlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldENhbGxGb3J3YXJkaW5nIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0Q2FsbEZvcndhcmRpbmcgTlBFIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IENhbGxGb3J3YXJkaW5nSW5mbygKICAgICAgICAgICAgICAgIENhbGxGb3J3YXJkaW5nSW5mby5TVEFUVVNfVU5LTk9XTl9FUlJPUiwgMCAvKiByZWFzb24gKi8sIG51bGwgLyogbnVtYmVyICovLAogICAgICAgICAgICAgICAgICAgICAgICAwIC8qIHRpbWVvdXQgKi8pOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgdm9pY2UgY2FsbCBmb3J3YXJkaW5nIGluZm8gaW5jbHVkaW5nIHN0YXR1cyAoZW5hYmxlL2Rpc2FibGUpLCBjYWxsIGZvcndhcmRpbmcKICAgICAqIHJlYXNvbiwgdGhlIG51bWJlciB0byBmb3J3YXJkLCBhbmQgdGhlIHRpbWVvdXQgYmVmb3JlIHRoZSBmb3J3YXJkaW5nIGlzIGF0dGVtcHRlZC4KICAgICAqCiAgICAgKiBAcGFyYW0gY2FsbEZvcndhcmRpbmdJbmZvIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm99IHRvIHNldHVwIHRoZSBjYWxsIGZvcndhcmRpbmcuCiAgICAgKiBFbmFibGluZyBpZiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI2dldFN0YXR1cygpfSByZXR1cm5zCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI1NUQVRVU19BQ1RJVkV9OyBEaXNhYmxpbmcgaWYKICAgICAqIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8jZ2V0U3RhdHVzKCl9IHJldHVybnMge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mbyNTVEFUVVNfSU5BQ1RJVkV9LgogICAgICoKICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIGFueSBvZiB0aGUgZm9sbG93aW5nIGZvciBwYXJhbWV0ZXIgY2FsbEZvcndhcmRpbmdJbmZvOgogICAgICogMCkgaXQgaXMge0Bjb2RlIG51bGx9LgogICAgICogMSkge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mbyNnZXRTdGF0dXMoKX0gcmV0dXJucyBuZWl0aGVyCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI1NUQVRVU19BQ1RJVkV9IG5vciB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI1NUQVRVU19JTkFDVElWRX0uCiAgICAgKiAyKSB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI2dldFJlYXNvbigpfSBpcyBub3QgYW55IG9mCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvLlJFQVNPTl9VTkNPTkRJVElPTkFMfSwge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQlVTWX0sCiAgICAgKiB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvLlJFQVNPTl9OT19SRVBMWX0sIHtAbGluayBDYWxsRm9yd2FyZGluZ0luZm8uUkVBU09OX05PVF9SRUFDSEFCTEV9LAogICAgICoge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQUxMfSwge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fQUxMX0NPTkRJVElPTkFMfQogICAgICogMykge0BsaW5rIENhbGxGb3J3YXJkaW5nSW5mbyNnZXROdW1iZXIoKX0gcmV0dXJucyB7QGNvZGUgbnVsbH0uCiAgICAgKiA0KSB7QGxpbmsgQ2FsbEZvcndhcmRpbmdJbmZvI2dldFRpbWVvdXRTZWNvbmRzKCl9IGRvZXNuJ3QgcmV0dXJuIGEgcG9zaXRpdmUgdmFsdWUuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gdG8gaW5kaWNhdGUgaXQgd2FzIHNldCBzdWNjZXNzZnVsbHk7IHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldENhbGxGb3J3YXJkaW5nKEBOb25OdWxsIENhbGxGb3J3YXJkaW5nSW5mbyBjYWxsRm9yd2FyZGluZ0luZm8pIHsKICAgICAgICBpZiAoY2FsbEZvcndhcmRpbmdJbmZvID09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigiY2FsbEZvcndhcmRpbmdJbmZvIGlzIG51bGwiKTsKICAgICAgICB9CiAgICAgICAgaW50IGNhbGxGb3J3YXJkaW5nU3RhdHVzID0gY2FsbEZvcndhcmRpbmdJbmZvLmdldFN0YXR1cygpOwogICAgICAgIGlmIChjYWxsRm9yd2FyZGluZ1N0YXR1cyAhPSBDYWxsRm9yd2FyZGluZ0luZm8uU1RBVFVTX0FDVElWRQogICAgICAgICAgICAgICAgJiYgY2FsbEZvcndhcmRpbmdTdGF0dXMgIT0gQ2FsbEZvcndhcmRpbmdJbmZvLlNUQVRVU19JTkFDVElWRSkgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKAogICAgICAgICAgICAgICAgICAgICJjYWxsRm9yd2FyZGluZ1N0YXR1cyBpcyBuZWl0aGVyIGFjdGl2ZSBub3IgaW5hY3RpdmUiKTsKICAgICAgICB9CiAgICAgICAgaW50IGNhbGxGb3J3YXJkaW5nUmVhc29uID0gY2FsbEZvcndhcmRpbmdJbmZvLmdldFJlYXNvbigpOwogICAgICAgIGlmIChjYWxsRm9yd2FyZGluZ1JlYXNvbiA8IENhbGxGb3J3YXJkaW5nSW5mby5SRUFTT05fVU5DT05ESVRJT05BTAogICAgICAgICAgICAgICAgfHwgY2FsbEZvcndhcmRpbmdSZWFzb24gPiBDYWxsRm9yd2FyZGluZ0luZm8uUkVBU09OX0FMTF9DT05ESVRJT05BTCkgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJjYWxsRm9yd2FyZGluZ1JlYXNvbiBpcyBvdXQgb2YgcmFuZ2UiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNhbGxGb3J3YXJkaW5nSW5mby5nZXROdW1iZXIoKSA9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oImNhbGxGb3J3YXJkaW5nIG51bWJlciBpcyBudWxsIik7CiAgICAgICAgfQogICAgICAgIGlmIChjYWxsRm9yd2FyZGluZ0luZm8uZ2V0VGltZW91dFNlY29uZHMoKSA8PSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oImNhbGxGb3J3YXJkaW5nIHRpbWVvdXQgaXNuJ3QgcG9zaXRpdmUiKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmICh0ZWxlcGhvbnkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRlbGVwaG9ueS5zZXRDYWxsRm9yd2FyZGluZyhnZXRTdWJJZCgpLCBjYWxsRm9yd2FyZGluZ0luZm8pOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXRDYWxsRm9yd2FyZGluZyBSZW1vdGVFeGNlcHRpb24iLCBleCk7CiAgICAgICAgfSBjYXRjaCAoTnVsbFBvaW50ZXJFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgInNldENhbGxGb3J3YXJkaW5nIE5QRSIsIGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogSW5kaWNhdGVzIHRoZSBjYWxsIHdhaXRpbmcgc3RhdHVzIGlzIGFjdGl2ZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQUxMX1dBSVRJTkdfU1RBVFVTX0FDVElWRSA9IDE7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgdGhlIGNhbGwgd2FpdGluZyBzdGF0dXMgaXMgaW5hY3RpdmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FMTF9XQUlUSU5HX1NUQVRVU19JTkFDVElWRSA9IDI7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgdGhlIGNhbGwgd2FpdGluZyBzdGF0dXMgaXMgd2l0aCBhbiB1bmtub3duIGVycm9yLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENBTExfV0FJVElOR19TVEFUVVNfVU5LTk9XTl9FUlJPUiA9IDM7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgdGhlIGNhbGwgd2FpdGluZyBpcyBub3Qgc3VwcG9ydGVkIChlLmcuIGNhbGxlZCB2aWEgQ0RNQSkuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FMTF9XQUlUSU5HX1NUQVRVU19OT1RfU1VQUE9SVEVEID0gNDsKCiAgICAvKioKICAgICAqIENhbGwgd2FpdGluZyBmdW5jdGlvbiBzdGF0dXMKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBASW50RGVmKHByZWZpeCA9IHsgIkNBTExfV0FJVElOR19TVEFUVVNfIiB9LCB2YWx1ZSA9IHsKICAgICAgICBDQUxMX1dBSVRJTkdfU1RBVFVTX0FDVElWRSwKICAgICAgICBDQUxMX1dBSVRJTkdfU1RBVFVTX0lOQUNUSVZFLAogICAgICAgIENBTExfV0FJVElOR19TVEFUVVNfTk9UX1NVUFBPUlRFRCwKICAgICAgICBDQUxMX1dBSVRJTkdfU1RBVFVTX1VOS05PV05fRVJST1IKICAgIH0pCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBwdWJsaWMgQGludGVyZmFjZSBDYWxsV2FpdGluZ1N0YXR1cyB7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBzdGF0dXMgb2Ygdm9pY2UgY2FsbCB3YWl0aW5nIGZ1bmN0aW9uLiBDYWxsIHdhaXRpbmcgZnVuY3Rpb24gZW5hYmxlcyB0aGUgd2FpdGluZwogICAgICogZm9yIHRoZSBpbmNvbWluZyBjYWxsIHdoZW4gaXQgcmVhY2hlcyB0aGUgdXNlciB3aG8gaXMgYnVzeSB0byBtYWtlIGFub3RoZXIgY2FsbCBhbmQgYWxsb3dzCiAgICAgKiB1c2VycyB0byBkZWNpZGUgd2hldGhlciB0byBzd2l0Y2ggdG8gdGhlIGluY29taW5nIGNhbGwuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgc3RhdHVzIG9mIGNhbGwgd2FpdGluZyBmdW5jdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBAQ2FsbFdhaXRpbmdTdGF0dXMgaW50IGdldENhbGxXYWl0aW5nU3RhdHVzKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuZ2V0Q2FsbFdhaXRpbmdTdGF0dXMoZ2V0U3ViSWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgUmxvZy5lKFRBRywgImdldENhbGxXYWl0aW5nU3RhdHVzIFJlbW90ZUV4Y2VwdGlvbiIsIGV4KTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAiZ2V0Q2FsbFdhaXRpbmdTdGF0dXMgTlBFIiwgZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ0FMTF9XQUlUSU5HX1NUQVRVU19VTktOT1dOX0VSUk9SOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgc3RhdHVzIGZvciB2b2ljZSBjYWxsIHdhaXRpbmcgZnVuY3Rpb24uIENhbGwgd2FpdGluZyBmdW5jdGlvbiBlbmFibGVzIHRoZSB3YWl0aW5nCiAgICAgKiBmb3IgdGhlIGluY29taW5nIGNhbGwgd2hlbiBpdCByZWFjaGVzIHRoZSB1c2VyIHdobyBpcyBidXN5IHRvIG1ha2UgYW5vdGhlciBjYWxsIGFuZCBhbGxvd3MKICAgICAqIHVzZXJzIHRvIGRlY2lkZSB3aGV0aGVyIHRvIHN3aXRjaCB0byB0aGUgaW5jb21pbmcgY2FsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gaXNFbmFibGUge0Bjb2RlIHRydWV9IHRvIGVuYWJsZTsge0Bjb2RlIGZhbHNlfSB0byBkaXNhYmxlLgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gdG8gaW5kaWNhdGUgaXQgd2FzIHNldCBzdWNjZXNzZnVsbHk7IHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldENhbGxXYWl0aW5nU3RhdHVzKGJvb2xlYW4gaXNFbmFibGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHRlbGVwaG9ueSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHRlbGVwaG9ueSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVsZXBob255LnNldENhbGxXYWl0aW5nU3RhdHVzKGdldFN1YklkKCksIGlzRW5hYmxlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBSbG9nLmUoVEFHLCAic2V0Q2FsbFdhaXRpbmdTdGF0dXMgUmVtb3RlRXhjZXB0aW9uIiwgZXgpOwogICAgICAgIH0gY2F0Y2ggKE51bGxQb2ludGVyRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIFJsb2cuZShUQUcsICJzZXRDYWxsV2FpdGluZ1N0YXR1cyBOUEUiLCBleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBhbGxvd2luZyBtb2JpbGUgZGF0YSBkdXJpbmcgdm9pY2UgY2FsbC4gVGhpcyBpcyB1c2VkIGZvciBhbGxvd2luZyBkYXRhIG9uIHRoZSBub24tZGVmYXVsdAogICAgICogZGF0YSBTSU0uIFdoZW4gYSB2b2ljZSBjYWxsIGlzIHBsYWNlZCBvbiB0aGUgbm9uLWRlZmF1bHQgZGF0YSBTSU0gb24gRFNEUyBkZXZpY2VzLCB1c2VycyB3aWxsCiAgICAgKiBub3QgYmUgYWJsZSB0byB1c2UgbW9iaWxlIGRhdGEuIEJ5IGNhbGxpbmcgdGhpcyBBUEksIGRhdGEgd2lsbCBiZSB0ZW1wb3JhcmlseSBlbmFibGVkIG9uIHRoZQogICAgICogbm9uLWRlZmF1bHQgZGF0YSBTSU0gZHVyaW5nIHRoZSBsaWZlIGN5Y2xlIG9mIHRoZSB2b2ljZSBjYWxsLgogICAgICoKICAgICAqIEBwYXJhbSBhbGxvdyB7QGNvZGUgdHJ1ZX0gaWYgYWxsb3dpbmcgdXNpbmcgZGF0YSBkdXJpbmcgdm9pY2UgY2FsbCwge0Bjb2RlIGZhbHNlfSBpZgogICAgICogZGlzYWxsb3dlZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiBvcGVyYXRpb24gaXMgc3VjY2Vzc2Z1bC4gb3RoZXJ3aXNlIHtAY29kZSBmYWxzZX0uCiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXREYXRhQWxsb3dlZER1cmluZ1ZvaWNlQ2FsbChib29sZWFuIGFsbG93KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5zZXREYXRhQWxsb3dlZER1cmluZ1ZvaWNlQ2FsbChnZXRTdWJJZCgpLCBhbGxvdyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gaWYgYmluZGVyIHByb2Nlc3MgY3Jhc2hlcy4KICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrIHdoZXRoZXIgZGF0YSBpcyBhbGxvd2VkIGR1cmluZyB2b2ljZSBjYWxsLiBUaGlzIGlzIHVzZWQgZm9yIGFsbG93aW5nIGRhdGEgb24gdGhlCiAgICAgKiBub24tZGVmYXVsdCBkYXRhIFNJTS4gV2hlbiBhIHZvaWNlIGNhbGwgaXMgcGxhY2VkIG9uIHRoZSBub24tZGVmYXVsdCBkYXRhIFNJTSBvbiBEU0RTCiAgICAgKiBkZXZpY2VzLCB1c2VycyB3aWxsIG5vdCBiZSBhYmxlIHRvIHVzZSBtb2JpbGUgZGF0YS4gQnkgY2FsbGluZyB0aGlzIEFQSSwgZGF0YSB3aWxsIGJlCiAgICAgKiB0ZW1wb3JhcmlseSBlbmFibGVkIG9uIHRoZSBub24tZGVmYXVsdCBkYXRhIFNJTSBkdXJpbmcgdGhlIGxpZmUgY3ljbGUgb2YgdGhlIHZvaWNlIGNhbGwuCiAgICAgKgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgZGF0YSBpcyBhbGxvd2VkIGR1cmluZyB2b2ljZSBjYWxsLgogICAgICoKICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgdGhlIHBlcm1pc3Npb24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaXNEYXRhQWxsb3dlZEluVm9pY2VDYWxsKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgc2VydmljZSA9IGdldElUZWxlcGhvbnkoKTsKICAgICAgICAgICAgaWYgKHNlcnZpY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZpY2UuaXNEYXRhQWxsb3dlZEluVm9pY2VDYWxsKGdldFN1YklkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIFRoaXMgY291bGQgaGFwcGVuIGlmIGJpbmRlciBwcm9jZXNzIGNyYXNoZXMuCiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgd2hldGhlciB0aGUgc3BlY2lmaWMgc2ltIGNhcmQgYWx3YXlzIGFsbG93cyBNTVMgY29ubmVjdGlvbi4gSWYgdHJ1ZSwgTU1TIG5ldHdvcmsKICAgICAqIHJlcXVlc3Qgd2lsbCBiZSBhY2NlcHRlZCBieSB0ZWxlcGhvbnkgZXZlbiBpZiB1c2VyIHR1cm5zICJtb2JpbGUgZGF0YSIgb2ZmCiAgICAgKiBvbiB0aGlzIHNwZWNpZmljIHNpbSBjYXJkLgogICAgICoKICAgICAqIEBwYXJhbSBhbHdheXNBbGxvdyB3aGV0aGVyIE1tcyBkYXRhIGlzIGFsd2F5cyBhbGxvd2VkLgogICAgICogQHJldHVybiB3aGV0aGVyIG9wZXJhdGlvbiBpcyBzdWNjZXNzZnVsLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldEFsd2F5c0FsbG93TW1zRGF0YShib29sZWFuIGFsd2F5c0FsbG93KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVRlbGVwaG9ueSBzZXJ2aWNlID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAoc2VydmljZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZS5zZXRBbHdheXNBbGxvd01tc0RhdGEoZ2V0U3ViSWQoKSwgYWx3YXlzQWxsb3cpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgSWNjTG9jayBzdGF0ZSBvciBwYXNzd29yZCB3YXMgY2hhbmdlZCBzdWNjZXNzZnVsbHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDSEFOR0VfSUNDX0xPQ0tfU1VDQ0VTUyA9IEludGVnZXIuTUFYX1ZBTFVFOwoKICAgIC8qKgogICAgICogQ2hlY2sgd2hldGhlciBJQ0MgcGluIGxvY2sgaXMgZW5hYmxlZC4KICAgICAqIFRoaXMgaXMgYSBzeW5jIGNhbGwgd2hpY2ggcmV0dXJucyB0aGUgY2FjaGVkIHBpbiBlbmFibGVkIHN0YXRlLgogICAgICoKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIElDQyBsb2NrIGVuYWJsZWQsIHtAY29kZSBmYWxzZX0gaWYgSUNDIGxvY2sgZGlzYWJsZWQuCiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAV29ya2VyVGhyZWFkCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0ljY0xvY2tFbmFibGVkKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuaXNJY2NMb2NrRW5hYmxlZChnZXRTdWJJZCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIExvZy5lKFRBRywgImlzSWNjTG9ja0VuYWJsZWQgUmVtb3RlRXhjZXB0aW9uIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgSUNDIHBpbiBsb2NrIGVuYWJsZWQgb3IgZGlzYWJsZWQuCiAgICAgKgogICAgICogSWYgZW5hYmxlL2Rpc2FibGUgSUNDIHBpbiBsb2NrIHN1Y2Nlc3NmdWxseSwgYSB2YWx1ZSBvZiB7QGxpbmsgSW50ZWdlciNNQVhfVkFMVUV9IGlzCiAgICAgKiByZXR1cm5lZC4KICAgICAqIElmIGFuIGluY29ycmVjdCBvbGQgcGFzc3dvcmQgaXMgc3BlY2lmaWVkLCB0aGUgcmV0dXJuIHZhbHVlIHdpbGwgaW5kaWNhdGUgaG93IG1hbnkgbW9yZQogICAgICogYXR0ZW1wdHMgdGhlIHVzZXIgY2FuIG1ha2UgdG8gY2hhbmdlIHRoZSBwYXNzd29yZCBiZWZvcmUgdGhlIFNJTSBpcyBsb2NrZWQuCiAgICAgKiBVc2luZyBQVUsgY29kZSB0byB1bmxvY2sgU0lNIGlmIGVudGVyIHRoZSBpbmNvcnJlY3Qgb2xkIHBhc3N3b3JkIDMgdGltZXMuCiAgICAgKgogICAgICogQHBhcmFtIGVuYWJsZWQgICAgInRydWUiIGZvciBsb2NrZWQsICJmYWxzZSIgZm9yIHVubG9ja2VkLgogICAgICogQHBhcmFtIHBhc3N3b3JkICAgbmVlZGVkIHRvIGNoYW5nZSB0aGUgSUNDIHBpbiBzdGF0ZSwgYWthLiBQaW4xCiAgICAgKiBAcmV0dXJuIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBzdGF0dXMgb2YgSWNjTG9jayBlbmFibGVkIG9yIGRpc2FibGVkIGluIHRoZSBmb2xsb3dpbmcKICAgICAqIHRocmVlIGNhc2VzOgogICAgICogICAtIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI0NIQU5HRV9JQ0NfTE9DS19TVUNDRVNTfSBpZiBlbmFibGVkIG9yIGRpc2FibGVkIEljY0xvY2sKICAgICAqICAgc3VjY2Vzc2Z1bGx5LgogICAgICogICAtIFBvc2l0aXZlIG51bWJlciBhbmQgemVybyBmb3IgcmVtYWluaW5nIHBhc3N3b3JkIGF0dGVtcHRzLgogICAgICogICAtIE5lZ2F0aXZlIG51bWJlciBmb3Igb3RoZXIgZmFpbHVyZSBjYXNlcyAoc3VjaCBsaWtlIGVuYWJsaW5nL2Rpc2FibGluZyBQSU4gZmFpbGVkKS4KICAgICAqCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBoYXZlIHRoZSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgc2V0SWNjTG9ja0VuYWJsZWQoYm9vbGVhbiBlbmFibGVkLCBATm9uTnVsbCBTdHJpbmcgcGFzc3dvcmQpIHsKICAgICAgICBjaGVja05vdE51bGwocGFzc3dvcmQsICJzZXRJY2NMb2NrRW5hYmxlZCBwYXNzd29yZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuc2V0SWNjTG9ja0VuYWJsZWQoZ2V0U3ViSWQoKSwgZW5hYmxlZCwgcGFzc3dvcmQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgTG9nLmUoVEFHLCAic2V0SWNjTG9ja0VuYWJsZWQgUmVtb3RlRXhjZXB0aW9uIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIC8qKgogICAgICogQ2hhbmdlIHRoZSBJQ0MgcGFzc3dvcmQgdXNlZCBpbiBJQ0MgcGluIGxvY2suCiAgICAgKgogICAgICogSWYgdGhlIHBhc3N3b3JkIHdhcyBjaGFuZ2VkIHN1Y2Nlc3NmdWxseSwgYSB2YWx1ZSBvZiB7QGxpbmsgSW50ZWdlciNNQVhfVkFMVUV9IGlzIHJldHVybmVkLgogICAgICogSWYgYW4gaW5jb3JyZWN0IG9sZCBwYXNzd29yZCBpcyBzcGVjaWZpZWQsIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBpbmRpY2F0ZSBob3cgbWFueSBtb3JlCiAgICAgKiBhdHRlbXB0cyB0aGUgdXNlciBjYW4gbWFrZSB0byBjaGFuZ2UgdGhlIHBhc3N3b3JkIGJlZm9yZSB0aGUgU0lNIGlzIGxvY2tlZC4KICAgICAqIFVzaW5nIFBVSyBjb2RlIHRvIHVubG9jayBTSU0gaWYgZW50ZXIgdGhlIGluY29ycmVjdCBvbGQgcGFzc3dvcmQgMyB0aW1lcy4KICAgICAqCiAgICAgKiBAcGFyYW0gb2xkUGFzc3dvcmQgaXMgdGhlIG9sZCBwYXNzd29yZAogICAgICogQHBhcmFtIG5ld1Bhc3N3b3JkIGlzIHRoZSBuZXcgcGFzc3dvcmQKICAgICAqIEByZXR1cm4gYW4gaW50ZWdlciByZXByZXNlbnRpbmcgdGhlIHN0YXR1cyBvZiBJY2NMb2NrIGNoYW5nZWQgaW4gdGhlIGZvbGxvd2luZyB0aHJlZSBjYXNlczoKICAgICAqICAgLSB7QGxpbmsgVGVsZXBob255TWFuYWdlciNDSEFOR0VfSUNDX0xPQ0tfU1VDQ0VTU30gaWYgY2hhbmdlZCBJY2NMb2NrIHN1Y2Nlc3NmdWxseS4KICAgICAqICAgLSBQb3NpdGl2ZSBudW1iZXIgYW5kIHplcm8gZm9yIHJlbWFpbmluZyBwYXNzd29yZCBhdHRlbXB0cy4KICAgICAqICAgLSBOZWdhdGl2ZSBudW1iZXIgZm9yIG90aGVyIGZhaWx1cmUgY2FzZXMgKHN1Y2ggbGlrZSBlbmFibGluZy9kaXNhYmxpbmcgUElOIGZhaWxlZCkuCiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IGNoYW5nZUljY0xvY2tQYXNzd29yZChATm9uTnVsbCBTdHJpbmcgb2xkUGFzc3dvcmQsIEBOb25OdWxsIFN0cmluZyBuZXdQYXNzd29yZCkgewogICAgICAgIGNoZWNrTm90TnVsbChvbGRQYXNzd29yZCwgImNoYW5nZUljY0xvY2tQYXNzd29yZCBvbGRQYXNzd29yZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIGNoZWNrTm90TnVsbChuZXdQYXNzd29yZCwgImNoYW5nZUljY0xvY2tQYXNzd29yZCBuZXdQYXNzd29yZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElUZWxlcGhvbnkgdGVsZXBob255ID0gZ2V0SVRlbGVwaG9ueSgpOwogICAgICAgICAgICBpZiAodGVsZXBob255ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZWxlcGhvbnkuY2hhbmdlSWNjTG9ja1Bhc3N3b3JkKGdldFN1YklkKCksIG9sZFBhc3N3b3JkLCBuZXdQYXNzd29yZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICBMb2cuZShUQUcsICJjaGFuZ2VJY2NMb2NrUGFzc3dvcmQgUmVtb3RlRXhjZXB0aW9uIiwgZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIC8qKgogICAgICogQ2FsbGVkIHdoZW4gdXNlckFjdGl2aXR5IGlzIHNpZ25hbGxlZCBpbiB0aGUgcG93ZXIgbWFuYWdlci4KICAgICAqIFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGZyb20gc3lzdGVtIFVpZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIG5vdGlmeVVzZXJBY3Rpdml0eSgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJVGVsZXBob255IHNlcnZpY2UgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgICAgIGlmIChzZXJ2aWNlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNlcnZpY2UudXNlckFjdGl2aXR5KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZSkgewogICAgICAgICAgICAvLyBvbmUtd2F5IG5vdGlmaWNhdGlvbiwgaWYgdGVsZXBob255IGlzIG5vdCBhdmFpbGFibGUsIGl0IGlzIG9rYXkgdG8gbm90IHRocm93CiAgICAgICAgICAgIC8vIGV4Y2VwdGlvbiBoZXJlLgogICAgICAgICAgICBMb2cudyhUQUcsICJub3RpZnlVc2VyQWN0aXZpdHkgZXhjZXB0aW9uOiAiICsgZS5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBjbGFzcyBEZWF0aFJlY2lwaWVudCBpbXBsZW1lbnRzIElCaW5kZXIuRGVhdGhSZWNpcGllbnQgewogICAgICAgIEBPdmVycmlkZQogICAgICAgIHB1YmxpYyB2b2lkIGJpbmRlckRpZWQoKSB7CiAgICAgICAgICAgIHJlc2V0U2VydmljZUNhY2hlKCk7CiAgICAgICAgfQogICAgfQoKICAgLyoqCiAgICAqIFJlc2V0IGV2ZXJ5dGhpbmcgaW4gdGhlIHNlcnZpY2UgY2FjaGU7IGlmIG9uZSBoYW5kbGUgZGllZCB0aGVuIHRoZXkgYXJlCiAgICAqIGFsbCBwcm9iYWJseSBicm9rZW4uCiAgICAqIEBoaWRlCiAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCByZXNldFNlcnZpY2VDYWNoZSgpIHsKICAgICAgICBzeW5jaHJvbml6ZWQgKHNDYWNoZUxvY2spIHsKICAgICAgICAgICAgaWYgKHNJU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNJU3ViLmFzQmluZGVyKCkudW5saW5rVG9EZWF0aChzU2VydmljZURlYXRoLCAwKTsKICAgICAgICAgICAgICAgIHNJU3ViID0gbnVsbDsKICAgICAgICAgICAgICAgIFN1YnNjcmlwdGlvbk1hbmFnZXIuY2xlYXJDYWNoZXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc0lTbXMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc0lTbXMuYXNCaW5kZXIoKS51bmxpbmtUb0RlYXRoKHNTZXJ2aWNlRGVhdGgsIDApOwogICAgICAgICAgICAgICAgc0lTbXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzSVBob25lU3ViSW5mbyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzSVBob25lU3ViSW5mby5hc0JpbmRlcigpLnVubGlua1RvRGVhdGgoc1NlcnZpY2VEZWF0aCwgMCk7CiAgICAgICAgICAgICAgICBzSVBob25lU3ViSW5mbyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAvKioKICAgICogQGhpZGUKICAgICovCiAgICBzdGF0aWMgSVBob25lU3ViSW5mbyBnZXRTdWJzY3JpYmVySW5mb1NlcnZpY2UoKSB7CiAgICAgICAgLy8gS2VlcHMgY2FjaGUgZGlzYWJsZWQgdW50aWwgdGVzdCBmaXhlcyBhcmUgY2hlY2tlZCBpbnRvIEFPU1AuCiAgICAgICAgaWYgKCFzU2VydmljZUhhbmRsZUNhY2hlRW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm4gSVBob25lU3ViSW5mby5TdHViLmFzSW50ZXJmYWNlKAogICAgICAgICAgICAgICAgVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgLmdldFBob25lU3ViU2VydmljZVJlZ2lzdGVyZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNJUGhvbmVTdWJJbmZvID09IG51bGwpIHsKICAgICAgICAgICAgSVBob25lU3ViSW5mbyB0ZW1wID0gSVBob25lU3ViSW5mby5TdHViLmFzSW50ZXJmYWNlKAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueUZyYW1ld29ya0luaXRpYWxpemVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRQaG9uZVN1YlNlcnZpY2VSZWdpc3RlcmVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgLmdldCgpKTsKICAgICAgICAgICAgc3luY2hyb25pemVkIChzQ2FjaGVMb2NrKSB7CiAgICAgICAgICAgICAgICBpZiAoc0lQaG9uZVN1YkluZm8gPT0gbnVsbCAmJiB0ZW1wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBzSVBob25lU3ViSW5mbyA9IHRlbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIHNJUGhvbmVTdWJJbmZvLmFzQmluZGVyKCkubGlua1RvRGVhdGgoc1NlcnZpY2VEZWF0aCwgMCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29tZXRoaW5nIGhhcyBnb25lIGhvcnJpYmx5IHdyb25nCiAgICAgICAgICAgICAgICAgICAgICAgIHNJUGhvbmVTdWJJbmZvID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNJUGhvbmVTdWJJbmZvOwogICAgfQoKICAgLyoqCiAgICAqIEBoaWRlCiAgICAqLwogICAgc3RhdGljIElTdWIgZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpIHsKICAgICAgICAvLyBLZWVwcyBjYWNoZSBkaXNhYmxlZCB1bnRpbCB0ZXN0IGZpeGVzIGFyZSBjaGVja2VkIGludG8gQU9TUC4KICAgICAgICBpZiAoIXNTZXJ2aWNlSGFuZGxlQ2FjaGVFbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybiBJU3ViLlN0dWIuYXNJbnRlcmZhY2UoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U3Vic2NyaXB0aW9uU2VydmljZVJlZ2lzdGVyZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldCgpKTsKICAgICAgICB9CgogICAgICAgIGlmIChzSVN1YiA9PSBudWxsKSB7CiAgICAgICAgICAgIElTdWIgdGVtcCA9IElTdWIuU3R1Yi5hc0ludGVyZmFjZSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgICAgICBzeW5jaHJvbml6ZWQgKHNDYWNoZUxvY2spIHsKICAgICAgICAgICAgICAgIGlmIChzSVN1YiA9PSBudWxsICYmIHRlbXAgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNJU3ViID0gdGVtcDsKICAgICAgICAgICAgICAgICAgICAgICAgc0lTdWIuYXNCaW5kZXIoKS5saW5rVG9EZWF0aChzU2VydmljZURlYXRoLCAwKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzb21ldGhpbmcgaGFzIGdvbmUgaG9ycmlibHkgd3JvbmcKICAgICAgICAgICAgICAgICAgICAgICAgc0lTdWIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc0lTdWI7CiAgICB9CgogICAgLyoqCiAgICAqIEBoaWRlCiAgICAqLwogICAgc3RhdGljIElTbXMgZ2V0U21zU2VydmljZSgpIHsKICAgICAgICAvLyBLZWVwcyBjYWNoZSBkaXNhYmxlZCB1bnRpbCB0ZXN0IGZpeGVzIGFyZSBjaGVja2VkIGludG8gQU9TUC4KICAgICAgICBpZiAoIXNTZXJ2aWNlSGFuZGxlQ2FjaGVFbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybiBJU21zLlN0dWIuYXNJbnRlcmZhY2UoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U21zU2VydmljZVJlZ2lzdGVyZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldCgpKTsKICAgICAgICB9CgogICAgICAgIGlmIChzSVNtcyA9PSBudWxsKSB7CiAgICAgICAgICAgIElTbXMgdGVtcCA9IElTbXMuU3R1Yi5hc0ludGVyZmFjZSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRTbXNTZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgICAgICBzeW5jaHJvbml6ZWQgKHNDYWNoZUxvY2spIHsKICAgICAgICAgICAgICAgIGlmIChzSVNtcyA9PSBudWxsICYmIHRlbXAgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNJU21zID0gdGVtcDsKICAgICAgICAgICAgICAgICAgICAgICAgc0lTbXMuYXNCaW5kZXIoKS5saW5rVG9EZWF0aChzU2VydmljZURlYXRoLCAwKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzb21ldGhpbmcgaGFzIGdvbmUgaG9ycmlibHkgd3JvbmcKICAgICAgICAgICAgICAgICAgICAgICAgc0lTbXMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc0lTbXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBzZXJ2aWNlIGhhbmRsZSBjYWNoaW5nIGZvciB0ZXN0cyB0aGF0IHV0aWxpemUgbW9jayBzZXJ2aWNlcy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBWaXNpYmxlRm9yVGVzdGluZwogICAgcHVibGljIHN0YXRpYyB2b2lkIGRpc2FibGVTZXJ2aWNlSGFuZGxlQ2FjaGluZygpIHsKICAgICAgICBzU2VydmljZUhhbmRsZUNhY2hlRW5hYmxlZCA9IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogUmVlbmFibGVzIHNlcnZpY2UgaGFuZGxlIGNhY2hpbmcuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVmlzaWJsZUZvclRlc3RpbmcKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBlbmFibGVTZXJ2aWNlSGFuZGxlQ2FjaGluZygpIHsKICAgICAgICBzU2VydmljZUhhbmRsZUNhY2hlRW5hYmxlZCA9IHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIGRldmljZSBjYW4gY29ubmVjdCB0byA1RyBuZXR3b3JrIHdoZW4gdHdvIFNJTXMgYXJlIGFjdGl2ZS4KICAgICAqIEBoaWRlCiAgICAgKiBUT0RPIGIvMTUzNjY5NzE2OiByZW1vdmUgb3IgbWFrZSBzeXN0ZW0gQVBJLgogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBjYW5Db25uZWN0VG81R0luRHNkc01vZGUoKSB7CiAgICAgICAgSVRlbGVwaG9ueSB0ZWxlcGhvbnkgPSBnZXRJVGVsZXBob255KCk7CiAgICAgICAgaWYgKHRlbGVwaG9ueSA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdGVsZXBob255LmNhbkNvbm5lY3RUbzVHSW5Ec2RzTW9kZSgpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChOdWxsUG9pbnRlckV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9Cn0KCg==</text>
      </register>
      <register name="/" type="4">
        <text encoding="base64">QWN0aXZpdHkuUkVTVUxUX09LQVk=</text>
      </register>
      <register name="0" type="2">
        <text encoding="base64">LyoKICogQ29weXJpZ2h0IChDKSAyMDE0IFRoZSBBbmRyb2lkIE9wZW4gU291cmNlIFByb2plY3QKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBhbmRyb2lkLnRlbGVwaG9ueTsKCmltcG9ydCBzdGF0aWMgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXIuU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRDsKaW1wb3J0IHN0YXRpYyBhbmRyb2lkLm5ldC5OZXR3b3JrUG9saWN5TWFuYWdlci5TVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEOwoKaW1wb3J0IGFuZHJvaWQuTWFuaWZlc3Q7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uQ2FsbGJhY2tFeGVjdXRvcjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5Db2xvckludDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5EdXJhdGlvbk1pbGxpc0xvbmc7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uSW50RGVmOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLk5vbk51bGw7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uTnVsbGFibGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uUmVxdWlyZXNGZWF0dXJlOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlJlcXVpcmVzUGVybWlzc2lvbjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudC5TZGtDb25zdGFudFR5cGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uU3VwcHJlc3NBdXRvRG9jOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlN5c3RlbUFwaTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TeXN0ZW1TZXJ2aWNlOwppbXBvcnQgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudDsKaW1wb3J0IGFuZHJvaWQuYXBwLlByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTsKaW1wb3J0IGFuZHJvaWQuY29tcGF0LmFubm90YXRpb24uVW5zdXBwb3J0ZWRBcHBVc2FnZTsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5Db250ZXh0OwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkludGVudDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlSW5mbzsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuQ29uZmlndXJhdGlvbjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuUmVzb3VyY2VzOwppbXBvcnQgYW5kcm9pZC5kYXRhYmFzZS5Db250ZW50T2JzZXJ2ZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5OZXR3b3JrQ2FwYWJpbGl0aWVzOwppbXBvcnQgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5Vcmk7CmltcG9ydCBhbmRyb2lkLm9zLkJpbmRlcjsKaW1wb3J0IGFuZHJvaWQub3MuQnVpbGQ7CmltcG9ydCBhbmRyb2lkLm9zLkJ1bmRsZTsKaW1wb3J0IGFuZHJvaWQub3MuSGFuZGxlcjsKaW1wb3J0IGFuZHJvaWQub3MuTG9vcGVyOwppbXBvcnQgYW5kcm9pZC5vcy5QYXJjZWxVdWlkOwppbXBvcnQgYW5kcm9pZC5vcy5Qcm9jZXNzOwppbXBvcnQgYW5kcm9pZC5vcy5SZW1vdGVFeGNlcHRpb247CmltcG9ydCBhbmRyb2lkLnByb3ZpZGVyLlRlbGVwaG9ueS5TaW1JbmZvOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuZXVpY2MuRXVpY2NNYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLkltc01tVGVsTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQudXRpbC5CYXNlNjQ7CmltcG9ydCBhbmRyb2lkLnV0aWwuTG9nOwppbXBvcnQgYW5kcm9pZC51dGlsLlBhaXI7CgppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTdWI7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuUGhvbmVDb25zdGFudHM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkudXRpbC5IYW5kbGVyRXhlY3V0b3I7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC51dGlsLkZ1bmN0aW9uYWxVdGlsczsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnV0aWwuUHJlY29uZGl0aW9uczsKaW1wb3J0IGNvbS5hbmRyb2lkLnRlbGVwaG9ueS5SbG9nOwoKaW1wb3J0IGphdmEuaW8uQnl0ZUFycmF5SW5wdXRTdHJlYW07CmltcG9ydCBqYXZhLmlvLkJ5dGVBcnJheU91dHB1dFN0cmVhbTsKaW1wb3J0IGphdmEuaW8uSU9FeGNlcHRpb247CmltcG9ydCBqYXZhLmlvLk9iamVjdElucHV0U3RyZWFtOwppbXBvcnQgamF2YS5pby5PYmplY3RPdXRwdXRTdHJlYW07CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb25Qb2xpY3k7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkFycmF5czsKaW1wb3J0IGphdmEudXRpbC5Db2xsZWN0aW9uczsKaW1wb3J0IGphdmEudXRpbC5IYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLkxpc3Q7CmltcG9ydCBqYXZhLnV0aWwuTG9jYWxlOwppbXBvcnQgamF2YS51dGlsLk1hcDsKaW1wb3J0IGphdmEudXRpbC5jb25jdXJyZW50LkNvbmN1cnJlbnRIYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLmNvbmN1cnJlbnQuRXhlY3V0b3I7CmltcG9ydCBqYXZhLnV0aWwuZnVuY3Rpb24uQ29uc3VtZXI7CmltcG9ydCBqYXZhLnV0aWwuc3RyZWFtLkNvbGxlY3RvcnM7CgovKioKICogU3Vic2NyaXB0aW9uTWFuYWdlciBpcyB0aGUgYXBwbGljYXRpb24gaW50ZXJmYWNlIHRvIFN1YnNjcmlwdGlvbkNvbnRyb2xsZXIKICogYW5kIHByb3ZpZGVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IFRlbGVwaG9ueSBTdWJzY3JpcHRpb25zLgogKi8KQFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU1VCU0NSSVBUSU9OX1NFUlZJQ0UpCkBSZXF1aXJlc0ZlYXR1cmUoUGFja2FnZU1hbmFnZXIuRkVBVFVSRV9URUxFUEhPTllfU1VCU0NSSVBUSU9OKQpwdWJsaWMgY2xhc3MgU3Vic2NyaXB0aW9uTWFuYWdlciB7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBTdHJpbmcgTE9HX1RBRyA9ICJTdWJzY3JpcHRpb25NYW5hZ2VyIjsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGJvb2xlYW4gREJHID0gZmFsc2U7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBib29sZWFuIFZEQkcgPSBmYWxzZTsKCiAgICAvKiogQW4gaW52YWxpZCBzdWJzY3JpcHRpb24gaWRlbnRpZmllciAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgPSAtMTsKCiAgICAvKiogQmFzZSB2YWx1ZSBmb3IgcGxhY2Vob2xkZXIgU1VCU0NSSVBUSU9OX0lEJ3MuICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBMQUNFSE9MREVSX1NVQlNDUklQVElPTl9JRF9CQVNFID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBBbiBpbnZhbGlkIHBob25lIGlkZW50aWZpZXIgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9QSE9ORV9JTkRFWCA9IC0xOwoKICAgIC8qKgogICAgICogSW5kaWNhdGVzIGludmFsaWQgc2ltIHNsb3QuIFRoaXMgY2FuIGJlIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsgI2dldFNsb3RJbmRleChpbnQpfS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9TSU1fU0xPVF9JTkRFWCA9IC0xOwoKICAgIC8qKiBJbmRpY2F0ZXMgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9uIElEIGluIFRlbGVwaG9ueS4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgdGhlIGNhbGxlciB3YW50cyB0aGUgZGVmYXVsdCBwaG9uZSBpZC4KICAgICAqIFVzZWQgaW4gU3Vic2NyaXB0aW9uQ29udHJvbGxlciBhbmQgUGhvbmUgYnV0IGRvIHdlIHJlYWxseSBuZWVkIGl0Pz8/CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfUEhPTkVfSU5ERVggPSBJbnRlZ2VyLk1BWF9WQUxVRTsKCiAgICAvKiogSW5kaWNhdGVzIHRoZSBjYWxsZXIgd2FudHMgdGhlIGRlZmF1bHQgc2xvdCBpZC4gTk9UIHVzZWQgcmVtb3ZlPyAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUZBVUxUX1NJTV9TTE9UX0lOREVYID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqIE1pbmltdW0gcG9zc2libGUgc3ViaWQgdGhhdCByZXByZXNlbnRzIGEgc3Vic2NyaXB0aW9uICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1JTl9TVUJTQ1JJUFRJT05fSURfVkFMVUUgPSAwOwoKICAgIC8qKiBNYXhpbXVtIHBvc3NpYmxlIHN1YmlkIHRoYXQgcmVwcmVzZW50cyBhIHN1YnNjcmlwdGlvbiAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNQVhfU1VCU0NSSVBUSU9OX0lEX1ZBTFVFID0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIENPTlRFTlRfVVJJID0gU2ltSW5mby5DT05URU5UX1VSSTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSA9ICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfREVGQVVMVF9EQVRBX1NVQl9JRF9QUk9QRVJUWSA9ICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFkgPSAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfZGVmYXVsdF9zbXNfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9BQ1RJVkVfREFUQV9TVUJfSURfUFJPUEVSVFkgPSAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfYWN0aXZlX2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9TTE9UX0lOREVYX1BST1BFUlRZID0gImNhY2hlX2tleS50ZWxlcGhvbnkuZ2V0X3Nsb3RfaW5kZXgiOwoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgR0VUX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19NRVRIT0RfTkFNRSA9ICJnZXRTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFJFU1RPUkVfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FID0gInJlc3RvcmVTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKioKICAgICAqIEtleSB0byB0aGUgYmFja3VwICYgcmVzdG9yZSBkYXRhIGJ5dGUgYXJyYXkgaW4gdGhlIEJ1bmRsZSB0aGF0IGlzIHJldHVybmVkIGJ5CiAgICAgKiB7QGxpbmsKICAgICAqICNnZXRBbGxTaW1TcGVjaWZpY1NldHRpbmdzRm9yQmFja3VwKCl9IG9yIHRvIGJlIHBhc3MgaW4gdG8ge0BsaW5rCiAgICAgKiAjcmVzdG9yZUFsbFNpbVNwZWNpZmljU2V0dGluZ3MoKX0uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBID0gIktFWV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfREFUQSI7CgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW50IE1BWF9DQUNIRV9TSVpFID0gNDsKCiAgICBwcml2YXRlIHN0YXRpYyBjbGFzcyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPFQ+CiAgICAgICAgICAgIGV4dGVuZHMgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPFZvaWQsIFQ+IHsKICAgICAgICBwcml2YXRlIGZpbmFsIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0Z1bmN0aW9uPElTdWIsIFQ+IG1JbnRlcmZhY2VNZXRob2Q7CiAgICAgICAgcHJpdmF0ZSBmaW5hbCBTdHJpbmcgbUNhY2hlS2V5UHJvcGVydHk7CiAgICAgICAgcHJpdmF0ZSBmaW5hbCBUIG1EZWZhdWx0VmFsdWU7CgogICAgICAgIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUoCiAgICAgICAgICAgICAgICBGdW5jdGlvbmFsVXRpbHMuVGhyb3dpbmdGdW5jdGlvbjxJU3ViLCBUPiBzdWJzY3JpcHRpb25JbnRlcmZhY2VNZXRob2QsCiAgICAgICAgICAgICAgICBTdHJpbmcgY2FjaGVLZXlQcm9wZXJ0eSwKICAgICAgICAgICAgICAgIFQgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgIHN1cGVyKE1BWF9DQUNIRV9TSVpFLCBjYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgbUludGVyZmFjZU1ldGhvZCA9IHN1YnNjcmlwdGlvbkludGVyZmFjZU1ldGhvZDsKICAgICAgICAgICAgbUNhY2hlS2V5UHJvcGVydHkgPSBjYWNoZUtleVByb3BlcnR5OwogICAgICAgICAgICBtRGVmYXVsdFZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KCiAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgcHVibGljIFQgcmVjb21wdXRlKFZvaWQgYVZvaWQpIHsKICAgICAgICAgICAgVCByZXN1bHQgPSBtRGVmYXVsdFZhbHVlOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG1JbnRlcmZhY2VNZXRob2QuYXBwbHlPclRocm93KGlTdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgICAgIFJsb2cudyhMT0dfVEFHLCAiRmFpbGVkIHRvIHJlY29tcHV0ZSBjYWNoZSBrZXkgZm9yICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChWREJHKQogICAgICAgICAgICAgICAgbG9nZCgicmVjb21wdXRpbmcgIiArIG1DYWNoZUtleVByb3BlcnR5ICsgIiwgcmVzdWx0ID0gIiArIHJlc3VsdCk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIGNsYXNzIEludGVnZXJQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8VD4KICAgICAgICAgICAgZXh0ZW5kcyBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8SW50ZWdlciwgVD4gewogICAgICAgIHByaXZhdGUgZmluYWwgRnVuY3Rpb25hbFV0aWxzLlRocm93aW5nQmlGdW5jdGlvbjxJU3ViLCBJbnRlZ2VyLCBUPiBtSW50ZXJmYWNlTWV0aG9kOwogICAgICAgIHByaXZhdGUgZmluYWwgU3RyaW5nIG1DYWNoZUtleVByb3BlcnR5OwogICAgICAgIHByaXZhdGUgZmluYWwgVCBtRGVmYXVsdFZhbHVlOwoKICAgICAgICBJbnRlZ2VyUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlKAogICAgICAgICAgICAgICAgRnVuY3Rpb25hbFV0aWxzLlRocm93aW5nQmlGdW5jdGlvbjxJU3ViLCBJbnRlZ2VyLCBUPiBzdWJzY3JpcHRpb25JbnRlcmZhY2VNZXRob2QsCiAgICAgICAgICAgICAgICBTdHJpbmcgY2FjaGVLZXlQcm9wZXJ0eSwKICAgICAgICAgICAgICAgIFQgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgIHN1cGVyKE1BWF9DQUNIRV9TSVpFLCBjYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgbUludGVyZmFjZU1ldGhvZCA9IHN1YnNjcmlwdGlvbkludGVyZmFjZU1ldGhvZDsKICAgICAgICAgICAgbUNhY2hlS2V5UHJvcGVydHkgPSBjYWNoZUtleVByb3BlcnR5OwogICAgICAgICAgICBtRGVmYXVsdFZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KCiAgICAgICAgQE92ZXJyaWRlCiAgICAgICAgcHVibGljIFQgcmVjb21wdXRlKEludGVnZXIgcXVlcnkpIHsKICAgICAgICAgICAgVCByZXN1bHQgPSBtRGVmYXVsdFZhbHVlOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG1JbnRlcmZhY2VNZXRob2QuYXBwbHlPclRocm93KGlTdWIsIHF1ZXJ5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgICAgICBSbG9nLncoTE9HX1RBRywgIkZhaWxlZCB0byByZWNvbXB1dGUgY2FjaGUga2V5IGZvciAiICsgbUNhY2hlS2V5UHJvcGVydHkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgICAgIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U3ViSWRDYWNoZSA9IG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oCiAgICAgICAgICAgIElTdWI6OmdldERlZmF1bHRTdWJJZCwKICAgICAgICAgICAgQ0FDSEVfS0VZX0RFRkFVTFRfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzRGVmYXVsdERhdGFTdWJJZENhY2hlID0gbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PigKICAgICAgICAgICAgSVN1Yjo6Z2V0RGVmYXVsdERhdGFTdWJJZCwKICAgICAgICAgICAgQ0FDSEVfS0VZX0RFRkFVTFRfREFUQV9TVUJfSURfUFJPUEVSVFksCiAgICAgICAgICAgIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEKTsKCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U21zU3ViSWRDYWNoZSA9IG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oCiAgICAgICAgICAgIElTdWI6OmdldERlZmF1bHRTbXNTdWJJZCwKICAgICAgICAgICAgQ0FDSEVfS0VZX0RFRkFVTFRfU01TX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQpOwoKICAgIHByaXZhdGUgc3RhdGljIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8SW50ZWdlcj4gc0FjdGl2ZURhdGFTdWJJZENhY2hlID0gbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PigKICAgICAgICAgICAgSVN1Yjo6Z2V0QWN0aXZlRGF0YVN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICBDQUNIRV9LRVlfQUNUSVZFX0RBVEFfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzU2xvdEluZGV4Q2FjaGUgPSBuZXcgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTw+KAogICAgICAgICAgICBJU3ViOjpnZXRTbG90SW5kZXgsCiAgICAgICAgICAgIENBQ0hFX0tFWV9TTE9UX0lOREVYX1BST1BFUlRZLAogICAgICAgICAgICBJTlZBTElEX1NJTV9TTE9UX0lOREVYKTsKCiAgICAvKiogQ2FjaGUgZGVwZW5kcyBvbiBnZXREZWZhdWx0U3ViSWQsIHNvIHdlIHVzZSB0aGUgZGVmYXVsdFN1YklkIGNhY2hlIGtleSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzUGhvbmVJZENhY2hlID0gbmV3IEludGVnZXJQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PigKICAgICAgICAgICAgSVN1Yjo6Z2V0UGhvbmVJZCwKICAgICAgICAgICAgQ0FDSEVfS0VZX0RFRkFVTFRfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICBJTlZBTElEX1BIT05FX0lOREVYKTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gc2ltSW5mbyBjaGFuZ2UKICAgICAqIG9uIHRoZSBnaXZlbiBzdWJzY3JpcHRpb25JZAogICAgICogCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbklkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbgogICAgICogQHJldHVybiB0aGUgVXJpIHVzZWQgdG8gb2JzZXJ2ZSBjYXJyaWVyIGlkZW50aXR5IGNoYW5nZXMKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgVXJpIGdldFVyaUZvclN1YnNjcmlwdGlvbklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIHJldHVybiBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwgU3RyaW5nLnZhbHVlT2Yoc3Vic2NyaXB0aW9uSWQpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgZW5hYmxlZCB1c2VyIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzCiAgICAgKiB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVm9XaUZpU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYQogICAgICoge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfQogICAgICogdG8gZW5zdXJlIHlvdXIgYXBwCiAgICAgKiBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdAogICAgICogZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFdGQ19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoQ09OVEVOVF9VUkksICJ3ZmMiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiBhZHZhbmNlZCBjYWxsaW5nIHVzZXIKICAgICAqIHNldHRpbmcKICAgICAqIAogICAgICogQHNlZSBJbXNNbVRlbE1hbmFnZXIjaXNBZHZhbmNlZENhbGxpbmdTZXR0aW5nRW5hYmxlZCgpLgogICAgICogICAgICA8cD4KICAgICAqICAgICAgVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mCiAgICAgKiAgICAgIGNoYW5nZXMgdG8gdGhlCiAgICAgKiAgICAgIHN1YnNjcmlwdGlvbiBhZHZhbmNlZCBjYWxsaW5nIGVuYWJsZWQKICAgICAqICAgICAge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0FkdmFuY2VkQ2FsbGluZ1NldHRpbmdFbmFibGVkKCl9IHdoaWxlIHlvdXIgYXBwCiAgICAgKiAgICAgIGlzIHJ1bm5pbmcuCiAgICAgKiAgICAgIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZSB5b3VyIGFwcAogICAgICogICAgICBpcyBub3RpZmllZCBvZgogICAgICogICAgICBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiAgICAgIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90CiAgICAgKiAgICAgIGd1YXJhbnRlZSB0aW1lbHkKICAgICAqICAgICAgZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiAgICAgIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqICAgICAge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQURWQU5DRURfQ0FMTElOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAiYWR2YW5jZWRfY2FsbGluZyIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIHdmYyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzCiAgICAgKiB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgbW9kZSB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2dldFZvV2lGaU1vZGVTZXR0aW5nKCl9CiAgICAgKiB3aGlsZSB5b3VyIGFwcCBpcyBydW5uaW5nLiBZb3UgY2FuIGFsc28gdXNlIGEKICAgICAqIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90CiAgICAgKiBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QKICAgICAqIGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKENPTlRFTlRfVVJJLCAid2ZjX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzCiAgICAgKiB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgcm9hbWluZyBtb2RlCiAgICAgKiB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2dldFZvV2lGaVJvYW1pbmdNb2RlU2V0dGluZygpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzCiAgICAgKiBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90CiAgICAgKiBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgV0ZDX1JPQU1JTkdfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgIndmY19yb2FtaW5nX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB2dCh2aWRlbyB0ZWxlcGhvbnkgb3ZlciBJTVMpCiAgICAgKiBlbmFibGVkCiAgICAgKiBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcwogICAgICogdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gdnQgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVnRTZXR0aW5nRW5hYmxlZCgpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdAogICAgICogcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90CiAgICAgKiBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgVlRfRU5BQkxFRF9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgInZ0X2VuYWJsZWQiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBlbmFibGVkIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzCiAgICAgKiB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgcm9hbWluZyBlbmFibGVkCiAgICAgKiB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVm9XaUZpUm9hbWluZ1NldHRpbmdFbmFibGVkKCl9CiAgICAgKiB3aGlsZSB5b3VyIGFwcCBpcyBydW5uaW5nLiBZb3UgY2FuIGFsc28gdXNlIGEKICAgICAqIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90CiAgICAgKiBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QKICAgICAqIGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfZW5hYmxlZCIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayB1cml9IHVzZWQgdG8gY2FsbCB0aGUgYXBwcm9wcmlhdGUgYmFja3VwIG9yIHJlc3RvcmUgbWV0aG9kCiAgICAgKiBmb3Igc2ltLXNwZWNpZmljCiAgICAgKiBzZXR0aW5ncwogICAgICogPHA+CiAgICAgKiBTZWUge0BsaW5rICNHRVRfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FfSBhbmQge0BsaW5rCiAgICAgKiAjUkVTVE9SRV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUV9IGZvciBpbmZvcm1hdGlvbiBvbiB3aGF0IG1ldGhvZCB0bwogICAgICogY2FsbC4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgImJhY2t1cF9hbmRfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayB1cml9IHVzZWQgdG8gbm90aWZ5IGNvbnRlbnRvYnNlcnZlcnMgbGlzdGVuaW5nIHRvIHNpbWluZm8KICAgICAqIHJlc3RvcmUgZHVyaW5nCiAgICAgKiBTdVcuCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBTSU1fSU5GT19TVVdfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBTSU1fSU5GT19CQUNLVVBfQU5EX1JFU1RPUkVfQ09OVEVOVF9VUkksICJzdXdfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIGNyb3NzIHNpbSBlbmFibGVkIHVzZXIKICAgICAqIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzCiAgICAgKiB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBjcm9zcyBzaW0gY2FsbGluZyBlbmFibGVkCiAgICAgKiB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzQ3Jvc3NTaW1DYWxsaW5nRW5hYmxlZCgpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90CiAgICAgKiBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQ1JPU1NfU0lNX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwKICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRCk7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciB1bmlxdWUga2V5IGNvbHVtbiBuYW1lIGlzIHRoZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKiA8UD4KICAgICAqIFR5cGU6IFRFWFQgKFN0cmluZykKICAgICAqIDwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBVTklRVUVfS0VZX1NVQlNDUklQVElPTl9JRCA9IFNpbUluZm8uQ09MVU1OX1VOSVFVRV9LRVlfU1VCU0NSSVBUSU9OX0lEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGEgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIHdpdGhpbiB0aGUKICAgICAqIHNwZWNpZmljIHN1YnNjcmlwdGlvbiB0eXBlLiBGb3IgZXhhbXBsZSwgaXQgY29udGFpbnMgU0lNIElDQyBJZGVudGlmaWVyCiAgICAgKiBzdWJzY3JpcHRpb25zCiAgICAgKiBvbiBMb2NhbCBTSU1zLiBhbmQgTWFjLWFkZHJlc3MgZm9yIFJlbW90ZS1TSU0gU3Vic2NyaXB0aW9ucyBmb3IgQmx1ZXRvb3RoCiAgICAgKiBkZXZpY2VzLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSUNDX0lEID0gU2ltSW5mby5DT0xVTU5fSUNDX0lEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHVzZXIgU0lNX1NsT1RfSU5ERVgKICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFNJTV9TTE9UX0lOREVYID0gU2ltSW5mby5DT0xVTU5fU0lNX1NMT1RfSU5ERVg7CgogICAgLyoqIFNJTSBpcyBub3QgaW5zZXJ0ZWQgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX05PVF9JTlNFUlRFRCA9IFNpbUluZm8uU0lNX05PVF9JTlNFUlRFRDsKCiAgICAvKioKICAgICAqIFRoZSBzbG90LWluZGV4IGZvciBCbHVldG9vdGggUmVtb3RlLVNJTSBzdWJzY3JpcHRpb25zCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNMT1RfSU5ERVhfRk9SX1JFTU9URV9TSU1fU1VCID0gSU5WQUxJRF9TSU1fU0xPVF9JTkRFWDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIFN1YnNjcmlwdGlvbi10eXBlLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBJTlRFR0VSIChpbnQpCiAgICAgKiA8L1A+CiAgICAgKiB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTX0gZm9yIExvY2FsLVNJTSBTdWJzY3JpcHRpb25zLAogICAgICoge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRV9SRU1PVEVfU0lNfSBmb3IgUmVtb3RlLVNJTSBTdWJzY3JpcHRpb25zLgogICAgICogRGVmYXVsdCB2YWx1ZSBpcyAwLgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFNVQlNDUklQVElPTl9UWVBFID0gU2ltSW5mby5DT0xVTU5fU1VCU0NSSVBUSU9OX1RZUEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBkYXRhX2VuYWJsZWRfb3ZlcnJpZGVfcnVsZXMuCiAgICAgKiBJdCdzIGEgbGlzdCBvZiBydWxlcyBmb3Igb3ZlcnJpZGluZyBkYXRhIGVuYWJsZWQgc2V0dGluZ3MuIFRoZSBzeW50YXggaXMKICAgICAqIEZvciBleGFtcGxlLCAibW1zPW5vbkRlZmF1bHQiIGluZGljYXRlcyBlbmFibGluZyBkYXRhIGZvciBtbXMgaW4gbm9uLWRlZmF1bHQKICAgICAqIHN1YnNjcmlwdGlvbi4KICAgICAqICJkZWZhdWx0PW5vbkRlZmF1bHQmaW5Wb2ljZUNhbGwiIGluZGljYXRlcyBlbmFibGluZyBkYXRhIGZvciBpbnRlcm5ldCBpbgogICAgICogbm9uLWRlZmF1bHQKICAgICAqIHN1YnNjcmlwdGlvbiBhbmQgd2hpbGUgaXMgaW4gdm9pY2UgY2FsbC4KICAgICAqCiAgICAgKiBEZWZhdWx0IHZhbHVlIGlzIGVtcHR5IHN0cmluZy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVMgPSBTaW1JbmZvLkNPTFVNTl9EQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVM7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsgIlNVQlNDUklQVElPTl9UWVBFXyIgfSwgdmFsdWUgPSB7CiAgICAgICAgICAgIFNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTSwKICAgICAgICAgICAgU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTSB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgU3Vic2NyaXB0aW9uVHlwZSB7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnN0YW50IGlzIHRvIGRlc2lnbmF0ZSBhIHN1YnNjcmlwdGlvbiBhcyBhIExvY2FsLVNJTSBTdWJzY3JpcHRpb24uCiAgICAgKiA8cD4KICAgICAqIEEgTG9jYWwtU0lNIGNhbiBiZSBhIHBoeXNpY2FsIFNJTSBpbnNlcnRlZCBpbnRvIGEgc2ltLXNsb3QgaW4gdGhlIGRldmljZSwgb3IKICAgICAqIGVTSU0gb24gdGhlCiAgICAgKiBkZXZpY2UuCiAgICAgKiA8L3A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTSA9IFNpbUluZm8uU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNOwoKICAgIC8qKgogICAgICogVGhpcyBjb25zdGFudCBpcyB0byBkZXNpZ25hdGUgYSBzdWJzY3JpcHRpb24gYXMgYSBSZW1vdGUtU0lNIFN1YnNjcmlwdGlvbi4KICAgICAqIDxwPgogICAgICogQSBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiBpcyBmb3IgYSBTSU0gb24gYSBwaG9uZSBjb25uZWN0ZWQgdG8gdGhpcyBkZXZpY2UKICAgICAqIHZpYSBzb21lCiAgICAgKiBjb25uZWN0aXZpdHkgbWVjaGFuaXNtLCBmb3IgZXhhbXBsZSBibHVldG9vdGguIFNpbWlsYXIgdG8gTG9jYWwgU0lNLCB0aGlzCiAgICAgKiBzdWJzY3JpcHRpb24gY2FuCiAgICAgKiBiZSB1c2VkIGZvciBTTVMsIFZvaWNlIGFuZCBkYXRhIGJ5IHByb3h5aW5nIGRhdGEgdGhyb3VnaCB0aGUgY29ubmVjdGVkCiAgICAgKiBkZXZpY2UuCiAgICAgKiBDZXJ0YWluIGRhdGEgb2YgdGhlIFNJTSwgc3VjaCBhcyBJTUVJLCBhcmUgbm90IGFjY2Vzc2libGUgZm9yIFJlbW90ZSBTSU1zLgogICAgICogPC9wPgogICAgICoKICAgICAqIDxwPgogICAgICogQSBSZW1vdGUtU0lNIGlzIGF2YWlsYWJsZSBvbmx5IGFzIGxvbmcgdGhlIHBob25lIHN0YXlzIGNvbm5lY3RlZCB0byB0aGlzCiAgICAgKiBkZXZpY2UuCiAgICAgKiBXaGVuIHRoZSBwaG9uZSBkaXNjb25uZWN0cywgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMgcmVtb3ZlZCBmcm9tIHRoaXMKICAgICAqIGRldmljZSBhbmQgaXMKICAgICAqIG5vIGxvbmdlciBrbm93bi4gQWxsIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24sIHN1Y2ggYXMgc3RvcmVkCiAgICAgKiBTTVMsIGNhbGwgbG9ncywKICAgICAqIGNvbnRhY3RzIGV0YywgYXJlIHJlbW92ZWQgZnJvbSB0aGlzIGRldmljZS4KICAgICAqIDwvcD4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIElmIHRoZSBwaG9uZSByZS1jb25uZWN0cyB0byB0aGlzIGRldmljZSwgYSBuZXcgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMKICAgICAqIGNyZWF0ZWQgZm9yCiAgICAgKiB0aGUgcGhvbmUuIFRoZSBTdWJzY3JpcHRpb24gSWQgYXNzb2NpYXRlZCB3aXRoIHRoZSBuZXcgc3Vic2NyaXB0aW9uIGlzCiAgICAgKiBkaWZmZXJlbnQgZnJvbQogICAgICogdGhlIFN1YnNjcmlwdGlvbiBJZCBvZiB0aGUgcHJldmlvdXMgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gY3JlYXRlZCAoYW5kCiAgICAgKiByZW1vdmVkKSBmb3IgdGhlCiAgICAgKiBwaG9uZTsgaS5lLiwgbmV3IFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9uIHRyZWF0cyB0aGUgcmVjb25uZWN0ZWQgcGhvbmUgYXMgYQogICAgICogUmVtb3RlLVNJTSB0aGF0CiAgICAgKiB3YXMgbmV2ZXIgc2VlbiBiZWZvcmUuCiAgICAgKiA8L3A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU0gPSBTaW1JbmZvLlNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU07CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdXNlciBkaXNwbGF5ZWQgbmFtZS4KICAgICAqIDxQPgogICAgICogVHlwZTogVEVYVCAoU3RyaW5nKQogICAgICogPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIERJU1BMQVlfTkFNRSA9IFNpbUluZm8uQ09MVU1OX0RJU1BMQVlfTkFNRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgc2VydmljZSBwcm92aWRlciBuYW1lIGZvciB0aGUgU0lNLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0FSUklFUl9OQU1FID0gU2ltSW5mby5DT0xVTU5fQ0FSUklFUl9OQU1FOwoKICAgIC8qKgogICAgICogRGVmYXVsdCBuYW1lIHJlc291cmNlCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfTkFNRV9SRVMgPSBjb20uYW5kcm9pZC5pbnRlcm5hbC5SLnN0cmluZy51bmtub3duTmFtZTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBzb3VyY2Ugb2YgdGhlIHVzZXIgZGlzcGxheWVkIG5hbWUuCiAgICAgKiA8UD4KICAgICAqIFR5cGU6IElOVCAoaW50KQogICAgICogPC9QPgogICAgICogd2l0aCBvbmUgb2YgdGhlIE5BTUVfU09VUkNFX1hYWFggdmFsdWVzIGJlbG93CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTkFNRV9TT1VSQ0UgPSBTaW1JbmZvLkNPTFVNTl9OQU1FX1NPVVJDRTsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIHRoZSBjYXJyaWVyIGlkLgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9DQVJSSUVSX0lEID0gU2ltSW5mby5OQU1FX1NPVVJDRV9DQVJSSUVSX0lEOwoKICAgIC8qKgogICAgICogVGhlIG5hbWVfc291cmNlIGlzIGZyb20gU0lNIEVGX1NQTi4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfU0lNX1NQTiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfU0lNX1NQTjsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIHVzZXIgaW5wdXQKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5BTUVfU09VUkNFX1VTRVJfSU5QVVQgPSBTaW1JbmZvLk5BTUVfU09VUkNFX1VTRVJfSU5QVVQ7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgY2FycmllciAoY2FycmllciBhcHAsIGNhcnJpZXIgY29uZmlnLCBldGMuKQogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9DQVJSSUVSID0gU2ltSW5mby5OQU1FX1NPVVJDRV9DQVJSSUVSOwoKICAgIC8qKgogICAgICogVGhlIG5hbWVfc291cmNlIGlzIGZyb20gU0lNIEVGX1BOTi4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfU0lNX1BOTiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfU0lNX1BOTjsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyAiTkFNRV9TT1VSQ0VfIiB9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRCwKICAgICAgICAgICAgTkFNRV9TT1VSQ0VfU0lNX1NQTiwKICAgICAgICAgICAgTkFNRV9TT1VSQ0VfVVNFUl9JTlBVVCwKICAgICAgICAgICAgTkFNRV9TT1VSQ0VfQ0FSUklFUiwKICAgICAgICAgICAgTkFNRV9TT1VSQ0VfU0lNX1BOTgogICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFNpbURpc3BsYXlOYW1lU291cmNlIHsKICAgIH0KCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgbm90IHNoYXJlZCB0byBhIHJlbW90ZSBwYXJ0eS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRDJEX1NIQVJJTkdfRElTQUJMRUQgPSAwOwoKICAgIC8qKgogICAgICogRGV2aWNlIHN0YXR1cyBpcyBzaGFyZWQgd2l0aCBhbGwgbnVtYmVycyBpbiB0aGUgdXNlcidzIGNvbnRhY3RzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEMkRfU0hBUklOR19BTExfQ09OVEFDVFMgPSAxOwoKICAgIC8qKgogICAgICogRGV2aWNlIHN0YXR1cyBpcyBzaGFyZWQgd2l0aCBhbGwgc2VsZWN0ZWQgY29udGFjdHMuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEQyRF9TSEFSSU5HX1NFTEVDVEVEX0NPTlRBQ1RTID0gMjsKCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgc2hhcmVkIHdoZW5ldmVyIHBvc3NpYmxlLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEMkRfU0hBUklOR19BTEwgPSAzOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7ICJEMkRfU0hBUklOR18iIH0sIHZhbHVlID0gewogICAgICAgICAgICBEMkRfU0hBUklOR19ESVNBQkxFRCwKICAgICAgICAgICAgRDJEX1NIQVJJTkdfQUxMX0NPTlRBQ1RTLAogICAgICAgICAgICBEMkRfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUywKICAgICAgICAgICAgRDJEX1NIQVJJTkdfQUxMCiAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgRGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSB7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZGV2aWNlIHRvIGRldmljZSBzaGFyaW5nIHN0YXR1cy4KICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEMkRfU1RBVFVTX1NIQVJJTkcgPSBTaW1JbmZvLkNPTFVNTl9EMkRfU1RBVFVTX1NIQVJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgY29udGFjdHMgaW5mb3JtYXRpb24gdGhhdCBhbGxvdyBkZXZpY2UgdG8KICAgICAqIGRldmljZSBzaGFyaW5nLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEQyRF9TVEFUVVNfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUyA9IFNpbUluZm8uQ09MVU1OX0QyRF9TVEFUVVNfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgY29sb3Igb2YgYSBTSU0uCiAgICAgKiA8UD4KICAgICAqIFR5cGU6IElOVEVHRVIgKGludCkKICAgICAqIDwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBIVUUgPSBTaW1JbmZvLkNPTFVNTl9DT0xPUjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgcGhvbmUgbnVtYmVyIG9mIGEgU0lNLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTlVNQkVSID0gU2ltSW5mby5DT0xVTU5fTlVNQkVSOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHdoZXRoZXIgZGF0YSByb2FtaW5nIGlzIGVuYWJsZWQuCiAgICAgKiA8UD4KICAgICAqIFR5cGU6IElOVEVHRVIgKGludCkKICAgICAqIDwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEQVRBX1JPQU1JTkcgPSBTaW1JbmZvLkNPTFVNTl9EQVRBX1JPQU1JTkc7CgogICAgLyoqIEluZGljYXRlcyB0aGF0IGRhdGEgcm9hbWluZyBpcyBlbmFibGVkIGZvciBhIHN1YnNjcmlwdGlvbiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREFUQV9ST0FNSU5HX0VOQUJMRSA9IFNpbUluZm8uREFUQV9ST0FNSU5HX0VOQUJMRTsKCiAgICAvKiogSW5kaWNhdGVzIHRoYXQgZGF0YSByb2FtaW5nIGlzIGRpc2FibGVkIGZvciBhIHN1YnNjcmlwdGlvbiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREFUQV9ST0FNSU5HX0RJU0FCTEUgPSBTaW1JbmZvLkRBVEFfUk9BTUlOR19ESVNBQkxFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHN1YnNjcmlwdGlvbiBjYXJyaWVyIGlkLgogICAgICogCiAgICAgKiBAc2VlIFRlbGVwaG9ueU1hbmFnZXIjZ2V0U2ltQ2FycmllcklkKCkKICAgICAqICAgICAgPHA+CiAgICAgKiAgICAgIFR5cGU6IElOVEVHRVIgKGludCkKICAgICAqICAgICAgPC9wPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0FSUklFUl9JRCA9IFNpbUluZm8uQ09MVU1OX0NBUlJJRVJfSUQ7CgogICAgLyoqCiAgICAgKiBAaGlkZSBBIGNvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIEVIUExNTnMgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24KICAgICAqICAgICAgIDxQPgogICAgICogICAgICAgVHlwZTogVEVYVCAoU3RyaW5nKQogICAgICogICAgICAgPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFSFBMTU5TID0gU2ltSW5mby5DT0xVTU5fRUhQTE1OUzsKCiAgICAvKioKICAgICAqIEBoaWRlIEEgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgSFBMTU5zIGFzc29jaWF0ZWQgd2l0aCB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiAgICAgICA8UD4KICAgICAqICAgICAgIFR5cGU6IFRFWFQgKFN0cmluZykKICAgICAqICAgICAgIDwvUD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSFBMTU5TID0gU2ltSW5mby5DT0xVTU5fSFBMTU5TOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNQ0MgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLCBzdG9yZWQgYXMgYQogICAgICogc3RyaW5nLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE1DQ19TVFJJTkcgPSBTaW1JbmZvLkNPTFVNTl9NQ0NfU1RSSU5HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNTkMgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLCBzdG9yZWQgYXMgYQogICAgICogc3RyaW5nLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE1OQ19TVFJJTkcgPSBTaW1JbmZvLkNPTFVNTl9NTkNfU1RSSU5HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNQ0MgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBJTlRFR0VSIChpbnQpCiAgICAgKiA8L1A+CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE1DQyA9IFNpbUluZm8uQ09MVU1OX01DQzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgTU5DIGFzc29jaWF0ZWQgd2l0aCBhIFNJTS4KICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNTkMgPSBTaW1JbmZvLkNPTFVNTl9NTkM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIGlzbyBjb3VudHJ5IGNvZGUgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUIChTdHJpbmcpCiAgICAgKiA8L1A+CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTT19DT1VOVFJZX0NPREUgPSBTaW1JbmZvLkNPTFVNTl9JU09fQ09VTlRSWV9DT0RFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgZW1iZWRkZWQgKHRoYXQKICAgICAqIGlzLCBwcmVzZW50IG9uIGFuCiAgICAgKiBlU0lNKS4KICAgICAqIDxwPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KSwgMSBmb3IgZW1iZWRkZWQgb3IgMCBmb3Igbm9uLWVtYmVkZGVkLgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJU19FTUJFRERFRCA9IFNpbUluZm8uQ09MVU1OX0lTX0VNQkVEREVEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIFNJTSBjYXJkIGlkZW50aWZpZXIuIEZvciBVSUNDIGNhcmQgaXQgaXMKICAgICAqIHRoZSBJQ0NJRCBvZiB0aGUKICAgICAqIGN1cnJlbnQgZW5hYmxlZCBwcm9maWxlIG9uIHRoZSBjYXJkLCB3aGlsZSBmb3IgZVVJQ0MgY2FyZCBpdCBpcyB0aGUgRUlEIG9mCiAgICAgKiB0aGUgY2FyZC4KICAgICAqIDxQPgogICAgICogVHlwZTogVEVYVCAoU3RyaW5nKQogICAgICogPC9QPgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJEX0lEID0gU2ltSW5mby5DT0xVTU5fQ0FSRF9JRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgZW5jb2RlZCB7QGxpbmsgVWljY0FjY2Vzc1J1bGV9cyBmcm9tCiAgICAgKiB7QGxpbmsgVWljY0FjY2Vzc1J1bGUjZW5jb2RlUnVsZXN9LiBPbmx5IHByZXNlbnQgaWYge0BsaW5rICNJU19FTUJFRERFRH0gaXMKICAgICAqIDEuCiAgICAgKiA8cD4KICAgICAqIFRZUEU6IEJMT0IKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNDRVNTX1JVTEVTID0gU2ltSW5mby5DT0xVTU5fQUNDRVNTX1JVTEVTOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBlbmNvZGVkIHtAbGluayBVaWNjQWNjZXNzUnVsZX1zIGZyb20KICAgICAqIHtAbGluayBVaWNjQWNjZXNzUnVsZSNlbmNvZGVSdWxlc30gYnV0IGZvciB0aGUgcnVsZXMgdGhhdCBjb21lIGZyb20KICAgICAqIENhcnJpZXJDb25maWdzLgogICAgICogT25seSBwcmVzZW50IGlmIHRoZXJlIGFyZSBhY2Nlc3MgcnVsZXMgaW4gQ2FycmllckNvbmZpZ3MKICAgICAqIDxwPgogICAgICogVFlQRTogQkxPQgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ0NFU1NfUlVMRVNfRlJPTV9DQVJSSUVSX0NPTkZJR1MgPSBTaW1JbmZvLkNPTFVNTl9BQ0NFU1NfUlVMRVNfRlJPTV9DQVJSSUVSX0NPTkZJR1M7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBpZGVudGlmeWluZyB3aGV0aGVyIGFuIGVtYmVkZGVkIHN1YnNjcmlwdGlvbiBpcwogICAgICogb24gYSByZW1vdmFibGUKICAgICAqIGNhcmQuIFN1Y2ggc3Vic2NyaXB0aW9ucyBhcmUgbWFya2VkIGluYWNjZXNzaWJsZSBhcyBzb29uIGFzIHRoZSBjdXJyZW50IGNhcmQKICAgICAqIGlzIHJlbW92ZWQuCiAgICAgKiBPdGhlcndpc2UsIHRoZXkgd2lsbCByZW1haW4gYWNjZXNzaWJsZSB1bmxlc3MgZXhwbGljaXRseSBkZWxldGVkLiBPbmx5CiAgICAgKiBwcmVzZW50IGlmCiAgICAgKiB7QGxpbmsgI0lTX0VNQkVEREVEfSBpcyAxLgogICAgICogPHA+CiAgICAgKiBUWVBFOiBJTlRFR0VSIChpbnQpLCAxIGZvciByZW1vdmFibGUgb3IgMCBmb3Igbm9uLXJlbW92YWJsZS4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSVNfUkVNT1ZBQkxFID0gU2ltSW5mby5DT0xVTU5fSVNfUkVNT1ZBQkxFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGV4dHJlbWUgdGhyZWF0IGluIENCIHNldHRpbmdzCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0VYVFJFTUVfVEhSRUFUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfRVhUUkVNRV9USFJFQVRfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igc2V2ZXJlIHRocmVhdCBpbiBDQiBzZXR0aW5ncwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9TRVZFUkVfVEhSRUFUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfU0VWRVJFX1RIUkVBVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbWJlciBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTUJFUl9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0FNQkVSX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVtZXJnZW5jeSBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9FTUVSR0VOQ1lfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9FTUVSR0VOQ1lfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYWxlcnQgc291bmQgZHVyYXRpb24gaW4gQ0Igc2V0dGluZ3MKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfU09VTkRfRFVSQVRJT04gPSBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9TT1VORF9EVVJBVElPTjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbGVydCByZW1pbmRlciBpbnRlcnZhbCBpbiBDQiBzZXR0aW5ncwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTEVSVF9SRU1JTkRFUl9JTlRFUlZBTCA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1JFTUlOREVSX0lOVEVSVkFMOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsaW5nIHZpYnJhdGUgaW4gQ0Igc2V0dGluZ3MKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfVklCUkFURSA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1ZJQlJBVEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZW5hYmxpbmcgYWxlcnQgc3BlZWNoIGluIENCIHNldHRpbmdzCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0FMRVJUX1NQRUVDSCA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1NQRUVDSDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBFVFdTIHRlc3QgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfRVRXU19URVNUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfRVRXU19URVNUX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBjaGFubmVsNTAgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQ0hBTk5FTF81MF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NIQU5ORUxfNTBfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgQ01BUyB0ZXN0IGFsZXJ0IGluIENCIHNldHRpbmdzCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0NNQVNfVEVTVF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NNQVNfVEVTVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBPcHQgb3V0IGRpYWxvZyBpbiBDQiBzZXR0aW5ncwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9PUFRfT1VUX0RJQUxPRyA9IFNpbUluZm8uQ09MVU1OX0NCX09QVF9PVVRfRElBTE9HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBWb2x0ZS4KICAgICAqCiAgICAgKiBJZiB0aGlzIHNldHRpbmcgaXMgbm90IGluaXRpYWxpemVkIChzZXQgdG8gLTEpIHRoZW4gd2UgdXNlIHRoZSBDYXJyaWVyIENvbmZpZwogICAgICogdmFsdWUKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfRU5IQU5DRURfNEdfTFRFX09OX0JZX0RFRkFVTFRfQk9PTH0uCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVOSEFOQ0VEXzRHX01PREVfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX0VOSEFOQ0VEXzRHX01PREVfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgVlQgKFZpZGVvIFRlbGVwaG9ueSBvdmVyIElNUykKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVlRfSU1TX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9WVF9JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgV2lmaSBjYWxsaW5nCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFdGQ19JTVNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBXaWZpIGNhbGxpbmcgbW9kZQogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX01PREUgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX01PREU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgV2lmaSBjYWxsaW5nIG1vZGUgaW4gcm9hbWluZwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfTU9ERSA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19NT0RFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBXaWZpIGNhbGxpbmcgaW4gcm9hbWluZwogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19FTkFCTEVEOwoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgdXNlciBoYXMgZW5hYmxlZCBJTVMgUkNTIFVzZXIgQ2FwYWJpbGl0eSBFeGNoYW5nZSAoVUNFKSBmb3IKICAgICAqIHRoaXMKICAgICAqIHN1YnNjcmlwdGlvbi4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSU1TX1JDU19VQ0VfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX0lNU19SQ1NfVUNFX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB1c2VyIGhhcyBlbmFibGVkIGNyb3NzIFNJTSBjYWxsaW5nIGZvciB0aGlzIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDUk9TU19TSU1fQ0FMTElOR19FTkFCTEVEID0gU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIG9wcG9ydHVuaXN0aWMsCiAgICAgKiB0aGF0IGlzLAogICAgICogd2hldGhlciB0aGUgbmV0d29yayBpdCBjb25uZWN0cyB0byBpcyBsaW1pdGVkIGluIGZ1bmN0aW9uYWxpdHkgb3IgY292ZXJhZ2UuCiAgICAgKiBGb3IgZXhhbXBsZSwgQ0JSUy4KICAgICAqIDxwPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KSwgMSBmb3Igb3Bwb3J0dW5pc3RpYyBvciAwIGZvciBub24tb3Bwb3J0dW5pc3RpYy4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSVNfT1BQT1JUVU5JU1RJQyA9IFNpbUluZm8uQ09MVU1OX0lTX09QUE9SVFVOSVNUSUM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZ3JvdXAgSUQuIFN1YnNjcmlwdGlvbnMgd2l0aCBzYW1lIGdyb3VwIElECiAgICAgKiBhcmUgY29uc2lkZXJlZCBidW5kbGVkIHRvZ2V0aGVyLCBhbmQgc2hvdWxkIGJlaGF2ZSBhcyBhIHNpbmdsZSBzdWJzY3JpcHRpb24KICAgICAqIGF0CiAgICAgKiBjZXJ0YWluIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBHUk9VUF9VVUlEID0gU2ltSW5mby5DT0xVTU5fR1JPVVBfVVVJRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBncm91cCBvd25lci4gSXQncyB0aGUgcGFja2FnZSBuYW1lIHdobwogICAgICogY3JlYXRlZAogICAgICogdGhlIHN1YnNjcmlwdGlvbiBncm91cC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBHUk9VUF9PV05FUiA9IFNpbUluZm8uQ09MVU1OX0dST1VQX09XTkVSOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBwcm9maWxlIGNsYXNzIG9mIGEgc3Vic2NyaXB0aW9uCiAgICAgKiBPbmx5IHByZXNlbnQgaWYge0BsaW5rICNJU19FTUJFRERFRH0gaXMgMS4KICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBQUk9GSUxFX0NMQVNTID0gU2ltSW5mby5DT0xVTU5fUFJPRklMRV9DTEFTUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgcG9ydCBpbmRleCBvZiB0aGUgYWN0aXZlIFVJQ0MgcG9ydC4KICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBQT1JUX0lOREVYID0gU2ltSW5mby5DT0xVTU5fUE9SVF9JTkRFWDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBWb0lNUyBvcHQtaW4gc3RhdHVzLgogICAgICoKICAgICAqIDxQPgogICAgICogVHlwZTogSU5URUdFUiAoaW50KQogICAgICogPC9QPgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBWT0lNU19PUFRfSU5fU1RBVFVTID0gU2ltSW5mby5DT0xVTU5fVk9JTVNfT1BUX0lOX1NUQVRVUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBOUiBBZHZhbmNlZCBjYWxsaW5nCiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB1c2VyIGhhcyBlbmFibGVkIFZvTlIgc2V0dGluZ3MgZm9yIHRoaXMgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE5SX0FEVkFOQ0VEX0NBTExJTkdfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX05SX0FEVkFOQ0VEX0NBTExJTkdfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFByb2ZpbGUgY2xhc3Mgb2YgdGhlIHN1YnNjcmlwdGlvbgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsgIlBST0ZJTEVfQ0xBU1NfIiB9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1RFU1RJTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTCwKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1VOU0VULAogICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFByb2ZpbGVDbGFzcyB7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIHRlc3RpbmcgcHJvZmlsZSBjYW4gYmUgcHJlLWxvYWRlZCBvciBkb3dubG9hZGVkIG9udG8KICAgICAqIHRoZSBlVUlDQyBhbmQgcHJvdmlkZXMgY29ubmVjdGl2aXR5IHRvIHRlc3QgZXF1aXBtZW50CiAgICAgKiBmb3IgdGhlIHB1cnBvc2Ugb2YgdGVzdGluZyB0aGUgZGV2aWNlIGFuZCB0aGUgZVVJQ0MuIEl0CiAgICAgKiBpcyBub3QgaW50ZW5kZWQgdG8gc3RvcmUgYW55IG9wZXJhdG9yIGNyZWRlbnRpYWxzLgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQUk9GSUxFX0NMQVNTX1RFU1RJTkcgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfVEVTVElORzsKCiAgICAvKioKICAgICAqIEEgcHJvdmlzaW9uaW5nIHByb2ZpbGUgaXMgcHJlLWxvYWRlZCBvbnRvIHRoZSBlVUlDQyBhbmQKICAgICAqIHByb3ZpZGVzIGNvbm5lY3Rpdml0eSB0byBhIG1vYmlsZSBuZXR3b3JrIHNvbGVseSBmb3IgdGhlCiAgICAgKiBwdXJwb3NlIG9mIHByb3Zpc2lvbmluZyBwcm9maWxlcy4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfUFJPVklTSU9OSU5HOwoKICAgIC8qKgogICAgICogQW4gb3BlcmF0aW9uYWwgcHJvZmlsZSBjYW4gYmUgcHJlLWxvYWRlZCBvciBkb3dubG9hZGVkCiAgICAgKiBvbnRvIHRoZSBlVUlDQyBhbmQgcHJvdmlkZXMgc2VydmljZXMgcHJvdmlkZWQgYnkgdGhlCiAgICAgKiBvcGVyYXRvci4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTDsKCiAgICAvKioKICAgICAqIFRoZSBwcm9maWxlIGNsYXNzIGlzIHVuc2V0LiBUaGlzIG9jY3VycyB3aGVuIHByb2ZpbGUgY2xhc3MKICAgICAqIGluZm8gaXMgbm90IGF2YWlsYWJsZS4gVGhlIHN1YnNjcmlwdGlvbiBlaXRoZXIgaGFzIG5vIHByb2ZpbGUKICAgICAqIG1ldGFkYXRhIG9yIHRoZSBwcm9maWxlIG1ldGFkYXRhIGRpZCBub3QgZW5jb2RlIHByb2ZpbGUgY2xhc3MuCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfVU5TRVQgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfVU5TRVQ7CgogICAgLyoqCiAgICAgKiBEZWZhdWx0IHByb2ZpbGUgY2xhc3MKICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfREVGQVVMVCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19VTlNFVDsKCiAgICAvKioKICAgICAqIElNU0kgKEludGVybmF0aW9uYWwgTW9iaWxlIFN1YnNjcmliZXIgSWRlbnRpdHkpLgogICAgICogPFA+CiAgICAgKiBUeXBlOiBURVhUCiAgICAgKiA8L1A+CiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIC8vIFRPRE86IGFkZCBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJTVNJID0gU2ltSW5mby5DT0xVTU5fSU1TSTsKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdWljYyBhcHBsaWNhdGlvbnMgaXMgc2V0IHRvIGJlIGVuYWJsZWQgb3IgZGlzYWJsZWQuIEJ5IGRlZmF1bHQgaXQncwogICAgICogZW5hYmxlZC4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVUlDQ19BUFBMSUNBVElPTlNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1VJQ0NfQVBQTElDQVRJT05TX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSB3aGljaCBuZXR3b3JrIHR5cGUgaXMgYWxsb3dlZC4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUxMT1dFRF9ORVRXT1JLX1RZUEVTID0gU2ltSW5mby5DT0xVTU5fQUxMT1dFRF9ORVRXT1JLX1RZUEVTX0ZPUl9SRUFTT05TOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7ICJVU0FHRV9TRVRUSU5HXyIgfSwgdmFsdWUgPSB7CiAgICAgICAgICAgIFVTQUdFX1NFVFRJTkdfVU5LTk9XTiwKICAgICAgICAgICAgVVNBR0VfU0VUVElOR19ERUZBVUxULAogICAgICAgICAgICBVU0FHRV9TRVRUSU5HX1ZPSUNFX0NFTlRSSUMsCiAgICAgICAgICAgIFVTQUdFX1NFVFRJTkdfREFUQV9DRU5UUklDIH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBVc2FnZVNldHRpbmcgewogICAgfQoKICAgIC8qKgogICAgICogVGhlIHVzYWdlIHNldHRpbmcgaXMgdW5rbm93bi4KICAgICAqCiAgICAgKiBUaGlzIHdpbGwgYmUgdGhlIHVzYWdlIHNldHRpbmcgcmV0dXJuZWQgb24gZGV2aWNlcyB0aGF0IGRvIG5vdCBzdXBwb3J0CiAgICAgKiBxdWVyeWluZyB0aGUKICAgICAqIG9yIHNldHRpbmcgdGhlIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogSXQgbWF5IGFsc28gYmUgcHJvdmlkZWQgYnkgYSBjYXJyaWVyIHRoYXQgd2lzaGVzIHRvIHByb3ZpZGUgYSB2YWx1ZSB0byBhdm9pZAogICAgICogbWFraW5nIGFueQogICAgICogc2V0dGluZ3MgY2hhbmdlcy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVNBR0VfU0VUVElOR19VTktOT1dOID0gLTE7CgogICAgLyoqCiAgICAgKiBTdWJzY3JpcHRpb24gdXNlcyB0aGUgZGVmYXVsdCBzZXR0aW5nLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBpcyBiYXNlZCB1cG9uIGRldmljZSBjYXBhYmlsaXR5IGFuZCB0aGUgb3RoZXIgcHJvcGVydGllcyBvZiB0aGUKICAgICAqIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBNb3N0IHN1YnNjcmlwdGlvbnMgd2lsbCBkZWZhdWx0IHRvIHZvaWNlLWNlbnRyaWMgd2hlbiBpbiBhIHBob25lLgogICAgICoKICAgICAqIEFuIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHdpbGwgZGVmYXVsdCB0byBkYXRhLWNlbnRyaWMuCiAgICAgKgogICAgICoge0BzZWUgU3Vic2NyaXB0aW9uSW5mbyNpc09wcG9ydHVuaXN0aWN9CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTQUdFX1NFVFRJTkdfREVGQVVMVCA9IDA7CgogICAgLyoqCiAgICAgKiBUaGlzIHN1YnNjcmlwdGlvbiBpcyBmb3JjZWQgdG8gdm9pY2UtY2VudHJpYyBtb2RlCiAgICAgKgogICAgICogPHA+CiAgICAgKiBSZWZlciB0byB2b2ljZS1jZW50cmljIG1vZGUgaW4gM2dwcCAyNC4zMDEgc2VjIDQuMyBhbmQgM2dwcCAyNC41MDEgc2VjIDQuMy4KICAgICAqIEFsc28gcmVmZXIgdG8gIlVFJ3MgdXNhZ2Ugc2V0dGluZyIgYXMgZGVmaW5lZCBpbiAzZ3BwIDI0LjMwMSBzZWN0aW9uIDMuMSBhbmQKICAgICAqIDNncHAgMjMuMjIxCiAgICAgKiBBbm5leCBBLgogICAgICoKICAgICAqIDxwPgogICAgICogRGV2aWNlcyB0aGF0IHN1cHBvcnQge0BsaW5rIFBhY2thZ2VNYW5hZ2VyI0ZFQVRVUkVfVEVMRVBIT05ZX0NBTExJTkd9IGFuZAogICAgICogc3VwcG9ydCB1c2FnZQogICAgICogc2V0dGluZyBjb25maWd1cmF0aW9uIG11c3Qgc3VwcG9ydCBzZXR0aW5nIHRoaXMgdmFsdWUgdmlhCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NFTExVTEFSX1VTQUdFX1NFVFRJTkdfSU5UfS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVVNBR0VfU0VUVElOR19WT0lDRV9DRU5UUklDID0gMTsKCiAgICAvKioKICAgICAqIFRoaXMgc3Vic2NyaXB0aW9uIGlzIGZvcmNlZCB0byBkYXRhLWNlbnRyaWMgbW9kZQogICAgICoKICAgICAqIDxwPgogICAgICogUmVmZXIgdG8gZGF0YS1jZW50cmljIG1vZGUgaW4gM2dwcCAyNC4zMDEgc2VjIDQuMyBhbmQgM2dwcCAyNC41MDEgc2VjIDQuMy4KICAgICAqIEFsc28gcmVmZXIgdG8gIlVFJ3MgdXNhZ2Ugc2V0dGluZyIgYXMgZGVmaW5lZCBpbiAzZ3BwIDI0LjMwMSBzZWN0aW9uIDMuMSBhbmQKICAgICAqIDNncHAgMjMuMjIxCiAgICAgKiBBbm5leCBBLgogICAgICoKICAgICAqIDxwPgogICAgICogRGV2aWNlcyB0aGF0IHN1cHBvcnQge0BsaW5rIFBhY2thZ2VNYW5hZ2VyI0ZFQVRVUkVfVEVMRVBIT05ZX0RBVEF9IGFuZAogICAgICogc3VwcG9ydCB1c2FnZQogICAgICogc2V0dGluZyBjb25maWd1cmF0aW9uIG11c3Qgc3VwcG9ydCBzZXR0aW5nIHRoaXMgdmFsdWUgdmlhLgogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DRUxMVUxBUl9VU0FHRV9TRVRUSU5HX0lOVH0uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTQUdFX1NFVFRJTkdfREFUQV9DRU5UUklDID0gMjsKCiAgICAvKioKICAgICAqIEluZGljYXRlIHRoZSBwcmVmZXJyZWQgdXNhZ2Ugc2V0dGluZyBmb3IgdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiAwIC0gRGVmYXVsdCAtIElmIHRoZSB2YWx1ZSBoYXMgbm90IGJlZW4gZXhwbGljaXRseSBzZXQsIGl0IHdpbGwgYmUgImRlZmF1bHQiCiAgICAgKiAxIC0gVm9pY2UtY2VudHJpYwogICAgICogMiAtIERhdGEtY2VudHJpYwogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFVTQUdFX1NFVFRJTkcgPSBTaW1JbmZvLkNPTFVNTl9VU0FHRV9TRVRUSU5HOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogVGhlIHVzZXIgaGFzIGNoYW5nZWQgb25lIG9mIHRoZSBkZWZhdWx0IHN1YnMgcmVsYXRlZCB0bwogICAgICogZGF0YSwgcGhvbmUgY2FsbHMsIG9yIHNtcwogICAgICogPC9wPgogICAgICoKICAgICAqIFRPRE86IENoYW5nZSB0byBhIGxpc3RlbmVyCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBTVUJfREVGQVVMVF9DSEFOR0VEX0FDVElPTiA9ICJhbmRyb2lkLmludGVudC5hY3Rpb24uU1VCX0RFRkFVTFRfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuIFRoaXMgaGFzIHRoZQogICAgICogZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6CiAgICAgKiA8L3A+CiAgICAgKiBUaGUge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IGV4dHJhIGluZGljYXRlcyB0aGUgY3VycmVudCBkZWZhdWx0CiAgICAgKiBzdWJzY3JpcHRpb24gaW5kZXgKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VEID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBkZWZhdWx0IHNtcyBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuIFRoaXMgaGFzIHRoZQogICAgICogZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6CiAgICAgKiA8L3A+CiAgICAgKiB7QGxpbmsgI0VYVFJBX1NVQlNDUklQVElPTl9JTkRFWH0gZXh0cmEgaW5kaWNhdGVzIHRoZSBjdXJyZW50IGRlZmF1bHQgc21zCiAgICAgKiBzdWJzY3JpcHRpb24gaW5kZXgKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1NNU19TVUJTQ1JJUFRJT05fQ0hBTkdFRCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uREVGQVVMVF9TTVNfU1VCU0NSSVBUSU9OX0NIQU5HRUQiOwoKICAgIC8qKgogICAgICogQWN0aXZpdHkgQWN0aW9uOiBEaXNwbGF5IFVJIGZvciBtYW5hZ2luZyB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbnMKICAgICAqIGJldHdlZW4gYSBjYXJyaWVyIGFuZCBhIHNwZWNpZmljIHN1YnNjcmliZXIuCiAgICAgKiA8cD4KICAgICAqIENhcnJpZXIgYXBwcyBhcmUgZW5jb3VyYWdlZCB0byBpbXBsZW1lbnQgdGhpcyBhY3Rpdml0eSwgYW5kIHRoZSBPUyB3aWxsCiAgICAgKiBwcm92aWRlIGFuIGFmZm9yZGFuY2UgdG8gcXVpY2tseSBlbnRlciB0aGlzIGFjdGl2aXR5LCB0eXBpY2FsbHkgdmlhCiAgICAgKiBTZXR0aW5ncy4gVGhpcyBhZmZvcmRhbmNlIHdpbGwgb25seSBiZSBzaG93biB3aGVuIHRoZSBjYXJyaWVyIGFwcCBpcwogICAgICogYWN0aXZlbHkgcHJvdmlkaW5nIHN1YnNjcmlwdGlvbiBwbGFuIGluZm9ybWF0aW9uIHZpYQogICAgICoge0BsaW5rICNzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQsIExpc3QpfS4KICAgICAqIDxwPgogICAgICogQ29udGFpbnMge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IHRvIGluZGljYXRlIHdoaWNoIHN1YnNjcmlwdGlvbgogICAgICogdGhlIHVzZXIgaXMgaW50ZXJlc3RlZCBpbi4KICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5BQ1RJVklUWV9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX01BTkFHRV9TVUJTQ1JJUFRJT05fUExBTlMgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLk1BTkFHRV9TVUJTQ1JJUFRJT05fUExBTlMiOwoKICAgIC8qKgogICAgICogQnJvYWRjYXN0IEFjdGlvbjogUmVxdWVzdCBhIHJlZnJlc2ggb2YgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW5zCiAgICAgKiBiZXR3ZWVuIGEgY2FycmllciBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBDYXJyaWVyIGFwcHMgYXJlIGVuY291cmFnZWQgdG8gaW1wbGVtZW50IHRoaXMgcmVjZWl2ZXIsIGFuZCB0aGUgT1Mgd2lsbAogICAgICogcHJvdmlkZSBhbiBhZmZvcmRhbmNlIHRvIHJlcXVlc3QgYSByZWZyZXNoLiBUaGlzIGFmZm9yZGFuY2Ugd2lsbCBvbmx5IGJlCiAgICAgKiBzaG93biB3aGVuIHRoZSBjYXJyaWVyIGFwcCBpcyBhY3RpdmVseSBwcm92aWRpbmcgc3Vic2NyaXB0aW9uIHBsYW4KICAgICAqIGluZm9ybWF0aW9uIHZpYSB7QGxpbmsgI3NldFN1YnNjcmlwdGlvblBsYW5zKGludCwgTGlzdCl9LgogICAgICogPHA+CiAgICAgKiBDb250YWlucyB7QGxpbmsgI0VYVFJBX1NVQlNDUklQVElPTl9JTkRFWH0gdG8gaW5kaWNhdGUgd2hpY2ggc3Vic2NyaXB0aW9uCiAgICAgKiB0aGUgdXNlciBpcyBpbnRlcmVzdGVkIGluLgogICAgICogPHA+CiAgICAgKiBSZWNlaXZlcnMgc2hvdWxkIHByb3RlY3QgdGhlbXNlbHZlcyBieSBjaGVja2luZyB0aGF0IHRoZSBzZW5kZXIgaG9sZHMgdGhlCiAgICAgKiB7QGNvZGUgYW5kcm9pZC5wZXJtaXNzaW9uLk1BTkFHRV9TVUJTQ1JJUFRJT05fUExBTlN9IHBlcm1pc3Npb24uCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fUkVGUkVTSF9TVUJTQ1JJUFRJT05fUExBTlMgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLlJFRlJFU0hfU1VCU0NSSVBUSU9OX1BMQU5TIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFucyBiZXR3ZWVuIGEgY2FycmllciBhbmQgYQogICAgICogc3BlY2lmaWMgc3Vic2NyaWJlciBoYXMgY2hhbmdlZC4KICAgICAqIDxwPgogICAgICogQ29udGFpbnMge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IHRvIGluZGljYXRlIHdoaWNoIHN1YnNjcmlwdGlvbgogICAgICogY2hhbmdlZC4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1BTkFHRV9TVUJTQ1JJUFRJT05fUExBTlMpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fU1VCU0NSSVBUSU9OX1BMQU5TX0NIQU5HRUQgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLlNVQlNDUklQVElPTl9QTEFOU19DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEludGVnZXIgZXh0cmEgdXNlZCB3aXRoIHtAbGluayAjQUNUSU9OX0RFRkFVTFRfU1VCU0NSSVBUSU9OX0NIQU5HRUR9IGFuZAogICAgICoge0BsaW5rICNBQ1RJT05fREVGQVVMVF9TTVNfU1VCU0NSSVBUSU9OX0NIQU5HRUR9IHRvIGluZGljYXRlIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIHdoaWNoIGhhcyBjaGFuZ2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVggPSAiYW5kcm9pZC50ZWxlcGhvbnkuZXh0cmEuU1VCU0NSSVBUSU9OX0lOREVYIjsKCiAgICAvKioKICAgICAqIEludGVnZXIgZXh0cmEgdG8gc3BlY2lmeSBTSU0gc2xvdCBpbmRleC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRVhUUkFfU0xPVF9JTkRFWCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TTE9UX0lOREVYIjsKCiAgICAvKioKICAgICAqIEEgc291cmNlIG9mIHBob25lIG51bWJlcjogdGhlIEVGLU1TSVNETiAoc2VlIDNHUFAgVFMgMzEuMTAyKSwKICAgICAqIG9yIEVGLU1ETiBmb3IgQ0RNQSAoc2VlIDNHUFAyIEMuUDAwNjUtQiksIGZyb20gVUlDQyBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSBhdmFpbGFiaWxpdHkgYW5kIGEgb2YgdGhlIG51bWJlciBkZXBlbmRzIG9uIHRoZSBjYXJyaWVyLgogICAgICogVGhlIG51bWJlciBtYXkgYmUgdXBkYXRlZCBieSBvdmVyLXRoZS1haXIgdXBkYXRlIHRvIFVJQ0MgYXBwbGljYXRpb25zCiAgICAgKiBmcm9tIHRoZSBjYXJyaWVyLCBvciBieSBvdGhlciBtZWFucyB3aXRoIHBoeXNpY2FsIGFjY2VzcyB0byB0aGUgU0lNLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgPSAxOwoKICAgIC8qKgogICAgICogQSBzb3VyY2Ugb2YgcGhvbmUgbnVtYmVyOiBwcm92aWRlZCBieSBhbiBhcHAgdGhhdCBoYXMgY2FycmllciBwcml2aWxlZ2UuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBUaGUgbnVtYmVyIGlzIGludGVuZGVkIHRvIGJlIHNldCBieSBhIGNhcnJpZXIgYXBwIGtub3dpbmcgdGhlIGNvcnJlY3QgbnVtYmVyCiAgICAgKiB3aGljaCBpcywgZm9yIGV4YW1wbGUsIGRpZmZlcmVudCBmcm9tIHRoZSBudW1iZXIgaW4KICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9CiAgICAgKiBmb3Igc29tZSByZWFzb24uCiAgICAgKiBUaGUgbnVtYmVyIGlzIG5vdCBhdmFpbGFibGUgdW50aWwgYSBjYXJyaWVyIGFwcCBzZXRzIG9uZSB2aWEKICAgICAqIHtAbGluayAjc2V0Q2FycmllclBob25lTnVtYmVyKGludCwgU3RyaW5nKX0uCiAgICAgKiBUaGUgYXBwIGNhbiB1cGRhdGUgdGhlIG51bWJlciB3aXRoIHRoZSBzYW1lIEFQSSBzaG91bGQgdGhlIG51bWJlciBjaGFuZ2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiA9IDI7CgogICAgLyoqCiAgICAgKiBBIHNvdXJjZSBvZiBwaG9uZSBudW1iZXI6IHByb3ZpZGVkIGJ5IElNUyAoSVAgTXVsdGltZWRpYSBTdWJzeXN0ZW0pCiAgICAgKiBpbXBsZW1lbnRhdGlvbi4KICAgICAqIFdoZW4gSU1TIHNlcnZpY2UgaXMgcmVnaXN0ZXJlZCAoYXMgaW5kaWNhdGVkIGJ5CiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLlJlZ2lzdHJhdGlvbk1hbmFnZXIuUmVnaXN0cmF0aW9uQ2FsbGJhY2sjb25SZWdpc3RlcmVkKGludCl9KQogICAgICogdGhlIElNUyBpbXBsZW1lbnRhdGlvbiBtYXkgcmV0dXJuIFAtQXNzb2NpYXRlZC1VcmkgU0lQIGhlYWRlcnMgKFJGQyAzNDU1KS4KICAgICAqIFRoZSBVUklzCiAgICAgKiBhcmUgdGhlIHVzZXLigJlzIHB1YmxpYyB1c2VyIGlkZW50aXRpZXMga25vd24gdG8gdGhlIG5ldHdvcmsgKHNlZSAzR1BQIFRTCiAgICAgKiAyNC4yMjkgNS40LjEuMiksCiAgICAgKiBhbmQgdGhlIHBob25lIG51bWJlciBpcyB0eXBpY2FsbHkgb25lIG9mIHRoZW0gKHNlZSDigJxnbG9iYWwgbnVtYmVy4oCdIGluIDNHUFAgVFMKICAgICAqIDIzLjAwMyAxMy40KS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoaXMgc291cmNlIHByb3ZpZGVzIHRoZSBwaG9uZSBudW1iZXIgZnJvbSB0aGUgbGFzdCBJTVMgcmVnaXN0cmF0aW9uLgogICAgICogSU1TIHJlZ2lzdHJhdGlvbiBtYXkgaGFwcGVuIG9uIGV2ZXJ5IGRldmljZSByZWJvb3Qgb3Igb3RoZXIgbmV0d29yayBjb25kaXRpb24KICAgICAqIGNoYW5nZXMuCiAgICAgKiBUaGUgbnVtYmVyIHdpbGwgYmUgdXBkYXRlZCBzaG91bGQgdGhlIGFzc29jaWF0ZWQgVVJJIGNoYW5nZSBhZnRlciBhbiBJTVMKICAgICAqIHJlZ2lzdHJhdGlvbi4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVMgPSAzOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7ICJQSE9ORV9OVU1CRVJfU09VUkNFIiB9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDLAogICAgICAgICAgICBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIsCiAgICAgICAgICAgIFBIT05FX05VTUJFUl9TT1VSQ0VfSU1TLAogICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFBob25lTnVtYmVyU291cmNlIHsKICAgIH0KCiAgICBwcml2YXRlIGZpbmFsIENvbnRleHQgbUNvbnRleHQ7CgogICAgLy8gQ2FjaGUgb2YgUmVzb3VyY2UgdGhhdCBoYXMgYmVlbiBjcmVhdGVkIGluIGdldFJlc291cmNlc0ZvclN1YklkLiBLZXkgaXMgYQogICAgLy8gUGFpciBjb250YWluaW5nCiAgICAvLyB0aGUgQ29udGV4dCBhbmQgc3ViSWQuCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBNYXA8UGFpcjxDb250ZXh0LCBJbnRlZ2VyPiwgUmVzb3VyY2VzPiBzUmVzb3VyY2VzQ2FjaGUgPSBuZXcgQ29uY3VycmVudEhhc2hNYXA8PigpOwoKICAgIC8qKgogICAgICogQSBsaXN0ZW5lciBjbGFzcyBmb3IgbW9uaXRvcmluZyBjaGFuZ2VzIHRvIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzLgogICAgICogPHA+CiAgICAgKiBPdmVycmlkZSB0aGUgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBtZXRob2QgaW4gdGhlIG9iamVjdCB0aGF0IGV4dGVuZHMgdGhpcwogICAgICogY2xhc3MgYW5kIHBhc3MgaXQgdG8KICAgICAqIHtAbGluayAjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9CiAgICAgKiB0byByZWdpc3RlciB5b3VyIGxpc3RlbmVyIGFuZCB0byB1bnJlZ2lzdGVyIGludm9rZQogICAgICoge0BsaW5rICNyZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciAjb25TdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciB7CiAgICAgICAgcHJpdmF0ZSBjbGFzcyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyIGV4dGVuZHMgSGFuZGxlciB7CiAgICAgICAgICAgIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lckhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKExvb3BlciBsb29wZXIpIHsKICAgICAgICAgICAgICAgIHN1cGVyKGxvb3Blcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFBvc3RlZCBleGVjdXRvciBjYWxsYmFjayBvbiB0aGUgaGFuZGxlciBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBsb29wZXIuCiAgICAgICAgICogVGhlIGxvb3BlciBjYW4gYmUgdGhlIGNhbGxpbmcgdGhyZWFkJ3MgbG9vcGVyIG9yIHRoZSBsb29wZXIgcGFzc2VkIGZyb20gdGhlCiAgICAgICAgICogY29uc3RydWN0b3Ige0BsaW5rICNPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyKX0uCiAgICAgICAgICovCiAgICAgICAgcHJpdmF0ZSBmaW5hbCBIYW5kbGVyRXhlY3V0b3IgbUV4ZWN1dG9yOwoKICAgICAgICAvKioKICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBIYW5kbGVyRXhlY3V0b3IgZ2V0SGFuZGxlckV4ZWN1dG9yKCkgewogICAgICAgICAgICByZXR1cm4gbUV4ZWN1dG9yOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigpIHsKICAgICAgICAgICAgbUV4ZWN1dG9yID0gbmV3IEhhbmRsZXJFeGVjdXRvcihuZXcgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVySGFuZGxlcigpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEFsbG93IGEgbGlzdGVuZXIgdG8gYmUgY3JlYXRlZCB3aXRoIGEgY3VzdG9tIGxvb3BlcgogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSBsb29wZXIgdGhlIGxvb3BlciB0aGF0IHRoZSB1bmRlcmxpbmluZyBoYW5kbGVyIHNob3VsZCBydW4gb24KICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyIGxvb3BlcikgewogICAgICAgICAgICBtRXhlY3V0b3IgPSBuZXcgSGFuZGxlckV4ZWN1dG9yKG5ldyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKGxvb3BlcikpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIHRoZXJlIGlzIGFueSBjaGFuZ2UgdG8gYW55IFN1YnNjcmlwdGlvbkluZm8sIGFzIHdlbGwgYXMKICAgICAgICAgKiBvbmNlIG9uCiAgICAgICAgICogcmVnaXN0ZXJpbmcgZm9yIGNoYW5nZXMgd2l0aCB7QGxpbmsgI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0uCiAgICAgICAgICogVHlwaWNhbGx5CiAgICAgICAgICogdGhpcyBtZXRob2Qgd291bGQgaW52b2tlIHtAbGluayAjZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3R9CiAgICAgICAgICovCiAgICAgICAgcHVibGljIHZvaWQgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCgpIHsKICAgICAgICAgICAgaWYgKERCRykKICAgICAgICAgICAgICAgIGxvZygib25TdWJzY3JpcHRpb25zQ2hhbmdlZDogTk9UIE9WRVJSSURERU4iKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbgogICAgICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgKiBFeGVjdXRvciwgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0gb3IKICAgICAgICAgKiB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICogT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0gZmFpbHMgdG8gY29tcGxldGUgZHVlIHRvIHRoZQogICAgICAgICAqIHtAbGluayBDb250ZXh0I1RFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFfSBiZWluZyB1bmF2YWlsYWJsZS4KICAgICAgICAgKiAKICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyB2b2lkIG9uQWRkTGlzdGVuZXJGYWlsZWQoKSB7CiAgICAgICAgICAgIFJsb2cudyhMT0dfVEFHLCAib25BZGRMaXN0ZW5lckZhaWxlZCBub3Qgb3ZlcnJpZGRlbiIpOwogICAgICAgIH0KCiAgICAgICAgcHJpdmF0ZSB2b2lkIGxvZyhTdHJpbmcgcykgewogICAgICAgICAgICBSbG9nLmQoTE9HX1RBRywgcyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25NYW5hZ2VyKENvbnRleHQgY29udGV4dCkgewogICAgICAgIGlmIChEQkcpCiAgICAgICAgICAgIGxvZ2QoIlN1YnNjcmlwdGlvbk1hbmFnZXIgY3JlYXRlZCIpOwogICAgICAgIG1Db250ZXh0ID0gY29udGV4dDsKICAgIH0KCiAgICBwcml2YXRlIE5ldHdvcmtQb2xpY3lNYW5hZ2VyIGdldE5ldHdvcmtQb2xpY3lNYW5hZ2VyKCkgewogICAgICAgIHJldHVybiAoTmV0d29ya1BvbGljeU1hbmFnZXIpIG1Db250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0Lk5FVFdPUktfUE9MSUNZX1NFUlZJQ0UpOwogICAgfQoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgZGV2ZWxvcGVycyBzaG91bGQgYWx3YXlzIG9idGFpbiByZWZlcmVuY2VzIGRpcmVjdGx5IGZyb20KICAgICAqICAgICAgICAgICAgIHtAbGluayBDb250ZXh0I2dldFN5c3RlbVNlcnZpY2UoQ2xhc3MpfS4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBzdGF0aWMgU3Vic2NyaXB0aW9uTWFuYWdlciBmcm9tKENvbnRleHQgY29udGV4dCkgewogICAgICAgIHJldHVybiAoU3Vic2NyaXB0aW9uTWFuYWdlcikgY29udGV4dAogICAgICAgICAgICAgICAgLmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU1VCU0NSSVBUSU9OX1NFUlZJQ0UpOwogICAgfQoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgZm9yIGNoYW5nZXMgdG8gdGhlIGxpc3Qgb2YgYWN0aXZlIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzCiAgICAgKiBvciB0byB0aGUKICAgICAqIGluZGl2aWR1YWwgcmVjb3JkcyB0aGVtc2VsdmVzLiBXaGVuIGEgY2hhbmdlIG9jY3VycyB0aGUKICAgICAqIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIG9mCiAgICAgKiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBpbnZva2VkIGltbWVkaWF0ZWx5IGlmIHRoZXJlIGhhcyBiZWVuIGEgbm90aWZpY2F0aW9uLgogICAgICogVGhlCiAgICAgKiBvblN1YnNjcmlwdGlvbkNoYW5nZWQgbWV0aG9kIHdpbGwgYWxzbyBiZSB0cmlnZ2VyZWQgb25jZSBpbml0aWFsbHkgd2hlbgogICAgICogY2FsbGluZyB0aGlzCiAgICAgKiBmdW5jdGlvbi4gVGhlIGNhbGxiYWNrIHdpbGwgYmUgaW52b2tlZCBvbiB0aGUgbG9vcGVyIHNwZWNpZmllZCBpbiB0aGUKICAgICAqIGxpc3RlbmVyJ3MgY29uc3RydWN0b3IuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG92ZXJyaWRkZW4uCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgV2lsbCBnZXQgZXhjZXB0aW9uIGlmIHRoZSBwYXJhbWV0ZXIgbGlzdGVuZXIgaXMgbm90IGluaXRpYWxpemVkCiAgICAgKiAgICAgICAgICAgICB3aXRoIGEgTG9vcGVyLgogICAgICogICAgICAgICAgICAgVXNlCiAgICAgKiAgICAgICAgICAgICB7QGxpbmsgI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihFeGVjdXRvciwgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0uCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgdm9pZCBhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICAgICAgaWYgKGxpc3RlbmVyID09IG51bGwpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIobGlzdGVuZXIubUV4ZWN1dG9yLCBsaXN0ZW5lcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBhY3RpdmUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMKICAgICAqIG9yIHRvIHRoZQogICAgICogaW5kaXZpZHVhbCByZWNvcmRzIHRoZW1zZWx2ZXMuIFdoZW4gYSBjaGFuZ2Ugb2NjdXJzIHRoZQogICAgICogb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBtZXRob2Qgb2YKICAgICAqIHRoZSBsaXN0ZW5lciB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkgaWYgdGhlcmUgaGFzIGJlZW4gYSBub3RpZmljYXRpb24uCiAgICAgKiBUaGUKICAgICAqIG9uU3Vic2NyaXB0aW9uQ2hhbmdlZCBtZXRob2Qgd2lsbCBhbHNvIGJlIHRyaWdnZXJlZCBvbmNlIGluaXRpYWxseSB3aGVuCiAgICAgKiBjYWxsaW5nIHRoaXMKICAgICAqIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lciBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB3aXRoCiAgICAgKiAgICAgICAgICAgICAgICAgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICogQHBhcmFtIGV4ZWN1dG9yIHRoZSBleGVjdXRvciB0aGF0IHdpbGwgZXhlY3V0ZSBjYWxsYmFja3MuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIGFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgQE5vbk51bGwgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsCiAgICAgICAgICAgIEBOb25OdWxsIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIFN0cmluZyBwa2dOYW1lID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgicmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2UgdXNlIHRoZSBUZWxlcGhvbnlSZWdpc3RyeSBhcyBpdCBydW5zIGluIHRoZSBzeXN0ZW0gYW5kIHRodXMgaXMgYWx3YXlzCiAgICAgICAgLy8gYXZhaWxhYmxlLiBXaGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpIG1Db250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLmFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lciwKICAgICAgICAgICAgICAgICAgICBleGVjdXRvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHRlbGVwaG9ueSByZWdpc3RyeSBpc24ndCBhdmFpbGFibGUsIHdlIHdpbGwgaW5mb3JtIHRoZSBjYWxsZXIgb24gdGhlaXIKICAgICAgICAgICAgLy8gbGlzdGVuZXIgdGhhdCBpdCBmYWlsZWQgc28gdGhleSBjYW4gdHJ5IHRvIHJlLXJlZ2lzdGVyLgogICAgICAgICAgICBsb2dlKCJhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXI6IHBrZ25hbWU9IiArIHBrZ05hbWUgKyAiIGZhaWxlZCB0byBiZSBhZGRlZCAiCiAgICAgICAgICAgICAgICAgICAgKyAiIGR1ZSB0byBURUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSBiZWluZyB1bmF2YWlsYWJsZS4iKTsKICAgICAgICAgICAgZXhlY3V0b3IuZXhlY3V0ZSgoKSAtPiBsaXN0ZW5lci5vbkFkZExpc3RlbmVyRmFpbGVkKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVucmVnaXN0ZXIgdGhlIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9LiBUaGlzIGlzIG5vdCBzdHJpY3RseQogICAgICogbmVjZXNzYXJ5CiAgICAgKiBhcyB0aGUgbGlzdGVuZXIgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHVucmVnaXN0ZXJlZCBpZiBhbiBhdHRlbXB0IHRvIGludm9rZQogICAgICogdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInVucmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIgKyBwa2dGb3JEZWJ1ZwogICAgICAgICAgICAgICAgICAgICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICAvLyBXZSB1c2UgdGhlIFRlbGVwaG9ueVJlZ2lzdHJ5IGFzIGl0IHJ1bnMgaW4gdGhlIHN5c3RlbSBhbmQgdGh1cyBpcyBhbHdheXMKICAgICAgICAvLyBhdmFpbGFibGUgd2hlcmUgYXMgU3Vic2NyaXB0aW9uQ29udHJvbGxlciBjb3VsZCBjcmFzaCBhbmQgbm90IGJlIGF2YWlsYWJsZQogICAgICAgIFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgPSAoVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyKSBtQ29udGV4dAogICAgICAgICAgICAgICAgLmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSk7CiAgICAgICAgaWYgKHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciAhPSBudWxsKSB7CiAgICAgICAgICAgIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlci5yZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIobGlzdGVuZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgY2xhc3MgZm9yIG1vbml0b3JpbmcgY2hhbmdlcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcwogICAgICogb2Ygb3Bwb3J0dW5pc3RpYwogICAgICogc3Vic2NyaXB0aW9ucy4KICAgICAqIDxwPgogICAgICogT3ZlcnJpZGUgdGhlIG9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkIG1ldGhvZCBpbiB0aGUgb2JqZWN0IHRoYXQKICAgICAqIGV4dGVuZHMgdGhpcwogICAgICogb3Ige0BsaW5rICNhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICogRXhlY3V0b3IsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogdG8gcmVnaXN0ZXIgeW91ciBsaXN0ZW5lciBhbmQgdG8gdW5yZWdpc3RlciBpbnZva2UKICAgICAqIHtAbGluayAjcmVtb3ZlT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAqIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogPHA+CiAgICAgKiBQZXJtaXNzaW9ucyBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgewogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhbnkgY2hhbmdlIHRvIGFueSBTdWJzY3JpcHRpb25JbmZvLiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCgpIHsKICAgICAgICAgICAgaWYgKERCRykKICAgICAgICAgICAgICAgIGxvZygib25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQ6IE5PVCBPVkVSUklEREVOIik7CiAgICAgICAgfQoKICAgICAgICBwcml2YXRlIHZvaWQgbG9nKFN0cmluZyBzKSB7CiAgICAgICAgICAgIFJsb2cuZChMT0dfVEFHLCBzKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiByZWNvcmRzIG9yIHRvCiAgICAgKiB0aGUKICAgICAqIGluZGl2aWR1YWwgcmVjb3JkcyB0aGVtc2VsdmVzLiBXaGVuIGEgY2hhbmdlIG9jY3VycyB0aGUKICAgICAqIG9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkCiAgICAgKiBtZXRob2Qgb2YgdGhlIGxpc3RlbmVyIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBpZiB0aGVyZSBoYXMgYmVlbiBhCiAgICAgKiBub3RpZmljYXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mCiAgICAgKiAgICAgICAgICAgICAgICAge0BsaW5rIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAgICBATm9uTnVsbCBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE5vbk51bGwgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGxpc3RlbmVyID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgU3RyaW5nIHBrZ05hbWUgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICBsb2dkKCJyZWdpc3RlciBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CgogICAgICAgIC8vIFdlIHVzZSB0aGUgVGVsZXBob255UmVnaXN0cnkgYXMgaXQgcnVucyBpbiB0aGUgc3lzdGVtIGFuZCB0aHVzIGlzIGFsd2F5cwogICAgICAgIC8vIGF2YWlsYWJsZSB3aGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpIG1Db250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLmFkZE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIsIGV4ZWN1dG9yKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVbnJlZ2lzdGVyIHRoZSB7QGxpbmsgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0gdGhhdCBpcwogICAgICogY3VycmVudGx5CiAgICAgKiBsaXN0ZW5pbmcgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGNoYW5nZS4gVGhpcyBpcyBub3Qgc3RyaWN0bHkgbmVjZXNzYXJ5CiAgICAgKiBhcyB0aGUgbGlzdGVuZXIgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHVucmVnaXN0ZXJlZCBpZiBhbiBhdHRlbXB0IHRvIGludm9rZQogICAgICogdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgIEBOb25OdWxsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChsaXN0ZW5lciwgImxpc3RlbmVyIGNhbm5vdCBiZSBudWxsIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgidW5yZWdpc3RlciBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIKICAgICAgICAgICAgICAgICAgICArIHBrZ0ZvckRlYnVnICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICBUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyID0gKFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlcikgbUNvbnRleHQKICAgICAgICAgICAgICAgIC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIucmVtb3ZlT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBhY3RpdmUgU3Vic2NyaXB0aW9uSW5mbyB3aXRoIHRoZSBpbnB1dCBzdWJJZC4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURQogICAgICogUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGtleSBpbiBkYXRhYmFzZS4KICAgICAqIEByZXR1cm4gU3Vic2NyaXB0aW9uSW5mbywgbWF5YmUgbnVsbCBpZiBpdHMgbm90IGFjdGl2ZS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKQogICAgICAgICAgICBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb10rIHN1YklkPSIgKyBzdWJJZCk7CiAgICAgICAgaWYgKCFpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoc3ViSWQpKSB7CiAgICAgICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvXS0gaW52YWxpZCBzdWJJZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3Vic2NyaXB0aW9uSW5mbyBzdWJJbmZvID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YkluZm8gPSBpU3ViLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3ViSW5mbzsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgYW4gYWN0aXZlIFN1YnNjcmlwdGlvbkluZm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IGFzc29jaWF0ZWQgd2l0aCB0aGUKICAgICAqIFNpbSBJY2NJZC4KICAgICAqCiAgICAgKiBAcGFyYW0gaWNjSWQgdGhlIEljY0lkIG9mIFNJTSBjYXJkCiAgICAgKiBAcmV0dXJuIFN1YnNjcmlwdGlvbkluZm8sIG1heWJlIG51bGwgaWYgaXRzIG5vdCBhY3RpdmUKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBATnVsbGFibGUKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JJY2MoQE5vbk51bGwgU3RyaW5nIGljY0lkKSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9ySWNjSW5kZXhdKyBpY2NJZD0iICsgaWNjSWQpOwogICAgICAgIGlmIChpY2NJZCA9PSBudWxsKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9ySWNjSW5kZXhdLSBudWxsIGljY2lkIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3Vic2NyaXB0aW9uSW5mbyByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9ySWNjSWQoaWNjSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBhY3RpdmUgU3Vic2NyaXB0aW9uSW5mbyBhc3NvY2lhdGVkIHdpdGggdGhlIHNsb3RJbmRleAogICAgICoKICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFCiAgICAgKiBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzbG90SW5kZXggdGhlIHNsb3Qgd2hpY2ggdGhlIHN1YnNjcmlwdGlvbiBpcyBpbnNlcnRlZAogICAgICogQHJldHVybiBTdWJzY3JpcHRpb25JbmZvLCBtYXliZSBudWxsIGlmIGl0cyBub3QgYWN0aXZlCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9yU2ltU2xvdEluZGV4XSsgc2xvdEluZGV4PSIgKyBzbG90SW5kZXgpOwogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9yU2ltU2xvdEluZGV4XS0gaW52YWxpZCBzbG90SW5kZXgiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBTdWJzY3JpcHRpb25JbmZvIHJlc3VsdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JTaW1TbG90SW5kZXgoc2xvdEluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gTGlzdCBvZiBhbGwgU3Vic2NyaXB0aW9uSW5mbyByZWNvcmRzIGluIGRhdGFiYXNlLAogICAgICogICAgICAgICBpbmNsdWRlIHRob3NlIHRoYXQgd2VyZSBpbnNlcnRlZCBiZWZvcmUsIG1heWJlIGVtcHR5IGJ1dCBub3QgbnVsbC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QWxsU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoIltnZXRBbGxTdWJzY3JpcHRpb25JbmZvTGlzdF0rIik7CgogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWxsU3ViSW5mb0xpc3QobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmIChyZXN1bHQgPT0gbnVsbCkgewogICAgICAgICAgICByZXN1bHQgPSBDb2xsZWN0aW9ucy5lbXB0eUxpc3QoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgU3Vic2NyaXB0aW9uSW5mbyhzKSBvZiB0aGUgY3VycmVudGx5IGFjdGl2ZSBTSU0ocykuIFRoZSByZWNvcmRzIHdpbGwKICAgICAqIGJlIHNvcnRlZAogICAgICogYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fSB0aGVuIGJ5CiAgICAgKiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogPHA+CiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUKICAgICAqIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuIEluIHRoZSBsYXR0ZXIgY2FzZSwgb25seQogICAgICogcmVjb3JkcyBhY2Nlc3NpYmxlCiAgICAgKiB0byB0aGUgY2FsbGluZyBhcHAgYXJlIHJldHVybmVkLgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnRseSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcwogICAgICogICAgICAgICBhdmFpbGFibGUgb24gdGhlIGRldmljZS4KICAgICAqICAgICAgICAgPHVsPgogICAgICogICAgICAgICA8bGk+CiAgICAgKiAgICAgICAgIElmIG51bGwgaXMgcmV0dXJuZWQgdGhlIGN1cnJlbnQgc3RhdGUgaXMgdW5rbm93biBidXQgaWYgYQogICAgICogICAgICAgICB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfQogICAgICogICAgICAgICBoYXMgYmVlbiByZWdpc3RlcmVkCiAgICAgKiAgICAgICAgIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZQogICAgICogICAgICAgICBpbnZva2VkIGluIHRoZSBmdXR1cmUuCiAgICAgKiAgICAgICAgIDwvbGk+CiAgICAgKiAgICAgICAgIDxsaT4KICAgICAqICAgICAgICAgSWYgdGhlIGxpc3QgaXMgZW1wdHkgdGhlbiB0aGVyZSBhcmUgbm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99CiAgICAgKiAgICAgICAgIHJlY29yZHMgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqICAgICAgICAgPC9saT4KICAgICAqICAgICAgICAgPGxpPgogICAgICogICAgICAgICBpZiB0aGUgbGlzdCBpcyBub24tZW1wdHkgdGhlIGxpc3QgaXMgc29ydGVkIGJ5CiAgICAgKiAgICAgICAgIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0KICAgICAqICAgICAgICAgdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKiAgICAgICAgIDwvbGk+CiAgICAgKiAgICAgICAgIDwvdWw+CiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KC8qIHVzZXJWaXNpYmxlb25seSAqL3RydWUpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IGJvdGggaGlkZGVuIGFuZCB2aXNpYmxlIFN1YnNjcmlwdGlvbkluZm8ocykgb2YgdGhlIGN1cnJlbnRseSBhY3RpdmUKICAgICAqIFNJTShzKS4KICAgICAqIFRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0KICAgICAqIHRoZW4gYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEhpZGRlbiBzdWJzY3JpcHRpb25zIHJlZmVyIHRvIHRob3NlIGFyZSBub3QgbWVhbnQgdmlzaWJsZSB0byB0aGUgdXNlcnMuCiAgICAgKiBGb3IgZXhhbXBsZSwgYW4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gdGhhdCBpcyBncm91cGVkIHdpdGggb3RoZXIKICAgICAqIHN1YnNjcmlwdGlvbnMgc2hvdWxkIHJlbWFpbiBpbnZpc2libGUgdG8gdXNlcnMgYXMgdGhleSBhcmUgb25seSBmdW5jdGlvbmFsbHkKICAgICAqIHN1cHBsZW1lbnRhcnkgdG8gcHJpbWFyeSBvbmVzLgogICAgICoKICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFCiAgICAgKiBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIG9ubHkKICAgICAqIHJlY29yZHMgYWNjZXNzaWJsZQogICAgICogdG8gdGhlIGNhbGxpbmcgYXBwIGFyZSByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAcmV0dXJuIFNvcnRlZCBsaXN0IG9mIHRoZSBjdXJyZW50bHkgYXZhaWxhYmxlIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfQogICAgICogICAgICAgICByZWNvcmRzIG9uIHRoZSBkZXZpY2UuCiAgICAgKiAgICAgICAgIFRoaXMgaXMgc2ltaWxhciB0byB7QGxpbmsgI2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0fSBleGNlcHQgdGhhdAogICAgICogICAgICAgICBpdCB3aWxsIHJldHVybgogICAgICogICAgICAgICBib3RoIGFjdGl2ZSBhbmQgaGlkZGVuIFN1YnNjcmlwdGlvbkluZm9zLgogICAgICoKICAgICAqLwogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0Q29tcGxldGVBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGNvbXBsZXRlTGlzdCA9IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KAogICAgICAgICAgICAgICAgLyogdXNlclZpc2libGVvbmx5ICovZmFsc2UpOwogICAgICAgIGlmIChjb21wbGV0ZUxpc3QgPT0gbnVsbCkgewogICAgICAgICAgICBjb21wbGV0ZUxpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBsZXRlTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgaXMgc2ltaWxhciB0byB7QGxpbmsgI2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCl9LCBidXQgaWYKICAgICAqIHVzZXJWaXNpYmxlT25seQogICAgICogaXMgdHJ1ZSwgaXQgd2lsbCBmaWx0ZXIgb3V0IHRoZSBoaWRkZW4gc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgQE51bGxhYmxlIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoYm9vbGVhbiB1c2VyVmlzaWJsZU9ubHkpIHsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGFjdGl2ZUxpc3QgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWN0aXZlTGlzdCA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmICghdXNlclZpc2libGVPbmx5IHx8IGFjdGl2ZUxpc3QgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gYWN0aXZlTGlzdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYWN0aXZlTGlzdC5zdHJlYW0oKS5maWx0ZXIoc3ViSW5mbyAtPiBpc1N1YnNjcmlwdGlvblZpc2libGUoc3ViSW5mbykpCiAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3QoQ29sbGVjdG9ycy50b0xpc3QoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgU3Vic2NyaXB0aW9uSW5mbyhzKSBvZiBhbGwgYXZhaWxhYmxlIHN1YnNjcmlwdGlvbnMsIGlmIGFueS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIEF2YWlsYWJsZSBzdWJzY3JpcHRpb25zIGluY2x1ZGUgYWN0aXZlIG9uZXMgKHRob3NlIHdpdGggYSBub24tbmVnYXRpdmUKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleCgpfSkgYXMgd2VsbCBhcyBpbmFjdGl2ZSBidXQgaW5zdGFsbGVkCiAgICAgKiBlbWJlZGRlZAogICAgICogc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbgogICAgICogYnkKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFNvcnRlZCBsaXN0IG9mIHRoZSBjdXJyZW50IHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGF2YWlsYWJsZQogICAgICogICAgICAgICBvbiB0aGUKICAgICAqICAgICAgICAgZGV2aWNlLgogICAgICogICAgICAgICA8dWw+CiAgICAgKiAgICAgICAgIDxsaT4KICAgICAqICAgICAgICAgSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhCiAgICAgKiAgICAgICAgIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IGhhcyBiZWVuIHJlZ2lzdGVyZWQKICAgICAqICAgICAgICAge0BsaW5rIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciNvblN1YnNjcmlwdGlvbnNDaGFuZ2VkfSB3aWxsIGJlCiAgICAgKiAgICAgICAgIGludm9rZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAqICAgICAgICAgPGxpPgogICAgICogICAgICAgICBJZiB0aGUgbGlzdCBpcyBlbXB0eSB0aGVuIHRoZXJlIGFyZSBubyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30KICAgICAqICAgICAgICAgcmVjb3JkcyBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogICAgICAgICA8bGk+CiAgICAgKiAgICAgICAgIGlmIHRoZSBsaXN0IGlzIG5vbi1lbXB0eSB0aGUgbGlzdCBpcyBzb3J0ZWQgYnkKICAgICAqICAgICAgICAge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fQogICAgICogICAgICAgICB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqICAgICAgICAgPC91bD4KICAgICAqCiAgICAgKiAgICAgICAgIDxwPgogICAgICogICAgICAgICBQZXJtaXNzaW9ucyBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFCiAgICAgKiAgICAgICAgIGlzIHJlcXVpcmVkCiAgICAgKiAgICAgICAgIGZvciAjZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QgdG8gYmUgaW52b2tlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEF2YWlsYWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIFN1YnNjcmlwdGlvbkluZm8ocykgb2YgYWxsIGVtYmVkZGVkIHN1YnNjcmlwdGlvbnMgYWNjZXNzaWJsZSB0byB0aGUKICAgICAqIGNhbGxpbmcgYXBwLCBpZgogICAgICogYW55LgogICAgICoKICAgICAqIDxwPgogICAgICogT25seSB0aG9zZSBzdWJzY3JpcHRpb25zIGZvciB3aGljaCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyBwZXIKICAgICAqIHRoZQogICAgICogc3Vic2NyaXB0aW9uIG1ldGFkYXRhLCBpZiBhbnksIHdpbGwgYmUgaW5jbHVkZWQgaW4gdGhlIHJldHVybmVkIGxpc3QuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBUaGUgcmVjb3JkcyB3aWxsIGJlIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9IHRoZW4KICAgICAqIGJ5CiAgICAgKiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogQHJldHVybiBTb3J0ZWQgbGlzdCBvZiB0aGUgY3VycmVudCBlbWJlZGRlZCB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcwogICAgICogICAgICAgICBhdmFpbGFibGUgb24gdGhlCiAgICAgKiAgICAgICAgIGRldmljZSB3aGljaCBhcmUgYWNjZXNzaWJsZSB0byB0aGUgY2FsbGVyLgogICAgICogICAgICAgICA8dWw+CiAgICAgKiAgICAgICAgIDxsaT4KICAgICAqICAgICAgICAgSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhCiAgICAgKiAgICAgICAgIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IGhhcyBiZWVuIHJlZ2lzdGVyZWQKICAgICAqICAgICAgICAge0BsaW5rIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciNvblN1YnNjcmlwdGlvbnNDaGFuZ2VkfSB3aWxsIGJlCiAgICAgKiAgICAgICAgIGludm9rZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAqICAgICAgICAgPGxpPgogICAgICogICAgICAgICBJZiB0aGUgbGlzdCBpcyBlbXB0eSB0aGVuIHRoZXJlIGFyZSBubyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30KICAgICAqICAgICAgICAgcmVjb3JkcyBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogICAgICAgICA8bGk+CiAgICAgKiAgICAgICAgIGlmIHRoZSBsaXN0IGlzIG5vbi1lbXB0eSB0aGUgbGlzdCBpcyBzb3J0ZWQgYnkKICAgICAqICAgICAgICAge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fQogICAgICogICAgICAgICB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqICAgICAgICAgPC91bD4KICAgICAqLwogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QWNjZXNzaWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWNjZXNzaWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXF1ZXN0IGEgcmVmcmVzaCBvZiB0aGUgcGxhdGZvcm0gY2FjaGUgb2YgcHJvZmlsZSBpbmZvcm1hdGlvbiBmb3IgdGhlIGVVSUNDCiAgICAgKiB3aGljaAogICAgICogY29ycmVzcG9uZHMgdG8gdGhlIGNhcmQgSUQgcmV0dXJuZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2dldENhcmRJZEZvckRlZmF1bHRFdWljYygpfS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uCiAgICAgKiBjaGFuZ2VzIGR1ZQogICAgICogdG8gYW4gb3BlcmF0aW9uIGRvbmUgb3V0c2lkZSB0aGUgc2NvcGUgb2YgYSByZXF1ZXN0IGluaXRpYXRlZCBieSB0aGUgcGxhdGZvcm0KICAgICAqIHRvIHRoZQogICAgICogRXVpY2NTZXJ2aWNlLiBUaGVyZSBpcyBubyBuZWVkIHRvIHJlZnJlc2ggZm9yIGRvd25sb2FkcywgZGVsZXRlcywgb3Igb3RoZXIKICAgICAqIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1dSSVRFX0VNQkVEREVEX1NVQlNDUklQVElPTlN9CiAgICAgKiBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgKiAgICAgIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaCgpIHsKICAgICAgICBpbnQgY2FyZElkID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KS5nZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5yZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdFJlZnJlc2goY2FyZElkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dkKCJyZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdEZyZXNoIGZvciBjYXJkID0gIiArIGNhcmRJZCArICIgZmFpbGVkLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBwbGF0Zm9ybSBjYWNoZSBvZiBwcm9maWxlIGluZm9ybWF0aW9uIGZvciB0aGUgZVVJQ0MKICAgICAqIHdpdGggdGhlIGdpdmVuCiAgICAgKiB7QGNvZGUgY2FyZElkfS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uCiAgICAgKiBjaGFuZ2VzIGR1ZQogICAgICogdG8gYW4gb3BlcmF0aW9uIGRvbmUgb3V0c2lkZSB0aGUgc2NvcGUgb2YgYSByZXF1ZXN0IGluaXRpYXRlZCBieSB0aGUgcGxhdGZvcm0KICAgICAqIHRvIHRoZQogICAgICogRXVpY2NTZXJ2aWNlLiBUaGVyZSBpcyBubyBuZWVkIHRvIHJlZnJlc2ggZm9yIGRvd25sb2FkcywgZGVsZXRlcywgb3Igb3RoZXIKICAgICAqIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1dSSVRFX0VNQkVEREVEX1NVQlNDUklQVElPTlN9CiAgICAgKiBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBwYXJhbSBjYXJkSWQgdGhlIGNhcmQgSUQgb2YgdGhlIGVVSUNDLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgKiAgICAgIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaChpbnQgY2FyZElkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIucmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RSZWZyZXNoKGNhcmRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZCgicmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RGcmVzaCBmb3IgY2FyZCA9ICIgKyBjYXJkSWQgKyAiIGZhaWxlZC4iKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRoZSBjb3VudCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZGF0YWJhc2UsIHRoaXMgaW5jbHVkZXMKICAgICAqICAgICAgICAgYWxsIHN1YnNjcmlwdGlvbnMgdGhhdCBoYXZlIGJlZW4gc2Vlbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IGdldEFsbFN1YnNjcmlwdGlvbkluZm9Db3VudCgpIHsKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgiW2dldEFsbFN1YnNjcmlwdGlvbkluZm9Db3VudF0rIik7CgogICAgICAgIGludCByZXN1bHQgPSAwOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBbGxTdWJJbmZvQ291bnQobUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFCiAgICAgKiBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIHRoZSBjb3VudAogICAgICogd2lsbCBpbmNsdWRlCiAgICAgKiBvbmx5IHRob3NlIHN1YnNjcmlwdGlvbnMgYWNjZXNzaWJsZSB0byB0aGUgY2FsbGVyLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGN1cnJlbnQgbnVtYmVyIG9mIGFjdGl2ZSBzdWJzY3JpcHRpb25zLiBUaGVyZSBpcyBubyBndWFyYW50ZWUgdGhlCiAgICAgKiAgICAgICAgIHZhbHVlCiAgICAgKiAgICAgICAgIHJldHVybmVkIGJ5IHRoaXMgbWV0aG9kIHdpbGwgYmUgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aCBvZiB0aGUgbGlzdAogICAgICogICAgICAgICByZXR1cm5lZCBieQogICAgICogICAgICAgICB7QGxpbmsgI2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0fS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Db3VudCgpIHsKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3ViSW5mb0NvdW50KG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0aGUgbWF4aW11bSBudW1iZXIgb2YgYWN0aXZlIHN1YnNjcmlwdGlvbnMgdGhhdCB3aWxsIGJlIHJldHVybmVkIGJ5CiAgICAgKiAgICAgICAgIHtAbGluayAjZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3R9IGFuZCB0aGUgdmFsdWUgcmV0dXJuZWQgYnkKICAgICAqICAgICAgICAge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnR9LgogICAgICovCiAgICBwdWJsaWMgaW50IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Db3VudE1heCgpIHsKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3ViSW5mb0NvdW50TWF4KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIAogICAgICogQHBhcmFtIGljY0lkICAgICB0aGUgSWNjSWQgb2YgdGhlIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBTSU0gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gdGhlIFVSTCBvZiB0aGUgbmV3bHkgY3JlYXRlZCByb3cgb3IgdGhlIHVwZGF0ZWQgcm93CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgVXJpIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIGljY0lkLCBpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgaWNjSWQ6IiArIGljY0lkICsgIiBzbG90SW5kZXg6IiArIHNsb3RJbmRleCk7CiAgICAgICAgaWYgKGljY0lkID09IG51bGwpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBudWxsIGljY0lkIik7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gaW52YWxpZCBzbG90SW5kZXgiKTsKICAgICAgICB9CgogICAgICAgIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoaWNjSWQsIG51bGwsIHNsb3RJbmRleCwgU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNKTsKCiAgICAgICAgLy8gRklYTUU6IEFsd2F5cyByZXR1cm5zIG51bGw/CiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIAogICAgICogQHBhcmFtIHVuaXF1ZUlkICAgICAgICAgVGhpcyBpcyB0aGUgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSBzdWJzY3JpcHRpb24KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhpbiB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZmljIHN1YnNjcmlwdGlvbiB0eXBlLgogICAgICogQHBhcmFtIGRpc3BsYXlOYW1lICAgICAgaHVtYW4tcmVhZGFibGUgbmFtZSBvZiB0aGUgZGV2aWNlIHRoZSBzdWJzY3JpcHRpb24KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIGNvcnJlc3BvbmRzIHRvLgogICAgICogQHBhcmFtIHNsb3RJbmRleCAgICAgICAgdGhlIHNsb3QgYXNzaWduZWQgdG8gdGhpcyBzdWJzY3JpcHRpb24uIEl0IGlzIGlnbm9yZWQKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBzdWJzY3JpcHRpb25UeXBlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBvZiB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU19LgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvblR5cGUgdGhlIHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEV9CiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpKGNsaWVudCA9IFN5c3RlbUFwaS5DbGllbnQuTU9EVUxFX0xJQlJBUklFUykKICAgIHB1YmxpYyB2b2lkIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoQE5vbk51bGwgU3RyaW5nIHVuaXF1ZUlkLCBATnVsbGFibGUgU3RyaW5nIGRpc3BsYXlOYW1lLAogICAgICAgICAgICBpbnQgc2xvdEluZGV4LCBAU3Vic2NyaXB0aW9uVHlwZSBpbnQgc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgdW5pcXVlSWQ6IiArIHVuaXF1ZUlkCiAgICAgICAgICAgICAgICAgICAgKyAiLCBkaXNwbGF5TmFtZToiICsgZGlzcGxheU5hbWUgKyAiLCBzbG90SW5kZXg6IiArIHNsb3RJbmRleAogICAgICAgICAgICAgICAgICAgICsgIiwgc3Vic2NyaXB0aW9uVHlwZTogIiArIHN1YnNjcmlwdGlvblR5cGUpOwogICAgICAgIH0KICAgICAgICBpZiAodW5pcXVlSWQgPT0gbnVsbCkgewogICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSB1bmlxdWVJZCBpcyBudWxsIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBJU3ViIHNlcnZpY2UgaXMgbnVsbCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludCByZXN1bHQgPSBpU3ViLmFkZFN1YkluZm8odW5pcXVlSWQsIGRpc3BsYXlOYW1lLCBzbG90SW5kZXgsIHN1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICBpZiAocmVzdWx0IDwgMCkgewogICAgICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIkFkZGluZyBvZiBzdWJzY3JpcHRpb24gZGlkbid0IHN1Y2NlZWQ6IGVycm9yID0gIiArIHJlc3VsdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsb2dkKCJzdWNjZXNzZnVsbHkgYWRkZWQgbmV3IHN1YnNjcmlwdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBTdWJzY3JpcHRpb25JbmZvIHJlY29yZCBmcm9tIHRoZSBTdWJzY3JpcHRpb25JbmZvIGRhdGFiYXNlCiAgICAgKiAKICAgICAqIEBwYXJhbSB1bmlxdWVJZCAgICAgICAgIFRoaXMgaXMgdGhlIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoaW4gdGhlIHNwZWNpZmljCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24gdHlwZS4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25UeXBlIHRoZSB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFfQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaShjbGllbnQgPSBTeXN0ZW1BcGkuQ2xpZW50Lk1PRFVMRV9MSUJSQVJJRVMpCiAgICBwdWJsaWMgdm9pZCByZW1vdmVTdWJzY3JpcHRpb25JbmZvUmVjb3JkKEBOb25OdWxsIFN0cmluZyB1bmlxdWVJZCwKICAgICAgICAgICAgQFN1YnNjcmlwdGlvblR5cGUgaW50IHN1YnNjcmlwdGlvblR5cGUpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbcmVtb3ZlU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0rIHVuaXF1ZUlkOiIgKyB1bmlxdWVJZAogICAgICAgICAgICAgICAgICAgICsgIiwgc3Vic2NyaXB0aW9uVHlwZTogIiArIHN1YnNjcmlwdGlvblR5cGUpOwogICAgICAgIH0KICAgICAgICBpZiAodW5pcXVlSWQgPT0gbnVsbCkgewogICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSB1bmlxdWVJZCBpcyBudWxsIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiW3JlbW92ZVN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBJU3ViIHNlcnZpY2UgaXMgbnVsbCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludCByZXN1bHQgPSBpU3ViLnJlbW92ZVN1YkluZm8odW5pcXVlSWQsIHN1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICBpZiAocmVzdWx0IDwgMCkgewogICAgICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIlJlbW92YWwgb2Ygc3Vic2NyaXB0aW9uIGRpZG4ndCBzdWNjZWVkOiBlcnJvciA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbG9nZCgic3VjY2Vzc2Z1bGx5IHJlbW92ZWQgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0IFNJTSBpY29uIHRpbnQgY29sb3IgZm9yIHN1YnNjcmlwdGlvbiBJRAogICAgICogCiAgICAgKiBAcGFyYW0gdGludCAgdGhlIFJHQiB2YWx1ZSBvZiBpY29uIHRpbnQgY29sb3Igb2YgdGhlIFNJTQogICAgICogQHBhcmFtIHN1YklkIHRoZSB1bmlxdWUgU3Vic2NyaXRwaW9uIElEIGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBzZXRJY29uVGludChAQ29sb3JJbnQgaW50IHRpbnQsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKQogICAgICAgICAgICBsb2dkKCJbc2V0SWNvblRpbnRdKyB0aW50OiIgKyB0aW50ICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldEljb25UaW50IiwKICAgICAgICAgICAgICAgIChpU3ViKSAtPiBpU3ViLnNldEljb25UaW50KHRpbnQsIHN1YklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGRpc3BsYXkgbmFtZSBmb3IgYSBzdWJzY3JpcHRpb24gSUQKICAgICAqIAogICAgICogQHBhcmFtIGRpc3BsYXlOYW1lIHRoZSBkaXNwbGF5IG5hbWUgb2YgU0lNIGNhcmQKICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICB0aGUgdW5pcXVlIFN1YnNjcml0cGlvbiBJRCBpbiBkYXRhYmFzZQogICAgICogQHBhcmFtIG5hbWVTb3VyY2UgIFNJTSBkaXNwbGF5IG5hbWUgc291cmNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkIG9yIDwgMCBpZiBpbnZhbGlkIHN1YklkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBzZXREaXNwbGF5TmFtZShATnVsbGFibGUgU3RyaW5nIGRpc3BsYXlOYW1lLCBpbnQgc3ViSWQsCiAgICAgICAgICAgIEBTaW1EaXNwbGF5TmFtZVNvdXJjZSBpbnQgbmFtZVNvdXJjZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREaXNwbGF5TmFtZV0rICBkaXNwbGF5TmFtZToiICsgZGlzcGxheU5hbWUgKyAiIHN1YklkOiIgKyBzdWJJZAogICAgICAgICAgICAgICAgICAgICsgIiBuYW1lU291cmNlOiIgKyBuYW1lU291cmNlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0RGlzcGxheU5hbWUiLAogICAgICAgICAgICAgICAgKGlTdWIpIC0+IGlTdWIuc2V0RGlzcGxheU5hbWVVc2luZ1NyYyhkaXNwbGF5TmFtZSwgc3ViSWQsIG5hbWVTb3VyY2UpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBwaG9uZSBudW1iZXIgYnkgc3ViSWQKICAgICAqIAogICAgICogQHBhcmFtIG51bWJlciB0aGUgcGhvbmUgbnVtYmVyIG9mIHRoZSBTSU0KICAgICAqIEBwYXJhbSBzdWJJZCAgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlIsIHRyYWNraW5nQnVnID0gMTcwNzI5NTUzKQogICAgcHVibGljIGludCBzZXREaXNwbGF5TnVtYmVyKFN0cmluZyBudW1iZXIsIGludCBzdWJJZCkgewogICAgICAgIGlmIChudW1iZXIgPT0gbnVsbCkgewogICAgICAgICAgICBsb2dkKCJbc2V0RGlzcGxheU51bWJlcl0tIGZhaWwiKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3ViSWQsICJzZXREaXNwbGF5TnVtYmVyIiwKICAgICAgICAgICAgICAgIChpU3ViKSAtPiBpU3ViLnNldERpc3BsYXlOdW1iZXIobnVtYmVyLCBzdWJJZCkpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IGRhdGEgcm9hbWluZyBieSBzaW1JbmZvIGluZGV4CiAgICAgKiAKICAgICAqIEBwYXJhbSByb2FtaW5nIDA6RG9uJ3QgYWxsb3cgZGF0YSB3aGVuIHJvYW1pbmcsIDE6QWxsb3cgZGF0YSB3aGVuIHJvYW1pbmcKICAgICAqIEBwYXJhbSBzdWJJZCAgIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBpbnQgc2V0RGF0YVJvYW1pbmcoaW50IHJvYW1pbmcsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKQogICAgICAgICAgICBsb2dkKCJbc2V0RGF0YVJvYW1pbmddKyByb2FtaW5nOiIgKyByb2FtaW5nICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERhdGFSb2FtaW5nIiwKICAgICAgICAgICAgICAgIChpU3ViKSAtPiBpU3ViLnNldERhdGFSb2FtaW5nKHJvYW1pbmcsIHN1YklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgc2xvdEluZGV4IGFzc29jaWF0ZWQgd2l0aCB0aGUgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8gaW5kZXggaW4gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gc2xvdEluZGV4IGFzIGEgcG9zaXRpdmUgaW50ZWdlciBvciB7QGxpbmsgI0lOVkFMSURfU0lNX1NMT1RfSU5ERVh9IGlmCiAgICAgKiAgICAgICAgIHRoZSBzdXBwbGllZAogICAgICogICAgICAgICBzdWJzY3JpcHRpb25JZCBkb2Vzbid0IGhhdmUgYW4gYXNzb2NpYXRlZCBzbG90IGluZGV4LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRTbG90SW5kZXgoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIHNTbG90SW5kZXhDYWNoZS5xdWVyeShzdWJzY3JpcHRpb25JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYW4gYXJyYXkgb2YgU3Vic2NyaXB0aW9uIElkcyBmb3Igc3BlY2lmaWVkIHNsb3QgSW5kZXguCiAgICAgKiAKICAgICAqIEBwYXJhbSBzbG90SW5kZXggdGhlIHNsb3QgaW5kZXguCiAgICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBJZHMgb3IgbnVsbCBpZiB0aGUgZ2l2ZW4gc2xvdCBJbmRleCBpcyBub3QgdmFsaWQgb3IKICAgICAqICAgICAgICAgdGhlcmUgYXJlIG5vIGFjdGl2ZQogICAgICogICAgICAgICBzdWJzY3JpcHRpb25zIGluIHRoZSBzbG90LgogICAgICovCiAgICBATnVsbGFibGUKICAgIHB1YmxpYyBpbnRbXSBnZXRTdWJzY3JpcHRpb25JZHMoaW50IHNsb3RJbmRleCkgewogICAgICAgIHJldHVybiBnZXRTdWJJZChzbG90SW5kZXgpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBzdGF0aWMgaW50W10gZ2V0U3ViSWQoaW50IHNsb3RJbmRleCkgewogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXRTdWJJZF0tIGZhaWwiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpbnRbXSBzdWJJZCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdWJJZCA9IGlTdWIuZ2V0U3ViSWQoc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJZDsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldFBob25lSWQoaW50IHN1YklkKSB7CiAgICAgICAgcmV0dXJuIHNQaG9uZUlkQ2FjaGUucXVlcnkoc3ViSWQpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgbG9nZChTdHJpbmcgbXNnKSB7CiAgICAgICAgUmxvZy5kKExPR19UQUcsIG1zZyk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBsb2dlKFN0cmluZyBtc2cpIHsKICAgICAgICBSbG9nLmUoTE9HX1RBRywgbXNnKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHN5c3RlbSdzIGRlZmF1bHQgc3Vic2NyaXB0aW9uIGlkLgogICAgICoKICAgICAqIEZvciBhIHZvaWNlIGNhcGFibGUgZGV2aWNlLCBpdCB3aWxsIHJldHVybiBnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZC4KICAgICAqIEZvciBhIGRhdGEgb25seSBkZXZpY2UsIGl0IHdpbGwgcmV0dXJuIHRoZSBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkLgogICAgICogTWF5IHJldHVybiBhbiBJTlZBTElEX1NVQlNDUklQVElPTl9JRCBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSAic3lzdGVtIiBkZWZhdWx0IHN1YnNjcmlwdGlvbiBpZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIHJldHVybiBzRGVmYXVsdFN1YklkQ2FjaGUucXVlcnkobnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBPbiBhIGRhdGEgb25seSBkZXZpY2Ugb3Igb24gZXJyb3IsIHdpbGwgcmV0dXJuIElOVkFMSURfU1VCU0NSSVBUSU9OX0lELgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uIElkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICBpbnQgc3ViSWQgPSBJTlZBTElEX1NVQlNDUklQVElPTl9JRDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YklkID0gaVN1Yi5nZXREZWZhdWx0Vm9pY2VTdWJJZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoImdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkLCBzdWIgaWQgPSAiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgdGhlIHN5c3RlbSdzIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uIGlkLgogICAgICoKICAgICAqIE9uIGEgZGF0YS1vbmx5IGRldmljZSwgdGhpcyBpcyBhIG5vLW9wLgogICAgICoKICAgICAqIE1heSB0aHJvdyBhIHtAbGluayBSdW50aW1lRXhjZXB0aW9ufSBpZiB0aGUgcHJvdmlkZWQgc3Vic2NyaXB0aW9uIGlkIGlzIGVxdWFsCiAgICAgKiB0bwogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9CiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIEEgdmFsaWQgc3Vic2NyaXB0aW9uIElEIHRvIHNldCBhcyB0aGUgc3lzdGVtIGRlZmF1bHQsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgb3IKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNJTlZBTElEX1NVQlNDUklQVElPTl9JRH0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgic2V0RGVmYXVsdFZvaWNlU3ViSWQgc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0Vm9pY2VTdWJJZChzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2FtZSBhcyB7QGxpbmsgI3NldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKGludCl9LCBidXQgcHJlc2VydmVkIGZvcgogICAgICogYmFja3dhcmRzCiAgICAgKiBjb21wYXRpYmlsaXR5LgogICAgICogCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0Vm9pY2VTdWJJZChpbnQgc3ViSWQpIHsKICAgICAgICBzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChzdWJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIFdpbGwgcmV0dXJuIG51bGwgb24gZGF0YSBvbmx5IGRldmljZXMsIG9yIG9uIGVycm9yLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIHRoZSBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRWb2ljZVBob25lSWQoKSB7CiAgICAgICAgcmV0dXJuIGdldFBob25lSWQoZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IFNNUyBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSBkYXRhIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IFNNUyBzdWJzY3JpcHRpb24gSWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHRTbXNTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBzdWJzY3JpcHRpb24gd2hpY2ggd2lsbCBiZSB1c2VkIGJ5IGRlZmF1bHQgZm9yIFNNUywgd2l0aCB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3aGljaAogICAgICogdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0bzsgb3IgdGhyb3cgYSBSdW50aW1lRXhjZXB0aW9uIGlmCiAgICAgKiB0aGUgc3VwcGxpZWQKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBpcyBub3QgdXNhYmxlIChjaGVjayB3aXRoCiAgICAgKiB7QGxpbmsgI2lzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50KX0pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElECiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFNtc1N1YklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKQogICAgICAgICAgICBsb2dkKCJzZXREZWZhdWx0U21zU3ViSWQgc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0U21zU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGV4LnJldGhyb3dGcm9tU3lzdGVtU2VydmVyKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBXaWxsIHJldHVybiBudWxsIG9uIGRhdGEgb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBpbnQgZ2V0RGVmYXVsdFNtc1Bob25lSWQoKSB7CiAgICAgICAgcmV0dXJuIGdldFBob25lSWQoZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBPbiBhIHZvaWNlIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uIElkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIHJldHVybiBzRGVmYXVsdERhdGFTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBzdWJzY3JpcHRpb24gd2hpY2ggd2lsbCBiZSB1c2VkIGJ5IGRlZmF1bHQgZm9yIGRhdGEsIHdpdGggdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gd2hpY2gKICAgICAqIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgY29ycmVzcG9uZHMgdG87IG9yIHRocm93IGEgUnVudGltZUV4Y2VwdGlvbiBpZgogICAgICogdGhlIHN1cHBsaWVkCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgaXMgbm90IHVzYWJsZSAoY2hlY2sgd2l0aAogICAgICoge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERlZmF1bHREYXRhU3ViSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoInNldERhdGFTdWJzY3JpcHRpb24gc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0RGF0YVN1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogV2lsbCByZXR1cm4gbnVsbCBvbiB2b2ljZSBvbmx5IGRldmljZXMsIG9yIG9uIGVycm9yLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIHRoZSBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSW5mbygpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBpbnQgZ2V0RGVmYXVsdERhdGFQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgdm9pZCBjbGVhclN1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuY2xlYXJTdWJJbmZvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gRklYTUUgdGhpcyBpcyB2dWxuZXJhYmxlIHRvIHJhY2UgY29uZGl0aW9ucwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgYm9vbGVhbiBhbGxEZWZhdWx0c1NlbGVjdGVkKCkgewogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBpcyB2YWxpZC4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIEEgdmFsaWQgc3Vic2NyaXB0aW9uIElEIGlzIG5vdCBuZWNlc3NhcmlseSBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uIElECiAgICAgKiAoc2VlIHtAbGluayAjaXNBY3RpdmVTdWJzY3JpcHRpb25JZChpbnQpfSkgb3IgYW4gdXNhYmxlIHN1YnNjcmlwdGlvbiBJRAogICAgICogKHNlZSB7QGxpbmsgI2lzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50KX0pLiBVbmxlc3Mgc3BlY2lmaWNhbGx5IG5vdGVkLAogICAgICogc3Vic2NyaXB0aW9uCiAgICAgKiBBUElzIHdvcmsgd2l0aCBhIHZhbGlkIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgVGhlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb25JZCBpcyB2YWxpZDsge0Bjb2RlIGZhbHNlfQogICAgICogICAgICAgICBvdGhlcndpc2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbklkID4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGlzIHVzYWJsZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIEEgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRCBpcyBhIHZhbGlkIHN1YnNjcmlwdGlvbiBJRCwgYnV0IG5vdCBuZWNlc3NhcmlseSBhbgogICAgICogYWN0aXZlCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgKHNlZSB7QGxpbmsgI2lzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50KX0pLiBTb21lIHN1YnNjcmlwdGlvbgogICAgICogQVBJcwogICAgICogcmVxdWlyZSBhIHVzYWJsZSBzdWJzY3JpcHRpb24gSUQsIGFuZCB0aGlzIGlzIG5vdGVkIGluIHRoZWlyIGRvY3VtZW50YXRpb247CiAgICAgKiBvdGhlcndpc2UsIGEKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBkb2VzIG5vdCBuZWVkIHRvIGJlIHVzYWJsZSBmb3Igc3Vic2NyaXB0aW9uIGZ1bmN0aW9ucywgb25seQogICAgICogdmFsaWQuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb24gSUQKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgdXNhYmxlOyB7QGNvZGUgZmFsc2V9CiAgICAgKiAgICAgICAgIG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIGlzVXNhYmxlU3ViSWRWYWx1ZShzdWJzY3JpcHRpb25JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgc3ViSWQgaXMgYW4gdXNhYmxlIHN1YklkIHZhbHVlIGVsc2UgZmFsc2UuIEEKICAgICAqICAgICAgICAgdXNhYmxlIHN1YklkIG1lYW5zIGl0cyBuZWl0aGVyIGEgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgbm9yIGEKICAgICAqICAgICAgICAgREVGQVVMVF9TVUJfSUQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgc3RhdGljIGJvb2xlYW4gaXNVc2FibGVTdWJJZFZhbHVlKGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBzdWJJZCA+PSBNSU5fU1VCU0NSSVBUSU9OX0lEX1ZBTFVFICYmIHN1YklkIDw9IE1BWF9TVUJTQ1JJUFRJT05fSURfVkFMVUU7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlAsIHRyYWNraW5nQnVnID0gMTE1NjA5MDIzKQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVmFsaWRTbG90SW5kZXgoaW50IHNsb3RJbmRleCkgewogICAgICAgIHJldHVybiBzbG90SW5kZXggPj0gMCAmJiBzbG90SW5kZXggPCBUZWxlcGhvbnlNYW5hZ2VyLmdldERlZmF1bHQoKS5nZXRBY3RpdmVNb2RlbUNvdW50KCk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlIsIHRyYWNraW5nQnVnID0gMTcwNzI5NTUzKQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVmFsaWRQaG9uZUlkKGludCBwaG9uZUlkKSB7CiAgICAgICAgcmV0dXJuIHBob25lSWQgPj0gMCAmJiBwaG9uZUlkIDwgVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuZ2V0QWN0aXZlTW9kZW1Db3VudCgpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyB2b2lkIHB1dFBob25lSWRBbmRTdWJJZEV4dHJhKEludGVudCBpbnRlbnQsIGludCBwaG9uZUlkKSB7CiAgICAgICAgaW50W10gc3ViSWRzID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRTdWJJZChwaG9uZUlkKTsKICAgICAgICBpZiAoc3ViSWRzICE9IG51bGwgJiYgc3ViSWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcHV0UGhvbmVJZEFuZFN1YklkRXh0cmEoaW50ZW50LCBwaG9uZUlkLCBzdWJJZHNbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZ2QoInB1dFBob25lSWRBbmRTdWJJZEV4dHJhOiBubyB2YWxpZCBzdWJzIik7CiAgICAgICAgICAgIGludGVudC5wdXRFeHRyYShQaG9uZUNvbnN0YW50cy5QSE9ORV9LRVksIHBob25lSWQpOwogICAgICAgICAgICBpbnRlbnQucHV0RXh0cmEoRVhUUkFfU0xPVF9JTkRFWCwgcGhvbmVJZCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYShJbnRlbnQgaW50ZW50LCBpbnQgcGhvbmVJZCwgaW50IHN1YklkKSB7CiAgICAgICAgaWYgKFZEQkcpCiAgICAgICAgICAgIGxvZ2QoInB1dFBob25lSWRBbmRTdWJJZEV4dHJhOiBwaG9uZUlkPSIgKyBwaG9uZUlkICsgIiBzdWJJZD0iICsgc3ViSWQpOwogICAgICAgIGludGVudC5wdXRFeHRyYShFWFRSQV9TTE9UX0lOREVYLCBwaG9uZUlkKTsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoUGhvbmVDb25zdGFudHMuUEhPTkVfS0VZLCBwaG9uZUlkKTsKICAgICAgICBwdXRTdWJzY3JpcHRpb25JZEV4dHJhKGludGVudCwgc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHZpc2libGUgc3Vic2NyaXB0aW9uIElkKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIHN1YklkJ3MgdGhhdCBhcmUgYWN0aXZlLAogICAgICogICAgICAgICBpcyBuZXZlciBudWxsIGJ1dCB0aGUgbGVuZ3RoIG1heSBiZSAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBpbnRbXSBnZXRBY3RpdmVTdWJzY3JpcHRpb25JZExpc3QoKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdCgvKiB2aXNpYmxlT25seSAqLyB0cnVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBib3RoIGhpZGRlbiBhbmQgdmlzaWJsZSBzdWJzY3JpcHRpb24gSWQocykgb2YgdGhlIGN1cnJlbnRseSBhY3RpdmUKICAgICAqIFNJTShzKS4KICAgICAqCiAgICAgKiBIaWRkZW4gc3Vic2NyaXB0aW9ucyByZWZlciB0byB0aG9zZSBhcmUgbm90IG1lYW50IHZpc2libGUgdG8gdGhlIHVzZXJzLgogICAgICogRm9yIGV4YW1wbGUsIGFuIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHRoYXQgaXMgZ3JvdXBlZCB3aXRoIG90aGVyCiAgICAgKiBzdWJzY3JpcHRpb25zIHNob3VsZCByZW1haW4gaW52aXNpYmxlIHRvIHVzZXJzIGFzIHRoZXkgYXJlIG9ubHkgZnVuY3Rpb25hbGx5CiAgICAgKiBzdXBwbGVtZW50YXJ5IHRvIHByaW1hcnkgb25lcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIHN1YklkJ3MgdGhhdCBhcmUgYWN0aXZlLAogICAgICogICAgICAgICBpcyBuZXZlciBudWxsIGJ1dCB0aGUgbGVuZ3RoIG1heSBiZSAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBpbnRbXSBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdCgpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KC8qIHZpc2libGVPbmx5ICovZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiBhIG5vbi1udWxsIGxpc3Qgb2Ygc3ViSWQncyB0aGF0IGFyZSBhY3RpdmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOb25OdWxsIGludFtdIGdldEFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdChib29sZWFuIHZpc2libGVPbmx5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGludFtdIHN1YklkID0gaVN1Yi5nZXRBY3RpdmVTdWJJZExpc3QodmlzaWJsZU9ubHkpOwogICAgICAgICAgICAgICAgaWYgKHN1YklkICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1YklkOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBpbnRbMF07CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGRldmljZSBpcyBjb25zaWRlcmVkIHJvYW1pbmcgb24gdGhlIGN1cnJlbnQKICAgICAqIG5ldHdvcmsgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIElECiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIG5ldHdvcmsgZm9yIHRoZSBzdWJzY3JpcHRpb24gaXMgcm9hbWluZywgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGlzTmV0d29ya1JvYW1pbmcoaW50IHN1YklkKSB7CiAgICAgICAgZmluYWwgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICBpZiAocGhvbmVJZCA8IDApIHsKICAgICAgICAgICAgLy8gV2hhdCBlbHNlIGNhbiB3ZSBkbz8KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuaXNOZXR3b3JrUm9hbWluZyhzdWJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgY29uc3RhbnQgaW5kaWNhdGluZyB0aGUgc3RhdGUgb2Ygc2ltIGZvciB0aGUgc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4CiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9VTktOT1dOfQogICAgICogICAgICAgICAgICAgICAgICB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9BQlNFTlR9CiAgICAgKiAgICAgICAgICAgICAgICAgIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1BJTl9SRVFVSVJFRH0KICAgICAqICAgICAgICAgICAgICAgICAge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUFVLX1JFUVVJUkVEfQogICAgICogICAgICAgICAgICAgICAgICB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRH0KICAgICAqICAgICAgICAgICAgICAgICAge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKiAgICAgICAgICAgICAgICAgIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX05PVF9SRUFEWX0KICAgICAqICAgICAgICAgICAgICAgICAge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUEVSTV9ESVNBQkxFRH0KICAgICAqICAgICAgICAgICAgICAgICAge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUn0KICAgICAqCiAgICAgKiAgICAgICAgICAgICAgICAgIHtAaGlkZX0KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0U2ltU3RhdGVGb3JTbG90SW5kZXgoaW50IHNsb3RJbmRleCkgewogICAgICAgIGludCBzaW1TdGF0ZSA9IFRlbGVwaG9ueU1hbmFnZXIuU0lNX1NUQVRFX1VOS05PV047CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzaW1TdGF0ZSA9IGlTdWIuZ2V0U2ltU3RhdGVGb3JTbG90SW5kZXgoc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNpbVN0YXRlOwogICAgfQoKICAgIC8qKgogICAgICogU3RvcmUgcHJvcGVydGllcyBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uSW5mbyBpbiBkYXRhYmFzZQogICAgICogCiAgICAgKiBAcGFyYW0gc3ViSWQgICAgIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5ICAgQ29sdW1uIG5hbWUgaW4gZGF0YWJhc2UgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbkluZm8KICAgICAqIEBwYXJhbSBwcm9wVmFsdWUgVmFsdWUgdG8gc3RvcmUgaW4gREIgZm9yIHBhcnRpY3VsYXIgc3ViSWQgJiBjb2x1bW4gbmFtZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIHNldFN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIFN0cmluZyBwcm9wVmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXJpYWxpemUgbGlzdCBvZiBjb250YWN0cyB1cmkgdG8gc3RyaW5nCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgU3RyaW5nIHNlcmlhbGl6ZVVyaUxpc3RzKExpc3Q8VXJpPiB1cmlzKSB7CiAgICAgICAgTGlzdDxTdHJpbmc+IGNvbnRhY3RzID0gbmV3IEFycmF5TGlzdDw+KCk7CiAgICAgICAgZm9yIChVcmkgdXJpIDogdXJpcykgewogICAgICAgICAgICBjb250YWN0cy5hZGQodXJpLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBCeXRlQXJyYXlPdXRwdXRTdHJlYW0gYm9zID0gbmV3IEJ5dGVBcnJheU91dHB1dFN0cmVhbSgpOwogICAgICAgICAgICBPYmplY3RPdXRwdXRTdHJlYW0gb29zID0gbmV3IE9iamVjdE91dHB1dFN0cmVhbShib3MpOwogICAgICAgICAgICBvb3Mud3JpdGVPYmplY3QoY29udGFjdHMpOwogICAgICAgICAgICBvb3MuZmx1c2goKTsKICAgICAgICAgICAgcmV0dXJuIEJhc2U2NC5lbmNvZGVUb1N0cmluZyhib3MudG9CeXRlQXJyYXkoKSwgQmFzZTY0LkRFRkFVTFQpOwogICAgICAgIH0gY2F0Y2ggKElPRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgbG9nZCgic2VyaWFsaXplVXJpTGlzdHMgSU8gZXhjZXB0aW9uIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBsaXN0IG9mIGNvbnRhY3RzIHVyaSBjb3JyZXNwb25kaW5nIHRvIHF1ZXJ5IHJlc3VsdC4KICAgICAqIAogICAgICogQHBhcmFtIHN1YklkICAgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHJldHVybiBsaXN0IG9mIGNvbnRhY3RzIHVyaSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgTGlzdDxVcmk+IGdldENvbnRhY3RzRnJvbVN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBieXRlW10gYiA9IEJhc2U2NC5kZWNvZGUocmVzdWx0LCBCYXNlNjQuREVGQVVMVCk7CiAgICAgICAgICAgICAgICBCeXRlQXJyYXlJbnB1dFN0cmVhbSBiaXMgPSBuZXcgQnl0ZUFycmF5SW5wdXRTdHJlYW0oYik7CiAgICAgICAgICAgICAgICBPYmplY3RJbnB1dFN0cmVhbSBvaXMgPSBuZXcgT2JqZWN0SW5wdXRTdHJlYW0oYmlzKTsKICAgICAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBjb250YWN0cyA9IEFycmF5TGlzdC5jbGFzcy5jYXN0KG9pcy5yZWFkT2JqZWN0KCkpOwogICAgICAgICAgICAgICAgTGlzdDxVcmk+IHVyaXMgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICAgICAgICAgIGZvciAoU3RyaW5nIGNvbnRhY3QgOiBjb250YWN0cykgewogICAgICAgICAgICAgICAgICAgIHVyaXMuYWRkKFVyaS5wYXJzZShjb250YWN0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdXJpczsKICAgICAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgSU8gZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0gY2F0Y2ggKENsYXNzTm90Rm91bmRFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgQ2xhc3NOb3RGb3VuZCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEFycmF5TGlzdDw+KCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBwcm9wZXJ0aWVzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb25JbmZvIGluIGRhdGFiYXNlCiAgICAgKiAKICAgICAqIEBwYXJhbSBzdWJJZCAgIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5IENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gVmFsdWUgYXNzb2NpYXRlZCB3aXRoIHN1YklkIGFuZCBwcm9wS2V5IGNvbHVtbiBpbiBkYXRhYmFzZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgU3RyaW5nIGdldFN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHRWYWx1ZSA9IG51bGw7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdFZhbHVlID0gaVN1Yi5nZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIGNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHRWYWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYm9vbGVhbiB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHF1ZXJ5IHJlc3VsdC4KICAgICAqIAogICAgICogQHBhcmFtIHN1YklkICAgIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5ICBDb2x1bW4gbmFtZSBpbiBTdWJzY3JpcHRpb25JbmZvIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gZGVmVmFsdWUgRGVmYXVsdCBib29sZWFuIHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAcmV0dXJuIGJvb2xlYW4gcmVzdWx0IHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGJvb2xlYW4gZ2V0Qm9vbGVhblN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksCiAgICAgICAgICAgIGJvb2xlYW4gZGVmVmFsdWUsIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSW50ZWdlci5wYXJzZUludChyZXN1bHQpID09IDE7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlcnIpIHsKICAgICAgICAgICAgICAgIGxvZ2QoImdldEJvb2xlYW5TdWJzY3JpcHRpb25Qcm9wZXJ0eSBOdW1iZXJGb3JtYXQgZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZlZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBpbnRlZ2VyIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gcXVlcnkgcmVzdWx0LgogICAgICogCiAgICAgKiBAcGFyYW0gc3ViSWQgICAgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgIENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBkZWZWYWx1ZSBEZWZhdWx0IGludGVnZXIgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gaW50ZWdlciByZXN1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldEludGVnZXJTdWJzY3JpcHRpb25Qcm9wZXJ0eShpbnQgc3ViSWQsIFN0cmluZyBwcm9wS2V5LCBpbnQgZGVmVmFsdWUsCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSW50ZWdlci5wYXJzZUludChyZXN1bHQpOwogICAgICAgICAgICB9IGNhdGNoIChOdW1iZXJGb3JtYXRFeGNlcHRpb24gZXJyKSB7CiAgICAgICAgICAgICAgICBsb2dkKCJnZXRJbnRlZ2VyU3Vic2NyaXB0aW9uUHJvcGVydHkgTnVtYmVyRm9ybWF0IGV4Y2VwdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWZWYWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgbG9uZyB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHF1ZXJ5IHJlc3VsdC4KICAgICAqIAogICAgICogQHBhcmFtIHN1YklkICAgIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5ICBDb2x1bW4gbmFtZSBpbiBTdWJzY3JpcHRpb25JbmZvIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gZGVmVmFsdWUgRGVmYXVsdCBsb25nIHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAcmV0dXJuIGxvbmcgcmVzdWx0IHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGxvbmcgZ2V0TG9uZ1N1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIGxvbmcgZGVmVmFsdWUsCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTG9uZy5wYXJzZUxvbmcocmVzdWx0KTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGVycikgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0TG9uZ1N1YnNjcmlwdGlvblByb3BlcnR5IE51bWJlckZvcm1hdCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB7QGxpbmsgUmVzb3VyY2VzfSBmcm9tIHRoZSBnaXZlbiB7QGxpbmsgQ29udGV4dH0gZm9yIHRoZSBNQ0MvTU5DCiAgICAgKiBhc3NvY2lhdGVkIHdpdGgKICAgICAqIHRoZSBzdWJzY3JpcHRpb24uIElmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgaW52YWxpZCwgdGhlIGJhc2UgcmVzb3VyY2VzIGFyZQogICAgICogcmV0dXJuZWQgaW5zdGVhZC4KICAgICAqCiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUKICAgICAqIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCBvYmplY3QKICAgICAqIEBwYXJhbSBzdWJJZCAgIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24gd2hvc2UgcmVzb3VyY2VzIGFyZSByZXF1aXJlZAogICAgICogQHJldHVybiBSZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIFJlc291cmNlcyBnZXRSZXNvdXJjZXNGb3JTdWJJZChATm9uTnVsbCBDb250ZXh0IGNvbnRleHQsIGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBnZXRSZXNvdXJjZXNGb3JTdWJJZChjb250ZXh0LCBzdWJJZCwgZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb24uCiAgICAgKiAKICAgICAqIEBwYXJhbSBjb250ZXh0ICAgICAgIENvbnRleHQgb2JqZWN0CiAgICAgKiBAcGFyYW0gc3ViSWQgICAgICAgICBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uIHdobydzIHJlc291cmNlcyBhcmUKICAgICAqICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkCiAgICAgKiBAcGFyYW0gdXNlUm9vdExvY2FsZSBpZiByb290IGxvY2FsZSBzaG91bGQgYmUgdXNlZC4gTG9jYWxpemVkIGxvY2FsZSBpcyB1c2VkCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICBpZiBmYWxzZS4KICAgICAqIEByZXR1cm4gUmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgcHVibGljIHN0YXRpYyBSZXNvdXJjZXMgZ2V0UmVzb3VyY2VzRm9yU3ViSWQoQ29udGV4dCBjb250ZXh0LCBpbnQgc3ViSWQsCiAgICAgICAgICAgIGJvb2xlYW4gdXNlUm9vdExvY2FsZSkgewogICAgICAgIC8vIENoZWNrIGlmIHJlc291cmNlcyBmb3IgdGhpcyBjb250ZXh0IGFuZCBzdWJJZCBhbHJlYWR5IGV4aXN0IGluIHRoZSByZXNvdXJjZQogICAgICAgIC8vIGNhY2hlLgogICAgICAgIC8vIFJlc291cmNlcyB0aGF0IHVzZSB0aGUgcm9vdCBsb2NhbGUgYXJlIG5vdCBjYWNoZWQuCiAgICAgICAgUGFpcjxDb250ZXh0LCBJbnRlZ2VyPiBjYWNoZUtleSA9IG51bGw7CiAgICAgICAgaWYgKGlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkgJiYgIXVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAgICAgY2FjaGVLZXkgPSBQYWlyLmNyZWF0ZShjb250ZXh0LCBzdWJJZCk7CiAgICAgICAgICAgIGlmIChzUmVzb3VyY2VzQ2FjaGUuY29udGFpbnNLZXkoY2FjaGVLZXkpKSB7CiAgICAgICAgICAgICAgICAvLyBDYWNoZSBoaXQuIFVzZSBjYWNoZWQgUmVzb3VyY2VzLgogICAgICAgICAgICAgICAgcmV0dXJuIHNSZXNvdXJjZXNDYWNoZS5nZXQoY2FjaGVLZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmaW5hbCBTdWJzY3JpcHRpb25JbmZvIHN1YkluZm8gPSBTdWJzY3JpcHRpb25NYW5hZ2VyLmZyb20oY29udGV4dCkuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhzdWJJZCk7CgogICAgICAgIENvbmZpZ3VyYXRpb24gb3ZlcnJpZGVDb25maWcgPSBuZXcgQ29uZmlndXJhdGlvbigpOwogICAgICAgIGlmIChzdWJJbmZvICE9IG51bGwpIHsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubWNjID0gc3ViSW5mby5nZXRNY2MoKTsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubW5jID0gc3ViSW5mby5nZXRNbmMoKTsKICAgICAgICAgICAgaWYgKG92ZXJyaWRlQ29uZmlnLm1uYyA9PSAwKSB7CiAgICAgICAgICAgICAgICBvdmVycmlkZUNvbmZpZy5tbmMgPSBDb25maWd1cmF0aW9uLk1OQ19aRVJPOwogICAgICAgICAgICAgICAgY2FjaGVLZXkgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FjaGVLZXkgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcuc2V0TG9jYWxlKExvY2FsZS5ST09UKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBuZXcgY29udGV4dCB3aXRoIG5ldyBjb25maWd1cmF0aW9uIHNvIHRoYXQgd2UgY2FuIGF2b2lkIG1vZGlmeWluZyB0aGUKICAgICAgICAvLyBwYXNzZWQgaW4KICAgICAgICAvLyBjb250ZXh0LgogICAgICAgIC8vIE5vdGUgdGhhdCBpZiB0aGUgb3JpZ2luYWwgY29udGV4dCBjb25maWd1cmF0aW9uIGNoYW5nZXMsIHRoZSByZXNvdXJjZXMgaGVyZQogICAgICAgIC8vIHdpbGwgYWxzbwogICAgICAgIC8vIGNoYW5nZSBmb3IgYWxsIHZhbHVlcyBleGNlcHQgdGhvc2Ugb3ZlcnJpZGRlbiBieSBuZXdDb25maWcgKGUuZy4gaWYgdGhlCiAgICAgICAgLy8gZGV2aWNlIGhhcyBhbgogICAgICAgIC8vIG9yaWVudGF0aW9uIGNoYW5nZSkuCiAgICAgICAgQ29udGV4dCBuZXdDb250ZXh0ID0gY29udGV4dC5jcmVhdGVDb25maWd1cmF0aW9uQ29udGV4dChvdmVycmlkZUNvbmZpZyk7CiAgICAgICAgUmVzb3VyY2VzIHJlcyA9IG5ld0NvbnRleHQuZ2V0UmVzb3VyY2VzKCk7CgogICAgICAgIGlmIChjYWNoZUtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIC8vIFNhdmUgdGhlIG5ld2x5IGNyZWF0ZWQgUmVzb3VyY2VzIGluIHRoZSByZXNvdXJjZSBjYWNoZS4KICAgICAgICAgICAgc1Jlc291cmNlc0NhY2hlLnB1dChjYWNoZUtleSwgcmVzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGNvcnJlc3BvbmRzIHRvIGEgc3Vic2NyaXB0aW9uIHdoaWNoIGlzCiAgICAgKiBhY3RpdmVseSBpbgogICAgICogdXNlIG9uIHRoZSBkZXZpY2UuIEFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gSUQgaXMgYSB2YWxpZCBhbmQgdXNhYmxlCiAgICAgKiBzdWJzY3JpcHRpb24gSUQuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb24gSUQuCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGNvcnJlc3BvbmRzIHRvIGFuIGFjdGl2ZQogICAgICogICAgICAgICBzdWJzY3JpcHRpb247CiAgICAgKiAgICAgICAgIHtAY29kZSBmYWxzZX0gaWYgaXQgZG9lcyBub3QgY29ycmVzcG9uZCB0byBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uOyBvcgogICAgICogICAgICAgICB0aHJvdyBhCiAgICAgKiAgICAgICAgIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgaGFzbid0IGdvdCB0aGUgcmlnaHQgcGVybWlzc2lvbi4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIGlzQWN0aXZlU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBzdWIgSUQgaXMgYWN0aXZlLiBpLmUuIFRoZSBzdWIgSUQgY29ycmVzcG9uZHMgdG8gYSBrbm93bgogICAgICogICAgICAgICBzdWJzY3JpcHRpb24KICAgICAqICAgICAgICAgYW5kIHRoZSBTSU0gcHJvdmlkaW5nIHRoZSBzdWJzY3JpcHRpb24gaXMgcHJlc2VudCBpbiBhIHNsb3QgYW5kIGluCiAgICAgKiAgICAgICAgICJMT0FERUQiIHN0YXRlLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBib29sZWFuIGlzQWN0aXZlU3ViSWQoaW50IHN1YklkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpU3ViLmlzQWN0aXZlU3ViSWQoc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllcgogICAgICogYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0bwogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25QbGFuPiBnZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQpIHsKICAgICAgICBTdWJzY3JpcHRpb25QbGFuW10gc3Vic2NyaXB0aW9uUGxhbnMgPSBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLmdldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLAogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uUGxhbnMgPT0gbnVsbAogICAgICAgICAgICAgICAgPyBDb2xsZWN0aW9ucy5lbXB0eUxpc3QoKQogICAgICAgICAgICAgICAgOiBBcnJheXMuYXNMaXN0KHN1YnNjcmlwdGlvblBsYW5zKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIKICAgICAqIGFuZCBhIHNwZWNpZmljIHN1YnNjcmliZXIuCiAgICAgKiA8cD4KICAgICAqIFRoaXMgbWV0aG9kIGlzIG9ubHkgYWNjZXNzaWJsZSB0byB0aGUgZm9sbG93aW5nIG5hcnJvdyBzZXQgb2YgYXBwczoKICAgICAqIDx1bD4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZm9yIHRoaXMgc3Vic2NyaWJlcklkLCBhcyBkZXRlcm1pbmVkIGJ5CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfS4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZXhwbGljaXRseSBkZWxlZ2F0ZWQgYWNjZXNzIHRocm91Z2gKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ09ORklHX1BMQU5TX1BBQ0tBR0VfT1ZFUlJJREVfU1RSSU5HfS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpYmVyIHRoaXMgcmVsYXRpb25zaGlwIGFwcGxpZXMgdG8uIEFuIGVtcHR5IGxpc3QKICAgICAqICAgICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgdGhlIGxpc3Qgb2YgcGxhbnMuIFRoZSBmaXJzdCBwbGFuIGlzIGFsd2F5cyB0aGUgcHJpbWFyeSBhbmQKICAgICAqICAgICAgICAgICAgICBtb3N0IGltcG9ydGFudCBwbGFuLiBBbnkgYWRkaXRpb25hbCBwbGFucyBhcmUgc2Vjb25kYXJ5IGFuZAogICAgICogICAgICAgICAgICAgIG1heSBub3QgYmUgZGlzcGxheWVkIG9yIHVzZWQgYnkgZGVjaXNpb24gbWFraW5nIGxvZ2ljLgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiAgICAgICAgaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBwbGFucyBkb24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluZWQgaW4ge0BsaW5rIFN1YnNjcmlwdGlvblBsYW59LgogICAgICogQGRlcHJlY2F0ZWQgdXNlIHtAbGluayAjc2V0U3Vic2NyaXB0aW9uUGxhbnMoaW50LCBMaXN0LCBsb25nKX0gaW5zdGVhZC4KICAgICAqLwogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvblBsYW5zKGludCBzdWJJZCwgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25QbGFuPiBwbGFucykgewogICAgICAgIHNldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLCBwbGFucywgMCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyCiAgICAgKiBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICAgICAgICAgICAgICAgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0by4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQW4gZW1wdHkgbGlzdAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgICAgICAgICAgICAgICAgICAgIHRoZSBsaXN0IG9mIHBsYW5zLiBUaGUgZmlyc3QgcGxhbiBpcyBhbHdheXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHByaW1hcnkgYW5kCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vc3QgaW1wb3J0YW50IHBsYW4uIEFueSBhZGRpdGlvbmFsIHBsYW5zIGFyZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnkgYW5kCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heSBub3QgYmUgZGlzcGxheWVkIG9yIHVzZWQgYnkgZGVjaXNpb24KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFraW5nIGxvZ2ljLgogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHN1YnNjcmlwdGlvbgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFucwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGxlYXZlIHRoZSBwbGFucyB1bnRpbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBsaWNpdGx5IGNsZWFyZWQsIG9yIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uICAgICAgICBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIHBsYW5zIGRvbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5lZCBpbiB7QGxpbmsgU3Vic2NyaXB0aW9uUGxhbn0uCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvblBsYW5zKGludCBzdWJJZCwgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25QbGFuPiBwbGFucywKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIGdldE5ldHdvcmtQb2xpY3lNYW5hZ2VyKCkuc2V0U3Vic2NyaXB0aW9uUGxhbnMoc3ViSWQsCiAgICAgICAgICAgICAgICBwbGFucy50b0FycmF5KG5ldyBTdWJzY3JpcHRpb25QbGFuWzBdKSwgZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzLAogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRlbXBvcmFyaWx5IG92ZXJyaWRlIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyIGFuZAogICAgICogYSBzcGVjaWZpYyBzdWJzY3JpYmVyIHRvIGJlIGNvbnNpZGVyZWQgdW5tZXRlcmVkLiBUaGlzIHdpbGwgYmUgcmVmbGVjdGVkCiAgICAgKiB0byBhcHBzIHZpYSB7QGxpbmsgTmV0d29ya0NhcGFiaWxpdGllcyNORVRfQ0FQQUJJTElUWV9OT1RfTUVURVJFRH0uCiAgICAgKiA8cD4KICAgICAqIFRoaXMgbWV0aG9kIGlzIG9ubHkgYWNjZXNzaWJsZSB0byB0aGUgZm9sbG93aW5nIG5hcnJvdyBzZXQgb2YgYXBwczoKICAgICAqIDx1bD4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZm9yIHRoaXMgc3Vic2NyaWJlcklkLCBhcyBkZXRlcm1pbmVkIGJ5CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfS4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZXhwbGljaXRseSBkZWxlZ2F0ZWQgYWNjZXNzIHRocm91Z2gKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ09ORklHX1BMQU5TX1BBQ0tBR0VfT1ZFUlJJREVfU1RSSU5HfS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHN1YklkICAgICAgICAgICAgICAgICAgICB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVVbm1ldGVyZWQgICAgICAgIHNldCBpZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgc2hvdWxkIGJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNpZGVyZWQgdW5tZXRlcmVkLgogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvcgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZVVubWV0ZXJlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVVbm1ldGVyZWQsCiAgICAgICAgICAgIEBEdXJhdGlvbk1pbGxpc0xvbmcgbG9uZyBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpIHsKICAgICAgICBzZXRTdWJzY3JpcHRpb25PdmVycmlkZVVubWV0ZXJlZChzdWJJZCwgb3ZlcnJpZGVVbm1ldGVyZWQsCiAgICAgICAgICAgICAgICBUZWxlcGhvbnlNYW5hZ2VyLmdldEFsbE5ldHdvcmtUeXBlcygpLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpOwogICAgfQoKICAgIC8qKgogICAgICogVGVtcG9yYXJpbHkgb3ZlcnJpZGUgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIgYW5kCiAgICAgKiBhIHNwZWNpZmljIHN1YnNjcmliZXIgdG8gYmUgY29uc2lkZXJlZCB1bm1ldGVyZWQuIFRoaXMgd2lsbCBiZSByZWZsZWN0ZWQKICAgICAqIHRvIGFwcHMgdmlhIHtAbGluayBOZXR3b3JrQ2FwYWJpbGl0aWVzI05FVF9DQVBBQklMSVRZX05PVF9NRVRFUkVEfS4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgICAgICAgICAgICAgICAgICAgIHRoZSBzdWJzY3JpYmVyIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4KICAgICAqIEBwYXJhbSBvdmVycmlkZVVubWV0ZXJlZCAgICAgICAgc2V0IGlmIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBzaG91bGQgYmUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc2lkZXJlZCB1bm1ldGVyZWQuCiAgICAgKiBAcGFyYW0gbmV0d29ya1R5cGVzICAgICAgICAgICAgIHRoZSBuZXR3b3JrIHR5cGVzIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgbm8KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29yayB0eXBlcyBhcmUgc3BlY2lmaWVkLCBvdmVycmlkZSB2YWx1ZXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSBpZ25vcmVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7QHNlZSBUZWxlcGhvbnlNYW5hZ2VyI2dldEFsbE5ldHdvcmtUeXBlcygpfQogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvcgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZVVubWV0ZXJlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVVbm1ldGVyZWQsCiAgICAgICAgICAgIEBOb25OdWxsIEBBbm5vdGF0aW9uLk5ldHdvcmtUeXBlIGludFtdIG5ldHdvcmtUeXBlcywKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIGZpbmFsIGludCBvdmVycmlkZVZhbHVlID0gb3ZlcnJpZGVVbm1ldGVyZWQgPyBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEIDogMDsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvbk92ZXJyaWRlKHN1YklkLCBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVELAogICAgICAgICAgICAgICAgb3ZlcnJpZGVWYWx1ZSwgbmV0d29ya1R5cGVzLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIGNvbmdlc3RlZC4gVGhpcyB3aWxsIGNhdXNlIHRoZQogICAgICogZGV2aWNlIHRvIGRlbGF5IGNlcnRhaW4gbmV0d29yayByZXF1ZXN0cyB3aGVuIHBvc3NpYmxlLCBzdWNoIGFzIGRldmVsb3BlcgogICAgICogam9icyB0aGF0IGFyZSB3aWxsaW5nIHRvIHJ1biBpbiBhIGZsZXhpYmxlIHRpbWUgd2luZG93LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICAgICAgICAgICAgICAgdGhlIHN1YnNjcmliZXIgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLgogICAgICogQHBhcmFtIG92ZXJyaWRlQ29uZ2VzdGVkICAgICAgICBzZXQgaWYgdGhlIHN1YnNjcmlwdGlvbiBzaG91bGQgYmUgY29uc2lkZXJlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25nZXN0ZWQuCiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgcmVxdWVzdGVkCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJyaWRlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gbGVhdmUgaW4gdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RlZCBzdGF0ZSB1bnRpbCBleHBsaWNpdGx5IGNsZWFyZWQsIG9yCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlQ29uZ2VzdGVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZUNvbmdlc3RlZCwKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlQ29uZ2VzdGVkKHN1YklkLCBvdmVycmlkZUNvbmdlc3RlZCwKICAgICAgICAgICAgICAgIFRlbGVwaG9ueU1hbmFnZXIuZ2V0QWxsTmV0d29ya1R5cGVzKCksIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIGNvbmdlc3RlZC4gVGhpcyB3aWxsIGNhdXNlIHRoZQogICAgICogZGV2aWNlIHRvIGRlbGF5IGNlcnRhaW4gbmV0d29yayByZXF1ZXN0cyB3aGVuIHBvc3NpYmxlLCBzdWNoIGFzIGRldmVsb3BlcgogICAgICogam9icyB0aGF0IGFyZSB3aWxsaW5nIHRvIHJ1biBpbiBhIGZsZXhpYmxlIHRpbWUgd2luZG93LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICAgICAgICAgICAgICAgdGhlIHN1YnNjcmliZXIgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLgogICAgICogQHBhcmFtIG92ZXJyaWRlQ29uZ2VzdGVkICAgICAgICBzZXQgaWYgdGhlIHN1YnNjcmlwdGlvbiBzaG91bGQgYmUgY29uc2lkZXJlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25nZXN0ZWQuCiAgICAgKiBAcGFyYW0gbmV0d29ya1R5cGVzICAgICAgICAgICAgIHRoZSBuZXR3b3JrIHR5cGVzIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgbm8KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29yayB0eXBlcyBhcmUgc3BlY2lmaWVkLCBvdmVycmlkZSB2YWx1ZXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSBpZ25vcmVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7QHNlZSBUZWxlcGhvbnlNYW5hZ2VyI2dldEFsbE5ldHdvcmtUeXBlcygpfQogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvcgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZUNvbmdlc3RlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVDb25nZXN0ZWQsCiAgICAgICAgICAgIEBOb25OdWxsIEBBbm5vdGF0aW9uLk5ldHdvcmtUeXBlIGludFtdIG5ldHdvcmtUeXBlcywKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIGZpbmFsIGludCBvdmVycmlkZVZhbHVlID0gb3ZlcnJpZGVDb25nZXN0ZWQgPyBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfQ09OR0VTVEVEIDogMDsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvbk92ZXJyaWRlKHN1YklkLCBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfQ09OR0VTVEVELAogICAgICAgICAgICAgICAgb3ZlcnJpZGVWYWx1ZSwgbmV0d29ya1R5cGVzLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgYXBwIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhlCiAgICAgKiBnaXZlbiBzdWJzY3JpcHRpb24KICAgICAqIGFjY29yZGluZyB0byBpdHMgbWV0YWRhdGEuCiAgICAgKgogICAgICogT25seSBzdXBwb3J0ZWQgZm9yIGVtYmVkZGVkIHN1YnNjcmlwdGlvbnMgKGlmCiAgICAgKiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyBUaGUgc3Vic2NyaXB0aW9uIHRvIGNoZWNrLgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBhcHAgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhpcyBzdWJzY3JpcHRpb24gcGVyIGl0cwogICAgICogICAgICAgICBtZXRhZGF0YS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8gaW5mbykgewogICAgICAgIHJldHVybiBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oaW5mbywgbUNvbnRleHQuZ2V0UGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24uCiAgICAgKiBBbiBhcHAgY2FuIG9ubHkKICAgICAqIGJlIGF1dGhvcml6ZWQgaWYgaXQgaXMgaW5jbHVkZWQgaW4gdGhlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuVWljY0FjY2Vzc1J1bGV9IG9mIHRoZQogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlN1YnNjcmlwdGlvbkluZm99IHdpdGggdGhlIGFjY2VzcyBzdGF0dXMuCiAgICAgKgogICAgICogT25seSBzdXBwb3J0ZWQgZm9yIGVtYmVkZGVkIHN1YnNjcmlwdGlvbnMgKGlmCiAgICAgKiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyAgICAgICAgVGhlIHN1YnNjcmlwdGlvbiB0byBjaGVjay4KICAgICAqIEBwYXJhbSBwYWNrYWdlTmFtZSBQYWNrYWdlIG5hbWUgb2YgdGhlIGFwcCB0byBjaGVjay4KICAgICAqIEByZXR1cm4gd2hldGhlciB0aGUgYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoaXMgc3Vic2NyaXB0aW9uIHBlciBpdHMKICAgICAqICAgICAgICAgYWNjZXNzIHJ1bGVzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKEBOb25OdWxsIFN1YnNjcmlwdGlvbkluZm8gaW5mbywKICAgICAgICAgICAgQE5vbk51bGwgU3RyaW5nIHBhY2thZ2VOYW1lKSB7CiAgICAgICAgaWYgKGluZm8gPT0gbnVsbCB8fCBpbmZvLmdldEFsbEFjY2Vzc1J1bGVzKCkgPT0gbnVsbCB8fCBwYWNrYWdlTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgUGFja2FnZU1hbmFnZXIgcGFja2FnZU1hbmFnZXIgPSBtQ29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpOwogICAgICAgIFBhY2thZ2VJbmZvIHBhY2thZ2VJbmZvOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHBhY2thZ2VJbmZvID0gcGFja2FnZU1hbmFnZXIuZ2V0UGFja2FnZUluZm8ocGFja2FnZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgUGFja2FnZU1hbmFnZXIuR0VUX1NJR05JTkdfQ0VSVElGSUNBVEVTKTsKICAgICAgICB9IGNhdGNoIChQYWNrYWdlTWFuYWdlci5OYW1lTm90Rm91bmRFeGNlcHRpb24gZSkgewogICAgICAgICAgICBsb2dkKCJVbmtub3duIHBhY2thZ2U6ICIgKyBwYWNrYWdlTmFtZSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZm9yIChVaWNjQWNjZXNzUnVsZSBydWxlIDogaW5mby5nZXRBbGxBY2Nlc3NSdWxlcygpKSB7CiAgICAgICAgICAgIGlmIChydWxlLmdldENhcnJpZXJQcml2aWxlZ2VTdGF0dXMocGFja2FnZUluZm8pID09IFRlbGVwaG9ueU1hbmFnZXIuQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX0hBU19BQ0NFU1MpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzCiAgICAgKiB1c2VkCiAgICAgKiBieSBBbHRlcm5hdGl2ZU5ldHdvcmtTZXJ2aWNlIG9yIGNhcnJpZXIgYXBwcyB0byBzd2l0Y2ggcHJpbWFyeSBhbmQgQ0JSUwogICAgICogc3Vic2NyaXB0aW9uIGR5bmFtaWNhbGx5IGluIG11bHRpLVNJTSBkZXZpY2VzLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICAgICB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIHRvIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogICAgICAgICAgICAgICAgICAgICAgIElmIGl0J3MKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0sIGl0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgbWVhbnMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICBpdCdzIHVuc2V0IGFuZAogICAgICogICAgICAgICAgICAgICAgICAgICAgIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBpcyB1c2VkIHRvIGRldGVybWluZSB3aGljaCBtb2RlbSBpcyBwcmVmZXJyZWQuCiAgICAgKiBAcGFyYW0gbmVlZFZhbGlkYXRpb24gd2hldGhlciBUZWxlcGhvbnkgd2lsbCB3YWl0IHVudGlsIHRoZSBuZXR3b3JrIGlzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVkIGJ5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGl2aXR5IHNlcnZpY2UgYmVmb3JlIHN3aXRjaGluZyBkYXRhIHRvIGl0LiBNb3JlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlscyBzZWUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgTmV0d29ya0NhcGFiaWxpdGllcyNORVRfQ0FQQUJJTElUWV9WQUxJREFURUR9LgogICAgICogQHBhcmFtIGV4ZWN1dG9yICAgICAgIFRoZSBleGVjdXRvciBvZiB3aGVyZSB0aGUgY2FsbGJhY2sgd2lsbCBleGVjdXRlLgogICAgICogQHBhcmFtIGNhbGxiYWNrICAgICAgIENhbGxiYWNrIHdpbGwgYmUgdHJpZ2dlcmVkIG9uY2UgaXQgc3VjY2VlZHMgb3IgZmFpbGVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgIFBhc3MgbnVsbCBpZiBkb24ndCBjYXJlIGFib3V0IHRoZSByZXN1bHQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZChpbnQgc3ViSWQsIGJvb2xlYW4gbmVlZFZhbGlkYXRpb24sCiAgICAgICAgICAgIEBOdWxsYWJsZSBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE51bGxhYmxlIEBUZWxlcGhvbnlNYW5hZ2VyLlNldE9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25SZXN1bHQgQ29uc3VtZXI8SW50ZWdlcj4gY2FsbGJhY2spIHsKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgiW3NldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZF0rIHN1YklkOiIgKyBzdWJJZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBJU2V0T3Bwb3J0dW5pc3RpY0RhdGFDYWxsYmFjayBjYWxsYmFja1N0dWIgPSBuZXcgSVNldE9wcG9ydHVuaXN0aWNEYXRhQ2FsbGJhY2suU3R1YigpIHsKICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgb25Db21wbGV0ZShpbnQgcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4ZWN1dG9yID09IG51bGwgfHwgY2FsbGJhY2sgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpbmFsIGxvbmcgaWRlbnRpdHkgPSBCaW5kZXIuY2xlYXJDYWxsaW5nSWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFjY2VwdChyZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBpU3ViLnNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZChzdWJJZCwgbmVlZFZhbGlkYXRpb24sIGNhbGxiYWNrU3R1Yik7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzCiAgICAgKiB1c2VkCiAgICAgKiBieSBBbHRlcm5hdGl2ZU5ldHdvcmtTZXJ2aWNlIG9yIGNhcnJpZXIgYXBwcyB0byBzd2l0Y2ggcHJpbWFyeSBhbmQgQ0JSUwogICAgICogc3Vic2NyaXB0aW9uIGR5bmFtaWNhbGx5IGluIG11bHRpLVNJTSBkZXZpY2VzLgogICAgICoKICAgICAqIEByZXR1cm4gcHJlZmVycmVkIHN1YnNjcmlwdGlvbiBpZCBmb3IgY2VsbHVsYXIgZGF0YS4KICAgICAqICAgICAgICAge0BsaW5rIERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfSBpZgogICAgICogICAgICAgICB0aGVyZSdzIG5vIHByZWZlcmVkIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICoKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgZ2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIGludCBwcmVmZXJyZWRTdWJJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZWZlcnJlZFN1YklkID0gaVN1Yi5nZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBwcmVmZXJyZWRTdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgdGhhdCBjYW4gYmUgdmlzaWJsZSB0byB0aGUgY2FsbGVyLgogICAgICogT3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGFyZSBmb3Igb3Bwb3J0dW5pc3RpYyBuZXR3b3Jrcywgd2hpY2ggYXJlCiAgICAgKiBjZWxsdWxhcgogICAgICogbmV0d29ya3Mgd2l0aCBsaW1pdGVkIGNhcGFiaWxpdGllcyBhbmQgY292ZXJhZ2UsIGZvciBleGFtcGxlLCBDQlJTLgogICAgICoKICAgICAqIDxwPgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGxpc3Qgb2Ygb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gaW5mby4gSWYgbm9uZSBleGlzdHMsIGFuIGVtcHR5CiAgICAgKiAgICAgICAgIGxpc3QuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0T3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnMoKSB7CiAgICAgICAgU3RyaW5nIGNvbnRleHRQa2cgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgU3RyaW5nIGNvbnRleHRBdHRyaWJ1dGlvblRhZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpIDogbnVsbDsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHN1YkluZm9MaXN0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YkluZm9MaXN0ID0gaVN1Yi5nZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9ucyhjb250ZXh0UGtnLAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0QXR0cmlidXRpb25UYWcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHN1YkluZm9MaXN0ID09IG51bGwpIHsKICAgICAgICAgICAgc3ViSW5mb0xpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJbmZvTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIFN3aXRjaCB0byBhIGNlcnRhaW4gc3Vic2NyaXB0aW9uCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkICAgICAgICAgIHN1YiBpZAogICAgICogQHBhcmFtIGNhbGxiYWNrSW50ZW50IHBlbmRpbmcgaW50ZW50IHRoYXQgd2lsbCBiZSBzZW50IGFmdGVyIG9wZXJhdGlvbiBpcwogICAgICogICAgICAgICAgICAgICAgICAgICAgIGRvbmUuCiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICAgICAgIHRvLWJlLWRlcHJlY2F0ZWQgdGhpcyBBUEkgaXMgYSBkdXBsaWNhdGUgb2YKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgRXVpY2NNYW5hZ2VyI3N3aXRjaFRvU3Vic2NyaXB0aW9uKGludCwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICBQZW5kaW5nSW50ZW50KX0gYW5kIGRvZXMgbm90IHN1cHBvcnQgTXVsdGlwbGUgRW5hYmxlZAogICAgICogICAgICAgICAgICAgICAgICAgICAgIFByb2ZpbGUoTUVQKS4gQXBwcyBzaG91bGQgdXNlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsIFBlbmRpbmdJbnRlbnQpfQogICAgICogICAgICAgICAgICAgICAgICAgICAgIG9yCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsIGludCwgUGVuZGluZ0ludGVudCl9CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgaW5zdGVhZC4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uV1JJVEVfRU1CRURERURfU1VCU0NSSVBUSU9OUykKICAgIHB1YmxpYyB2b2lkIHN3aXRjaFRvU3Vic2NyaXB0aW9uKGludCBzdWJJZCwgQE5vbk51bGwgUGVuZGluZ0ludGVudCBjYWxsYmFja0ludGVudCkgewogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKGNhbGxiYWNrSW50ZW50LCAiY2FsbGJhY2tJbnRlbnQgY2Fubm90IGJlIG51bGwiKTsKICAgICAgICBFdWljY01hbmFnZXIgZXVpY2NNYW5hZ2VyID0gbmV3IEV1aWNjTWFuYWdlcihtQ29udGV4dCk7CiAgICAgICAgZXVpY2NNYW5hZ2VyLnN3aXRjaFRvU3Vic2NyaXB0aW9uKHN1YklkLCBjYWxsYmFja0ludGVudCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgd2hldGhlciBhIHN1YnNjcmlwdGlvbiBpcyBvcHBvcnR1bmlzdGljLCB0aGF0IGlzLCB3aGV0aGVyIHRoZSBuZXR3b3JrIGl0CiAgICAgKiBjb25uZWN0cwogICAgICogdG8gaGFzIGxpbWl0ZWQgY292ZXJhZ2UuIEZvciBleGFtcGxlLCBDQlJTLiBTZXR0aW5nIGEgc3Vic2NyaXB0aW9uCiAgICAgKiBvcHBvcnR1bmlzdGljIGhhcwogICAgICogZm9sbG93aW5nIGltcGFjdHM6CiAgICAgKiAxKSBFdmVuIGlmIGl0J3MgYWN0aXZlLCBpdCB3aWxsIGJlIGRvcm1hbnQgbW9zdCBvZiB0aGUgdGltZS4gVGhlIG1vZGVtIHdpbGwKICAgICAqIG5vdCB0cnkKICAgICAqIHRvIHNjYW4gb3IgY2FtcCB1bnRpbCBpdCBrbm93cyBhbiBhdmFpbGFibGUgbmV0d29yayBpcyBuZWFyYnkgdG8gc2F2ZSBwb3dlci4KICAgICAqIDIpIFRlbGVwaG9ueSByZWxpZXMgb24gc3lzdGVtIGFwcCBvciBjYXJyaWVyIGlucHV0IHRvIG5vdGlmeSBuZWFyYnkgYXZhaWxhYmxlCiAgICAgKiBuZXR3b3Jrcy4KICAgICAqIFNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjdXBkYXRlQXZhaWxhYmxlTmV0d29ya3MoTGlzdCwgRXhlY3V0b3IsIENvbnN1bWVyKX0KICAgICAqIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogMykgSW4gbXVsdGktU0lNIGRldmljZXMsIHdoZW4gdGhlIG5ldHdvcmsgaXMgbmVhcmJ5IGFuZCBjYW1wZWQsIHN5c3RlbSBtYXkKICAgICAqIGF1dG9tYXRpY2FsbHkKICAgICAqIHN3aXRjaCBpbnRlcm5ldCBkYXRhIGJldHdlZW4gaXQgYW5kIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24sIGJhc2VkIG9uCiAgICAgKiBjYXJyaWVyCiAgICAgKiByZWNvbW1lbmRhdGlvbiBhbmQgaXRzIHNpZ25hbCBzdHJlbmd0aCBhbmQgbWV0ZXJlZC1uZXNzLCBldGMuCiAgICAgKgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0gb3IgY2FycmllcgogICAgICogcHJpdmlsZWdlIHBlcm1pc3Npb24gb2YgdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gb3Bwb3J0dW5pc3RpYyB3aGV0aGVyIGl04oCZcyBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbi4KICAgICAqIEBwYXJhbSBzdWJJZCAgICAgICAgIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIG9wZXJhdGlvbiBpcyBzdWNjZWVkLCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldE9wcG9ydHVuaXN0aWMoYm9vbGVhbiBvcHBvcnR1bmlzdGljLCBpbnQgc3ViSWQpIHsKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgiW3NldE9wcG9ydHVuaXN0aWNdKyBvcHBvcnR1bmlzdGljOiIgKyBvcHBvcnR1bmlzdGljICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldE9wcG9ydHVuaXN0aWMiLAogICAgICAgICAgICAgICAgKGlTdWIpIC0+IGlTdWIuc2V0T3Bwb3J0dW5pc3RpYygKICAgICAgICAgICAgICAgICAgICAgICAgb3Bwb3J0dW5pc3RpYywgc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSkpID09IDE7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbmZvcm0gU3Vic2NyaXB0aW9uTWFuYWdlciB0aGF0IHN1YnNjcmlwdGlvbnMgaW4gdGhlIGxpc3QgYXJlIGJ1bmRsZWQKICAgICAqIGFzIGEgZ3JvdXAuIEl0IGNhbiBiZSBtdWx0aXBsZSBwcmltYXJ5IChub24tb3Bwb3J0dW5pc3RpYykgc3Vic2NyaXB0aW9ucywKICAgICAqIG9yIG9uZSBvciBtb3JlIHByaW1hcnkgcGx1cyBvbmUgb3IgbW9yZSBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMuCiAgICAgKgogICAgICogVGhpcyBBUEkgd2lsbCBhbHdheXMgY3JlYXRlIGEgbmV3IGltbXV0YWJsZSBncm91cCBhbmQgYXNzaWduIGdyb3VwIFVVSUQgdG8KICAgICAqIGFsbCB0aGUKICAgICAqIHN1YnNjcmlwdGlvbnMsIHJlZ2FyZGxlc3Mgd2hldGhlciB0aGV5IGFyZSBpbiBhIGdyb3VwIGFscmVhZHkgb3Igbm90LgogICAgICoKICAgICAqIEdyb3VwZWQgc3Vic2NyaXB0aW9ucyB3aWxsIGhhdmUgYmVsb3cgYmVoYXZpb3JzOgogICAgICogMSkgVGhleSB3aWxsIHNoYXJlIHRoZSBzYW1lIHVzZXIgc2V0dGluZ3MuCiAgICAgKiAyKSBUaGUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGluIHRoZSBncm91cCBpcyBjb25zaWRlcmVkIGludmlzaWJsZSBhbmQKICAgICAqIHdpbGwgbm90CiAgICAgKiByZXR1cm4gZnJvbSB7QGxpbmsgI2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCl9LCB1bmxlc3MgY2FsbGVyIGhhcwogICAgICogY2FycmllcgogICAgICogcHJpdmlsZWdlIHBlcm1pc3Npb24gb2YgdGhlIHN1YnNjcmlwdGlvbnMuCiAgICAgKiAzKSBUaGUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGluIHRoZSBncm91cCBjYW4ndCBiZSBhY3RpdmUgYnkgaXRzZWxmLiBJZgogICAgICogYWxsIG90aGVyCiAgICAgKiBub24tb3Bwb3J0dW5pc3RpYyBvbmVzIGFyZSBkZWFjdGl2YXRlZCAodW5wbHVnZ2VkIG9yIGRpc2FibGVkIGluIFNldHRpbmdzKSwKICAgICAqIHRoZSBvcHBvcnR1bmlzdGljIG9uZXMgd2lsbCBiZSBkZWFjdGl2YXRlZCBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiAgICAgICAgaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBhbnkgb2YgdGhlIHN1YnNjcmlwdGlvbnMgaW4gdGhlIGxpc3QKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvZXNuJ3QgZXhpc3QuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiAgICBpZiBUZWxlcGhvbnkgc2VydmljZSBpcyBpbiBiYWQgc3RhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkTGlzdCBsaXN0IG9mIHN1YklkIHRoYXQgd2lsbCBiZSBpbiB0aGUgc2FtZSBncm91cAogICAgICogQHJldHVybiBncm91cFVVSUQgYSBVVUlEIGFzc2lnbmVkIHRvIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIFBhcmNlbFV1aWQgY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChzdWJJZExpc3QsICJjYW4ndCBjcmVhdGUgZ3JvdXAgZm9yIG51bGwgc3ViSWQgbGlzdCIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXBdIik7CiAgICAgICAgfQoKICAgICAgICBQYXJjZWxVdWlkIGdyb3VwVXVpZCA9IG51bGw7CiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpIC0+IGkpLnRvQXJyYXkoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZ3JvdXBVdWlkID0gaVN1Yi5jcmVhdGVTdWJzY3JpcHRpb25Hcm91cChzdWJJZEFycmF5LCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJjcmVhdGVTdWJzY3JpcHRpb25Hcm91cCBSZW1vdGVFeGNlcHRpb24gIiArIGV4KTsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ3JvdXBVdWlkOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGludG8gYSBncm91cC4KICAgICAqIFNlZSB7QGxpbmsgI2NyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwKExpc3QpfSBmb3IgbW9yZSBkZXRhaWxzLgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiAgICAgICAgaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiB0aGUgc29tZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2Vzbid0IGV4aXN0LgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gICAgaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZExpc3QgbGlzdCBvZiBzdWJJZCB0aGF0IG5lZWQgYWRkaW5nIGludG8gdGhlIGdyb3VwCiAgICAgKiBAcGFyYW0gZ3JvdXBVdWlkIHRoZSBncm91cFV1aWQgdGhlIHN1YnNjcmlwdGlvbnMgYXJlIGJlaW5nIGFkZGVkIHRvLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBhZGRTdWJzY3JpcHRpb25zSW50b0dyb3VwKEBOb25OdWxsIExpc3Q8SW50ZWdlcj4gc3ViSWRMaXN0LAogICAgICAgICAgICBATm9uTnVsbCBQYXJjZWxVdWlkIGdyb3VwVXVpZCkgewogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKHN1YklkTGlzdCwgInN1YklkTGlzdCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKGdyb3VwVXVpZCwgImdyb3VwVXVpZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbYWRkU3Vic2NyaXB0aW9uc0ludG9Hcm91cF0iKTsKICAgICAgICB9CgogICAgICAgIGludFtdIHN1YklkQXJyYXkgPSBzdWJJZExpc3Quc3RyZWFtKCkubWFwVG9JbnQoaSAtPiBpKS50b0FycmF5KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLmFkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXAoc3ViSWRBcnJheSwgZ3JvdXBVdWlkLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJhZGRTdWJzY3JpcHRpb25zSW50b0dyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBib29sZWFuIGlzU3lzdGVtUHJvY2VzcygpIHsKICAgICAgICByZXR1cm4gUHJvY2Vzcy5teVVpZCgpID09IFByb2Nlc3MuU1lTVEVNX1VJRDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmcm9tIHRoZWlyIHN1YnNjcmlwdGlvbiBncm91cC4KICAgICAqIFNlZSB7QGxpbmsgI2NyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwKExpc3QpfSBmb3IgbW9yZSBkZXRhaWxzLgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiAgICAgICAgaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiB0aGUgc29tZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2Vzbid0IGJlbG9uZwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHNwZWNpZmllZCBncm91cC4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uICAgIGlmIFRlbGVwaG9ueSBzZXJ2aWNlIGlzIGluIGJhZCBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWRMaXN0IGxpc3Qgb2Ygc3ViSWQgdGhhdCBuZWVkIHJlbW92aW5nIGZyb20gdGhlaXIgZ3JvdXBzLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCByZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwKEBOb25OdWxsIExpc3Q8SW50ZWdlcj4gc3ViSWRMaXN0LAogICAgICAgICAgICBATm9uTnVsbCBQYXJjZWxVdWlkIGdyb3VwVXVpZCkgewogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKHN1YklkTGlzdCwgInN1YklkTGlzdCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKGdyb3VwVXVpZCwgImdyb3VwVXVpZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbcmVtb3ZlU3Vic2NyaXB0aW9uc0Zyb21Hcm91cF0iKTsKICAgICAgICB9CgogICAgICAgIGludFtdIHN1YklkQXJyYXkgPSBzdWJJZExpc3Quc3RyZWFtKCkubWFwVG9JbnQoaSAtPiBpKS50b0FycmF5KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAoc3ViSWRBcnJheSwgZ3JvdXBVdWlkLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgc3Vic2NyaXB0aW9uSW5mbyBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgdGhhdCBhcmUgaW4gdGhlIHNhbWUgZ3JvdXAgb2YKICAgICAqIGdpdmVuIHN1YklkLgogICAgICogU2VlIHtAbGluayAjY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoTGlzdCl9IGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQ2FsbGVyIG11c3QgaGF2ZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciBjYXJyaWVyIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9uIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfQogICAgICoKICAgICAqIDxwPgogICAgICogU3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMzMsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGFuIGVtcHR5IExpc3QgaWYgdGhlCiAgICAgKiBjYWxsZXIgZG9lcwogICAgICogbm90IGhhdmUgYWNjZXNzIHRvIGRldmljZSBpZGVudGlmaWVycy4KICAgICAqIFRoaXMgbWV0aG9kIGNhbiBiZSBpbnZva2VkIGlmIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlcXVpcmVtZW50cyBpcyBtZXQ6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+SWYgdGhlIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbi4KICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9CiAgICAgKiA8bGk+SWYgdGhlIGFwcCBoYXMge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFfQogICAgICogcGVybWlzc2lvbiBhbmQKICAgICAqIGFjY2VzcyB0byBkZXZpY2UgaWRlbnRpZmllcnMuCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIFRlbGVwaG9ueSBzZXJ2aWNlIGlzIGluIGJhZCBzdGF0ZS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gICAgIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICoKICAgICAqIEBwYXJhbSBncm91cFV1aWQgb2Ygd2hpY2ggbGlzdCBvZiBzdWJJbmZvIHdpbGwgYmUgcmV0dXJuZWQuCiAgICAgKiBAcmV0dXJuIGxpc3Qgb2Ygc3Vic2NyaXB0aW9uSW5mbyB0aGF0IGJlbG9uZyB0byB0aGUgc2FtZSBncm91cCwgaW5jbHVkaW5nIHRoZQogICAgICogICAgICAgICBnaXZlbgogICAgICogICAgICAgICBzdWJzY3JpcHRpb24gaXRzZWxmLiBJdCB3aWxsIHJldHVybiBhbiBlbXB0eSBsaXN0IGlmIG5vIHN1YnNjcmlwdGlvbgogICAgICogICAgICAgICBiZWxvbmdzIHRvIHRoZSBncm91cC4KICAgICAqCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldFN1YnNjcmlwdGlvbnNJbkdyb3VwKEBOb25OdWxsIFBhcmNlbFV1aWQgZ3JvdXBVdWlkKSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoZ3JvdXBVdWlkLCAiZ3JvdXBVdWlkIGNhbid0IGJlIG51bGwiKTsKICAgICAgICBTdHJpbmcgY29udGV4dFBrZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBTdHJpbmcgY29udGV4dEF0dHJpYnV0aW9uVGFnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkgOiBudWxsOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXRTdWJzY3JpcHRpb25zSW5Hcm91cF0rIGdyb3VwVXVpZDoiICsgZ3JvdXBVdWlkKTsKICAgICAgICB9CgogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gcmVzdWx0ID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRTdWJzY3JpcHRpb25zSW5Hcm91cChncm91cFV1aWQsIGNvbnRleHRQa2csCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHRBdHRyaWJ1dGlvblRhZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIHZpc2libGUgdG8gQVBJIGNhbGxlci4gSWYgaXQncyBhIGJ1bmRsZWQKICAgICAqIG9wcG9ydHVuaXN0aWMKICAgICAqIHN1YnNjcmlwdGlvbiwgaXQgc2hvdWxkIGJlIGhpZGRlbiBhbnl3aGVyZSBpbiBTZXR0aW5ncywgZGlhbGVyLCBzdGF0dXMgYmFyCiAgICAgKiBldGMuCiAgICAgKiBFeGNlcHRpb24gaXMgaWYgY2FsbGVyIG93bnMgY2FycmllciBwcml2aWxlZ2UsIGluIHdoaWNoIGNhc2UgdGhleSB3aWxsCiAgICAgKiB3YW50IHRvIHNlZSB0aGVpciBvd24gaGlkZGVuIHN1YnNjcmlwdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIGluZm8gdGhlIHN1YnNjcmlwdGlvbkluZm8gdG8gY2hlY2sgYWdhaW5zdC4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGlzIHN1YnNjcmlwdGlvbiBzaG91bGQgYmUgdmlzaWJsZSB0byB0aGUgQVBJIGNhbGxlci4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc1N1YnNjcmlwdGlvblZpc2libGUoU3Vic2NyaXB0aW9uSW5mbyBpbmZvKSB7CiAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIElmIHN1YnNjcmlwdGlvbiBpcyBOT1QgZ3JvdXBlZCBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiwgaXQncyB2aXNpYmxlLgogICAgICAgIGlmIChpbmZvLmdldEdyb3VwVXVpZCgpID09IG51bGwgfHwgIWluZm8uaXNPcHBvcnR1bmlzdGljKCkpCiAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBJZiB0aGUgY2FsbGVyIGlzIHRoZSBjYXJyaWVyIGFwcCBhbmQgb3ducyB0aGUgc3Vic2NyaXB0aW9uLCBpdCBzaG91bGQgYmUKICAgICAgICAvLyB2aXNpYmxlCiAgICAgICAgLy8gdG8gdGhlIGNhbGxlci4KICAgICAgICBib29sZWFuIGhhc0NhcnJpZXJQcml2aWxlZ2VQZXJtaXNzaW9uID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KQogICAgICAgICAgICAgICAgLmhhc0NhcnJpZXJQcml2aWxlZ2VzKGluZm8uZ2V0U3Vic2NyaXB0aW9uSWQoKSkKICAgICAgICAgICAgICAgIHx8IGNhbk1hbmFnZVN1YnNjcmlwdGlvbihpbmZvKTsKICAgICAgICByZXR1cm4gaGFzQ2FycmllclByaXZpbGVnZVBlcm1pc3Npb247CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgdGhhdCBhcmUgYXZhaWxhYmxlIGFuZCB2aXNpYmxlIHRvIHRoZSB1c2VyLgogICAgICogVXNlZCBieSBTZXR0aW5ncyBhcHAgdG8gc2hvdyBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdXNlciB0byBwaWNrLgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBpcwogICAgICogcmVxdWlyZWQKICAgICAqIGZvciBnZXRTZWxlY3RhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QgdG8gYmUgaW52b2tlZC4KICAgICAqIAogICAgICogQHJldHVybiBsaXN0IG9mIHVzZXIgc2VsZWN0YWJsZSBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRTZWxlY3RhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBhdmFpbGFibGVMaXN0ID0gZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKTsKICAgICAgICBpZiAoYXZhaWxhYmxlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE11bHRpcGxlIHN1YnNjcmlwdGlvbnMgaW4gYSBncm91cCBzaG91bGQgb25seSBoYXZlIG9uZSByZXByZXNlbnRhdGl2ZS4KICAgICAgICAgICAgLy8gSXQgc2hvdWxkIGJlIHRoZSBjdXJyZW50IGFjdGl2ZSBwcmltYXJ5IHN1YnNjcmlwdGlvbiBpZiBhbnksIG9yIGFueQogICAgICAgICAgICAvLyBwcmltYXJ5IHN1YnNjcmlwdGlvbi4KICAgICAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBzZWxlY3RhYmxlTGlzdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgICAgICBNYXA8UGFyY2VsVXVpZCwgU3Vic2NyaXB0aW9uSW5mbz4gZ3JvdXBNYXAgPSBuZXcgSGFzaE1hcDw+KCk7CgogICAgICAgICAgICBmb3IgKFN1YnNjcmlwdGlvbkluZm8gaW5mbyA6IGF2YWlsYWJsZUxpc3QpIHsKICAgICAgICAgICAgICAgIC8vIE9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBhcmUgY29uc2lkZXJlZCBpbnZpc2libGUKICAgICAgICAgICAgICAgIC8vIHRvIHVzZXJzIHNvIHRoZXkgc2hvdWxkIG5ldmVyIGJlIHJldHVybmVkLgogICAgICAgICAgICAgICAgaWYgKCFpc1N1YnNjcmlwdGlvblZpc2libGUoaW5mbykpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgUGFyY2VsVXVpZCBncm91cFV1aWQgPSBpbmZvLmdldEdyb3VwVXVpZCgpOwogICAgICAgICAgICAgICAgaWYgKGdyb3VwVXVpZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRG9lc24ndCBiZWxvbmcgdG8gYW55IGdyb3VwLiBBZGQgaW4gdGhlIGxpc3QuCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZUxpc3QuYWRkKGluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZ3JvdXBNYXAuY29udGFpbnNLZXkoZ3JvdXBVdWlkKQogICAgICAgICAgICAgICAgICAgICAgICB8fCAoZ3JvdXBNYXAuZ2V0KGdyb3VwVXVpZCkuZ2V0U2ltU2xvdEluZGV4KCkgPT0gSU5WQUxJRF9TSU1fU0xPVF9JTkRFWAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGluZm8uZ2V0U2ltU2xvdEluZGV4KCkgIT0gSU5WQUxJRF9TSU1fU0xPVF9JTkRFWCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBiZWxvbmdzIHRvIGEgZ3JvdXAgdGhhdCBoYXMgbmV2ZXIgYmVlbiByZWNvcmRlZCBvciBpdCdzIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgLy8gYWN0aXZlIHN1YnNjcmlwdGlvbiwgYWRkIGl0IGluIHRoZSBsaXN0LgogICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGVMaXN0LnJlbW92ZShncm91cE1hcC5nZXQoZ3JvdXBVdWlkKSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZUxpc3QuYWRkKGluZm8pOwogICAgICAgICAgICAgICAgICAgIGdyb3VwTWFwLnB1dChncm91cFV1aWQsIGluZm8pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VsZWN0YWJsZUxpc3Q7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlcyBvciBkaXNhYmxlcyBhIHN1YnNjcmlwdGlvbi4gVGhpcyBpcyBjdXJyZW50bHkgdXNlZCBpbiB0aGUgc2V0dGluZ3MKICAgICAqIHBhZ2UuIEl0IHdpbGwKICAgICAqIGZhaWwgYW5kIHJldHVybiBmYWxzZSBpZiBvcGVyYXRpb24gaXMgbm90IHN1cHBvcnRlZCBvciBmYWlsZWQuCiAgICAgKgogICAgICogVG8gZGlzYWJsZSBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uIG9uIGEgcGh5c2ljYWwgKG5vbi1FdWljYykgU0lNLAogICAgICoge0BsaW5rICNjYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb259IG5lZWRzIHRvIGJlIHRydWUuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBQZXJtaXNzaW9ucyBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFIGlzIHJlcXVpcmVkCiAgICAgKgogICAgICogQHBhcmFtIGVuYWJsZSAgICAgICAgIHdoZXRoZXIgdXNlciBpcyB0dXJuaW5nIGl0IG9uIG9yIG9mZi4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gdG8gYmUgZW5hYmxlZCBvciBkaXNhYmxlZC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBJdCBjb3VsZCBiZSBhIGVTSU0gb3IgcFNJTSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBvcGVyYXRpb24gaXMgc3VjY2Vzc2Z1bC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRTdWJzY3JpcHRpb25FbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCwgYm9vbGVhbiBlbmFibGUpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJzZXRTdWJzY3JpcHRpb25BY3RpdmF0ZWQgc3ViSWQ9ICIgKyBzdWJzY3JpcHRpb25JZCArICIgZW5hYmxlICIgKyBlbmFibGUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuc2V0U3Vic2NyaXB0aW9uRW5hYmxlZChlbmFibGUsIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB1aWNjIGFwcGxpY2F0aW9ucyBiZWluZyBlbmFibGVkIG9yIGRpc2FibGVkLgogICAgICogVGhlIHZhbHVlIHdpbGwgYmUgcmVtZW1iZXJlZCBvbiB0aGUgc3Vic2NyaXB0aW9uIGFuZCB3aWxsIGJlIGFwcGxpZWQgd2hlbmV2ZXIKICAgICAqIGl0J3MgcHJlc2VudC4KICAgICAqIElmIHRoZSBzdWJzY3JpcHRpb24gaW4gY3VycmVudGx5IHByZXNlbnQsIGl0IHdpbGwgYWxzbyBhcHBseSB0aGUgc2V0dGluZyB0bwogICAgICogbW9kZW0KICAgICAqIGltbWVkaWF0ZWx5ICh0aGUgc2V0dGluZyBpbiB0aGUgbW9kZW0gd2lsbCBub3QgY2hhbmdlIHVudGlsIHRoZSBtb2RlbQogICAgICogcmVjZWl2ZXMgYW5kIHJlc3BvbmRzCiAgICAgKiB0byB0aGUgcmVxdWVzdCwgYnV0IHR5cGljYWxseSB0aGlzIHNob3VsZCBvbmx5IHRha2UgYSBmZXcgc2Vjb25kcy4gVGhlIHVzZXIKICAgICAqIHZpc2libGUgc2V0dGluZwogICAgICogYXZhaWxhYmxlIGZyb20gU3Vic2NyaXB0aW9uSW5mby5hcmVVaWNjQXBwbGljYXRpb25zRW5hYmxlZCgpIHdpbGwgYmUgdXBkYXRlZAogICAgICogaW1tZWRpYXRlbHkuKQogICAgICoKICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgd2hpY2ggc3Vic2NyaXB0aW9uIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gZW5hYmxlZCAgICAgICAgd2hldGhlciB1aWNjIGFwcGxpY2F0aW9ucyBhcmUgZW5hYmxlZCBvciBkaXNhYmxlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRVaWNjQXBwbGljYXRpb25zRW5hYmxlZChpbnQgc3Vic2NyaXB0aW9uSWQsIGJvb2xlYW4gZW5hYmxlZCkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInNldFVpY2NBcHBsaWNhdGlvbnNFbmFibGVkIHN1YklkPSAiICsgc3Vic2NyaXB0aW9uSWQgKyAiIGVuYWJsZSAiICsgZW5hYmxlZCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IElTdWIuU3R1Yi5hc0ludGVyZmFjZSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnNldFVpY2NBcHBsaWNhdGlvbnNFbmFibGVkKGVuYWJsZWQsIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIGl0J3Mgc3VwcG9ydGVkIHRvIGRpc2FibGUgLyByZS1lbmFibGUgYSBzdWJzY3JpcHRpb24gb24gYSBwaHlzaWNhbAogICAgICogKG5vbi1ldWljYykgU0lNLgogICAgICoKICAgICAqIFBoeXNpY2FsIFNJTSByZWZlcnMgbm9uLWV1aWNjLCBvciBha2Egbm9uLXByb2dyYW1tYWJsZSBTSU0uCiAgICAgKgogICAgICogSXQgcHJvdmlkZXMgd2hldGhlciBhIHBoeXNpY2FsIFNJTSBjYXJkIGNhbiBiZSBkaXNhYmxlZCB3aXRob3V0IHRha2luZyBpdAogICAgICogb3V0LCB3aGljaCBpcyBkb25lCiAgICAgKiB2aWEge0BsaW5rICNzZXRTdWJzY3JpcHRpb25FbmFibGVkKGludCwgYm9vbGVhbil9IEFQSS4KICAgICAqCiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOiBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUuCiAgICAgKgogICAgICogQHJldHVybiB3aGV0aGVyIGNhbiBkaXNhYmxlIHN1YnNjcmlwdGlvbnMgb24gcGh5c2ljYWwgU0lNcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBjYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24oKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiY2FuRGlzYWJsZVBoeXNpY2FsU3Vic2NyaXB0aW9uIik7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IElTdWIuU3R1Yi5hc0ludGVyZmFjZSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5jYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIERPIE5PVCBVU0UuCiAgICAgKiBUaGlzIEFQSSBpcyBkZXNpZ25lZCBmb3IgZmVhdHVyZXMgdGhhdCBhcmUgbm90IGZpbmlzaGVkIGF0IHRoaXMgcG9pbnQuIERvIG5vdAogICAgICogY2FsbCB0aGlzIEFQSS4KICAgICAqIAogICAgICogQGhpZGUKICAgICAqICAgICAgIFRPRE8gYi8xMzU1NDc1MTI6IGZ1cnRoZXIgY2xlYW4gdXAKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzU3Vic2NyaXB0aW9uRW5hYmxlZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuaXNTdWJzY3JpcHRpb25FbmFibGVkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZyB1c2VyIHByZWZlcmVuY2UgZm9yIGEgc3Vic2NyaXB0aW9uCiAgICAgKiBJRC4gVGhlIHNldHRpbmcKICAgICAqIGFwcCB1c2VzIHRoaXMgbWV0aG9kIHRvIGluZGljYXRlIHdpdGggd2hvbSB0aGV5IHdpc2ggdG8gc2hhcmUgZGV2aWNlIHRvCiAgICAgKiBkZXZpY2Ugc3RhdHVzCiAgICAgKiBpbmZvcm1hdGlvbi4KICAgICAqIAogICAgICogQHBhcmFtIHNoYXJpbmcgICAgICAgIHRoZSBzdGF0dXMgc2hhcmluZyBwcmVmZXJlbmNlCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UoaW50IHN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICBARGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSBpbnQgc2hhcmluZykgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmddICsgc2hhcmluZzogIiArIHNoYXJpbmcgKyAiIHN1YklkOiAiCiAgICAgICAgICAgICAgICAgICAgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YnNjcmlwdGlvbklkLCAic2V0RGV2aWNlVG9EZXZpY2VTaGFyaW5nU3RhdHVzIiwKICAgICAgICAgICAgICAgIChpU3ViKSAtPiBpU3ViLnNldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZyhzaGFyaW5nLCBzdWJzY3JpcHRpb25JZCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdXNlci1jaG9zZW4gZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZyBwcmVmZXJlbmNlCiAgICAgKiAKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gaWQgb2Ygc3Vic2NyaXB0aW9uCiAgICAgKiBAcmV0dXJuIFRoZSBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nIHByZWZlcmVuY2UKICAgICAqLwogICAgcHVibGljIEBEZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdQcmVmZXJlbmNlIGludCBnZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdQcmVmZXJlbmNlKAogICAgICAgICAgICBpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbZ2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nXSArIHN1YklkOiAiICsgc3Vic2NyaXB0aW9uSWQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0SW50ZWdlclN1YnNjcmlwdGlvblByb3BlcnR5KHN1YnNjcmlwdGlvbklkLCBEMkRfU1RBVFVTX1NIQVJJTkcsCiAgICAgICAgICAgICAgICBEMkRfU0hBUklOR19ESVNBQkxFRCwgbUNvbnRleHQpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZyBmb3IgYQogICAgICogc3Vic2NyaXB0aW9uIElELgogICAgICogVGhlIHNldHRpbmcgYXBwIHVzZXMgdGhpcyBtZXRob2QgdG8gaW5kaWNhdGUgd2l0aCB3aG9tIHRoZXkgd2lzaCB0byBzaGFyZQogICAgICogZGV2aWNlIHRvIGRldmljZQogICAgICogc3RhdHVzIGluZm9ybWF0aW9uLgogICAgICogCiAgICAgKiBAcGFyYW0gY29udGFjdHMgICAgICAgVGhlIGxpc3Qgb2YgY29udGFjdHMgdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHNoYXJpbmcKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBUaGUgdW5pcXVlIFN1YnNjcmlwdGlvbiBJRCBpbiBkYXRhYmFzZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nQ29udGFjdHMoaW50IHN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICBATm9uTnVsbCBMaXN0PFVyaT4gY29udGFjdHMpIHsKICAgICAgICBTdHJpbmcgY29udGFjdFN0cmluZyA9IHNlcmlhbGl6ZVVyaUxpc3RzKGNvbnRhY3RzKTsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbc2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nQ29udGFjdHNdICsgY29udGFjdHM6ICIgKyBjb250YWN0U3RyaW5nCiAgICAgICAgICAgICAgICAgICAgKyAiIHN1YklkOiAiICsgc3Vic2NyaXB0aW9uSWQpOwogICAgICAgIH0KICAgICAgICBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJzY3JpcHRpb25JZCwgInNldERldmljZVRvRGV2aWNlU2hhcmluZ1N0YXR1cyIsCiAgICAgICAgICAgICAgICAoaVN1YikgLT4gaVN1Yi5zZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0cyhzZXJpYWxpemVVcmlMaXN0cyhjb250YWN0cyksCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZy4KICAgICAqIAogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFN1YnNjcmlwdGlvbiBpZCBvZiBzdWJzY3JpcHRpb24KICAgICAqIEByZXR1cm4gVGhlIGxpc3Qgb2YgY29udGFjdHMgdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nCiAgICAgKi8KICAgIHB1YmxpYyBATm9uTnVsbCBMaXN0PFVyaT4gZ2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nQ29udGFjdHMoCiAgICAgICAgICAgIGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0c10gKyBzdWJJZDogIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldENvbnRhY3RzRnJvbVN1YnNjcmlwdGlvblByb3BlcnR5KHN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICAgICAgRDJEX1NUQVRVU19TSEFSSU5HX1NFTEVDVEVEX0NPTlRBQ1RTLCBtQ29udGV4dCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBETyBOT1QgVVNFLgogICAgICogVGhpcyBBUEkgaXMgZGVzaWduZWQgZm9yIGZlYXR1cmVzIHRoYXQgYXJlIG5vdCBmaW5pc2hlZCBhdCB0aGlzIHBvaW50LiBEbyBub3QKICAgICAqIGNhbGwgdGhpcyBBUEkuCiAgICAgKiAKICAgICAqIEBoaWRlCiAgICAgKiAgICAgICBUT0RPIGIvMTM1NTQ3NTEyOiBmdXJ0aGVyIGNsZWFuIHVwCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IGdldEVuYWJsZWRTdWJzY3JpcHRpb25JZChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaW50IHN1YklkID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdWJJZCA9IGlTdWIuZ2V0RW5hYmxlZFN1YnNjcmlwdGlvbklkKHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgiZ2V0RW5hYmxlZFN1YnNjcmlwdGlvbklkLCBzdWJJZCA9ICIgKyBzdWJJZCk7CiAgICAgICAgcmV0dXJuIHN1YklkOwogICAgfQoKICAgIHByaXZhdGUgaW50ZXJmYWNlIENhbGxJU3ViTWV0aG9kSGVscGVyIHsKICAgICAgICBpbnQgY2FsbE1ldGhvZChJU3ViIGlTdWIpIHRocm93cyBSZW1vdGVFeGNlcHRpb247CiAgICB9CgogICAgcHJpdmF0ZSBpbnQgc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoaW50IHN1YklkLCBTdHJpbmcgbWV0aG9kTmFtZSwKICAgICAgICAgICAgQ2FsbElTdWJNZXRob2RIZWxwZXIgaGVscGVyKSB7CiAgICAgICAgaWYgKCFpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoc3ViSWQpKSB7CiAgICAgICAgICAgIGxvZ2QoIlsiICsgbWV0aG9kTmFtZSArICJdIiArICItIGZhaWwiKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KCiAgICAgICAgaW50IHJlc3VsdCA9IDA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBoZWxwZXIuY2FsbE1ldGhvZChpU3ViKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYWN0aXZlIGRhdGEgc3Vic2NyaXB0aW9uIGlkLiBBY3RpdmUgZGF0YSBzdWJzY3JpcHRpb24gcmVmZXJzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uCiAgICAgKiBjdXJyZW50bHkgY2hvc2VuIHRvIHByb3ZpZGUgY2VsbHVsYXIgaW50ZXJuZXQgY29ubmVjdGlvbiB0byB0aGUgdXNlci4gVGhpcwogICAgICogbWF5IGJlCiAgICAgKiBkaWZmZXJlbnQgZnJvbSBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkuIEVnLiBPcHBvcnR1bmlzdGljcyBkYXRhCiAgICAgKgogICAgICogU2VlIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjb25BY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWRDaGFuZ2VkKGludCl9IGZvciB0aGUKICAgICAqIGRldGFpbHMuCiAgICAgKgogICAgICogQHJldHVybiBBY3RpdmUgZGF0YSBzdWJzY3JpcHRpb24gaWQgaWYgYW55IGlzIGNob3Nlbiwgb3IKICAgICAqICAgICAgICAgU3Vic2NyaXB0aW9uTWFuYWdlci5JTlZBTElEX1NVQlNDUklQVElPTl9JRCBpZiBub3QuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldEFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0FjdGl2ZURhdGFTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCB0aGF0IHB1dHMgYSBzdWJzY3JpcHRpb24gaWQgb24gYW4gaW50ZW50IHdpdGggdGhlIGNvbnN0YW50czoKICAgICAqIFBob25lQ29uc3RhbnQuU1VCU0NSSVBUSU9OX0tFWSBhbmQKICAgICAqIFN1YnNjcmlwdGlvbk1hbmFnZXIuRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYLgogICAgICogQm90aCBjb25zdGFudHMgYXJlIHVzZWQgdG8gc3VwcG9ydCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4gT25jZSB3ZSBrbm93IHdlCiAgICAgKiBnb3QgYWxsIHBsYWNlcywKICAgICAqIHdlIGNhbiByZW1vdmUgUGhvbmVDb25zdGFudHMuU1VCU0NSSVBUSU9OX0tFWS4KICAgICAqIAogICAgICogQHBhcmFtIGludGVudCBJbnRlbnQgdG8gcHV0IHN1YiBpZCBvbi4KICAgICAqIEBwYXJhbSBzdWJJZCAgU3Vic2NyaXB0aW9uSWQgdG8gcHV0IG9uIGludGVudC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgcHV0U3Vic2NyaXB0aW9uSWRFeHRyYShJbnRlbnQgaW50ZW50LCBpbnQgc3ViSWQpIHsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoU3Vic2NyaXB0aW9uTWFuYWdlci5FWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVgsIHN1YklkKTsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoUGhvbmVDb25zdGFudHMuU1VCU0NSSVBUSU9OX0tFWSwgc3ViSWQpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVEZWZhdWx0U3ViSWRDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfREVGQVVMVF9TVUJfSURfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVEZWZhdWx0RGF0YVN1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0RFRkFVTFRfREFUQV9TVUJfSURfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVEZWZhdWx0U21zU3ViSWRDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfREVGQVVMVF9TTVNfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlQWN0aXZlRGF0YVN1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0FDVElWRV9EQVRBX1NVQl9JRF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZVNsb3RJbmRleENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9TTE9UX0lOREVYX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFsbG93cyBhIHRlc3QgcHJvY2VzcyB0byBkaXNhYmxlIGNsaWVudC1zaWRlIGNhY2hpbmcgb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgZGlzYWJsZUNhY2hpbmcoKSB7CiAgICAgICAgc0RlZmF1bHRTdWJJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNEZWZhdWx0RGF0YVN1YklkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc0FjdGl2ZURhdGFTdWJJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNEZWZhdWx0U21zU3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzU2xvdEluZGV4Q2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc1Bob25lSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENsZWFycyBhbGwgcHJvY2Vzcy1sb2NhbCBiaW5kZXIgY2FjaGVzLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBjbGVhckNhY2hlcygpIHsKICAgICAgICBzRGVmYXVsdFN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzRGVmYXVsdERhdGFTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc0FjdGl2ZURhdGFTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc0RlZmF1bHRTbXNTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc1Nsb3RJbmRleENhY2hlLmNsZWFyKCk7CiAgICAgICAgc1Bob25lSWRDYWNoZS5jbGVhcigpOwogICAgfQoKICAgIC8qKgogICAgICogQ2FsbGVkIHRvIHJldHJpZXZlIFNJTS1zcGVjaWZpYyBzZXR0aW5ncyBkYXRhIHRvIGJlIGJhY2tlZCB1cC4KICAgICAqCiAgICAgKiBAcmV0dXJuIGRhdGEgaW4gYnl0ZVtdIHRvIGJlIGJhY2tlZCB1cC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBieXRlW10gZ2V0QWxsU2ltU3BlY2lmaWNTZXR0aW5nc0ZvckJhY2t1cCgpIHsKICAgICAgICBCdW5kbGUgYnVuZGxlID0gbUNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCkuY2FsbCgKICAgICAgICAgICAgICAgIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSwKICAgICAgICAgICAgICAgIEdFVF9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUUsIG51bGwsIG51bGwpOwogICAgICAgIHJldHVybiBidW5kbGUuZ2V0Qnl0ZUFycmF5KFN1YnNjcmlwdGlvbk1hbmFnZXIuS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBKTsKICAgIH0KCiAgICAvKioKICAgICAqIENhbGxlZCB0byBhdHRlbXB0IHRvIHJlc3RvcmUgdGhlIGJhY2tlZCB1cCBzaW0tc3BlY2lmaWMgY29uZmlncyB0byBkZXZpY2UgZm9yCiAgICAgKiBzcGVjaWZpYyBzaW0uCiAgICAgKiBUaGlzIHdpbGwgdHJ5IHRvIHJlc3RvcmUgdGhlIGRhdGEgdGhhdCB3YXMgc3RvcmVkIGludGVybmFsbHkgd2hlbiB7QGxpbmsKICAgICAqICNyZXN0b3JlQWxsU2ltU3BlY2lmaWNTZXR0aW5nc0Zyb21CYWNrdXAoYnl0ZVtdIGRhdGEpfSB3YXMgY2FsbGVkIGR1cmluZwogICAgICogc2V0dXAgd2l6YXJkLgogICAgICogRW5kIHJlc3VsdCBpcyBTaW1JbmZvREIgaXMgbW9kaWZpZWQgdG8gbWF0Y2ggYW55IGJhY2tlZCB1cCBjb25maWdzIGZvciB0aGUKICAgICAqIHJlcXVlc3RlZAogICAgICogaW5zZXJ0ZWQgc2ltLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayBVcml9IHtAbGluayAjU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJfSBpcyBub3RpZmllZAogICAgICogaWYgYW55IFNpbUluZm9EQgogICAgICogZW50cnkgaXMgdXBkYXRlZCBhcyB0aGUgcmVzdWx0IG9mIHRoaXMgbWV0aG9kIGNhbGwuCiAgICAgKgogICAgICogQHBhcmFtIGljY0lkIG9mIHRoZSBzaW0gdGhhdCBhIHJlc3RvcmUgaXMgcmVxdWVzdGVkIGZvci4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgcmVzdG9yZVNpbVNwZWNpZmljU2V0dGluZ3NGb3JJY2NJZEZyb21CYWNrdXAoQE5vbk51bGwgU3RyaW5nIGljY0lkKSB7CiAgICAgICAgbUNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCkuY2FsbCgKICAgICAgICAgICAgICAgIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSwKICAgICAgICAgICAgICAgIFJFU1RPUkVfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FLAogICAgICAgICAgICAgICAgaWNjSWQsIG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogQ2FsbGVkIGR1cmluZyBzZXR1cCB3aXphcmQgcmVzdG9yZSBmbG93IHRvIGF0dGVtcHQgdG8gcmVzdG9yZSB0aGUgYmFja2VkIHVwCiAgICAgKiBzaW0tc3BlY2lmaWMKICAgICAqIGNvbmZpZ3MgdG8gZGV2aWNlIGZvciBhbGwgZXhpc3RpbmcgU0lNcyBpbiBTaW1JbmZvREIuIEludGVybmFsbHksIGl0IHdpbGwKICAgICAqIHN0b3JlIHRoZSBiYWNrdXAKICAgICAqIGRhdGEgaW4gYW4gaW50ZXJuYWwgZmlsZS4gVGhpcyBmaWxlIHdpbGwgcGVyc2lzdCBvbiBkZXZpY2UgZm9yIGRldmljZSdzCiAgICAgKiBsaWZldGltZSBhbmQgd2lsbCBiZQogICAgICogdXNlZCBsYXRlciBvbiB3aGVuIGEgU0lNIGlzIGluc2VydGVkIHRvIHJlc3RvcmUgdGhhdCBzcGVjaWZpYyBTSU0ncyBzZXR0aW5ncwogICAgICogYnkgY2FsbGluZwogICAgICoge0BsaW5rICNyZXN0b3JlU2ltU3BlY2lmaWNTZXR0aW5nc0ZvckljY0lkRnJvbUJhY2t1cChTdHJpbmcgaWNjSWQpfS4gRW5kCiAgICAgKiByZXN1bHQgaXMKICAgICAqIFNpbUluZm9EQiBpcyBtb2RpZmllZCB0byBtYXRjaCBhbnkgYmFja2VkIHVwIGNvbmZpZ3MgZm9yIHRoZSBhcHByb3ByaWF0ZQogICAgICogaW5zZXJ0ZWQgU0lNcy4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSB7QGxpbmsgVXJpfSB7QGxpbmsgI1NJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSX0gaXMgbm90aWZpZWQKICAgICAqIGlmIGFueSBTaW1JbmZvREIKICAgICAqIGVudHJ5IGlzIHVwZGF0ZWQgYXMgdGhlIHJlc3VsdCBvZiB0aGlzIG1ldGhvZCBjYWxsLgogICAgICoKICAgICAqIEBwYXJhbSBkYXRhIHdpdGggdGhlIHNpbSBzcGVjaWZpYyBjb25maWdzIHRvIGJlIGJhY2tlZCB1cC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgcmVzdG9yZUFsbFNpbVNwZWNpZmljU2V0dGluZ3NGcm9tQmFja3VwKEBOb25OdWxsIGJ5dGVbXSBkYXRhKSB7CiAgICAgICAgQnVuZGxlIGJ1bmRsZSA9IG5ldyBCdW5kbGUoKTsKICAgICAgICBidW5kbGUucHV0Qnl0ZUFycmF5KEtFWV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfREFUQSwgZGF0YSk7CiAgICAgICAgbUNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCkuY2FsbCgKICAgICAgICAgICAgICAgIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSwKICAgICAgICAgICAgICAgIFJFU1RPUkVfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FLAogICAgICAgICAgICAgICAgbnVsbCwgYnVuZGxlKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBzZXRQaG9uZU51bWJlcihATm9uTnVsbCBTdHJpbmcgdmFsdWUpIHsKICAgICAgICBQaG9uZUNvbnN0YW50cy5zZXRNU0lTRE4odmFsdWUpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcGhvbmUgbnVtYmVyIGZvciB0aGUgZ2l2ZW4ge0Bjb2RlIHN1YnNjcmlwdGlvbklkfSBhbmQKICAgICAqIHtAY29kZSBzb3VyY2V9LAogICAgICogb3IgYW4gZW1wdHkgc3RyaW5nIGlmIG5vdCBhdmFpbGFibGUuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBHZW5lcmFsIGFwcHMgdGhhdCBuZWVkIHRvIGtub3cgdGhlIHBob25lIG51bWJlciBzaG91bGQgdXNlCiAgICAgKiB7QGxpbmsgI2dldFBob25lTnVtYmVyKGludCl9CiAgICAgKiBpbnN0ZWFkLiBUaGlzIEFQSSBtYXkgYmUgc3VpdGFibGUgc3BlY2lmaWMgYXBwcyB0aGF0IG5lZWRzIHRvIGtub3cgdGhlIHBob25lCiAgICAgKiBudW1iZXIgZnJvbQogICAgICogYSBzcGVjaWZpYyBzb3VyY2UuIEZvciBleGFtcGxlLCBhIGNhcnJpZXIgYXBwIG5lZWRzIHRvIGtub3cgZXhhY3RseSB3aGF0J3Mgb24KICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9IGFuZCBkZWNpZGUgaWYgdGhlIHByZXZpb3VzbHkgc2V0IHBob25lCiAgICAgKiBudW1iZXIKICAgICAqIG9mIHNvdXJjZSB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiBjYXJyaWVyfSBzaG91bGQgYmUgdXBkYXRlZC4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0CiAgICAgKiBjYW4gdmFyeQogICAgICogZGVwZW5kaW5nIG9uIHRoZSB7QGNvZGUgc291cmNlfSBhbmQgdGhlIG5ldHdvcmsgZXRjLiBQcm9ncmFtbWF0aWMgcGFyc2luZwogICAgICogc2hvdWxkIGJlIGRvbmUKICAgICAqIGNhdXRpb3VzbHksIGZvciBleGFtcGxlLCBhZnRlciBmb3JtYXR0aW5nIHRoZSBudW1iZXIgdG8gYSBjb25zaXN0ZW50IGZvcm1hdAogICAgICogd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+CiAgICAgKiBOb3RlIHRoZSBhc3N1bXB0aW9uIGlzIHRoYXQgb25lIHN1YnNjcmlwdGlvbiAod2hpY2ggdXN1YWxseSBtZWFucyBvbmUgU0lNKQogICAgICogaGFzCiAgICAgKiBvbmx5IG9uZSBwaG9uZSBudW1iZXIuIFRoZSBtdWx0aXBsZSBzb3VyY2VzIGJhY2t1cCBlYWNoIG90aGVyIHNvIGhvcGVmdWxseSBhdAogICAgICogbGVhc3Qgb25lCiAgICAgKiBpcyBhdmFpbGF2bGUuIEZvciBleGFtcGxlLCBmb3IgYSBjYXJyaWVyIHRoYXQgZG9lc24ndCB0eXBpY2FsbHkgc2V0IHBob25lCiAgICAgKiBudW1iZXJzCiAgICAgKiBvbiB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfVUlDQyBVSUNDfSwgdGhlIHNvdXJjZQogICAgICoge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0lNUyBJTVN9CiAgICAgKiBtYXkgcHJvdmlkZSBvbmUuIE9yLCBhIGNhcnJpZXIgbWF5IGRlY2lkZSB0byBwcm92aWRlIHRoZSBwaG9uZSBudW1iZXIgdmlhCiAgICAgKiBzb3VyY2UKICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSIGNhcnJpZXJ9IGlmIG5laXRoZXIgc291cmNlIFVJQ0Mgbm9yIElNUwogICAgICogaXMgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIGF2YWlsYWJpbGl0eSBhbmQgY29ycmVjdG5lc3Mgb2YgdGhlIHBob25lIG51bWJlciBkZXBlbmRzIG9uIHRoZQogICAgICogdW5kZXJseWluZyBzb3VyY2UKICAgICAqIGFuZCB0aGUgbmV0d29yayBldGMuIEFkZGl0aW9uYWwgdmVyaWZpY2F0aW9uIGlzIG5lZWRlZCB0byB1c2UgdGhpcyBudW1iZXIgZm9yCiAgICAgKiBzZWN1cml0eS1yZWxhdGVkIG9yIG90aGVyIHNlbnNpdGl2ZSBzY2VuYXJpb3MuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb24gSUQsIG9yCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rICNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGRlZmF1bHQgb25lLgogICAgICogQHBhcmFtIHNvdXJjZSAgICAgICAgIHRoZSBzb3VyY2Ugb2YgdGhlIHBob25lIG51bWJlciwgb25lIG9mIHRoZQogICAgICogICAgICAgICAgICAgICAgICAgICAgIFBIT05FX05VTUJFUl9TT1VSQ0VfKiBjb25zdGFudHMuCiAgICAgKiBAcmV0dXJuIHRoZSBwaG9uZSBudW1iZXIsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3QgYXZhaWxhYmxlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYge0Bjb2RlIHNvdXJjZX0gaXMgaW52YWxpZC4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uICAgIGlmIHRoZSB0ZWxlcGhvbnkgcHJvY2VzcyBpcyBub3QgY3VycmVudGx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uICAgICAgICBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgaGF2ZSBwZXJtaXNzaW9ucwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQuCiAgICAgKiBAc2VlICNQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MKICAgICAqIEBzZWUgI1BIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUgogICAgICogQHNlZSAjUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVMKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgImNhcnJpZXIgcHJpdmlsZWdlcyIsCiAgICB9KQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBTdHJpbmcgZ2V0UGhvbmVOdW1iZXIoaW50IHN1YnNjcmlwdGlvbklkLCBAUGhvbmVOdW1iZXJTb3VyY2UgaW50IHNvdXJjZSkgewogICAgICAgIGlmIChzdWJzY3JpcHRpb25JZCA9PSBERUZBVUxUX1NVQlNDUklQVElPTl9JRCkgewogICAgICAgICAgICBzdWJzY3JpcHRpb25JZCA9IGdldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlICE9IFBIT05FX05VTUJFUl9TT1VSQ0VfVUlDQwogICAgICAgICAgICAgICAgJiYgc291cmNlICE9IFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUgogICAgICAgICAgICAgICAgJiYgc291cmNlICE9IFBIT05FX05VTUJFUl9TT1VSQ0VfSU1TKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oImludmFsaWQgc291cmNlICIgKyBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgLy8gaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAvLyByZXR1cm4gaVN1Yi5nZXRQaG9uZU51bWJlcihzdWJzY3JpcHRpb25JZCwgc291cmNlLAogICAgICAgICAgICAvLyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICBpZiAoUGhvbmVDb25zdGFudHMuZ2V0TVNJU0ROKCkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBob25lQ29uc3RhbnRzLmdldE1TSVNETigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigic3Vic2NyaXB0aW9uIHNlcnZpY2UgdW5hdmFpbGFibGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgdGhyb3cgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHBob25lIG51bWJlciBmb3IgdGhlIGdpdmVuIHtAY29kZSBzdWJJZH0sIG9yIGFuIGVtcHR5IHN0cmluZyBpZgogICAgICogbm90IGF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoaXMgQVBJIGlzIHN1aXRhYmxlIGZvciBnZW5lcmFsIGFwcHMgdGhhdCBuZWVkcyB0byBrbm93IHRoZSBwaG9uZSBudW1iZXIuCiAgICAgKiBGb3Igc3BlY2lmaWMgYXBwcyB0aGF0IG5lZWRzIHRvIGtub3cgdGhlIHBob25lIG51bWJlciBwcm92aWRlZCBieSBhIHNwZWNpZmljCiAgICAgKiBzb3VyY2UsCiAgICAgKiB7QGxpbmsgI2dldFBob25lTnVtYmVyKGludCwgaW50KX0gbWF5IGJlIHN1aXRhYmxlLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhpcyBBUEkgaXMgYnVpbHQgdXAgb24ge0BsaW5rICNnZXRQaG9uZU51bWJlcihpbnQsIGludCl9LCBidXQgcGlja3MKICAgICAqIGZyb20gYXZhaWxhYmxlIHNvdXJjZXMgaW4gdGhlIGZvbGxvd2luZyBvcmRlcjoKICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSfQogICAgICogPiB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfVUlDQ30gPiB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfSU1TfS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0CiAgICAgKiBjYW4gdmFyeQogICAgICogZGVwZW5kaW5nIG9uIHRoZSB1bmRlcmx5aW5nIHNvdXJjZSBhbmQgdGhlIG5ldHdvcmsgZXRjLiBQcm9ncmFtbWF0aWMgcGFyc2luZwogICAgICogc2hvdWxkIGJlIGRvbmUKICAgICAqIGNhdXRpb3VzbHksIGZvciBleGFtcGxlLCBhZnRlciBmb3JtYXR0aW5nIHRoZSBudW1iZXIgdG8gYSBjb25zaXN0ZW50IGZvcm1hdAogICAgICogd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+CiAgICAgKiBUaGUgYXZhaWxhYmlsaXR5IGFuZCBjb3JyZWN0bmVzcyBvZiB0aGUgcGhvbmUgbnVtYmVyIGRlcGVuZHMgb24gdGhlCiAgICAgKiB1bmRlcmx5aW5nIHNvdXJjZQogICAgICogYW5kIHRoZSBuZXR3b3JrIGV0Yy4gQWRkaXRpb25hbCB2ZXJpZmljYXRpb24gaXMgbmVlZGVkIHRvIHVzZSB0aGlzIG51bWJlciBmb3IKICAgICAqIHNlY3VyaXR5LXJlbGF0ZWQgb3Igb3RoZXIgc2Vuc2l0aXZlIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3IKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfQogICAgICogICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZGVmYXVsdCBvbmUuCiAgICAgKiBAcmV0dXJuIHRoZSBwaG9uZSBudW1iZXIsIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3QgYXZhaWxhYmxlLgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgdGhlIHRlbGVwaG9ueSBwcm9jZXNzIGlzIG5vdCBjdXJyZW50bHkKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gICAgIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBoYXZlIHBlcm1pc3Npb25zCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlZC4KICAgICAqIEBzZWUgI2dldFBob25lTnVtYmVyKGludCwgaW50KQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFueU9mID0gewogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9OVU1CRVJTLAogICAgICAgICAgICBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFLAogICAgICAgICAgICAiY2FycmllciBwcml2aWxlZ2VzIiwKICAgIH0pCiAgICBATm9uTnVsbAogICAgcHVibGljIFN0cmluZyBnZXRQaG9uZU51bWJlcihpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoc3Vic2NyaXB0aW9uSWQgPT0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQpIHsKICAgICAgICAgICAgc3Vic2NyaXB0aW9uSWQgPSBnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIC8vIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgLy8gcmV0dXJuIGlTdWIuZ2V0UGhvbmVOdW1iZXJGcm9tRmlyc3RBdmFpbGFibGVTb3VyY2Uoc3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgIC8vIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIGlmIChQaG9uZUNvbnN0YW50cy5nZXRNU0lTRE4oKSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUGhvbmVDb25zdGFudHMuZ2V0TVNJU0ROKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJzdWJzY3JpcHRpb24gc2VydmljZSB1bmF2YWlsYWJsZS4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICB0aHJvdyBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGhvbmUgbnVtYmVyIGZvciB0aGUgZ2l2ZW4ge0Bjb2RlIHN1YklkfSBmb3Igc291cmNlCiAgICAgKiB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiBjYXJyaWVyfS4KICAgICAqIFNldHMgYW4gZW1wdHkgc3RyaW5nIHRvIHJlbW92ZSB0aGUgcHJldmlvdXNseSBzZXQgcGhvbmUgbnVtYmVyLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIEFQSSBpcyBzdWl0YWJsZSBmb3IgY2FycmllciBhcHBzIHRvIHByb3ZpZGUgYSBwaG9uZSBudW1iZXIsIGZvciBleGFtcGxlCiAgICAgKiB3aGVuCiAgICAgKiBpdCdzIG5vdCBwb3NzaWJsZSB0byB1cGRhdGUge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgVUlDQ30gZGlyZWN0bHkuCiAgICAgKgogICAgICogPHA+CiAgICAgKiBJdCdzIHJlY29tbWVuZGVkIHRoYXQgdGhlIHBob25lIG51bWJlciBpcyBmb3JtYXR0ZWQgdG8gd2VsbC1rbm93biBmb3JtYXRzLAogICAgICogZm9yIGV4YW1wbGUsIGJ5IHtAbGluayBQaG9uZU51bWJlclV0aWxzfSB7QGNvZGUgZm9ybWF0TnVtYmVyKn0gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3IKICAgICAqICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfQogICAgICogICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZGVmYXVsdCBvbmUuCiAgICAgKiBAcGFyYW0gbnVtYmVyICAgICAgICAgdGhlIHBob25lIG51bWJlciwgb3IgYW4gZW1wdHkgc3RyaW5nIHRvIHJlbW92ZSB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c2x5IHNldCBudW1iZXIuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgdGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlLgogICAgICogQHRocm93cyBOdWxsUG9pbnRlckV4Y2VwdGlvbiAgaWYge0Bjb2RlIG51bWJlcn0gaXMge0Bjb2RlIG51bGx9LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiAgICAgaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbnMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKCJjYXJyaWVyIHByaXZpbGVnZXMiKQogICAgcHVibGljIHZvaWQgc2V0Q2FycmllclBob25lTnVtYmVyKGludCBzdWJzY3JpcHRpb25JZCwgQE5vbk51bGwgU3RyaW5nIG51bWJlcikgewogICAgICAgIGlmIChzdWJzY3JpcHRpb25JZCA9PSBERUZBVUxUX1NVQlNDUklQVElPTl9JRCkgewogICAgICAgICAgICBzdWJzY3JpcHRpb25JZCA9IGdldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpOwogICAgICAgIH0KICAgICAgICBpZiAobnVtYmVyID09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCJpbnZhbGlkIG51bWJlciBudWxsIik7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnNldFBob25lTnVtYmVyKHN1YnNjcmlwdGlvbklkLCBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIsIG51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInN1YnNjcmlwdGlvbiBzZXJ2aWNlIHVuYXZhaWxhYmxlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHRocm93IGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIHByZWZlcnJlZCB1c2FnZSBzZXR0aW5nLgogICAgICoKICAgICAqIFRoZSBjZWxsdWxhciB1c2FnZSBzZXR0aW5nIGlzIGEgc3dpdGNoIHdoaWNoIGNvbnRyb2xzIHRoZSBtb2RlIG9mIG9wZXJhdGlvbgogICAgICogZm9yIHRoZSBjZWxsdWxhcgogICAgICogcmFkaW8gdG8gZWl0aGVyIHJlcXVpcmUgb3Igbm90IHJlcXVpcmUgdm9pY2Ugc2VydmljZS4gSXQgaXMgbm90IG1hbmFnZWQgdmlhCiAgICAgKiBBbmRyb2lk4oCZcwogICAgICogU2V0dGluZ3MuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJJZCBvZiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIHVzYWdlU2V0dGluZyAgIHRoZSByZXF1ZXN0ZWQgdXNhZ2Ugc2V0dGluZy4KICAgICAqCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiBhIHNwZWNpZmljIG1vZGUgb3Igc2V0dGluZyB0aGUgbW9kZSBpcyBub3QKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZCBvbiBhCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWN1bGFyIGRldmljZS4KICAgICAqCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8cD4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlcXVpcmVzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBDYXJyaWVyUHJpdmlsZWdlcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTm90ZTogVGhpcyBtZXRob2Qgd2lsbCBub3QgYWxsb3cgdGhlIHNldHRpbmcgb2YKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVTQUdFX1NFVFRJTkdfVU5LTk9XTi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgdm9pZCBzZXRVc2FnZVNldHRpbmcoaW50IHN1YnNjcmlwdGlvbklkLCBAVXNhZ2VTZXR0aW5nIGludCB1c2FnZVNldHRpbmcpIHsKICAgICAgICBpZiAoVkRCRykKICAgICAgICAgICAgbG9nZCgiW3NldFVzYWdlU2V0dGluZ10rIHNldHRpbmc6IiArIHVzYWdlU2V0dGluZyArICIgc3ViSWQ6IiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJzY3JpcHRpb25JZCwgInNldFVzYWdlU2V0dGluZyIsCiAgICAgICAgICAgICAgICAoaVN1YikgLT4gaVN1Yi5zZXRVc2FnZVNldHRpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIHVzYWdlU2V0dGluZywgc3Vic2NyaXB0aW9uSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSkpOwogICAgfQp9Cg==</text>
      </register>
      <register name="1" type="2">
        <text encoding="base64">LyoKICogQ29weXJpZ2h0IChDKSAyMDE0IFRoZSBBbmRyb2lkIE9wZW4gU291cmNlIFByb2plY3QKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBhbmRyb2lkLnRlbGVwaG9ueTsKCmltcG9ydCBzdGF0aWMgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXIuU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRDsKaW1wb3J0IHN0YXRpYyBhbmRyb2lkLm5ldC5OZXR3b3JrUG9saWN5TWFuYWdlci5TVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEOwoKaW1wb3J0IGFuZHJvaWQuTWFuaWZlc3Q7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uQ2FsbGJhY2tFeGVjdXRvcjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5Db2xvckludDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5EdXJhdGlvbk1pbGxpc0xvbmc7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uSW50RGVmOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLk5vbk51bGw7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uTnVsbGFibGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uUmVxdWlyZXNGZWF0dXJlOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlJlcXVpcmVzUGVybWlzc2lvbjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TZGtDb25zdGFudC5TZGtDb25zdGFudFR5cGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uU3VwcHJlc3NBdXRvRG9jOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlN5c3RlbUFwaTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TeXN0ZW1TZXJ2aWNlOwppbXBvcnQgYW5kcm9pZC5hcHAuUGVuZGluZ0ludGVudDsKaW1wb3J0IGFuZHJvaWQuYXBwLlByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTsKaW1wb3J0IGFuZHJvaWQuY29tcGF0LmFubm90YXRpb24uVW5zdXBwb3J0ZWRBcHBVc2FnZTsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5Db250ZXh0OwppbXBvcnQgYW5kcm9pZC5jb250ZW50LkludGVudDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlSW5mbzsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5wbS5QYWNrYWdlTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuQ29uZmlndXJhdGlvbjsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5yZXMuUmVzb3VyY2VzOwppbXBvcnQgYW5kcm9pZC5kYXRhYmFzZS5Db250ZW50T2JzZXJ2ZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5OZXR3b3JrQ2FwYWJpbGl0aWVzOwppbXBvcnQgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLm5ldC5Vcmk7CmltcG9ydCBhbmRyb2lkLm9zLkJpbmRlcjsKaW1wb3J0IGFuZHJvaWQub3MuQnVpbGQ7CmltcG9ydCBhbmRyb2lkLm9zLkJ1bmRsZTsKaW1wb3J0IGFuZHJvaWQub3MuSGFuZGxlcjsKaW1wb3J0IGFuZHJvaWQub3MuTG9vcGVyOwppbXBvcnQgYW5kcm9pZC5vcy5QYXJjZWxVdWlkOwppbXBvcnQgYW5kcm9pZC5vcy5Qcm9jZXNzOwppbXBvcnQgYW5kcm9pZC5vcy5SZW1vdGVFeGNlcHRpb247CmltcG9ydCBhbmRyb2lkLnByb3ZpZGVyLlRlbGVwaG9ueS5TaW1JbmZvOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuZXVpY2MuRXVpY2NNYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC50ZWxlcGhvbnkuaW1zLkltc01tVGVsTWFuYWdlcjsKaW1wb3J0IGFuZHJvaWQudXRpbC5CYXNlNjQ7CmltcG9ydCBhbmRyb2lkLnV0aWwuTG9nOwppbXBvcnQgYW5kcm9pZC51dGlsLlBhaXI7CgppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LklTdWI7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkuUGhvbmVDb25zdGFudHM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC50ZWxlcGhvbnkudXRpbC5IYW5kbGVyRXhlY3V0b3I7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC51dGlsLkZ1bmN0aW9uYWxVdGlsczsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnV0aWwuUHJlY29uZGl0aW9uczsKaW1wb3J0IGNvbS5hbmRyb2lkLnRlbGVwaG9ueS5SbG9nOwoKaW1wb3J0IGphdmEuaW8uQnl0ZUFycmF5SW5wdXRTdHJlYW07CmltcG9ydCBqYXZhLmlvLkJ5dGVBcnJheU91dHB1dFN0cmVhbTsKaW1wb3J0IGphdmEuaW8uSU9FeGNlcHRpb247CmltcG9ydCBqYXZhLmlvLk9iamVjdElucHV0U3RyZWFtOwppbXBvcnQgamF2YS5pby5PYmplY3RPdXRwdXRTdHJlYW07CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb25Qb2xpY3k7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkFycmF5czsKaW1wb3J0IGphdmEudXRpbC5Db2xsZWN0aW9uczsKaW1wb3J0IGphdmEudXRpbC5IYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLkxpc3Q7CmltcG9ydCBqYXZhLnV0aWwuTG9jYWxlOwppbXBvcnQgamF2YS51dGlsLk1hcDsKaW1wb3J0IGphdmEudXRpbC5jb25jdXJyZW50LkNvbmN1cnJlbnRIYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLmNvbmN1cnJlbnQuRXhlY3V0b3I7CmltcG9ydCBqYXZhLnV0aWwuZnVuY3Rpb24uQ29uc3VtZXI7CmltcG9ydCBqYXZhLnV0aWwuc3RyZWFtLkNvbGxlY3RvcnM7CgovKioKICogU3Vic2NyaXB0aW9uTWFuYWdlciBpcyB0aGUgYXBwbGljYXRpb24gaW50ZXJmYWNlIHRvIFN1YnNjcmlwdGlvbkNvbnRyb2xsZXIKICogYW5kIHByb3ZpZGVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IFRlbGVwaG9ueSBTdWJzY3JpcHRpb25zLgogKi8KQFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU1VCU0NSSVBUSU9OX1NFUlZJQ0UpCkBSZXF1aXJlc0ZlYXR1cmUoUGFja2FnZU1hbmFnZXIuRkVBVFVSRV9URUxFUEhPTllfU1VCU0NSSVBUSU9OKQpwdWJsaWMgY2xhc3MgU3Vic2NyaXB0aW9uTWFuYWdlciB7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBTdHJpbmcgTE9HX1RBRyA9ICJTdWJzY3JpcHRpb25NYW5hZ2VyIjsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGJvb2xlYW4gREJHID0gZmFsc2U7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBib29sZWFuIFZEQkcgPSBmYWxzZTsKCiAgICAvKiogQW4gaW52YWxpZCBzdWJzY3JpcHRpb24gaWRlbnRpZmllciAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgPSAtMTsKCiAgICAvKiogQmFzZSB2YWx1ZSBmb3IgcGxhY2Vob2xkZXIgU1VCU0NSSVBUSU9OX0lEJ3MuICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBMQUNFSE9MREVSX1NVQlNDUklQVElPTl9JRF9CQVNFID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBBbiBpbnZhbGlkIHBob25lIGlkZW50aWZpZXIgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9QSE9ORV9JTkRFWCA9IC0xOwoKICAgIC8qKiBJbmRpY2F0ZXMgaW52YWxpZCBzaW0gc2xvdC4gVGhpcyBjYW4gYmUgcmV0dXJuZWQgYnkge0BsaW5rICNnZXRTbG90SW5kZXgoaW50KX0uICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTlZBTElEX1NJTV9TTE9UX0lOREVYID0gLTE7CgogICAgLyoqIEluZGljYXRlcyB0aGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gSUQgaW4gVGVsZXBob255LiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQgPSBJbnRlZ2VyLk1BWF9WQUxVRTsKCiAgICAvKioKICAgICAqIEluZGljYXRlcyB0aGUgY2FsbGVyIHdhbnRzIHRoZSBkZWZhdWx0IHBob25lIGlkLgogICAgICogVXNlZCBpbiBTdWJzY3JpcHRpb25Db250cm9sbGVyIGFuZCBQaG9uZSBidXQgZG8gd2UgcmVhbGx5IG5lZWQgaXQ/Pz8KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfUEhPTkVfSU5ERVggPSBJbnRlZ2VyLk1BWF9WQUxVRTsKCiAgICAvKiogSW5kaWNhdGVzIHRoZSBjYWxsZXIgd2FudHMgdGhlIGRlZmF1bHQgc2xvdCBpZC4gTk9UIHVzZWQgcmVtb3ZlPyAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUZBVUxUX1NJTV9TTE9UX0lOREVYID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqIE1pbmltdW0gcG9zc2libGUgc3ViaWQgdGhhdCByZXByZXNlbnRzIGEgc3Vic2NyaXB0aW9uICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1JTl9TVUJTQ1JJUFRJT05fSURfVkFMVUUgPSAwOwoKICAgIC8qKiBNYXhpbXVtIHBvc3NpYmxlIHN1YmlkIHRoYXQgcmVwcmVzZW50cyBhIHN1YnNjcmlwdGlvbiAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNQVhfU1VCU0NSSVBUSU9OX0lEX1ZBTFVFID0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQgLSAxOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIENPTlRFTlRfVVJJID0gU2ltSW5mby5DT05URU5UX1VSSTsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSA9CiAgICAgICAgICAgICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfREVGQVVMVF9EQVRBX1NVQl9JRF9QUk9QRVJUWSA9CiAgICAgICAgICAgICJjYWNoZV9rZXkudGVsZXBob255LmdldF9kZWZhdWx0X2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfZGVmYXVsdF9zbXNfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9BQ1RJVkVfREFUQV9TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfYWN0aXZlX2RhdGFfc3ViX2lkIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBQ0hFX0tFWV9TTE9UX0lOREVYX1BST1BFUlRZID0KICAgICAgICAgICAgImNhY2hlX2tleS50ZWxlcGhvbnkuZ2V0X3Nsb3RfaW5kZXgiOwoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgR0VUX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19NRVRIT0RfTkFNRSA9ICJnZXRTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFJFU1RPUkVfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FID0KICAgICAgICAgICAgInJlc3RvcmVTaW1TcGVjaWZpY1NldHRpbmdzIjsKCiAgICAvKioKICAgICAqIEtleSB0byB0aGUgYmFja3VwICYgcmVzdG9yZSBkYXRhIGJ5dGUgYXJyYXkgaW4gdGhlIEJ1bmRsZSB0aGF0IGlzIHJldHVybmVkIGJ5IHtAbGluawogICAgICogI2dldEFsbFNpbVNwZWNpZmljU2V0dGluZ3NGb3JCYWNrdXAoKX0gb3IgdG8gYmUgcGFzcyBpbiB0byB7QGxpbmsKICAgICAqICNyZXN0b3JlQWxsU2ltU3BlY2lmaWNTZXR0aW5ncygpfS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBLRVlfU0lNX1NQRUNJRklDX1NFVFRJTkdTX0RBVEEgPSAiS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBIjsKCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpbnQgTUFYX0NBQ0hFX1NJWkUgPSA0OwoKICAgIHByaXZhdGUgc3RhdGljIGNsYXNzIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8VD4KICAgICAgICAgICAgZXh0ZW5kcyBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8Vm9pZCwgVD4gewogICAgICAgIHByaXZhdGUgZmluYWwgRnVuY3Rpb25hbFV0aWxzLlRocm93aW5nRnVuY3Rpb248SVN1YiwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0Z1bmN0aW9uPElTdWIsIFQ+IHN1YnNjcmlwdGlvbkludGVyZmFjZU1ldGhvZCwKICAgICAgICAgICAgICAgIFN0cmluZyBjYWNoZUtleVByb3BlcnR5LAogICAgICAgICAgICAgICAgVCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgc3VwZXIoTUFYX0NBQ0hFX1NJWkUsIGNhY2hlS2V5UHJvcGVydHkpOwogICAgICAgICAgICBtSW50ZXJmYWNlTWV0aG9kID0gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kOwogICAgICAgICAgICBtQ2FjaGVLZXlQcm9wZXJ0eSA9IGNhY2hlS2V5UHJvcGVydHk7CiAgICAgICAgICAgIG1EZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQoKICAgICAgICBAT3ZlcnJpZGUKICAgICAgICBwdWJsaWMgVCByZWNvbXB1dGUoVm9pZCBhVm9pZCkgewogICAgICAgICAgICBUIHJlc3VsdCA9IG1EZWZhdWx0VmFsdWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbUludGVyZmFjZU1ldGhvZC5hcHBseU9yVGhyb3coaVN1Yik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBjbGFzcyBJbnRlZ2VyUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPFQ+CiAgICAgICAgICAgIGV4dGVuZHMgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXIsIFQ+IHsKICAgICAgICBwcml2YXRlIGZpbmFsIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kLAogICAgICAgICAgICAgICAgU3RyaW5nIGNhY2hlS2V5UHJvcGVydHksCiAgICAgICAgICAgICAgICBUIGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICBzdXBlcihNQVhfQ0FDSEVfU0laRSwgY2FjaGVLZXlQcm9wZXJ0eSk7CiAgICAgICAgICAgIG1JbnRlcmZhY2VNZXRob2QgPSBzdWJzY3JpcHRpb25JbnRlcmZhY2VNZXRob2Q7CiAgICAgICAgICAgIG1DYWNoZUtleVByb3BlcnR5ID0gY2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICAgICAgbURlZmF1bHRWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CgogICAgICAgIEBPdmVycmlkZQogICAgICAgIHB1YmxpYyBUIHJlY29tcHV0ZShJbnRlZ2VyIHF1ZXJ5KSB7CiAgICAgICAgICAgIFQgcmVzdWx0ID0gbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBtSW50ZXJmYWNlTWV0aG9kLmFwcGx5T3JUaHJvdyhpU3ViLCBxdWVyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzRGVmYXVsdERhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXREZWZhdWx0RGF0YVN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX0RBVEFfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICAgICAgICAgIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEKTsKCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U21zU3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFNtc1N1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFksCiAgICAgICAgICAgICAgICAgICAgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQpOwoKICAgIHByaXZhdGUgc3RhdGljIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8SW50ZWdlcj4gc0FjdGl2ZURhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRBY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgICAgICAgICAgQ0FDSEVfS0VZX0FDVElWRV9EQVRBX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzU2xvdEluZGV4Q2FjaGUgPQogICAgICAgICAgICBuZXcgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTw+KElTdWI6OmdldFNsb3RJbmRleCwKICAgICAgICAgICAgICAgICAgICBDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NJTV9TTE9UX0lOREVYKTsKCiAgICAvKiogQ2FjaGUgZGVwZW5kcyBvbiBnZXREZWZhdWx0U3ViSWQsIHNvIHdlIHVzZSB0aGUgZGVmYXVsdFN1YklkIGNhY2hlIGtleSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzUGhvbmVJZENhY2hlID0KICAgICAgICAgICAgbmV3IEludGVnZXJQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRQaG9uZUlkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1BIT05FX0lOREVYKTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gc2ltSW5mbyBjaGFuZ2UKICAgICAqIG9uIHRoZSBnaXZlbiBzdWJzY3JpcHRpb25JZAogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb25JZCB0byByZWNlaXZlIHVwZGF0ZXMgb24KICAgICAqIEByZXR1cm4gdGhlIFVyaSB1c2VkIHRvIG9ic2VydmUgY2FycmllciBpZGVudGl0eSBjaGFuZ2VzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIFVyaSBnZXRVcmlGb3JTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gVXJpLndpdGhBcHBlbmRlZFBhdGgoQ09OVEVOVF9VUkksIFN0cmluZy52YWx1ZU9mKHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIGVuYWJsZWQgdXNlciBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVm9XaUZpU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgV0ZDX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwgIndmYyIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIGFkdmFuY2VkIGNhbGxpbmcgdXNlciBzZXR0aW5nCiAgICAgKiBAc2VlIEltc01tVGVsTWFuYWdlciNpc0FkdmFuY2VkQ2FsbGluZ1NldHRpbmdFbmFibGVkKCkuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIGFkdmFuY2VkIGNhbGxpbmcgZW5hYmxlZAogICAgICoge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0FkdmFuY2VkQ2FsbGluZ1NldHRpbmdFbmFibGVkKCl9IHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuCiAgICAgKiBZb3UgY2FuIGFsc28gdXNlIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YKICAgICAqIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQURWQU5DRURfQ0FMTElOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAiYWR2YW5jZWRfY2FsbGluZyIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIHdmYyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyBtb2RlIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjZ2V0Vm9XaUZpTW9kZVNldHRpbmcoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKENPTlRFTlRfVVJJLCAid2ZjX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyByb2FtaW5nIG1vZGUge0BsaW5rIEltc01tVGVsTWFuYWdlciNnZXRWb1dpRmlSb2FtaW5nTW9kZVNldHRpbmcoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19NT0RFX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfbW9kZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIHZ0KHZpZGVvIHRlbGVwaG9ueSBvdmVyIElNUykgZW5hYmxlZAogICAgICogc2V0dGluZy4KICAgICAqIDxwPgogICAgICogVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gdnQgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVnRTZXR0aW5nRW5hYmxlZCgpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdCBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFZUX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aCgKICAgICAgICAgICAgQ09OVEVOVF9VUkksICJ2dF9lbmFibGVkIik7CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIHJvYW1pbmcgZW5hYmxlZCBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgcm9hbWluZyBlbmFibGVkIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjaXNWb1dpRmlSb2FtaW5nU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfZW5hYmxlZCIpOwoKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgdXJpfSB1c2VkIHRvIGNhbGwgdGhlIGFwcHJvcHJpYXRlIGJhY2t1cCBvciByZXN0b3JlIG1ldGhvZCBmb3Igc2ltLXNwZWNpZmljCiAgICAgKiBzZXR0aW5ncwogICAgICogPHA+CiAgICAgKiBTZWUge0BsaW5rICNHRVRfU0lNX1NQRUNJRklDX1NFVFRJTkdTX01FVEhPRF9OQU1FfSBhbmQge0BsaW5rCiAgICAgKiAjUkVTVE9SRV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUV9IGZvciBpbmZvcm1hdGlvbiBvbiB3aGF0IG1ldGhvZCB0byBjYWxsLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgImJhY2t1cF9hbmRfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayB1cml9IHVzZWQgdG8gbm90aWZ5IGNvbnRlbnRvYnNlcnZlcnMgbGlzdGVuaW5nIHRvIHNpbWluZm8gcmVzdG9yZSBkdXJpbmcKICAgICAqIFN1Vy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBTSU1fSU5GT19TVVdfUkVTVE9SRV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBTSU1fSU5GT19CQUNLVVBfQU5EX1JFU1RPUkVfQ09OVEVOVF9VUkksICJzdXdfcmVzdG9yZSIpOwoKICAgIC8qKgogICAgICogQSBjb250ZW50IHtAbGluayBVcml9IHVzZWQgdG8gcmVjZWl2ZSB1cGRhdGVzIG9uIGNyb3NzIHNpbSBlbmFibGVkIHVzZXIgc2V0dGluZy4KICAgICAqIDxwPgogICAgICogVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gY3Jvc3Mgc2ltIGNhbGxpbmcgZW5hYmxlZAogICAgICoge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc0Nyb3NzU2ltQ2FsbGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgQ1JPU1NfU0lNX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aChDT05URU5UX1VSSSwKICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRCk7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciB1bmlxdWUga2V5IGNvbHVtbiBuYW1lIGlzIHRoZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFVOSVFVRV9LRVlfU1VCU0NSSVBUSU9OX0lEID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fVU5JUVVFX0tFWV9TVUJTQ1JJUFRJT05fSUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlCiAgICAgKiBzcGVjaWZpYyBzdWJzY3JpcHRpb24gdHlwZS4gRm9yIGV4YW1wbGUsIGl0IGNvbnRhaW5zIFNJTSBJQ0MgSWRlbnRpZmllciBzdWJzY3JpcHRpb25zCiAgICAgKiBvbiBMb2NhbCBTSU1zLiBhbmQgTWFjLWFkZHJlc3MgZm9yIFJlbW90ZS1TSU0gU3Vic2NyaXB0aW9ucyBmb3IgQmx1ZXRvb3RoIGRldmljZXMuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElDQ19JRCA9IFNpbUluZm8uQ09MVU1OX0lDQ19JRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB1c2VyIFNJTV9TbE9UX0lOREVYCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFNJTV9TTE9UX0lOREVYID0gU2ltSW5mby5DT0xVTU5fU0lNX1NMT1RfSU5ERVg7CgogICAgLyoqIFNJTSBpcyBub3QgaW5zZXJ0ZWQgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0lNX05PVF9JTlNFUlRFRCA9IFNpbUluZm8uU0lNX05PVF9JTlNFUlRFRDsKCiAgICAvKioKICAgICAqIFRoZSBzbG90LWluZGV4IGZvciBCbHVldG9vdGggUmVtb3RlLVNJTSBzdWJzY3JpcHRpb25zCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTTE9UX0lOREVYX0ZPUl9SRU1PVEVfU0lNX1NVQiA9IElOVkFMSURfU0lNX1NMT1RfSU5ERVg7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBTdWJzY3JpcHRpb24tdHlwZS4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+IHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNfSBmb3IgTG9jYWwtU0lNIFN1YnNjcmlwdGlvbnMsCiAgICAgKiB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU19IGZvciBSZW1vdGUtU0lNIFN1YnNjcmlwdGlvbnMuCiAgICAgKiBEZWZhdWx0IHZhbHVlIGlzIDAuCiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgU1VCU0NSSVBUSU9OX1RZUEUgPSBTaW1JbmZvLkNPTFVNTl9TVUJTQ1JJUFRJT05fVFlQRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGRhdGFfZW5hYmxlZF9vdmVycmlkZV9ydWxlcy4KICAgICAqIEl0J3MgYSBsaXN0IG9mIHJ1bGVzIGZvciBvdmVycmlkaW5nIGRhdGEgZW5hYmxlZCBzZXR0aW5ncy4gVGhlIHN5bnRheCBpcwogICAgICogRm9yIGV4YW1wbGUsICJtbXM9bm9uRGVmYXVsdCIgaW5kaWNhdGVzIGVuYWJsaW5nIGRhdGEgZm9yIG1tcyBpbiBub24tZGVmYXVsdCBzdWJzY3JpcHRpb24uCiAgICAgKiAiZGVmYXVsdD1ub25EZWZhdWx0JmluVm9pY2VDYWxsIiBpbmRpY2F0ZXMgZW5hYmxpbmcgZGF0YSBmb3IgaW50ZXJuZXQgaW4gbm9uLWRlZmF1bHQKICAgICAqIHN1YnNjcmlwdGlvbiBhbmQgd2hpbGUgaXMgaW4gdm9pY2UgY2FsbC4KICAgICAqCiAgICAgKiBEZWZhdWx0IHZhbHVlIGlzIGVtcHR5IHN0cmluZy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVMgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9EQVRBX0VOQUJMRURfT1ZFUlJJREVfUlVMRVM7CgogICAgLyoqIEBoaWRlICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsiU1VCU0NSSVBUSU9OX1RZUEVfIn0sCiAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgIFNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTSwKICAgICAgICAgICAgU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTX0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBTdWJzY3JpcHRpb25UeXBlIHt9CgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnN0YW50IGlzIHRvIGRlc2lnbmF0ZSBhIHN1YnNjcmlwdGlvbiBhcyBhIExvY2FsLVNJTSBTdWJzY3JpcHRpb24uCiAgICAgKiA8cD4gQSBMb2NhbC1TSU0gY2FuIGJlIGEgcGh5c2ljYWwgU0lNIGluc2VydGVkIGludG8gYSBzaW0tc2xvdCBpbiB0aGUgZGV2aWNlLCBvciBlU0lNIG9uIHRoZQogICAgICogZGV2aWNlLgogICAgICogPC9wPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVUJTQ1JJUFRJT05fVFlQRV9MT0NBTF9TSU0gPSBTaW1JbmZvLlNVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTTsKCiAgICAvKioKICAgICAqIFRoaXMgY29uc3RhbnQgaXMgdG8gZGVzaWduYXRlIGEgc3Vic2NyaXB0aW9uIGFzIGEgUmVtb3RlLVNJTSBTdWJzY3JpcHRpb24uCiAgICAgKiA8cD4KICAgICAqIEEgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMgZm9yIGEgU0lNIG9uIGEgcGhvbmUgY29ubmVjdGVkIHRvIHRoaXMgZGV2aWNlIHZpYSBzb21lCiAgICAgKiBjb25uZWN0aXZpdHkgbWVjaGFuaXNtLCBmb3IgZXhhbXBsZSBibHVldG9vdGguIFNpbWlsYXIgdG8gTG9jYWwgU0lNLCB0aGlzIHN1YnNjcmlwdGlvbiBjYW4KICAgICAqIGJlIHVzZWQgZm9yIFNNUywgVm9pY2UgYW5kIGRhdGEgYnkgcHJveHlpbmcgZGF0YSB0aHJvdWdoIHRoZSBjb25uZWN0ZWQgZGV2aWNlLgogICAgICogQ2VydGFpbiBkYXRhIG9mIHRoZSBTSU0sIHN1Y2ggYXMgSU1FSSwgYXJlIG5vdCBhY2Nlc3NpYmxlIGZvciBSZW1vdGUgU0lNcy4KICAgICAqIDwvcD4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIEEgUmVtb3RlLVNJTSBpcyBhdmFpbGFibGUgb25seSBhcyBsb25nIHRoZSBwaG9uZSBzdGF5cyBjb25uZWN0ZWQgdG8gdGhpcyBkZXZpY2UuCiAgICAgKiBXaGVuIHRoZSBwaG9uZSBkaXNjb25uZWN0cywgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gaXMgcmVtb3ZlZCBmcm9tIHRoaXMgZGV2aWNlIGFuZCBpcwogICAgICogbm8gbG9uZ2VyIGtub3duLiBBbGwgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbiwgc3VjaCBhcyBzdG9yZWQgU01TLCBjYWxsIGxvZ3MsCiAgICAgKiBjb250YWN0cyBldGMsIGFyZSByZW1vdmVkIGZyb20gdGhpcyBkZXZpY2UuCiAgICAgKiA8L3A+CiAgICAgKgogICAgICogPHA+CiAgICAgKiBJZiB0aGUgcGhvbmUgcmUtY29ubmVjdHMgdG8gdGhpcyBkZXZpY2UsIGEgbmV3IFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9uIGlzIGNyZWF0ZWQgZm9yCiAgICAgKiB0aGUgcGhvbmUuIFRoZSBTdWJzY3JpcHRpb24gSWQgYXNzb2NpYXRlZCB3aXRoIHRoZSBuZXcgc3Vic2NyaXB0aW9uIGlzIGRpZmZlcmVudCBmcm9tCiAgICAgKiB0aGUgU3Vic2NyaXB0aW9uIElkIG9mIHRoZSBwcmV2aW91cyBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiBjcmVhdGVkIChhbmQgcmVtb3ZlZCkgZm9yIHRoZQogICAgICogcGhvbmU7IGkuZS4sIG5ldyBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiB0cmVhdHMgdGhlIHJlY29ubmVjdGVkIHBob25lIGFzIGEgUmVtb3RlLVNJTSB0aGF0CiAgICAgKiB3YXMgbmV2ZXIgc2VlbiBiZWZvcmUuCiAgICAgKiA8L3A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU0gPSBTaW1JbmZvLlNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU07CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdXNlciBkaXNwbGF5ZWQgbmFtZS4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRElTUExBWV9OQU1FID0gU2ltSW5mby5DT0xVTU5fRElTUExBWV9OQU1FOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBzZXJ2aWNlIHByb3ZpZGVyIG5hbWUgZm9yIHRoZSBTSU0uCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENBUlJJRVJfTkFNRSA9IFNpbUluZm8uQ09MVU1OX0NBUlJJRVJfTkFNRTsKCiAgICAvKioKICAgICAqIERlZmF1bHQgbmFtZSByZXNvdXJjZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREVGQVVMVF9OQU1FX1JFUyA9IGNvbS5hbmRyb2lkLmludGVybmFsLlIuc3RyaW5nLnVua25vd25OYW1lOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHNvdXJjZSBvZiB0aGUgdXNlciBkaXNwbGF5ZWQgbmFtZS4KICAgICAqIDxQPlR5cGU6IElOVCAoaW50KTwvUD4gd2l0aCBvbmUgb2YgdGhlIE5BTUVfU09VUkNFX1hYWFggdmFsdWVzIGJlbG93CiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTkFNRV9TT1VSQ0UgPSBTaW1JbmZvLkNPTFVNTl9OQU1FX1NPVVJDRTsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIHRoZSBjYXJyaWVyIGlkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRCA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRDsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIFNJTSBFRl9TUE4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9TSU1fU1BOID0gU2ltSW5mby5OQU1FX1NPVVJDRV9TSU1fU1BOOwoKICAgIC8qKgogICAgICogVGhlIG5hbWVfc291cmNlIGlzIGZyb20gdXNlciBpbnB1dAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5BTUVfU09VUkNFX1VTRVJfSU5QVVQgPSBTaW1JbmZvLk5BTUVfU09VUkNFX1VTRVJfSU5QVVQ7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgY2FycmllciAoY2FycmllciBhcHAsIGNhcnJpZXIgY29uZmlnLCBldGMuKQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfQ0FSUklFUiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfQ0FSUklFUjsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIFNJTSBFRl9QTk4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9TSU1fUE5OID0gU2ltSW5mby5OQU1FX1NPVVJDRV9TSU1fUE5OOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7Ik5BTUVfU09VUkNFXyJ9LAogICAgICAgICAgICB2YWx1ZSA9IHsKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9DQVJSSUVSX0lELAogICAgICAgICAgICAgICAgICAgIE5BTUVfU09VUkNFX1NJTV9TUE4sCiAgICAgICAgICAgICAgICAgICAgTkFNRV9TT1VSQ0VfVVNFUl9JTlBVVCwKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9DQVJSSUVSLAogICAgICAgICAgICAgICAgICAgIE5BTUVfU09VUkNFX1NJTV9QTk4KICAgICAgICAgICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFNpbURpc3BsYXlOYW1lU291cmNlIHt9CgogICAgLyoqCiAgICAgKiBEZXZpY2Ugc3RhdHVzIGlzIG5vdCBzaGFyZWQgdG8gYSByZW1vdGUgcGFydHkuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEQyRF9TSEFSSU5HX0RJU0FCTEVEID0gMDsKCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgc2hhcmVkIHdpdGggYWxsIG51bWJlcnMgaW4gdGhlIHVzZXIncyBjb250YWN0cy4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRDJEX1NIQVJJTkdfQUxMX0NPTlRBQ1RTID0gMTsKCiAgICAvKioKICAgICAqIERldmljZSBzdGF0dXMgaXMgc2hhcmVkIHdpdGggYWxsIHNlbGVjdGVkIGNvbnRhY3RzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEMkRfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUyA9IDI7CgogICAgLyoqCiAgICAgKiBEZXZpY2Ugc3RhdHVzIGlzIHNoYXJlZCB3aGVuZXZlciBwb3NzaWJsZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRDJEX1NIQVJJTkdfQUxMID0gMzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJEMkRfU0hBUklOR18ifSwKICAgICAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgICAgICAgICAgRDJEX1NIQVJJTkdfRElTQUJMRUQsCiAgICAgICAgICAgICAgICAgICAgRDJEX1NIQVJJTkdfQUxMX0NPTlRBQ1RTLAogICAgICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX1NFTEVDVEVEX0NPTlRBQ1RTLAogICAgICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX0FMTAogICAgICAgICAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgRGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSB7fQoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGRldmljZSB0byBkZXZpY2Ugc2hhcmluZyBzdGF0dXMuCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEMkRfU1RBVFVTX1NIQVJJTkcgPSBTaW1JbmZvLkNPTFVNTl9EMkRfU1RBVFVTX1NIQVJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgY29udGFjdHMgaW5mb3JtYXRpb24gdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHNoYXJpbmcuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBEMkRfU1RBVFVTX1NIQVJJTkdfU0VMRUNURURfQ09OVEFDVFMgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9EMkRfU1RBVFVTX1NIQVJJTkdfU0VMRUNURURfQ09OVEFDVFM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIGNvbG9yIG9mIGEgU0lNLgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBIVUUgPSBTaW1JbmZvLkNPTFVNTl9DT0xPUjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgcGhvbmUgbnVtYmVyIG9mIGEgU0lNLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBOVU1CRVIgPSBTaW1JbmZvLkNPTFVNTl9OVU1CRVI7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igd2hldGhlciBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZC4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgREFUQV9ST0FNSU5HID0gU2ltSW5mby5DT0xVTU5fREFUQV9ST0FNSU5HOwoKICAgIC8qKiBJbmRpY2F0ZXMgdGhhdCBkYXRhIHJvYW1pbmcgaXMgZW5hYmxlZCBmb3IgYSBzdWJzY3JpcHRpb24gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfUk9BTUlOR19FTkFCTEUgPSBTaW1JbmZvLkRBVEFfUk9BTUlOR19FTkFCTEU7CgogICAgLyoqIEluZGljYXRlcyB0aGF0IGRhdGEgcm9hbWluZyBpcyBkaXNhYmxlZCBmb3IgYSBzdWJzY3JpcHRpb24gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERBVEFfUk9BTUlOR19ESVNBQkxFID0gU2ltSW5mby5EQVRBX1JPQU1JTkdfRElTQUJMRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBzdWJzY3JpcHRpb24gY2FycmllciBpZC4KICAgICAqIEBzZWUgVGVsZXBob255TWFuYWdlciNnZXRTaW1DYXJyaWVySWQoKQogICAgICogPHA+VHlwZTogSU5URUdFUiAoaW50KSA8L3A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJSSUVSX0lEID0gU2ltSW5mby5DT0xVTU5fQ0FSUklFUl9JRDsKCiAgICAvKioKICAgICAqIEBoaWRlIEEgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgRUhQTE1OcyBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgRUhQTE1OUyA9IFNpbUluZm8uQ09MVU1OX0VIUExNTlM7CgogICAgLyoqCiAgICAgKiBAaGlkZSBBIGNvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIEhQTE1OcyBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSFBMTU5TID0gU2ltSW5mby5DT0xVTU5fSFBMTU5TOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNQ0MgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLCBzdG9yZWQgYXMgYSBzdHJpbmcuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTUNDX1NUUklORyA9IFNpbUluZm8uQ09MVU1OX01DQ19TVFJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIE1OQyBhc3NvY2lhdGVkIHdpdGggYSBTSU0sIHN0b3JlZCBhcyBhIHN0cmluZy4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNTkNfU1RSSU5HID0gU2ltSW5mby5DT0xVTU5fTU5DX1NUUklORzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgTUNDIGFzc29jaWF0ZWQgd2l0aCBhIFNJTS4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNQ0MgPSBTaW1JbmZvLkNPTFVNTl9NQ0M7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIE1OQyBhc3NvY2lhdGVkIHdpdGggYSBTSU0uCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTU5DID0gU2ltSW5mby5DT0xVTU5fTU5DOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBpc28gY291bnRyeSBjb2RlIGFzc29jaWF0ZWQgd2l0aCBhIFNJTS4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJU09fQ09VTlRSWV9DT0RFID0gU2ltSW5mby5DT0xVTU5fSVNPX0NPVU5UUllfQ09ERTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIGVtYmVkZGVkICh0aGF0IGlzLCBwcmVzZW50IG9uIGFuCiAgICAgKiBlU0lNKS4KICAgICAqIDxwPlR5cGU6IElOVEVHRVIgKGludCksIDEgZm9yIGVtYmVkZGVkIG9yIDAgZm9yIG5vbi1lbWJlZGRlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX0VNQkVEREVEID0gU2ltSW5mby5DT0xVTU5fSVNfRU1CRURERUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgU0lNIGNhcmQgaWRlbnRpZmllci4gRm9yIFVJQ0MgY2FyZCBpdCBpcyB0aGUgSUNDSUQgb2YgdGhlCiAgICAgKiBjdXJyZW50IGVuYWJsZWQgcHJvZmlsZSBvbiB0aGUgY2FyZCwgd2hpbGUgZm9yIGVVSUNDIGNhcmQgaXQgaXMgdGhlIEVJRCBvZiB0aGUgY2FyZC4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJEX0lEID0gU2ltSW5mby5DT0xVTU5fQ0FSRF9JRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgZW5jb2RlZCB7QGxpbmsgVWljY0FjY2Vzc1J1bGV9cyBmcm9tCiAgICAgKiB7QGxpbmsgVWljY0FjY2Vzc1J1bGUjZW5jb2RlUnVsZXN9LiBPbmx5IHByZXNlbnQgaWYge0BsaW5rICNJU19FTUJFRERFRH0gaXMgMS4KICAgICAqIDxwPlRZUEU6IEJMT0IKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDQ0VTU19SVUxFUyA9IFNpbUluZm8uQ09MVU1OX0FDQ0VTU19SVUxFUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgZW5jb2RlZCB7QGxpbmsgVWljY0FjY2Vzc1J1bGV9cyBmcm9tCiAgICAgKiB7QGxpbmsgVWljY0FjY2Vzc1J1bGUjZW5jb2RlUnVsZXN9IGJ1dCBmb3IgdGhlIHJ1bGVzIHRoYXQgY29tZSBmcm9tIENhcnJpZXJDb25maWdzLgogICAgICogT25seSBwcmVzZW50IGlmIHRoZXJlIGFyZSBhY2Nlc3MgcnVsZXMgaW4gQ2FycmllckNvbmZpZ3MKICAgICAqIDxwPlRZUEU6IEJMT0IKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDQ0VTU19SVUxFU19GUk9NX0NBUlJJRVJfQ09ORklHUyA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0FDQ0VTU19SVUxFU19GUk9NX0NBUlJJRVJfQ09ORklHUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGlkZW50aWZ5aW5nIHdoZXRoZXIgYW4gZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGlzIG9uIGEgcmVtb3ZhYmxlCiAgICAgKiBjYXJkLiBTdWNoIHN1YnNjcmlwdGlvbnMgYXJlIG1hcmtlZCBpbmFjY2Vzc2libGUgYXMgc29vbiBhcyB0aGUgY3VycmVudCBjYXJkIGlzIHJlbW92ZWQuCiAgICAgKiBPdGhlcndpc2UsIHRoZXkgd2lsbCByZW1haW4gYWNjZXNzaWJsZSB1bmxlc3MgZXhwbGljaXRseSBkZWxldGVkLiBPbmx5IHByZXNlbnQgaWYKICAgICAqIHtAbGluayAjSVNfRU1CRURERUR9IGlzIDEuCiAgICAgKiA8cD5UWVBFOiBJTlRFR0VSIChpbnQpLCAxIGZvciByZW1vdmFibGUgb3IgMCBmb3Igbm9uLXJlbW92YWJsZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX1JFTU9WQUJMRSA9IFNpbUluZm8uQ09MVU1OX0lTX1JFTU9WQUJMRTsKCiAgICAvKioKICAgICAqICBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZXh0cmVtZSB0aHJlYXQgaW4gQ0Igc2V0dGluZ3MKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0VYVFJFTUVfVEhSRUFUX0FMRVJUID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ0JfRVhUUkVNRV9USFJFQVRfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igc2V2ZXJlIHRocmVhdCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9TRVZFUkVfVEhSRUFUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfU0VWRVJFX1RIUkVBVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbWJlciBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTUJFUl9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0FNQkVSX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVtZXJnZW5jeSBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9FTUVSR0VOQ1lfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9FTUVSR0VOQ1lfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYWxlcnQgc291bmQgZHVyYXRpb24gaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfU09VTkRfRFVSQVRJT04gPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9TT1VORF9EVVJBVElPTjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBhbGVydCByZW1pbmRlciBpbnRlcnZhbCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTEVSVF9SRU1JTkRFUl9JTlRFUlZBTCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1JFTUlOREVSX0lOVEVSVkFMOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsaW5nIHZpYnJhdGUgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfVklCUkFURSA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1ZJQlJBVEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZW5hYmxpbmcgYWxlcnQgc3BlZWNoIGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0FMRVJUX1NQRUVDSCA9IFNpbUluZm8uQ09MVU1OX0NCX0FMRVJUX1NQRUVDSDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBFVFdTIHRlc3QgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfRVRXU19URVNUX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfRVRXU19URVNUX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBjaGFubmVsNTAgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQ0hBTk5FTF81MF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NIQU5ORUxfNTBfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgQ01BUyB0ZXN0IGFsZXJ0IGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0NNQVNfVEVTVF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0NNQVNfVEVTVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBPcHQgb3V0IGRpYWxvZyBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9PUFRfT1VUX0RJQUxPRyA9IFNpbUluZm8uQ09MVU1OX0NCX09QVF9PVVRfRElBTE9HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBWb2x0ZS4KICAgICAqCiAgICAgKiBJZiB0aGlzIHNldHRpbmcgaXMgbm90IGluaXRpYWxpemVkIChzZXQgdG8gLTEpICB0aGVuIHdlIHVzZSB0aGUgQ2FycmllciBDb25maWcgdmFsdWUKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfRU5IQU5DRURfNEdfTFRFX09OX0JZX0RFRkFVTFRfQk9PTH0uCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVOSEFOQ0VEXzRHX01PREVfRU5BQkxFRCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0VOSEFOQ0VEXzRHX01PREVfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgVlQgKFZpZGVvIFRlbGVwaG9ueSBvdmVyIElNUykKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVlRfSU1TX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9WVF9JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgV2lmaSBjYWxsaW5nCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFdGQ19JTVNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBXaWZpIGNhbGxpbmcgbW9kZQogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX01PREUgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX01PREU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgV2lmaSBjYWxsaW5nIG1vZGUgaW4gcm9hbWluZwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfTU9ERSA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19NT0RFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsZSBXaWZpIGNhbGxpbmcgaW4gcm9hbWluZwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX1JPQU1JTkdfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1dGQ19JTVNfUk9BTUlOR19FTkFCTEVEOwoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyBpZiB0aGUgdXNlciBoYXMgZW5hYmxlZCBJTVMgUkNTIFVzZXIgQ2FwYWJpbGl0eSBFeGNoYW5nZSAoVUNFKSBmb3IgdGhpcwogICAgICogc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSU1TX1JDU19VQ0VfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX0lNU19SQ1NfVUNFX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIGlmIHRoZSB1c2VyIGhhcyBlbmFibGVkIGNyb3NzIFNJTSBjYWxsaW5nIGZvciB0aGlzIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDUk9TU19TSU1fQ0FMTElOR19FTkFCTEVEID0gU2ltSW5mby5DT0xVTU5fQ1JPU1NfU0lNX0NBTExJTkdfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIG9wcG9ydHVuaXN0aWMsIHRoYXQgaXMsCiAgICAgKiB3aGV0aGVyIHRoZSBuZXR3b3JrIGl0IGNvbm5lY3RzIHRvIGlzIGxpbWl0ZWQgaW4gZnVuY3Rpb25hbGl0eSBvciBjb3ZlcmFnZS4KICAgICAqIEZvciBleGFtcGxlLCBDQlJTLgogICAgICogPHA+VHlwZTogSU5URUdFUiAoaW50KSwgMSBmb3Igb3Bwb3J0dW5pc3RpYyBvciAwIGZvciBub24tb3Bwb3J0dW5pc3RpYy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElTX09QUE9SVFVOSVNUSUMgPSBTaW1JbmZvLkNPTFVNTl9JU19PUFBPUlRVTklTVElDOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGdyb3VwIElELiBTdWJzY3JpcHRpb25zIHdpdGggc2FtZSBncm91cCBJRAogICAgICogYXJlIGNvbnNpZGVyZWQgYnVuZGxlZCB0b2dldGhlciwgYW5kIHNob3VsZCBiZWhhdmUgYXMgYSBzaW5nbGUgc3Vic2NyaXB0aW9uIGF0CiAgICAgKiBjZXJ0YWluIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBHUk9VUF9VVUlEID0gU2ltSW5mby5DT0xVTU5fR1JPVVBfVVVJRDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBncm91cCBvd25lci4gSXQncyB0aGUgcGFja2FnZSBuYW1lIHdobyBjcmVhdGVkCiAgICAgKiB0aGUgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEdST1VQX09XTkVSID0gU2ltSW5mby5DT0xVTU5fR1JPVVBfT1dORVI7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIHByb2ZpbGUgY2xhc3Mgb2YgYSBzdWJzY3JpcHRpb24KICAgICAqIE9ubHkgcHJlc2VudCBpZiB7QGxpbmsgI0lTX0VNQkVEREVEfSBpcyAxLgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFBST0ZJTEVfQ0xBU1MgPSBTaW1JbmZvLkNPTFVNTl9QUk9GSUxFX0NMQVNTOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBwb3J0IGluZGV4IG9mIHRoZSBhY3RpdmUgVUlDQyBwb3J0LgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFBPUlRfSU5ERVggPSBTaW1JbmZvLkNPTFVNTl9QT1JUX0lOREVYOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIFZvSU1TIG9wdC1pbiBzdGF0dXMuCiAgICAgKgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFZPSU1TX09QVF9JTl9TVEFUVVMgPSBTaW1JbmZvLkNPTFVNTl9WT0lNU19PUFRfSU5fU1RBVFVTOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIE5SIEFkdmFuY2VkIGNhbGxpbmcKICAgICAqIERldGVybWluZXMgaWYgdGhlIHVzZXIgaGFzIGVuYWJsZWQgVm9OUiBzZXR0aW5ncyBmb3IgdGhpcyBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTlJfQURWQU5DRURfQ0FMTElOR19FTkFCTEVEID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fTlJfQURWQU5DRURfQ0FMTElOR19FTkFCTEVEOwoKICAgIC8qKgogICAgICogUHJvZmlsZSBjbGFzcyBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5TT1VSQ0UpCiAgICBASW50RGVmKHByZWZpeCA9IHsgIlBST0ZJTEVfQ0xBU1NfIiB9LCB2YWx1ZSA9IHsKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1RFU1RJTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcsCiAgICAgICAgICAgIFNpbUluZm8uUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTCwKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1VOU0VULAogICAgfSkKICAgIHB1YmxpYyBAaW50ZXJmYWNlIFByb2ZpbGVDbGFzcyB7fQoKICAgIC8qKgogICAgICogQSB0ZXN0aW5nIHByb2ZpbGUgY2FuIGJlIHByZS1sb2FkZWQgb3IgZG93bmxvYWRlZCBvbnRvCiAgICAgKiB0aGUgZVVJQ0MgYW5kIHByb3ZpZGVzIGNvbm5lY3Rpdml0eSB0byB0ZXN0IGVxdWlwbWVudAogICAgICogZm9yIHRoZSBwdXJwb3NlIG9mIHRlc3RpbmcgdGhlIGRldmljZSBhbmQgdGhlIGVVSUNDLiBJdAogICAgICogaXMgbm90IGludGVuZGVkIHRvIHN0b3JlIGFueSBvcGVyYXRvciBjcmVkZW50aWFscy4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfVEVTVElORyA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19URVNUSU5HOwoKICAgIC8qKgogICAgICogQSBwcm92aXNpb25pbmcgcHJvZmlsZSBpcyBwcmUtbG9hZGVkIG9udG8gdGhlIGVVSUNDIGFuZAogICAgICogcHJvdmlkZXMgY29ubmVjdGl2aXR5IHRvIGEgbW9iaWxlIG5ldHdvcmsgc29sZWx5IGZvciB0aGUKICAgICAqIHB1cnBvc2Ugb2YgcHJvdmlzaW9uaW5nIHByb2ZpbGVzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkcgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfUFJPVklTSU9OSU5HOwoKICAgIC8qKgogICAgICogQW4gb3BlcmF0aW9uYWwgcHJvZmlsZSBjYW4gYmUgcHJlLWxvYWRlZCBvciBkb3dubG9hZGVkCiAgICAgKiBvbnRvIHRoZSBlVUlDQyBhbmQgcHJvdmlkZXMgc2VydmljZXMgcHJvdmlkZWQgYnkgdGhlCiAgICAgKiBvcGVyYXRvci4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfT1BFUkFUSU9OQUwgPSBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfT1BFUkFUSU9OQUw7CgogICAgLyoqCiAgICAgKiBUaGUgcHJvZmlsZSBjbGFzcyBpcyB1bnNldC4gVGhpcyBvY2N1cnMgd2hlbiBwcm9maWxlIGNsYXNzCiAgICAgKiBpbmZvIGlzIG5vdCBhdmFpbGFibGUuIFRoZSBzdWJzY3JpcHRpb24gZWl0aGVyIGhhcyBubyBwcm9maWxlCiAgICAgKiBtZXRhZGF0YSBvciB0aGUgcHJvZmlsZSBtZXRhZGF0YSBkaWQgbm90IGVuY29kZSBwcm9maWxlIGNsYXNzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19VTlNFVCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19VTlNFVDsKCiAgICAvKioKICAgICAqIERlZmF1bHQgcHJvZmlsZSBjbGFzcwogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQERlcHJlY2F0ZWQKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBST0ZJTEVfQ0xBU1NfREVGQVVMVCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19VTlNFVDsKCiAgICAvKioKICAgICAqIElNU0kgKEludGVybmF0aW9uYWwgTW9iaWxlIFN1YnNjcmliZXIgSWRlbnRpdHkpLgogICAgICogPFA+VHlwZTogVEVYVCA8L1A+CiAgICAgKiBAaGlkZQogICAgICovCiAgICAvL1RPRE86IGFkZCBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJTVNJID0gU2ltSW5mby5DT0xVTU5fSU1TSTsKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdWljYyBhcHBsaWNhdGlvbnMgaXMgc2V0IHRvIGJlIGVuYWJsZWQgb3IgZGlzYWJsZWQuIEJ5IGRlZmF1bHQgaXQncyBlbmFibGVkLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgVUlDQ19BUFBMSUNBVElPTlNfRU5BQkxFRCA9IFNpbUluZm8uQ09MVU1OX1VJQ0NfQVBQTElDQVRJT05TX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSB3aGljaCBuZXR3b3JrIHR5cGUgaXMgYWxsb3dlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFMTE9XRURfTkVUV09SS19UWVBFUyA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0FMTE9XRURfTkVUV09SS19UWVBFU19GT1JfUkVBU09OUzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJVU0FHRV9TRVRUSU5HXyJ9LAogICAgICAgIHZhbHVlID0gewogICAgICAgICAgICBVU0FHRV9TRVRUSU5HX1VOS05PV04sCiAgICAgICAgICAgIFVTQUdFX1NFVFRJTkdfREVGQVVMVCwKICAgICAgICAgICAgVVNBR0VfU0VUVElOR19WT0lDRV9DRU5UUklDLAogICAgICAgICAgICBVU0FHRV9TRVRUSU5HX0RBVEFfQ0VOVFJJQ30pCiAgICBwdWJsaWMgQGludGVyZmFjZSBVc2FnZVNldHRpbmcge30KCiAgICAvKioKICAgICAqIFRoZSB1c2FnZSBzZXR0aW5nIGlzIHVua25vd24uCiAgICAgKgogICAgICogVGhpcyB3aWxsIGJlIHRoZSB1c2FnZSBzZXR0aW5nIHJldHVybmVkIG9uIGRldmljZXMgdGhhdCBkbyBub3Qgc3VwcG9ydCBxdWVyeWluZyB0aGUKICAgICAqIG9yIHNldHRpbmcgdGhlIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogSXQgbWF5IGFsc28gYmUgcHJvdmlkZWQgYnkgYSBjYXJyaWVyIHRoYXQgd2lzaGVzIHRvIHByb3ZpZGUgYSB2YWx1ZSB0byBhdm9pZCBtYWtpbmcgYW55CiAgICAgKiBzZXR0aW5ncyBjaGFuZ2VzLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX1VOS05PV04gPSAtMTsKCiAgICAvKioKICAgICAqIFN1YnNjcmlwdGlvbiB1c2VzIHRoZSBkZWZhdWx0IHNldHRpbmcuCiAgICAgKgogICAgICogVGhlIHZhbHVlIGlzIGJhc2VkIHVwb24gZGV2aWNlIGNhcGFiaWxpdHkgYW5kIHRoZSBvdGhlciBwcm9wZXJ0aWVzIG9mIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogTW9zdCBzdWJzY3JpcHRpb25zIHdpbGwgZGVmYXVsdCB0byB2b2ljZS1jZW50cmljIHdoZW4gaW4gYSBwaG9uZS4KICAgICAqCiAgICAgKiBBbiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiB3aWxsIGRlZmF1bHQgdG8gZGF0YS1jZW50cmljLgogICAgICoKICAgICAqIHtAc2VlIFN1YnNjcmlwdGlvbkluZm8jaXNPcHBvcnR1bmlzdGljfQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX0RFRkFVTFQgPSAwOwoKICAgIC8qKgogICAgICogVGhpcyBzdWJzY3JpcHRpb24gaXMgZm9yY2VkIHRvIHZvaWNlLWNlbnRyaWMgbW9kZQogICAgICoKICAgICAqIDxwPlJlZmVyIHRvIHZvaWNlLWNlbnRyaWMgbW9kZSBpbiAzZ3BwIDI0LjMwMSBzZWMgNC4zIGFuZCAzZ3BwIDI0LjUwMSBzZWMgNC4zLgogICAgICogQWxzbyByZWZlciB0byAiVUUncyB1c2FnZSBzZXR0aW5nIiBhcyBkZWZpbmVkIGluIDNncHAgMjQuMzAxIHNlY3Rpb24gMy4xIGFuZCAzZ3BwIDIzLjIyMQogICAgICogQW5uZXggQS4KICAgICAqCiAgICAgKiA8cD5EZXZpY2VzIHRoYXQgc3VwcG9ydCB7QGxpbmsgUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTllfQ0FMTElOR30gYW5kIHN1cHBvcnQgdXNhZ2UKICAgICAqIHNldHRpbmcgY29uZmlndXJhdGlvbiBtdXN0IHN1cHBvcnQgc2V0dGluZyB0aGlzIHZhbHVlIHZpYQogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DRUxMVUxBUl9VU0FHRV9TRVRUSU5HX0lOVH0uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFVTQUdFX1NFVFRJTkdfVk9JQ0VfQ0VOVFJJQyA9IDE7CgogICAgLyoqCiAgICAgKiBUaGlzIHN1YnNjcmlwdGlvbiBpcyBmb3JjZWQgdG8gZGF0YS1jZW50cmljIG1vZGUKICAgICAqCiAgICAgKiA8cD5SZWZlciB0byBkYXRhLWNlbnRyaWMgbW9kZSBpbiAzZ3BwIDI0LjMwMSBzZWMgNC4zIGFuZCAzZ3BwIDI0LjUwMSBzZWMgNC4zLgogICAgICogQWxzbyByZWZlciB0byAiVUUncyB1c2FnZSBzZXR0aW5nIiBhcyBkZWZpbmVkIGluIDNncHAgMjQuMzAxIHNlY3Rpb24gMy4xIGFuZCAzZ3BwIDIzLjIyMQogICAgICogQW5uZXggQS4KICAgICAqCiAgICAgKiA8cD5EZXZpY2VzIHRoYXQgc3VwcG9ydCB7QGxpbmsgUGFja2FnZU1hbmFnZXIjRkVBVFVSRV9URUxFUEhPTllfREFUQX0gYW5kIHN1cHBvcnQgdXNhZ2UKICAgICAqIHNldHRpbmcgY29uZmlndXJhdGlvbiBtdXN0IHN1cHBvcnQgc2V0dGluZyB0aGlzIHZhbHVlIHZpYS4KICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ0VMTFVMQVJfVVNBR0VfU0VUVElOR19JTlR9LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBVU0FHRV9TRVRUSU5HX0RBVEFfQ0VOVFJJQyA9IDI7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZSB0aGUgcHJlZmVycmVkIHVzYWdlIHNldHRpbmcgZm9yIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogMCAtIERlZmF1bHQgLSBJZiB0aGUgdmFsdWUgaGFzIG5vdCBiZWVuIGV4cGxpY2l0bHkgc2V0LCBpdCB3aWxsIGJlICJkZWZhdWx0IgogICAgICogMSAtIFZvaWNlLWNlbnRyaWMKICAgICAqIDIgLSBEYXRhLWNlbnRyaWMKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBVU0FHRV9TRVRUSU5HID0gU2ltSW5mby5DT0xVTU5fVVNBR0VfU0VUVElORzsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSB1c2VyIGhhcyBjaGFuZ2VkIG9uZSBvZiB0aGUgZGVmYXVsdCBzdWJzIHJlbGF0ZWQgdG8KICAgICAqIGRhdGEsIHBob25lIGNhbGxzLCBvciBzbXM8L3A+CiAgICAgKgogICAgICogVE9ETzogQ2hhbmdlIHRvIGEgbGlzdGVuZXIKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBTVUJfREVGQVVMVF9DSEFOR0VEX0FDVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLmludGVudC5hY3Rpb24uU1VCX0RFRkFVTFRfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICogVGhlIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSBleHRyYSBpbmRpY2F0ZXMgdGhlIGN1cnJlbnQgZGVmYXVsdCBzdWJzY3JpcHRpb24gaW5kZXgKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VECiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBkZWZhdWx0IHNtcyBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICoge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IGV4dHJhIGluZGljYXRlcyB0aGUgY3VycmVudCBkZWZhdWx0IHNtcwogICAgICogc3Vic2NyaXB0aW9uIGluZGV4CiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fREVGQVVMVF9TTVNfU1VCU0NSSVBUSU9OX0NIQU5HRUQKICAgICAgICAgICAgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLkRFRkFVTFRfU01TX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEFjdGl2aXR5IEFjdGlvbjogRGlzcGxheSBVSSBmb3IgbWFuYWdpbmcgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW5zCiAgICAgKiBiZXR3ZWVuIGEgY2FycmllciBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBDYXJyaWVyIGFwcHMgYXJlIGVuY291cmFnZWQgdG8gaW1wbGVtZW50IHRoaXMgYWN0aXZpdHksIGFuZCB0aGUgT1Mgd2lsbAogICAgICogcHJvdmlkZSBhbiBhZmZvcmRhbmNlIHRvIHF1aWNrbHkgZW50ZXIgdGhpcyBhY3Rpdml0eSwgdHlwaWNhbGx5IHZpYQogICAgICogU2V0dGluZ3MuIFRoaXMgYWZmb3JkYW5jZSB3aWxsIG9ubHkgYmUgc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMKICAgICAqIGFjdGl2ZWx5IHByb3ZpZGluZyBzdWJzY3JpcHRpb24gcGxhbiBpbmZvcm1hdGlvbiB2aWEKICAgICAqIHtAbGluayAjc2V0U3Vic2NyaXB0aW9uUGxhbnMoaW50LCBMaXN0KX0uCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIHRoZSB1c2VyIGlzIGludGVyZXN0ZWQgaW4uCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQUNUSVZJVFlfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFucwogICAgICogYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogQ2FycmllciBhcHBzIGFyZSBlbmNvdXJhZ2VkIHRvIGltcGxlbWVudCB0aGlzIHJlY2VpdmVyLCBhbmQgdGhlIE9TIHdpbGwKICAgICAqIHByb3ZpZGUgYW4gYWZmb3JkYW5jZSB0byByZXF1ZXN0IGEgcmVmcmVzaC4gVGhpcyBhZmZvcmRhbmNlIHdpbGwgb25seSBiZQogICAgICogc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMgYWN0aXZlbHkgcHJvdmlkaW5nIHN1YnNjcmlwdGlvbiBwbGFuCiAgICAgKiBpbmZvcm1hdGlvbiB2aWEge0BsaW5rICNzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQsIExpc3QpfS4KICAgICAqIDxwPgogICAgICogQ29udGFpbnMge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IHRvIGluZGljYXRlIHdoaWNoIHN1YnNjcmlwdGlvbgogICAgICogdGhlIHVzZXIgaXMgaW50ZXJlc3RlZCBpbi4KICAgICAqIDxwPgogICAgICogUmVjZWl2ZXJzIHNob3VsZCBwcm90ZWN0IHRoZW1zZWx2ZXMgYnkgY2hlY2tpbmcgdGhhdCB0aGUgc2VuZGVyIGhvbGRzIHRoZQogICAgICoge0Bjb2RlIGFuZHJvaWQucGVybWlzc2lvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TfSBwZXJtaXNzaW9uLgogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1JFRlJFU0hfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5SRUZSRVNIX1NVQlNDUklQVElPTl9QTEFOUyI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbnMgYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEKICAgICAqIHNwZWNpZmljIHN1YnNjcmliZXIgaGFzIGNoYW5nZWQuCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIGNoYW5nZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTUFOQUdFX1NVQlNDUklQVElPTl9QTEFOUykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TVUJTQ1JJUFRJT05fUExBTlNfQ0hBTkdFRAogICAgICAgICAgICA9ICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uU1VCU0NSSVBUSU9OX1BMQU5TX0NIQU5HRUQiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fREVGQVVMVF9TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gYW5kCiAgICAgKiB7QGxpbmsgI0FDVElPTl9ERUZBVUxUX1NNU19TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gdG8gaW5kaWNhdGUgdGhlIHN1YnNjcmlwdGlvbgogICAgICogd2hpY2ggaGFzIGNoYW5nZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NVQlNDUklQVElPTl9JTkRFWCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TVUJTQ1JJUFRJT05fSU5ERVgiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB0byBzcGVjaWZ5IFNJTSBzbG90IGluZGV4LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TTE9UX0lOREVYID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNMT1RfSU5ERVgiOwoKICAgIC8qKgogICAgICogQSBzb3VyY2Ugb2YgcGhvbmUgbnVtYmVyOiB0aGUgRUYtTVNJU0ROIChzZWUgM0dQUCBUUyAzMS4xMDIpLAogICAgICogb3IgRUYtTUROIGZvciBDRE1BIChzZWUgM0dQUDIgQy5QMDA2NS1CKSwgZnJvbSBVSUNDIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIDxwPlRoZSBhdmFpbGFiaWxpdHkgYW5kIGEgb2YgdGhlIG51bWJlciBkZXBlbmRzIG9uIHRoZSBjYXJyaWVyLgogICAgICogVGhlIG51bWJlciBtYXkgYmUgdXBkYXRlZCBieSBvdmVyLXRoZS1haXIgdXBkYXRlIHRvIFVJQ0MgYXBwbGljYXRpb25zCiAgICAgKiBmcm9tIHRoZSBjYXJyaWVyLCBvciBieSBvdGhlciBtZWFucyB3aXRoIHBoeXNpY2FsIGFjY2VzcyB0byB0aGUgU0lNLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgPSAxOwoKICAgIC8qKgogICAgICogQSBzb3VyY2Ugb2YgcGhvbmUgbnVtYmVyOiBwcm92aWRlZCBieSBhbiBhcHAgdGhhdCBoYXMgY2FycmllciBwcml2aWxlZ2UuCiAgICAgKgogICAgICogPHA+VGhlIG51bWJlciBpcyBpbnRlbmRlZCB0byBiZSBzZXQgYnkgYSBjYXJyaWVyIGFwcCBrbm93aW5nIHRoZSBjb3JyZWN0IG51bWJlcgogICAgICogd2hpY2ggaXMsIGZvciBleGFtcGxlLCBkaWZmZXJlbnQgZnJvbSB0aGUgbnVtYmVyIGluIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9CiAgICAgKiBmb3Igc29tZSByZWFzb24uCiAgICAgKiBUaGUgbnVtYmVyIGlzIG5vdCBhdmFpbGFibGUgdW50aWwgYSBjYXJyaWVyIGFwcCBzZXRzIG9uZSB2aWEKICAgICAqIHtAbGluayAjc2V0Q2FycmllclBob25lTnVtYmVyKGludCwgU3RyaW5nKX0uCiAgICAgKiBUaGUgYXBwIGNhbiB1cGRhdGUgdGhlIG51bWJlciB3aXRoIHRoZSBzYW1lIEFQSSBzaG91bGQgdGhlIG51bWJlciBjaGFuZ2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiA9IDI7CgogICAgLyoqCiAgICAgKiBBIHNvdXJjZSBvZiBwaG9uZSBudW1iZXI6IHByb3ZpZGVkIGJ5IElNUyAoSVAgTXVsdGltZWRpYSBTdWJzeXN0ZW0pIGltcGxlbWVudGF0aW9uLgogICAgICogV2hlbiBJTVMgc2VydmljZSBpcyByZWdpc3RlcmVkIChhcyBpbmRpY2F0ZWQgYnkKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuUmVnaXN0cmF0aW9uTWFuYWdlci5SZWdpc3RyYXRpb25DYWxsYmFjayNvblJlZ2lzdGVyZWQoaW50KX0pCiAgICAgKiB0aGUgSU1TIGltcGxlbWVudGF0aW9uIG1heSByZXR1cm4gUC1Bc3NvY2lhdGVkLVVyaSBTSVAgaGVhZGVycyAoUkZDIDM0NTUpLiBUaGUgVVJJcwogICAgICogYXJlIHRoZSB1c2Vy4oCZcyBwdWJsaWMgdXNlciBpZGVudGl0aWVzIGtub3duIHRvIHRoZSBuZXR3b3JrIChzZWUgM0dQUCBUUyAyNC4yMjkgNS40LjEuMiksCiAgICAgKiBhbmQgdGhlIHBob25lIG51bWJlciBpcyB0eXBpY2FsbHkgb25lIG9mIHRoZW0gKHNlZSDigJxnbG9iYWwgbnVtYmVy4oCdIGluIDNHUFAgVFMgMjMuMDAzIDEzLjQpLgogICAgICoKICAgICAqIDxwPlRoaXMgc291cmNlIHByb3ZpZGVzIHRoZSBwaG9uZSBudW1iZXIgZnJvbSB0aGUgbGFzdCBJTVMgcmVnaXN0cmF0aW9uLgogICAgICogSU1TIHJlZ2lzdHJhdGlvbiBtYXkgaGFwcGVuIG9uIGV2ZXJ5IGRldmljZSByZWJvb3Qgb3Igb3RoZXIgbmV0d29yayBjb25kaXRpb24gY2hhbmdlcy4KICAgICAqIFRoZSBudW1iZXIgd2lsbCBiZSB1cGRhdGVkIHNob3VsZCB0aGUgYXNzb2NpYXRlZCBVUkkgY2hhbmdlIGFmdGVyIGFuIElNUyByZWdpc3RyYXRpb24uCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFBIT05FX05VTUJFUl9TT1VSQ0VfSU1TID0gMzsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJQSE9ORV9OVU1CRVJfU09VUkNFIn0sCiAgICAgICAgICAgIHZhbHVlID0gewogICAgICAgICAgICAgICAgICAgIFBIT05FX05VTUJFUl9TT1VSQ0VfVUlDQywKICAgICAgICAgICAgICAgICAgICBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIsCiAgICAgICAgICAgICAgICAgICAgUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVMsCiAgICAgICAgICAgIH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBQaG9uZU51bWJlclNvdXJjZSB7fQoKICAgIHByaXZhdGUgZmluYWwgQ29udGV4dCBtQ29udGV4dDsKCiAgICAvLyBDYWNoZSBvZiBSZXNvdXJjZSB0aGF0IGhhcyBiZWVuIGNyZWF0ZWQgaW4gZ2V0UmVzb3VyY2VzRm9yU3ViSWQuIEtleSBpcyBhIFBhaXIgY29udGFpbmluZwogICAgLy8gdGhlIENvbnRleHQgYW5kIHN1YklkLgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTWFwPFBhaXI8Q29udGV4dCwgSW50ZWdlcj4sIFJlc291cmNlcz4gc1Jlc291cmNlc0NhY2hlID0KICAgICAgICAgICAgbmV3IENvbmN1cnJlbnRIYXNoTWFwPD4oKTsKCiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgY2xhc3MgZm9yIG1vbml0b3JpbmcgY2hhbmdlcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3Jkcy4KICAgICAqIDxwPgogICAgICogT3ZlcnJpZGUgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIGluIHRoZSBvYmplY3QgdGhhdCBleHRlbmRzIHRoaXMKICAgICAqIGNsYXNzIGFuZCBwYXNzIGl0IHRvIHtAbGluayAjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9CiAgICAgKiB0byByZWdpc3RlciB5b3VyIGxpc3RlbmVyIGFuZCB0byB1bnJlZ2lzdGVyIGludm9rZQogICAgICoge0BsaW5rICNyZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciAjb25TdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciB7CiAgICAgICAgcHJpdmF0ZSBjbGFzcyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyIGV4dGVuZHMgSGFuZGxlciB7CiAgICAgICAgICAgIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lckhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKExvb3BlciBsb29wZXIpIHsKICAgICAgICAgICAgICAgIHN1cGVyKGxvb3Blcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFBvc3RlZCBleGVjdXRvciBjYWxsYmFjayBvbiB0aGUgaGFuZGxlciBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBsb29wZXIuCiAgICAgICAgICogVGhlIGxvb3BlciBjYW4gYmUgdGhlIGNhbGxpbmcgdGhyZWFkJ3MgbG9vcGVyIG9yIHRoZSBsb29wZXIgcGFzc2VkIGZyb20gdGhlCiAgICAgICAgICogY29uc3RydWN0b3Ige0BsaW5rICNPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyKX0uCiAgICAgICAgICovCiAgICAgICAgcHJpdmF0ZSBmaW5hbCBIYW5kbGVyRXhlY3V0b3IgbUV4ZWN1dG9yOwoKICAgICAgICAvKioKICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBIYW5kbGVyRXhlY3V0b3IgZ2V0SGFuZGxlckV4ZWN1dG9yKCkgewogICAgICAgICAgICByZXR1cm4gbUV4ZWN1dG9yOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigpIHsKICAgICAgICAgICAgbUV4ZWN1dG9yID0gbmV3IEhhbmRsZXJFeGVjdXRvcihuZXcgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVySGFuZGxlcigpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEFsbG93IGEgbGlzdGVuZXIgdG8gYmUgY3JlYXRlZCB3aXRoIGEgY3VzdG9tIGxvb3BlcgogICAgICAgICAqIEBwYXJhbSBsb29wZXIgdGhlIGxvb3BlciB0aGF0IHRoZSB1bmRlcmxpbmluZyBoYW5kbGVyIHNob3VsZCBydW4gb24KICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyIGxvb3BlcikgewogICAgICAgICAgICBtRXhlY3V0b3IgPSBuZXcgSGFuZGxlckV4ZWN1dG9yKG5ldyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKGxvb3BlcikpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIHRoZXJlIGlzIGFueSBjaGFuZ2UgdG8gYW55IFN1YnNjcmlwdGlvbkluZm8sIGFzIHdlbGwgYXMgb25jZSBvbgogICAgICAgICAqIHJlZ2lzdGVyaW5nIGZvciBjaGFuZ2VzIHdpdGgge0BsaW5rICNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9LiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAoREJHKSBsb2coIm9uU3Vic2NyaXB0aW9uc0NoYW5nZWQ6IE5PVCBPVkVSUklEREVOIik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBpbnZva2VkIHdoZW4ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAqIEV4ZWN1dG9yLCBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBvcgogICAgICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgKiBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBmYWlscyB0byBjb21wbGV0ZSBkdWUgdG8gdGhlCiAgICAgICAgICoge0BsaW5rIENvbnRleHQjVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0V9IGJlaW5nIHVuYXZhaWxhYmxlLgogICAgICAgICAqIEBoaWRlCiAgICAgICAgICovCiAgICAgICAgcHVibGljIHZvaWQgb25BZGRMaXN0ZW5lckZhaWxlZCgpIHsKICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJvbkFkZExpc3RlbmVyRmFpbGVkIG5vdCBvdmVycmlkZGVuIik7CiAgICAgICAgfQoKICAgICAgICBwcml2YXRlIHZvaWQgbG9nKFN0cmluZyBzKSB7CiAgICAgICAgICAgIFJsb2cuZChMT0dfVEFHLCBzKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN1YnNjcmlwdGlvbk1hbmFnZXIoQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgaWYgKERCRykgbG9nZCgiU3Vic2NyaXB0aW9uTWFuYWdlciBjcmVhdGVkIik7CiAgICAgICAgbUNvbnRleHQgPSBjb250ZXh0OwogICAgfQoKICAgIHByaXZhdGUgTmV0d29ya1BvbGljeU1hbmFnZXIgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKSB7CiAgICAgICAgcmV0dXJuIChOZXR3b3JrUG9saWN5TWFuYWdlcikgbUNvbnRleHQKICAgICAgICAgICAgICAgIC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuTkVUV09SS19QT0xJQ1lfU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBkZXZlbG9wZXJzIHNob3VsZCBhbHdheXMgb2J0YWluIHJlZmVyZW5jZXMgZGlyZWN0bHkgZnJvbQogICAgICogICAgICAgICAgICAge0BsaW5rIENvbnRleHQjZ2V0U3lzdGVtU2VydmljZShDbGFzcyl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHN0YXRpYyBTdWJzY3JpcHRpb25NYW5hZ2VyIGZyb20oQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIChTdWJzY3JpcHRpb25NYW5hZ2VyKSBjb250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9TVUJTQ1JJUFRJT05fU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBhY3RpdmUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgb3IgdG8gdGhlCiAgICAgKiBpbmRpdmlkdWFsIHJlY29yZHMgdGhlbXNlbHZlcy4gV2hlbiBhIGNoYW5nZSBvY2N1cnMgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIG9mCiAgICAgKiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBpbnZva2VkIGltbWVkaWF0ZWx5IGlmIHRoZXJlIGhhcyBiZWVuIGEgbm90aWZpY2F0aW9uLiBUaGUKICAgICAqIG9uU3Vic2NyaXB0aW9uQ2hhbmdlZCBtZXRob2Qgd2lsbCBhbHNvIGJlIHRyaWdnZXJlZCBvbmNlIGluaXRpYWxseSB3aGVuIGNhbGxpbmcgdGhpcwogICAgICogZnVuY3Rpb24uIFRoZSBjYWxsYmFjayB3aWxsIGJlIGludm9rZWQgb24gdGhlIGxvb3BlciBzcGVjaWZpZWQgaW4gdGhlIGxpc3RlbmVyJ3MgY29uc3RydWN0b3IuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG92ZXJyaWRkZW4uCiAgICAgKgogICAgICogQGRlcHJlY2F0ZWQgV2lsbCBnZXQgZXhjZXB0aW9uIGlmIHRoZSBwYXJhbWV0ZXIgbGlzdGVuZXIgaXMgbm90IGluaXRpYWxpemVkIHdpdGggYSBMb29wZXIuCiAgICAgKiBVc2Uge0BsaW5rICNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoRXhlY3V0b3IsIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHZvaWQgYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIGlmIChsaXN0ZW5lciA9PSBudWxsKSByZXR1cm47CiAgICAgICAgYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyLm1FeGVjdXRvciwgbGlzdGVuZXIpOwogICAgfQoKICAgIC8qKgogICAgICogUmVnaXN0ZXIgZm9yIGNoYW5nZXMgdG8gdGhlIGxpc3Qgb2YgYWN0aXZlIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIG9yIHRvIHRoZQogICAgICogaW5kaXZpZHVhbCByZWNvcmRzIHRoZW1zZWx2ZXMuIFdoZW4gYSBjaGFuZ2Ugb2NjdXJzIHRoZSBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG1ldGhvZCBvZgogICAgICogdGhlIGxpc3RlbmVyIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBpZiB0aGVyZSBoYXMgYmVlbiBhIG5vdGlmaWNhdGlvbi4gVGhlCiAgICAgKiBvblN1YnNjcmlwdGlvbkNoYW5nZWQgbWV0aG9kIHdpbGwgYWxzbyBiZSB0cmlnZ2VyZWQgb25jZSBpbml0aWFsbHkgd2hlbiBjYWxsaW5nIHRoaXMKICAgICAqIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lciBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB3aXRoCiAgICAgKiAgICAgICAgICAgICAgICAgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICogQHBhcmFtIGV4ZWN1dG9yIHRoZSBleGVjdXRvciB0aGF0IHdpbGwgZXhlY3V0ZSBjYWxsYmFja3MuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIGFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgQE5vbk51bGwgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsCiAgICAgICAgICAgIEBOb25OdWxsIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIFN0cmluZyBwa2dOYW1lID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgicmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2UgdXNlIHRoZSBUZWxlcGhvbnlSZWdpc3RyeSBhcyBpdCBydW5zIGluIHRoZSBzeXN0ZW0gYW5kIHRodXMgaXMgYWx3YXlzCiAgICAgICAgLy8gYXZhaWxhYmxlLiBXaGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIuYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgIGV4ZWN1dG9yKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0aGUgdGVsZXBob255IHJlZ2lzdHJ5IGlzbid0IGF2YWlsYWJsZSwgd2Ugd2lsbCBpbmZvcm0gdGhlIGNhbGxlciBvbiB0aGVpcgogICAgICAgICAgICAvLyBsaXN0ZW5lciB0aGF0IGl0IGZhaWxlZCBzbyB0aGV5IGNhbiB0cnkgdG8gcmUtcmVnaXN0ZXIuCiAgICAgICAgICAgIGxvZ2UoImFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcjogcGtnbmFtZT0iICsgcGtnTmFtZSArICIgZmFpbGVkIHRvIGJlIGFkZGVkICIKICAgICAgICAgICAgICAgICAgICArICIgZHVlIHRvIFRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFIGJlaW5nIHVuYXZhaWxhYmxlLiIpOwogICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IGxpc3RlbmVyLm9uQWRkTGlzdGVuZXJGYWlsZWQoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVW5yZWdpc3RlciB0aGUge0BsaW5rIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0uIFRoaXMgaXMgbm90IHN0cmljdGx5IG5lY2Vzc2FyeQogICAgICogYXMgdGhlIGxpc3RlbmVyIHdpbGwgYXV0b21hdGljYWxseSBiZSB1bnJlZ2lzdGVyZWQgaWYgYW4gYXR0ZW1wdCB0byBpbnZva2UgdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkgcmV0dXJuOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInVucmVnaXN0ZXIgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIgKyBwa2dGb3JEZWJ1ZwogICAgICAgICAgICAgICAgICAgICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICAvLyBXZSB1c2UgdGhlIFRlbGVwaG9ueVJlZ2lzdHJ5IGFzIGl0IHJ1bnMgaW4gdGhlIHN5c3RlbSBhbmQgdGh1cyBpcyBhbHdheXMKICAgICAgICAvLyBhdmFpbGFibGUgd2hlcmUgYXMgU3Vic2NyaXB0aW9uQ29udHJvbGxlciBjb3VsZCBjcmFzaCBhbmQgbm90IGJlIGF2YWlsYWJsZQogICAgICAgIFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgPSAoVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyKQogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLnJlbW92ZU9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQSBsaXN0ZW5lciBjbGFzcyBmb3IgbW9uaXRvcmluZyBjaGFuZ2VzIHRvIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIG9mIG9wcG9ydHVuaXN0aWMKICAgICAqIHN1YnNjcmlwdGlvbnMuCiAgICAgKiA8cD4KICAgICAqIE92ZXJyaWRlIHRoZSBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCBtZXRob2QgaW4gdGhlIG9iamVjdCB0aGF0IGV4dGVuZHMgdGhpcwogICAgICogb3Ige0BsaW5rICNhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICogRXhlY3V0b3IsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogdG8gcmVnaXN0ZXIgeW91ciBsaXN0ZW5lciBhbmQgdG8gdW5yZWdpc3RlciBpbnZva2UKICAgICAqIHtAbGluayAjcmVtb3ZlT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAqIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfQogICAgICogPHA+CiAgICAgKiBQZXJtaXNzaW9ucyBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgewogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhbnkgY2hhbmdlIHRvIGFueSBTdWJzY3JpcHRpb25JbmZvLiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCgpIHsKICAgICAgICAgICAgaWYgKERCRykgbG9nKCJvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZDogTk9UIE9WRVJSSURERU4iKTsKICAgICAgICB9CgogICAgICAgIHByaXZhdGUgdm9pZCBsb2coU3RyaW5nIHMpIHsKICAgICAgICAgICAgUmxvZy5kKExPR19UQUcsIHMpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIGZvciBjaGFuZ2VzIHRvIHRoZSBsaXN0IG9mIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHJlY29yZHMgb3IgdG8gdGhlCiAgICAgKiBpbmRpdmlkdWFsIHJlY29yZHMgdGhlbXNlbHZlcy4gV2hlbiBhIGNoYW5nZSBvY2N1cnMgdGhlIG9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkCiAgICAgKiBtZXRob2Qgb2YgdGhlIGxpc3RlbmVyIHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBpZiB0aGVyZSBoYXMgYmVlbiBhIG5vdGlmaWNhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZCBvdmVycmlkZGVuLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAgICBATm9uTnVsbCBAQ2FsbGJhY2tFeGVjdXRvciBFeGVjdXRvciBleGVjdXRvciwKICAgICAgICAgICAgQE5vbk51bGwgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBsaXN0ZW5lcikgewogICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGxpc3RlbmVyID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgU3RyaW5nIHBrZ05hbWUgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICBsb2dkKCJyZWdpc3RlciBhZGRPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ05hbWU9IiArIHBrZ05hbWUKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CgogICAgICAgIC8vIFdlIHVzZSB0aGUgVGVsZXBob255UmVnaXN0cnkgYXMgaXQgcnVucyBpbiB0aGUgc3lzdGVtIGFuZCB0aHVzIGlzIGFsd2F5cwogICAgICAgIC8vIGF2YWlsYWJsZSB3aGVyZSBhcyBTdWJzY3JpcHRpb25Db250cm9sbGVyIGNvdWxkIGNyYXNoIGFuZCBub3QgYmUgYXZhaWxhYmxlCiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIuYWRkT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciwgZXhlY3V0b3IpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVucmVnaXN0ZXIgdGhlIHtAbGluayBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB0aGF0IGlzIGN1cnJlbnRseQogICAgICogbGlzdGVuaW5nIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBjaGFuZ2UuIFRoaXMgaXMgbm90IHN0cmljdGx5IG5lY2Vzc2FyeQogICAgICogYXMgdGhlIGxpc3RlbmVyIHdpbGwgYXV0b21hdGljYWxseSBiZSB1bnJlZ2lzdGVyZWQgaWYgYW4gYXR0ZW1wdCB0byBpbnZva2UgdGhlIGxpc3RlbmVyCiAgICAgKiBmYWlscy4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgdGhhdCBpcyB0byBiZSB1bnJlZ2lzdGVyZWQuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZU9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgIEBOb25OdWxsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChsaXN0ZW5lciwgImxpc3RlbmVyIGNhbm5vdCBiZSBudWxsIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgidW5yZWdpc3RlciBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHBrZ0ZvckRlYnVnPSIKICAgICAgICAgICAgICAgICAgICArIHBrZ0ZvckRlYnVnICsgIiBsaXN0ZW5lcj0iICsgbGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICBUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyID0gKFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlcikKICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSk7CiAgICAgICAgaWYgKHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciAhPSBudWxsKSB7CiAgICAgICAgICAgIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlci5yZW1vdmVPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKGxpc3RlbmVyKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFjdGl2ZSBTdWJzY3JpcHRpb25JbmZvIHdpdGggdGhlIGlucHV0IHN1YklkLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8ga2V5IGluIGRhdGFiYXNlLgogICAgICogQHJldHVybiBTdWJzY3JpcHRpb25JbmZvLCBtYXliZSBudWxsIGlmIGl0cyBub3QgYWN0aXZlLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oaW50IHN1YklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvXSsgc3ViSWQ9IiArIHN1YklkKTsKICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkpIHsKICAgICAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICAgICAgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9dLSBpbnZhbGlkIHN1YklkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBTdWJzY3JpcHRpb25JbmZvIHN1YkluZm8gPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSW5mbyA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJbmZvOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhbiBhY3RpdmUgU3Vic2NyaXB0aW9uSW5mbyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gYXNzb2NpYXRlZCB3aXRoIHRoZSBTaW0gSWNjSWQuCiAgICAgKgogICAgICogQHBhcmFtIGljY0lkIHRoZSBJY2NJZCBvZiBTSU0gY2FyZAogICAgICogQHJldHVybiBTdWJzY3JpcHRpb25JbmZvLCBtYXliZSBudWxsIGlmIGl0cyBub3QgYWN0aXZlCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgQE51bGxhYmxlCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9ySWNjKEBOb25OdWxsIFN0cmluZyBpY2NJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0luZGV4XSsgaWNjSWQ9IiArIGljY0lkKTsKICAgICAgICBpZiAoaWNjSWQgPT0gbnVsbCkgewogICAgICAgICAgICBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0luZGV4XS0gbnVsbCBpY2NpZCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIFN1YnNjcmlwdGlvbkluZm8gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljY0lkKGljY0lkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgYWN0aXZlIFN1YnNjcmlwdGlvbkluZm8gYXNzb2NpYXRlZCB3aXRoIHRoZSBzbG90SW5kZXgKICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBzdWJzY3JpcHRpb24gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gU3Vic2NyaXB0aW9uSW5mbywgbWF5YmUgbnVsbCBpZiBpdHMgbm90IGFjdGl2ZQogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JTaW1TbG90SW5kZXgoaW50IHNsb3RJbmRleCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleF0rIHNsb3RJbmRleD0iICsgc2xvdEluZGV4KTsKICAgICAgICBpZiAoIWlzVmFsaWRTbG90SW5kZXgoc2xvdEluZGV4KSkgewogICAgICAgICAgICBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleF0tIGludmFsaWQgc2xvdEluZGV4Iik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3Vic2NyaXB0aW9uSW5mbyByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9yU2ltU2xvdEluZGV4KHNsb3RJbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIExpc3Qgb2YgYWxsIFN1YnNjcmlwdGlvbkluZm8gcmVjb3JkcyBpbiBkYXRhYmFzZSwKICAgICAqIGluY2x1ZGUgdGhvc2UgdGhhdCB3ZXJlIGluc2VydGVkIGJlZm9yZSwgbWF5YmUgZW1wdHkgYnV0IG5vdCBudWxsLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBbGxTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW2dldEFsbFN1YnNjcmlwdGlvbkluZm9MaXN0XSsiKTsKCiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBbGxTdWJJbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4gVGhlIHJlY29yZHMgd2lsbCBiZSBzb3J0ZWQKICAgICAqIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuIEluIHRoZSBsYXR0ZXIgY2FzZSwgb25seSByZWNvcmRzIGFjY2Vzc2libGUKICAgICAqIHRvIHRoZSBjYWxsaW5nIGFwcCBhcmUgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHJldHVybiBTb3J0ZWQgbGlzdCBvZiB0aGUgY3VycmVudGx5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGF2YWlsYWJsZSBvbiB0aGUgZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9CiAgICAgKiBoYXMgYmVlbiByZWdpc3RlcmVkIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZQogICAgICogaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPC9saT4KICAgICAqIDxsaT4KICAgICAqIElmIHRoZSBsaXN0IGlzIGVtcHR5IHRoZW4gdGhlcmUgYXJlIG5vIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiA8L2xpPgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvbGk+CiAgICAgKiA8L3VsPgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgvKiB1c2VyVmlzaWJsZW9ubHkgKi90cnVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBib3RoIGhpZGRlbiBhbmQgdmlzaWJsZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqIFRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0KICAgICAqIHRoZW4gYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEhpZGRlbiBzdWJzY3JpcHRpb25zIHJlZmVyIHRvIHRob3NlIGFyZSBub3QgbWVhbnQgdmlzaWJsZSB0byB0aGUgdXNlcnMuCiAgICAgKiBGb3IgZXhhbXBsZSwgYW4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gdGhhdCBpcyBncm91cGVkIHdpdGggb3RoZXIKICAgICAqIHN1YnNjcmlwdGlvbnMgc2hvdWxkIHJlbWFpbiBpbnZpc2libGUgdG8gdXNlcnMgYXMgdGhleSBhcmUgb25seSBmdW5jdGlvbmFsbHkKICAgICAqIHN1cHBsZW1lbnRhcnkgdG8gcHJpbWFyeSBvbmVzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIG9ubHkgcmVjb3JkcyBhY2Nlc3NpYmxlCiAgICAgKiB0byB0aGUgY2FsbGluZyBhcHAgYXJlIHJldHVybmVkLgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnRseSBhdmFpbGFibGUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99CiAgICAgKiByZWNvcmRzIG9uIHRoZSBkZXZpY2UuCiAgICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gZXhjZXB0IHRoYXQgaXQgd2lsbCByZXR1cm4KICAgICAqIGJvdGggYWN0aXZlIGFuZCBoaWRkZW4gU3Vic2NyaXB0aW9uSW5mb3MuCiAgICAgKgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gY29tcGxldGVMaXN0ID0gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoCiAgICAgICAgICAgICAgICAvKiB1c2VyVmlzaWJsZW9ubHkgKi9mYWxzZSk7CiAgICAgICAgaWYgKGNvbXBsZXRlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBsZXRlTGlzdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcGxldGVMaXN0OwogICAgfQoKICAgIC8qKgogICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgpfSwgYnV0IGlmIHVzZXJWaXNpYmxlT25seQogICAgKiBpcyB0cnVlLCBpdCB3aWxsIGZpbHRlciBvdXQgdGhlIGhpZGRlbiBzdWJzY3JpcHRpb25zLgogICAgKgogICAgKiBAaGlkZQogICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChib29sZWFuIHVzZXJWaXNpYmxlT25seSkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gYWN0aXZlTGlzdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVMaXN0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKCF1c2VyVmlzaWJsZU9ubHkgfHwgYWN0aXZlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0LnN0cmVhbSgpLmZpbHRlcihzdWJJbmZvIC0+IGlzU3Vic2NyaXB0aW9uVmlzaWJsZShzdWJJbmZvKSkKICAgICAgICAgICAgICAgICAgICAuY29sbGVjdChDb2xsZWN0b3JzLnRvTGlzdCgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIGFsbCBhdmFpbGFibGUgc3Vic2NyaXB0aW9ucywgaWYgYW55LgogICAgICoKICAgICAqIDxwPkF2YWlsYWJsZSBzdWJzY3JpcHRpb25zIGluY2x1ZGUgYWN0aXZlIG9uZXMgKHRob3NlIHdpdGggYSBub24tbmVnYXRpdmUKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleCgpfSkgYXMgd2VsbCBhcyBpbmFjdGl2ZSBidXQgaW5zdGFsbGVkIGVtYmVkZGVkCiAgICAgKiBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSBoYXMgYmVlbiByZWdpc3RlcmVkCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyI29uU3Vic2NyaXB0aW9uc0NoYW5nZWR9IHdpbGwgYmUgaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPGxpPgogICAgICogSWYgdGhlIGxpc3QgaXMgZW1wdHkgdGhlbiB0aGVyZSBhcmUgbm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIDxsaT4KICAgICAqIGlmIHRoZSBsaXN0IGlzIG5vbi1lbXB0eSB0aGUgbGlzdCBpcyBzb3J0ZWQgYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fQogICAgICogdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNnZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdCB0byBiZSBpbnZva2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgU3Vic2NyaXB0aW9uSW5mbyhzKSBvZiBhbGwgZW1iZWRkZWQgc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsaW5nIGFwcCwgaWYKICAgICAqIGFueS4KICAgICAqCiAgICAgKiA8cD5Pbmx5IHRob3NlIHN1YnNjcmlwdGlvbnMgZm9yIHdoaWNoIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIHBlciB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBtZXRhZGF0YSwgaWYgYW55LCB3aWxsIGJlIGluY2x1ZGVkIGluIHRoZSByZXR1cm5lZCBsaXN0LgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQgZW1iZWRkZWQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlIHdoaWNoIGFyZSBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKiA8dWw+CiAgICAgKiA8bGk+CiAgICAgKiBJZiBudWxsIGlzIHJldHVybmVkIHRoZSBjdXJyZW50IHN0YXRlIGlzIHVua25vd24gYnV0IGlmIGEKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IGhhcyBiZWVuIHJlZ2lzdGVyZWQKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZSBpbnZva2VkIGluIHRoZSBmdXR1cmUuCiAgICAgKiA8bGk+CiAgICAgKiBJZiB0aGUgbGlzdCBpcyBlbXB0eSB0aGVuIHRoZXJlIGFyZSBubyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcyBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvdWw+CiAgICAgKi8KICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHJlc3VsdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIHJlZnJlc2ggb2YgdGhlIHBsYXRmb3JtIGNhY2hlIG9mIHByb2ZpbGUgaW5mb3JtYXRpb24gZm9yIHRoZSBlVUlDQyB3aGljaAogICAgICogY29ycmVzcG9uZHMgdG8gdGhlIGNhcmQgSUQgcmV0dXJuZWQgYnkge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaCgpIHsKICAgICAgICBpbnQgY2FyZElkID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KS5nZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5yZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdFJlZnJlc2goY2FyZElkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dkKCJyZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdEZyZXNoIGZvciBjYXJkID0gIiArIGNhcmRJZCArICIgZmFpbGVkLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBwbGF0Zm9ybSBjYWNoZSBvZiBwcm9maWxlIGluZm9ybWF0aW9uIGZvciB0aGUgZVVJQ0Mgd2l0aCB0aGUgZ2l2ZW4KICAgICAqIHtAY29kZSBjYXJkSWR9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBwYXJhbSBjYXJkSWQgdGhlIGNhcmQgSUQgb2YgdGhlIGVVSUNDLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaChpbnQgY2FyZElkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIucmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RSZWZyZXNoKGNhcmRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZCgicmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RGcmVzaCBmb3IgY2FyZCA9ICIgKyBjYXJkSWQgKyAiIGZhaWxlZC4iKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRoZSBjb3VudCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZGF0YWJhc2UsIHRoaXMgaW5jbHVkZXMKICAgICAqIGFsbCBzdWJzY3JpcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNlZW4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnRdKyIpOwoKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWxsU3ViSW5mb0NvdW50KG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIHRoZSBjb3VudCB3aWxsIGluY2x1ZGUKICAgICAqIG9ubHkgdGhvc2Ugc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgY3VycmVudCBudW1iZXIgb2YgYWN0aXZlIHN1YnNjcmlwdGlvbnMuIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGUgdmFsdWUKICAgICAqIHJldHVybmVkIGJ5IHRoaXMgbWV0aG9kIHdpbGwgYmUgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aCBvZiB0aGUgbGlzdCByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0uCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaW50IHJlc3VsdCA9IDA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjdGl2ZVN1YkluZm9Db3VudChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdGhlIG1heGltdW0gbnVtYmVyIG9mIGFjdGl2ZSBzdWJzY3JpcHRpb25zIHRoYXQgd2lsbCBiZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gYW5kIHRoZSB2YWx1ZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnR9LgogICAgICovCiAgICBwdWJsaWMgaW50IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Db3VudE1heCgpIHsKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3ViSW5mb0NvdW50TWF4KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSBpY2NJZCB0aGUgSWNjSWQgb2YgdGhlIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBTSU0gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gdGhlIFVSTCBvZiB0aGUgbmV3bHkgY3JlYXRlZCByb3cgb3IgdGhlIHVwZGF0ZWQgcm93CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgVXJpIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIGljY0lkLCBpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgaWNjSWQ6IiArIGljY0lkICsgIiBzbG90SW5kZXg6IiArIHNsb3RJbmRleCk7CiAgICAgICAgaWYgKGljY0lkID09IG51bGwpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBudWxsIGljY0lkIik7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gaW52YWxpZCBzbG90SW5kZXgiKTsKICAgICAgICB9CgogICAgICAgIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoaWNjSWQsIG51bGwsIHNsb3RJbmRleCwgU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNKTsKCiAgICAgICAgLy8gRklYTUU6IEFsd2F5cyByZXR1cm5zIG51bGw/CiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgc3BlY2lmaWMgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gZGlzcGxheU5hbWUgaHVtYW4tcmVhZGFibGUgbmFtZSBvZiB0aGUgZGV2aWNlIHRoZSBzdWJzY3JpcHRpb24gY29ycmVzcG9uZHMgdG8uCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IGFzc2lnbmVkIHRvIHRoaXMgc3Vic2NyaXB0aW9uLiBJdCBpcyBpZ25vcmVkIGZvciBzdWJzY3JpcHRpb25UeXBlCiAgICAgKiAgICAgICAgICAgICAgICAgIG9mIHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTX0uCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkoY2xpZW50ID0gU3lzdGVtQXBpLkNsaWVudC5NT0RVTEVfTElCUkFSSUVTKQogICAgcHVibGljIHZvaWQgYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZChATm9uTnVsbCBTdHJpbmcgdW5pcXVlSWQsIEBOdWxsYWJsZSBTdHJpbmcgZGlzcGxheU5hbWUsCiAgICAgICAgICAgIGludCBzbG90SW5kZXgsIEBTdWJzY3JpcHRpb25UeXBlIGludCBzdWJzY3JpcHRpb25UeXBlKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdKyB1bmlxdWVJZDoiICsgdW5pcXVlSWQKICAgICAgICAgICAgICAgICAgICArICIsIGRpc3BsYXlOYW1lOiIgKyBkaXNwbGF5TmFtZSArICIsIHNsb3RJbmRleDoiICsgc2xvdEluZGV4CiAgICAgICAgICAgICAgICAgICAgKyAiLCBzdWJzY3JpcHRpb25UeXBlOiAiICsgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmICh1bmlxdWVJZCA9PSBudWxsKSB7CiAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIHVuaXF1ZUlkIGlzIG51bGwiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViID09IG51bGwpIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIElTdWIgc2VydmljZSBpcyBudWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IHJlc3VsdCA9IGlTdWIuYWRkU3ViSW5mbyh1bmlxdWVJZCwgZGlzcGxheU5hbWUsIHNsb3RJbmRleCwgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPCAwKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiQWRkaW5nIG9mIHN1YnNjcmlwdGlvbiBkaWRuJ3Qgc3VjY2VlZDogZXJyb3IgPSAiICsgcmVzdWx0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZ2QoInN1Y2Nlc3NmdWxseSBhZGRlZCBuZXcgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIFN1YnNjcmlwdGlvbkluZm8gcmVjb3JkIGZyb20gdGhlIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlIHNwZWNpZmljCiAgICAgKiAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkoY2xpZW50ID0gU3lzdGVtQXBpLkNsaWVudC5NT0RVTEVfTElCUkFSSUVTKQogICAgcHVibGljIHZvaWQgcmVtb3ZlU3Vic2NyaXB0aW9uSW5mb1JlY29yZChATm9uTnVsbCBTdHJpbmcgdW5pcXVlSWQsCiAgICAgICAgICAgIEBTdWJzY3JpcHRpb25UeXBlIGludCBzdWJzY3JpcHRpb25UeXBlKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW3JlbW92ZVN1YnNjcmlwdGlvbkluZm9SZWNvcmRdKyB1bmlxdWVJZDoiICsgdW5pcXVlSWQKICAgICAgICAgICAgICAgICAgICArICIsIHN1YnNjcmlwdGlvblR5cGU6ICIgKyBzdWJzY3JpcHRpb25UeXBlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHVuaXF1ZUlkID09IG51bGwpIHsKICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gdW5pcXVlSWQgaXMgbnVsbCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgTG9nLmUoTE9HX1RBRywgIltyZW1vdmVTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gSVN1YiBzZXJ2aWNlIGlzIG51bGwiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgcmVzdWx0ID0gaVN1Yi5yZW1vdmVTdWJJbmZvKHVuaXF1ZUlkLCBzdWJzY3JpcHRpb25UeXBlKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA8IDApIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJSZW1vdmFsIG9mIHN1YnNjcmlwdGlvbiBkaWRuJ3Qgc3VjY2VlZDogZXJyb3IgPSAiICsgcmVzdWx0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZ2QoInN1Y2Nlc3NmdWxseSByZW1vdmVkIHN1YnNjcmlwdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldCBTSU0gaWNvbiB0aW50IGNvbG9yIGZvciBzdWJzY3JpcHRpb24gSUQKICAgICAqIEBwYXJhbSB0aW50IHRoZSBSR0IgdmFsdWUgb2YgaWNvbiB0aW50IGNvbG9yIG9mIHRoZSBTSU0KICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgdW5pcXVlIFN1YnNjcml0cGlvbiBJRCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgc2V0SWNvblRpbnQoQENvbG9ySW50IGludCB0aW50LCBpbnQgc3ViSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW3NldEljb25UaW50XSsgdGludDoiICsgdGludCArICIgc3ViSWQ6IiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3ViSWQsICJzZXRJY29uVGludCIsCiAgICAgICAgICAgICAgICAoaVN1YiktPiBpU3ViLnNldEljb25UaW50KHRpbnQsIHN1YklkKQogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGRpc3BsYXkgbmFtZSBmb3IgYSBzdWJzY3JpcHRpb24gSUQKICAgICAqIEBwYXJhbSBkaXNwbGF5TmFtZSB0aGUgZGlzcGxheSBuYW1lIG9mIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpdHBpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBuYW1lU291cmNlIFNJTSBkaXNwbGF5IG5hbWUgc291cmNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkIG9yIDwgMCBpZiBpbnZhbGlkIHN1YklkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBzZXREaXNwbGF5TmFtZShATnVsbGFibGUgU3RyaW5nIGRpc3BsYXlOYW1lLCBpbnQgc3ViSWQsCiAgICAgICAgICAgIEBTaW1EaXNwbGF5TmFtZVNvdXJjZSBpbnQgbmFtZVNvdXJjZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREaXNwbGF5TmFtZV0rICBkaXNwbGF5TmFtZToiICsgZGlzcGxheU5hbWUgKyAiIHN1YklkOiIgKyBzdWJJZAogICAgICAgICAgICAgICAgICAgICsgIiBuYW1lU291cmNlOiIgKyBuYW1lU291cmNlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0RGlzcGxheU5hbWUiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXREaXNwbGF5TmFtZVVzaW5nU3JjKGRpc3BsYXlOYW1lLCBzdWJJZCwgbmFtZVNvdXJjZSkKICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHBob25lIG51bWJlciBieSBzdWJJZAogICAgICogQHBhcmFtIG51bWJlciB0aGUgcGhvbmUgbnVtYmVyIG9mIHRoZSBTSU0KICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8gaW5kZXggaW4gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gdGhlIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgaW50IHNldERpc3BsYXlOdW1iZXIoU3RyaW5nIG51bWJlciwgaW50IHN1YklkKSB7CiAgICAgICAgaWYgKG51bWJlciA9PSBudWxsKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREaXNwbGF5TnVtYmVyXS0gZmFpbCIpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERpc3BsYXlOdW1iZXIiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXREaXNwbGF5TnVtYmVyKG51bWJlciwgc3ViSWQpCiAgICAgICAgKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBkYXRhIHJvYW1pbmcgYnkgc2ltSW5mbyBpbmRleAogICAgICogQHBhcmFtIHJvYW1pbmcgMDpEb24ndCBhbGxvdyBkYXRhIHdoZW4gcm9hbWluZywgMTpBbGxvdyBkYXRhIHdoZW4gcm9hbWluZwogICAgICogQHBhcmFtIHN1YklkIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBpbnQgc2V0RGF0YVJvYW1pbmcoaW50IHJvYW1pbmcsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbc2V0RGF0YVJvYW1pbmddKyByb2FtaW5nOiIgKyByb2FtaW5nICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERhdGFSb2FtaW5nIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREYXRhUm9hbWluZyhyb2FtaW5nLCBzdWJJZCkKICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHNsb3RJbmRleCBhc3NvY2lhdGVkIHdpdGggdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHNsb3RJbmRleCBhcyBhIHBvc2l0aXZlIGludGVnZXIgb3Ige0BsaW5rICNJTlZBTElEX1NJTV9TTE9UX0lOREVYfSBpZiB0aGUgc3VwcGxpZWQKICAgICAqIHN1YnNjcmlwdGlvbklkIGRvZXNuJ3QgaGF2ZSBhbiBhc3NvY2lhdGVkIHNsb3QgaW5kZXguCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldFNsb3RJbmRleChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gc1Nsb3RJbmRleENhY2hlLnF1ZXJ5KHN1YnNjcmlwdGlvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBhbiBhcnJheSBvZiBTdWJzY3JpcHRpb24gSWRzIGZvciBzcGVjaWZpZWQgc2xvdCBJbmRleC4KICAgICAqIEBwYXJhbSBzbG90SW5kZXggdGhlIHNsb3QgaW5kZXguCiAgICAgKiBAcmV0dXJuIHN1YnNjcmlwdGlvbiBJZHMgb3IgbnVsbCBpZiB0aGUgZ2l2ZW4gc2xvdCBJbmRleCBpcyBub3QgdmFsaWQgb3IgdGhlcmUgYXJlIG5vIGFjdGl2ZQogICAgICogc3Vic2NyaXB0aW9ucyBpbiB0aGUgc2xvdC4KICAgICAqLwogICAgQE51bGxhYmxlCiAgICBwdWJsaWMgaW50W10gZ2V0U3Vic2NyaXB0aW9uSWRzKGludCBzbG90SW5kZXgpIHsKICAgICAgICByZXR1cm4gZ2V0U3ViSWQoc2xvdEluZGV4KTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGludFtdIGdldFN1YklkKGludCBzbG90SW5kZXgpIHsKICAgICAgICBpZiAoIWlzVmFsaWRTbG90SW5kZXgoc2xvdEluZGV4KSkgewogICAgICAgICAgICBsb2dkKCJbZ2V0U3ViSWRdLSBmYWlsIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaW50W10gc3ViSWQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSWQgPSBpU3ViLmdldFN1YklkKHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3ViSWQ7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRQaG9uZUlkKGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBzUGhvbmVJZENhY2hlLnF1ZXJ5KHN1YklkKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIGxvZ2QoU3RyaW5nIG1zZykgewogICAgICAgIFJsb2cuZChMT0dfVEFHLCBtc2cpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgbG9nZShTdHJpbmcgbXNnKSB7CiAgICAgICAgUmxvZy5lKExPR19UQUcsIG1zZyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBGb3IgYSB2b2ljZSBjYXBhYmxlIGRldmljZSwgaXQgd2lsbCByZXR1cm4gZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQuCiAgICAgKiBGb3IgYSBkYXRhIG9ubHkgZGV2aWNlLCBpdCB3aWxsIHJldHVybiB0aGUgZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZC4KICAgICAqIE1heSByZXR1cm4gYW4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgb24gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgInN5c3RlbSIgZGVmYXVsdCBzdWJzY3JpcHRpb24gaWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHRTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSBkYXRhIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbiBJZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoKSB7CiAgICAgICAgaW50IHN1YklkID0gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdWJJZCA9IGlTdWIuZ2V0RGVmYXVsdFZvaWNlU3ViSWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmIChWREJHKSBsb2dkKCJnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCwgc3ViIGlkID0gIiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc3ViSWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBPbiBhIGRhdGEtb25seSBkZXZpY2UsIHRoaXMgaXMgYSBuby1vcC4KICAgICAqCiAgICAgKiBNYXkgdGhyb3cgYSB7QGxpbmsgUnVudGltZUV4Y2VwdGlvbn0gaWYgdGhlIHByb3ZpZGVkIHN1YnNjcmlwdGlvbiBpZCBpcyBlcXVhbCB0bwogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9CiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIEEgdmFsaWQgc3Vic2NyaXB0aW9uIElEIHRvIHNldCBhcyB0aGUgc3lzdGVtIGRlZmF1bHQsIG9yCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUR9CiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInNldERlZmF1bHRWb2ljZVN1YklkIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdFZvaWNlU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNhbWUgYXMge0BsaW5rICNzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChpbnQpfSwgYnV0IHByZXNlcnZlZCBmb3IgYmFja3dhcmRzCiAgICAgKiBjb21wYXRpYmlsaXR5LgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFZvaWNlU3ViSWQoaW50IHN1YklkKSB7CiAgICAgICAgc2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBXaWxsIHJldHVybiBudWxsIG9uIGRhdGEgb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlIsIHRyYWNraW5nQnVnID0gMTcwNzI5NTUzKQogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSW5mbygpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0Vm9pY2VQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uIGlkLgogICAgICoKICAgICAqIE9uIGEgZGF0YSBvbmx5IGRldmljZSBvciBvbiBlcnJvciwgd2lsbCByZXR1cm4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uIElkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKSB7CiAgICAgICAgcmV0dXJuIHNEZWZhdWx0U21zU3ViSWRDYWNoZS5xdWVyeShudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgc3Vic2NyaXB0aW9uIHdoaWNoIHdpbGwgYmUgdXNlZCBieSBkZWZhdWx0IGZvciBTTVMsIHdpdGggdGhlIHN1YnNjcmlwdGlvbiB3aGljaAogICAgICogdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0bzsgb3IgdGhyb3cgYSBSdW50aW1lRXhjZXB0aW9uIGlmIHRoZSBzdXBwbGllZAogICAgICogc3Vic2NyaXB0aW9uIElEIGlzIG5vdCB1c2FibGUgKGNoZWNrIHdpdGgge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERlZmF1bHRTbXNTdWJJZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgic2V0RGVmYXVsdFNtc1N1YklkIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdFNtc1N1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBleC5yZXRocm93RnJvbVN5c3RlbVNlcnZlcigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgU3Vic2NyaXB0aW9uSW5mbyBmb3IgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogV2lsbCByZXR1cm4gbnVsbCBvbiBkYXRhIG9ubHkgZGV2aWNlcywgb3Igb24gZXJyb3IuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgU3Vic2NyaXB0aW9uSW5mbyBmb3IgdGhlIGRlZmF1bHQgU01TIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgaW50IGdldERlZmF1bHRTbXNQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHN5c3RlbSdzIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSB2b2ljZSBvbmx5IGRldmljZSBvciBvbiBlcnJvciwgd2lsbCByZXR1cm4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiBJZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHREYXRhU3ViSWRDYWNoZS5xdWVyeShudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgc3Vic2NyaXB0aW9uIHdoaWNoIHdpbGwgYmUgdXNlZCBieSBkZWZhdWx0IGZvciBkYXRhLCB3aXRoIHRoZSBzdWJzY3JpcHRpb24gd2hpY2gKICAgICAqIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgY29ycmVzcG9uZHMgdG87IG9yIHRocm93IGEgUnVudGltZUV4Y2VwdGlvbiBpZiB0aGUgc3VwcGxpZWQKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBpcyBub3QgdXNhYmxlIChjaGVjayB3aXRoIHtAbGluayAjaXNVc2FibGVTdWJzY3JpcHRpb25JZChpbnQpfSkuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQKICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0RGF0YVN1YklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJzZXREYXRhU3Vic2NyaXB0aW9uIHN1YiBpZCA9ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0RGVmYXVsdERhdGFTdWJJZChzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIFdpbGwgcmV0dXJuIG51bGwgb24gdm9pY2Ugb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IGdldERlZmF1bHREYXRhUGhvbmVJZCgpIHsKICAgICAgICByZXR1cm4gZ2V0UGhvbmVJZChnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHZvaWQgY2xlYXJTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLmNsZWFyU3ViSW5mbygpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vRklYTUUgdGhpcyBpcyB2dWxuZXJhYmxlIHRvIHJhY2UgY29uZGl0aW9ucwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgYm9vbGVhbiBhbGxEZWZhdWx0c1NlbGVjdGVkKCkgewogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0U21zU3Vic2NyaXB0aW9uSWQoKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBpcyB2YWxpZC4KICAgICAqCiAgICAgKiA8cD5BIHZhbGlkIHN1YnNjcmlwdGlvbiBJRCBpcyBub3QgbmVjZXNzYXJpbHkgYW4gYWN0aXZlIHN1YnNjcmlwdGlvbiBJRAogICAgICogKHNlZSB7QGxpbmsgI2lzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50KX0pIG9yIGFuIHVzYWJsZSBzdWJzY3JpcHRpb24gSUQKICAgICAqIChzZWUge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4gVW5sZXNzIHNwZWNpZmljYWxseSBub3RlZCwgc3Vic2NyaXB0aW9uCiAgICAgKiBBUElzIHdvcmsgd2l0aCBhIHZhbGlkIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgVGhlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb25JZCBpcyB2YWxpZDsge0Bjb2RlIGZhbHNlfSBvdGhlcndpc2UuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbklkID4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGlzIHVzYWJsZS4KICAgICAqCiAgICAgKiA8cD5BIHVzYWJsZSBzdWJzY3JpcHRpb24gSUQgaXMgYSB2YWxpZCBzdWJzY3JpcHRpb24gSUQsIGJ1dCBub3QgbmVjZXNzYXJpbHkgYW4gYWN0aXZlCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgKHNlZSB7QGxpbmsgI2lzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50KX0pLiBTb21lIHN1YnNjcmlwdGlvbiBBUElzCiAgICAgKiByZXF1aXJlIGEgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRCwgYW5kIHRoaXMgaXMgbm90ZWQgaW4gdGhlaXIgZG9jdW1lbnRhdGlvbjsgb3RoZXJ3aXNlLCBhCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgZG9lcyBub3QgbmVlZCB0byBiZSB1c2FibGUgZm9yIHN1YnNjcmlwdGlvbiBmdW5jdGlvbnMsIG9ubHkgdmFsaWQuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb24gSUQKICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgdXNhYmxlOyB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIGlzVXNhYmxlU3ViSWRWYWx1ZShzdWJzY3JpcHRpb25JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgc3ViSWQgaXMgYW4gdXNhYmxlIHN1YklkIHZhbHVlIGVsc2UgZmFsc2UuIEEKICAgICAqIHVzYWJsZSBzdWJJZCBtZWFucyBpdHMgbmVpdGhlciBhIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEIG5vciBhIERFRkFVTFRfU1VCX0lELgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVXNhYmxlU3ViSWRWYWx1ZShpbnQgc3ViSWQpIHsKICAgICAgICByZXR1cm4gc3ViSWQgPj0gTUlOX1NVQlNDUklQVElPTl9JRF9WQUxVRSAmJiBzdWJJZCA8PSBNQVhfU1VCU0NSSVBUSU9OX0lEX1ZBTFVFOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QLCB0cmFja2luZ0J1ZyA9IDExNTYwOTAyMykKICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkU2xvdEluZGV4KGludCBzbG90SW5kZXgpIHsKICAgICAgICByZXR1cm4gc2xvdEluZGV4ID49IDAgJiYgc2xvdEluZGV4IDwgVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuZ2V0QWN0aXZlTW9kZW1Db3VudCgpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5SLCB0cmFja2luZ0J1ZyA9IDE3MDcyOTU1MykKICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc1ZhbGlkUGhvbmVJZChpbnQgcGhvbmVJZCkgewogICAgICAgIHJldHVybiBwaG9uZUlkID49IDAgJiYgcGhvbmVJZCA8IFRlbGVwaG9ueU1hbmFnZXIuZ2V0RGVmYXVsdCgpLmdldEFjdGl2ZU1vZGVtQ291bnQoKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCkKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYShJbnRlbnQgaW50ZW50LCBpbnQgcGhvbmVJZCkgewogICAgICAgIGludFtdIHN1YklkcyA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0U3ViSWQocGhvbmVJZCk7CiAgICAgICAgaWYgKHN1YklkcyAhPSBudWxsICYmIHN1Yklkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHB1dFBob25lSWRBbmRTdWJJZEV4dHJhKGludGVudCwgcGhvbmVJZCwgc3ViSWRzWzBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb2dkKCJwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYTogbm8gdmFsaWQgc3VicyIpOwogICAgICAgICAgICBpbnRlbnQucHV0RXh0cmEoUGhvbmVDb25zdGFudHMuUEhPTkVfS0VZLCBwaG9uZUlkKTsKICAgICAgICAgICAgaW50ZW50LnB1dEV4dHJhKEVYVFJBX1NMT1RfSU5ERVgsIHBob25lSWQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUiwgdHJhY2tpbmdCdWcgPSAxNzA3Mjk1NTMpCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgcHV0UGhvbmVJZEFuZFN1YklkRXh0cmEoSW50ZW50IGludGVudCwgaW50IHBob25lSWQsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYTogcGhvbmVJZD0iICsgcGhvbmVJZCArICIgc3ViSWQ9IiArIHN1YklkKTsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoRVhUUkFfU0xPVF9JTkRFWCwgcGhvbmVJZCk7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFBob25lQ29uc3RhbnRzLlBIT05FX0tFWSwgcGhvbmVJZCk7CiAgICAgICAgcHV0U3Vic2NyaXB0aW9uSWRFeHRyYShpbnRlbnQsIHN1YklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB2aXNpYmxlIHN1YnNjcmlwdGlvbiBJZChzKSBvZiB0aGUgY3VycmVudGx5IGFjdGl2ZSBTSU0ocykuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgbGlzdCBvZiBzdWJJZCdzIHRoYXQgYXJlIGFjdGl2ZSwKICAgICAqICAgICAgICAgaXMgbmV2ZXIgbnVsbCBidXQgdGhlIGxlbmd0aCBtYXkgYmUgMC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5vbk51bGwgaW50W10gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JZExpc3QoLyogdmlzaWJsZU9ubHkgKi8gdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYm90aCBoaWRkZW4gYW5kIHZpc2libGUgc3Vic2NyaXB0aW9uIElkKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqCiAgICAgKiBIaWRkZW4gc3Vic2NyaXB0aW9ucyByZWZlciB0byB0aG9zZSBhcmUgbm90IG1lYW50IHZpc2libGUgdG8gdGhlIHVzZXJzLgogICAgICogRm9yIGV4YW1wbGUsIGFuIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIHRoYXQgaXMgZ3JvdXBlZCB3aXRoIG90aGVyCiAgICAgKiBzdWJzY3JpcHRpb25zIHNob3VsZCByZW1haW4gaW52aXNpYmxlIHRvIHVzZXJzIGFzIHRoZXkgYXJlIG9ubHkgZnVuY3Rpb25hbGx5CiAgICAgKiBzdXBwbGVtZW50YXJ5IHRvIHByaW1hcnkgb25lcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIHN1YklkJ3MgdGhhdCBhcmUgYWN0aXZlLAogICAgICogICAgICAgICBpcyBuZXZlciBudWxsIGJ1dCB0aGUgbGVuZ3RoIG1heSBiZSAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBpbnRbXSBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdCgpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KC8qIHZpc2libGVPbmx5ICovZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiBhIG5vbi1udWxsIGxpc3Qgb2Ygc3ViSWQncyB0aGF0IGFyZSBhY3RpdmUuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIEBOb25OdWxsIGludFtdIGdldEFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdChib29sZWFuIHZpc2libGVPbmx5KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGludFtdIHN1YklkID0gaVN1Yi5nZXRBY3RpdmVTdWJJZExpc3QodmlzaWJsZU9ubHkpOwogICAgICAgICAgICAgICAgaWYgKHN1YklkICE9IG51bGwpIHJldHVybiBzdWJJZDsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgaW50WzBdOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBkZXZpY2UgaXMgY29uc2lkZXJlZCByb2FtaW5nIG9uIHRoZSBjdXJyZW50CiAgICAgKiBuZXR3b3JrIGZvciBhIHN1YnNjcmlwdGlvbi4KICAgICAqIDxwPgogICAgICogQXZhaWxhYmlsaXR5OiBPbmx5IHdoZW4gdXNlciByZWdpc3RlcmVkIHRvIGEgbmV0d29yay4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHN1YnNjcmlwdGlvbiBJRAogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBuZXR3b3JrIGZvciB0aGUgc3Vic2NyaXB0aW9uIGlzIHJvYW1pbmcsIGZhbHNlIG90aGVyd2lzZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc05ldHdvcmtSb2FtaW5nKGludCBzdWJJZCkgewogICAgICAgIGZpbmFsIGludCBwaG9uZUlkID0gZ2V0UGhvbmVJZChzdWJJZCk7CiAgICAgICAgaWYgKHBob25lSWQgPCAwKSB7CiAgICAgICAgICAgIC8vIFdoYXQgZWxzZSBjYW4gd2UgZG8/CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFRlbGVwaG9ueU1hbmFnZXIuZ2V0RGVmYXVsdCgpLmlzTmV0d29ya1JvYW1pbmcoc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXRlIG9mIHNpbSBmb3IgdGhlIHNsb3QgaW5kZXguCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleAogICAgICoKICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1VOS05PV059CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9BQlNFTlR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9QSU5fUkVRVUlSRUR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9QVUtfUkVRVUlSRUR9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9ORVRXT1JLX0xPQ0tFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1JFQURZfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfTk9UX1JFQURZfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUEVSTV9ESVNBQkxFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX0NBUkRfSU9fRVJST1J9CiAgICAgKgogICAgICoge0BoaWRlfQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRTaW1TdGF0ZUZvclNsb3RJbmRleChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaW50IHNpbVN0YXRlID0gVGVsZXBob255TWFuYWdlci5TSU1fU1RBVEVfVU5LTk9XTjsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNpbVN0YXRlID0gaVN1Yi5nZXRTaW1TdGF0ZUZvclNsb3RJbmRleChzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2ltU3RhdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBwcm9wZXJ0aWVzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb25JbmZvIGluIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gZGF0YWJhc2UgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbkluZm8KICAgICAqIEBwYXJhbSBwcm9wVmFsdWUgVmFsdWUgdG8gc3RvcmUgaW4gREIgZm9yIHBhcnRpY3VsYXIgc3ViSWQgJiBjb2x1bW4gbmFtZQogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIHNldFN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIFN0cmluZyBwcm9wVmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXJpYWxpemUgbGlzdCBvZiBjb250YWN0cyB1cmkgdG8gc3RyaW5nCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIFN0cmluZyBzZXJpYWxpemVVcmlMaXN0cyhMaXN0PFVyaT4gdXJpcykgewogICAgICAgIExpc3Q8U3RyaW5nPiBjb250YWN0cyA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIGZvciAoVXJpIHVyaSA6IHVyaXMpIHsKICAgICAgICAgICAgY29udGFjdHMuYWRkKHVyaS50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgQnl0ZUFycmF5T3V0cHV0U3RyZWFtIGJvcyA9IG5ldyBCeXRlQXJyYXlPdXRwdXRTdHJlYW0oKTsKICAgICAgICAgICAgT2JqZWN0T3V0cHV0U3RyZWFtIG9vcyA9IG5ldyBPYmplY3RPdXRwdXRTdHJlYW0oYm9zKTsKICAgICAgICAgICAgb29zLndyaXRlT2JqZWN0KGNvbnRhY3RzKTsKICAgICAgICAgICAgb29zLmZsdXNoKCk7CiAgICAgICAgICAgIHJldHVybiBCYXNlNjQuZW5jb2RlVG9TdHJpbmcoYm9zLnRvQnl0ZUFycmF5KCksIEJhc2U2NC5ERUZBVUxUKTsKICAgICAgICB9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIGxvZ2QoInNlcmlhbGl6ZVVyaUxpc3RzIElPIGV4Y2VwdGlvbiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gIiI7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gbGlzdCBvZiBjb250YWN0cyB1cmkgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHJldHVybiBsaXN0IG9mIGNvbnRhY3RzIHVyaSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgTGlzdDxVcmk+IGdldENvbnRhY3RzRnJvbVN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksCiAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBieXRlW10gYiA9IEJhc2U2NC5kZWNvZGUocmVzdWx0LCBCYXNlNjQuREVGQVVMVCk7CiAgICAgICAgICAgICAgICBCeXRlQXJyYXlJbnB1dFN0cmVhbSBiaXMgPSBuZXcgQnl0ZUFycmF5SW5wdXRTdHJlYW0oYik7CiAgICAgICAgICAgICAgICBPYmplY3RJbnB1dFN0cmVhbSBvaXMgPSBuZXcgT2JqZWN0SW5wdXRTdHJlYW0oYmlzKTsKICAgICAgICAgICAgICAgIExpc3Q8U3RyaW5nPiBjb250YWN0cyA9IEFycmF5TGlzdC5jbGFzcy5jYXN0KG9pcy5yZWFkT2JqZWN0KCkpOwogICAgICAgICAgICAgICAgTGlzdDxVcmk+IHVyaXMgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICAgICAgICAgIGZvciAoU3RyaW5nIGNvbnRhY3QgOiBjb250YWN0cykgewogICAgICAgICAgICAgICAgICAgIHVyaXMuYWRkKFVyaS5wYXJzZShjb250YWN0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdXJpczsKICAgICAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgSU8gZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0gY2F0Y2ggKENsYXNzTm90Rm91bmRFeGNlcHRpb24gZSkgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Q29udGFjdHNGcm9tU3Vic2NyaXB0aW9uUHJvcGVydHkgQ2xhc3NOb3RGb3VuZCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEFycmF5TGlzdDw+KCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBwcm9wZXJ0aWVzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb25JbmZvIGluIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHJldHVybiBWYWx1ZSBhc3NvY2lhdGVkIHdpdGggc3ViSWQgYW5kIHByb3BLZXkgY29sdW1uIGluIGRhdGFiYXNlCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwcml2YXRlIHN0YXRpYyBTdHJpbmcgZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwKICAgICAgICAgICAgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdFZhbHVlID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0VmFsdWUgPSBpU3ViLmdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgY29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdFZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBib29sZWFuIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gcXVlcnkgcmVzdWx0LgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5IENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBkZWZWYWx1ZSBEZWZhdWx0IGJvb2xlYW4gdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gYm9vbGVhbiByZXN1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgYm9vbGVhbiBnZXRCb29sZWFuU3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwKICAgICAgICAgICAgYm9vbGVhbiBkZWZWYWx1ZSwgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdCA9IGdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LCBjb250ZXh0KTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBJbnRlZ2VyLnBhcnNlSW50KHJlc3VsdCkgPT0gMTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGVycikgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0Qm9vbGVhblN1YnNjcmlwdGlvblByb3BlcnR5IE51bWJlckZvcm1hdCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGludGVnZXIgdmFsdWUgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHBhcmFtIGRlZlZhbHVlIERlZmF1bHQgaW50ZWdlciB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQHJldHVybiBpbnRlZ2VyIHJlc3VsdCB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0SW50ZWdlclN1YnNjcmlwdGlvblByb3BlcnR5KGludCBzdWJJZCwgU3RyaW5nIHByb3BLZXksIGludCBkZWZWYWx1ZSwKICAgICAgICAgICAgQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgU3RyaW5nIHJlc3VsdCA9IGdldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LCBjb250ZXh0KTsKICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBJbnRlZ2VyLnBhcnNlSW50KHJlc3VsdCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlcnIpIHsKICAgICAgICAgICAgICAgIGxvZ2QoImdldEludGVnZXJTdWJzY3JpcHRpb25Qcm9wZXJ0eSBOdW1iZXJGb3JtYXQgZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZlZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBsb25nIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gcXVlcnkgcmVzdWx0LgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbiBJZCBvZiBTdWJzY3JpcHRpb24KICAgICAqIEBwYXJhbSBwcm9wS2V5IENvbHVtbiBuYW1lIGluIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBkZWZWYWx1ZSBEZWZhdWx0IGxvbmcgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEByZXR1cm4gbG9uZyByZXN1bHQgdmFsdWUgdG8gYmUgcmV0dXJuZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgbG9uZyBnZXRMb25nU3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwgbG9uZyBkZWZWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb250ZXh0IGNvbnRleHQpIHsKICAgICAgICBTdHJpbmcgcmVzdWx0ID0gZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoc3ViSWQsIHByb3BLZXksIGNvbnRleHQpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIExvbmcucGFyc2VMb25nKHJlc3VsdCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlcnIpIHsKICAgICAgICAgICAgICAgIGxvZ2QoImdldExvbmdTdWJzY3JpcHRpb25Qcm9wZXJ0eSBOdW1iZXJGb3JtYXQgZXhjZXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZlZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUge0BsaW5rIFJlc291cmNlc30gZnJvbSB0aGUgZ2l2ZW4ge0BsaW5rIENvbnRleHR9IGZvciB0aGUgTUNDL01OQyBhc3NvY2lhdGVkIHdpdGgKICAgICAqIHRoZSBzdWJzY3JpcHRpb24uIElmIHRoZSBzdWJzY3JpcHRpb24gSUQgaXMgaW52YWxpZCwgdGhlIGJhc2UgcmVzb3VyY2VzIGFyZSByZXR1cm5lZCBpbnN0ZWFkLgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICoKICAgICAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2JqZWN0CiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbiB3aG9zZSByZXNvdXJjZXMgYXJlIHJlcXVpcmVkCiAgICAgKiBAcmV0dXJuIFJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgUmVzb3VyY2VzIGdldFJlc291cmNlc0ZvclN1YklkKEBOb25OdWxsIENvbnRleHQgY29udGV4dCwgaW50IHN1YklkKSB7CiAgICAgICAgcmV0dXJuIGdldFJlc291cmNlc0ZvclN1YklkKGNvbnRleHQsIHN1YklkLCBmYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSByZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbi4KICAgICAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2JqZWN0CiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbiB3aG8ncyByZXNvdXJjZXMgYXJlIHJlcXVpcmVkCiAgICAgKiBAcGFyYW0gdXNlUm9vdExvY2FsZSBpZiByb290IGxvY2FsZSBzaG91bGQgYmUgdXNlZC4gTG9jYWxpemVkIGxvY2FsZSBpcyB1c2VkIGlmIGZhbHNlLgogICAgICogQHJldHVybiBSZXNvdXJjZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBwdWJsaWMgc3RhdGljIFJlc291cmNlcyBnZXRSZXNvdXJjZXNGb3JTdWJJZChDb250ZXh0IGNvbnRleHQsIGludCBzdWJJZCwKICAgICAgICAgICAgYm9vbGVhbiB1c2VSb290TG9jYWxlKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgcmVzb3VyY2VzIGZvciB0aGlzIGNvbnRleHQgYW5kIHN1YklkIGFscmVhZHkgZXhpc3QgaW4gdGhlIHJlc291cmNlIGNhY2hlLgogICAgICAgIC8vIFJlc291cmNlcyB0aGF0IHVzZSB0aGUgcm9vdCBsb2NhbGUgYXJlIG5vdCBjYWNoZWQuCiAgICAgICAgUGFpcjxDb250ZXh0LCBJbnRlZ2VyPiBjYWNoZUtleSA9IG51bGw7CiAgICAgICAgaWYgKGlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkgJiYgIXVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAgICAgY2FjaGVLZXkgPSBQYWlyLmNyZWF0ZShjb250ZXh0LCBzdWJJZCk7CiAgICAgICAgICAgIGlmIChzUmVzb3VyY2VzQ2FjaGUuY29udGFpbnNLZXkoY2FjaGVLZXkpKSB7CiAgICAgICAgICAgICAgICAvLyBDYWNoZSBoaXQuIFVzZSBjYWNoZWQgUmVzb3VyY2VzLgogICAgICAgICAgICAgICAgcmV0dXJuIHNSZXNvdXJjZXNDYWNoZS5nZXQoY2FjaGVLZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmaW5hbCBTdWJzY3JpcHRpb25JbmZvIHN1YkluZm8gPQogICAgICAgICAgICAgICAgU3Vic2NyaXB0aW9uTWFuYWdlci5mcm9tKGNvbnRleHQpLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oc3ViSWQpOwoKICAgICAgICBDb25maWd1cmF0aW9uIG92ZXJyaWRlQ29uZmlnID0gbmV3IENvbmZpZ3VyYXRpb24oKTsKICAgICAgICBpZiAoc3ViSW5mbyAhPSBudWxsKSB7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLm1jYyA9IHN1YkluZm8uZ2V0TWNjKCk7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLm1uYyA9IHN1YkluZm8uZ2V0TW5jKCk7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUNvbmZpZy5tbmMgPT0gMCkgewogICAgICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubW5jID0gQ29uZmlndXJhdGlvbi5NTkNfWkVSTzsKICAgICAgICAgICAgICAgIGNhY2hlS2V5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhY2hlS2V5ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh1c2VSb290TG9jYWxlKSB7CiAgICAgICAgICAgIG92ZXJyaWRlQ29uZmlnLnNldExvY2FsZShMb2NhbGUuUk9PVCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDcmVhdGUgbmV3IGNvbnRleHQgd2l0aCBuZXcgY29uZmlndXJhdGlvbiBzbyB0aGF0IHdlIGNhbiBhdm9pZCBtb2RpZnlpbmcgdGhlIHBhc3NlZCBpbgogICAgICAgIC8vIGNvbnRleHQuCiAgICAgICAgLy8gTm90ZSB0aGF0IGlmIHRoZSBvcmlnaW5hbCBjb250ZXh0IGNvbmZpZ3VyYXRpb24gY2hhbmdlcywgdGhlIHJlc291cmNlcyBoZXJlIHdpbGwgYWxzbwogICAgICAgIC8vIGNoYW5nZSBmb3IgYWxsIHZhbHVlcyBleGNlcHQgdGhvc2Ugb3ZlcnJpZGRlbiBieSBuZXdDb25maWcgKGUuZy4gaWYgdGhlIGRldmljZSBoYXMgYW4KICAgICAgICAvLyBvcmllbnRhdGlvbiBjaGFuZ2UpLgogICAgICAgIENvbnRleHQgbmV3Q29udGV4dCA9IGNvbnRleHQuY3JlYXRlQ29uZmlndXJhdGlvbkNvbnRleHQob3ZlcnJpZGVDb25maWcpOwogICAgICAgIFJlc291cmNlcyByZXMgPSBuZXdDb250ZXh0LmdldFJlc291cmNlcygpOwoKICAgICAgICBpZiAoY2FjaGVLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAvLyBTYXZlIHRoZSBuZXdseSBjcmVhdGVkIFJlc291cmNlcyBpbiB0aGUgcmVzb3VyY2UgY2FjaGUuCiAgICAgICAgICAgIHNSZXNvdXJjZXNDYWNoZS5wdXQoY2FjaGVLZXksIHJlcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0byBhIHN1YnNjcmlwdGlvbiB3aGljaCBpcyBhY3RpdmVseSBpbgogICAgICogdXNlIG9uIHRoZSBkZXZpY2UuIEFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gSUQgaXMgYSB2YWxpZCBhbmQgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgY29ycmVzcG9uZHMgdG8gYW4gYWN0aXZlIHN1YnNjcmlwdGlvbjsKICAgICAqIHtAY29kZSBmYWxzZX0gaWYgaXQgZG9lcyBub3QgY29ycmVzcG9uZCB0byBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uOyBvciB0aHJvdyBhCiAgICAgKiBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGhhc24ndCBnb3QgdGhlIHJpZ2h0IHBlcm1pc3Npb24uCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBpc0FjdGl2ZVN1YnNjcmlwdGlvbklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIHJldHVybiBpc0FjdGl2ZVN1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGUgc3ViIElEIGlzIGFjdGl2ZS4gaS5lLiBUaGUgc3ViIElEIGNvcnJlc3BvbmRzIHRvIGEga25vd24gc3Vic2NyaXB0aW9uCiAgICAgKiBhbmQgdGhlIFNJTSBwcm92aWRpbmcgdGhlIHN1YnNjcmlwdGlvbiBpcyBwcmVzZW50IGluIGEgc2xvdCBhbmQgaW4gIkxPQURFRCIgc3RhdGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGJvb2xlYW4gaXNBY3RpdmVTdWJJZChpbnQgc3ViSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuaXNBY3RpdmVTdWJJZChzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyCiAgICAgKiBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIHJlbGF0aW9uc2hpcCBhcHBsaWVzIHRvCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25QbGFuPiBnZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQpIHsKICAgICAgICBTdWJzY3JpcHRpb25QbGFuW10gc3Vic2NyaXB0aW9uUGxhbnMgPQogICAgICAgICAgICAgICAgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKS5nZXRTdWJzY3JpcHRpb25QbGFucyhzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uUGxhbnMgPT0gbnVsbAogICAgICAgICAgICAgICAgPyBDb2xsZWN0aW9ucy5lbXB0eUxpc3QoKSA6IEFycmF5cy5hc0xpc3Qoc3Vic2NyaXB0aW9uUGxhbnMpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllcgogICAgICogYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0by4gQW4gZW1wdHkgbGlzdAogICAgICogICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgdGhlIGxpc3Qgb2YgcGxhbnMuIFRoZSBmaXJzdCBwbGFuIGlzIGFsd2F5cyB0aGUgcHJpbWFyeSBhbmQKICAgICAqICAgICAgICAgICAgbW9zdCBpbXBvcnRhbnQgcGxhbi4gQW55IGFkZGl0aW9uYWwgcGxhbnMgYXJlIHNlY29uZGFyeSBhbmQKICAgICAqICAgICAgICAgICAgbWF5IG5vdCBiZSBkaXNwbGF5ZWQgb3IgdXNlZCBieSBkZWNpc2lvbiBtYWtpbmcgbG9naWMuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgcGxhbnMgZG9uJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBkZWZpbmVkIGluIHtAbGluayBTdWJzY3JpcHRpb25QbGFufS4KICAgICAqIEBkZXByZWNhdGVkIHVzZSB7QGxpbmsgI3NldFN1YnNjcmlwdGlvblBsYW5zKGludCwgTGlzdCwgbG9uZyl9IGluc3RlYWQuCiAgICAgKi8KICAgIEBEZXByZWNhdGVkCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQsIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uUGxhbj4gcGxhbnMpIHsKICAgICAgICBzZXRTdWJzY3JpcHRpb25QbGFucyhzdWJJZCwgcGxhbnMsIDApOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllcgogICAgICogYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyByZWxhdGlvbnNoaXAgYXBwbGllcyB0by4gQW4gZW1wdHkgbGlzdAogICAgICogICAgICAgICAgICBtYXkgYmUgc2VudCB0byBjbGVhciBhbnkgZXhpc3RpbmcgcGxhbnMuCiAgICAgKiBAcGFyYW0gcGxhbnMgdGhlIGxpc3Qgb2YgcGxhbnMuIFRoZSBmaXJzdCBwbGFuIGlzIGFsd2F5cyB0aGUgcHJpbWFyeSBhbmQKICAgICAqICAgICAgICAgICAgbW9zdCBpbXBvcnRhbnQgcGxhbi4gQW55IGFkZGl0aW9uYWwgcGxhbnMgYXJlIHNlY29uZGFyeSBhbmQKICAgICAqICAgICAgICAgICAgbWF5IG5vdCBiZSBkaXNwbGF5ZWQgb3IgdXNlZCBieSBkZWNpc2lvbiBtYWtpbmcgbG9naWMuCiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgc3Vic2NyaXB0aW9uIHBsYW5zCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgdGhlIHBsYW5zIHVudGlsCiAgICAgKiAgICAgICAgICAgIGV4cGxpY2l0bHkgY2xlYXJlZCwgb3IgdGhlIG5leHQgcmVib290LCB3aGljaGV2ZXIgaGFwcGVucyBmaXJzdC4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBwbGFucyBkb24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIGRlZmluZWQgaW4ge0BsaW5rIFN1YnNjcmlwdGlvblBsYW59LgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQsIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uUGxhbj4gcGxhbnMsCiAgICAgICAgICAgIEBEdXJhdGlvbk1pbGxpc0xvbmcgbG9uZyBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpIHsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLAogICAgICAgICAgICAgICAgcGxhbnMudG9BcnJheShuZXcgU3Vic2NyaXB0aW9uUGxhblswXSksIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcywKICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIHVubWV0ZXJlZC4gVGhpcyB3aWxsIGJlIHJlZmxlY3RlZAogICAgICogdG8gYXBwcyB2aWEge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfTk9UX01FVEVSRUR9LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVVbm1ldGVyZWQgc2V0IGlmIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBzaG91bGQgYmUKICAgICAqICAgICAgICAgICAgY29uc2lkZXJlZCB1bm1ldGVyZWQuCiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgcmVxdWVzdGVkIG92ZXJyaWRlCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgaW4gdGhlCiAgICAgKiAgICAgICAgICAgIHJlcXVlc3RlZCBzdGF0ZSB1bnRpbCBleHBsaWNpdGx5IGNsZWFyZWQsIG9yIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlVW5tZXRlcmVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZVVubWV0ZXJlZCwKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlVW5tZXRlcmVkKHN1YklkLCBvdmVycmlkZVVubWV0ZXJlZCwKICAgICAgICAgICAgICAgIFRlbGVwaG9ueU1hbmFnZXIuZ2V0QWxsTmV0d29ya1R5cGVzKCksIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIHVubWV0ZXJlZC4gVGhpcyB3aWxsIGJlIHJlZmxlY3RlZAogICAgICogdG8gYXBwcyB2aWEge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfTk9UX01FVEVSRUR9LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVVbm1ldGVyZWQgc2V0IGlmIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBzaG91bGQgYmUKICAgICAqICAgICAgICAgICAgY29uc2lkZXJlZCB1bm1ldGVyZWQuCiAgICAgKiBAcGFyYW0gbmV0d29ya1R5cGVzIHRoZSBuZXR3b3JrIHR5cGVzIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4gSWYgbm8KICAgICAqICAgICAgICAgICAgbmV0d29yayB0eXBlcyBhcmUgc3BlY2lmaWVkLCBvdmVycmlkZSB2YWx1ZXMgd2lsbCBiZSBpZ25vcmVkLgogICAgICogICAgICAgICAgICB7QHNlZSBUZWxlcGhvbnlNYW5hZ2VyI2dldEFsbE5ldHdvcmtUeXBlcygpfQogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZCBvdmVycmlkZQogICAgICogICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9IHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvciB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZVVubWV0ZXJlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVVbm1ldGVyZWQsCiAgICAgICAgICAgIEBOb25OdWxsIEBBbm5vdGF0aW9uLk5ldHdvcmtUeXBlIGludFtdIG5ldHdvcmtUeXBlcywKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcykgewogICAgICAgIGZpbmFsIGludCBvdmVycmlkZVZhbHVlID0gb3ZlcnJpZGVVbm1ldGVyZWQgPyBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEIDogMDsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvbk92ZXJyaWRlKHN1YklkLCBTVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVELAogICAgICAgICAgICAgICAgb3ZlcnJpZGVWYWx1ZSwgbmV0d29ya1R5cGVzLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBvdmVycmlkZSB0aGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbiBiZXR3ZWVuIGEgY2FycmllciBhbmQKICAgICAqIGEgc3BlY2lmaWMgc3Vic2NyaWJlciB0byBiZSBjb25zaWRlcmVkIGNvbmdlc3RlZC4gVGhpcyB3aWxsIGNhdXNlIHRoZQogICAgICogZGV2aWNlIHRvIGRlbGF5IGNlcnRhaW4gbmV0d29yayByZXF1ZXN0cyB3aGVuIHBvc3NpYmxlLCBzdWNoIGFzIGRldmVsb3BlcgogICAgICogam9icyB0aGF0IGFyZSB3aWxsaW5nIHRvIHJ1biBpbiBhIGZsZXhpYmxlIHRpbWUgd2luZG93LgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIG92ZXJyaWRlIGFwcGxpZXMgdG8uCiAgICAgKiBAcGFyYW0gb3ZlcnJpZGVDb25nZXN0ZWQgc2V0IGlmIHRoZSBzdWJzY3JpcHRpb24gc2hvdWxkIGJlIGNvbnNpZGVyZWQKICAgICAqICAgICAgICAgICAgY29uZ2VzdGVkLgogICAgICogQHBhcmFtIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcyB0aGUgZHVyYXRpb24gYWZ0ZXIgd2hpY2ggdGhlIHJlcXVlc3RlZCBvdmVycmlkZQogICAgICogICAgICAgICAgICB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgY2xlYXJlZCwgb3Ige0Bjb2RlIDB9IHRvIGxlYXZlIGluIHRoZQogICAgICogICAgICAgICAgICByZXF1ZXN0ZWQgc3RhdGUgdW50aWwgZXhwbGljaXRseSBjbGVhcmVkLCBvciB0aGUgbmV4dCByZWJvb3QsCiAgICAgKiAgICAgICAgICAgIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25PdmVycmlkZUNvbmdlc3RlZChpbnQgc3ViSWQsIGJvb2xlYW4gb3ZlcnJpZGVDb25nZXN0ZWQsCiAgICAgICAgICAgIEBEdXJhdGlvbk1pbGxpc0xvbmcgbG9uZyBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpIHsKICAgICAgICBzZXRTdWJzY3JpcHRpb25PdmVycmlkZUNvbmdlc3RlZChzdWJJZCwgb3ZlcnJpZGVDb25nZXN0ZWQsCiAgICAgICAgICAgICAgICBUZWxlcGhvbnlNYW5hZ2VyLmdldEFsbE5ldHdvcmtUeXBlcygpLCBleHBpcmF0aW9uRHVyYXRpb25NaWxsaXMpOwogICAgfQoKICAgIC8qKgogICAgICogVGVtcG9yYXJpbHkgb3ZlcnJpZGUgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIgYW5kCiAgICAgKiBhIHNwZWNpZmljIHN1YnNjcmliZXIgdG8gYmUgY29uc2lkZXJlZCBjb25nZXN0ZWQuIFRoaXMgd2lsbCBjYXVzZSB0aGUKICAgICAqIGRldmljZSB0byBkZWxheSBjZXJ0YWluIG5ldHdvcmsgcmVxdWVzdHMgd2hlbiBwb3NzaWJsZSwgc3VjaCBhcyBkZXZlbG9wZXIKICAgICAqIGpvYnMgdGhhdCBhcmUgd2lsbGluZyB0byBydW4gaW4gYSBmbGV4aWJsZSB0aW1lIHdpbmRvdy4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLgogICAgICogQHBhcmFtIG92ZXJyaWRlQ29uZ2VzdGVkIHNldCBpZiB0aGUgc3Vic2NyaXB0aW9uIHNob3VsZCBiZSBjb25zaWRlcmVkCiAgICAgKiAgICAgICAgICAgIGNvbmdlc3RlZC4KICAgICAqIEBwYXJhbSBuZXR3b3JrVHlwZXMgdGhlIG5ldHdvcmsgdHlwZXMgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLiBJZiBubwogICAgICogICAgICAgICAgICBuZXR3b3JrIHR5cGVzIGFyZSBzcGVjaWZpZWQsIG92ZXJyaWRlIHZhbHVlcyB3aWxsIGJlIGlnbm9yZWQuCiAgICAgKiAgICAgICAgICAgIHtAc2VlIFRlbGVwaG9ueU1hbmFnZXIjZ2V0QWxsTmV0d29ya1R5cGVzKCl9CiAgICAgKiBAcGFyYW0gZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzIHRoZSBkdXJhdGlvbiBhZnRlciB3aGljaCB0aGUgcmVxdWVzdGVkIG92ZXJyaWRlCiAgICAgKiAgICAgICAgICAgIHdpbGwgYmUgYXV0b21hdGljYWxseSBjbGVhcmVkLCBvciB7QGNvZGUgMH0gdG8gbGVhdmUgaW4gdGhlCiAgICAgKiAgICAgICAgICAgIHJlcXVlc3RlZCBzdGF0ZSB1bnRpbCBleHBsaWNpdGx5IGNsZWFyZWQsIG9yIHRoZSBuZXh0IHJlYm9vdCwKICAgICAqICAgICAgICAgICAgd2hpY2hldmVyIGhhcHBlbnMgZmlyc3QuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlQ29uZ2VzdGVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZUNvbmdlc3RlZCwKICAgICAgICAgICAgQE5vbk51bGwgQEFubm90YXRpb24uTmV0d29ya1R5cGUgaW50W10gbmV0d29ya1R5cGVzLAogICAgICAgICAgICBARHVyYXRpb25NaWxsaXNMb25nIGxvbmcgZXhwaXJhdGlvbkR1cmF0aW9uTWlsbGlzKSB7CiAgICAgICAgZmluYWwgaW50IG92ZXJyaWRlVmFsdWUgPSBvdmVycmlkZUNvbmdlc3RlZCA/IFNVQlNDUklQVElPTl9PVkVSUklERV9DT05HRVNURUQgOiAwOwogICAgICAgIGdldE5ldHdvcmtQb2xpY3lNYW5hZ2VyKCkuc2V0U3Vic2NyaXB0aW9uT3ZlcnJpZGUoc3ViSWQsIFNVQlNDUklQVElPTl9PVkVSUklERV9DT05HRVNURUQsCiAgICAgICAgICAgICAgICBvdmVycmlkZVZhbHVlLCBuZXR3b3JrVHlwZXMsIGV4cGlyYXRpb25EdXJhdGlvbk1pbGxpcywgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIHRoZSBhcHAgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBpcyBhdXRob3JpemVkIHRvIG1hbmFnZSB0aGUgZ2l2ZW4gc3Vic2NyaXB0aW9uCiAgICAgKiBhY2NvcmRpbmcgdG8gaXRzIG1ldGFkYXRhLgogICAgICoKICAgICAqIE9ubHkgc3VwcG9ydGVkIGZvciBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIChpZiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyBUaGUgc3Vic2NyaXB0aW9uIHRvIGNoZWNrLgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBhcHAgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhpcyBzdWJzY3JpcHRpb24gcGVyIGl0cyBtZXRhZGF0YS4KICAgICAqLwogICAgcHVibGljIGJvb2xlYW4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8gaW5mbykgewogICAgICAgIHJldHVybiBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oaW5mbywgbUNvbnRleHQuZ2V0UGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoZSBnaXZlbiBzdWJzY3JpcHRpb24uIEFuIGFwcCBjYW4gb25seQogICAgICogYmUgYXV0aG9yaXplZCBpZiBpdCBpcyBpbmNsdWRlZCBpbiB0aGUge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlVpY2NBY2Nlc3NSdWxlfSBvZiB0aGUKICAgICAqIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5TdWJzY3JpcHRpb25JbmZvfSB3aXRoIHRoZSBhY2Nlc3Mgc3RhdHVzLgogICAgICoKICAgICAqIE9ubHkgc3VwcG9ydGVkIGZvciBlbWJlZGRlZCBzdWJzY3JpcHRpb25zIChpZiB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNpc0VtYmVkZGVkfSByZXR1cm5zCiAgICAgKiB0cnVlKS4gVG8gY2hlY2sgZm9yIHBlcm1pc3Npb25zIGZvciBub24tZW1iZWRkZWQgc3Vic2NyaXB0aW9uIGFzIHdlbGwsCiAgICAgKiB7QHNlZSBhbmRyb2lkLnRlbGVwaG9ueS5UZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfS4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyBUaGUgc3Vic2NyaXB0aW9uIHRvIGNoZWNrLgogICAgICogQHBhcmFtIHBhY2thZ2VOYW1lIFBhY2thZ2UgbmFtZSBvZiB0aGUgYXBwIHRvIGNoZWNrLgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBhcHAgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhpcyBzdWJzY3JpcHRpb24gcGVyIGl0cyBhY2Nlc3MgcnVsZXMuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgYm9vbGVhbiBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oQE5vbk51bGwgU3Vic2NyaXB0aW9uSW5mbyBpbmZvLAogICAgICAgICAgICBATm9uTnVsbCBTdHJpbmcgcGFja2FnZU5hbWUpIHsKICAgICAgICBpZiAoaW5mbyA9PSBudWxsIHx8IGluZm8uZ2V0QWxsQWNjZXNzUnVsZXMoKSA9PSBudWxsIHx8IHBhY2thZ2VOYW1lID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBQYWNrYWdlTWFuYWdlciBwYWNrYWdlTWFuYWdlciA9IG1Db250ZXh0LmdldFBhY2thZ2VNYW5hZ2VyKCk7CiAgICAgICAgUGFja2FnZUluZm8gcGFja2FnZUluZm87CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcGFja2FnZUluZm8gPSBwYWNrYWdlTWFuYWdlci5nZXRQYWNrYWdlSW5mbyhwYWNrYWdlTmFtZSwKICAgICAgICAgICAgICAgIFBhY2thZ2VNYW5hZ2VyLkdFVF9TSUdOSU5HX0NFUlRJRklDQVRFUyk7CiAgICAgICAgfSBjYXRjaCAoUGFja2FnZU1hbmFnZXIuTmFtZU5vdEZvdW5kRXhjZXB0aW9uIGUpIHsKICAgICAgICAgICAgbG9nZCgiVW5rbm93biBwYWNrYWdlOiAiICsgcGFja2FnZU5hbWUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoVWljY0FjY2Vzc1J1bGUgcnVsZSA6IGluZm8uZ2V0QWxsQWNjZXNzUnVsZXMoKSkgewogICAgICAgICAgICBpZiAocnVsZS5nZXRDYXJyaWVyUHJpdmlsZWdlU3RhdHVzKHBhY2thZ2VJbmZvKQogICAgICAgICAgICAgICAgICAgID09IFRlbGVwaG9ueU1hbmFnZXIuQ0FSUklFUl9QUklWSUxFR0VfU1RBVFVTX0hBU19BQ0NFU1MpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzIHVzZWQKICAgICAqIGJ5IEFsdGVybmF0aXZlTmV0d29ya1NlcnZpY2Ugb3IgY2FycmllciBhcHBzIHRvIHN3aXRjaCBwcmltYXJ5IGFuZCBDQlJTCiAgICAgKiBzdWJzY3JpcHRpb24gZHluYW1pY2FsbHkgaW4gbXVsdGktU0lNIGRldmljZXMuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHdoaWNoIHN1YnNjcmlwdGlvbiBpcyBwcmVmZXJyZWQgdG8gZm9yIGNlbGx1bGFyIGRhdGEuIElmIGl0J3MKICAgICAqICAgICAgICAgICAgICB7QGxpbmsgU3Vic2NyaXB0aW9uTWFuYWdlciNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0sIGl0IG1lYW5zCiAgICAgKiAgICAgICAgICAgICAgaXQncyB1bnNldCBhbmQge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpfQogICAgICogICAgICAgICAgICAgIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIG1vZGVtIGlzIHByZWZlcnJlZC4KICAgICAqIEBwYXJhbSBuZWVkVmFsaWRhdGlvbiB3aGV0aGVyIFRlbGVwaG9ueSB3aWxsIHdhaXQgdW50aWwgdGhlIG5ldHdvcmsgaXMgdmFsaWRhdGVkIGJ5CiAgICAgKiAgICAgICAgICAgICAgY29ubmVjdGl2aXR5IHNlcnZpY2UgYmVmb3JlIHN3aXRjaGluZyBkYXRhIHRvIGl0LiBNb3JlIGRldGFpbHMgc2VlCiAgICAgKiAgICAgICAgICAgICAge0BsaW5rIE5ldHdvcmtDYXBhYmlsaXRpZXMjTkVUX0NBUEFCSUxJVFlfVkFMSURBVEVEfS4KICAgICAqIEBwYXJhbSBleGVjdXRvciBUaGUgZXhlY3V0b3Igb2Ygd2hlcmUgdGhlIGNhbGxiYWNrIHdpbGwgZXhlY3V0ZS4KICAgICAqIEBwYXJhbSBjYWxsYmFjayBDYWxsYmFjayB3aWxsIGJlIHRyaWdnZXJlZCBvbmNlIGl0IHN1Y2NlZWRzIG9yIGZhaWxlZC4KICAgICAqICAgICAgICAgICAgICAgICBQYXNzIG51bGwgaWYgZG9uJ3QgY2FyZSBhYm91dCB0aGUgcmVzdWx0LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKgogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoaW50IHN1YklkLCBib29sZWFuIG5lZWRWYWxpZGF0aW9uLAogICAgICAgICAgICBATnVsbGFibGUgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsIEBOdWxsYWJsZQogICAgICAgICAgICBAVGVsZXBob255TWFuYWdlci5TZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uUmVzdWx0IENvbnN1bWVyPEludGVnZXI+IGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltzZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWRdKyBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiA9PSBudWxsKSByZXR1cm47CgogICAgICAgICAgICBJU2V0T3Bwb3J0dW5pc3RpY0RhdGFDYWxsYmFjayBjYWxsYmFja1N0dWIgPSBuZXcgSVNldE9wcG9ydHVuaXN0aWNEYXRhQ2FsbGJhY2suU3R1YigpIHsKICAgICAgICAgICAgICAgIEBPdmVycmlkZQogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgb25Db21wbGV0ZShpbnQgcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4ZWN1dG9yID09IG51bGwgfHwgY2FsbGJhY2sgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpbmFsIGxvbmcgaWRlbnRpdHkgPSBCaW5kZXIuY2xlYXJDYWxsaW5nSWRlbnRpdHkoKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRvci5leGVjdXRlKCgpIC0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFjY2VwdChyZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICBCaW5kZXIucmVzdG9yZUNhbGxpbmdJZGVudGl0eShpZGVudGl0eSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBpU3ViLnNldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZChzdWJJZCwgbmVlZFZhbGlkYXRpb24sIGNhbGxiYWNrU3R1Yik7CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIGZvciBjZWxsdWxhciBkYXRhLgogICAgICogSXQncyBhbHNvIHVzdWFsbHkgdGhlIHN1YnNjcmlwdGlvbiB3ZSBzZXQgdXAgaW50ZXJuZXQgY29ubmVjdGlvbiBvbi4KICAgICAqCiAgICAgKiBQcmVmZXJyZWREYXRhIG92ZXJ3cml0ZXMgdXNlciBzZXR0aW5nIG9mIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uIEFuZCBpdCdzIHVzZWQKICAgICAqIGJ5IEFsdGVybmF0aXZlTmV0d29ya1NlcnZpY2Ugb3IgY2FycmllciBhcHBzIHRvIHN3aXRjaCBwcmltYXJ5IGFuZCBDQlJTCiAgICAgKiBzdWJzY3JpcHRpb24gZHluYW1pY2FsbHkgaW4gbXVsdGktU0lNIGRldmljZXMuCiAgICAgKgogICAgICogQHJldHVybiBwcmVmZXJyZWQgc3Vic2NyaXB0aW9uIGlkIGZvciBjZWxsdWxhciBkYXRhLiB7QGxpbmsgREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9IGlmCiAgICAgKiB0aGVyZSdzIG5vIHByZWZlcmVkIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICoKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgZ2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIGludCBwcmVmZXJyZWRTdWJJZCA9IFN1YnNjcmlwdGlvbk1hbmFnZXIuREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZWZlcnJlZFN1YklkID0gaVN1Yi5nZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBwcmVmZXJyZWRTdWJJZDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgdGhhdCBjYW4gYmUgdmlzaWJsZSB0byB0aGUgY2FsbGVyLgogICAgICogT3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGFyZSBmb3Igb3Bwb3J0dW5pc3RpYyBuZXR3b3Jrcywgd2hpY2ggYXJlIGNlbGx1bGFyCiAgICAgKiBuZXR3b3JrcyB3aXRoIGxpbWl0ZWQgY2FwYWJpbGl0aWVzIGFuZCBjb3ZlcmFnZSwgZm9yIGV4YW1wbGUsIENCUlMuCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoKICAgICAqIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGxpc3Qgb2Ygb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gaW5mby4gSWYgbm9uZSBleGlzdHMsIGFuIGVtcHR5IGxpc3QuCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0T3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnMoKSB7CiAgICAgICAgU3RyaW5nIGNvbnRleHRQa2cgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgU3RyaW5nIGNvbnRleHRBdHRyaWJ1dGlvblRhZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpIDogbnVsbDsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHN1YkluZm9MaXN0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YkluZm9MaXN0ID0gaVN1Yi5nZXRPcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9ucyhjb250ZXh0UGtnLAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0QXR0cmlidXRpb25UYWcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHN1YkluZm9MaXN0ID09IG51bGwpIHsKICAgICAgICAgICAgc3ViSW5mb0xpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdWJJbmZvTGlzdDsKICAgIH0KCiAgICAvKioKICAgICAqIFN3aXRjaCB0byBhIGNlcnRhaW4gc3Vic2NyaXB0aW9uCiAgICAgKgogICAgICogIEBwYXJhbSBzdWJJZCBzdWIgaWQKICAgICAqICBAcGFyYW0gY2FsbGJhY2tJbnRlbnQgcGVuZGluZyBpbnRlbnQgdGhhdCB3aWxsIGJlIHNlbnQgYWZ0ZXIgb3BlcmF0aW9uIGlzIGRvbmUuCiAgICAgKgogICAgICogIHRvLWJlLWRlcHJlY2F0ZWQgdGhpcyBBUEkgaXMgYSBkdXBsaWNhdGUgb2Yge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsCiAgICAgKiAgUGVuZGluZ0ludGVudCl9IGFuZCBkb2VzIG5vdCBzdXBwb3J0IE11bHRpcGxlIEVuYWJsZWQgUHJvZmlsZShNRVApLiBBcHBzIHNob3VsZCB1c2UKICAgICAqICB7QGxpbmsgRXVpY2NNYW5hZ2VyI3N3aXRjaFRvU3Vic2NyaXB0aW9uKGludCwgUGVuZGluZ0ludGVudCl9IG9yCiAgICAgKiAge0BsaW5rIEV1aWNjTWFuYWdlciNzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQsIGludCwgUGVuZGluZ0ludGVudCl9IGluc3RlYWQuCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLldSSVRFX0VNQkVEREVEX1NVQlNDUklQVElPTlMpCiAgICBwdWJsaWMgdm9pZCBzd2l0Y2hUb1N1YnNjcmlwdGlvbihpbnQgc3ViSWQsIEBOb25OdWxsIFBlbmRpbmdJbnRlbnQgY2FsbGJhY2tJbnRlbnQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChjYWxsYmFja0ludGVudCwgImNhbGxiYWNrSW50ZW50IGNhbm5vdCBiZSBudWxsIik7CiAgICAgICAgRXVpY2NNYW5hZ2VyIGV1aWNjTWFuYWdlciA9IG5ldyBFdWljY01hbmFnZXIobUNvbnRleHQpOwogICAgICAgIGV1aWNjTWFuYWdlci5zd2l0Y2hUb1N1YnNjcmlwdGlvbihzdWJJZCwgY2FsbGJhY2tJbnRlbnQpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgb3Bwb3J0dW5pc3RpYywgdGhhdCBpcywgd2hldGhlciB0aGUgbmV0d29yayBpdCBjb25uZWN0cwogICAgICogdG8gaGFzIGxpbWl0ZWQgY292ZXJhZ2UuIEZvciBleGFtcGxlLCBDQlJTLiBTZXR0aW5nIGEgc3Vic2NyaXB0aW9uIG9wcG9ydHVuaXN0aWMgaGFzCiAgICAgKiBmb2xsb3dpbmcgaW1wYWN0czoKICAgICAqICAxKSBFdmVuIGlmIGl0J3MgYWN0aXZlLCBpdCB3aWxsIGJlIGRvcm1hbnQgbW9zdCBvZiB0aGUgdGltZS4gVGhlIG1vZGVtIHdpbGwgbm90IHRyeQogICAgICogICAgIHRvIHNjYW4gb3IgY2FtcCB1bnRpbCBpdCBrbm93cyBhbiBhdmFpbGFibGUgbmV0d29yayBpcyBuZWFyYnkgdG8gc2F2ZSBwb3dlci4KICAgICAqICAyKSBUZWxlcGhvbnkgcmVsaWVzIG9uIHN5c3RlbSBhcHAgb3IgY2FycmllciBpbnB1dCB0byBub3RpZnkgbmVhcmJ5IGF2YWlsYWJsZSBuZXR3b3Jrcy4KICAgICAqICAgICBTZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjdXBkYXRlQXZhaWxhYmxlTmV0d29ya3MoTGlzdCwgRXhlY3V0b3IsIENvbnN1bWVyKX0KICAgICAqICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqICAzKSBJbiBtdWx0aS1TSU0gZGV2aWNlcywgd2hlbiB0aGUgbmV0d29yayBpcyBuZWFyYnkgYW5kIGNhbXBlZCwgc3lzdGVtIG1heSBhdXRvbWF0aWNhbGx5CiAgICAgKiAgICAgc3dpdGNoIGludGVybmV0IGRhdGEgYmV0d2VlbiBpdCBhbmQgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiwgYmFzZWQgb24gY2FycmllcgogICAgICogICAgIHJlY29tbWVuZGF0aW9uIGFuZCBpdHMgc2lnbmFsIHN0cmVuZ3RoIGFuZCBtZXRlcmVkLW5lc3MsIGV0Yy4KICAgICAqCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEV9IG9yIGNhcnJpZXIKICAgICAqIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9mIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHBhcmFtIG9wcG9ydHVuaXN0aWMgd2hldGhlciBpdOKAmXMgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHtAY29kZSB0cnVlfSBpZiB0aGUgb3BlcmF0aW9uIGlzIHN1Y2NlZWQsIHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gc2V0T3Bwb3J0dW5pc3RpYyhib29sZWFuIG9wcG9ydHVuaXN0aWMsIGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbc2V0T3Bwb3J0dW5pc3RpY10rIG9wcG9ydHVuaXN0aWM6IiArIG9wcG9ydHVuaXN0aWMgKyAiIHN1YklkOiIgKyBzdWJJZCk7CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0T3Bwb3J0dW5pc3RpYyIsCiAgICAgICAgICAgICAgICAoaVN1YiktPiBpU3ViLnNldE9wcG9ydHVuaXN0aWMoCiAgICAgICAgICAgICAgICAgICAgICAgIG9wcG9ydHVuaXN0aWMsIHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpKSA9PSAxOwogICAgfQoKICAgIC8qKgogICAgICogSW5mb3JtIFN1YnNjcmlwdGlvbk1hbmFnZXIgdGhhdCBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGFyZSBidW5kbGVkCiAgICAgKiBhcyBhIGdyb3VwLiBJdCBjYW4gYmUgbXVsdGlwbGUgcHJpbWFyeSAobm9uLW9wcG9ydHVuaXN0aWMpIHN1YnNjcmlwdGlvbnMsCiAgICAgKiBvciBvbmUgb3IgbW9yZSBwcmltYXJ5IHBsdXMgb25lIG9yIG1vcmUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIFRoaXMgQVBJIHdpbGwgYWx3YXlzIGNyZWF0ZSBhIG5ldyBpbW11dGFibGUgZ3JvdXAgYW5kIGFzc2lnbiBncm91cCBVVUlEIHRvIGFsbCB0aGUKICAgICAqIHN1YnNjcmlwdGlvbnMsIHJlZ2FyZGxlc3Mgd2hldGhlciB0aGV5IGFyZSBpbiBhIGdyb3VwIGFscmVhZHkgb3Igbm90LgogICAgICoKICAgICAqIEdyb3VwZWQgc3Vic2NyaXB0aW9ucyB3aWxsIGhhdmUgYmVsb3cgYmVoYXZpb3JzOgogICAgICogMSkgVGhleSB3aWxsIHNoYXJlIHRoZSBzYW1lIHVzZXIgc2V0dGluZ3MuCiAgICAgKiAyKSBUaGUgb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIGluIHRoZSBncm91cCBpcyBjb25zaWRlcmVkIGludmlzaWJsZSBhbmQgd2lsbCBub3QKICAgICAqICAgIHJldHVybiBmcm9tIHtAbGluayAjZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKX0sIHVubGVzcyBjYWxsZXIgaGFzIGNhcnJpZXIKICAgICAqICAgIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9mIHRoZSBzdWJzY3JpcHRpb25zLgogICAgICogMykgVGhlIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZ3JvdXAgY2FuJ3QgYmUgYWN0aXZlIGJ5IGl0c2VsZi4gSWYgYWxsIG90aGVyCiAgICAgKiAgICBub24tb3Bwb3J0dW5pc3RpYyBvbmVzIGFyZSBkZWFjdGl2YXRlZCAodW5wbHVnZ2VkIG9yIGRpc2FibGVkIGluIFNldHRpbmdzKSwKICAgICAqICAgIHRoZSBvcHBvcnR1bmlzdGljIG9uZXMgd2lsbCBiZSBkZWFjdGl2YXRlZCBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICogcGVybWlzc2lvbiBvciBoYWQgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbiBvbiB0aGUgc3Vic2NyaXB0aW9uczoKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9IG9yCiAgICAgKiB7QGxpbmsgI2Nhbk1hbmFnZVN1YnNjcmlwdGlvbihTdWJzY3JpcHRpb25JbmZvKX0KICAgICAqCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgYW55IG9mIHRoZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGRvZXNuJ3QgZXhpc3QuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiBUZWxlcGhvbnkgc2VydmljZSBpcyBpbiBiYWQgc3RhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkTGlzdCBsaXN0IG9mIHN1YklkIHRoYXQgd2lsbCBiZSBpbiB0aGUgc2FtZSBncm91cAogICAgICogQHJldHVybiBncm91cFVVSUQgYSBVVUlEIGFzc2lnbmVkIHRvIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIFBhcmNlbFV1aWQgY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChzdWJJZExpc3QsICJjYW4ndCBjcmVhdGUgZ3JvdXAgZm9yIG51bGwgc3ViSWQgbGlzdCIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXBdIik7CiAgICAgICAgfQoKICAgICAgICBQYXJjZWxVdWlkIGdyb3VwVXVpZCA9IG51bGw7CiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpLT5pKS50b0FycmF5KCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGdyb3VwVXVpZCA9IGlTdWIuY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoc3ViSWRBcnJheSwgcGtnRm9yRGVidWcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInRlbGVwaG9ueSBzZXJ2aWNlIGlzIG51bGwuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZSgiY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdyb3VwVXVpZDsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBpbnRvIGEgZ3JvdXAuCiAgICAgKiBTZWUge0BsaW5rICNjcmVhdGVTdWJzY3JpcHRpb25Hcm91cChMaXN0KX0gZm9yIG1vcmUgZGV0YWlscy4KICAgICAqCiAgICAgKiBDYWxsZXIgd2lsbCBlaXRoZXIgaGF2ZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIHRoZSBzb21lIHN1YnNjcmlwdGlvbnMgaW4gdGhlIGxpc3QgZG9lc24ndCBleGlzdC4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIFRlbGVwaG9ueSBzZXJ2aWNlIGlzIGluIGJhZCBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWRMaXN0IGxpc3Qgb2Ygc3ViSWQgdGhhdCBuZWVkIGFkZGluZyBpbnRvIHRoZSBncm91cAogICAgICogQHBhcmFtIGdyb3VwVXVpZCB0aGUgZ3JvdXBVdWlkIHRoZSBzdWJzY3JpcHRpb25zIGFyZSBiZWluZyBhZGRlZCB0by4KICAgICAqCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgYWRkU3Vic2NyaXB0aW9uc0ludG9Hcm91cChATm9uTnVsbCBMaXN0PEludGVnZXI+IHN1YklkTGlzdCwKICAgICAgICAgICAgQE5vbk51bGwgUGFyY2VsVXVpZCBncm91cFV1aWQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChzdWJJZExpc3QsICJzdWJJZExpc3QgY2FuJ3QgYmUgbnVsbC4iKTsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChncm91cFV1aWQsICJncm91cFV1aWQgY2FuJ3QgYmUgbnVsbC4iKTsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXBdIik7CiAgICAgICAgfQoKICAgICAgICBpbnRbXSBzdWJJZEFycmF5ID0gc3ViSWRMaXN0LnN0cmVhbSgpLm1hcFRvSW50KGktPmkpLnRvQXJyYXkoKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuYWRkU3Vic2NyaXB0aW9uc0ludG9Hcm91cChzdWJJZEFycmF5LCBncm91cFV1aWQsIHBrZ0ZvckRlYnVnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGxvZ2UoImFkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIGJvb2xlYW4gaXNTeXN0ZW1Qcm9jZXNzKCkgewogICAgICAgIHJldHVybiBQcm9jZXNzLm15VWlkKCkgPT0gUHJvY2Vzcy5TWVNURU1fVUlEOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZyb20gdGhlaXIgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICogU2VlIHtAbGluayAjY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoTGlzdCl9IGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKiBwZXJtaXNzaW9uIG9yIGhhZCBjYXJyaWVyIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9uIHRoZSBzdWJzY3JpcHRpb25zOgogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0gb3IKICAgICAqIHtAbGluayAjY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8pfQogICAgICoKICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiB0aGUgc29tZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGRvZXNuJ3QgYmVsb25nCiAgICAgKiAgICAgICAgICAgICB0aGUgc3BlY2lmaWVkIGdyb3VwLgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZExpc3QgbGlzdCBvZiBzdWJJZCB0aGF0IG5lZWQgcmVtb3ZpbmcgZnJvbSB0aGVpciBncm91cHMuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QsCiAgICAgICAgICAgIEBOb25OdWxsIFBhcmNlbFV1aWQgZ3JvdXBVdWlkKSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoc3ViSWRMaXN0LCAic3ViSWRMaXN0IGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoZ3JvdXBVdWlkLCAiZ3JvdXBVdWlkIGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwXSIpOwogICAgICAgIH0KCiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpLT5pKS50b0FycmF5KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAoc3ViSWRBcnJheSwgZ3JvdXBVdWlkLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJyZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgc3Vic2NyaXB0aW9uSW5mbyBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgdGhhdCBhcmUgaW4gdGhlIHNhbWUgZ3JvdXAgb2YgZ2l2ZW4gc3ViSWQuCiAgICAgKiBTZWUge0BsaW5rICNjcmVhdGVTdWJzY3JpcHRpb25Hcm91cChMaXN0KX0gZm9yIG1vcmUgZGV0YWlscy4KICAgICAqCiAgICAgKiBDYWxsZXIgbXVzdCBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbi4KICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9CiAgICAgKgogICAgICogPHA+U3RhcnRpbmcgd2l0aCBBUEkgbGV2ZWwgMzMsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGFuIGVtcHR5IExpc3QgaWYgdGhlIGNhbGxlciBkb2VzCiAgICAgKiBub3QgaGF2ZSBhY2Nlc3MgdG8gZGV2aWNlIGlkZW50aWZpZXJzLgogICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGludm9rZWQgaWYgb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVxdWlyZW1lbnRzIGlzIG1ldDoKICAgICAqIDx1bD4KICAgICAqICAgICA8bGk+SWYgdGhlIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbi4KICAgICAqICAgICB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfQogICAgICogICAgIDxsaT5JZiB0aGUgYXBwIGhhcyB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEV9IHBlcm1pc3Npb24gYW5kCiAgICAgKiAgICAgYWNjZXNzIHRvIGRldmljZSBpZGVudGlmaWVycy4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gZ3JvdXBVdWlkIG9mIHdoaWNoIGxpc3Qgb2Ygc3ViSW5mbyB3aWxsIGJlIHJldHVybmVkLgogICAgICogQHJldHVybiBsaXN0IG9mIHN1YnNjcmlwdGlvbkluZm8gdGhhdCBiZWxvbmcgdG8gdGhlIHNhbWUgZ3JvdXAsIGluY2x1ZGluZyB0aGUgZ2l2ZW4KICAgICAqIHN1YnNjcmlwdGlvbiBpdHNlbGYuIEl0IHdpbGwgcmV0dXJuIGFuIGVtcHR5IGxpc3QgaWYgbm8gc3Vic2NyaXB0aW9uIGJlbG9uZ3MgdG8gdGhlIGdyb3VwLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0U3Vic2NyaXB0aW9uc0luR3JvdXAoQE5vbk51bGwgUGFyY2VsVXVpZCBncm91cFV1aWQpIHsKICAgICAgICBQcmVjb25kaXRpb25zLmNoZWNrTm90TnVsbChncm91cFV1aWQsICJncm91cFV1aWQgY2FuJ3QgYmUgbnVsbCIpOwogICAgICAgIFN0cmluZyBjb250ZXh0UGtnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIFN0cmluZyBjb250ZXh0QXR0cmlidXRpb25UYWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSA6IG51bGw7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2dldFN1YnNjcmlwdGlvbnNJbkdyb3VwXSsgZ3JvdXBVdWlkOiIgKyBncm91cFV1aWQpOwogICAgICAgIH0KCiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldFN1YnNjcmlwdGlvbnNJbkdyb3VwKGdyb3VwVXVpZCwgY29udGV4dFBrZywKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dEF0dHJpYnV0aW9uVGFnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGxvZ2UoInJlbW92ZVN1YnNjcmlwdGlvbnNGcm9tR3JvdXAgUmVtb3RlRXhjZXB0aW9uICIgKyBleCk7CiAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgIGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgdmlzaWJsZSB0byBBUEkgY2FsbGVyLiBJZiBpdCdzIGEgYnVuZGxlZCBvcHBvcnR1bmlzdGljCiAgICAgKiBzdWJzY3JpcHRpb24sIGl0IHNob3VsZCBiZSBoaWRkZW4gYW55d2hlcmUgaW4gU2V0dGluZ3MsIGRpYWxlciwgc3RhdHVzIGJhciBldGMuCiAgICAgKiBFeGNlcHRpb24gaXMgaWYgY2FsbGVyIG93bnMgY2FycmllciBwcml2aWxlZ2UsIGluIHdoaWNoIGNhc2UgdGhleSB3aWxsCiAgICAgKiB3YW50IHRvIHNlZSB0aGVpciBvd24gaGlkZGVuIHN1YnNjcmlwdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIGluZm8gdGhlIHN1YnNjcmlwdGlvbkluZm8gdG8gY2hlY2sgYWdhaW5zdC4KICAgICAqIEByZXR1cm4gdHJ1ZSBpZiB0aGlzIHN1YnNjcmlwdGlvbiBzaG91bGQgYmUgdmlzaWJsZSB0byB0aGUgQVBJIGNhbGxlci4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgYm9vbGVhbiBpc1N1YnNjcmlwdGlvblZpc2libGUoU3Vic2NyaXB0aW9uSW5mbyBpbmZvKSB7CiAgICAgICAgaWYgKGluZm8gPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIElmIHN1YnNjcmlwdGlvbiBpcyBOT1QgZ3JvdXBlZCBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiwgaXQncyB2aXNpYmxlLgogICAgICAgIGlmIChpbmZvLmdldEdyb3VwVXVpZCgpID09IG51bGwgfHwgIWluZm8uaXNPcHBvcnR1bmlzdGljKCkpIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBJZiB0aGUgY2FsbGVyIGlzIHRoZSBjYXJyaWVyIGFwcCBhbmQgb3ducyB0aGUgc3Vic2NyaXB0aW9uLCBpdCBzaG91bGQgYmUgdmlzaWJsZQogICAgICAgIC8vIHRvIHRoZSBjYWxsZXIuCiAgICAgICAgYm9vbGVhbiBoYXNDYXJyaWVyUHJpdmlsZWdlUGVybWlzc2lvbiA9IFRlbGVwaG9ueU1hbmFnZXIuZnJvbShtQ29udGV4dCkKICAgICAgICAgICAgICAgIC5oYXNDYXJyaWVyUHJpdmlsZWdlcyhpbmZvLmdldFN1YnNjcmlwdGlvbklkKCkpCiAgICAgICAgICAgICAgICB8fCBjYW5NYW5hZ2VTdWJzY3JpcHRpb24oaW5mbyk7CiAgICAgICAgcmV0dXJuIGhhc0NhcnJpZXJQcml2aWxlZ2VQZXJtaXNzaW9uOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIHRoYXQgYXJlIGF2YWlsYWJsZSBhbmQgdmlzaWJsZSB0byB0aGUgdXNlci4KICAgICAqIFVzZWQgYnkgU2V0dGluZ3MgYXBwIHRvIHNob3cgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHVzZXIgdG8gcGljay4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciBnZXRTZWxlY3RhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QgdG8gYmUgaW52b2tlZC4KICAgICAqIEByZXR1cm4gbGlzdCBvZiB1c2VyIHNlbGVjdGFibGUgc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgQE51bGxhYmxlIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0U2VsZWN0YWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gYXZhaWxhYmxlTGlzdCA9IGdldEF2YWlsYWJsZVN1YnNjcmlwdGlvbkluZm9MaXN0KCk7CiAgICAgICAgaWYgKGF2YWlsYWJsZUxpc3QgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBNdWx0aXBsZSBzdWJzY3JpcHRpb25zIGluIGEgZ3JvdXAgc2hvdWxkIG9ubHkgaGF2ZSBvbmUgcmVwcmVzZW50YXRpdmUuCiAgICAgICAgICAgIC8vIEl0IHNob3VsZCBiZSB0aGUgY3VycmVudCBhY3RpdmUgcHJpbWFyeSBzdWJzY3JpcHRpb24gaWYgYW55LCBvciBhbnkKICAgICAgICAgICAgLy8gcHJpbWFyeSBzdWJzY3JpcHRpb24uCiAgICAgICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gc2VsZWN0YWJsZUxpc3QgPSBuZXcgQXJyYXlMaXN0PD4oKTsKICAgICAgICAgICAgTWFwPFBhcmNlbFV1aWQsIFN1YnNjcmlwdGlvbkluZm8+IGdyb3VwTWFwID0gbmV3IEhhc2hNYXA8PigpOwoKICAgICAgICAgICAgZm9yIChTdWJzY3JpcHRpb25JbmZvIGluZm8gOiBhdmFpbGFibGVMaXN0KSB7CiAgICAgICAgICAgICAgICAvLyBPcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgYXJlIGNvbnNpZGVyZWQgaW52aXNpYmxlCiAgICAgICAgICAgICAgICAvLyB0byB1c2VycyBzbyB0aGV5IHNob3VsZCBuZXZlciBiZSByZXR1cm5lZC4KICAgICAgICAgICAgICAgIGlmICghaXNTdWJzY3JpcHRpb25WaXNpYmxlKGluZm8pKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBQYXJjZWxVdWlkIGdyb3VwVXVpZCA9IGluZm8uZ2V0R3JvdXBVdWlkKCk7CiAgICAgICAgICAgICAgICBpZiAoZ3JvdXBVdWlkID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAvLyBEb2Vzbid0IGJlbG9uZyB0byBhbnkgZ3JvdXAuIEFkZCBpbiB0aGUgbGlzdC4KICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlTGlzdC5hZGQoaW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFncm91cE1hcC5jb250YWluc0tleShncm91cFV1aWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHx8IChncm91cE1hcC5nZXQoZ3JvdXBVdWlkKS5nZXRTaW1TbG90SW5kZXgoKSA9PSBJTlZBTElEX1NJTV9TTE9UX0lOREVYCiAgICAgICAgICAgICAgICAgICAgICAgICYmIGluZm8uZ2V0U2ltU2xvdEluZGV4KCkgIT0gSU5WQUxJRF9TSU1fU0xPVF9JTkRFWCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBiZWxvbmdzIHRvIGEgZ3JvdXAgdGhhdCBoYXMgbmV2ZXIgYmVlbiByZWNvcmRlZCBvciBpdCdzIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgLy8gYWN0aXZlIHN1YnNjcmlwdGlvbiwgYWRkIGl0IGluIHRoZSBsaXN0LgogICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGVMaXN0LnJlbW92ZShncm91cE1hcC5nZXQoZ3JvdXBVdWlkKSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZUxpc3QuYWRkKGluZm8pOwogICAgICAgICAgICAgICAgICAgIGdyb3VwTWFwLnB1dChncm91cFV1aWQsIGluZm8pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VsZWN0YWJsZUxpc3Q7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRW5hYmxlcyBvciBkaXNhYmxlcyBhIHN1YnNjcmlwdGlvbi4gVGhpcyBpcyBjdXJyZW50bHkgdXNlZCBpbiB0aGUgc2V0dGluZ3MgcGFnZS4gSXQgd2lsbAogICAgICogZmFpbCBhbmQgcmV0dXJuIGZhbHNlIGlmIG9wZXJhdGlvbiBpcyBub3Qgc3VwcG9ydGVkIG9yIGZhaWxlZC4KICAgICAqCiAgICAgKiBUbyBkaXNhYmxlIGFuIGFjdGl2ZSBzdWJzY3JpcHRpb24gb24gYSBwaHlzaWNhbCAobm9uLUV1aWNjKSBTSU0sCiAgICAgKiB7QGxpbmsgI2NhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbn0gbmVlZHMgdG8gYmUgdHJ1ZS4KICAgICAqCiAgICAgKiA8cD4KICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqCiAgICAgKiBAcGFyYW0gZW5hYmxlIHdoZXRoZXIgdXNlciBpcyB0dXJuaW5nIGl0IG9uIG9yIG9mZi4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gdG8gYmUgZW5hYmxlZCBvciBkaXNhYmxlZC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBJdCBjb3VsZCBiZSBhIGVTSU0gb3IgcFNJTSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHJldHVybiB3aGV0aGVyIHRoZSBvcGVyYXRpb24gaXMgc3VjY2Vzc2Z1bC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBzZXRTdWJzY3JpcHRpb25FbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCwgYm9vbGVhbiBlbmFibGUpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJzZXRTdWJzY3JpcHRpb25BY3RpdmF0ZWQgc3ViSWQ9ICIgKyBzdWJzY3JpcHRpb25JZCArICIgZW5hYmxlICIgKyBlbmFibGUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuc2V0U3Vic2NyaXB0aW9uRW5hYmxlZChlbmFibGUsIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB1aWNjIGFwcGxpY2F0aW9ucyBiZWluZyBlbmFibGVkIG9yIGRpc2FibGVkLgogICAgICogVGhlIHZhbHVlIHdpbGwgYmUgcmVtZW1iZXJlZCBvbiB0aGUgc3Vic2NyaXB0aW9uIGFuZCB3aWxsIGJlIGFwcGxpZWQgd2hlbmV2ZXIgaXQncyBwcmVzZW50LgogICAgICogSWYgdGhlIHN1YnNjcmlwdGlvbiBpbiBjdXJyZW50bHkgcHJlc2VudCwgaXQgd2lsbCBhbHNvIGFwcGx5IHRoZSBzZXR0aW5nIHRvIG1vZGVtCiAgICAgKiBpbW1lZGlhdGVseSAodGhlIHNldHRpbmcgaW4gdGhlIG1vZGVtIHdpbGwgbm90IGNoYW5nZSB1bnRpbCB0aGUgbW9kZW0gcmVjZWl2ZXMgYW5kIHJlc3BvbmRzCiAgICAgKiB0byB0aGUgcmVxdWVzdCwgYnV0IHR5cGljYWxseSB0aGlzIHNob3VsZCBvbmx5IHRha2UgYSBmZXcgc2Vjb25kcy4gVGhlIHVzZXIgdmlzaWJsZSBzZXR0aW5nCiAgICAgKiBhdmFpbGFibGUgZnJvbSBTdWJzY3JpcHRpb25JbmZvLmFyZVVpY2NBcHBsaWNhdGlvbnNFbmFibGVkKCkgd2lsbCBiZSB1cGRhdGVkCiAgICAgKiBpbW1lZGlhdGVseS4pCiAgICAgKgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB3aGljaCBzdWJzY3JpcHRpb24gdG8gb3BlcmF0ZSBvbi4KICAgICAqIEBwYXJhbSBlbmFibGVkIHdoZXRoZXIgdWljYyBhcHBsaWNhdGlvbnMgYXJlIGVuYWJsZWQgb3IgZGlzYWJsZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0VWljY0FwcGxpY2F0aW9uc0VuYWJsZWQoaW50IHN1YnNjcmlwdGlvbklkLCBib29sZWFuIGVuYWJsZWQpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJzZXRVaWNjQXBwbGljYXRpb25zRW5hYmxlZCBzdWJJZD0gIiArIHN1YnNjcmlwdGlvbklkICsgIiBlbmFibGUgIiArIGVuYWJsZWQpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBJU3ViLlN0dWIuYXNJbnRlcmZhY2UoCiAgICAgICAgICAgICAgICAgICAgVGVsZXBob255RnJhbWV3b3JrSW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRUZWxlcGhvbnlTZXJ2aWNlTWFuYWdlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0U3Vic2NyaXB0aW9uU2VydmljZVJlZ2lzdGVyZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldCgpKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXRVaWNjQXBwbGljYXRpb25zRW5hYmxlZChlbmFibGVkLCBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogV2hldGhlciBpdCdzIHN1cHBvcnRlZCB0byBkaXNhYmxlIC8gcmUtZW5hYmxlIGEgc3Vic2NyaXB0aW9uIG9uIGEgcGh5c2ljYWwgKG5vbi1ldWljYykgU0lNLgogICAgICoKICAgICAqIFBoeXNpY2FsIFNJTSByZWZlcnMgbm9uLWV1aWNjLCBvciBha2Egbm9uLXByb2dyYW1tYWJsZSBTSU0uCiAgICAgKgogICAgICogSXQgcHJvdmlkZXMgd2hldGhlciBhIHBoeXNpY2FsIFNJTSBjYXJkIGNhbiBiZSBkaXNhYmxlZCB3aXRob3V0IHRha2luZyBpdCBvdXQsIHdoaWNoIGlzIGRvbmUKICAgICAqIHZpYSB7QGxpbmsgI3NldFN1YnNjcmlwdGlvbkVuYWJsZWQoaW50LCBib29sZWFuKX0gQVBJLgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IFJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHdoZXRoZXIgY2FuIGRpc2FibGUgc3Vic2NyaXB0aW9ucyBvbiBwaHlzaWNhbCBTSU1zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGNhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbigpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJjYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24iKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gSVN1Yi5TdHViLmFzSW50ZXJmYWNlKAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueUZyYW1ld29ya0luaXRpYWxpemVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0VGVsZXBob255U2VydmljZU1hbmFnZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFN1YnNjcmlwdGlvblNlcnZpY2VSZWdpc3RlcmVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXQoKSk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpU3ViLmNhbkRpc2FibGVQaHlzaWNhbFN1YnNjcmlwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogRE8gTk9UIFVTRS4KICAgICAqIFRoaXMgQVBJIGlzIGRlc2lnbmVkIGZvciBmZWF0dXJlcyB0aGF0IGFyZSBub3QgZmluaXNoZWQgYXQgdGhpcyBwb2ludC4gRG8gbm90IGNhbGwgdGhpcyBBUEkuCiAgICAgKiBAaGlkZQogICAgICogVE9ETyBiLzEzNTU0NzUxMjogZnVydGhlciBjbGVhbiB1cAogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJvb2xlYW4gaXNTdWJzY3JpcHRpb25FbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5pc1N1YnNjcmlwdGlvbkVuYWJsZWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nIHVzZXIgcHJlZmVyZW5jZSBmb3IgYSBzdWJzY3JpcHRpb24gSUQuIFRoZSBzZXR0aW5nCiAgICAgKiBhcHAgdXNlcyB0aGlzIG1ldGhvZCB0byBpbmRpY2F0ZSB3aXRoIHdob20gdGhleSB3aXNoIHRvIHNoYXJlIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzCiAgICAgKiBpbmZvcm1hdGlvbi4KICAgICAqIEBwYXJhbSBzaGFyaW5nIHRoZSBzdGF0dXMgc2hhcmluZyBwcmVmZXJlbmNlCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UoaW50IHN1YnNjcmlwdGlvbklkLAogICAgICAgICAgICBARGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nUHJlZmVyZW5jZSBpbnQgc2hhcmluZykgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmddICsgc2hhcmluZzogIiArIHNoYXJpbmcgKyAiIHN1YklkOiAiCiAgICAgICAgICAgICAgICAgICAgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YnNjcmlwdGlvbklkLCAic2V0RGV2aWNlVG9EZXZpY2VTaGFyaW5nU3RhdHVzIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmcoc2hhcmluZywgc3Vic2NyaXB0aW9uSWQpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHVzZXItY2hvc2VuIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzIHNoYXJpbmcgcHJlZmVyZW5jZQogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFN1YnNjcmlwdGlvbiBpZCBvZiBzdWJzY3JpcHRpb24KICAgICAqIEByZXR1cm4gVGhlIGRldmljZSB0byBkZXZpY2Ugc3RhdHVzIHNoYXJpbmcgcHJlZmVyZW5jZQogICAgICovCiAgICBwdWJsaWMgQERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UgaW50IGdldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ1ByZWZlcmVuY2UoCiAgICAgICAgICAgIGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltnZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmddICsgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRJbnRlZ2VyU3Vic2NyaXB0aW9uUHJvcGVydHkoc3Vic2NyaXB0aW9uSWQsIEQyRF9TVEFUVVNfU0hBUklORywKICAgICAgICAgICAgICAgIEQyRF9TSEFSSU5HX0RJU0FCTEVELCBtQ29udGV4dCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGxpc3Qgb2YgY29udGFjdHMgdGhhdCBhbGxvdyBkZXZpY2UgdG8gZGV2aWNlIHN0YXR1cyBzaGFyaW5nIGZvciBhIHN1YnNjcmlwdGlvbiBJRC4KICAgICAqIFRoZSBzZXR0aW5nIGFwcCB1c2VzIHRoaXMgbWV0aG9kIHRvIGluZGljYXRlIHdpdGggd2hvbSB0aGV5IHdpc2ggdG8gc2hhcmUgZGV2aWNlIHRvIGRldmljZQogICAgICogc3RhdHVzIGluZm9ybWF0aW9uLgogICAgICogQHBhcmFtIGNvbnRhY3RzIFRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZwogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uIElEIGluIGRhdGFiYXNlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0cyhpbnQgc3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgIEBOb25OdWxsIExpc3Q8VXJpPiBjb250YWN0cykgewogICAgICAgIFN0cmluZyBjb250YWN0U3RyaW5nID0gc2VyaWFsaXplVXJpTGlzdHMoY29udGFjdHMpOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltzZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0c10gKyBjb250YWN0czogIiArIGNvbnRhY3RTdHJpbmcKICAgICAgICAgICAgICAgICAgICArICIgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YnNjcmlwdGlvbklkLCAic2V0RGV2aWNlVG9EZXZpY2VTaGFyaW5nU3RhdHVzIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+aVN1Yi5zZXREZXZpY2VUb0RldmljZVN0YXR1c1NoYXJpbmdDb250YWN0cyhzZXJpYWxpemVVcmlMaXN0cyhjb250YWN0cyksCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZy4KICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBTdWJzY3JpcHRpb24gaWQgb2Ygc3Vic2NyaXB0aW9uCiAgICAgKiBAcmV0dXJuIFRoZSBsaXN0IG9mIGNvbnRhY3RzIHRoYXQgYWxsb3cgZGV2aWNlIHRvIGRldmljZSBzdGF0dXMgc2hhcmluZwogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxVcmk+IGdldERldmljZVRvRGV2aWNlU3RhdHVzU2hhcmluZ0NvbnRhY3RzKAogICAgICAgICAgICBpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbZ2V0RGV2aWNlVG9EZXZpY2VTdGF0dXNTaGFyaW5nQ29udGFjdHNdICsgc3ViSWQ6ICIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRDb250YWN0c0Zyb21TdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJzY3JpcHRpb25JZCwKICAgICAgICAgICAgICAgIEQyRF9TVEFUVVNfU0hBUklOR19TRUxFQ1RFRF9DT05UQUNUUywgbUNvbnRleHQpOwogICAgfQoKICAgIC8qKgogICAgICogRE8gTk9UIFVTRS4KICAgICAqIFRoaXMgQVBJIGlzIGRlc2lnbmVkIGZvciBmZWF0dXJlcyB0aGF0IGFyZSBub3QgZmluaXNoZWQgYXQgdGhpcyBwb2ludC4gRG8gbm90IGNhbGwgdGhpcyBBUEkuCiAgICAgKiBAaGlkZQogICAgICogVE9ETyBiLzEzNTU0NzUxMjogZnVydGhlciBjbGVhbiB1cAogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRFbmFibGVkU3Vic2NyaXB0aW9uSWQoaW50IHNsb3RJbmRleCkgewogICAgICAgIGludCBzdWJJZCA9IElOVkFMSURfU1VCU0NSSVBUSU9OX0lEOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSWQgPSBpU3ViLmdldEVuYWJsZWRTdWJzY3JpcHRpb25JZChzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoImdldEVuYWJsZWRTdWJzY3JpcHRpb25JZCwgc3ViSWQgPSAiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzdWJJZDsKICAgIH0KCiAgICBwcml2YXRlIGludGVyZmFjZSBDYWxsSVN1Yk1ldGhvZEhlbHBlciB7CiAgICAgICAgaW50IGNhbGxNZXRob2QoSVN1YiBpU3ViKSB0aHJvd3MgUmVtb3RlRXhjZXB0aW9uOwogICAgfQoKICAgIHByaXZhdGUgaW50IHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKGludCBzdWJJZCwgU3RyaW5nIG1ldGhvZE5hbWUsCiAgICAgICAgICAgIENhbGxJU3ViTWV0aG9kSGVscGVyIGhlbHBlcikgewogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKHN1YklkKSkgewogICAgICAgICAgICBsb2dkKCJbIiArIG1ldGhvZE5hbWUgKyAiXSIgKyAiLSBmYWlsIik7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIGludCByZXN1bHQgPSAwOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaGVscGVyLmNhbGxNZXRob2QoaVN1Yik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IGFjdGl2ZSBkYXRhIHN1YnNjcmlwdGlvbiBpZC4gQWN0aXZlIGRhdGEgc3Vic2NyaXB0aW9uIHJlZmVycyB0byB0aGUgc3Vic2NyaXB0aW9uCiAgICAgKiBjdXJyZW50bHkgY2hvc2VuIHRvIHByb3ZpZGUgY2VsbHVsYXIgaW50ZXJuZXQgY29ubmVjdGlvbiB0byB0aGUgdXNlci4gVGhpcyBtYXkgYmUKICAgICAqIGRpZmZlcmVudCBmcm9tIGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKS4gRWcuIE9wcG9ydHVuaXN0aWNzIGRhdGEKICAgICAqCiAgICAgKiBTZWUge0BsaW5rIFBob25lU3RhdGVMaXN0ZW5lciNvbkFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZENoYW5nZWQoaW50KX0gZm9yIHRoZSBkZXRhaWxzLgogICAgICoKICAgICAqIEByZXR1cm4gQWN0aXZlIGRhdGEgc3Vic2NyaXB0aW9uIGlkIGlmIGFueSBpcyBjaG9zZW4sIG9yCiAgICAgKiBTdWJzY3JpcHRpb25NYW5hZ2VyLklOVkFMSURfU1VCU0NSSVBUSU9OX0lEIGlmIG5vdC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0QWN0aXZlRGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIHJldHVybiBzQWN0aXZlRGF0YVN1YklkQ2FjaGUucXVlcnkobnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBIZWxwZXIgbWV0aG9kIHRoYXQgcHV0cyBhIHN1YnNjcmlwdGlvbiBpZCBvbiBhbiBpbnRlbnQgd2l0aCB0aGUgY29uc3RhbnRzOgogICAgICogUGhvbmVDb25zdGFudC5TVUJTQ1JJUFRJT05fS0VZIGFuZCBTdWJzY3JpcHRpb25NYW5hZ2VyLkVYVFJBX1NVQlNDUklQVElPTl9JTkRFWC4KICAgICAqIEJvdGggY29uc3RhbnRzIGFyZSB1c2VkIHRvIHN1cHBvcnQgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuICBPbmNlIHdlIGtub3cgd2UgZ290IGFsbCBwbGFjZXMsCiAgICAgKiB3ZSBjYW4gcmVtb3ZlIFBob25lQ29uc3RhbnRzLlNVQlNDUklQVElPTl9LRVkuCiAgICAgKiBAcGFyYW0gaW50ZW50IEludGVudCB0byBwdXQgc3ViIGlkIG9uLgogICAgICogQHBhcmFtIHN1YklkIFN1YnNjcmlwdGlvbklkIHRvIHB1dCBvbiBpbnRlbnQuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIHB1dFN1YnNjcmlwdGlvbklkRXh0cmEoSW50ZW50IGludGVudCwgaW50IHN1YklkKSB7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFN1YnNjcmlwdGlvbk1hbmFnZXIuRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYLCBzdWJJZCk7CiAgICAgICAgaW50ZW50LnB1dEV4dHJhKFBob25lQ29uc3RhbnRzLlNVQlNDUklQVElPTl9LRVksIHN1YklkKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdFN1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0RFRkFVTFRfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdERhdGFTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9ERUZBVUxUX0RBVEFfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlRGVmYXVsdFNtc1N1YklkQ2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX0RFRkFVTFRfU01TX1NVQl9JRF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZUFjdGl2ZURhdGFTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9BQ1RJVkVfREFUQV9TVUJfSURfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVTbG90SW5kZXhDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbGxvd3MgYSB0ZXN0IHByb2Nlc3MgdG8gZGlzYWJsZSBjbGllbnQtc2lkZSBjYWNoaW5nIG9wZXJhdGlvbnMuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGRpc2FibGVDYWNoaW5nKCkgewogICAgICAgIHNEZWZhdWx0U3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzRGVmYXVsdERhdGFTdWJJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNBY3RpdmVEYXRhU3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzRGVmYXVsdFNtc1N1YklkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc1Nsb3RJbmRleENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNQaG9uZUlkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDbGVhcnMgYWxsIHByb2Nlc3MtbG9jYWwgYmluZGVyIGNhY2hlcy4KICAgICAqCiAgICAgKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGNsZWFyQ2FjaGVzKCkgewogICAgICAgIHNEZWZhdWx0U3ViSWRDYWNoZS5jbGVhcigpOwogICAgICAgIHNEZWZhdWx0RGF0YVN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzQWN0aXZlRGF0YVN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzRGVmYXVsdFNtc1N1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzU2xvdEluZGV4Q2FjaGUuY2xlYXIoKTsKICAgICAgICBzUGhvbmVJZENhY2hlLmNsZWFyKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsZWQgdG8gcmV0cmlldmUgU0lNLXNwZWNpZmljIHNldHRpbmdzIGRhdGEgdG8gYmUgYmFja2VkIHVwLgogICAgICoKICAgICAqIEByZXR1cm4gZGF0YSBpbiBieXRlW10gdG8gYmUgYmFja2VkIHVwLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGJ5dGVbXSBnZXRBbGxTaW1TcGVjaWZpY1NldHRpbmdzRm9yQmFja3VwKCkgewogICAgICAgIEJ1bmRsZSBidW5kbGUgPSAgbUNvbnRleHQuZ2V0Q29udGVudFJlc29sdmVyKCkuY2FsbCgKICAgICAgICAgICAgICAgIFNJTV9JTkZPX0JBQ0tVUF9BTkRfUkVTVE9SRV9DT05URU5UX1VSSSwKICAgICAgICAgICAgICAgIEdFVF9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUUsIG51bGwsIG51bGwpOwogICAgICAgIHJldHVybiBidW5kbGUuZ2V0Qnl0ZUFycmF5KFN1YnNjcmlwdGlvbk1hbmFnZXIuS0VZX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19EQVRBKTsKICAgIH0KCiAgICAvKioKICAgICAqIENhbGxlZCB0byBhdHRlbXB0IHRvIHJlc3RvcmUgdGhlIGJhY2tlZCB1cCBzaW0tc3BlY2lmaWMgY29uZmlncyB0byBkZXZpY2UgZm9yIHNwZWNpZmljIHNpbS4KICAgICAqIFRoaXMgd2lsbCB0cnkgdG8gcmVzdG9yZSB0aGUgZGF0YSB0aGF0IHdhcyBzdG9yZWQgaW50ZXJuYWxseSB3aGVuIHtAbGluawogICAgICogI3Jlc3RvcmVBbGxTaW1TcGVjaWZpY1NldHRpbmdzRnJvbUJhY2t1cChieXRlW10gZGF0YSl9IHdhcyBjYWxsZWQgZHVyaW5nIHNldHVwIHdpemFyZC4KICAgICAqIEVuZCByZXN1bHQgaXMgU2ltSW5mb0RCIGlzIG1vZGlmaWVkIHRvIG1hdGNoIGFueSBiYWNrZWQgdXAgY29uZmlncyBmb3IgdGhlIHJlcXVlc3RlZAogICAgICogaW5zZXJ0ZWQgc2ltLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayBVcml9IHtAbGluayAjU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJfSBpcyBub3RpZmllZCBpZiBhbnkgU2ltSW5mb0RCCiAgICAgKiBlbnRyeSBpcyB1cGRhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2QgY2FsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gaWNjSWQgb2YgdGhlIHNpbSB0aGF0IGEgcmVzdG9yZSBpcyByZXF1ZXN0ZWQgZm9yLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCByZXN0b3JlU2ltU3BlY2lmaWNTZXR0aW5nc0ZvckljY0lkRnJvbUJhY2t1cChATm9uTnVsbCBTdHJpbmcgaWNjSWQpIHsKICAgICAgICBtQ29udGV4dC5nZXRDb250ZW50UmVzb2x2ZXIoKS5jYWxsKAogICAgICAgICAgICAgICAgU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJLAogICAgICAgICAgICAgICAgUkVTVE9SRV9TSU1fU1BFQ0lGSUNfU0VUVElOR1NfTUVUSE9EX05BTUUsCiAgICAgICAgICAgICAgICBpY2NJZCwgbnVsbCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsZWQgZHVyaW5nIHNldHVwIHdpemFyZCByZXN0b3JlIGZsb3cgdG8gYXR0ZW1wdCB0byByZXN0b3JlIHRoZSBiYWNrZWQgdXAgc2ltLXNwZWNpZmljCiAgICAgKiBjb25maWdzIHRvIGRldmljZSBmb3IgYWxsIGV4aXN0aW5nIFNJTXMgaW4gU2ltSW5mb0RCLiBJbnRlcm5hbGx5LCBpdCB3aWxsIHN0b3JlIHRoZSBiYWNrdXAKICAgICAqIGRhdGEgaW4gYW4gaW50ZXJuYWwgZmlsZS4gVGhpcyBmaWxlIHdpbGwgcGVyc2lzdCBvbiBkZXZpY2UgZm9yIGRldmljZSdzIGxpZmV0aW1lIGFuZCB3aWxsIGJlCiAgICAgKiB1c2VkIGxhdGVyIG9uIHdoZW4gYSBTSU0gaXMgaW5zZXJ0ZWQgdG8gcmVzdG9yZSB0aGF0IHNwZWNpZmljIFNJTSdzIHNldHRpbmdzIGJ5IGNhbGxpbmcKICAgICAqIHtAbGluayAjcmVzdG9yZVNpbVNwZWNpZmljU2V0dGluZ3NGb3JJY2NJZEZyb21CYWNrdXAoU3RyaW5nIGljY0lkKX0uIEVuZCByZXN1bHQgaXMKICAgICAqIFNpbUluZm9EQiBpcyBtb2RpZmllZCB0byBtYXRjaCBhbnkgYmFja2VkIHVwIGNvbmZpZ3MgZm9yIHRoZSBhcHByb3ByaWF0ZSBpbnNlcnRlZCBTSU1zLgogICAgICoKICAgICAqIDxwPgogICAgICogVGhlIHtAbGluayBVcml9IHtAbGluayAjU0lNX0lORk9fQkFDS1VQX0FORF9SRVNUT1JFX0NPTlRFTlRfVVJJfSBpcyBub3RpZmllZCBpZiBhbnkgU2ltSW5mb0RCCiAgICAgKiBlbnRyeSBpcyB1cGRhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2QgY2FsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gZGF0YSB3aXRoIHRoZSBzaW0gc3BlY2lmaWMgY29uZmlncyB0byBiZSBiYWNrZWQgdXAuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHJlc3RvcmVBbGxTaW1TcGVjaWZpY1NldHRpbmdzRnJvbUJhY2t1cChATm9uTnVsbCBieXRlW10gZGF0YSkgewogICAgICAgIEJ1bmRsZSBidW5kbGUgPSBuZXcgQnVuZGxlKCk7CiAgICAgICAgYnVuZGxlLnB1dEJ5dGVBcnJheShLRVlfU0lNX1NQRUNJRklDX1NFVFRJTkdTX0RBVEEsIGRhdGEpOwogICAgICAgIG1Db250ZXh0LmdldENvbnRlbnRSZXNvbHZlcigpLmNhbGwoCiAgICAgICAgICAgICAgICBTSU1fSU5GT19CQUNLVVBfQU5EX1JFU1RPUkVfQ09OVEVOVF9VUkksCiAgICAgICAgICAgICAgICBSRVNUT1JFX1NJTV9TUEVDSUZJQ19TRVRUSU5HU19NRVRIT0RfTkFNRSwKICAgICAgICAgICAgICAgIG51bGwsIGJ1bmRsZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBwaG9uZSBudW1iZXIgZm9yIHRoZSBnaXZlbiB7QGNvZGUgc3Vic2NyaXB0aW9uSWR9IGFuZCB7QGNvZGUgc291cmNlfSwKICAgICAqIG9yIGFuIGVtcHR5IHN0cmluZyBpZiBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPkdlbmVyYWwgYXBwcyB0aGF0IG5lZWQgdG8ga25vdyB0aGUgcGhvbmUgbnVtYmVyIHNob3VsZCB1c2Uge0BsaW5rICNnZXRQaG9uZU51bWJlcihpbnQpfQogICAgICogaW5zdGVhZC4gVGhpcyBBUEkgbWF5IGJlIHN1aXRhYmxlIHNwZWNpZmljIGFwcHMgdGhhdCBuZWVkcyB0byBrbm93IHRoZSBwaG9uZSBudW1iZXIgZnJvbQogICAgICogYSBzcGVjaWZpYyBzb3VyY2UuIEZvciBleGFtcGxlLCBhIGNhcnJpZXIgYXBwIG5lZWRzIHRvIGtub3cgZXhhY3RseSB3aGF0J3Mgb24KICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDIFVJQ0N9IGFuZCBkZWNpZGUgaWYgdGhlIHByZXZpb3VzbHkgc2V0IHBob25lIG51bWJlcgogICAgICogb2Ygc291cmNlIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSIGNhcnJpZXJ9IHNob3VsZCBiZSB1cGRhdGVkLgogICAgICoKICAgICAqIDxwPlRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0IGNhbiB2YXJ5CiAgICAgKiBkZXBlbmRpbmcgb24gdGhlIHtAY29kZSBzb3VyY2V9IGFuZCB0aGUgbmV0d29yayBldGMuIFByb2dyYW1tYXRpYyBwYXJzaW5nIHNob3VsZCBiZSBkb25lCiAgICAgKiBjYXV0aW91c2x5LCBmb3IgZXhhbXBsZSwgYWZ0ZXIgZm9ybWF0dGluZyB0aGUgbnVtYmVyIHRvIGEgY29uc2lzdGVudCBmb3JtYXQgd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+Tm90ZSB0aGUgYXNzdW1wdGlvbiBpcyB0aGF0IG9uZSBzdWJzY3JpcHRpb24gKHdoaWNoIHVzdWFsbHkgbWVhbnMgb25lIFNJTSkgaGFzCiAgICAgKiBvbmx5IG9uZSBwaG9uZSBudW1iZXIuIFRoZSBtdWx0aXBsZSBzb3VyY2VzIGJhY2t1cCBlYWNoIG90aGVyIHNvIGhvcGVmdWxseSBhdCBsZWFzdCBvbmUKICAgICAqIGlzIGF2YWlsYXZsZS4gRm9yIGV4YW1wbGUsIGZvciBhIGNhcnJpZXIgdGhhdCBkb2Vzbid0IHR5cGljYWxseSBzZXQgcGhvbmUgbnVtYmVycwogICAgICogb24ge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MgVUlDQ30sIHRoZSBzb3VyY2Uge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0lNUyBJTVN9CiAgICAgKiBtYXkgcHJvdmlkZSBvbmUuIE9yLCBhIGNhcnJpZXIgbWF5IGRlY2lkZSB0byBwcm92aWRlIHRoZSBwaG9uZSBudW1iZXIgdmlhIHNvdXJjZQogICAgICoge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIgY2Fycmllcn0gaWYgbmVpdGhlciBzb3VyY2UgVUlDQyBub3IgSU1TIGlzIGF2YWlsYWJsZS4KICAgICAqCiAgICAgKiA8cD5UaGUgYXZhaWxhYmlsaXR5IGFuZCBjb3JyZWN0bmVzcyBvZiB0aGUgcGhvbmUgbnVtYmVyIGRlcGVuZHMgb24gdGhlIHVuZGVybHlpbmcgc291cmNlCiAgICAgKiBhbmQgdGhlIG5ldHdvcmsgZXRjLiBBZGRpdGlvbmFsIHZlcmlmaWNhdGlvbiBpcyBuZWVkZWQgdG8gdXNlIHRoaXMgbnVtYmVyIGZvcgogICAgICogc2VjdXJpdHktcmVsYXRlZCBvciBvdGhlciBzZW5zaXRpdmUgc2NlbmFyaW9zLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgc3Vic2NyaXB0aW9uIElELCBvciB7QGxpbmsgI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfQogICAgICogICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZGVmYXVsdCBvbmUuCiAgICAgKiBAcGFyYW0gc291cmNlIHRoZSBzb3VyY2Ugb2YgdGhlIHBob25lIG51bWJlciwgb25lIG9mIHRoZSBQSE9ORV9OVU1CRVJfU09VUkNFXyogY29uc3RhbnRzLgogICAgICogQHJldHVybiB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIHtAY29kZSBzb3VyY2V9IGlzIGludmFsaWQuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgdGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBoYXZlIHBlcm1pc3Npb25zIHJlcXVpcmVkLgogICAgICogQHNlZSAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDCiAgICAgKiBAc2VlICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIKICAgICAqIEBzZWUgI1BIT05FX05VTUJFUl9TT1VSQ0VfSU1TCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW55T2YgPSB7CiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX05VTUJFUlMsCiAgICAgICAgICAgIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUsCiAgICAgICAgICAgICJjYXJyaWVyIHByaXZpbGVnZXMiLAogICAgfSkKICAgIEBOb25OdWxsCiAgICBwdWJsaWMgU3RyaW5nIGdldFBob25lTnVtYmVyKGludCBzdWJzY3JpcHRpb25JZCwgQFBob25lTnVtYmVyU291cmNlIGludCBzb3VyY2UpIHsKICAgICAgICBpZiAoc3Vic2NyaXB0aW9uSWQgPT0gREVGQVVMVF9TVUJTQ1JJUFRJT05fSUQpIHsKICAgICAgICAgICAgc3Vic2NyaXB0aW9uSWQgPSBnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX1VJQ0MKICAgICAgICAgICAgICAgICYmIHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSAhPSBQSE9ORV9OVU1CRVJfU09VUkNFX0lNUykgewogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJpbnZhbGlkIHNvdXJjZSAiICsgc291cmNlKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpU3ViLmdldFBob25lTnVtYmVyKHN1YnNjcmlwdGlvbklkLCBzb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJzdWJzY3JpcHRpb24gc2VydmljZSB1bmF2YWlsYWJsZS4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICB0aHJvdyBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgcGhvbmUgbnVtYmVyIGZvciB0aGUgZ2l2ZW4ge0Bjb2RlIHN1YklkfSwgb3IgYW4gZW1wdHkgc3RyaW5nIGlmCiAgICAgKiBub3QgYXZhaWxhYmxlLgogICAgICoKICAgICAqIDxwPlRoaXMgQVBJIGlzIHN1aXRhYmxlIGZvciBnZW5lcmFsIGFwcHMgdGhhdCBuZWVkcyB0byBrbm93IHRoZSBwaG9uZSBudW1iZXIuCiAgICAgKiBGb3Igc3BlY2lmaWMgYXBwcyB0aGF0IG5lZWRzIHRvIGtub3cgdGhlIHBob25lIG51bWJlciBwcm92aWRlZCBieSBhIHNwZWNpZmljIHNvdXJjZSwKICAgICAqIHtAbGluayAjZ2V0UGhvbmVOdW1iZXIoaW50LCBpbnQpfSBtYXkgYmUgc3VpdGFibGUuCiAgICAgKgogICAgICogPHA+VGhpcyBBUEkgaXMgYnVpbHQgdXAgb24ge0BsaW5rICNnZXRQaG9uZU51bWJlcihpbnQsIGludCl9LCBidXQgcGlja3MKICAgICAqIGZyb20gYXZhaWxhYmxlIHNvdXJjZXMgaW4gdGhlIGZvbGxvd2luZyBvcmRlcjoge0BsaW5rICNQSE9ORV9OVU1CRVJfU09VUkNFX0NBUlJJRVJ9CiAgICAgKiA+IHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9VSUNDfSA+IHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9JTVN9LgogICAgICoKICAgICAqIDxwPlRoZSBBUEkgcHJvdmlkZXMgbm8gZ3VhcmFudGVlcyBvZiB3aGF0IGZvcm1hdCB0aGUgbnVtYmVyIGlzIGluOiB0aGUgZm9ybWF0IGNhbiB2YXJ5CiAgICAgKiBkZXBlbmRpbmcgb24gdGhlIHVuZGVybHlpbmcgc291cmNlIGFuZCB0aGUgbmV0d29yayBldGMuIFByb2dyYW1tYXRpYyBwYXJzaW5nIHNob3VsZCBiZSBkb25lCiAgICAgKiBjYXV0aW91c2x5LCBmb3IgZXhhbXBsZSwgYWZ0ZXIgZm9ybWF0dGluZyB0aGUgbnVtYmVyIHRvIGEgY29uc2lzdGVudCBmb3JtYXQgd2l0aAogICAgICoge0BsaW5rIGFuZHJvaWQudGVsZXBob255LlBob25lTnVtYmVyVXRpbHMjZm9ybWF0TnVtYmVyVG9FMTY0KFN0cmluZywgU3RyaW5nKX0uCiAgICAgKgogICAgICogPHA+VGhlIGF2YWlsYWJpbGl0eSBhbmQgY29ycmVjdG5lc3Mgb2YgdGhlIHBob25lIG51bWJlciBkZXBlbmRzIG9uIHRoZSB1bmRlcmx5aW5nIHNvdXJjZQogICAgICogYW5kIHRoZSBuZXR3b3JrIGV0Yy4gQWRkaXRpb25hbCB2ZXJpZmljYXRpb24gaXMgbmVlZGVkIHRvIHVzZSB0aGlzIG51bWJlciBmb3IKICAgICAqIHNlY3VyaXR5LXJlbGF0ZWQgb3Igb3RoZXIgc2Vuc2l0aXZlIHNjZW5hcmlvcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3Ige0BsaW5rICNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGRlZmF1bHQgb25lLgogICAgICogQHJldHVybiB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgbm90IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIHRoZSB0ZWxlcGhvbnkgcHJvY2VzcyBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbnMgcmVxdWlyZWQuCiAgICAgKiBAc2VlICNnZXRQaG9uZU51bWJlcihpbnQsIGludCkKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbnlPZiA9IHsKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfTlVNQkVSUywKICAgICAgICAgICAgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSwKICAgICAgICAgICAgImNhcnJpZXIgcHJpdmlsZWdlcyIsCiAgICB9KQogICAgQE5vbk51bGwKICAgIHB1YmxpYyBTdHJpbmcgZ2V0UGhvbmVOdW1iZXIoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbklkID09IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkID0gZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5nZXRQaG9uZU51bWJlckZyb21GaXJzdEF2YWlsYWJsZVNvdXJjZShzdWJzY3JpcHRpb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInN1YnNjcmlwdGlvbiBzZXJ2aWNlIHVuYXZhaWxhYmxlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIHRocm93IGV4LnJldGhyb3dBc1J1bnRpbWVFeGNlcHRpb24oKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBwaG9uZSBudW1iZXIgZm9yIHRoZSBnaXZlbiB7QGNvZGUgc3ViSWR9IGZvciBzb3VyY2UKICAgICAqIHtAbGluayAjUEhPTkVfTlVNQkVSX1NPVVJDRV9DQVJSSUVSIGNhcnJpZXJ9LgogICAgICogU2V0cyBhbiBlbXB0eSBzdHJpbmcgdG8gcmVtb3ZlIHRoZSBwcmV2aW91c2x5IHNldCBwaG9uZSBudW1iZXIuCiAgICAgKgogICAgICogPHA+VGhlIEFQSSBpcyBzdWl0YWJsZSBmb3IgY2FycmllciBhcHBzIHRvIHByb3ZpZGUgYSBwaG9uZSBudW1iZXIsIGZvciBleGFtcGxlIHdoZW4KICAgICAqIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVwZGF0ZSB7QGxpbmsgI1BIT05FX05VTUJFUl9TT1VSQ0VfVUlDQyBVSUNDfSBkaXJlY3RseS4KICAgICAqCiAgICAgKiA8cD5JdCdzIHJlY29tbWVuZGVkIHRoYXQgdGhlIHBob25lIG51bWJlciBpcyBmb3JtYXR0ZWQgdG8gd2VsbC1rbm93biBmb3JtYXRzLAogICAgICogZm9yIGV4YW1wbGUsIGJ5IHtAbGluayBQaG9uZU51bWJlclV0aWxzfSB7QGNvZGUgZm9ybWF0TnVtYmVyKn0gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRCwgb3Ige0BsaW5rICNERUZBVUxUX1NVQlNDUklQVElPTl9JRH0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGRlZmF1bHQgb25lLgogICAgICogQHBhcmFtIG51bWJlciB0aGUgcGhvbmUgbnVtYmVyLCBvciBhbiBlbXB0eSBzdHJpbmcgdG8gcmVtb3ZlIHRoZSBwcmV2aW91c2x5IHNldCBudW1iZXIuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiB0aGUgdGVsZXBob255IHByb2Nlc3MgaXMgbm90IGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiBAdGhyb3dzIE51bGxQb2ludGVyRXhjZXB0aW9uIGlmIHtAY29kZSBudW1iZXJ9IGlzIHtAY29kZSBudWxsfS4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbnMgcmVxdWlyZWQuCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oImNhcnJpZXIgcHJpdmlsZWdlcyIpCiAgICBwdWJsaWMgdm9pZCBzZXRDYXJyaWVyUGhvbmVOdW1iZXIoaW50IHN1YnNjcmlwdGlvbklkLCBATm9uTnVsbCBTdHJpbmcgbnVtYmVyKSB7CiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbklkID09IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEKSB7CiAgICAgICAgICAgIHN1YnNjcmlwdGlvbklkID0gZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXIgPT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oImludmFsaWQgbnVtYmVyIG51bGwiKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0UGhvbmVOdW1iZXIoc3Vic2NyaXB0aW9uSWQsIFBIT05FX05VTUJFUl9TT1VSQ0VfQ0FSUklFUiwgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigic3Vic2NyaXB0aW9uIHNlcnZpY2UgdW5hdmFpbGFibGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgdGhyb3cgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNldCB0aGUgcHJlZmVycmVkIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogVGhlIGNlbGx1bGFyIHVzYWdlIHNldHRpbmcgaXMgYSBzd2l0Y2ggd2hpY2ggY29udHJvbHMgdGhlIG1vZGUgb2Ygb3BlcmF0aW9uIGZvciB0aGUgY2VsbHVsYXIKICAgICAqIHJhZGlvIHRvIGVpdGhlciByZXF1aXJlIG9yIG5vdCByZXF1aXJlIHZvaWNlIHNlcnZpY2UuIEl0IGlzIG5vdCBtYW5hZ2VkIHZpYSBBbmRyb2lk4oCZcwogICAgICogU2V0dGluZ3MuCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJJZCBvZiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIHVzYWdlU2V0dGluZyB0aGUgcmVxdWVzdGVkIHVzYWdlIHNldHRpbmcuCiAgICAgKgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgYSBzcGVjaWZpYyBtb2RlIG9yIHNldHRpbmcgdGhlIG1vZGUgaXMgbm90IHN1cHBvcnRlZCBvbiBhCiAgICAgKiBwYXJ0aWN1bGFyIGRldmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBDYXJyaWVyUHJpdmlsZWdlcyBmb3IgdGhlIGdpdmVuIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCB3aWxsIG5vdCBhbGxvdyB0aGUgc2V0dGluZyBvZiBVU0FHRV9TRVRUSU5HX1VOS05PV04uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHZvaWQgc2V0VXNhZ2VTZXR0aW5nKGludCBzdWJzY3JpcHRpb25JZCwgQFVzYWdlU2V0dGluZyBpbnQgdXNhZ2VTZXR0aW5nKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltzZXRVc2FnZVNldHRpbmddKyBzZXR0aW5nOiIgKyB1c2FnZVNldHRpbmcgKyAiIHN1YklkOiIgKyBzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3Vic2NyaXB0aW9uSWQsICJzZXRVc2FnZVNldHRpbmciLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXRVc2FnZVNldHRpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIHVzYWdlU2V0dGluZywgc3Vic2NyaXB0aW9uSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSkpOwogICAgfQp9Cgo=</text>
      </register>
      <register name="2" type="2">
        <text encoding="base64">LyoKICogQ29weXJpZ2h0IChDKSAyMDE0IFRoZSBBbmRyb2lkIE9wZW4gU291cmNlIFByb2plY3QKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBhbmRyb2lkLnRlbGVwaG9ueTsKCmltcG9ydCBzdGF0aWMgYW5kcm9pZC5uZXQuTmV0d29ya1BvbGljeU1hbmFnZXIuU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRDsKaW1wb3J0IHN0YXRpYyBhbmRyb2lkLm5ldC5OZXR3b3JrUG9saWN5TWFuYWdlci5TVUJTQ1JJUFRJT05fT1ZFUlJJREVfVU5NRVRFUkVEOwoKaW1wb3J0IGFuZHJvaWQuTWFuaWZlc3Q7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uQ2FsbGJhY2tFeGVjdXRvcjsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5Db2xvckludDsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5EdXJhdGlvbk1pbGxpc0xvbmc7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uSW50RGVmOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLk5vbk51bGw7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uTnVsbGFibGU7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uUmVxdWlyZXNQZXJtaXNzaW9uOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlNka0NvbnN0YW50OwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlNka0NvbnN0YW50LlNka0NvbnN0YW50VHlwZTsKaW1wb3J0IGFuZHJvaWQuYW5ub3RhdGlvbi5TdXBwcmVzc0F1dG9Eb2M7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uU3lzdGVtQXBpOwppbXBvcnQgYW5kcm9pZC5hbm5vdGF0aW9uLlN5c3RlbVNlcnZpY2U7CmltcG9ydCBhbmRyb2lkLmFubm90YXRpb24uVGVzdEFwaTsKaW1wb3J0IGFuZHJvaWQuYXBwLlBlbmRpbmdJbnRlbnQ7CmltcG9ydCBhbmRyb2lkLmFwcC5Qcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU7CmltcG9ydCBhbmRyb2lkLmNvbXBhdC5hbm5vdGF0aW9uLlVuc3VwcG9ydGVkQXBwVXNhZ2U7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQuQ29udGV4dDsKaW1wb3J0IGFuZHJvaWQuY29udGVudC5JbnRlbnQ7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZUluZm87CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZU1hbmFnZXI7CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucmVzLkNvbmZpZ3VyYXRpb247CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucmVzLlJlc291cmNlczsKaW1wb3J0IGFuZHJvaWQuZGF0YWJhc2UuQ29udGVudE9ic2VydmVyOwppbXBvcnQgYW5kcm9pZC5uZXQuTmV0d29ya0NhcGFiaWxpdGllczsKaW1wb3J0IGFuZHJvaWQubmV0Lk5ldHdvcmtQb2xpY3lNYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC5uZXQuVXJpOwppbXBvcnQgYW5kcm9pZC5vcy5CaW5kZXI7CmltcG9ydCBhbmRyb2lkLm9zLkJ1aWxkOwppbXBvcnQgYW5kcm9pZC5vcy5IYW5kbGVyOwppbXBvcnQgYW5kcm9pZC5vcy5Mb29wZXI7CmltcG9ydCBhbmRyb2lkLm9zLlBhcmNlbFV1aWQ7CmltcG9ydCBhbmRyb2lkLm9zLlByb2Nlc3M7CmltcG9ydCBhbmRyb2lkLm9zLlJlbW90ZUV4Y2VwdGlvbjsKaW1wb3J0IGFuZHJvaWQucHJvdmlkZXIuVGVsZXBob255LlNpbUluZm87CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5ldWljYy5FdWljY01hbmFnZXI7CmltcG9ydCBhbmRyb2lkLnRlbGVwaG9ueS5pbXMuSW1zTW1UZWxNYW5hZ2VyOwppbXBvcnQgYW5kcm9pZC51dGlsLkxvZzsKaW1wb3J0IGFuZHJvaWQudXRpbC5QYWlyOwoKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5JU2V0T3Bwb3J0dW5pc3RpY0RhdGFDYWxsYmFjazsKaW1wb3J0IGNvbS5hbmRyb2lkLmludGVybmFsLnRlbGVwaG9ueS5JU3ViOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LlBob25lQ29uc3RhbnRzOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudGVsZXBob255LnV0aWwuSGFuZGxlckV4ZWN1dG9yOwppbXBvcnQgY29tLmFuZHJvaWQuaW50ZXJuYWwudXRpbC5GdW5jdGlvbmFsVXRpbHM7CmltcG9ydCBjb20uYW5kcm9pZC5pbnRlcm5hbC51dGlsLlByZWNvbmRpdGlvbnM7CmltcG9ydCBjb20uYW5kcm9pZC50ZWxlcGhvbnkuUmxvZzsKCmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb247CmltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5SZXRlbnRpb25Qb2xpY3k7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkFycmF5czsKaW1wb3J0IGphdmEudXRpbC5Db2xsZWN0aW9uczsKaW1wb3J0IGphdmEudXRpbC5IYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLkxpc3Q7CmltcG9ydCBqYXZhLnV0aWwuTG9jYWxlOwppbXBvcnQgamF2YS51dGlsLk1hcDsKaW1wb3J0IGphdmEudXRpbC5jb25jdXJyZW50LkNvbmN1cnJlbnRIYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLmNvbmN1cnJlbnQuRXhlY3V0b3I7CmltcG9ydCBqYXZhLnV0aWwuZnVuY3Rpb24uQ29uc3VtZXI7CmltcG9ydCBqYXZhLnV0aWwuc3RyZWFtLkNvbGxlY3RvcnM7CgovKioKICogU3Vic2NyaXB0aW9uTWFuYWdlciBpcyB0aGUgYXBwbGljYXRpb24gaW50ZXJmYWNlIHRvIFN1YnNjcmlwdGlvbkNvbnRyb2xsZXIKICogYW5kIHByb3ZpZGVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IFRlbGVwaG9ueSBTdWJzY3JpcHRpb25zLgogKi8KQFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfU1VCU0NSSVBUSU9OX1NFUlZJQ0UpCnB1YmxpYyBjbGFzcyBTdWJzY3JpcHRpb25NYW5hZ2VyIHsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIFN0cmluZyBMT0dfVEFHID0gIlN1YnNjcmlwdGlvbk1hbmFnZXIiOwogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgYm9vbGVhbiBEQkcgPSBmYWxzZTsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGJvb2xlYW4gVkRCRyA9IGZhbHNlOwoKICAgIC8qKiBBbiBpbnZhbGlkIHN1YnNjcmlwdGlvbiBpZGVudGlmaWVyICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJTlZBTElEX1NVQlNDUklQVElPTl9JRCA9IC0xOwoKICAgIC8qKiBCYXNlIHZhbHVlIGZvciBEdW1teSBTVUJTQ1JJUFRJT05fSUQncy4gKi8KICAgIC8qKiBGSVhNRTogUmVtb3ZlIER1bW15U3ViSWQncywgYnV0IGZvciBub3cgaGF2ZSB0aGVtIG1hcCBqdXN0IGJlbG93IElOVkFMSURfU1VCU0NSSVBUSU9OX0lECiAgICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEVU1NWV9TVUJTQ1JJUFRJT05fSURfQkFTRSA9IElOVkFMSURfU1VCU0NSSVBUSU9OX0lEIC0gMTsKCiAgICAvKiogQW4gaW52YWxpZCBwaG9uZSBpZGVudGlmaWVyICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElOVkFMSURfUEhPTkVfSU5ERVggPSAtMTsKCiAgICAvKiogSW5kaWNhdGVzIGludmFsaWQgc2ltIHNsb3QuIFRoaXMgY2FuIGJlIHJldHVybmVkIGJ5IHtAbGluayAjZ2V0U2xvdEluZGV4KGludCl9LiAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSU5WQUxJRF9TSU1fU0xPVF9JTkRFWCA9IC0xOwoKICAgIC8qKiBJbmRpY2F0ZXMgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9uIElEIGluIFRlbGVwaG9ueS4gKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqCiAgICAgKiBJbmRpY2F0ZXMgdGhlIGNhbGxlciB3YW50cyB0aGUgZGVmYXVsdCBwaG9uZSBpZC4KICAgICAqIFVzZWQgaW4gU3Vic2NyaXB0aW9uQ29udHJvbGxlciBhbmQgUGhvbmUgYnV0IGRvIHdlIHJlYWxseSBuZWVkIGl0Pz8/CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUZBVUxUX1BIT05FX0lOREVYID0gSW50ZWdlci5NQVhfVkFMVUU7CgogICAgLyoqIEluZGljYXRlcyB0aGUgY2FsbGVyIHdhbnRzIHRoZSBkZWZhdWx0IHNsb3QgaWQuIE5PVCB1c2VkIHJlbW92ZT8gKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgREVGQVVMVF9TSU1fU0xPVF9JTkRFWCA9IEludGVnZXIuTUFYX1ZBTFVFOwoKICAgIC8qKiBNaW5pbXVtIHBvc3NpYmxlIHN1YmlkIHRoYXQgcmVwcmVzZW50cyBhIHN1YnNjcmlwdGlvbiAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNSU5fU1VCU0NSSVBUSU9OX0lEX1ZBTFVFID0gMDsKCiAgICAvKiogTWF4aW11bSBwb3NzaWJsZSBzdWJpZCB0aGF0IHJlcHJlc2VudHMgYSBzdWJzY3JpcHRpb24gKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTUFYX1NVQlNDUklQVElPTl9JRF9WQUxVRSA9IERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEIC0gMTsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBDT05URU5UX1VSSSA9IFNpbUluZm8uQ09OVEVOVF9VUkk7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfREVGQVVMVF9TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfZGVmYXVsdF9zdWJfaWQiOwoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0FDSEVfS0VZX0RFRkFVTFRfREFUQV9TVUJfSURfUFJPUEVSVFkgPQogICAgICAgICAgICAiY2FjaGVfa2V5LnRlbGVwaG9ueS5nZXRfZGVmYXVsdF9kYXRhX3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfREVGQVVMVF9TTVNfU1VCX0lEX1BST1BFUlRZID0KICAgICAgICAgICAgImNhY2hlX2tleS50ZWxlcGhvbnkuZ2V0X2RlZmF1bHRfc21zX3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfQUNUSVZFX0RBVEFfU1VCX0lEX1BST1BFUlRZID0KICAgICAgICAgICAgImNhY2hlX2tleS50ZWxlcGhvbnkuZ2V0X2FjdGl2ZV9kYXRhX3N1Yl9pZCI7CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSA9CiAgICAgICAgICAgICJjYWNoZV9rZXkudGVsZXBob255LmdldF9zbG90X2luZGV4IjsKCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpbnQgTUFYX0NBQ0hFX1NJWkUgPSA0OwoKICAgIHByaXZhdGUgc3RhdGljIGNsYXNzIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8VD4KICAgICAgICAgICAgZXh0ZW5kcyBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8Vm9pZCwgVD4gewogICAgICAgIHByaXZhdGUgZmluYWwgRnVuY3Rpb25hbFV0aWxzLlRocm93aW5nRnVuY3Rpb248SVN1YiwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0Z1bmN0aW9uPElTdWIsIFQ+IHN1YnNjcmlwdGlvbkludGVyZmFjZU1ldGhvZCwKICAgICAgICAgICAgICAgIFN0cmluZyBjYWNoZUtleVByb3BlcnR5LAogICAgICAgICAgICAgICAgVCBkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgICAgc3VwZXIoTUFYX0NBQ0hFX1NJWkUsIGNhY2hlS2V5UHJvcGVydHkpOwogICAgICAgICAgICBtSW50ZXJmYWNlTWV0aG9kID0gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kOwogICAgICAgICAgICBtQ2FjaGVLZXlQcm9wZXJ0eSA9IGNhY2hlS2V5UHJvcGVydHk7CiAgICAgICAgICAgIG1EZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQoKICAgICAgICBAT3ZlcnJpZGUKICAgICAgICBwcm90ZWN0ZWQgVCByZWNvbXB1dGUoVm9pZCBhVm9pZCkgewogICAgICAgICAgICBUIHJlc3VsdCA9IG1EZWZhdWx0VmFsdWU7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbUludGVyZmFjZU1ldGhvZC5hcHBseU9yVGhyb3coaVN1Yik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBjbGFzcyBJbnRlZ2VyUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPFQ+CiAgICAgICAgICAgIGV4dGVuZHMgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXIsIFQ+IHsKICAgICAgICBwcml2YXRlIGZpbmFsIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gbUludGVyZmFjZU1ldGhvZDsKICAgICAgICBwcml2YXRlIGZpbmFsIFN0cmluZyBtQ2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICBwcml2YXRlIGZpbmFsIFQgbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZSgKICAgICAgICAgICAgICAgIEZ1bmN0aW9uYWxVdGlscy5UaHJvd2luZ0JpRnVuY3Rpb248SVN1YiwgSW50ZWdlciwgVD4gc3Vic2NyaXB0aW9uSW50ZXJmYWNlTWV0aG9kLAogICAgICAgICAgICAgICAgU3RyaW5nIGNhY2hlS2V5UHJvcGVydHksCiAgICAgICAgICAgICAgICBUIGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgICBzdXBlcihNQVhfQ0FDSEVfU0laRSwgY2FjaGVLZXlQcm9wZXJ0eSk7CiAgICAgICAgICAgIG1JbnRlcmZhY2VNZXRob2QgPSBzdWJzY3JpcHRpb25JbnRlcmZhY2VNZXRob2Q7CiAgICAgICAgICAgIG1DYWNoZUtleVByb3BlcnR5ID0gY2FjaGVLZXlQcm9wZXJ0eTsKICAgICAgICAgICAgbURlZmF1bHRWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CgogICAgICAgIEBPdmVycmlkZQogICAgICAgIHByb3RlY3RlZCBUIHJlY29tcHV0ZShJbnRlZ2VyIHF1ZXJ5KSB7CiAgICAgICAgICAgIFQgcmVzdWx0ID0gbURlZmF1bHRWYWx1ZTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBtSW50ZXJmYWNlTWV0aG9kLmFwcGx5T3JUaHJvdyhpU3ViLCBxdWVyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJGYWlsZWQgdG8gcmVjb21wdXRlIGNhY2hlIGtleSBmb3IgIiArIG1DYWNoZUtleVByb3BlcnR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInJlY29tcHV0aW5nICIgKyBtQ2FjaGVLZXlQcm9wZXJ0eSArICIsIHJlc3VsdCA9ICIgKyByZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgVm9pZFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzRGVmYXVsdERhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXREZWZhdWx0RGF0YVN1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX0RBVEFfU1VCX0lEX1BST1BFUlRZLAogICAgICAgICAgICAgICAgICAgIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEKTsKCiAgICBwcml2YXRlIHN0YXRpYyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPEludGVnZXI+IHNEZWZhdWx0U21zU3ViSWRDYWNoZSA9CiAgICAgICAgICAgIG5ldyBWb2lkUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlPD4oSVN1Yjo6Z2V0RGVmYXVsdFNtc1N1YklkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFksCiAgICAgICAgICAgICAgICAgICAgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQpOwoKICAgIHByaXZhdGUgc3RhdGljIFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8SW50ZWdlcj4gc0FjdGl2ZURhdGFTdWJJZENhY2hlID0KICAgICAgICAgICAgbmV3IFZvaWRQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRBY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWQsCiAgICAgICAgICAgICAgICAgICAgQ0FDSEVfS0VZX0FDVElWRV9EQVRBX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NVQlNDUklQVElPTl9JRCk7CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzU2xvdEluZGV4Q2FjaGUgPQogICAgICAgICAgICBuZXcgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTw+KElTdWI6OmdldFNsb3RJbmRleCwKICAgICAgICAgICAgICAgICAgICBDQUNIRV9LRVlfU0xPVF9JTkRFWF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1NJTV9TTE9UX0lOREVYKTsKCiAgICAvKiogQ2FjaGUgZGVwZW5kcyBvbiBnZXREZWZhdWx0U3ViSWQsIHNvIHdlIHVzZSB0aGUgZGVmYXVsdFN1YklkIGNhY2hlIGtleSAqLwogICAgcHJpdmF0ZSBzdGF0aWMgSW50ZWdlclByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZTxJbnRlZ2VyPiBzUGhvbmVJZENhY2hlID0KICAgICAgICAgICAgbmV3IEludGVnZXJQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGU8PihJU3ViOjpnZXRQaG9uZUlkLAogICAgICAgICAgICAgICAgICAgIENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSwKICAgICAgICAgICAgICAgICAgICBJTlZBTElEX1BIT05FX0lOREVYKTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gc2ltSW5mbyBjaGFuZ2UKICAgICAqIG9uIHRoZSBnaXZlbiBzdWJzY3JpcHRpb25JZAogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSBzdWJzY3JpcHRpb25JZCB0byByZWNlaXZlIHVwZGF0ZXMgb24KICAgICAqIEByZXR1cm4gdGhlIFVyaSB1c2VkIHRvIG9ic2VydmUgY2FycmllciBpZGVudGl0eSBjaGFuZ2VzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIFVyaSBnZXRVcmlGb3JTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gVXJpLndpdGhBcHBlbmRlZFBhdGgoQ09OVEVOVF9VUkksIFN0cmluZy52YWx1ZU9mKHN1YnNjcmlwdGlvbklkKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIGVuYWJsZWQgdXNlciBzZXR0aW5nLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiB3ZmMgZW5hYmxlZCB7QGxpbmsgSW1zTW1UZWxNYW5hZ2VyI2lzVm9XaUZpU2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAKICAgICAqIGlzIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlIHtAbGluayBVcml9IGV2ZW4gd2hlbiBpdCBpcyBub3QgcnVubmluZy4KICAgICAqIE5vdGUsIGhvd2V2ZXIsIHRoYXQgdXNpbmcgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IGRvZXMgbm90IGd1YXJhbnRlZSB0aW1lbHkKICAgICAqIGRlbGl2ZXJ5IG9mIHVwZGF0ZXMgdG8gdGhlIHtAbGluayBVcml9LgogICAgICogVG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byBhIHNwZWNpZmljIHN1YklkLCBhcHBlbmQgc3ViSWQgdG8gdGhlIFVSSQogICAgICoge0BsaW5rIFVyaSN3aXRoQXBwZW5kZWRQYXRoKFVyaSwgU3RyaW5nKX0uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgQFRlc3RBcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgVXJpIFdGQ19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoQ09OVEVOVF9VUkksICJ3ZmMiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiBhZHZhbmNlZCBjYWxsaW5nIHVzZXIgc2V0dGluZwogICAgICogQHNlZSBJbXNNbVRlbE1hbmFnZXIjaXNBZHZhbmNlZENhbGxpbmdTZXR0aW5nRW5hYmxlZCgpLgogICAgICogPHA+CiAgICAgKiBVc2UgdGhpcyB7QGxpbmsgVXJpfSB3aXRoIGEge0BsaW5rIENvbnRlbnRPYnNlcnZlcn0gdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBhZHZhbmNlZCBjYWxsaW5nIGVuYWJsZWQKICAgICAqIHtAbGluayBJbXNNbVRlbE1hbmFnZXIjaXNBZHZhbmNlZENhbGxpbmdTZXR0aW5nRW5hYmxlZCgpfSB3aGlsZSB5b3VyIGFwcCBpcyBydW5uaW5nLgogICAgICogWW91IGNhbiBhbHNvIHVzZSBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlIHlvdXIgYXBwIGlzIG5vdGlmaWVkIG9mCiAgICAgKiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdCBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBBRFZBTkNFRF9DQUxMSU5HX0VOQUJMRURfQ09OVEVOVF9VUkkgPSBVcmkud2l0aEFwcGVuZGVkUGF0aCgKICAgICAgICAgICAgQ09OVEVOVF9VUkksICJhZHZhbmNlZF9jYWxsaW5nIik7CgogICAgLyoqCiAgICAgKiBBIGNvbnRlbnQge0BsaW5rIFVyaX0gdXNlZCB0byByZWNlaXZlIHVwZGF0ZXMgb24gd2ZjIG1vZGUgc2V0dGluZy4KICAgICAqIDxwPgogICAgICogVXNlIHRoaXMge0BsaW5rIFVyaX0gd2l0aCBhIHtAbGluayBDb250ZW50T2JzZXJ2ZXJ9IHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gdGhlCiAgICAgKiBzdWJzY3JpcHRpb24gd2ZjIG1vZGUge0BsaW5rIEltc01tVGVsTWFuYWdlciNnZXRWb1dpRmlNb2RlU2V0dGluZygpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdCBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKENPTlRFTlRfVVJJLCAid2ZjX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBtb2RlIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyByb2FtaW5nIG1vZGUge0BsaW5rIEltc01tVGVsTWFuYWdlciNnZXRWb1dpRmlSb2FtaW5nTW9kZVNldHRpbmcoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9CiAgICAgKiB0byBlbnN1cmUgeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBAVGVzdEFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgV0ZDX1JPQU1JTkdfTU9ERV9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgIndmY19yb2FtaW5nX21vZGUiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB2dCh2aWRlbyB0ZWxlcGhvbnkgb3ZlciBJTVMpIGVuYWJsZWQKICAgICAqIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHZ0IGVuYWJsZWQge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc1Z0U2V0dGluZ0VuYWJsZWQoKX0KICAgICAqIHdoaWxlIHlvdXIgYXBwIGlzIHJ1bm5pbmcuIFlvdSBjYW4gYWxzbyB1c2UgYSB7QGxpbmsgYW5kcm9pZC5hcHAuam9iLkpvYlNlcnZpY2V9IHRvIGVuc3VyZQogICAgICogeW91ciBhcHAgaXMgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUge0BsaW5rIFVyaX0gZXZlbiB3aGVuIGl0IGlzIG5vdCBydW5uaW5nLgogICAgICogTm90ZSwgaG93ZXZlciwgdGhhdCB1c2luZyBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gZG9lcyBub3QgZ3VhcmFudGVlIHRpbWVseQogICAgICogZGVsaXZlcnkgb2YgdXBkYXRlcyB0byB0aGUge0BsaW5rIFVyaX0uCiAgICAgKiBUbyBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIGEgc3BlY2lmaWMgc3ViSWQsIGFwcGVuZCBzdWJJZCB0byB0aGUgVVJJCiAgICAgKiB7QGxpbmsgVXJpI3dpdGhBcHBlbmRlZFBhdGgoVXJpLCBTdHJpbmcpfS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBOb25OdWxsCiAgICBAU3lzdGVtQXBpCiAgICBAVGVzdEFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBVcmkgVlRfRU5BQkxFRF9DT05URU5UX1VSSSA9IFVyaS53aXRoQXBwZW5kZWRQYXRoKAogICAgICAgICAgICBDT05URU5UX1VSSSwgInZ0X2VuYWJsZWQiKTsKCiAgICAvKioKICAgICAqIEEgY29udGVudCB7QGxpbmsgVXJpfSB1c2VkIHRvIHJlY2VpdmUgdXBkYXRlcyBvbiB3ZmMgcm9hbWluZyBlbmFibGVkIHNldHRpbmcuCiAgICAgKiA8cD4KICAgICAqIFVzZSB0aGlzIHtAbGluayBVcml9IHdpdGggYSB7QGxpbmsgQ29udGVudE9ic2VydmVyfSB0byBiZSBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZQogICAgICogc3Vic2NyaXB0aW9uIHdmYyByb2FtaW5nIGVuYWJsZWQge0BsaW5rIEltc01tVGVsTWFuYWdlciNpc1ZvV2lGaVJvYW1pbmdTZXR0aW5nRW5hYmxlZCgpfQogICAgICogd2hpbGUgeW91ciBhcHAgaXMgcnVubmluZy4gWW91IGNhbiBhbHNvIHVzZSBhIHtAbGluayBhbmRyb2lkLmFwcC5qb2IuSm9iU2VydmljZX0gdG8gZW5zdXJlCiAgICAgKiB5b3VyIGFwcCBpcyBub3RpZmllZCBvZiBjaGFuZ2VzIHRvIHRoZSB7QGxpbmsgVXJpfSBldmVuIHdoZW4gaXQgaXMgbm90IHJ1bm5pbmcuCiAgICAgKiBOb3RlLCBob3dldmVyLCB0aGF0IHVzaW5nIGEge0BsaW5rIGFuZHJvaWQuYXBwLmpvYi5Kb2JTZXJ2aWNlfSBkb2VzIG5vdCBndWFyYW50ZWUgdGltZWx5CiAgICAgKiBkZWxpdmVyeSBvZiB1cGRhdGVzIHRvIHRoZSB7QGxpbmsgVXJpfS4KICAgICAqIFRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgdG8gYSBzcGVjaWZpYyBzdWJJZCwgYXBwZW5kIHN1YklkIHRvIHRoZSBVUkkKICAgICAqIHtAbGluayBVcmkjd2l0aEFwcGVuZGVkUGF0aChVcmksIFN0cmluZyl9LgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIEBTeXN0ZW1BcGkKICAgIEBUZXN0QXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFVyaSBXRkNfUk9BTUlOR19FTkFCTEVEX0NPTlRFTlRfVVJJID0gVXJpLndpdGhBcHBlbmRlZFBhdGgoCiAgICAgICAgICAgIENPTlRFTlRfVVJJLCAid2ZjX3JvYW1pbmdfZW5hYmxlZCIpOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgdW5pcXVlIGtleSBjb2x1bW4gbmFtZSBpcyB0aGUgc3Vic2NyaXB0aW9uIGlkLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBVTklRVUVfS0VZX1NVQlNDUklQVElPTl9JRCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX1VOSVFVRV9LRVlfU1VCU0NSSVBUSU9OX0lEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGEgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSBzdWJzY3JpcHRpb24gd2l0aGluIHRoZQogICAgICogc3BlY2lmaWMgc3Vic2NyaXB0aW9uIHR5cGUuIEZvciBleGFtcGxlLCBpdCBjb250YWlucyBTSU0gSUNDIElkZW50aWZpZXIgc3Vic2NyaXB0aW9ucwogICAgICogb24gTG9jYWwgU0lNcy4gYW5kIE1hYy1hZGRyZXNzIGZvciBSZW1vdGUtU0lNIFN1YnNjcmlwdGlvbnMgZm9yIEJsdWV0b290aCBkZXZpY2VzLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJQ0NfSUQgPSBTaW1JbmZvLkNPTFVNTl9JQ0NfSUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdXNlciBTSU1fU2xPVF9JTkRFWAogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBTSU1fU0xPVF9JTkRFWCA9IFNpbUluZm8uQ09MVU1OX1NJTV9TTE9UX0lOREVYOwoKICAgIC8qKiBTSU0gaXMgbm90IGluc2VydGVkICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNJTV9OT1RfSU5TRVJURUQgPSBTaW1JbmZvLlNJTV9OT1RfSU5TRVJURUQ7CgogICAgLyoqCiAgICAgKiBUaGUgc2xvdC1pbmRleCBmb3IgQmx1ZXRvb3RoIFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9ucwogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0xPVF9JTkRFWF9GT1JfUkVNT1RFX1NJTV9TVUIgPSBJTlZBTElEX1NJTV9TTE9UX0lOREVYOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgU3Vic2NyaXB0aW9uLXR5cGUuCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPiB7QGxpbmsgI1NVQlNDUklQVElPTl9UWVBFX0xPQ0FMX1NJTX0gZm9yIExvY2FsLVNJTSBTdWJzY3JpcHRpb25zLAogICAgICoge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRV9SRU1PVEVfU0lNfSBmb3IgUmVtb3RlLVNJTSBTdWJzY3JpcHRpb25zLgogICAgICogRGVmYXVsdCB2YWx1ZSBpcyAwLgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFNVQlNDUklQVElPTl9UWVBFID0gU2ltSW5mby5DT0xVTU5fU1VCU0NSSVBUSU9OX1RZUEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBkYXRhX2VuYWJsZWRfb3ZlcnJpZGVfcnVsZXMuCiAgICAgKiBJdCdzIGEgbGlzdCBvZiBydWxlcyBmb3Igb3ZlcnJpZGluZyBkYXRhIGVuYWJsZWQgc2V0dGluZ3MuIFRoZSBzeW50YXggaXMKICAgICAqIEZvciBleGFtcGxlLCAibW1zPW5vbkRlZmF1bHQiIGluZGljYXRlcyBlbmFibGluZyBkYXRhIGZvciBtbXMgaW4gbm9uLWRlZmF1bHQgc3Vic2NyaXB0aW9uLgogICAgICogImRlZmF1bHQ9bm9uRGVmYXVsdCZpblZvaWNlQ2FsbCIgaW5kaWNhdGVzIGVuYWJsaW5nIGRhdGEgZm9yIGludGVybmV0IGluIG5vbi1kZWZhdWx0CiAgICAgKiBzdWJzY3JpcHRpb24gYW5kIHdoaWxlIGlzIGluIHZvaWNlIGNhbGwuCiAgICAgKgogICAgICogRGVmYXVsdCB2YWx1ZSBpcyBlbXB0eSBzdHJpbmcuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgREFUQV9FTkFCTEVEX09WRVJSSURFX1JVTEVTID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fREFUQV9FTkFCTEVEX09WRVJSSURFX1JVTEVTOwoKICAgIC8qKiBAaGlkZSAqLwogICAgQFJldGVudGlvbihSZXRlbnRpb25Qb2xpY3kuU09VUkNFKQogICAgQEludERlZihwcmVmaXggPSB7IlNVQlNDUklQVElPTl9UWVBFXyJ9LAogICAgICAgIHZhbHVlID0gewogICAgICAgICAgICBTVUJTQ1JJUFRJT05fVFlQRV9MT0NBTF9TSU0sCiAgICAgICAgICAgIFNVQlNDUklQVElPTl9UWVBFX1JFTU9URV9TSU19KQogICAgcHVibGljIEBpbnRlcmZhY2UgU3Vic2NyaXB0aW9uVHlwZSB7fQoKICAgIC8qKgogICAgICogVGhpcyBjb25zdGFudCBpcyB0byBkZXNpZ25hdGUgYSBzdWJzY3JpcHRpb24gYXMgYSBMb2NhbC1TSU0gU3Vic2NyaXB0aW9uLgogICAgICogPHA+IEEgTG9jYWwtU0lNIGNhbiBiZSBhIHBoeXNpY2FsIFNJTSBpbnNlcnRlZCBpbnRvIGEgc2ltLXNsb3QgaW4gdGhlIGRldmljZSwgb3IgZVNJTSBvbiB0aGUKICAgICAqIGRldmljZS4KICAgICAqIDwvcD4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNID0gU2ltSW5mby5TVUJTQ1JJUFRJT05fVFlQRV9MT0NBTF9TSU07CgogICAgLyoqCiAgICAgKiBUaGlzIGNvbnN0YW50IGlzIHRvIGRlc2lnbmF0ZSBhIHN1YnNjcmlwdGlvbiBhcyBhIFJlbW90ZS1TSU0gU3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBIFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9uIGlzIGZvciBhIFNJTSBvbiBhIHBob25lIGNvbm5lY3RlZCB0byB0aGlzIGRldmljZSB2aWEgc29tZQogICAgICogY29ubmVjdGl2aXR5IG1lY2hhbmlzbSwgZm9yIGV4YW1wbGUgYmx1ZXRvb3RoLiBTaW1pbGFyIHRvIExvY2FsIFNJTSwgdGhpcyBzdWJzY3JpcHRpb24gY2FuCiAgICAgKiBiZSB1c2VkIGZvciBTTVMsIFZvaWNlIGFuZCBkYXRhIGJ5IHByb3h5aW5nIGRhdGEgdGhyb3VnaCB0aGUgY29ubmVjdGVkIGRldmljZS4KICAgICAqIENlcnRhaW4gZGF0YSBvZiB0aGUgU0lNLCBzdWNoIGFzIElNRUksIGFyZSBub3QgYWNjZXNzaWJsZSBmb3IgUmVtb3RlIFNJTXMuCiAgICAgKiA8L3A+CiAgICAgKgogICAgICogPHA+CiAgICAgKiBBIFJlbW90ZS1TSU0gaXMgYXZhaWxhYmxlIG9ubHkgYXMgbG9uZyB0aGUgcGhvbmUgc3RheXMgY29ubmVjdGVkIHRvIHRoaXMgZGV2aWNlLgogICAgICogV2hlbiB0aGUgcGhvbmUgZGlzY29ubmVjdHMsIFJlbW90ZS1TSU0gc3Vic2NyaXB0aW9uIGlzIHJlbW92ZWQgZnJvbSB0aGlzIGRldmljZSBhbmQgaXMKICAgICAqIG5vIGxvbmdlciBrbm93bi4gQWxsIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24sIHN1Y2ggYXMgc3RvcmVkIFNNUywgY2FsbCBsb2dzLAogICAgICogY29udGFjdHMgZXRjLCBhcmUgcmVtb3ZlZCBmcm9tIHRoaXMgZGV2aWNlLgogICAgICogPC9wPgogICAgICoKICAgICAqIDxwPgogICAgICogSWYgdGhlIHBob25lIHJlLWNvbm5lY3RzIHRvIHRoaXMgZGV2aWNlLCBhIG5ldyBSZW1vdGUtU0lNIHN1YnNjcmlwdGlvbiBpcyBjcmVhdGVkIGZvcgogICAgICogdGhlIHBob25lLiBUaGUgU3Vic2NyaXB0aW9uIElkIGFzc29jaWF0ZWQgd2l0aCB0aGUgbmV3IHN1YnNjcmlwdGlvbiBpcyBkaWZmZXJlbnQgZnJvbQogICAgICogdGhlIFN1YnNjcmlwdGlvbiBJZCBvZiB0aGUgcHJldmlvdXMgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gY3JlYXRlZCAoYW5kIHJlbW92ZWQpIGZvciB0aGUKICAgICAqIHBob25lOyBpLmUuLCBuZXcgUmVtb3RlLVNJTSBzdWJzY3JpcHRpb24gdHJlYXRzIHRoZSByZWNvbm5lY3RlZCBwaG9uZSBhcyBhIFJlbW90ZS1TSU0gdGhhdAogICAgICogd2FzIG5ldmVyIHNlZW4gYmVmb3JlLgogICAgICogPC9wPgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVUJTQ1JJUFRJT05fVFlQRV9SRU1PVEVfU0lNID0gU2ltSW5mby5TVUJTQ1JJUFRJT05fVFlQRV9SRU1PVEVfU0lNOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHVzZXIgZGlzcGxheWVkIG5hbWUuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIERJU1BMQVlfTkFNRSA9IFNpbUluZm8uQ09MVU1OX0RJU1BMQVlfTkFNRTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgc2VydmljZSBwcm92aWRlciBuYW1lIGZvciB0aGUgU0lNLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqLwogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQVJSSUVSX05BTUUgPSBTaW1JbmZvLkNPTFVNTl9DQVJSSUVSX05BTUU7CgogICAgLyoqCiAgICAgKiBEZWZhdWx0IG5hbWUgcmVzb3VyY2UKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFRkFVTFRfTkFNRV9SRVMgPSBjb20uYW5kcm9pZC5pbnRlcm5hbC5SLnN0cmluZy51bmtub3duTmFtZTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBzb3VyY2Ugb2YgdGhlIHVzZXIgZGlzcGxheWVkIG5hbWUuCiAgICAgKiA8UD5UeXBlOiBJTlQgKGludCk8L1A+IHdpdGggb25lIG9mIHRoZSBOQU1FX1NPVVJDRV9YWFhYIHZhbHVlcyBiZWxvdwogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE5BTUVfU09VUkNFID0gU2ltSW5mby5DT0xVTU5fTkFNRV9TT1VSQ0U7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgZnJvbSB0aGUgY2FycmllciBpZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5BTUVfU09VUkNFX0NBUlJJRVJfSUQgPSBTaW1JbmZvLk5BTUVfU09VUkNFX0NBUlJJRVJfSUQ7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgZnJvbSBTSU0gRUZfU1BOLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfU0lNX1NQTiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfU0lNX1NQTjsKCiAgICAvKioKICAgICAqIFRoZSBuYW1lX3NvdXJjZSBpcyBmcm9tIHVzZXIgaW5wdXQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlKG1heFRhcmdldFNkayA9IEJ1aWxkLlZFUlNJT05fQ09ERVMuUCwgdHJhY2tpbmdCdWcgPSAxMTU2MDkwMjMpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBOQU1FX1NPVVJDRV9VU0VSX0lOUFVUID0gU2ltSW5mby5OQU1FX1NPVVJDRV9VU0VSX0lOUFVUOwoKICAgIC8qKgogICAgICogVGhlIG5hbWVfc291cmNlIGlzIGNhcnJpZXIgKGNhcnJpZXIgYXBwLCBjYXJyaWVyIGNvbmZpZywgZXRjLikKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE5BTUVfU09VUkNFX0NBUlJJRVIgPSBTaW1JbmZvLk5BTUVfU09VUkNFX0NBUlJJRVI7CgogICAgLyoqCiAgICAgKiBUaGUgbmFtZV9zb3VyY2UgaXMgZnJvbSBTSU0gRUZfUE5OLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTkFNRV9TT1VSQ0VfU0lNX1BOTiA9IFNpbUluZm8uTkFNRV9TT1VSQ0VfU0lNX1BOTjsKCiAgICAvKiogQGhpZGUgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyJOQU1FX1NPVVJDRV8ifSwKICAgICAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgICAgICAgICAgTkFNRV9TT1VSQ0VfQ0FSUklFUl9JRCwKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9TSU1fU1BOLAogICAgICAgICAgICAgICAgICAgIE5BTUVfU09VUkNFX1VTRVJfSU5QVVQsCiAgICAgICAgICAgICAgICAgICAgTkFNRV9TT1VSQ0VfQ0FSUklFUiwKICAgICAgICAgICAgICAgICAgICBOQU1FX1NPVVJDRV9TSU1fUE5OCiAgICAgICAgICAgIH0pCiAgICBwdWJsaWMgQGludGVyZmFjZSBTaW1EaXNwbGF5TmFtZVNvdXJjZSB7fQoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBjb2xvciBvZiBhIFNJTS4KICAgICAqIDxQPlR5cGU6IElOVEVHRVIgKGludCk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSFVFID0gU2ltSW5mby5DT0xVTU5fQ09MT1I7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIHBob25lIG51bWJlciBvZiBhIFNJTS4KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKi8KICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTlVNQkVSID0gU2ltSW5mby5DT0xVTU5fTlVNQkVSOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHdoZXRoZXIgZGF0YSByb2FtaW5nIGlzIGVuYWJsZWQuCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICovCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIERBVEFfUk9BTUlORyA9IFNpbUluZm8uQ09MVU1OX0RBVEFfUk9BTUlORzsKCiAgICAvKiogSW5kaWNhdGVzIHRoYXQgZGF0YSByb2FtaW5nIGlzIGVuYWJsZWQgZm9yIGEgc3Vic2NyaXB0aW9uICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX1JPQU1JTkdfRU5BQkxFID0gU2ltSW5mby5EQVRBX1JPQU1JTkdfRU5BQkxFOwoKICAgIC8qKiBJbmRpY2F0ZXMgdGhhdCBkYXRhIHJvYW1pbmcgaXMgZGlzYWJsZWQgZm9yIGEgc3Vic2NyaXB0aW9uICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBEQVRBX1JPQU1JTkdfRElTQUJMRSA9IFNpbUluZm8uREFUQV9ST0FNSU5HX0RJU0FCTEU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igc3Vic2NyaXB0aW9uIGNhcnJpZXIgaWQuCiAgICAgKiBAc2VlIFRlbGVwaG9ueU1hbmFnZXIjZ2V0U2ltQ2FycmllcklkKCkKICAgICAqIDxwPlR5cGU6IElOVEVHRVIgKGludCkgPC9wPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0FSUklFUl9JRCA9IFNpbUluZm8uQ09MVU1OX0NBUlJJRVJfSUQ7CgogICAgLyoqCiAgICAgKiBAaGlkZSBBIGNvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIEVIUExNTnMgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVIUExNTlMgPSBTaW1JbmZvLkNPTFVNTl9FSFBMTU5TOwoKICAgIC8qKgogICAgICogQGhpZGUgQSBjb21tYS1zZXBhcmF0ZWQgbGlzdCBvZiBIUExNTnMgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIDxQPlR5cGU6IFRFWFQgKFN0cmluZyk8L1A+CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEhQTE1OUyA9IFNpbUluZm8uQ09MVU1OX0hQTE1OUzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgTUNDIGFzc29jaWF0ZWQgd2l0aCBhIFNJTSwgc3RvcmVkIGFzIGEgc3RyaW5nLgogICAgICogPFA+VHlwZTogVEVYVCAoU3RyaW5nKTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE1DQ19TVFJJTkcgPSBTaW1JbmZvLkNPTFVNTl9NQ0NfU1RSSU5HOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNTkMgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLCBzdG9yZWQgYXMgYSBzdHJpbmcuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTU5DX1NUUklORyA9IFNpbUluZm8uQ09MVU1OX01OQ19TVFJJTkc7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIE1DQyBhc3NvY2lhdGVkIHdpdGggYSBTSU0uCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgTUNDID0gU2ltSW5mby5DT0xVTU5fTUNDOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHRoZSBNTkMgYXNzb2NpYXRlZCB3aXRoIGEgU0lNLgogICAgICogPFA+VHlwZTogSU5URUdFUiAoaW50KTwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIE1OQyA9IFNpbUluZm8uQ09MVU1OX01OQzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgaXNvIGNvdW50cnkgY29kZSBhc3NvY2lhdGVkIHdpdGggYSBTSU0uCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSVNPX0NPVU5UUllfQ09ERSA9IFNpbUluZm8uQ09MVU1OX0lTT19DT1VOVFJZX0NPREU7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3Igd2hldGhlciBhIHN1YnNjcmlwdGlvbiBpcyBlbWJlZGRlZCAodGhhdCBpcywgcHJlc2VudCBvbiBhbgogICAgICogZVNJTSkuCiAgICAgKiA8cD5UeXBlOiBJTlRFR0VSIChpbnQpLCAxIGZvciBlbWJlZGRlZCBvciAwIGZvciBub24tZW1iZWRkZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJU19FTUJFRERFRCA9IFNpbUluZm8uQ09MVU1OX0lTX0VNQkVEREVEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIFNJTSBjYXJkIGlkZW50aWZpZXIuIEZvciBVSUNDIGNhcmQgaXQgaXMgdGhlIElDQ0lEIG9mIHRoZQogICAgICogY3VycmVudCBlbmFibGVkIHByb2ZpbGUgb24gdGhlIGNhcmQsIHdoaWxlIGZvciBlVUlDQyBjYXJkIGl0IGlzIHRoZSBFSUQgb2YgdGhlIGNhcmQuCiAgICAgKiA8UD5UeXBlOiBURVhUIChTdHJpbmcpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0FSRF9JRCA9IFNpbUluZm8uQ09MVU1OX0NBUkRfSUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIGVuY29kZWQge0BsaW5rIFVpY2NBY2Nlc3NSdWxlfXMgZnJvbQogICAgICoge0BsaW5rIFVpY2NBY2Nlc3NSdWxlI2VuY29kZVJ1bGVzfS4gT25seSBwcmVzZW50IGlmIHtAbGluayAjSVNfRU1CRURERUR9IGlzIDEuCiAgICAgKiA8cD5UWVBFOiBCTE9CCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ0NFU1NfUlVMRVMgPSBTaW1JbmZvLkNPTFVNTl9BQ0NFU1NfUlVMRVM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgdGhlIGVuY29kZWQge0BsaW5rIFVpY2NBY2Nlc3NSdWxlfXMgZnJvbQogICAgICoge0BsaW5rIFVpY2NBY2Nlc3NSdWxlI2VuY29kZVJ1bGVzfSBidXQgZm9yIHRoZSBydWxlcyB0aGF0IGNvbWUgZnJvbSBDYXJyaWVyQ29uZmlncy4KICAgICAqIE9ubHkgcHJlc2VudCBpZiB0aGVyZSBhcmUgYWNjZXNzIHJ1bGVzIGluIENhcnJpZXJDb25maWdzCiAgICAgKiA8cD5UWVBFOiBCTE9CCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ0NFU1NfUlVMRVNfRlJPTV9DQVJSSUVSX0NPTkZJR1MgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9BQ0NFU1NfUlVMRVNfRlJPTV9DQVJSSUVSX0NPTkZJR1M7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBpZGVudGlmeWluZyB3aGV0aGVyIGFuIGVtYmVkZGVkIHN1YnNjcmlwdGlvbiBpcyBvbiBhIHJlbW92YWJsZQogICAgICogY2FyZC4gU3VjaCBzdWJzY3JpcHRpb25zIGFyZSBtYXJrZWQgaW5hY2Nlc3NpYmxlIGFzIHNvb24gYXMgdGhlIGN1cnJlbnQgY2FyZCBpcyByZW1vdmVkLgogICAgICogT3RoZXJ3aXNlLCB0aGV5IHdpbGwgcmVtYWluIGFjY2Vzc2libGUgdW5sZXNzIGV4cGxpY2l0bHkgZGVsZXRlZC4gT25seSBwcmVzZW50IGlmCiAgICAgKiB7QGxpbmsgI0lTX0VNQkVEREVEfSBpcyAxLgogICAgICogPHA+VFlQRTogSU5URUdFUiAoaW50KSwgMSBmb3IgcmVtb3ZhYmxlIG9yIDAgZm9yIG5vbi1yZW1vdmFibGUuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBJU19SRU1PVkFCTEUgPSBTaW1JbmZvLkNPTFVNTl9JU19SRU1PVkFCTEU7CgogICAgLyoqCiAgICAgKiAgVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGV4dHJlbWUgdGhyZWF0IGluIENCIHNldHRpbmdzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9FWFRSRU1FX1RIUkVBVF9BTEVSVCA9CiAgICAgICAgICAgIFNpbUluZm8uQ09MVU1OX0NCX0VYVFJFTUVfVEhSRUFUX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHNldmVyZSB0aHJlYXQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfU0VWRVJFX1RIUkVBVF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX1NFVkVSRV9USFJFQVRfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYW1iZXIgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQU1CRVJfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9BTUJFUl9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbWVyZ2VuY3kgYWxlcnQgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfRU1FUkdFTkNZX0FMRVJUID0gU2ltSW5mby5DT0xVTU5fQ0JfRU1FUkdFTkNZX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGFsZXJ0IHNvdW5kIGR1cmF0aW9uIGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0FMRVJUX1NPVU5EX0RVUkFUSU9OID0KICAgICAgICAgICAgU2ltSW5mby5DT0xVTU5fQ0JfQUxFUlRfU09VTkRfRFVSQVRJT047CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgYWxlcnQgcmVtaW5kZXIgaW50ZXJ2YWwgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfQUxFUlRfUkVNSU5ERVJfSU5URVJWQUwgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9SRU1JTkRFUl9JTlRFUlZBTDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGluZyB2aWJyYXRlIGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0FMRVJUX1ZJQlJBVEUgPSBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9WSUJSQVRFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGVuYWJsaW5nIGFsZXJ0IHNwZWVjaCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9BTEVSVF9TUEVFQ0ggPSBTaW1JbmZvLkNPTFVNTl9DQl9BTEVSVF9TUEVFQ0g7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgRVRXUyB0ZXN0IGFsZXJ0IGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0VUV1NfVEVTVF9BTEVSVCA9IFNpbUluZm8uQ09MVU1OX0NCX0VUV1NfVEVTVF9BTEVSVDsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgY2hhbm5lbDUwIGFsZXJ0IGluIENCIHNldHRpbmdzCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIENCX0NIQU5ORUxfNTBfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9DSEFOTkVMXzUwX0FMRVJUOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIENNQVMgdGVzdCBhbGVydCBpbiBDQiBzZXR0aW5ncwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBDQl9DTUFTX1RFU1RfQUxFUlQgPSBTaW1JbmZvLkNPTFVNTl9DQl9DTUFTX1RFU1RfQUxFUlQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgT3B0IG91dCBkaWFsb2cgaW4gQ0Igc2V0dGluZ3MKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQ0JfT1BUX09VVF9ESUFMT0cgPSBTaW1JbmZvLkNPTFVNTl9DQl9PUFRfT1VUX0RJQUxPRzsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgVm9sdGUuCiAgICAgKgogICAgICogSWYgdGhpcyBzZXR0aW5nIGlzIG5vdCBpbml0aWFsaXplZCAoc2V0IHRvIC0xKSAgdGhlbiB3ZSB1c2UgdGhlIENhcnJpZXIgQ29uZmlnIHZhbHVlCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0VOSEFOQ0VEXzRHX0xURV9PTl9CWV9ERUZBVUxUX0JPT0x9LgogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFTkhBTkNFRF80R19NT0RFX0VOQUJMRUQgPQogICAgICAgICAgICBTaW1JbmZvLkNPTFVNTl9FTkhBTkNFRF80R19NT0RFX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZW5hYmxlIFZUIChWaWRlbyBUZWxlcGhvbnkgb3ZlciBJTVMpCiAgICAgKkBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIFZUX0lNU19FTkFCTEVEID0gU2ltSW5mby5DT0xVTU5fVlRfSU1TX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZW5hYmxlIFdpZmkgY2FsbGluZwogICAgICpAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBXRkNfSU1TX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX0VOQUJMRUQ7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgV2lmaSBjYWxsaW5nIG1vZGUKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgV0ZDX0lNU19NT0RFID0gU2ltSW5mby5DT0xVTU5fV0ZDX0lNU19NT0RFOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIFdpZmkgY2FsbGluZyBtb2RlIGluIHJvYW1pbmcKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgV0ZDX0lNU19ST0FNSU5HX01PREUgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX1JPQU1JTkdfTU9ERTsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciBlbmFibGUgV2lmaSBjYWxsaW5nIGluIHJvYW1pbmcKICAgICAqQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgV0ZDX0lNU19ST0FNSU5HX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9XRkNfSU1TX1JPQU1JTkdfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIERldGVybWluZXMgaWYgdGhlIHVzZXIgaGFzIGVuYWJsZWQgSU1TIFJDUyBVc2VyIENhcGFiaWxpdHkgRXhjaGFuZ2UgKFVDRSkgZm9yIHRoaXMKICAgICAqIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElNU19SQ1NfVUNFX0VOQUJMRUQgPSBTaW1JbmZvLkNPTFVNTl9JTVNfUkNTX1VDRV9FTkFCTEVEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIHdoZXRoZXIgYSBzdWJzY3JpcHRpb24gaXMgb3Bwb3J0dW5pc3RpYywgdGhhdCBpcywKICAgICAqIHdoZXRoZXIgdGhlIG5ldHdvcmsgaXQgY29ubmVjdHMgdG8gaXMgbGltaXRlZCBpbiBmdW5jdGlvbmFsaXR5IG9yIGNvdmVyYWdlLgogICAgICogRm9yIGV4YW1wbGUsIENCUlMuCiAgICAgKiA8cD5UeXBlOiBJTlRFR0VSIChpbnQpLCAxIGZvciBvcHBvcnR1bmlzdGljIG9yIDAgZm9yIG5vbi1vcHBvcnR1bmlzdGljLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgSVNfT1BQT1JUVU5JU1RJQyA9IFNpbUluZm8uQ09MVU1OX0lTX09QUE9SVFVOSVNUSUM7CgogICAgLyoqCiAgICAgKiBUZWxlcGhvbnlQcm92aWRlciBjb2x1bW4gbmFtZSBmb3IgZ3JvdXAgSUQuIFN1YnNjcmlwdGlvbnMgd2l0aCBzYW1lIGdyb3VwIElECiAgICAgKiBhcmUgY29uc2lkZXJlZCBidW5kbGVkIHRvZ2V0aGVyLCBhbmQgc2hvdWxkIGJlaGF2ZSBhcyBhIHNpbmdsZSBzdWJzY3JpcHRpb24gYXQKICAgICAqIGNlcnRhaW4gc2NlbmFyaW9zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEdST1VQX1VVSUQgPSBTaW1JbmZvLkNPTFVNTl9HUk9VUF9VVUlEOwoKICAgIC8qKgogICAgICogVGVsZXBob255UHJvdmlkZXIgY29sdW1uIG5hbWUgZm9yIGdyb3VwIG93bmVyLiBJdCdzIHRoZSBwYWNrYWdlIG5hbWUgd2hvIGNyZWF0ZWQKICAgICAqIHRoZSBzdWJzY3JpcHRpb24gZ3JvdXAuCiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgR1JPVVBfT1dORVIgPSBTaW1JbmZvLkNPTFVNTl9HUk9VUF9PV05FUjsKCiAgICAvKioKICAgICAqIFRlbGVwaG9ueVByb3ZpZGVyIGNvbHVtbiBuYW1lIGZvciB0aGUgcHJvZmlsZSBjbGFzcyBvZiBhIHN1YnNjcmlwdGlvbgogICAgICogT25seSBwcmVzZW50IGlmIHtAbGluayAjSVNfRU1CRURERUR9IGlzIDEuCiAgICAgKiA8UD5UeXBlOiBJTlRFR0VSIChpbnQpPC9QPgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgUFJPRklMRV9DTEFTUyA9IFNpbUluZm8uQ09MVU1OX1BST0ZJTEVfQ0xBU1M7CgogICAgLyoqCiAgICAgKiBQcm9maWxlIGNsYXNzIG9mIHRoZSBzdWJzY3JpcHRpb24KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXRlbnRpb24oUmV0ZW50aW9uUG9saWN5LlNPVVJDRSkKICAgIEBJbnREZWYocHJlZml4ID0geyAiUFJPRklMRV9DTEFTU18iIH0sIHZhbHVlID0gewogICAgICAgICAgICBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfVEVTVElORywKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX1BST1ZJU0lPTklORywKICAgICAgICAgICAgU2ltSW5mby5QUk9GSUxFX0NMQVNTX09QRVJBVElPTkFMLAogICAgICAgICAgICBTaW1JbmZvLlBST0ZJTEVfQ0xBU1NfVU5TRVQsCiAgICB9KQogICAgcHVibGljIEBpbnRlcmZhY2UgUHJvZmlsZUNsYXNzIHt9CgogICAgLyoqCiAgICAgKiBBIHRlc3RpbmcgcHJvZmlsZSBjYW4gYmUgcHJlLWxvYWRlZCBvciBkb3dubG9hZGVkIG9udG8KICAgICAqIHRoZSBlVUlDQyBhbmQgcHJvdmlkZXMgY29ubmVjdGl2aXR5IHRvIHRlc3QgZXF1aXBtZW50CiAgICAgKiBmb3IgdGhlIHB1cnBvc2Ugb2YgdGVzdGluZyB0aGUgZGV2aWNlIGFuZCB0aGUgZVVJQ0MuIEl0CiAgICAgKiBpcyBub3QgaW50ZW5kZWQgdG8gc3RvcmUgYW55IG9wZXJhdG9yIGNyZWRlbnRpYWxzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19URVNUSU5HID0gU2ltSW5mby5QUk9GSUxFX0NMQVNTX1RFU1RJTkc7CgogICAgLyoqCiAgICAgKiBBIHByb3Zpc2lvbmluZyBwcm9maWxlIGlzIHByZS1sb2FkZWQgb250byB0aGUgZVVJQ0MgYW5kCiAgICAgKiBwcm92aWRlcyBjb25uZWN0aXZpdHkgdG8gYSBtb2JpbGUgbmV0d29yayBzb2xlbHkgZm9yIHRoZQogICAgICogcHVycG9zZSBvZiBwcm92aXNpb25pbmcgcHJvZmlsZXMuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQUk9GSUxFX0NMQVNTX1BST1ZJU0lPTklORyA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19QUk9WSVNJT05JTkc7CgogICAgLyoqCiAgICAgKiBBbiBvcGVyYXRpb25hbCBwcm9maWxlIGNhbiBiZSBwcmUtbG9hZGVkIG9yIGRvd25sb2FkZWQKICAgICAqIG9udG8gdGhlIGVVSUNDIGFuZCBwcm92aWRlcyBzZXJ2aWNlcyBwcm92aWRlZCBieSB0aGUKICAgICAqIG9wZXJhdG9yLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTCA9IFNpbUluZm8uUFJPRklMRV9DTEFTU19PUEVSQVRJT05BTDsKCiAgICAvKioKICAgICAqIFRoZSBwcm9maWxlIGNsYXNzIGlzIHVuc2V0LiBUaGlzIG9jY3VycyB3aGVuIHByb2ZpbGUgY2xhc3MKICAgICAqIGluZm8gaXMgbm90IGF2YWlsYWJsZS4gVGhlIHN1YnNjcmlwdGlvbiBlaXRoZXIgaGFzIG5vIHByb2ZpbGUKICAgICAqIG1ldGFkYXRhIG9yIHRoZSBwcm9maWxlIG1ldGFkYXRhIGRpZCBub3QgZW5jb2RlIHByb2ZpbGUgY2xhc3MuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQUk9GSUxFX0NMQVNTX1VOU0VUID0gU2ltSW5mby5QUk9GSUxFX0NMQVNTX1VOU0VUOwoKICAgIC8qKgogICAgICogRGVmYXVsdCBwcm9maWxlIGNsYXNzCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUFJPRklMRV9DTEFTU19ERUZBVUxUID0gU2ltSW5mby5QUk9GSUxFX0NMQVNTX1VOU0VUOwoKICAgIC8qKgogICAgICogSU1TSSAoSW50ZXJuYXRpb25hbCBNb2JpbGUgU3Vic2NyaWJlciBJZGVudGl0eSkuCiAgICAgKiA8UD5UeXBlOiBURVhUIDwvUD4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIC8vVE9ETzogYWRkIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIElNU0kgPSBTaW1JbmZvLkNPTFVNTl9JTVNJOwoKICAgIC8qKgogICAgICogV2hldGhlciB1aWNjIGFwcGxpY2F0aW9ucyBpcyBzZXQgdG8gYmUgZW5hYmxlZCBvciBkaXNhYmxlZC4gQnkgZGVmYXVsdCBpdCdzIGVuYWJsZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBVSUNDX0FQUExJQ0FUSU9OU19FTkFCTEVEID0gU2ltSW5mby5DT0xVTU5fVUlDQ19BUFBMSUNBVElPTlNfRU5BQkxFRDsKCiAgICAvKioKICAgICAqIEluZGljYXRlIHdoaWNoIG5ldHdvcmsgdHlwZSBpcyBhbGxvd2VkLiBCeSBkZWZhdWx0IGl0J3MgZW5hYmxlZC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFMTE9XRURfTkVUV09SS19UWVBFUyA9IFNpbUluZm8uQ09MVU1OX0FMTE9XRURfTkVUV09SS19UWVBFUzsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSB1c2VyIGhhcyBjaGFuZ2VkIG9uZSBvZiB0aGUgZGVmYXVsdCBzdWJzIHJlbGF0ZWQgdG8KICAgICAqIGRhdGEsIHBob25lIGNhbGxzLCBvciBzbXM8L3A+CiAgICAgKgogICAgICogVE9ETzogQ2hhbmdlIHRvIGEgbGlzdGVuZXIKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBTVUJfREVGQVVMVF9DSEFOR0VEX0FDVElPTiA9CiAgICAgICAgICAgICJhbmRyb2lkLmludGVudC5hY3Rpb24uU1VCX0RFRkFVTFRfQ0hBTkdFRCI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICogVGhlIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSBleHRyYSBpbmRpY2F0ZXMgdGhlIGN1cnJlbnQgZGVmYXVsdCBzdWJzY3JpcHRpb24gaW5kZXgKICAgICAqLwogICAgQFNka0NvbnN0YW50KFNka0NvbnN0YW50VHlwZS5CUk9BRENBU1RfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VECiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5ERUZBVUxUX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFRoZSBkZWZhdWx0IHNtcyBzdWJzY3JpcHRpb24gaGFzIGNoYW5nZWQuICBUaGlzIGhhcyB0aGUgZm9sbG93aW5nCiAgICAgKiBleHRyYSB2YWx1ZXM6PC9wPgogICAgICoge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IGV4dHJhIGluZGljYXRlcyB0aGUgY3VycmVudCBkZWZhdWx0IHNtcwogICAgICogc3Vic2NyaXB0aW9uIGluZGV4CiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQlJPQURDQVNUX0lOVEVOVF9BQ1RJT04pCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBBQ1RJT05fREVGQVVMVF9TTVNfU1VCU0NSSVBUSU9OX0NIQU5HRUQKICAgICAgICAgICAgPSAiYW5kcm9pZC50ZWxlcGhvbnkuYWN0aW9uLkRFRkFVTFRfU01TX1NVQlNDUklQVElPTl9DSEFOR0VEIjsKCiAgICAvKioKICAgICAqIEFjdGl2aXR5IEFjdGlvbjogRGlzcGxheSBVSSBmb3IgbWFuYWdpbmcgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW5zCiAgICAgKiBiZXR3ZWVuIGEgY2FycmllciBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBDYXJyaWVyIGFwcHMgYXJlIGVuY291cmFnZWQgdG8gaW1wbGVtZW50IHRoaXMgYWN0aXZpdHksIGFuZCB0aGUgT1Mgd2lsbAogICAgICogcHJvdmlkZSBhbiBhZmZvcmRhbmNlIHRvIHF1aWNrbHkgZW50ZXIgdGhpcyBhY3Rpdml0eSwgdHlwaWNhbGx5IHZpYQogICAgICogU2V0dGluZ3MuIFRoaXMgYWZmb3JkYW5jZSB3aWxsIG9ubHkgYmUgc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMKICAgICAqIGFjdGl2ZWx5IHByb3ZpZGluZyBzdWJzY3JpcHRpb24gcGxhbiBpbmZvcm1hdGlvbiB2aWEKICAgICAqIHtAbGluayAjc2V0U3Vic2NyaXB0aW9uUGxhbnMoaW50LCBMaXN0KX0uCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIHRoZSB1c2VyIGlzIGludGVyZXN0ZWQgaW4uCiAgICAgKi8KICAgIEBTZGtDb25zdGFudChTZGtDb25zdGFudFR5cGUuQUNUSVZJVFlfSU5URU5UX0FDVElPTikKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TIjsKCiAgICAvKioKICAgICAqIEJyb2FkY2FzdCBBY3Rpb246IFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFucwogICAgICogYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEgc3BlY2lmaWMgc3Vic2NyaWJlci4KICAgICAqIDxwPgogICAgICogQ2FycmllciBhcHBzIGFyZSBlbmNvdXJhZ2VkIHRvIGltcGxlbWVudCB0aGlzIHJlY2VpdmVyLCBhbmQgdGhlIE9TIHdpbGwKICAgICAqIHByb3ZpZGUgYW4gYWZmb3JkYW5jZSB0byByZXF1ZXN0IGEgcmVmcmVzaC4gVGhpcyBhZmZvcmRhbmNlIHdpbGwgb25seSBiZQogICAgICogc2hvd24gd2hlbiB0aGUgY2FycmllciBhcHAgaXMgYWN0aXZlbHkgcHJvdmlkaW5nIHN1YnNjcmlwdGlvbiBwbGFuCiAgICAgKiBpbmZvcm1hdGlvbiB2aWEge0BsaW5rICNzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQsIExpc3QpfS4KICAgICAqIDxwPgogICAgICogQ29udGFpbnMge0BsaW5rICNFWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVh9IHRvIGluZGljYXRlIHdoaWNoIHN1YnNjcmlwdGlvbgogICAgICogdGhlIHVzZXIgaXMgaW50ZXJlc3RlZCBpbi4KICAgICAqIDxwPgogICAgICogUmVjZWl2ZXJzIHNob3VsZCBwcm90ZWN0IHRoZW1zZWx2ZXMgYnkgY2hlY2tpbmcgdGhhdCB0aGUgc2VuZGVyIGhvbGRzIHRoZQogICAgICoge0Bjb2RlIGFuZHJvaWQucGVybWlzc2lvbi5NQU5BR0VfU1VCU0NSSVBUSU9OX1BMQU5TfSBwZXJtaXNzaW9uLgogICAgICovCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBTdHJpbmcgQUNUSU9OX1JFRlJFU0hfU1VCU0NSSVBUSU9OX1BMQU5TCiAgICAgICAgICAgID0gImFuZHJvaWQudGVsZXBob255LmFjdGlvbi5SRUZSRVNIX1NVQlNDUklQVElPTl9QTEFOUyI7CgogICAgLyoqCiAgICAgKiBCcm9hZGNhc3QgQWN0aW9uOiBUaGUgYmlsbGluZyByZWxhdGlvbnNoaXAgcGxhbnMgYmV0d2VlbiBhIGNhcnJpZXIgYW5kIGEKICAgICAqIHNwZWNpZmljIHN1YnNjcmliZXIgaGFzIGNoYW5nZWQuCiAgICAgKiA8cD4KICAgICAqIENvbnRhaW5zIHtAbGluayAjRVhUUkFfU1VCU0NSSVBUSU9OX0lOREVYfSB0byBpbmRpY2F0ZSB3aGljaCBzdWJzY3JpcHRpb24KICAgICAqIGNoYW5nZWQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAU2RrQ29uc3RhbnQoU2RrQ29uc3RhbnRUeXBlLkJST0FEQ0FTVF9JTlRFTlRfQUNUSU9OKQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTUFOQUdFX1NVQlNDUklQVElPTl9QTEFOUykKICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEFDVElPTl9TVUJTQ1JJUFRJT05fUExBTlNfQ0hBTkdFRAogICAgICAgICAgICA9ICJhbmRyb2lkLnRlbGVwaG9ueS5hY3Rpb24uU1VCU0NSSVBUSU9OX1BMQU5TX0NIQU5HRUQiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB1c2VkIHdpdGgge0BsaW5rICNBQ1RJT05fREVGQVVMVF9TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gYW5kCiAgICAgKiB7QGxpbmsgI0FDVElPTl9ERUZBVUxUX1NNU19TVUJTQ1JJUFRJT05fQ0hBTkdFRH0gdG8gaW5kaWNhdGUgdGhlIHN1YnNjcmlwdGlvbgogICAgICogd2hpY2ggaGFzIGNoYW5nZWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgU3RyaW5nIEVYVFJBX1NVQlNDUklQVElPTl9JTkRFWCA9ICJhbmRyb2lkLnRlbGVwaG9ueS5leHRyYS5TVUJTQ1JJUFRJT05fSU5ERVgiOwoKICAgIC8qKgogICAgICogSW50ZWdlciBleHRyYSB0byBzcGVjaWZ5IFNJTSBzbG90IGluZGV4LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBFWFRSQV9TTE9UX0lOREVYID0gImFuZHJvaWQudGVsZXBob255LmV4dHJhLlNMT1RfSU5ERVgiOwoKICAgIHByaXZhdGUgZmluYWwgQ29udGV4dCBtQ29udGV4dDsKCiAgICAvLyBDYWNoZSBvZiBSZXNvdXJjZSB0aGF0IGhhcyBiZWVuIGNyZWF0ZWQgaW4gZ2V0UmVzb3VyY2VzRm9yU3ViSWQuIEtleSBpcyBhIFBhaXIgY29udGFpbmluZwogICAgLy8gdGhlIENvbnRleHQgYW5kIHN1YklkLgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTWFwPFBhaXI8Q29udGV4dCwgSW50ZWdlcj4sIFJlc291cmNlcz4gc1Jlc291cmNlc0NhY2hlID0KICAgICAgICAgICAgbmV3IENvbmN1cnJlbnRIYXNoTWFwPD4oKTsKCiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgY2xhc3MgZm9yIG1vbml0b3JpbmcgY2hhbmdlcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3Jkcy4KICAgICAqIDxwPgogICAgICogT3ZlcnJpZGUgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIGluIHRoZSBvYmplY3QgdGhhdCBleHRlbmRzIHRoaXMKICAgICAqIGNsYXNzIGFuZCBwYXNzIGl0IHRvIHtAbGluayAjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcil9CiAgICAgKiB0byByZWdpc3RlciB5b3VyIGxpc3RlbmVyIGFuZCB0byB1bnJlZ2lzdGVyIGludm9rZQogICAgICoge0BsaW5rICNyZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciAjb25TdWJzY3JpcHRpb25zQ2hhbmdlZCB0byBiZSBpbnZva2VkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGNsYXNzIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciB7CiAgICAgICAgcHJpdmF0ZSBjbGFzcyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyIGV4dGVuZHMgSGFuZGxlciB7CiAgICAgICAgICAgIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lckhhbmRsZXIoKSB7CiAgICAgICAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKExvb3BlciBsb29wZXIpIHsKICAgICAgICAgICAgICAgIHN1cGVyKGxvb3Blcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFBvc3RlZCBleGVjdXRvciBjYWxsYmFjayBvbiB0aGUgaGFuZGxlciBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBsb29wZXIuCiAgICAgICAgICogVGhlIGxvb3BlciBjYW4gYmUgdGhlIGNhbGxpbmcgdGhyZWFkJ3MgbG9vcGVyIG9yIHRoZSBsb29wZXIgcGFzc2VkIGZyb20gdGhlCiAgICAgICAgICogY29uc3RydWN0b3Ige0BsaW5rICNPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyKX0uCiAgICAgICAgICovCiAgICAgICAgcHJpdmF0ZSBmaW5hbCBIYW5kbGVyRXhlY3V0b3IgbUV4ZWN1dG9yOwoKICAgICAgICAvKioKICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBIYW5kbGVyRXhlY3V0b3IgZ2V0SGFuZGxlckV4ZWN1dG9yKCkgewogICAgICAgICAgICByZXR1cm4gbUV4ZWN1dG9yOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigpIHsKICAgICAgICAgICAgbUV4ZWN1dG9yID0gbmV3IEhhbmRsZXJFeGVjdXRvcihuZXcgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVySGFuZGxlcigpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEFsbG93IGEgbGlzdGVuZXIgdG8gYmUgY3JlYXRlZCB3aXRoIGEgY3VzdG9tIGxvb3BlcgogICAgICAgICAqIEBwYXJhbSBsb29wZXIgdGhlIGxvb3BlciB0aGF0IHRoZSB1bmRlcmxpbmluZyBoYW5kbGVyIHNob3VsZCBydW4gb24KICAgICAgICAgKiBAaGlkZQogICAgICAgICAqLwogICAgICAgIHB1YmxpYyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoTG9vcGVyIGxvb3BlcikgewogICAgICAgICAgICBtRXhlY3V0b3IgPSBuZXcgSGFuZGxlckV4ZWN1dG9yKG5ldyBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJIYW5kbGVyKGxvb3BlcikpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIHRoZXJlIGlzIGFueSBjaGFuZ2UgdG8gYW55IFN1YnNjcmlwdGlvbkluZm8sIGFzIHdlbGwgYXMgb25jZSBvbgogICAgICAgICAqIHJlZ2lzdGVyaW5nIGZvciBjaGFuZ2VzIHdpdGgge0BsaW5rICNhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9LiBUeXBpY2FsbHkKICAgICAgICAgKiB0aGlzIG1ldGhvZCB3b3VsZCBpbnZva2Uge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0KICAgICAgICAgKi8KICAgICAgICBwdWJsaWMgdm9pZCBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkKCkgewogICAgICAgICAgICBpZiAoREJHKSBsb2coIm9uU3Vic2NyaXB0aW9uc0NoYW5nZWQ6IE5PVCBPVkVSUklEREVOIik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBpbnZva2VkIHdoZW4ge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjYWRkT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAqIEV4ZWN1dG9yLCBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBvcgogICAgICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2FkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgKiBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIpfSBmYWlscyB0byBjb21wbGV0ZSBkdWUgdG8gdGhlCiAgICAgICAgICoge0BsaW5rIENvbnRleHQjVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0V9IGJlaW5nIHVuYXZhaWxhYmxlLgogICAgICAgICAqIEBoaWRlCiAgICAgICAgICovCiAgICAgICAgcHVibGljIHZvaWQgb25BZGRMaXN0ZW5lckZhaWxlZCgpIHsKICAgICAgICAgICAgUmxvZy53KExPR19UQUcsICJvbkFkZExpc3RlbmVyRmFpbGVkIG5vdCBvdmVycmlkZGVuIik7CiAgICAgICAgfQoKICAgICAgICBwcml2YXRlIHZvaWQgbG9nKFN0cmluZyBzKSB7CiAgICAgICAgICAgIFJsb2cuZChMT0dfVEFHLCBzKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIFN1YnNjcmlwdGlvbk1hbmFnZXIoQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgaWYgKERCRykgbG9nZCgiU3Vic2NyaXB0aW9uTWFuYWdlciBjcmVhdGVkIik7CiAgICAgICAgbUNvbnRleHQgPSBjb250ZXh0OwogICAgfQoKICAgIHByaXZhdGUgTmV0d29ya1BvbGljeU1hbmFnZXIgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKSB7CiAgICAgICAgcmV0dXJuIChOZXR3b3JrUG9saWN5TWFuYWdlcikgbUNvbnRleHQKICAgICAgICAgICAgICAgIC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuTkVUV09SS19QT0xJQ1lfU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAZGVwcmVjYXRlZCBkZXZlbG9wZXJzIHNob3VsZCBhbHdheXMgb2J0YWluIHJlZmVyZW5jZXMgZGlyZWN0bHkgZnJvbQogICAgICogICAgICAgICAgICAge0BsaW5rIENvbnRleHQjZ2V0U3lzdGVtU2VydmljZShDbGFzcyl9LgogICAgICovCiAgICBARGVwcmVjYXRlZAogICAgcHVibGljIHN0YXRpYyBTdWJzY3JpcHRpb25NYW5hZ2VyIGZyb20oQ29udGV4dCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIChTdWJzY3JpcHRpb25NYW5hZ2VyKSBjb250ZXh0CiAgICAgICAgICAgICAgICAuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9TVUJTQ1JJUFRJT05fU0VSVklDRSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBhY3RpdmUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgb3IgdG8gdGhlCiAgICAgKiBpbmRpdmlkdWFsIHJlY29yZHMgdGhlbXNlbHZlcy4gV2hlbiBhIGNoYW5nZSBvY2N1cnMgdGhlIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIG9mCiAgICAgKiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBpbnZva2VkIGltbWVkaWF0ZWx5IGlmIHRoZXJlIGhhcyBiZWVuIGEgbm90aWZpY2F0aW9uLiBUaGUKICAgICAqIG9uU3Vic2NyaXB0aW9uQ2hhbmdlZCBtZXRob2Qgd2lsbCBhbHNvIGJlIHRyaWdnZXJlZCBvbmNlIGluaXRpYWxseSB3aGVuIGNhbGxpbmcgdGhpcwogICAgICogZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IHdpdGgKICAgICAqICAgICAgICAgICAgICAgICBvblN1YnNjcmlwdGlvbnNDaGFuZ2VkIG92ZXJyaWRkZW4uCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIGFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lci5tRXhlY3V0b3IsIGxpc3RlbmVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlZ2lzdGVyIGZvciBjaGFuZ2VzIHRvIHRoZSBsaXN0IG9mIGFjdGl2ZSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcyBvciB0byB0aGUKICAgICAqIGluZGl2aWR1YWwgcmVjb3JkcyB0aGVtc2VsdmVzLiBXaGVuIGEgY2hhbmdlIG9jY3VycyB0aGUgb25TdWJzY3JpcHRpb25zQ2hhbmdlZCBtZXRob2Qgb2YKICAgICAqIHRoZSBsaXN0ZW5lciB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkgaWYgdGhlcmUgaGFzIGJlZW4gYSBub3RpZmljYXRpb24uIFRoZQogICAgICogb25TdWJzY3JpcHRpb25DaGFuZ2VkIG1ldGhvZCB3aWxsIGFsc28gYmUgdHJpZ2dlcmVkIG9uY2UgaW5pdGlhbGx5IHdoZW4gY2FsbGluZyB0aGlzCiAgICAgKiBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXIgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0gd2l0aAogICAgICogICAgICAgICAgICAgICAgIG9uU3Vic2NyaXB0aW9uc0NoYW5nZWQgb3ZlcnJpZGRlbi4KICAgICAqIEBwYXJhbSBleGVjdXRvciB0aGUgZXhlY3V0b3IgdGhhdCB3aWxsIGV4ZWN1dGUgY2FsbGJhY2tzLgogICAgICovCiAgICBwdWJsaWMgdm9pZCBhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgIEBOb25OdWxsIEBDYWxsYmFja0V4ZWN1dG9yIEV4ZWN1dG9yIGV4ZWN1dG9yLAogICAgICAgICAgICBATm9uTnVsbCBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBTdHJpbmcgcGtnTmFtZSA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInJlZ2lzdGVyIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBwa2dOYW1lPSIgKyBwa2dOYW1lCiAgICAgICAgICAgICAgICAgICAgKyAiIGxpc3RlbmVyPSIgKyBsaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIC8vIFdlIHVzZSB0aGUgVGVsZXBob255UmVnaXN0cnkgYXMgaXQgcnVucyBpbiB0aGUgc3lzdGVtIGFuZCB0aHVzIGlzIGFsd2F5cwogICAgICAgIC8vIGF2YWlsYWJsZS4gV2hlcmUgYXMgU3Vic2NyaXB0aW9uQ29udHJvbGxlciBjb3VsZCBjcmFzaCBhbmQgbm90IGJlIGF2YWlsYWJsZQogICAgICAgIFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgPSAoVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyKQogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLmFkZE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lciwKICAgICAgICAgICAgICAgICAgICBleGVjdXRvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHRlbGVwaG9ueSByZWdpc3RyeSBpc24ndCBhdmFpbGFibGUsIHdlIHdpbGwgaW5mb3JtIHRoZSBjYWxsZXIgb24gdGhlaXIKICAgICAgICAgICAgLy8gbGlzdGVuZXIgdGhhdCBpdCBmYWlsZWQgc28gdGhleSBjYW4gdHJ5IHRvIHJlLXJlZ2lzdGVyLgogICAgICAgICAgICBsb2dlKCJhZGRPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXI6IHBrZ25hbWU9IiArIHBrZ05hbWUgKyAiIGZhaWxlZCB0byBiZSBhZGRlZCAiCiAgICAgICAgICAgICAgICAgICAgKyAiIGR1ZSB0byBURUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSBiZWluZyB1bmF2YWlsYWJsZS4iKTsKICAgICAgICAgICAgZXhlY3V0b3IuZXhlY3V0ZSgoKSAtPiBsaXN0ZW5lci5vbkFkZExpc3RlbmVyRmFpbGVkKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVucmVnaXN0ZXIgdGhlIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9LiBUaGlzIGlzIG5vdCBzdHJpY3RseSBuZWNlc3NhcnkKICAgICAqIGFzIHRoZSBsaXN0ZW5lciB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgdW5yZWdpc3RlcmVkIGlmIGFuIGF0dGVtcHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lcgogICAgICogZmFpbHMuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIHRoYXQgaXMgdG8gYmUgdW5yZWdpc3RlcmVkLgogICAgICovCiAgICBwdWJsaWMgdm9pZCByZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICAgICAgaWYgKGxpc3RlbmVyID09IG51bGwpIHJldHVybjsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKERCRykgewogICAgICAgICAgICBsb2dkKCJ1bnJlZ2lzdGVyIE9uU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBwa2dGb3JEZWJ1Zz0iICsgcGtnRm9yRGVidWcKICAgICAgICAgICAgICAgICAgICArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2UgdXNlIHRoZSBUZWxlcGhvbnlSZWdpc3RyeSBhcyBpdCBydW5zIGluIHRoZSBzeXN0ZW0gYW5kIHRodXMgaXMgYWx3YXlzCiAgICAgICAgLy8gYXZhaWxhYmxlIHdoZXJlIGFzIFN1YnNjcmlwdGlvbkNvbnRyb2xsZXIgY291bGQgY3Jhc2ggYW5kIG5vdCBiZSBhdmFpbGFibGUKICAgICAgICBUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyID0gKFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlcikKICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldFN5c3RlbVNlcnZpY2UoQ29udGV4dC5URUxFUEhPTllfUkVHSVNUUllfU0VSVklDRSk7CiAgICAgICAgaWYgKHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciAhPSBudWxsKSB7CiAgICAgICAgICAgIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlci5yZW1vdmVPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIobGlzdGVuZXIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgY2xhc3MgZm9yIG1vbml0b3JpbmcgY2hhbmdlcyB0byB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcyBvZiBvcHBvcnR1bmlzdGljCiAgICAgKiBzdWJzY3JpcHRpb25zLgogICAgICogPHA+CiAgICAgKiBPdmVycmlkZSB0aGUgb25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQgbWV0aG9kIGluIHRoZSBvYmplY3QgdGhhdCBleHRlbmRzIHRoaXMKICAgICAqIG9yIHtAbGluayAjYWRkT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAqIEV4ZWN1dG9yLCBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIHRvIHJlZ2lzdGVyIHlvdXIgbGlzdGVuZXIgYW5kIHRvIHVucmVnaXN0ZXIgaW52b2tlCiAgICAgKiB7QGxpbmsgI3JlbW92ZU9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgKiBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKX0KICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqIGZvciAjb25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQgdG8gYmUgaW52b2tlZC4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBjbGFzcyBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIHsKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBpbnZva2VkIHdoZW4gdGhlcmUgaXMgYW55IGNoYW5nZSB0byBhbnkgU3Vic2NyaXB0aW9uSW5mby4gVHlwaWNhbGx5CiAgICAgICAgICogdGhpcyBtZXRob2Qgd291bGQgaW52b2tlIHtAbGluayAjZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3R9CiAgICAgICAgICovCiAgICAgICAgcHVibGljIHZvaWQgb25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQoKSB7CiAgICAgICAgICAgIGlmIChEQkcpIGxvZygib25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQ6IE5PVCBPVkVSUklEREVOIik7CiAgICAgICAgfQoKICAgICAgICBwcml2YXRlIHZvaWQgbG9nKFN0cmluZyBzKSB7CiAgICAgICAgICAgIFJsb2cuZChMT0dfVEFHLCBzKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWdpc3RlciBmb3IgY2hhbmdlcyB0byB0aGUgbGlzdCBvZiBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbiByZWNvcmRzIG9yIHRvIHRoZQogICAgICogaW5kaXZpZHVhbCByZWNvcmRzIHRoZW1zZWx2ZXMuIFdoZW4gYSBjaGFuZ2Ugb2NjdXJzIHRoZSBvbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZAogICAgICogbWV0aG9kIG9mIHRoZSBsaXN0ZW5lciB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkgaWYgdGhlcmUgaGFzIGJlZW4gYSBub3RpZmljYXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIGFuIGluc3RhbmNlIG9mIHtAbGluayBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSB3aXRoCiAgICAgKiAgICAgICAgICAgICAgICAgb25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWQgb3ZlcnJpZGRlbi4KICAgICAqLwogICAgcHVibGljIHZvaWQgYWRkT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcigKICAgICAgICAgICAgQE5vbk51bGwgQENhbGxiYWNrRXhlY3V0b3IgRXhlY3V0b3IgZXhlY3V0b3IsCiAgICAgICAgICAgIEBOb25OdWxsIE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIgbGlzdGVuZXIpIHsKICAgICAgICBpZiAoZXhlY3V0b3IgPT0gbnVsbCB8fCBsaXN0ZW5lciA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIFN0cmluZyBwa2dOYW1lID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgbG9nZCgicmVnaXN0ZXIgYWRkT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBwa2dOYW1lPSIgKyBwa2dOYW1lCiAgICAgICAgICAgICAgICAgICAgKyAiIGxpc3RlbmVyPSIgKyBsaXN0ZW5lcik7CiAgICAgICAgfQoKICAgICAgICAvLyBXZSB1c2UgdGhlIFRlbGVwaG9ueVJlZ2lzdHJ5IGFzIGl0IHJ1bnMgaW4gdGhlIHN5c3RlbSBhbmQgdGh1cyBpcyBhbHdheXMKICAgICAgICAvLyBhdmFpbGFibGUgd2hlcmUgYXMgU3Vic2NyaXB0aW9uQ29udHJvbGxlciBjb3VsZCBjcmFzaCBhbmQgbm90IGJlIGF2YWlsYWJsZQogICAgICAgIFRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgPSAoVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyKQogICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0U3lzdGVtU2VydmljZShDb250ZXh0LlRFTEVQSE9OWV9SRUdJU1RSWV9TRVJWSUNFKTsKICAgICAgICBpZiAodGVsZXBob255UmVnaXN0cnlNYW5hZ2VyICE9IG51bGwpIHsKICAgICAgICAgICAgdGVsZXBob255UmVnaXN0cnlNYW5hZ2VyLmFkZE9uT3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIoCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIsIGV4ZWN1dG9yKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBVbnJlZ2lzdGVyIHRoZSB7QGxpbmsgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcn0gdGhhdCBpcyBjdXJyZW50bHkKICAgICAqIGxpc3RlbmluZyBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgY2hhbmdlLiBUaGlzIGlzIG5vdCBzdHJpY3RseSBuZWNlc3NhcnkKICAgICAqIGFzIHRoZSBsaXN0ZW5lciB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgdW5yZWdpc3RlcmVkIGlmIGFuIGF0dGVtcHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lcgogICAgICogZmFpbHMuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVyIHRoYXQgaXMgdG8gYmUgdW5yZWdpc3RlcmVkLgogICAgICovCiAgICBwdWJsaWMgdm9pZCByZW1vdmVPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyKAogICAgICAgICAgICBATm9uTnVsbCBPbk9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyIGxpc3RlbmVyKSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwobGlzdGVuZXIsICJsaXN0ZW5lciBjYW5ub3QgYmUgbnVsbCIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInVucmVnaXN0ZXIgT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lciBwa2dGb3JEZWJ1Zz0iCiAgICAgICAgICAgICAgICAgICAgKyBwa2dGb3JEZWJ1ZyArICIgbGlzdGVuZXI9IiArIGxpc3RlbmVyKTsKICAgICAgICB9CiAgICAgICAgVGVsZXBob255UmVnaXN0cnlNYW5hZ2VyIHRlbGVwaG9ueVJlZ2lzdHJ5TWFuYWdlciA9IChUZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIpCiAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRTeXN0ZW1TZXJ2aWNlKENvbnRleHQuVEVMRVBIT05ZX1JFR0lTVFJZX1NFUlZJQ0UpOwogICAgICAgIGlmICh0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIgIT0gbnVsbCkgewogICAgICAgICAgICB0ZWxlcGhvbnlSZWdpc3RyeU1hbmFnZXIucmVtb3ZlT25PcHBvcnR1bmlzdGljU3Vic2NyaXB0aW9uc0NoYW5nZWRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBhY3RpdmUgU3Vic2NyaXB0aW9uSW5mbyB3aXRoIHRoZSBpbnB1dCBzdWJJZC4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyBQZXJtaXNzaW9uOiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgVGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGtleSBpbiBkYXRhYmFzZS4KICAgICAqIEByZXR1cm4gU3Vic2NyaXB0aW9uSW5mbywgbWF5YmUgbnVsbCBpZiBpdHMgbm90IGFjdGl2ZS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGludCBzdWJJZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb10rIHN1YklkPSIgKyBzdWJJZCk7CiAgICAgICAgaWYgKCFpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoc3ViSWQpKSB7CiAgICAgICAgICAgIGlmIChEQkcpIHsKICAgICAgICAgICAgICAgIGxvZ2QoIltnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvXS0gaW52YWxpZCBzdWJJZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3Vic2NyaXB0aW9uSW5mbyBzdWJJbmZvID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YkluZm8gPSBpU3ViLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oc3ViSWQsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3ViSW5mbzsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgYW4gYWN0aXZlIFN1YnNjcmlwdGlvbkluZm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IGFzc29jaWF0ZWQgd2l0aCB0aGUgU2ltIEljY0lkLgogICAgICoKICAgICAqIEBwYXJhbSBpY2NJZCB0aGUgSWNjSWQgb2YgU0lNIGNhcmQKICAgICAqIEByZXR1cm4gU3Vic2NyaXB0aW9uSW5mbywgbWF5YmUgbnVsbCBpZiBpdHMgbm90IGFjdGl2ZQogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIEBOdWxsYWJsZQogICAgQFN5c3RlbUFwaQogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvckljYyhATm9uTnVsbCBTdHJpbmcgaWNjSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JJY2NJbmRleF0rIGljY0lkPSIgKyBpY2NJZCk7CiAgICAgICAgaWYgKGljY0lkID09IG51bGwpIHsKICAgICAgICAgICAgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JJY2NJbmRleF0tIG51bGwgaWNjaWQiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBTdWJzY3JpcHRpb25JbmZvIHJlc3VsdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JJY2NJZChpY2NJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFjdGl2ZSBTdWJzY3JpcHRpb25JbmZvIGFzc29jaWF0ZWQgd2l0aCB0aGUgc2xvdEluZGV4CiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuCiAgICAgKgogICAgICogQHBhcmFtIHNsb3RJbmRleCB0aGUgc2xvdCB3aGljaCB0aGUgc3Vic2NyaXB0aW9uIGlzIGluc2VydGVkCiAgICAgKiBAcmV0dXJuIFN1YnNjcmlwdGlvbkluZm8sIG1heWJlIG51bGwgaWYgaXRzIG5vdCBhY3RpdmUKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvRm9yU2ltU2xvdEluZGV4KGludCBzbG90SW5kZXgpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JTaW1TbG90SW5kZXhdKyBzbG90SW5kZXg9IiArIHNsb3RJbmRleCk7CiAgICAgICAgaWYgKCFpc1ZhbGlkU2xvdEluZGV4KHNsb3RJbmRleCkpIHsKICAgICAgICAgICAgbG9nZCgiW2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Gb3JTaW1TbG90SW5kZXhdLSBpbnZhbGlkIHNsb3RJbmRleCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIFN1YnNjcmlwdGlvbkluZm8gcmVzdWx0ID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0ZvclNpbVNsb3RJbmRleChzbG90SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiBMaXN0IG9mIGFsbCBTdWJzY3JpcHRpb25JbmZvIHJlY29yZHMgaW4gZGF0YWJhc2UsCiAgICAgKiBpbmNsdWRlIHRob3NlIHRoYXQgd2VyZSBpbnNlcnRlZCBiZWZvcmUsIG1heWJlIGVtcHR5IGJ1dCBub3QgbnVsbC4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBbGxTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW2dldEFsbFN1YnNjcmlwdGlvbkluZm9MaXN0XSsiKTsKCiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBbGxTdWJJbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4gVGhlIHJlY29yZHMgd2lsbCBiZSBzb3J0ZWQKICAgICAqIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKgogICAgICogPHA+UmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKiBvciB0aGF0IHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIChzZWUKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzfSkuIEluIHRoZSBsYXR0ZXIgY2FzZSwgb25seSByZWNvcmRzIGFjY2Vzc2libGUKICAgICAqIHRvIHRoZSBjYWxsaW5nIGFwcCBhcmUgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHJldHVybiBTb3J0ZWQgbGlzdCBvZiB0aGUgY3VycmVudGx5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGF2YWlsYWJsZSBvbiB0aGUgZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9CiAgICAgKiBoYXMgYmVlbiByZWdpc3RlcmVkIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZQogICAgICogaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPC9saT4KICAgICAqIDxsaT4KICAgICAqIElmIHRoZSBsaXN0IGlzIGVtcHR5IHRoZW4gdGhlcmUgYXJlIG5vIHtAbGluayBTdWJzY3JpcHRpb25JbmZvfSByZWNvcmRzIGN1cnJlbnRseSBhdmFpbGFibGUuCiAgICAgKiA8L2xpPgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvbGk+CiAgICAgKiA8L3VsPgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgvKiB1c2VyVmlzaWJsZW9ubHkgKi90cnVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBib3RoIGhpZGRlbiBhbmQgdmlzaWJsZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqIFRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0KICAgICAqIHRoZW4gYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEhpZGRlbiBzdWJzY3JpcHRpb25zIHJlZmVyIHRvIHRob3NlIGFyZSBub3QgbWVhbnQgdmlzaWJsZSB0byB0aGUgdXNlcnMuCiAgICAgKiBGb3IgZXhhbXBsZSwgYW4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gdGhhdCBpcyBncm91cGVkIHdpdGggb3RoZXIKICAgICAqIHN1YnNjcmlwdGlvbnMgc2hvdWxkIHJlbWFpbiBpbnZpc2libGUgdG8gdXNlcnMgYXMgdGhleSBhcmUgb25seSBmdW5jdGlvbmFsbHkKICAgICAqIHN1cHBsZW1lbnRhcnkgdG8gcHJpbWFyeSBvbmVzLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIG9ubHkgcmVjb3JkcyBhY2Nlc3NpYmxlCiAgICAgKiB0byB0aGUgY2FsbGluZyBhcHAgYXJlIHJldHVybmVkLgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnRseSBhdmFpbGFibGUge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99CiAgICAgKiByZWNvcmRzIG9uIHRoZSBkZXZpY2UuCiAgICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gZXhjZXB0IHRoYXQgaXQgd2lsbCByZXR1cm4KICAgICAqIGJvdGggYWN0aXZlIGFuZCBoaWRkZW4gU3Vic2NyaXB0aW9uSW5mb3MuCiAgICAgKgogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRDb21wbGV0ZUFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gY29tcGxldGVMaXN0ID0gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mb0xpc3QoCiAgICAgICAgICAgICAgICAvKiB1c2VyVmlzaWJsZW9ubHkgKi9mYWxzZSk7CiAgICAgICAgaWYgKGNvbXBsZXRlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBsZXRlTGlzdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcGxldGVMaXN0OwogICAgfQoKICAgIC8qKgogICAgKiBUaGlzIGlzIHNpbWlsYXIgdG8ge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdCgpfSwgYnV0IGlmIHVzZXJWaXNpYmxlT25seQogICAgKiBpcyB0cnVlLCBpdCB3aWxsIGZpbHRlciBvdXQgdGhlIGhpZGRlbiBzdWJzY3JpcHRpb25zLgogICAgKgogICAgKiBAaGlkZQogICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChib29sZWFuIHVzZXJWaXNpYmxlT25seSkgewogICAgICAgIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gYWN0aXZlTGlzdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVMaXN0ID0gaVN1Yi5nZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgaWYgKCF1c2VyVmlzaWJsZU9ubHkgfHwgYWN0aXZlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhY3RpdmVMaXN0LnN0cmVhbSgpLmZpbHRlcihzdWJJbmZvIC0+IGlzU3Vic2NyaXB0aW9uVmlzaWJsZShzdWJJbmZvKSkKICAgICAgICAgICAgICAgICAgICAuY29sbGVjdChDb2xsZWN0b3JzLnRvTGlzdCgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBTdWJzY3JpcHRpb25JbmZvKHMpIG9mIGFsbCBhdmFpbGFibGUgc3Vic2NyaXB0aW9ucywgaWYgYW55LgogICAgICoKICAgICAqIDxwPkF2YWlsYWJsZSBzdWJzY3JpcHRpb25zIGluY2x1ZGUgYWN0aXZlIG9uZXMgKHRob3NlIHdpdGggYSBub24tbmVnYXRpdmUKICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleCgpfSkgYXMgd2VsbCBhcyBpbmFjdGl2ZSBidXQgaW5zdGFsbGVkIGVtYmVkZGVkCiAgICAgKiBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlLgogICAgICogPHVsPgogICAgICogPGxpPgogICAgICogSWYgbnVsbCBpcyByZXR1cm5lZCB0aGUgY3VycmVudCBzdGF0ZSBpcyB1bmtub3duIGJ1dCBpZiBhCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyfSBoYXMgYmVlbiByZWdpc3RlcmVkCiAgICAgKiB7QGxpbmsgT25TdWJzY3JpcHRpb25zQ2hhbmdlZExpc3RlbmVyI29uU3Vic2NyaXB0aW9uc0NoYW5nZWR9IHdpbGwgYmUgaW52b2tlZCBpbiB0aGUgZnV0dXJlLgogICAgICogPGxpPgogICAgICogSWYgdGhlIGxpc3QgaXMgZW1wdHkgdGhlbiB0aGVyZSBhcmUgbm8ge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgY3VycmVudGx5IGF2YWlsYWJsZS4KICAgICAqIDxsaT4KICAgICAqIGlmIHRoZSBsaXN0IGlzIG5vbi1lbXB0eSB0aGUgbGlzdCBpcyBzb3J0ZWQgYnkge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U2ltU2xvdEluZGV4fQogICAgICogdGhlbiBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTdWJzY3JpcHRpb25JZH0uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yICNnZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdCB0byBiZSBpbnZva2VkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIExpc3Q8U3Vic2NyaXB0aW9uSW5mbz4gZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiByZXN1bHQgPSBudWxsOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gaVN1Yi5nZXRBdmFpbGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgU3Vic2NyaXB0aW9uSW5mbyhzKSBvZiBhbGwgZW1iZWRkZWQgc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsaW5nIGFwcCwgaWYKICAgICAqIGFueS4KICAgICAqCiAgICAgKiA8cD5Pbmx5IHRob3NlIHN1YnNjcmlwdGlvbnMgZm9yIHdoaWNoIHRoZSBjYWxsaW5nIGFwcCBoYXMgY2FycmllciBwcml2aWxlZ2VzIHBlciB0aGUKICAgICAqIHN1YnNjcmlwdGlvbiBtZXRhZGF0YSwgaWYgYW55LCB3aWxsIGJlIGluY2x1ZGVkIGluIHRoZSByZXR1cm5lZCBsaXN0LgogICAgICoKICAgICAqIDxwPlRoZSByZWNvcmRzIHdpbGwgYmUgc29ydGVkIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFNpbVNsb3RJbmRleH0gdGhlbiBieQogICAgICoge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jZ2V0U3Vic2NyaXB0aW9uSWR9LgogICAgICoKICAgICAqIEByZXR1cm4gU29ydGVkIGxpc3Qgb2YgdGhlIGN1cnJlbnQgZW1iZWRkZWQge0BsaW5rIFN1YnNjcmlwdGlvbkluZm99IHJlY29yZHMgYXZhaWxhYmxlIG9uIHRoZQogICAgICogZGV2aWNlIHdoaWNoIGFyZSBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKiA8dWw+CiAgICAgKiA8bGk+CiAgICAgKiBJZiBudWxsIGlzIHJldHVybmVkIHRoZSBjdXJyZW50IHN0YXRlIGlzIHVua25vd24gYnV0IGlmIGEKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXJ9IGhhcyBiZWVuIHJlZ2lzdGVyZWQKICAgICAqIHtAbGluayBPblN1YnNjcmlwdGlvbnNDaGFuZ2VkTGlzdGVuZXIjb25TdWJzY3JpcHRpb25zQ2hhbmdlZH0gd2lsbCBiZSBpbnZva2VkIGluIHRoZSBmdXR1cmUuCiAgICAgKiA8bGk+CiAgICAgKiBJZiB0aGUgbGlzdCBpcyBlbXB0eSB0aGVuIHRoZXJlIGFyZSBubyB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mb30gcmVjb3JkcyBjdXJyZW50bHkgYXZhaWxhYmxlLgogICAgICogPGxpPgogICAgICogaWYgdGhlIGxpc3QgaXMgbm9uLWVtcHR5IHRoZSBsaXN0IGlzIHNvcnRlZCBieSB7QGxpbmsgU3Vic2NyaXB0aW9uSW5mbyNnZXRTaW1TbG90SW5kZXh9CiAgICAgKiB0aGVuIGJ5IHtAbGluayBTdWJzY3JpcHRpb25JbmZvI2dldFN1YnNjcmlwdGlvbklkfS4KICAgICAqIDwvdWw+CiAgICAgKi8KICAgIHB1YmxpYyBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdCgpIHsKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHJlc3VsdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjY2Vzc2libGVTdWJzY3JpcHRpb25JbmZvTGlzdChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVxdWVzdCBhIHJlZnJlc2ggb2YgdGhlIHBsYXRmb3JtIGNhY2hlIG9mIHByb2ZpbGUgaW5mb3JtYXRpb24gZm9yIHRoZSBlVUlDQyB3aGljaAogICAgICogY29ycmVzcG9uZHMgdG8gdGhlIGNhcmQgSUQgcmV0dXJuZWQgYnkge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaCgpIHsKICAgICAgICBpbnQgY2FyZElkID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KS5nZXRDYXJkSWRGb3JEZWZhdWx0RXVpY2MoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5yZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdFJlZnJlc2goY2FyZElkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dkKCJyZXF1ZXN0RW1iZWRkZWRTdWJzY3JpcHRpb25JbmZvTGlzdEZyZXNoIGZvciBjYXJkID0gIiArIGNhcmRJZCArICIgZmFpbGVkLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlcXVlc3QgYSByZWZyZXNoIG9mIHRoZSBwbGF0Zm9ybSBjYWNoZSBvZiBwcm9maWxlIGluZm9ybWF0aW9uIGZvciB0aGUgZVVJQ0Mgd2l0aCB0aGUgZ2l2ZW4KICAgICAqIHtAY29kZSBjYXJkSWR9LgogICAgICoKICAgICAqIDxwPlNob3VsZCBiZSBjYWxsZWQgYnkgdGhlIEV1aWNjU2VydmljZSBpbXBsZW1lbnRhdGlvbiB3aGVuZXZlciB0aGlzIGluZm9ybWF0aW9uIGNoYW5nZXMgZHVlCiAgICAgKiB0byBhbiBvcGVyYXRpb24gZG9uZSBvdXRzaWRlIHRoZSBzY29wZSBvZiBhIHJlcXVlc3QgaW5pdGlhdGVkIGJ5IHRoZSBwbGF0Zm9ybSB0byB0aGUKICAgICAqIEV1aWNjU2VydmljZS4gVGhlcmUgaXMgbm8gbmVlZCB0byByZWZyZXNoIGZvciBkb3dubG9hZHMsIGRlbGV0ZXMsIG9yIG90aGVyIG9wZXJhdGlvbnMgdGhhdAogICAgICogd2VyZSBtYWRlIHRocm91Z2ggdGhlIEV1aWNjU2VydmljZS4KICAgICAqCiAgICAgKiA8cD5SZXF1aXJlcyB0aGUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNXUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TfSBwZXJtaXNzaW9uLgogICAgICoKICAgICAqIEBwYXJhbSBjYXJkSWQgdGhlIGNhcmQgSUQgb2YgdGhlIGVVSUNDLgogICAgICoKICAgICAqIEBzZWUge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjZ2V0Q2FyZElkRm9yRGVmYXVsdEV1aWNjKCl9IGZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBjYXJkIElELgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIHB1YmxpYyB2b2lkIHJlcXVlc3RFbWJlZGRlZFN1YnNjcmlwdGlvbkluZm9MaXN0UmVmcmVzaChpbnQgY2FyZElkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIucmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RSZWZyZXNoKGNhcmRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZCgicmVxdWVzdEVtYmVkZGVkU3Vic2NyaXB0aW9uSW5mb0xpc3RGcmVzaCBmb3IgY2FyZCA9ICIgKyBjYXJkSWQgKyAiIGZhaWxlZC4iKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHRoZSBjb3VudCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZGF0YWJhc2UsIHRoaXMgaW5jbHVkZXMKICAgICAqIGFsbCBzdWJzY3JpcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNlZW4uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltnZXRBbGxTdWJzY3JpcHRpb25JbmZvQ291bnRdKyIpOwoKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWxsU3ViSW5mb0NvdW50KG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICoKICAgICAqIFJlcXVpcmVzIFBlcm1pc3Npb246IHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jUkVBRF9QSE9ORV9TVEFURSBSRUFEX1BIT05FX1NUQVRFfQogICAgICogb3IgdGhhdCB0aGUgY2FsbGluZyBhcHAgaGFzIGNhcnJpZXIgcHJpdmlsZWdlcyAoc2VlCiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30pLiBJbiB0aGUgbGF0dGVyIGNhc2UsIHRoZSBjb3VudCB3aWxsIGluY2x1ZGUKICAgICAqIG9ubHkgdGhvc2Ugc3Vic2NyaXB0aW9ucyBhY2Nlc3NpYmxlIHRvIHRoZSBjYWxsZXIuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgY3VycmVudCBudW1iZXIgb2YgYWN0aXZlIHN1YnNjcmlwdGlvbnMuIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGUgdmFsdWUKICAgICAqIHJldHVybmVkIGJ5IHRoaXMgbWV0aG9kIHdpbGwgYmUgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aCBvZiB0aGUgbGlzdCByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0uCiAgICAgKi8KICAgIEBTdXBwcmVzc0F1dG9Eb2MgLy8gQmxvY2tlZCBieSBiLzcyOTY3MjM2IC0gbm8gc3VwcG9ydCBmb3IgY2FycmllciBwcml2aWxlZ2VzCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BIT05FX1NUQVRFKQogICAgcHVibGljIGludCBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnQoKSB7CiAgICAgICAgaW50IHJlc3VsdCA9IDA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBpU3ViLmdldEFjdGl2ZVN1YkluZm9Db3VudChtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdGhlIG1heGltdW0gbnVtYmVyIG9mIGFjdGl2ZSBzdWJzY3JpcHRpb25zIHRoYXQgd2lsbCBiZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvTGlzdH0gYW5kIHRoZSB2YWx1ZSByZXR1cm5lZCBieQogICAgICoge0BsaW5rICNnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvQ291bnR9LgogICAgICovCiAgICBwdWJsaWMgaW50IGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9Db3VudE1heCgpIHsKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0QWN0aXZlU3ViSW5mb0NvdW50TWF4KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSBpY2NJZCB0aGUgSWNjSWQgb2YgdGhlIFNJTSBjYXJkCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IHdoaWNoIHRoZSBTSU0gaXMgaW5zZXJ0ZWQKICAgICAqIEByZXR1cm4gdGhlIFVSTCBvZiB0aGUgbmV3bHkgY3JlYXRlZCByb3cgb3IgdGhlIHVwZGF0ZWQgcm93CiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgVXJpIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIGljY0lkLCBpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgaWNjSWQ6IiArIGljY0lkICsgIiBzbG90SW5kZXg6IiArIHNsb3RJbmRleCk7CiAgICAgICAgaWYgKGljY0lkID09IG51bGwpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdLSBudWxsIGljY0lkIik7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFNsb3RJbmRleChzbG90SW5kZXgpKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25JbmZvUmVjb3JkXS0gaW52YWxpZCBzbG90SW5kZXgiKTsKICAgICAgICB9CgogICAgICAgIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoaWNjSWQsIG51bGwsIHNsb3RJbmRleCwgU1VCU0NSSVBUSU9OX1RZUEVfTE9DQUxfU0lNKTsKCiAgICAgICAgLy8gRklYTUU6IEFsd2F5cyByZXR1cm5zIG51bGw/CiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgbmV3IFN1YnNjcmlwdGlvbkluZm8gdG8gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZSBpZiBuZWVkZWQKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgc3BlY2lmaWMgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gZGlzcGxheU5hbWUgaHVtYW4tcmVhZGFibGUgbmFtZSBvZiB0aGUgZGV2aWNlIHRoZSBzdWJzY3JpcHRpb24gY29ycmVzcG9uZHMgdG8uCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IGFzc2lnbmVkIHRvIHRoaXMgc3Vic2NyaXB0aW9uLiBJdCBpcyBpZ25vcmVkIGZvciBzdWJzY3JpcHRpb25UeXBlCiAgICAgKiAgICAgICAgICAgICAgICAgIG9mIHtAbGluayAjU1VCU0NSSVBUSU9OX1RZUEVfUkVNT1RFX1NJTX0uCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIGFkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIHVuaXF1ZUlkLCBTdHJpbmcgZGlzcGxheU5hbWUsIGludCBzbG90SW5kZXgsCiAgICAgICAgICAgIGludCBzdWJzY3JpcHRpb25UeXBlKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2FkZFN1YnNjcmlwdGlvbkluZm9SZWNvcmRdKyB1bmlxdWVJZDoiICsgdW5pcXVlSWQKICAgICAgICAgICAgICAgICAgICArICIsIGRpc3BsYXlOYW1lOiIgKyBkaXNwbGF5TmFtZSArICIsIHNsb3RJbmRleDoiICsgc2xvdEluZGV4CiAgICAgICAgICAgICAgICAgICAgKyAiLCBzdWJzY3JpcHRpb25UeXBlOiAiICsgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmICh1bmlxdWVJZCA9PSBudWxsKSB7CiAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIHVuaXF1ZUlkIGlzIG51bGwiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViID09IG51bGwpIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIElTdWIgc2VydmljZSBpcyBudWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IHJlc3VsdCA9IGlTdWIuYWRkU3ViSW5mbyh1bmlxdWVJZCwgZGlzcGxheU5hbWUsIHNsb3RJbmRleCwgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPCAwKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiQWRkaW5nIG9mIHN1YnNjcmlwdGlvbiBkaWRuJ3Qgc3VjY2VlZDogZXJyb3IgPSAiICsgcmVzdWx0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxvZ2QoInN1Y2Nlc3NmdWxseSBhZGRlZCBuZXcgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIFN1YnNjcmlwdGlvbkluZm8gcmVjb3JkIGZyb20gdGhlIFN1YnNjcmlwdGlvbkluZm8gZGF0YWJhc2UKICAgICAqIEBwYXJhbSB1bmlxdWVJZCBUaGlzIGlzIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHN1YnNjcmlwdGlvbiB3aXRoaW4gdGhlIHNwZWNpZmljCiAgICAgKiAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uIHR5cGUuCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uVHlwZSB0aGUge0BsaW5rICNTVUJTQ1JJUFRJT05fVFlQRX0KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHJlbW92ZVN1YnNjcmlwdGlvbkluZm9SZWNvcmQoU3RyaW5nIHVuaXF1ZUlkLCBpbnQgc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIltyZW1vdmVTdWJzY3JpcHRpb25JbmZvUmVjb3JkXSsgdW5pcXVlSWQ6IiArIHVuaXF1ZUlkCiAgICAgICAgICAgICAgICAgICAgKyAiLCBzdWJzY3JpcHRpb25UeXBlOiAiICsgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmICh1bmlxdWVJZCA9PSBudWxsKSB7CiAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbYWRkU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIHVuaXF1ZUlkIGlzIG51bGwiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViID09IG51bGwpIHsKICAgICAgICAgICAgICAgIExvZy5lKExPR19UQUcsICJbcmVtb3ZlU3Vic2NyaXB0aW9uSW5mb1JlY29yZF0tIElTdWIgc2VydmljZSBpcyBudWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IHJlc3VsdCA9IGlTdWIucmVtb3ZlU3ViSW5mbyh1bmlxdWVJZCwgc3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPCAwKSB7CiAgICAgICAgICAgICAgICBMb2cuZShMT0dfVEFHLCAiUmVtb3ZhbCBvZiBzdWJzY3JpcHRpb24gZGlkbid0IHN1Y2NlZWQ6IGVycm9yID0gIiArIHJlc3VsdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsb2dkKCJzdWNjZXNzZnVsbHkgcmVtb3ZlZCBzdWJzY3JpcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgU0lNIGljb24gdGludCBjb2xvciBmb3Igc3Vic2NyaXB0aW9uIElECiAgICAgKiBAcGFyYW0gdGludCB0aGUgUkdCIHZhbHVlIG9mIGljb24gdGludCBjb2xvciBvZiB0aGUgU0lNCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpdHBpb24gSUQgaW4gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gdGhlIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IHNldEljb25UaW50KEBDb2xvckludCBpbnQgdGludCwgaW50IHN1YklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoIltzZXRJY29uVGludF0rIHRpbnQ6IiArIHRpbnQgKyAiIHN1YklkOiIgKyBzdWJJZCk7CiAgICAgICAgcmV0dXJuIHNldFN1YnNjcmlwdGlvblByb3BlcnR5SGVscGVyKHN1YklkLCAic2V0SWNvblRpbnQiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXRJY29uVGludCh0aW50LCBzdWJJZCkKICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBkaXNwbGF5IG5hbWUgZm9yIGEgc3Vic2NyaXB0aW9uIElECiAgICAgKiBAcGFyYW0gZGlzcGxheU5hbWUgdGhlIGRpc3BsYXkgbmFtZSBvZiBTSU0gY2FyZAogICAgICogQHBhcmFtIHN1YklkIHRoZSB1bmlxdWUgU3Vic2NyaXRwaW9uIElEIGluIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gbmFtZVNvdXJjZSBTSU0gZGlzcGxheSBuYW1lIHNvdXJjZQogICAgICogQHJldHVybiB0aGUgbnVtYmVyIG9mIHJlY29yZHMgdXBkYXRlZCBvciA8IDAgaWYgaW52YWxpZCBzdWJJZAogICAgICogQGhpZGUKICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgc2V0RGlzcGxheU5hbWUoQE51bGxhYmxlIFN0cmluZyBkaXNwbGF5TmFtZSwgaW50IHN1YklkLAogICAgICAgICAgICBAU2ltRGlzcGxheU5hbWVTb3VyY2UgaW50IG5hbWVTb3VyY2UpIHsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbc2V0RGlzcGxheU5hbWVdKyAgZGlzcGxheU5hbWU6IiArIGRpc3BsYXlOYW1lICsgIiBzdWJJZDoiICsgc3ViSWQKICAgICAgICAgICAgICAgICAgICArICIgbmFtZVNvdXJjZToiICsgbmFtZVNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldERpc3BsYXlOYW1lIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+IGlTdWIuc2V0RGlzcGxheU5hbWVVc2luZ1NyYyhkaXNwbGF5TmFtZSwgc3ViSWQsIG5hbWVTb3VyY2UpCiAgICAgICAgKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCBwaG9uZSBudW1iZXIgYnkgc3ViSWQKICAgICAqIEBwYXJhbSBudW1iZXIgdGhlIHBob25lIG51bWJlciBvZiB0aGUgU0lNCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHVuaXF1ZSBTdWJzY3JpcHRpb25JbmZvIGluZGV4IGluIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIHRoZSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIGludCBzZXREaXNwbGF5TnVtYmVyKFN0cmluZyBudW1iZXIsIGludCBzdWJJZCkgewogICAgICAgIGlmIChudW1iZXIgPT0gbnVsbCkgewogICAgICAgICAgICBsb2dkKCJbc2V0RGlzcGxheU51bWJlcl0tIGZhaWwiKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3ViSWQsICJzZXREaXNwbGF5TnVtYmVyIiwKICAgICAgICAgICAgICAgIChpU3ViKS0+IGlTdWIuc2V0RGlzcGxheU51bWJlcihudW1iZXIsIHN1YklkKQogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgZGF0YSByb2FtaW5nIGJ5IHNpbUluZm8gaW5kZXgKICAgICAqIEBwYXJhbSByb2FtaW5nIDA6RG9uJ3QgYWxsb3cgZGF0YSB3aGVuIHJvYW1pbmcsIDE6QWxsb3cgZGF0YSB3aGVuIHJvYW1pbmcKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgdW5pcXVlIFN1YnNjcmlwdGlvbkluZm8gaW5kZXggaW4gZGF0YWJhc2UKICAgICAqIEByZXR1cm4gdGhlIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgaW50IHNldERhdGFSb2FtaW5nKGludCByb2FtaW5nLCBpbnQgc3ViSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW3NldERhdGFSb2FtaW5nXSsgcm9hbWluZzoiICsgcm9hbWluZyArICIgc3ViSWQ6IiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc2V0U3Vic2NyaXB0aW9uUHJvcGVydHlIZWxwZXIoc3ViSWQsICJzZXREYXRhUm9hbWluZyIsCiAgICAgICAgICAgICAgICAoaVN1YiktPmlTdWIuc2V0RGF0YVJvYW1pbmcocm9hbWluZywgc3ViSWQpCiAgICAgICAgKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBzbG90SW5kZXggYXNzb2NpYXRlZCB3aXRoIHRoZSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiBzbG90SW5kZXggYXMgYSBwb3NpdGl2ZSBpbnRlZ2VyIG9yIHtAbGluayAjSU5WQUxJRF9TSU1fU0xPVF9JTkRFWH0gaWYgdGhlIHN1cHBsaWVkCiAgICAgKiBzdWJzY3JpcHRpb25JZCBkb2Vzbid0IGhhdmUgYW4gYXNzb2NpYXRlZCBzbG90IGluZGV4LgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRTbG90SW5kZXgoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIHNTbG90SW5kZXhDYWNoZS5xdWVyeShzdWJzY3JpcHRpb25JZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgYW4gYXJyYXkgb2YgU3Vic2NyaXB0aW9uIElkcyBmb3Igc3BlY2lmaWVkIHNsb3QgSW5kZXguCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4IHRoZSBzbG90IGluZGV4LgogICAgICogQHJldHVybiBzdWJzY3JpcHRpb24gSWRzIG9yIG51bGwgaWYgdGhlIGdpdmVuIHNsb3QgSW5kZXggaXMgbm90IHZhbGlkIG9yIHRoZXJlIGFyZSBubyBhY3RpdmUKICAgICAqIHN1YnNjcmlwdGlvbnMgaW4gdGhlIHNsb3QuCiAgICAgKi8KICAgIEBOdWxsYWJsZQogICAgcHVibGljIGludFtdIGdldFN1YnNjcmlwdGlvbklkcyhpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgcmV0dXJuIGdldFN1YklkKHNsb3RJbmRleCk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHN0YXRpYyBpbnRbXSBnZXRTdWJJZChpbnQgc2xvdEluZGV4KSB7CiAgICAgICAgaWYgKCFpc1ZhbGlkU2xvdEluZGV4KHNsb3RJbmRleCkpIHsKICAgICAgICAgICAgbG9nZCgiW2dldFN1YklkXS0gZmFpbCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGludFtdIHN1YklkID0gbnVsbDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YklkID0gaVN1Yi5nZXRTdWJJZChzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHN1YklkOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyBpbnQgZ2V0UGhvbmVJZChpbnQgc3ViSWQpIHsKICAgICAgICByZXR1cm4gc1Bob25lSWRDYWNoZS5xdWVyeShzdWJJZCk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBsb2dkKFN0cmluZyBtc2cpIHsKICAgICAgICBSbG9nLmQoTE9HX1RBRywgbXNnKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIGxvZ2UoU3RyaW5nIG1zZykgewogICAgICAgIFJsb2cuZShMT0dfVEFHLCBtc2cpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogRm9yIGEgdm9pY2UgY2FwYWJsZSBkZXZpY2UsIGl0IHdpbGwgcmV0dXJuIGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkLgogICAgICogRm9yIGEgZGF0YSBvbmx5IGRldmljZSwgaXQgd2lsbCByZXR1cm4gdGhlIGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQuCiAgICAgKiBNYXkgcmV0dXJuIGFuIElOVkFMSURfU1VCU0NSSVBUSU9OX0lEIG9uIGVycm9yLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlICJzeXN0ZW0iIGRlZmF1bHQgc3Vic2NyaXB0aW9uIGlkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0U3Vic2NyaXB0aW9uSWQoKSB7CiAgICAgICAgcmV0dXJuIHNEZWZhdWx0U3ViSWRDYWNoZS5xdWVyeShudWxsKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHN5c3RlbSdzIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uIGlkLgogICAgICoKICAgICAqIE9uIGEgZGF0YSBvbmx5IGRldmljZSBvciBvbiBlcnJvciwgd2lsbCByZXR1cm4gSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQuCiAgICAgKgogICAgICogQHJldHVybiB0aGUgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24gSWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIGludCBzdWJJZCA9IElOVkFMSURfU1VCU0NSSVBUSU9OX0lEOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3ViSWQgPSBpU3ViLmdldERlZmF1bHRWb2ljZVN1YklkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICBpZiAoVkRCRykgbG9nZCgiZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQsIHN1YiBpZCA9ICIgKyBzdWJJZCk7CiAgICAgICAgcmV0dXJuIHN1YklkOwogICAgfQoKICAgIC8qKgogICAgICogU2V0cyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCB2b2ljZSBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSBkYXRhLW9ubHkgZGV2aWNlLCB0aGlzIGlzIGEgbm8tb3AuCiAgICAgKgogICAgICogTWF5IHRocm93IGEge0BsaW5rIFJ1bnRpbWVFeGNlcHRpb259IGlmIHRoZSBwcm92aWRlZCBzdWJzY3JpcHRpb24gaWQgaXMgZXF1YWwgdG8KICAgICAqIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI0RFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfQogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBBIHZhbGlkIHN1YnNjcmlwdGlvbiBJRCB0byBzZXQgYXMgdGhlIHN5c3RlbSBkZWZhdWx0LCBvcgogICAgICogICAgICAgICAgICAgICAgICAgICAgIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI0lOVkFMSURfU1VCU0NSSVBUSU9OX0lEfQogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFRlc3RBcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgic2V0RGVmYXVsdFZvaWNlU3ViSWQgc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0Vm9pY2VTdWJJZChzdWJzY3JpcHRpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2FtZSBhcyB7QGxpbmsgI3NldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKGludCl9LCBidXQgcHJlc2VydmVkIGZvciBiYWNrd2FyZHMKICAgICAqIGNvbXBhdGliaWxpdHkuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXREZWZhdWx0Vm9pY2VTdWJJZChpbnQgc3ViSWQpIHsKICAgICAgICBzZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JZChzdWJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIGRlZmF1bHQgdm9pY2Ugc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIFdpbGwgcmV0dXJuIG51bGwgb24gZGF0YSBvbmx5IGRldmljZXMsIG9yIG9uIGVycm9yLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIHRoZSBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgU3Vic2NyaXB0aW9uSW5mbyBnZXREZWZhdWx0Vm9pY2VTdWJzY3JpcHRpb25JbmZvKCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JbmZvKGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRWb2ljZVBob25lSWQoKSB7CiAgICAgICAgcmV0dXJuIGdldFBob25lSWQoZ2V0RGVmYXVsdFZvaWNlU3Vic2NyaXB0aW9uSWQoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBzeXN0ZW0ncyBkZWZhdWx0IFNNUyBzdWJzY3JpcHRpb24gaWQuCiAgICAgKgogICAgICogT24gYSBkYXRhIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IFNNUyBzdWJzY3JpcHRpb24gSWQuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0RlZmF1bHRTbXNTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBzdWJzY3JpcHRpb24gd2hpY2ggd2lsbCBiZSB1c2VkIGJ5IGRlZmF1bHQgZm9yIFNNUywgd2l0aCB0aGUgc3Vic2NyaXB0aW9uIHdoaWNoCiAgICAgKiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGNvcnJlc3BvbmRzIHRvOyBvciB0aHJvdyBhIFJ1bnRpbWVFeGNlcHRpb24gaWYgdGhlIHN1cHBsaWVkCiAgICAgKiBzdWJzY3JpcHRpb24gSUQgaXMgbm90IHVzYWJsZSAoY2hlY2sgd2l0aCB7QGxpbmsgI2lzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50KX0pLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElECiAgICAgKgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0RGVmYXVsdFNtc1N1YklkKGludCBzdWJzY3JpcHRpb25JZCkgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJzZXREZWZhdWx0U21zU3ViSWQgc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0U21zU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGV4LnJldGhyb3dGcm9tU3lzdGVtU2VydmVyKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciBkZWZhdWx0IHZvaWNlIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBXaWxsIHJldHVybiBudWxsIG9uIGRhdGEgb25seSBkZXZpY2VzLCBvciBvbiBlcnJvci4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBTdWJzY3JpcHRpb25JbmZvIGZvciB0aGUgZGVmYXVsdCBTTVMgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIFN1YnNjcmlwdGlvbkluZm8gZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm8oZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBpbnQgZ2V0RGVmYXVsdFNtc1Bob25lSWQoKSB7CiAgICAgICAgcmV0dXJuIGdldFBob25lSWQoZ2V0RGVmYXVsdFNtc1N1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc3lzdGVtJ3MgZGVmYXVsdCBkYXRhIHN1YnNjcmlwdGlvbiBpZC4KICAgICAqCiAgICAgKiBPbiBhIHZvaWNlIG9ubHkgZGV2aWNlIG9yIG9uIGVycm9yLCB3aWxsIHJldHVybiBJTlZBTElEX1NVQlNDUklQVElPTl9JRC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uIElkLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkgewogICAgICAgIHJldHVybiBzRGVmYXVsdERhdGFTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHRoZSBzdWJzY3JpcHRpb24gd2hpY2ggd2lsbCBiZSB1c2VkIGJ5IGRlZmF1bHQgZm9yIGRhdGEsIHdpdGggdGhlIHN1YnNjcmlwdGlvbiB3aGljaAogICAgICogdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0bzsgb3IgdGhyb3cgYSBSdW50aW1lRXhjZXB0aW9uIGlmIHRoZSBzdXBwbGllZAogICAgICogc3Vic2NyaXB0aW9uIElEIGlzIG5vdCB1c2FibGUgKGNoZWNrIHdpdGgge0BsaW5rICNpc1VzYWJsZVN1YnNjcmlwdGlvbklkKGludCl9KS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRAogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldERlZmF1bHREYXRhU3ViSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInNldERhdGFTdWJzY3JpcHRpb24gc3ViIGlkID0gIiArIHN1YnNjcmlwdGlvbklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5zZXREZWZhdWx0RGF0YVN1YklkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogV2lsbCByZXR1cm4gbnVsbCBvbiB2b2ljZSBvbmx5IGRldmljZXMsIG9yIG9uIGVycm9yLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIFN1YnNjcmlwdGlvbkluZm8gZm9yIHRoZSBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBTdWJzY3JpcHRpb25JbmZvIGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSW5mbygpIHsKICAgICAgICByZXR1cm4gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBpbnQgZ2V0RGVmYXVsdERhdGFQaG9uZUlkKCkgewogICAgICAgIHJldHVybiBnZXRQaG9uZUlkKGdldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgdm9pZCBjbGVhclN1YnNjcmlwdGlvbkluZm8oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuY2xlYXJTdWJJbmZvKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy9GSVhNRSB0aGlzIGlzIHZ1bG5lcmFibGUgdG8gcmFjZSBjb25kaXRpb25zCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBib29sZWFuIGFsbERlZmF1bHRzU2VsZWN0ZWQoKSB7CiAgICAgICAgaWYgKCFpc1ZhbGlkU3Vic2NyaXB0aW9uSWQoZ2V0RGVmYXVsdERhdGFTdWJzY3JpcHRpb25JZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKGdldERlZmF1bHRTbXNTdWJzY3JpcHRpb25JZCgpKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICghaXNWYWxpZFN1YnNjcmlwdGlvbklkKGdldERlZmF1bHRWb2ljZVN1YnNjcmlwdGlvbklkKCkpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGlzIHZhbGlkLgogICAgICoKICAgICAqIDxwPkEgdmFsaWQgc3Vic2NyaXB0aW9uIElEIGlzIG5vdCBuZWNlc3NhcmlseSBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uIElECiAgICAgKiAoc2VlIHtAbGluayAjaXNBY3RpdmVTdWJzY3JpcHRpb25JZChpbnQpfSkgb3IgYW4gdXNhYmxlIHN1YnNjcmlwdGlvbiBJRAogICAgICogKHNlZSB7QGxpbmsgI2lzVXNhYmxlU3Vic2NyaXB0aW9uSWQoaW50KX0pLiBVbmxlc3Mgc3BlY2lmaWNhbGx5IG5vdGVkLCBzdWJzY3JpcHRpb24KICAgICAqIEFQSXMgd29yayB3aXRoIGEgdmFsaWQgc3Vic2NyaXB0aW9uIElELgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCBUaGUgc3Vic2NyaXB0aW9uIElELgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbklkIGlzIHZhbGlkOyB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVmFsaWRTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uSWQgPiBJTlZBTElEX1NVQlNDUklQVElPTl9JRDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBzdXBwbGllZCBzdWJzY3JpcHRpb24gSUQgaXMgdXNhYmxlLgogICAgICoKICAgICAqIDxwPkEgdXNhYmxlIHN1YnNjcmlwdGlvbiBJRCBpcyBhIHZhbGlkIHN1YnNjcmlwdGlvbiBJRCwgYnV0IG5vdCBuZWNlc3NhcmlseSBhbiBhY3RpdmUKICAgICAqIHN1YnNjcmlwdGlvbiBJRCAoc2VlIHtAbGluayAjaXNBY3RpdmVTdWJzY3JpcHRpb25JZChpbnQpfSkuIFNvbWUgc3Vic2NyaXB0aW9uIEFQSXMKICAgICAqIHJlcXVpcmUgYSB1c2FibGUgc3Vic2NyaXB0aW9uIElELCBhbmQgdGhpcyBpcyBub3RlZCBpbiB0aGVpciBkb2N1bWVudGF0aW9uOyBvdGhlcndpc2UsIGEKICAgICAqIHN1YnNjcmlwdGlvbiBJRCBkb2VzIG5vdCBuZWVkIHRvIGJlIHVzYWJsZSBmb3Igc3Vic2NyaXB0aW9uIGZ1bmN0aW9ucywgb25seSB2YWxpZC4KICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgdGhlIHN1YnNjcmlwdGlvbiBJRAogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIHN1YnNjcmlwdGlvbiBJRCBpcyB1c2FibGU7IHtAY29kZSBmYWxzZX0gb3RoZXJ3aXNlLgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGJvb2xlYW4gaXNVc2FibGVTdWJzY3JpcHRpb25JZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICByZXR1cm4gaXNVc2FibGVTdWJJZFZhbHVlKHN1YnNjcmlwdGlvbklkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm4gdHJ1ZSBpZiBzdWJJZCBpcyBhbiB1c2FibGUgc3ViSWQgdmFsdWUgZWxzZSBmYWxzZS4gQQogICAgICogdXNhYmxlIHN1YklkIG1lYW5zIGl0cyBuZWl0aGVyIGEgSU5WQUxJRF9TVUJTQ1JJUFRJT05fSUQgbm9yIGEgREVGQVVMVF9TVUJfSUQuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlApCiAgICBwdWJsaWMgc3RhdGljIGJvb2xlYW4gaXNVc2FibGVTdWJJZFZhbHVlKGludCBzdWJJZCkgewogICAgICAgIHJldHVybiBzdWJJZCA+PSBNSU5fU1VCU0NSSVBUSU9OX0lEX1ZBTFVFICYmIHN1YklkIDw9IE1BWF9TVUJTQ1JJUFRJT05fSURfVkFMVUU7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZShtYXhUYXJnZXRTZGsgPSBCdWlsZC5WRVJTSU9OX0NPREVTLlAsIHRyYWNraW5nQnVnID0gMTE1NjA5MDIzKQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVmFsaWRTbG90SW5kZXgoaW50IHNsb3RJbmRleCkgewogICAgICAgIHJldHVybiBzbG90SW5kZXggPj0gMCAmJiBzbG90SW5kZXggPCBUZWxlcGhvbnlNYW5hZ2VyLmdldERlZmF1bHQoKS5nZXRBY3RpdmVNb2RlbUNvdW50KCk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBAVW5zdXBwb3J0ZWRBcHBVc2FnZQogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGlzVmFsaWRQaG9uZUlkKGludCBwaG9uZUlkKSB7CiAgICAgICAgcmV0dXJuIHBob25lSWQgPj0gMCAmJiBwaG9uZUlkIDwgVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuZ2V0QWN0aXZlTW9kZW1Db3VudCgpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UobWF4VGFyZ2V0U2RrID0gQnVpbGQuVkVSU0lPTl9DT0RFUy5QKQogICAgcHVibGljIHN0YXRpYyB2b2lkIHB1dFBob25lSWRBbmRTdWJJZEV4dHJhKEludGVudCBpbnRlbnQsIGludCBwaG9uZUlkKSB7CiAgICAgICAgaW50W10gc3ViSWRzID0gU3Vic2NyaXB0aW9uTWFuYWdlci5nZXRTdWJJZChwaG9uZUlkKTsKICAgICAgICBpZiAoc3ViSWRzICE9IG51bGwgJiYgc3ViSWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcHV0UGhvbmVJZEFuZFN1YklkRXh0cmEoaW50ZW50LCBwaG9uZUlkLCBzdWJJZHNbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZ2QoInB1dFBob25lSWRBbmRTdWJJZEV4dHJhOiBubyB2YWxpZCBzdWJzIik7CiAgICAgICAgICAgIGludGVudC5wdXRFeHRyYShQaG9uZUNvbnN0YW50cy5QSE9ORV9LRVksIHBob25lSWQpOwogICAgICAgICAgICBpbnRlbnQucHV0RXh0cmEoRVhUUkFfU0xPVF9JTkRFWCwgcGhvbmVJZCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgQFVuc3VwcG9ydGVkQXBwVXNhZ2UKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBwdXRQaG9uZUlkQW5kU3ViSWRFeHRyYShJbnRlbnQgaW50ZW50LCBpbnQgcGhvbmVJZCwgaW50IHN1YklkKSB7CiAgICAgICAgaWYgKFZEQkcpIGxvZ2QoInB1dFBob25lSWRBbmRTdWJJZEV4dHJhOiBwaG9uZUlkPSIgKyBwaG9uZUlkICsgIiBzdWJJZD0iICsgc3ViSWQpOwogICAgICAgIGludGVudC5wdXRFeHRyYShFWFRSQV9TTE9UX0lOREVYLCBwaG9uZUlkKTsKICAgICAgICBpbnRlbnQucHV0RXh0cmEoUGhvbmVDb25zdGFudHMuUEhPTkVfS0VZLCBwaG9uZUlkKTsKICAgICAgICBwdXRTdWJzY3JpcHRpb25JZEV4dHJhKGludGVudCwgc3ViSWQpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0IHZpc2libGUgc3Vic2NyaXB0aW9uIElkKHMpIG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIFNJTShzKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIHN1YklkJ3MgdGhhdCBhcmUgYWN0aXZlLAogICAgICogICAgICAgICBpcyBuZXZlciBudWxsIGJ1dCB0aGUgbGVuZ3RoIG1heSBiZSAwLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBpbnRbXSBnZXRBY3RpdmVTdWJzY3JpcHRpb25JZExpc3QoKSB7CiAgICAgICAgcmV0dXJuIGdldEFjdGl2ZVN1YnNjcmlwdGlvbklkTGlzdCgvKiB2aXNpYmxlT25seSAqLyB0cnVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBib3RoIGhpZGRlbiBhbmQgdmlzaWJsZSBzdWJzY3JpcHRpb24gSWQocykgb2YgdGhlIGN1cnJlbnRseSBhY3RpdmUgU0lNKHMpLgogICAgICoKICAgICAqIEhpZGRlbiBzdWJzY3JpcHRpb25zIHJlZmVyIHRvIHRob3NlIGFyZSBub3QgbWVhbnQgdmlzaWJsZSB0byB0aGUgdXNlcnMuCiAgICAgKiBGb3IgZXhhbXBsZSwgYW4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb24gdGhhdCBpcyBncm91cGVkIHdpdGggb3RoZXIKICAgICAqIHN1YnNjcmlwdGlvbnMgc2hvdWxkIHJlbWFpbiBpbnZpc2libGUgdG8gdXNlcnMgYXMgdGhleSBhcmUgb25seSBmdW5jdGlvbmFsbHkKICAgICAqIHN1cHBsZW1lbnRhcnkgdG8gcHJpbWFyeSBvbmVzLgogICAgICoKICAgICAqIEByZXR1cm4gdGhlIGxpc3Qgb2Ygc3ViSWQncyB0aGF0IGFyZSBhY3RpdmUsCiAgICAgKiAgICAgICAgIGlzIG5ldmVyIG51bGwgYnV0IHRoZSBsZW5ndGggbWF5IGJlIDAuCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QUklWSUxFR0VEX1BIT05FX1NUQVRFKQogICAgcHVibGljIEBOb25OdWxsIGludFtdIGdldENvbXBsZXRlQWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KCkgewogICAgICAgIHJldHVybiBnZXRBY3RpdmVTdWJzY3JpcHRpb25JZExpc3QoLyogdmlzaWJsZU9ubHkgKi9mYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIGEgbm9uLW51bGwgbGlzdCBvZiBzdWJJZCdzIHRoYXQgYXJlIGFjdGl2ZS4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgQE5vbk51bGwgaW50W10gZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSWRMaXN0KGJvb2xlYW4gdmlzaWJsZU9ubHkpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW50W10gc3ViSWQgPSBpU3ViLmdldEFjdGl2ZVN1YklkTGlzdCh2aXNpYmxlT25seSk7CiAgICAgICAgICAgICAgICBpZiAoc3ViSWQgIT0gbnVsbCkgcmV0dXJuIHN1YklkOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBpbnRbMF07CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGRldmljZSBpcyBjb25zaWRlcmVkIHJvYW1pbmcgb24gdGhlIGN1cnJlbnQKICAgICAqIG5ldHdvcmsgZm9yIGEgc3Vic2NyaXB0aW9uLgogICAgICogPHA+CiAgICAgKiBBdmFpbGFiaWxpdHk6IE9ubHkgd2hlbiB1c2VyIHJlZ2lzdGVyZWQgdG8gYSBuZXR3b3JrLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCBUaGUgc3Vic2NyaXB0aW9uIElECiAgICAgKiBAcmV0dXJuIHRydWUgaWYgdGhlIG5ldHdvcmsgZm9yIHRoZSBzdWJzY3JpcHRpb24gaXMgcm9hbWluZywgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGlzTmV0d29ya1JvYW1pbmcoaW50IHN1YklkKSB7CiAgICAgICAgZmluYWwgaW50IHBob25lSWQgPSBnZXRQaG9uZUlkKHN1YklkKTsKICAgICAgICBpZiAocGhvbmVJZCA8IDApIHsKICAgICAgICAgICAgLy8gV2hhdCBlbHNlIGNhbiB3ZSBkbz8KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gVGVsZXBob255TWFuYWdlci5nZXREZWZhdWx0KCkuaXNOZXR3b3JrUm9hbWluZyhzdWJJZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgY29uc3RhbnQgaW5kaWNhdGluZyB0aGUgc3RhdGUgb2Ygc2ltIGZvciB0aGUgc2xvdCBpbmRleC4KICAgICAqCiAgICAgKiBAcGFyYW0gc2xvdEluZGV4CiAgICAgKgogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfVU5LTk9XTn0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX0FCU0VOVH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1BJTl9SRVFVSVJFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX1BVS19SRVFVSVJFRH0KICAgICAqIHtAU2VlIFRlbGVwaG9ueU1hbmFnZXIjU0lNX1NUQVRFX05FVFdPUktfTE9DS0VEfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfUkVBRFl9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9OT1RfUkVBRFl9CiAgICAgKiB7QFNlZSBUZWxlcGhvbnlNYW5hZ2VyI1NJTV9TVEFURV9QRVJNX0RJU0FCTEVEfQogICAgICoge0BTZWUgVGVsZXBob255TWFuYWdlciNTSU1fU1RBVEVfQ0FSRF9JT19FUlJPUn0KICAgICAqCiAgICAgKiB7QGhpZGV9CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldFNpbVN0YXRlRm9yU2xvdEluZGV4KGludCBzbG90SW5kZXgpIHsKICAgICAgICBpbnQgc2ltU3RhdGUgPSBUZWxlcGhvbnlNYW5hZ2VyLlNJTV9TVEFURV9VTktOT1dOOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2ltU3RhdGUgPSBpU3ViLmdldFNpbVN0YXRlRm9yU2xvdEluZGV4KHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzaW1TdGF0ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0b3JlIHByb3BlcnRpZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbkluZm8gaW4gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uCiAgICAgKiBAcGFyYW0gcHJvcEtleSBDb2x1bW4gbmFtZSBpbiBkYXRhYmFzZSBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uSW5mbwogICAgICogQHBhcmFtIHByb3BWYWx1ZSBWYWx1ZSB0byBzdG9yZSBpbiBEQiBmb3IgcGFydGljdWxhciBzdWJJZCAmIGNvbHVtbiBuYW1lCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgc2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwgU3RyaW5nIHByb3BWYWx1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLnNldFN1YnNjcmlwdGlvblByb3BlcnR5KHN1YklkLCBwcm9wS2V5LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFN0b3JlIHByb3BlcnRpZXMgYXNzb2NpYXRlZCB3aXRoIFN1YnNjcmlwdGlvbkluZm8gaW4gZGF0YWJhc2UKICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uCiAgICAgKiBAcGFyYW0gcHJvcEtleSBDb2x1bW4gbmFtZSBpbiBTdWJzY3JpcHRpb25JbmZvIGRhdGFiYXNlCiAgICAgKiBAcmV0dXJuIFZhbHVlIGFzc29jaWF0ZWQgd2l0aCBzdWJJZCBhbmQgcHJvcEtleSBjb2x1bW4gaW4gZGF0YWJhc2UKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHByaXZhdGUgc3RhdGljIFN0cmluZyBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShpbnQgc3ViSWQsIFN0cmluZyBwcm9wS2V5LAogICAgICAgICAgICBDb250ZXh0IGNvbnRleHQpIHsKICAgICAgICBTdHJpbmcgcmVzdWx0VmFsdWUgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRWYWx1ZSA9IGlTdWIuZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoc3ViSWQsIHByb3BLZXksCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpLCBjb250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGJvb2xlYW4gdmFsdWUgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHBhcmFtIGRlZlZhbHVlIERlZmF1bHQgYm9vbGVhbiB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQHJldHVybiBib29sZWFuIHJlc3VsdCB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBib29sZWFuIGdldEJvb2xlYW5TdWJzY3JpcHRpb25Qcm9wZXJ0eShpbnQgc3ViSWQsIFN0cmluZyBwcm9wS2V5LAogICAgICAgICAgICBib29sZWFuIGRlZlZhbHVlLCBDb250ZXh0IGNvbnRleHQpIHsKICAgICAgICBTdHJpbmcgcmVzdWx0ID0gZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoc3ViSWQsIHByb3BLZXksIGNvbnRleHQpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIEludGVnZXIucGFyc2VJbnQocmVzdWx0KSA9PSAxOwogICAgICAgICAgICB9IGNhdGNoIChOdW1iZXJGb3JtYXRFeGNlcHRpb24gZXJyKSB7CiAgICAgICAgICAgICAgICBsb2dkKCJnZXRCb29sZWFuU3Vic2NyaXB0aW9uUHJvcGVydHkgTnVtYmVyRm9ybWF0IGV4Y2VwdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWZWYWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgaW50ZWdlciB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHF1ZXJ5IHJlc3VsdC4KICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uCiAgICAgKiBAcGFyYW0gcHJvcEtleSBDb2x1bW4gbmFtZSBpbiBTdWJzY3JpcHRpb25JbmZvIGRhdGFiYXNlCiAgICAgKiBAcGFyYW0gZGVmVmFsdWUgRGVmYXVsdCBpbnRlZ2VyIHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAcmV0dXJuIGludGVnZXIgcmVzdWx0IHZhbHVlIHRvIGJlIHJldHVybmVkCiAgICAgKiBAaGlkZQogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGludCBnZXRJbnRlZ2VyU3Vic2NyaXB0aW9uUHJvcGVydHkoaW50IHN1YklkLCBTdHJpbmcgcHJvcEtleSwgaW50IGRlZlZhbHVlLAogICAgICAgICAgICBDb250ZXh0IGNvbnRleHQpIHsKICAgICAgICBTdHJpbmcgcmVzdWx0ID0gZ2V0U3Vic2NyaXB0aW9uUHJvcGVydHkoc3ViSWQsIHByb3BLZXksIGNvbnRleHQpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIEludGVnZXIucGFyc2VJbnQocmVzdWx0KTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGVycikgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0SW50ZWdlclN1YnNjcmlwdGlvblByb3BlcnR5IE51bWJlckZvcm1hdCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGxvbmcgdmFsdWUgY29ycmVzcG9uZGluZyB0byBxdWVyeSByZXN1bHQuCiAgICAgKiBAcGFyYW0gc3ViSWQgU3Vic2NyaXB0aW9uIElkIG9mIFN1YnNjcmlwdGlvbgogICAgICogQHBhcmFtIHByb3BLZXkgQ29sdW1uIG5hbWUgaW4gU3Vic2NyaXB0aW9uSW5mbyBkYXRhYmFzZQogICAgICogQHBhcmFtIGRlZlZhbHVlIERlZmF1bHQgbG9uZyB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQHJldHVybiBsb25nIHJlc3VsdCB2YWx1ZSB0byBiZSByZXR1cm5lZAogICAgICogQGhpZGUKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBsb25nIGdldExvbmdTdWJzY3JpcHRpb25Qcm9wZXJ0eShpbnQgc3ViSWQsIFN0cmluZyBwcm9wS2V5LCBsb25nIGRlZlZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbnRleHQgY29udGV4dCkgewogICAgICAgIFN0cmluZyByZXN1bHQgPSBnZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eShzdWJJZCwgcHJvcEtleSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTG9uZy5wYXJzZUxvbmcocmVzdWx0KTsKICAgICAgICAgICAgfSBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGVycikgewogICAgICAgICAgICAgICAgbG9nZCgiZ2V0TG9uZ1N1YnNjcmlwdGlvblByb3BlcnR5IE51bWJlckZvcm1hdCBleGNlcHRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB7QGxpbmsgUmVzb3VyY2VzfSBmcm9tIHRoZSBnaXZlbiB7QGxpbmsgQ29udGV4dH0gZm9yIHRoZSBNQ0MvTU5DIGFzc29jaWF0ZWQgd2l0aAogICAgICogdGhlIHN1YnNjcmlwdGlvbi4gSWYgdGhlIHN1YnNjcmlwdGlvbiBJRCBpcyBpbnZhbGlkLCB0aGUgYmFzZSByZXNvdXJjZXMgYXJlIHJldHVybmVkIGluc3RlYWQuCiAgICAgKgogICAgICogUmVxdWlyZXMgUGVybWlzc2lvbjoge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFIFJFQURfUEhPTkVfU1RBVEV9CiAgICAgKgogICAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCBvYmplY3QKICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uIHdob3NlIHJlc291cmNlcyBhcmUgcmVxdWlyZWQKICAgICAqIEByZXR1cm4gUmVzb3VyY2VzIGFzc29jaWF0ZWQgd2l0aCBTdWJzY3JpcHRpb24uCiAgICAgKiBAaGlkZQogICAgICovCiAgICBATm9uTnVsbAogICAgQFN5c3RlbUFwaQogICAgcHVibGljIHN0YXRpYyBSZXNvdXJjZXMgZ2V0UmVzb3VyY2VzRm9yU3ViSWQoQE5vbk51bGwgQ29udGV4dCBjb250ZXh0LCBpbnQgc3ViSWQpIHsKICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2VzRm9yU3ViSWQoY29udGV4dCwgc3ViSWQsIGZhbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dCBvYmplY3QKICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb24gSWQgb2YgU3Vic2NyaXB0aW9uIHdobydzIHJlc291cmNlcyBhcmUgcmVxdWlyZWQKICAgICAqIEBwYXJhbSB1c2VSb290TG9jYWxlIGlmIHJvb3QgbG9jYWxlIHNob3VsZCBiZSB1c2VkLiBMb2NhbGl6ZWQgbG9jYWxlIGlzIHVzZWQgaWYgZmFsc2UuCiAgICAgKiBAcmV0dXJuIFJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggU3Vic2NyaXB0aW9uLgogICAgICogQGhpZGUKICAgICAqLwogICAgQE5vbk51bGwKICAgIHB1YmxpYyBzdGF0aWMgUmVzb3VyY2VzIGdldFJlc291cmNlc0ZvclN1YklkKENvbnRleHQgY29udGV4dCwgaW50IHN1YklkLAogICAgICAgICAgICBib29sZWFuIHVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAvLyBDaGVjayBpZiByZXNvdXJjZXMgZm9yIHRoaXMgY29udGV4dCBhbmQgc3ViSWQgYWxyZWFkeSBleGlzdCBpbiB0aGUgcmVzb3VyY2UgY2FjaGUuCiAgICAgICAgLy8gUmVzb3VyY2VzIHRoYXQgdXNlIHRoZSByb290IGxvY2FsZSBhcmUgbm90IGNhY2hlZC4KICAgICAgICBQYWlyPENvbnRleHQsIEludGVnZXI+IGNhY2hlS2V5ID0gbnVsbDsKICAgICAgICBpZiAoaXNWYWxpZFN1YnNjcmlwdGlvbklkKHN1YklkKSAmJiAhdXNlUm9vdExvY2FsZSkgewogICAgICAgICAgICBjYWNoZUtleSA9IFBhaXIuY3JlYXRlKGNvbnRleHQsIHN1YklkKTsKICAgICAgICAgICAgaWYgKHNSZXNvdXJjZXNDYWNoZS5jb250YWluc0tleShjYWNoZUtleSkpIHsKICAgICAgICAgICAgICAgIC8vIENhY2hlIGhpdC4gVXNlIGNhY2hlZCBSZXNvdXJjZXMuCiAgICAgICAgICAgICAgICByZXR1cm4gc1Jlc291cmNlc0NhY2hlLmdldChjYWNoZUtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpbmFsIFN1YnNjcmlwdGlvbkluZm8gc3ViSW5mbyA9CiAgICAgICAgICAgICAgICBTdWJzY3JpcHRpb25NYW5hZ2VyLmZyb20oY29udGV4dCkuZ2V0QWN0aXZlU3Vic2NyaXB0aW9uSW5mbyhzdWJJZCk7CgogICAgICAgIENvbmZpZ3VyYXRpb24gb3ZlcnJpZGVDb25maWcgPSBuZXcgQ29uZmlndXJhdGlvbigpOwogICAgICAgIGlmIChzdWJJbmZvICE9IG51bGwpIHsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubWNjID0gc3ViSW5mby5nZXRNY2MoKTsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcubW5jID0gc3ViSW5mby5nZXRNbmMoKTsKICAgICAgICAgICAgaWYgKG92ZXJyaWRlQ29uZmlnLm1uYyA9PSAwKSBvdmVycmlkZUNvbmZpZy5tbmMgPSBDb25maWd1cmF0aW9uLk1OQ19aRVJPOwogICAgICAgIH0KCiAgICAgICAgaWYgKHVzZVJvb3RMb2NhbGUpIHsKICAgICAgICAgICAgb3ZlcnJpZGVDb25maWcuc2V0TG9jYWxlKExvY2FsZS5ST09UKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBuZXcgY29udGV4dCB3aXRoIG5ldyBjb25maWd1cmF0aW9uIHNvIHRoYXQgd2UgY2FuIGF2b2lkIG1vZGlmeWluZyB0aGUgcGFzc2VkIGluCiAgICAgICAgLy8gY29udGV4dC4KICAgICAgICAvLyBOb3RlIHRoYXQgaWYgdGhlIG9yaWdpbmFsIGNvbnRleHQgY29uZmlndXJhdGlvbiBjaGFuZ2VzLCB0aGUgcmVzb3VyY2VzIGhlcmUgd2lsbCBhbHNvCiAgICAgICAgLy8gY2hhbmdlIGZvciBhbGwgdmFsdWVzIGV4Y2VwdCB0aG9zZSBvdmVycmlkZGVuIGJ5IG5ld0NvbmZpZyAoZS5nLiBpZiB0aGUgZGV2aWNlIGhhcyBhbgogICAgICAgIC8vIG9yaWVudGF0aW9uIGNoYW5nZSkuCiAgICAgICAgQ29udGV4dCBuZXdDb250ZXh0ID0gY29udGV4dC5jcmVhdGVDb25maWd1cmF0aW9uQ29udGV4dChvdmVycmlkZUNvbmZpZyk7CiAgICAgICAgUmVzb3VyY2VzIHJlcyA9IG5ld0NvbnRleHQuZ2V0UmVzb3VyY2VzKCk7CgogICAgICAgIGlmIChjYWNoZUtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIC8vIFNhdmUgdGhlIG5ld2x5IGNyZWF0ZWQgUmVzb3VyY2VzIGluIHRoZSByZXNvdXJjZSBjYWNoZS4KICAgICAgICAgICAgc1Jlc291cmNlc0NhY2hlLnB1dChjYWNoZUtleSwgcmVzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3VwcGxpZWQgc3Vic2NyaXB0aW9uIElEIGNvcnJlc3BvbmRzIHRvIGEgc3Vic2NyaXB0aW9uIHdoaWNoIGlzIGFjdGl2ZWx5IGluCiAgICAgKiB1c2Ugb24gdGhlIGRldmljZS4gQW4gYWN0aXZlIHN1YnNjcmlwdGlvbiBJRCBpcyBhIHZhbGlkIGFuZCB1c2FibGUgc3Vic2NyaXB0aW9uIElELgogICAgICoKICAgICAqIEBwYXJhbSBzdWJzY3JpcHRpb25JZCB0aGUgc3Vic2NyaXB0aW9uIElELgogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIHN1cHBsaWVkIHN1YnNjcmlwdGlvbiBJRCBjb3JyZXNwb25kcyB0byBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uOwogICAgICoge0Bjb2RlIGZhbHNlfSBpZiBpdCBkb2VzIG5vdCBjb3JyZXNwb25kIHRvIGFuIGFjdGl2ZSBzdWJzY3JpcHRpb247IG9yIHRocm93IGEKICAgICAqIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgaGFzbid0IGdvdCB0aGUgcmlnaHQgcGVybWlzc2lvbi4KICAgICAqLwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzQWN0aXZlU3Vic2NyaXB0aW9uSWQoaW50IHN1YnNjcmlwdGlvbklkKSB7CiAgICAgICAgcmV0dXJuIGlzQWN0aXZlU3ViSWQoc3Vic2NyaXB0aW9uSWQpOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybiB0cnVlIGlmIHRoZSBzdWIgSUQgaXMgYWN0aXZlLiBpLmUuIFRoZSBzdWIgSUQgY29ycmVzcG9uZHMgdG8gYSBrbm93biBzdWJzY3JpcHRpb24KICAgICAqIGFuZCB0aGUgU0lNIHByb3ZpZGluZyB0aGUgc3Vic2NyaXB0aW9uIGlzIHByZXNlbnQgaW4gYSBzbG90IGFuZCBpbiAiTE9BREVEIiBzdGF0ZS4KICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBVbnN1cHBvcnRlZEFwcFVzYWdlCiAgICBwdWJsaWMgYm9vbGVhbiBpc0FjdGl2ZVN1YklkKGludCBzdWJJZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5pc0FjdGl2ZVN1YklkKHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG1Db250ZXh0LmdldEF0dHJpYnV0aW9uVGFnKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCB0aGUgZGVzY3JpcHRpb24gb2YgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIKICAgICAqIGFuZCBhIHNwZWNpZmljIHN1YnNjcmliZXIuCiAgICAgKiA8cD4KICAgICAqIFRoaXMgbWV0aG9kIGlzIG9ubHkgYWNjZXNzaWJsZSB0byB0aGUgZm9sbG93aW5nIG5hcnJvdyBzZXQgb2YgYXBwczoKICAgICAqIDx1bD4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZm9yIHRoaXMgc3Vic2NyaWJlcklkLCBhcyBkZXRlcm1pbmVkIGJ5CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfS4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZXhwbGljaXRseSBkZWxlZ2F0ZWQgYWNjZXNzIHRocm91Z2gKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ09ORklHX1BMQU5TX1BBQ0tBR0VfT1ZFUlJJREVfU1RSSU5HfS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpYmVyIHRoaXMgcmVsYXRpb25zaGlwIGFwcGxpZXMgdG8KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyBATm9uTnVsbCBMaXN0PFN1YnNjcmlwdGlvblBsYW4+IGdldFN1YnNjcmlwdGlvblBsYW5zKGludCBzdWJJZCkgewogICAgICAgIFN1YnNjcmlwdGlvblBsYW5bXSBzdWJzY3JpcHRpb25QbGFucyA9CiAgICAgICAgICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLmdldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgICAgIHJldHVybiBzdWJzY3JpcHRpb25QbGFucyA9PSBudWxsCiAgICAgICAgICAgICAgICA/IENvbGxlY3Rpb25zLmVtcHR5TGlzdCgpIDogQXJyYXlzLmFzTGlzdChzdWJzY3JpcHRpb25QbGFucyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyCiAgICAgKiBhbmQgYSBzcGVjaWZpYyBzdWJzY3JpYmVyLgogICAgICogPHA+CiAgICAgKiBUaGlzIG1ldGhvZCBpcyBvbmx5IGFjY2Vzc2libGUgdG8gdGhlIGZvbGxvd2luZyBuYXJyb3cgc2V0IG9mIGFwcHM6CiAgICAgKiA8dWw+CiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGZvciB0aGlzIHN1YnNjcmliZXJJZCwgYXMgZGV0ZXJtaW5lZCBieQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0uCiAgICAgKiA8bGk+VGhlIGNhcnJpZXIgYXBwIGV4cGxpY2l0bHkgZGVsZWdhdGVkIGFjY2VzcyB0aHJvdWdoCiAgICAgKiB7QGxpbmsgQ2FycmllckNvbmZpZ01hbmFnZXIjS0VZX0NPTkZJR19QTEFOU19QQUNLQUdFX09WRVJSSURFX1NUUklOR30uCiAgICAgKiA8L3VsPgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB0aGUgc3Vic2NyaWJlciB0aGlzIHJlbGF0aW9uc2hpcCBhcHBsaWVzIHRvLiBBbiBlbXB0eSBsaXN0CiAgICAgKiAgICAgICAgICAgIG1heSBiZSBzZW50IHRvIGNsZWFyIGFueSBleGlzdGluZyBwbGFucy4KICAgICAqIEBwYXJhbSBwbGFucyB0aGUgbGlzdCBvZiBwbGFucy4gVGhlIGZpcnN0IHBsYW4gaXMgYWx3YXlzIHRoZSBwcmltYXJ5IGFuZAogICAgICogICAgICAgICAgICBtb3N0IGltcG9ydGFudCBwbGFuLiBBbnkgYWRkaXRpb25hbCBwbGFucyBhcmUgc2Vjb25kYXJ5IGFuZAogICAgICogICAgICAgICAgICBtYXkgbm90IGJlIGRpc3BsYXllZCBvciB1c2VkIGJ5IGRlY2lzaW9uIG1ha2luZyBsb2dpYy4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBwbGFucyBkb24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIGRlZmluZWQgaW4ge0BsaW5rIFN1YnNjcmlwdGlvblBsYW59LgogICAgICovCiAgICBwdWJsaWMgdm9pZCBzZXRTdWJzY3JpcHRpb25QbGFucyhpbnQgc3ViSWQsIEBOb25OdWxsIExpc3Q8U3Vic2NyaXB0aW9uUGxhbj4gcGxhbnMpIHsKICAgICAgICBnZXROZXR3b3JrUG9saWN5TWFuYWdlcigpLnNldFN1YnNjcmlwdGlvblBsYW5zKHN1YklkLAogICAgICAgICAgICAgICAgcGxhbnMudG9BcnJheShuZXcgU3Vic2NyaXB0aW9uUGxhbltwbGFucy5zaXplKCldKSwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRlbXBvcmFyaWx5IG92ZXJyaWRlIHRoZSBiaWxsaW5nIHJlbGF0aW9uc2hpcCBwbGFuIGJldHdlZW4gYSBjYXJyaWVyIGFuZAogICAgICogYSBzcGVjaWZpYyBzdWJzY3JpYmVyIHRvIGJlIGNvbnNpZGVyZWQgdW5tZXRlcmVkLiBUaGlzIHdpbGwgYmUgcmVmbGVjdGVkCiAgICAgKiB0byBhcHBzIHZpYSB7QGxpbmsgTmV0d29ya0NhcGFiaWxpdGllcyNORVRfQ0FQQUJJTElUWV9OT1RfTUVURVJFRH0uCiAgICAgKiA8cD4KICAgICAqIFRoaXMgbWV0aG9kIGlzIG9ubHkgYWNjZXNzaWJsZSB0byB0aGUgZm9sbG93aW5nIG5hcnJvdyBzZXQgb2YgYXBwczoKICAgICAqIDx1bD4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZm9yIHRoaXMgc3Vic2NyaWJlcklkLCBhcyBkZXRlcm1pbmVkIGJ5CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfS4KICAgICAqIDxsaT5UaGUgY2FycmllciBhcHAgZXhwbGljaXRseSBkZWxlZ2F0ZWQgYWNjZXNzIHRocm91Z2gKICAgICAqIHtAbGluayBDYXJyaWVyQ29uZmlnTWFuYWdlciNLRVlfQ09ORklHX1BMQU5TX1BBQ0tBR0VfT1ZFUlJJREVfU1RSSU5HfS4KICAgICAqIDwvdWw+CiAgICAgKgogICAgICogQHBhcmFtIHN1YklkIHRoZSBzdWJzY3JpYmVyIHRoaXMgb3ZlcnJpZGUgYXBwbGllcyB0by4KICAgICAqIEBwYXJhbSBvdmVycmlkZVVubWV0ZXJlZCBzZXQgaWYgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHNob3VsZCBiZQogICAgICogICAgICAgICAgICBjb25zaWRlcmVkIHVubWV0ZXJlZC4KICAgICAqIEBwYXJhbSB0aW1lb3V0TWlsbGlzIHRoZSB0aW1lb3V0IGFmdGVyIHdoaWNoIHRoZSByZXF1ZXN0ZWQgb3ZlcnJpZGUgd2lsbAogICAgICogICAgICAgICAgICBiZSBhdXRvbWF0aWNhbGx5IGNsZWFyZWQsIG9yIHtAY29kZSAwfSB0byBsZWF2ZSBpbiB0aGUKICAgICAqICAgICAgICAgICAgcmVxdWVzdGVkIHN0YXRlIHVudGlsIGV4cGxpY2l0bHkgY2xlYXJlZCwgb3IgdGhlIG5leHQgcmVib290LAogICAgICogICAgICAgICAgICB3aGljaGV2ZXIgaGFwcGVucyBmaXJzdC4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlVW5tZXRlcmVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZVVubWV0ZXJlZCwKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIHRpbWVvdXRNaWxsaXMpIHsKCiAgICAgICAgZmluYWwgaW50IG92ZXJyaWRlVmFsdWUgPSBvdmVycmlkZVVubWV0ZXJlZCA/IFNVQlNDUklQVElPTl9PVkVSUklERV9VTk1FVEVSRUQgOiAwOwogICAgICAgIGdldE5ldHdvcmtQb2xpY3lNYW5hZ2VyKCkuc2V0U3Vic2NyaXB0aW9uT3ZlcnJpZGUoc3ViSWQsIFNVQlNDUklQVElPTl9PVkVSUklERV9VTk1FVEVSRUQsCiAgICAgICAgICAgICAgICBvdmVycmlkZVZhbHVlLCB0aW1lb3V0TWlsbGlzLCBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkpOwogICAgfQoKICAgIC8qKgogICAgICogVGVtcG9yYXJpbHkgb3ZlcnJpZGUgdGhlIGJpbGxpbmcgcmVsYXRpb25zaGlwIHBsYW4gYmV0d2VlbiBhIGNhcnJpZXIgYW5kCiAgICAgKiBhIHNwZWNpZmljIHN1YnNjcmliZXIgdG8gYmUgY29uc2lkZXJlZCBjb25nZXN0ZWQuIFRoaXMgd2lsbCBjYXVzZSB0aGUKICAgICAqIGRldmljZSB0byBkZWxheSBjZXJ0YWluIG5ldHdvcmsgcmVxdWVzdHMgd2hlbiBwb3NzaWJsZSwgc3VjaCBhcyBkZXZlbG9wZXIKICAgICAqIGpvYnMgdGhhdCBhcmUgd2lsbGluZyB0byBydW4gaW4gYSBmbGV4aWJsZSB0aW1lIHdpbmRvdy4KICAgICAqIDxwPgogICAgICogVGhpcyBtZXRob2QgaXMgb25seSBhY2Nlc3NpYmxlIHRvIHRoZSBmb2xsb3dpbmcgbmFycm93IHNldCBvZiBhcHBzOgogICAgICogPHVsPgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBmb3IgdGhpcyBzdWJzY3JpYmVySWQsIGFzIGRldGVybWluZWQgYnkKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9LgogICAgICogPGxpPlRoZSBjYXJyaWVyIGFwcCBleHBsaWNpdGx5IGRlbGVnYXRlZCBhY2Nlc3MgdGhyb3VnaAogICAgICoge0BsaW5rIENhcnJpZXJDb25maWdNYW5hZ2VyI0tFWV9DT05GSUdfUExBTlNfUEFDS0FHRV9PVkVSUklERV9TVFJJTkd9LgogICAgICogPC91bD4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWQgdGhlIHN1YnNjcmliZXIgdGhpcyBvdmVycmlkZSBhcHBsaWVzIHRvLgogICAgICogQHBhcmFtIG92ZXJyaWRlQ29uZ2VzdGVkIHNldCBpZiB0aGUgc3Vic2NyaXB0aW9uIHNob3VsZCBiZSBjb25zaWRlcmVkCiAgICAgKiAgICAgICAgICAgIGNvbmdlc3RlZC4KICAgICAqIEBwYXJhbSB0aW1lb3V0TWlsbGlzIHRoZSB0aW1lb3V0IGFmdGVyIHdoaWNoIHRoZSByZXF1ZXN0ZWQgb3ZlcnJpZGUgd2lsbAogICAgICogICAgICAgICAgICBiZSBhdXRvbWF0aWNhbGx5IGNsZWFyZWQsIG9yIHtAY29kZSAwfSB0byBsZWF2ZSBpbiB0aGUKICAgICAqICAgICAgICAgICAgcmVxdWVzdGVkIHN0YXRlIHVudGlsIGV4cGxpY2l0bHkgY2xlYXJlZCwgb3IgdGhlIG5leHQgcmVib290LAogICAgICogICAgICAgICAgICB3aGljaGV2ZXIgaGFwcGVucyBmaXJzdC4KICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKi8KICAgIHB1YmxpYyB2b2lkIHNldFN1YnNjcmlwdGlvbk92ZXJyaWRlQ29uZ2VzdGVkKGludCBzdWJJZCwgYm9vbGVhbiBvdmVycmlkZUNvbmdlc3RlZCwKICAgICAgICAgICAgQER1cmF0aW9uTWlsbGlzTG9uZyBsb25nIHRpbWVvdXRNaWxsaXMpIHsKICAgICAgICBmaW5hbCBpbnQgb3ZlcnJpZGVWYWx1ZSA9IG92ZXJyaWRlQ29uZ2VzdGVkID8gU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRCA6IDA7CiAgICAgICAgZ2V0TmV0d29ya1BvbGljeU1hbmFnZXIoKS5zZXRTdWJzY3JpcHRpb25PdmVycmlkZShzdWJJZCwgU1VCU0NSSVBUSU9OX09WRVJSSURFX0NPTkdFU1RFRCwKICAgICAgICAgICAgICAgIG92ZXJyaWRlVmFsdWUsIHRpbWVvdXRNaWxsaXMsIG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgYXBwIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgaXMgYXV0aG9yaXplZCB0byBtYW5hZ2UgdGhlIGdpdmVuIHN1YnNjcmlwdGlvbgogICAgICogYWNjb3JkaW5nIHRvIGl0cyBtZXRhZGF0YS4KICAgICAqCiAgICAgKiBPbmx5IHN1cHBvcnRlZCBmb3IgZW1iZWRkZWQgc3Vic2NyaXB0aW9ucyAoaWYge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jaXNFbWJlZGRlZH0gcmV0dXJucwogICAgICogdHJ1ZSkuIFRvIGNoZWNrIGZvciBwZXJtaXNzaW9ucyBmb3Igbm9uLWVtYmVkZGVkIHN1YnNjcmlwdGlvbiBhcyB3ZWxsLAogICAgICoge0BzZWUgYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30uCiAgICAgKgogICAgICogQHBhcmFtIGluZm8gVGhlIHN1YnNjcmlwdGlvbiB0byBjaGVjay4KICAgICAqIEByZXR1cm4gd2hldGhlciB0aGUgYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoaXMgc3Vic2NyaXB0aW9uIHBlciBpdHMgbWV0YWRhdGEuCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGNhbk1hbmFnZVN1YnNjcmlwdGlvbihTdWJzY3JpcHRpb25JbmZvIGluZm8pIHsKICAgICAgICByZXR1cm4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKGluZm8sIG1Db250ZXh0LmdldFBhY2thZ2VOYW1lKCkpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgdGhlIGdpdmVuIGFwcCBpcyBhdXRob3JpemVkIHRvIG1hbmFnZSB0aGUgZ2l2ZW4gc3Vic2NyaXB0aW9uLiBBbiBhcHAgY2FuIG9ubHkKICAgICAqIGJlIGF1dGhvcml6ZWQgaWYgaXQgaXMgaW5jbHVkZWQgaW4gdGhlIHtAbGluayBhbmRyb2lkLnRlbGVwaG9ueS5VaWNjQWNjZXNzUnVsZX0gb2YgdGhlCiAgICAgKiB7QGxpbmsgYW5kcm9pZC50ZWxlcGhvbnkuU3Vic2NyaXB0aW9uSW5mb30gd2l0aCB0aGUgYWNjZXNzIHN0YXR1cy4KICAgICAqCiAgICAgKiBPbmx5IHN1cHBvcnRlZCBmb3IgZW1iZWRkZWQgc3Vic2NyaXB0aW9ucyAoaWYge0BsaW5rIFN1YnNjcmlwdGlvbkluZm8jaXNFbWJlZGRlZH0gcmV0dXJucwogICAgICogdHJ1ZSkuIFRvIGNoZWNrIGZvciBwZXJtaXNzaW9ucyBmb3Igbm9uLWVtYmVkZGVkIHN1YnNjcmlwdGlvbiBhcyB3ZWxsLAogICAgICoge0BzZWUgYW5kcm9pZC50ZWxlcGhvbnkuVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlc30uCiAgICAgKgogICAgICogQHBhcmFtIGluZm8gVGhlIHN1YnNjcmlwdGlvbiB0byBjaGVjay4KICAgICAqIEBwYXJhbSBwYWNrYWdlTmFtZSBQYWNrYWdlIG5hbWUgb2YgdGhlIGFwcCB0byBjaGVjay4KICAgICAqIEByZXR1cm4gd2hldGhlciB0aGUgYXBwIGlzIGF1dGhvcml6ZWQgdG8gbWFuYWdlIHRoaXMgc3Vic2NyaXB0aW9uIHBlciBpdHMgYWNjZXNzIHJ1bGVzLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgcHVibGljIGJvb2xlYW4gY2FuTWFuYWdlU3Vic2NyaXB0aW9uKEBOb25OdWxsIFN1YnNjcmlwdGlvbkluZm8gaW5mbywKICAgICAgICAgICAgQE5vbk51bGwgU3RyaW5nIHBhY2thZ2VOYW1lKSB7CiAgICAgICAgaWYgKGluZm8gPT0gbnVsbCB8fCBpbmZvLmdldEFsbEFjY2Vzc1J1bGVzKCkgPT0gbnVsbCB8fCBwYWNrYWdlTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgUGFja2FnZU1hbmFnZXIgcGFja2FnZU1hbmFnZXIgPSBtQ29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpOwogICAgICAgIFBhY2thZ2VJbmZvIHBhY2thZ2VJbmZvOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHBhY2thZ2VJbmZvID0gcGFja2FnZU1hbmFnZXIuZ2V0UGFja2FnZUluZm8ocGFja2FnZU5hbWUsCiAgICAgICAgICAgICAgICBQYWNrYWdlTWFuYWdlci5HRVRfU0lHTklOR19DRVJUSUZJQ0FURVMpOwogICAgICAgIH0gY2F0Y2ggKFBhY2thZ2VNYW5hZ2VyLk5hbWVOb3RGb3VuZEV4Y2VwdGlvbiBlKSB7CiAgICAgICAgICAgIGxvZ2QoIlVua25vd24gcGFja2FnZTogIiArIHBhY2thZ2VOYW1lKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmb3IgKFVpY2NBY2Nlc3NSdWxlIHJ1bGUgOiBpbmZvLmdldEFsbEFjY2Vzc1J1bGVzKCkpIHsKICAgICAgICAgICAgaWYgKHJ1bGUuZ2V0Q2FycmllclByaXZpbGVnZVN0YXR1cyhwYWNrYWdlSW5mbykKICAgICAgICAgICAgICAgICAgICA9PSBUZWxlcGhvbnlNYW5hZ2VyLkNBUlJJRVJfUFJJVklMRUdFX1NUQVRVU19IQVNfQUNDRVNTKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgd2hpY2ggc3Vic2NyaXB0aW9uIGlzIHByZWZlcnJlZCBmb3IgY2VsbHVsYXIgZGF0YS4KICAgICAqIEl0J3MgYWxzbyB1c3VhbGx5IHRoZSBzdWJzY3JpcHRpb24gd2Ugc2V0IHVwIGludGVybmV0IGNvbm5lY3Rpb24gb24uCiAgICAgKgogICAgICogUHJlZmVycmVkRGF0YSBvdmVyd3JpdGVzIHVzZXIgc2V0dGluZyBvZiBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLiBBbmQgaXQncyB1c2VkCiAgICAgKiBieSBBbHRlcm5hdGl2ZU5ldHdvcmtTZXJ2aWNlIG9yIGNhcnJpZXIgYXBwcyB0byBzd2l0Y2ggcHJpbWFyeSBhbmQgQ0JSUwogICAgICogc3Vic2NyaXB0aW9uIGR5bmFtaWNhbGx5IGluIG11bHRpLVNJTSBkZXZpY2VzLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZCB3aGljaCBzdWJzY3JpcHRpb24gaXMgcHJlZmVycmVkIHRvIGZvciBjZWxsdWxhciBkYXRhLiBJZiBpdCdzCiAgICAgKiAgICAgICAgICAgICAge0BsaW5rIFN1YnNjcmlwdGlvbk1hbmFnZXIjREVGQVVMVF9TVUJTQ1JJUFRJT05fSUR9LCBpdCBtZWFucwogICAgICogICAgICAgICAgICAgIGl0J3MgdW5zZXQgYW5kIHtAbGluayBTdWJzY3JpcHRpb25NYW5hZ2VyI2dldERlZmF1bHREYXRhU3Vic2NyaXB0aW9uSWQoKX0KICAgICAqICAgICAgICAgICAgICBpcyB1c2VkIHRvIGRldGVybWluZSB3aGljaCBtb2RlbSBpcyBwcmVmZXJyZWQuCiAgICAgKiBAcGFyYW0gbmVlZFZhbGlkYXRpb24gd2hldGhlciBUZWxlcGhvbnkgd2lsbCB3YWl0IHVudGlsIHRoZSBuZXR3b3JrIGlzIHZhbGlkYXRlZCBieQogICAgICogICAgICAgICAgICAgIGNvbm5lY3Rpdml0eSBzZXJ2aWNlIGJlZm9yZSBzd2l0Y2hpbmcgZGF0YSB0byBpdC4gTW9yZSBkZXRhaWxzIHNlZQogICAgICogICAgICAgICAgICAgIHtAbGluayBOZXR3b3JrQ2FwYWJpbGl0aWVzI05FVF9DQVBBQklMSVRZX1ZBTElEQVRFRH0uCiAgICAgKiBAcGFyYW0gZXhlY3V0b3IgVGhlIGV4ZWN1dG9yIG9mIHdoZXJlIHRoZSBjYWxsYmFjayB3aWxsIGV4ZWN1dGUuCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgQ2FsbGJhY2sgd2lsbCBiZSB0cmlnZ2VyZWQgb25jZSBpdCBzdWNjZWVkcyBvciBmYWlsZWQuCiAgICAgKiAgICAgICAgICAgICAgICAgUGFzcyBudWxsIGlmIGRvbid0IGNhcmUgYWJvdXQgdGhlIHJlc3VsdC4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICoKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uTU9ESUZZX1BIT05FX1NUQVRFKQogICAgcHVibGljIHZvaWQgc2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkKGludCBzdWJJZCwgYm9vbGVhbiBuZWVkVmFsaWRhdGlvbiwKICAgICAgICAgICAgQE51bGxhYmxlIEBDYWxsYmFja0V4ZWN1dG9yIEV4ZWN1dG9yIGV4ZWN1dG9yLCBATnVsbGFibGUKICAgICAgICAgICAgQFRlbGVwaG9ueU1hbmFnZXIuU2V0T3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvblJlc3VsdCBDb25zdW1lcjxJbnRlZ2VyPiBjYWxsYmFjaykgewogICAgICAgIGlmIChWREJHKSBsb2dkKCJbc2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkXSsgc3ViSWQ6IiArIHN1YklkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgPT0gbnVsbCkgcmV0dXJuOwoKICAgICAgICAgICAgSVNldE9wcG9ydHVuaXN0aWNEYXRhQ2FsbGJhY2sgY2FsbGJhY2tTdHViID0gbmV3IElTZXRPcHBvcnR1bmlzdGljRGF0YUNhbGxiYWNrLlN0dWIoKSB7CiAgICAgICAgICAgICAgICBAT3ZlcnJpZGUKICAgICAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uQ29tcGxldGUoaW50IHJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChleGVjdXRvciA9PSBudWxsIHx8IGNhbGxiYWNrID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmaW5hbCBsb25nIGlkZW50aXR5ID0gQmluZGVyLmNsZWFyQ2FsbGluZ0lkZW50aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0b3IuZXhlY3V0ZSgoKSAtPiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hY2NlcHQocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgQmluZGVyLnJlc3RvcmVDYWxsaW5nSWRlbnRpdHkoaWRlbnRpdHkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaVN1Yi5zZXRQcmVmZXJyZWREYXRhU3Vic2NyaXB0aW9uSWQoc3ViSWQsIG5lZWRWYWxpZGF0aW9uLCBjYWxsYmFja1N0dWIpOwogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgd2hpY2ggc3Vic2NyaXB0aW9uIGlzIHByZWZlcnJlZCBmb3IgY2VsbHVsYXIgZGF0YS4KICAgICAqIEl0J3MgYWxzbyB1c3VhbGx5IHRoZSBzdWJzY3JpcHRpb24gd2Ugc2V0IHVwIGludGVybmV0IGNvbm5lY3Rpb24gb24uCiAgICAgKgogICAgICogUHJlZmVycmVkRGF0YSBvdmVyd3JpdGVzIHVzZXIgc2V0dGluZyBvZiBkZWZhdWx0IGRhdGEgc3Vic2NyaXB0aW9uLiBBbmQgaXQncyB1c2VkCiAgICAgKiBieSBBbHRlcm5hdGl2ZU5ldHdvcmtTZXJ2aWNlIG9yIGNhcnJpZXIgYXBwcyB0byBzd2l0Y2ggcHJpbWFyeSBhbmQgQ0JSUwogICAgICogc3Vic2NyaXB0aW9uIGR5bmFtaWNhbGx5IGluIG11bHRpLVNJTSBkZXZpY2VzLgogICAgICoKICAgICAqIEByZXR1cm4gcHJlZmVycmVkIHN1YnNjcmlwdGlvbiBpZCBmb3IgY2VsbHVsYXIgZGF0YS4ge0BsaW5rIERFRkFVTFRfU1VCU0NSSVBUSU9OX0lEfSBpZgogICAgICogdGhlcmUncyBubyBwcmVmZXJlZCBzdWJzY3JpcHRpb24uCiAgICAgKgogICAgICogQGhpZGUKICAgICAqCiAgICAgKi8KICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgaW50IGdldFByZWZlcnJlZERhdGFTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICBpbnQgcHJlZmVycmVkU3ViSWQgPSBTdWJzY3JpcHRpb25NYW5hZ2VyLkRFRkFVTFRfU1VCU0NSSVBUSU9OX0lEOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVmZXJyZWRTdWJJZCA9IGlTdWIuZ2V0UHJlZmVycmVkRGF0YVN1YnNjcmlwdGlvbklkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgLy8gaWdub3JlIGl0CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJlZmVycmVkU3ViSWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gb3Bwb3J0dW5pc3RpYyBzdWJzY3JpcHRpb25zIHRoYXQgY2FuIGJlIHZpc2libGUgdG8gdGhlIGNhbGxlci4KICAgICAqIE9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBhcmUgZm9yIG9wcG9ydHVuaXN0aWMgbmV0d29ya3MsIHdoaWNoIGFyZSBjZWxsdWxhcgogICAgICogbmV0d29ya3Mgd2l0aCBsaW1pdGVkIGNhcGFiaWxpdGllcyBhbmQgY292ZXJhZ2UsIGZvciBleGFtcGxlLCBDQlJTLgogICAgICoKICAgICAqIDxwPlJlcXVpcmVzIFBlcm1pc3Npb246CiAgICAgKiB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI1JFQURfUEhPTkVfU1RBVEUgUkVBRF9QSE9ORV9TVEFURX0KICAgICAqIG9yIHRoYXQgdGhlIGNhbGxpbmcgYXBwIGhhcyBjYXJyaWVyIHByaXZpbGVnZXMgKHNlZQogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXN9KS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoZSBsaXN0IG9mIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uIGluZm8uIElmIG5vbmUgZXhpc3RzLCBhbiBlbXB0eSBsaXN0LgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IGdldE9wcG9ydHVuaXN0aWNTdWJzY3JpcHRpb25zKCkgewogICAgICAgIFN0cmluZyBjb250ZXh0UGtnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIFN0cmluZyBjb250ZXh0QXR0cmlidXRpb25UYWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0QXR0cmlidXRpb25UYWcoKSA6IG51bGw7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBzdWJJbmZvTGlzdCA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdWJJbmZvTGlzdCA9IGlTdWIuZ2V0T3Bwb3J0dW5pc3RpY1N1YnNjcmlwdGlvbnMoY29udGV4dFBrZywKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dEF0dHJpYnV0aW9uVGFnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmIChzdWJJbmZvTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHN1YkluZm9MaXN0ID0gbmV3IEFycmF5TGlzdDw+KCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3ViSW5mb0xpc3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBTd2l0Y2ggdG8gYSBjZXJ0YWluIHN1YnNjcmlwdGlvbgogICAgICoKICAgICAqICBAcGFyYW0gc3ViSWQgc3ViIGlkCiAgICAgKiAgQHBhcmFtIGNhbGxiYWNrSW50ZW50IHBlbmRpbmcgaW50ZW50IHRoYXQgd2lsbCBiZSBzZW50IGFmdGVyIG9wZXJhdGlvbiBpcyBkb25lLgogICAgICovCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5XUklURV9FTUJFRERFRF9TVUJTQ1JJUFRJT05TKQogICAgcHVibGljIHZvaWQgc3dpdGNoVG9TdWJzY3JpcHRpb24oaW50IHN1YklkLCBATm9uTnVsbCBQZW5kaW5nSW50ZW50IGNhbGxiYWNrSW50ZW50KSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoY2FsbGJhY2tJbnRlbnQsICJjYWxsYmFja0ludGVudCBjYW5ub3QgYmUgbnVsbCIpOwogICAgICAgIEV1aWNjTWFuYWdlciBldWljY01hbmFnZXIgPSBuZXcgRXVpY2NNYW5hZ2VyKG1Db250ZXh0KTsKICAgICAgICBldWljY01hbmFnZXIuc3dpdGNoVG9TdWJzY3JpcHRpb24oc3ViSWQsIGNhbGxiYWNrSW50ZW50KTsKICAgIH0KCiAgICAvKioKICAgICAqIFNldCB3aGV0aGVyIGEgc3Vic2NyaXB0aW9uIGlzIG9wcG9ydHVuaXN0aWMsIHRoYXQgaXMsIHdoZXRoZXIgdGhlIG5ldHdvcmsgaXQgY29ubmVjdHMKICAgICAqIHRvIGhhcyBsaW1pdGVkIGNvdmVyYWdlLiBGb3IgZXhhbXBsZSwgQ0JSUy4gU2V0dGluZyBhIHN1YnNjcmlwdGlvbiBvcHBvcnR1bmlzdGljIGhhcwogICAgICogZm9sbG93aW5nIGltcGFjdHM6CiAgICAgKiAgMSkgRXZlbiBpZiBpdCdzIGFjdGl2ZSwgaXQgd2lsbCBiZSBkb3JtYW50IG1vc3Qgb2YgdGhlIHRpbWUuIFRoZSBtb2RlbSB3aWxsIG5vdCB0cnkKICAgICAqICAgICB0byBzY2FuIG9yIGNhbXAgdW50aWwgaXQga25vd3MgYW4gYXZhaWxhYmxlIG5ldHdvcmsgaXMgbmVhcmJ5IHRvIHNhdmUgcG93ZXIuCiAgICAgKiAgMikgVGVsZXBob255IHJlbGllcyBvbiBzeXN0ZW0gYXBwIG9yIGNhcnJpZXIgaW5wdXQgdG8gbm90aWZ5IG5lYXJieSBhdmFpbGFibGUgbmV0d29ya3MuCiAgICAgKiAgICAgU2VlIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI3VwZGF0ZUF2YWlsYWJsZU5ldHdvcmtzKExpc3QsIEV4ZWN1dG9yLCBDb25zdW1lcil9CiAgICAgKiAgICAgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiAgMykgSW4gbXVsdGktU0lNIGRldmljZXMsIHdoZW4gdGhlIG5ldHdvcmsgaXMgbmVhcmJ5IGFuZCBjYW1wZWQsIHN5c3RlbSBtYXkgYXV0b21hdGljYWxseQogICAgICogICAgIHN3aXRjaCBpbnRlcm5ldCBkYXRhIGJldHdlZW4gaXQgYW5kIGRlZmF1bHQgZGF0YSBzdWJzY3JpcHRpb24sIGJhc2VkIG9uIGNhcnJpZXIKICAgICAqICAgICByZWNvbW1lbmRhdGlvbiBhbmQgaXRzIHNpZ25hbCBzdHJlbmd0aCBhbmQgbWV0ZXJlZC1uZXNzLCBldGMuCiAgICAgKgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfSBvciBjYXJyaWVyCiAgICAgKiBwcml2aWxlZ2UgcGVybWlzc2lvbiBvZiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBvcHBvcnR1bmlzdGljIHdoZXRoZXIgaXTigJlzIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uLgogICAgICogQHBhcmFtIHN1YklkIHRoZSB1bmlxdWUgU3Vic2NyaXB0aW9uSW5mbyBpbmRleCBpbiBkYXRhYmFzZQogICAgICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIG9wZXJhdGlvbiBpcyBzdWNjZWVkLCB7QGNvZGUgZmFsc2V9IG90aGVyd2lzZS4KICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldE9wcG9ydHVuaXN0aWMoYm9vbGVhbiBvcHBvcnR1bmlzdGljLCBpbnQgc3ViSWQpIHsKICAgICAgICBpZiAoVkRCRykgbG9nZCgiW3NldE9wcG9ydHVuaXN0aWNdKyBvcHBvcnR1bmlzdGljOiIgKyBvcHBvcnR1bmlzdGljICsgIiBzdWJJZDoiICsgc3ViSWQpOwogICAgICAgIHJldHVybiBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihzdWJJZCwgInNldE9wcG9ydHVuaXN0aWMiLAogICAgICAgICAgICAgICAgKGlTdWIpLT4gaVN1Yi5zZXRPcHBvcnR1bmlzdGljKAogICAgICAgICAgICAgICAgICAgICAgICBvcHBvcnR1bmlzdGljLCBzdWJJZCwgbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpKSkgPT0gMTsKICAgIH0KCiAgICAvKioKICAgICAqIEluZm9ybSBTdWJzY3JpcHRpb25NYW5hZ2VyIHRoYXQgc3Vic2NyaXB0aW9ucyBpbiB0aGUgbGlzdCBhcmUgYnVuZGxlZAogICAgICogYXMgYSBncm91cC4gSXQgY2FuIGJlIG11bHRpcGxlIHByaW1hcnkgKG5vbi1vcHBvcnR1bmlzdGljKSBzdWJzY3JpcHRpb25zLAogICAgICogb3Igb25lIG9yIG1vcmUgcHJpbWFyeSBwbHVzIG9uZSBvciBtb3JlIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBUaGlzIEFQSSB3aWxsIGFsd2F5cyBjcmVhdGUgYSBuZXcgaW1tdXRhYmxlIGdyb3VwIGFuZCBhc3NpZ24gZ3JvdXAgVVVJRCB0byBhbGwgdGhlCiAgICAgKiBzdWJzY3JpcHRpb25zLCByZWdhcmRsZXNzIHdoZXRoZXIgdGhleSBhcmUgaW4gYSBncm91cCBhbHJlYWR5IG9yIG5vdC4KICAgICAqCiAgICAgKiBHcm91cGVkIHN1YnNjcmlwdGlvbnMgd2lsbCBoYXZlIGJlbG93IGJlaGF2aW9yczoKICAgICAqIDEpIFRoZXkgd2lsbCBzaGFyZSB0aGUgc2FtZSB1c2VyIHNldHRpbmdzLgogICAgICogMikgVGhlIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBpbiB0aGUgZ3JvdXAgaXMgY29uc2lkZXJlZCBpbnZpc2libGUgYW5kIHdpbGwgbm90CiAgICAgKiAgICByZXR1cm4gZnJvbSB7QGxpbmsgI2dldEFjdGl2ZVN1YnNjcmlwdGlvbkluZm9MaXN0KCl9LCB1bmxlc3MgY2FsbGVyIGhhcyBjYXJyaWVyCiAgICAgKiAgICBwcml2aWxlZ2UgcGVybWlzc2lvbiBvZiB0aGUgc3Vic2NyaXB0aW9ucy4KICAgICAqIDMpIFRoZSBvcHBvcnR1bmlzdGljIHN1YnNjcmlwdGlvbnMgaW4gdGhlIGdyb3VwIGNhbid0IGJlIGFjdGl2ZSBieSBpdHNlbGYuIElmIGFsbCBvdGhlcgogICAgICogICAgbm9uLW9wcG9ydHVuaXN0aWMgb25lcyBhcmUgZGVhY3RpdmF0ZWQgKHVucGx1Z2dlZCBvciBkaXNhYmxlZCBpbiBTZXR0aW5ncyksCiAgICAgKiAgICB0aGUgb3Bwb3J0dW5pc3RpYyBvbmVzIHdpbGwgYmUgZGVhY3RpdmF0ZWQgYXV0b21hdGljYWxseS4KICAgICAqCiAgICAgKiBDYWxsZXIgd2lsbCBlaXRoZXIgaGF2ZSB7QGxpbmsgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uI01PRElGWV9QSE9ORV9TVEFURX0KICAgICAqIHBlcm1pc3Npb24gb3IgaGFkIGNhcnJpZXIgcHJpdmlsZWdlIHBlcm1pc3Npb24gb24gdGhlIHN1YnNjcmlwdGlvbnM6CiAgICAgKiB7QGxpbmsgVGVsZXBob255TWFuYWdlciNoYXNDYXJyaWVyUHJpdmlsZWdlcygpfSBvcgogICAgICoge0BsaW5rICNjYW5NYW5hZ2VTdWJzY3JpcHRpb24oU3Vic2NyaXB0aW9uSW5mbyl9CiAgICAgKgogICAgICogQHRocm93cyBTZWN1cml0eUV4Y2VwdGlvbiBpZiB0aGUgY2FsbGVyIGRvZXNuJ3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzCiAgICAgKiAgICAgICAgICAgICBvdXRsaW5lZCBhYm92ZS4KICAgICAqIEB0aHJvd3MgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uIGlmIGFueSBvZiB0aGUgc3Vic2NyaXB0aW9ucyBpbiB0aGUgbGlzdCBkb2Vzbid0IGV4aXN0LgogICAgICogQHRocm93cyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24gaWYgVGVsZXBob255IHNlcnZpY2UgaXMgaW4gYmFkIHN0YXRlLgogICAgICoKICAgICAqIEBwYXJhbSBzdWJJZExpc3QgbGlzdCBvZiBzdWJJZCB0aGF0IHdpbGwgYmUgaW4gdGhlIHNhbWUgZ3JvdXAKICAgICAqIEByZXR1cm4gZ3JvdXBVVUlEIGEgVVVJRCBhc3NpZ25lZCB0byB0aGUgc3Vic2NyaXB0aW9uIGdyb3VwLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBATm9uTnVsbCBQYXJjZWxVdWlkIGNyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwKEBOb25OdWxsIExpc3Q8SW50ZWdlcj4gc3ViSWRMaXN0KSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoc3ViSWRMaXN0LCAiY2FuJ3QgY3JlYXRlIGdyb3VwIGZvciBudWxsIHN1YklkIGxpc3QiKTsKICAgICAgICBTdHJpbmcgcGtnRm9yRGVidWcgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiW2NyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwXSIpOwogICAgICAgIH0KCiAgICAgICAgUGFyY2VsVXVpZCBncm91cFV1aWQgPSBudWxsOwogICAgICAgIGludFtdIHN1YklkQXJyYXkgPSBzdWJJZExpc3Quc3RyZWFtKCkubWFwVG9JbnQoaS0+aSkudG9BcnJheSgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBncm91cFV1aWQgPSBpU3ViLmNyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwKHN1YklkQXJyYXksIHBrZ0ZvckRlYnVnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaXNTeXN0ZW1Qcm9jZXNzKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uKCJ0ZWxlcGhvbnkgc2VydmljZSBpcyBudWxsLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIGxvZ2UoImNyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBncm91cFV1aWQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgaW50byBhIGdyb3VwLgogICAgICogU2VlIHtAbGluayAjY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoTGlzdCl9IGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNNT0RJRllfUEhPTkVfU1RBVEV9CiAgICAgKiBwZXJtaXNzaW9uIG9yIGhhZCBjYXJyaWVyIHByaXZpbGVnZSBwZXJtaXNzaW9uIG9uIHRoZSBzdWJzY3JpcHRpb25zOgogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0gb3IKICAgICAqIHtAbGluayAjY2FuTWFuYWdlU3Vic2NyaXB0aW9uKFN1YnNjcmlwdGlvbkluZm8pfQogICAgICoKICAgICAqIEB0aHJvd3MgU2VjdXJpdHlFeGNlcHRpb24gaWYgdGhlIGNhbGxlciBkb2Vzbid0IG1lZXQgdGhlIHJlcXVpcmVtZW50cwogICAgICogICAgICAgICAgICAgb3V0bGluZWQgYWJvdmUuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiB0aGUgc29tZSBzdWJzY3JpcHRpb25zIGluIHRoZSBsaXN0IGRvZXNuJ3QgZXhpc3QuCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiBUZWxlcGhvbnkgc2VydmljZSBpcyBpbiBiYWQgc3RhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHN1YklkTGlzdCBsaXN0IG9mIHN1YklkIHRoYXQgbmVlZCBhZGRpbmcgaW50byB0aGUgZ3JvdXAKICAgICAqIEBwYXJhbSBncm91cFV1aWQgdGhlIGdyb3VwVXVpZCB0aGUgc3Vic2NyaXB0aW9ucyBhcmUgYmVpbmcgYWRkZWQgdG8uCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIGFkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXAoQE5vbk51bGwgTGlzdDxJbnRlZ2VyPiBzdWJJZExpc3QsCiAgICAgICAgICAgIEBOb25OdWxsIFBhcmNlbFV1aWQgZ3JvdXBVdWlkKSB7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoc3ViSWRMaXN0LCAic3ViSWRMaXN0IGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgUHJlY29uZGl0aW9ucy5jaGVja05vdE51bGwoZ3JvdXBVdWlkLCAiZ3JvdXBVdWlkIGNhbid0IGJlIG51bGwuIik7CiAgICAgICAgU3RyaW5nIHBrZ0ZvckRlYnVnID0gbUNvbnRleHQgIT0gbnVsbCA/IG1Db250ZXh0LmdldE9wUGFja2FnZU5hbWUoKSA6ICI8dW5rbm93bj4iOwogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoIlthZGRTdWJzY3JpcHRpb25zSW50b0dyb3VwXSIpOwogICAgICAgIH0KCiAgICAgICAgaW50W10gc3ViSWRBcnJheSA9IHN1YklkTGlzdC5zdHJlYW0oKS5tYXBUb0ludChpLT5pKS50b0FycmF5KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpU3ViLmFkZFN1YnNjcmlwdGlvbnNJbnRvR3JvdXAoc3ViSWRBcnJheSwgZ3JvdXBVdWlkLCBwa2dGb3JEZWJ1Zyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxTdGF0ZUV4Y2VwdGlvbigidGVsZXBob255IHNlcnZpY2UgaXMgbnVsbC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICBsb2dlKCJhZGRTdWJzY3JpcHRpb25zSW50b0dyb3VwIFJlbW90ZUV4Y2VwdGlvbiAiICsgZXgpOwogICAgICAgICAgICBpZiAoIWlzU3lzdGVtUHJvY2VzcygpKSB7CiAgICAgICAgICAgICAgICBleC5yZXRocm93QXNSdW50aW1lRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBib29sZWFuIGlzU3lzdGVtUHJvY2VzcygpIHsKICAgICAgICByZXR1cm4gUHJvY2Vzcy5teVVpZCgpID09IFByb2Nlc3MuU1lTVEVNX1VJRDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmcm9tIHRoZWlyIHN1YnNjcmlwdGlvbiBncm91cC4KICAgICAqIFNlZSB7QGxpbmsgI2NyZWF0ZVN1YnNjcmlwdGlvbkdyb3VwKExpc3QpfSBmb3IgbW9yZSBkZXRhaWxzLgogICAgICoKICAgICAqIENhbGxlciB3aWxsIGVpdGhlciBoYXZlIHtAbGluayBhbmRyb2lkLk1hbmlmZXN0LnBlcm1pc3Npb24jTU9ESUZZX1BIT05FX1NUQVRFfQogICAgICogcGVybWlzc2lvbiBvciBoYWQgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbiBvbiB0aGUgc3Vic2NyaXB0aW9uczoKICAgICAqIHtAbGluayBUZWxlcGhvbnlNYW5hZ2VyI2hhc0NhcnJpZXJQcml2aWxlZ2VzKCl9IG9yCiAgICAgKiB7QGxpbmsgI2Nhbk1hbmFnZVN1YnNjcmlwdGlvbihTdWJzY3JpcHRpb25JbmZvKX0KICAgICAqCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICogQHRocm93cyBJbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24gaWYgdGhlIHNvbWUgc3Vic2NyaXB0aW9ucyBpbiB0aGUgbGlzdCBkb2Vzbid0IGJlbG9uZwogICAgICogICAgICAgICAgICAgdGhlIHNwZWNpZmllZCBncm91cC4KICAgICAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIFRlbGVwaG9ueSBzZXJ2aWNlIGlzIGluIGJhZCBzdGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc3ViSWRMaXN0IGxpc3Qgb2Ygc3ViSWQgdGhhdCBuZWVkIHJlbW92aW5nIGZyb20gdGhlaXIgZ3JvdXBzLgogICAgICoKICAgICAqLwogICAgQFN1cHByZXNzQXV0b0RvYyAvLyBCbG9ja2VkIGJ5IGIvNzI5NjcyMzYgLSBubyBzdXBwb3J0IGZvciBjYXJyaWVyIHByaXZpbGVnZXMKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgdm9pZCByZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwKEBOb25OdWxsIExpc3Q8SW50ZWdlcj4gc3ViSWRMaXN0LAogICAgICAgICAgICBATm9uTnVsbCBQYXJjZWxVdWlkIGdyb3VwVXVpZCkgewogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKHN1YklkTGlzdCwgInN1YklkTGlzdCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKGdyb3VwVXVpZCwgImdyb3VwVXVpZCBjYW4ndCBiZSBudWxsLiIpOwogICAgICAgIFN0cmluZyBwa2dGb3JEZWJ1ZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRPcFBhY2thZ2VOYW1lKCkgOiAiPHVua25vd24+IjsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbcmVtb3ZlU3Vic2NyaXB0aW9uc0Zyb21Hcm91cF0iKTsKICAgICAgICB9CgogICAgICAgIGludFtdIHN1YklkQXJyYXkgPSBzdWJJZExpc3Quc3RyZWFtKCkubWFwVG9JbnQoaS0+aSkudG9BcnJheSgpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaVN1Yi5yZW1vdmVTdWJzY3JpcHRpb25zRnJvbUdyb3VwKHN1YklkQXJyYXksIGdyb3VwVXVpZCwgcGtnRm9yRGVidWcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInRlbGVwaG9ueSBzZXJ2aWNlIGlzIG51bGwuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZSgicmVtb3ZlU3Vic2NyaXB0aW9uc0Zyb21Hcm91cCBSZW1vdGVFeGNlcHRpb24gIiArIGV4KTsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogR2V0IHN1YnNjcmlwdGlvbkluZm8gbGlzdCBvZiBzdWJzY3JpcHRpb25zIHRoYXQgYXJlIGluIHRoZSBzYW1lIGdyb3VwIG9mIGdpdmVuIHN1YklkLgogICAgICogU2VlIHtAbGluayAjY3JlYXRlU3Vic2NyaXB0aW9uR3JvdXAoTGlzdCl9IGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICogQ2FsbGVyIHdpbGwgZWl0aGVyIGhhdmUge0BsaW5rIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbiNSRUFEX1BIT05FX1NUQVRFfQogICAgICogcGVybWlzc2lvbiBvciBoYWQgY2FycmllciBwcml2aWxlZ2UgcGVybWlzc2lvbiBvbiB0aGUgc3Vic2NyaXB0aW9uLgogICAgICoge0BsaW5rIFRlbGVwaG9ueU1hbmFnZXIjaGFzQ2FycmllclByaXZpbGVnZXMoKX0KICAgICAqCiAgICAgKiBAdGhyb3dzIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbiBpZiBUZWxlcGhvbnkgc2VydmljZSBpcyBpbiBiYWQgc3RhdGUuCiAgICAgKiBAdGhyb3dzIFNlY3VyaXR5RXhjZXB0aW9uIGlmIHRoZSBjYWxsZXIgZG9lc24ndCBtZWV0IHRoZSByZXF1aXJlbWVudHMKICAgICAqICAgICAgICAgICAgIG91dGxpbmVkIGFib3ZlLgogICAgICoKICAgICAqIEBwYXJhbSBncm91cFV1aWQgb2Ygd2hpY2ggbGlzdCBvZiBzdWJJbmZvIHdpbGwgYmUgcmV0dXJuZWQuCiAgICAgKiBAcmV0dXJuIGxpc3Qgb2Ygc3Vic2NyaXB0aW9uSW5mbyB0aGF0IGJlbG9uZyB0byB0aGUgc2FtZSBncm91cCwgaW5jbHVkaW5nIHRoZSBnaXZlbgogICAgICogc3Vic2NyaXB0aW9uIGl0c2VsZi4gSXQgd2lsbCByZXR1cm4gYW4gZW1wdHkgbGlzdCBpZiBubyBzdWJzY3JpcHRpb24gYmVsb25ncyB0byB0aGUgZ3JvdXAuCiAgICAgKgogICAgICovCiAgICBAU3VwcHJlc3NBdXRvRG9jIC8vIEJsb2NrZWQgYnkgYi83Mjk2NzIzNiAtIG5vIHN1cHBvcnQgZm9yIGNhcnJpZXIgcHJpdmlsZWdlcwogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgQE5vbk51bGwgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRTdWJzY3JpcHRpb25zSW5Hcm91cChATm9uTnVsbCBQYXJjZWxVdWlkIGdyb3VwVXVpZCkgewogICAgICAgIFByZWNvbmRpdGlvbnMuY2hlY2tOb3ROdWxsKGdyb3VwVXVpZCwgImdyb3VwVXVpZCBjYW4ndCBiZSBudWxsIik7CiAgICAgICAgU3RyaW5nIGNvbnRleHRQa2cgPSBtQ29udGV4dCAhPSBudWxsID8gbUNvbnRleHQuZ2V0T3BQYWNrYWdlTmFtZSgpIDogIjx1bmtub3duPiI7CiAgICAgICAgU3RyaW5nIGNvbnRleHRBdHRyaWJ1dGlvblRhZyA9IG1Db250ZXh0ICE9IG51bGwgPyBtQ29udGV4dC5nZXRBdHRyaWJ1dGlvblRhZygpIDogbnVsbDsKICAgICAgICBpZiAoVkRCRykgewogICAgICAgICAgICBsb2dkKCJbZ2V0U3Vic2NyaXB0aW9uc0luR3JvdXBdKyBncm91cFV1aWQ6IiArIGdyb3VwVXVpZCk7CiAgICAgICAgfQoKICAgICAgICBMaXN0PFN1YnNjcmlwdGlvbkluZm8+IHJlc3VsdCA9IG51bGw7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlTdWIuZ2V0U3Vic2NyaXB0aW9uc0luR3JvdXAoZ3JvdXBVdWlkLCBjb250ZXh0UGtnLAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0QXR0cmlidXRpb25UYWcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbGxlZ2FsU3RhdGVFeGNlcHRpb24oInRlbGVwaG9ueSBzZXJ2aWNlIGlzIG51bGwuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChSZW1vdGVFeGNlcHRpb24gZXgpIHsKICAgICAgICAgICAgbG9nZSgicmVtb3ZlU3Vic2NyaXB0aW9uc0Zyb21Hcm91cCBSZW1vdGVFeGNlcHRpb24gIiArIGV4KTsKICAgICAgICAgICAgaWYgKCFpc1N5c3RlbVByb2Nlc3MoKSkgewogICAgICAgICAgICAgICAgZXgucmV0aHJvd0FzUnVudGltZUV4Y2VwdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogV2hldGhlciBhIHN1YnNjcmlwdGlvbiBpcyB2aXNpYmxlIHRvIEFQSSBjYWxsZXIuIElmIGl0J3MgYSBidW5kbGVkIG9wcG9ydHVuaXN0aWMKICAgICAqIHN1YnNjcmlwdGlvbiwgaXQgc2hvdWxkIGJlIGhpZGRlbiBhbnl3aGVyZSBpbiBTZXR0aW5ncywgZGlhbGVyLCBzdGF0dXMgYmFyIGV0Yy4KICAgICAqIEV4Y2VwdGlvbiBpcyBpZiBjYWxsZXIgb3ducyBjYXJyaWVyIHByaXZpbGVnZSwgaW4gd2hpY2ggY2FzZSB0aGV5IHdpbGwKICAgICAqIHdhbnQgdG8gc2VlIHRoZWlyIG93biBoaWRkZW4gc3Vic2NyaXB0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gaW5mbyB0aGUgc3Vic2NyaXB0aW9uSW5mbyB0byBjaGVjayBhZ2FpbnN0LgogICAgICogQHJldHVybiB0cnVlIGlmIHRoaXMgc3Vic2NyaXB0aW9uIHNob3VsZCBiZSB2aXNpYmxlIHRvIHRoZSBBUEkgY2FsbGVyLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBib29sZWFuIGlzU3Vic2NyaXB0aW9uVmlzaWJsZShTdWJzY3JpcHRpb25JbmZvIGluZm8pIHsKICAgICAgICBpZiAoaW5mbyA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgLy8gSWYgc3Vic2NyaXB0aW9uIGlzIE5PVCBncm91cGVkIG9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9uLCBpdCdzIHZpc2libGUuCiAgICAgICAgaWYgKGluZm8uZ2V0R3JvdXBVdWlkKCkgPT0gbnVsbCB8fCAhaW5mby5pc09wcG9ydHVuaXN0aWMoKSkgcmV0dXJuIHRydWU7CgogICAgICAgIC8vIElmIHRoZSBjYWxsZXIgaXMgdGhlIGNhcnJpZXIgYXBwIGFuZCBvd25zIHRoZSBzdWJzY3JpcHRpb24sIGl0IHNob3VsZCBiZSB2aXNpYmxlCiAgICAgICAgLy8gdG8gdGhlIGNhbGxlci4KICAgICAgICBib29sZWFuIGhhc0NhcnJpZXJQcml2aWxlZ2VQZXJtaXNzaW9uID0gVGVsZXBob255TWFuYWdlci5mcm9tKG1Db250ZXh0KQogICAgICAgICAgICAgICAgLmhhc0NhcnJpZXJQcml2aWxlZ2VzKGluZm8uZ2V0U3Vic2NyaXB0aW9uSWQoKSkKICAgICAgICAgICAgICAgIHx8IGNhbk1hbmFnZVN1YnNjcmlwdGlvbihpbmZvKTsKICAgICAgICByZXR1cm4gaGFzQ2FycmllclByaXZpbGVnZVBlcm1pc3Npb247CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgdGhhdCBhcmUgYXZhaWxhYmxlIGFuZCB2aXNpYmxlIHRvIHRoZSB1c2VyLgogICAgICogVXNlZCBieSBTZXR0aW5ncyBhcHAgdG8gc2hvdyBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdXNlciB0byBwaWNrLgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICogZm9yIGdldFNlbGVjdGFibGVTdWJzY3JpcHRpb25JbmZvTGlzdCB0byBiZSBpbnZva2VkLgogICAgICogQHJldHVybiBsaXN0IG9mIHVzZXIgc2VsZWN0YWJsZSBzdWJzY3JpcHRpb25zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBATnVsbGFibGUgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBnZXRTZWxlY3RhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKSB7CiAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBhdmFpbGFibGVMaXN0ID0gZ2V0QXZhaWxhYmxlU3Vic2NyaXB0aW9uSW5mb0xpc3QoKTsKICAgICAgICBpZiAoYXZhaWxhYmxlTGlzdCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE11bHRpcGxlIHN1YnNjcmlwdGlvbnMgaW4gYSBncm91cCBzaG91bGQgb25seSBoYXZlIG9uZSByZXByZXNlbnRhdGl2ZS4KICAgICAgICAgICAgLy8gSXQgc2hvdWxkIGJlIHRoZSBjdXJyZW50IGFjdGl2ZSBwcmltYXJ5IHN1YnNjcmlwdGlvbiBpZiBhbnksIG9yIGFueQogICAgICAgICAgICAvLyBwcmltYXJ5IHN1YnNjcmlwdGlvbi4KICAgICAgICAgICAgTGlzdDxTdWJzY3JpcHRpb25JbmZvPiBzZWxlY3RhYmxlTGlzdCA9IG5ldyBBcnJheUxpc3Q8PigpOwogICAgICAgICAgICBNYXA8UGFyY2VsVXVpZCwgU3Vic2NyaXB0aW9uSW5mbz4gZ3JvdXBNYXAgPSBuZXcgSGFzaE1hcDw+KCk7CgogICAgICAgICAgICBmb3IgKFN1YnNjcmlwdGlvbkluZm8gaW5mbyA6IGF2YWlsYWJsZUxpc3QpIHsKICAgICAgICAgICAgICAgIC8vIE9wcG9ydHVuaXN0aWMgc3Vic2NyaXB0aW9ucyBhcmUgY29uc2lkZXJlZCBpbnZpc2libGUKICAgICAgICAgICAgICAgIC8vIHRvIHVzZXJzIHNvIHRoZXkgc2hvdWxkIG5ldmVyIGJlIHJldHVybmVkLgogICAgICAgICAgICAgICAgaWYgKCFpc1N1YnNjcmlwdGlvblZpc2libGUoaW5mbykpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIFBhcmNlbFV1aWQgZ3JvdXBVdWlkID0gaW5mby5nZXRHcm91cFV1aWQoKTsKICAgICAgICAgICAgICAgIGlmIChncm91cFV1aWQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIC8vIERvZXNuJ3QgYmVsb25nIHRvIGFueSBncm91cC4gQWRkIGluIHRoZSBsaXN0LgogICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGVMaXN0LmFkZChpbmZvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWdyb3VwTWFwLmNvbnRhaW5zS2V5KGdyb3VwVXVpZCkKICAgICAgICAgICAgICAgICAgICAgICAgfHwgKGdyb3VwTWFwLmdldChncm91cFV1aWQpLmdldFNpbVNsb3RJbmRleCgpID09IElOVkFMSURfU0lNX1NMT1RfSU5ERVgKICAgICAgICAgICAgICAgICAgICAgICAgJiYgaW5mby5nZXRTaW1TbG90SW5kZXgoKSAhPSBJTlZBTElEX1NJTV9TTE9UX0lOREVYKSkgewogICAgICAgICAgICAgICAgICAgIC8vIElmIGl0IGJlbG9uZ3MgdG8gYSBncm91cCB0aGF0IGhhcyBuZXZlciBiZWVuIHJlY29yZGVkIG9yIGl0J3MgdGhlIGN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAvLyBhY3RpdmUgc3Vic2NyaXB0aW9uLCBhZGQgaXQgaW4gdGhlIGxpc3QuCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZUxpc3QucmVtb3ZlKGdyb3VwTWFwLmdldChncm91cFV1aWQpKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlTGlzdC5hZGQoaW5mbyk7CiAgICAgICAgICAgICAgICAgICAgZ3JvdXBNYXAucHV0KGdyb3VwVXVpZCwgaW5mbyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWxlY3RhYmxlTGlzdDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBFbmFibGVzIG9yIGRpc2FibGVzIGEgc3Vic2NyaXB0aW9uLiBUaGlzIGlzIGN1cnJlbnRseSB1c2VkIGluIHRoZSBzZXR0aW5ncyBwYWdlLiBJdCB3aWxsCiAgICAgKiBmYWlsIGFuZCByZXR1cm4gZmFsc2UgaWYgb3BlcmF0aW9uIGlzIG5vdCBzdXBwb3J0ZWQgb3IgZmFpbGVkLgogICAgICoKICAgICAqIFRvIGRpc2FibGUgYW4gYWN0aXZlIHN1YnNjcmlwdGlvbiBvbiBhIHBoeXNpY2FsIChub24tRXVpY2MpIFNJTSwKICAgICAqIHtAbGluayAjY2FuRGlzYWJsZVBoeXNpY2FsU3Vic2NyaXB0aW9ufSBuZWVkcyB0byBiZSB0cnVlLgogICAgICoKICAgICAqIDxwPgogICAgICogUGVybWlzc2lvbnMgYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSBpcyByZXF1aXJlZAogICAgICoKICAgICAqIEBwYXJhbSBlbmFibGUgd2hldGhlciB1c2VyIGlzIHR1cm5pbmcgaXQgb24gb3Igb2ZmLgogICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbklkIFN1YnNjcmlwdGlvbiB0byBiZSBlbmFibGVkIG9yIGRpc2FibGVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgIEl0IGNvdWxkIGJlIGEgZVNJTSBvciBwU0lNIHN1YnNjcmlwdGlvbi4KICAgICAqCiAgICAgKiBAcmV0dXJuIHdoZXRoZXIgdGhlIG9wZXJhdGlvbiBpcyBzdWNjZXNzZnVsLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIEBTeXN0ZW1BcGkKICAgIEBSZXF1aXJlc1Blcm1pc3Npb24oYW5kcm9pZC5NYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIHNldFN1YnNjcmlwdGlvbkVuYWJsZWQoaW50IHN1YnNjcmlwdGlvbklkLCBib29sZWFuIGVuYWJsZSkgewogICAgICAgIGlmIChWREJHKSB7CiAgICAgICAgICAgIGxvZ2QoInNldFN1YnNjcmlwdGlvbkFjdGl2YXRlZCBzdWJJZD0gIiArIHN1YnNjcmlwdGlvbklkICsgIiBlbmFibGUgIiArIGVuYWJsZSk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IFRlbGVwaG9ueU1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uU2VydmljZSgpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5zZXRTdWJzY3JpcHRpb25FbmFibGVkKGVuYWJsZSwgc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU2V0IHVpY2MgYXBwbGljYXRpb25zIGJlaW5nIGVuYWJsZWQgb3IgZGlzYWJsZWQuCiAgICAgKiBUaGUgdmFsdWUgd2lsbCBiZSByZW1lbWJlcmVkIG9uIHRoZSBzdWJzY3JpcHRpb24gYW5kIHdpbGwgYmUgYXBwbGllZCB3aGVuZXZlciBpdCdzIHByZXNlbnQuCiAgICAgKiBJZiB0aGUgc3Vic2NyaXB0aW9uIGluIGN1cnJlbnRseSBwcmVzZW50LCBpdCB3aWxsIGFsc28gYXBwbHkgdGhlIHNldHRpbmcgdG8gbW9kZW0KICAgICAqIGltbWVkaWF0ZWx5LgogICAgICoKICAgICAqIFBlcm1pc3Npb25zIGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5NT0RJRllfUEhPTkVfU1RBVEUgaXMgcmVxdWlyZWQKICAgICAqCiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uSWQgd2hpY2ggc3Vic2NyaXB0aW9uIHRvIG9wZXJhdGUgb24uCiAgICAgKiBAcGFyYW0gZW5hYmxlZCB3aGV0aGVyIHVpY2MgYXBwbGljYXRpb25zIGFyZSBlbmFibGVkIG9yIGRpc2FibGVkLgogICAgICogQGhpZGUKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLk1PRElGWV9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyB2b2lkIHNldFVpY2NBcHBsaWNhdGlvbnNFbmFibGVkKGludCBzdWJzY3JpcHRpb25JZCwgYm9vbGVhbiBlbmFibGVkKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgic2V0VWljY0FwcGxpY2F0aW9uc0VuYWJsZWQgc3ViSWQ9ICIgKyBzdWJzY3JpcHRpb25JZCArICIgZW5hYmxlICIgKyBlbmFibGVkKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gSVN1Yi5TdHViLmFzSW50ZXJmYWNlKAogICAgICAgICAgICAgICAgICAgIFRlbGVwaG9ueUZyYW1ld29ya0luaXRpYWxpemVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0VGVsZXBob255U2VydmljZU1hbmFnZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFN1YnNjcmlwdGlvblNlcnZpY2VSZWdpc3RlcmVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXQoKSk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlTdWIuc2V0VWljY0FwcGxpY2F0aW9uc0VuYWJsZWQoZW5hYmxlZCwgc3Vic2NyaXB0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFdoZXRoZXIgaXQncyBzdXBwb3J0ZWQgdG8gZGlzYWJsZSAvIHJlLWVuYWJsZSBhIHN1YnNjcmlwdGlvbiBvbiBhIHBoeXNpY2FsIChub24tZXVpY2MpIFNJTS4KICAgICAqCiAgICAgKiBQaHlzaWNhbCBTSU0gcmVmZXJzIG5vbi1ldWljYywgb3IgYWthIG5vbi1wcm9ncmFtbWFibGUgU0lNLgogICAgICoKICAgICAqIEl0IHByb3ZpZGVzIHdoZXRoZXIgYSBwaHlzaWNhbCBTSU0gY2FyZCBjYW4gYmUgZGlzYWJsZWQgd2l0aG91dCB0YWtpbmcgaXQgb3V0LCB3aGljaCBpcyBkb25lCiAgICAgKiB2aWEge0BsaW5rICNzZXRTdWJzY3JpcHRpb25FbmFibGVkKGludCwgYm9vbGVhbil9IEFQSS4KICAgICAqCiAgICAgKiBSZXF1aXJlcyBQZXJtaXNzaW9uOiBSRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUuCiAgICAgKgogICAgICogQHJldHVybiB3aGV0aGVyIGNhbiBkaXNhYmxlIHN1YnNjcmlwdGlvbnMgb24gcGh5c2ljYWwgU0lNcy4KICAgICAqCiAgICAgKiBAaGlkZQogICAgICovCiAgICBAU3lzdGVtQXBpCiAgICBAUmVxdWlyZXNQZXJtaXNzaW9uKGFuZHJvaWQuTWFuaWZlc3QucGVybWlzc2lvbi5SRUFEX1BSSVZJTEVHRURfUEhPTkVfU1RBVEUpCiAgICBwdWJsaWMgYm9vbGVhbiBjYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24oKSB7CiAgICAgICAgaWYgKFZEQkcpIHsKICAgICAgICAgICAgbG9nZCgiY2FuRGlzYWJsZVBoeXNpY2FsU3Vic2NyaXB0aW9uIik7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIElTdWIgaVN1YiA9IElTdWIuU3R1Yi5hc0ludGVyZmFjZSgKICAgICAgICAgICAgICAgICAgICBUZWxlcGhvbnlGcmFtZXdvcmtJbml0aWFsaXplcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldFRlbGVwaG9ueVNlcnZpY2VNYW5hZ2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlUmVnaXN0ZXJlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0KCkpOwogICAgICAgICAgICBpZiAoaVN1YiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaVN1Yi5jYW5EaXNhYmxlUGh5c2ljYWxTdWJzY3JpcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIERPIE5PVCBVU0UuCiAgICAgKiBUaGlzIEFQSSBpcyBkZXNpZ25lZCBmb3IgZmVhdHVyZXMgdGhhdCBhcmUgbm90IGZpbmlzaGVkIGF0IHRoaXMgcG9pbnQuIERvIG5vdCBjYWxsIHRoaXMgQVBJLgogICAgICogQGhpZGUKICAgICAqIFRPRE8gYi8xMzU1NDc1MTI6IGZ1cnRoZXIgY2xlYW4gdXAKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBib29sZWFuIGlzU3Vic2NyaXB0aW9uRW5hYmxlZChpbnQgc3Vic2NyaXB0aW9uSWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBJU3ViIGlTdWIgPSBUZWxlcGhvbnlNYW5hZ2VyLmdldFN1YnNjcmlwdGlvblNlcnZpY2UoKTsKICAgICAgICAgICAgaWYgKGlTdWIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlTdWIuaXNTdWJzY3JpcHRpb25FbmFibGVkKHN1YnNjcmlwdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIERPIE5PVCBVU0UuCiAgICAgKiBUaGlzIEFQSSBpcyBkZXNpZ25lZCBmb3IgZmVhdHVyZXMgdGhhdCBhcmUgbm90IGZpbmlzaGVkIGF0IHRoaXMgcG9pbnQuIERvIG5vdCBjYWxsIHRoaXMgQVBJLgogICAgICogQGhpZGUKICAgICAqIFRPRE8gYi8xMzU1NDc1MTI6IGZ1cnRoZXIgY2xlYW4gdXAKICAgICAqLwogICAgQFN5c3RlbUFwaQogICAgQFJlcXVpcmVzUGVybWlzc2lvbihNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQURfUFJJVklMRUdFRF9QSE9ORV9TVEFURSkKICAgIHB1YmxpYyBpbnQgZ2V0RW5hYmxlZFN1YnNjcmlwdGlvbklkKGludCBzbG90SW5kZXgpIHsKICAgICAgICBpbnQgc3ViSWQgPSBJTlZBTElEX1NVQlNDUklQVElPTl9JRDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1YklkID0gaVN1Yi5nZXRFbmFibGVkU3Vic2NyaXB0aW9uSWQoc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFJlbW90ZUV4Y2VwdGlvbiBleCkgewogICAgICAgICAgICAvLyBpZ25vcmUgaXQKICAgICAgICB9CgogICAgICAgIGlmIChWREJHKSBsb2dkKCJnZXRFbmFibGVkU3Vic2NyaXB0aW9uSWQsIHN1YklkID0gIiArIHN1YklkKTsKICAgICAgICByZXR1cm4gc3ViSWQ7CiAgICB9CgogICAgcHJpdmF0ZSBpbnRlcmZhY2UgQ2FsbElTdWJNZXRob2RIZWxwZXIgewogICAgICAgIGludCBjYWxsTWV0aG9kKElTdWIgaVN1YikgdGhyb3dzIFJlbW90ZUV4Y2VwdGlvbjsKICAgIH0KCiAgICBwcml2YXRlIGludCBzZXRTdWJzY3JpcHRpb25Qcm9wZXJ0eUhlbHBlcihpbnQgc3ViSWQsIFN0cmluZyBtZXRob2ROYW1lLAogICAgICAgICAgICBDYWxsSVN1Yk1ldGhvZEhlbHBlciBoZWxwZXIpIHsKICAgICAgICBpZiAoIWlzVmFsaWRTdWJzY3JpcHRpb25JZChzdWJJZCkpIHsKICAgICAgICAgICAgbG9nZCgiWyIgKyBtZXRob2ROYW1lICsgIl0iICsgIi0gZmFpbCIpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQoKICAgICAgICBpbnQgcmVzdWx0ID0gMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgSVN1YiBpU3ViID0gVGVsZXBob255TWFuYWdlci5nZXRTdWJzY3JpcHRpb25TZXJ2aWNlKCk7CiAgICAgICAgICAgIGlmIChpU3ViICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGhlbHBlci5jYWxsTWV0aG9kKGlTdWIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoUmVtb3RlRXhjZXB0aW9uIGV4KSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBpdAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldCBhY3RpdmUgZGF0YSBzdWJzY3JpcHRpb24gaWQuIEFjdGl2ZSBkYXRhIHN1YnNjcmlwdGlvbiByZWZlcnMgdG8gdGhlIHN1YnNjcmlwdGlvbgogICAgICogY3VycmVudGx5IGNob3NlbiB0byBwcm92aWRlIGNlbGx1bGFyIGludGVybmV0IGNvbm5lY3Rpb24gdG8gdGhlIHVzZXIuIFRoaXMgbWF5IGJlCiAgICAgKiBkaWZmZXJlbnQgZnJvbSBnZXREZWZhdWx0RGF0YVN1YnNjcmlwdGlvbklkKCkuIEVnLiBPcHBvcnR1bmlzdGljcyBkYXRhCiAgICAgKgogICAgICogU2VlIHtAbGluayBQaG9uZVN0YXRlTGlzdGVuZXIjb25BY3RpdmVEYXRhU3Vic2NyaXB0aW9uSWRDaGFuZ2VkKGludCl9IGZvciB0aGUgZGV0YWlscy4KICAgICAqCiAgICAgKiBAcmV0dXJuIEFjdGl2ZSBkYXRhIHN1YnNjcmlwdGlvbiBpZCBpZiBhbnkgaXMgY2hvc2VuLCBvcgogICAgICogU3Vic2NyaXB0aW9uTWFuYWdlci5JTlZBTElEX1NVQlNDUklQVElPTl9JRCBpZiBub3QuCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgaW50IGdldEFjdGl2ZURhdGFTdWJzY3JpcHRpb25JZCgpIHsKICAgICAgICByZXR1cm4gc0FjdGl2ZURhdGFTdWJJZENhY2hlLnF1ZXJ5KG51bGwpOwogICAgfQoKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCB0aGF0IHB1dHMgYSBzdWJzY3JpcHRpb24gaWQgb24gYW4gaW50ZW50IHdpdGggdGhlIGNvbnN0YW50czoKICAgICAqIFBob25lQ29uc3RhbnQuU1VCU0NSSVBUSU9OX0tFWSBhbmQgU3Vic2NyaXB0aW9uTWFuYWdlci5FWFRSQV9TVUJTQ1JJUFRJT05fSU5ERVguCiAgICAgKiBCb3RoIGNvbnN0YW50cyBhcmUgdXNlZCB0byBzdXBwb3J0IGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiAgT25jZSB3ZSBrbm93IHdlIGdvdCBhbGwgcGxhY2VzLAogICAgICogd2UgY2FuIHJlbW92ZSBQaG9uZUNvbnN0YW50cy5TVUJTQ1JJUFRJT05fS0VZLgogICAgICogQHBhcmFtIGludGVudCBJbnRlbnQgdG8gcHV0IHN1YiBpZCBvbi4KICAgICAqIEBwYXJhbSBzdWJJZCBTdWJzY3JpcHRpb25JZCB0byBwdXQgb24gaW50ZW50LgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBwdXRTdWJzY3JpcHRpb25JZEV4dHJhKEludGVudCBpbnRlbnQsIGludCBzdWJJZCkgewogICAgICAgIGludGVudC5wdXRFeHRyYShTdWJzY3JpcHRpb25NYW5hZ2VyLkVYVFJBX1NVQlNDUklQVElPTl9JTkRFWCwgc3ViSWQpOwogICAgICAgIGludGVudC5wdXRFeHRyYShQaG9uZUNvbnN0YW50cy5TVUJTQ1JJUFRJT05fS0VZLCBzdWJJZCk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZURlZmF1bHRTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9ERUZBVUxUX1NVQl9JRF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZURlZmF1bHREYXRhU3ViSWRDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfREVGQVVMVF9EQVRBX1NVQl9JRF9QUk9QRVJUWSk7CiAgICB9CgogICAgLyoqIEBoaWRlICovCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgaW52YWxpZGF0ZURlZmF1bHRTbXNTdWJJZENhY2hlcygpIHsKICAgICAgICBQcm9wZXJ0eUludmFsaWRhdGVkQ2FjaGUuaW52YWxpZGF0ZUNhY2hlKENBQ0hFX0tFWV9ERUZBVUxUX1NNU19TVUJfSURfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKiBAaGlkZSAqLwogICAgcHVibGljIHN0YXRpYyB2b2lkIGludmFsaWRhdGVBY3RpdmVEYXRhU3ViSWRDYWNoZXMoKSB7CiAgICAgICAgUHJvcGVydHlJbnZhbGlkYXRlZENhY2hlLmludmFsaWRhdGVDYWNoZShDQUNIRV9LRVlfQUNUSVZFX0RBVEFfU1VCX0lEX1BST1BFUlRZKTsKICAgIH0KCiAgICAvKiogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBpbnZhbGlkYXRlU2xvdEluZGV4Q2FjaGVzKCkgewogICAgICAgIFByb3BlcnR5SW52YWxpZGF0ZWRDYWNoZS5pbnZhbGlkYXRlQ2FjaGUoQ0FDSEVfS0VZX1NMT1RfSU5ERVhfUFJPUEVSVFkpOwogICAgfQoKICAgIC8qKgogICAgICogQWxsb3dzIGEgdGVzdCBwcm9jZXNzIHRvIGRpc2FibGUgY2xpZW50LXNpZGUgY2FjaGluZyBvcGVyYXRpb25zLgogICAgICoKICAgICAqIEBoaWRlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBkaXNhYmxlQ2FjaGluZygpIHsKICAgICAgICBzRGVmYXVsdFN1YklkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc0RlZmF1bHREYXRhU3ViSWRDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzQWN0aXZlRGF0YVN1YklkQ2FjaGUuZGlzYWJsZUxvY2FsKCk7CiAgICAgICAgc0RlZmF1bHRTbXNTdWJJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgICAgIHNTbG90SW5kZXhDYWNoZS5kaXNhYmxlTG9jYWwoKTsKICAgICAgICBzUGhvbmVJZENhY2hlLmRpc2FibGVMb2NhbCgpOwogICAgfQoKICAgIC8qKgogICAgICogQ2xlYXJzIGFsbCBwcm9jZXNzLWxvY2FsIGJpbmRlciBjYWNoZXMuCiAgICAgKgogICAgICogQGhpZGUgKi8KICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBjbGVhckNhY2hlcygpIHsKICAgICAgICBzRGVmYXVsdFN1YklkQ2FjaGUuY2xlYXIoKTsKICAgICAgICBzRGVmYXVsdERhdGFTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc0FjdGl2ZURhdGFTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc0RlZmF1bHRTbXNTdWJJZENhY2hlLmNsZWFyKCk7CiAgICAgICAgc1Nsb3RJbmRleENhY2hlLmNsZWFyKCk7CiAgICAgICAgc1Bob25lSWRDYWNoZS5jbGVhcigpOwogICAgfQp9Cg==</text>
      </register>
      <register name="3" type="2">
        <text encoding="base64">cHVibGljIGNsYXNzIHRlc3Qgewp9Cg==</text>
      </register>
      <register name="4" type="2">
        <text encoding="base64">ICAgICAgICAvLyBJbnRlbnQgZm9yIGNsaWNrIGFuZCBkaXNtaXNzIGFjdGlvbgo=</text>
      </register>
      <register name="5" type="2">
        <text encoding="base64">Cg==</text>
      </register>
      <register name="6" type="2">
        <text encoding="base64">Ly8gLi4uCg==</text>
      </register>
      <register name="7" type="2">
        <text encoding="base64">ICAgICAgICB2YWwgY2xpY2tJbnRlbnQgPSBJbnRlbnQoY29udGV4dCwgU2F2ZVNlc3Npb25EYXRhU2VydmljZTo6Y2xhc3MuamF2YSkKICAgICAgICBjbGlja0ludGVudC5hY3Rpb24gPSBUcmFja2VyQWN0aW9ucy5OT1RJRklDQVRJT05fQ0xJQ0sKICAgICAgICB2YWwgY2xpY2tEYXRhID0gTm90aWZpY2F0aW9uRHRvKAogICAgICAgICAgICB0eXBlID0gIlRPRE8iLCAvKiBoYXJkY29kZWQgYXMgb2Ygbm93ICovCiAgICAgICAgICAgIHRpdGxlID0gdGl0bGUsCiAgICAgICAgICAgIGltYWdlID0gaWNvbi50b1N0cmluZygpLCAvKiBtb3N0bHkgd291bGQgcGFhcyBlaXRoZXIgbG9jYWwgaW1hZ2UgdXJpIG9yIHJlbW90ZSB1cmwgKi8KICAgICAgICAgICAgY2xpY2tlZCA9IHRydWUsCiAgICAgICAgICAgIG1lc3NhZ2UgPSBkZXNjcmlwdGlvbiwKICAgICAgICAgICAgdGltZVN0YXllZEluVHJheSA9IFN5c3RlbS5jdXJyZW50VGltZU1pbGxpcygpIC0gc2VudFRpbWVTdGFtcAogICAgICAgICkKICAgICAgICBjbGlja0ludGVudC5wdXRFeHRyYSgidmFsdWUiLCBjbGlja0RhdGEpCiAgICAgICAgdmFsIGNsaWNrUGVuZGluZ0ludGVudDogUGVuZGluZ0ludGVudCA9CiAgICAgICAgICAgIFBlbmRpbmdJbnRlbnQuZ2V0U2VydmljZShjb250ZXh0LCAwLCBjbGlja0ludGVudCwgUGVuZGluZ0ludGVudC5GTEFHX0lNTVVUQUJMRSkKCgogICAgICAgIHZhbCBkaXNtaXNzSW50ZW50ID0gSW50ZW50KGNvbnRleHQsIFNhdmVTZXNzaW9uRGF0YVNlcnZpY2U6OmNsYXNzLmphdmEpCiAgICAgICAgZGlzbWlzc0ludGVudC5hY3Rpb24gPSBUcmFja2VyQWN0aW9ucy5OT1RJRklDQVRJT05fRElTTUlTUwogICAgICAgIHZhbCBkaXNtaXNzRGF0YSA9IE5vdGlmaWNhdGlvbkR0bygKICAgICAgICAgICAgdHlwZSA9ICJUT0RPIiwgLyogaGFyZGNvZGVkIGFzIG9mIG5vdyAqLwogICAgICAgICAgICB0aXRsZSA9IHRpdGxlLAogICAgICAgICAgICBpbWFnZSA9IGljb24udG9TdHJpbmcoKSwgLyogbW9zdGx5IHdvdWxkIHBhYXMgZWl0aGVyIGxvY2FsIGltYWdlIHVyaSBvciByZW1vdGUgdXJsICovCiAgICAgICAgICAgIGRpc21pc3NlZCA9IHRydWUsCiAgICAgICAgICAgIG1lc3NhZ2UgPSBkZXNjcmlwdGlvbiwKICAgICAgICAgICAgdGltZVN0YXllZEluVHJheSA9IFN5c3RlbS5jdXJyZW50VGltZU1pbGxpcygpIC0gc2VudFRpbWVTdGFtcAogICAgICAgICkKICAgICAgICBkaXNtaXNzSW50ZW50LnB1dEV4dHJhKCJ2YWx1ZSIsIGRpc21pc3NEYXRhKQogICAgICAgIHZhbCBkaXNtaXNzUGVuZGluZ0ludGVudDogUGVuZGluZ0ludGVudCA9CiAgICAgICAgICAgIFBlbmRpbmdJbnRlbnQuZ2V0U2VydmljZShjb250ZXh0LCAwLCBkaXNtaXNzSW50ZW50LCBQZW5kaW5nSW50ZW50LkZMQUdfSU1NVVRBQkxFKQo=</text>
      </register>
      <register name="8" type="2">
        <text encoding="base64">ICAgICAgICBVc2VyVHJhY2tlci5hcHBEYXRhKFNlcmlhbGl6ZWRIYXNoTWFwKGhhc2hNYXBPZigidGl0bGUiIHRvIHRpdGxlKSkpCg==</text>
      </register>
      <register name="9" type="2">
        <text encoding="base64">ICAgICAgICB2YWwgY2xpY2tJbnRlbnQgPSBJbnRlbnQoY29udGV4dCwgU2F2ZVNlc3Npb25EYXRhU2VydmljZTo6Y2xhc3MuamF2YSkK</text>
      </register>
      <register name=":" type="4">
        <text encoding="base64">dw==</text>
      </register>
    </registers>
  </component>
  <component name="VimSearchSettings">
    <search>
      <last-search encoding="base64">QWN0aXZpdHkuUkVTVUxUX09LQVk=</last-search>
      <last-pattern encoding="base64">QWN0aXZpdHkuUkVTVUxUX09LQVk=</last-pattern>
      <last-dir encoding="base64">MQ==</last-dir>
      <show-last encoding="base64">dHJ1ZQ==</show-last>
    </search>
  </component>
</application>